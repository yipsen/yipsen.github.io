<!DOCTYPE html>
<html lang="en" class="h-100">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=8080&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>ListenableFuture æºç åˆ†æ | Yipsen Ye</title>
<meta name="description" content="åœ¨ Future æºç è§£æ ç¯‡æ—¶æåˆ°è¿‡ä»»åŠ¡æ‰§è¡Œçš„å››ç§æ¨¡å¼ï¼Œå…ˆç®€å•å›é¡¾ä¸€ä¸‹ï¼š
å•ç¨‹æ¨¡å¼ï¼ˆOne-Wayï¼‰
å³åªç®¡å°†ä»»åŠ¡æäº¤æ‰§è¡Œï¼Œä½†å¹¶ä¸å…³å¿ƒå…¶ç»“æœï¼Œè¿™ç§é€šå¸¸ä½¿ç”¨ Runnable å°è£…ä¸ºçº¿ç¨‹æäº¤æ‰§è¡Œã€‚
åŒæ­¥é˜»å¡æ¨¡å¼
å³ç›´æ¥å°±æ˜¯è¿è¡Œä»»åŠ¡ï¼Œå½“å‰çº¿ç¨‹ä¼šç›´æ¥è¿è¡Œå®Œä»»åŠ¡å†ç»§ç»­åç»­é€»è¾‘ï¼Œæ¯”å¦‚ç›´æ¥è¿è¡Œ Runnable#runã€‚
å¼‚æ­¥é˜»å¡æ¨¡å¼
å°±å¦‚ä¸Šé¢å¯¹ FutureTask çš„åˆ†æï¼Œå°†ä»»åŠ¡ Callable å°è£…ä¸º Future åæäº¤æ‰§è¡Œï¼ŒåŒæ—¶ç«‹å³é˜»å¡çº¿ç¨‹ç­‰å¾…è·å–ç»“æœï¼Œç›´åˆ°ç»“æœäº§ç”Ÿåç»§ç»­è¿è¡Œåç»­é€»è¾‘ï¼ˆåç»­é€»è¾‘åœ¨é€šå¸¸å°±ä¸»çº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼‰ã€‚å³ä¸»åŠ¨æŸ¥è¯¢
å¼‚æ­¥ç›‘å¬æ¨¡å¼
è¿˜æœ‰ä¸€ç§ä»»åŠ¡æ‰§è¡Œæ¨¡å¼å°±æ˜¯å¼‚æ­¥ç›‘å¬æ¨¡å¼ï¼Œå…·ä½“åšæ³•é€šå¸¸æ˜¯å°†ä¸€ä¸ªç»“æœç›‘å¬å™¨æ³¨å†Œç»™ä»»åŠ¡ï¼Œä»»åŠ¡æäº¤æ‰§è¡Œåï¼Œä¸»çº¿ç¨‹ä¸é˜»å¡ç»§ç»­è¿è¡Œï¼Œç­‰ä»»åŠ¡çº¿ç¨‹æ‰§è¡Œå®Œåï¼Œè°ƒç”¨ç»“æœç›‘å¬å™¨ï¼Œè¿è¡Œåç»­é€»è¾‘ï¼ˆé€šå¸¸æ­¤æ—¶åœ¨ä»»åŠ¡çº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­ï¼‰ã€‚å³è¢«åŠ¨å›è°ƒ
æœ¬æ–‡ä¸»è¦è®²çš„å°±æ˜¯ç¬¬4ç§ï¼Œå³å¼‚æ­¥ç›‘å¬æ¨¡å¼ï¼Œgoogle çš„ guava å·¥å…·åŒ…æä¾›çš„ ListenableFuture ç±»å°±å®ç°äº†è¿™ç§æ¨¡å¼ã€‚æ¥ä¸‹æ¥çœ‹ä¸‹å…¶å…·ä½“çš„ä½¿ç”¨ï¼Œä»¥åŠå…¶å®ç°åŸç†ã€‚
1. ListenableFuture æºç åˆ†æ 1.1 ä¸€æ®µç®€å•çš„ä»£ç ä¾‹å­ æˆ‘ä»¬ç…§æ—§ä»ç®€å•çš„ä»£ç ä¾‹å­å…¥æ‰‹åˆ†æï¼Œæœ¬æ¬¡ç›´æ¥ä½¿ç”¨å®˜æ–¹æ¨èçš„æ¡ˆä¾‹ï¼šListenableFutureExplained
public void testcase() throws Exception { // Yipsen: 1. å…ˆè·å–åŒ…è£…åçš„ ExecutorServiceï¼Œå³ ListeningExecutorService ListeningExecutorService executor = MoreExecutors.listeningDecorator(Executors.newFixedThreadPool(10)); // Yipsen: 2. æäº¤ä»»åŠ¡ï¼Œè·å– ListenableFuture ListenableFuture&lt;String&gt; future = executor.submit(new Callable&lt;String&gt;() { @Override public String call() throws Exception { TimeUnit.SECONDS.sleep(5); // Yipsen: æ¨¡æ‹Ÿè€—æ—¶è°ƒç”¨ return &#34;callable return result&#34;; } }); // Yipsen: 3. ä¸º Future ç»‘å®šç›‘å¬å™¨ï¼Œå¹¶ç»§ç»­ä½¿ç”¨ executor ç”Ÿæˆçº¿ç¨‹ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©å…¶ä»–çš„ executorï¼‰ Futures.addCallback(future, new FutureCallback&lt;String&gt;() { @Override public void onSuccess(String result) { System.out.println(&#34;success: &#34; &#43; result); } @Override public void onFailure(Throwable throwable) { System.out.println(&#34;failure: &#34; &#43; throwable.getMessage()); } }, executor); // Yipsen: 4. ä¸»çº¿ç¨‹å¯ä»¥ç»§ç»­è¿è¡Œåç»­é€»è¾‘ï¼Œä¸ä¼šè¢«é˜»å¡ System.out.println(&#34;main thread is running now......&#34;); } æ‰§è¡Œç»“æœï¼š
">
<meta name="author" content="yipsen">

<link rel="stylesheet" type="text/css" href="/styles/main.css">
<link rel="stylesheet" type="text/css" href="/styles/standard.css">

</head>

<body id="page" class="ff-consolas m-0">
    <header class="d-flex fd-row fw-wrap jc-between ai-center p-x-1 p-y-1 m-auto">
        <div class="nav-logo">
    <a href="http://localhost:8080/">
        
        <span class="nav-title">Yipsen Ye</span>
    </a>
</div>
<nav class="position-relative d-flex fw-wrap jc-end ai-center p-y-05">
    <ul class="d-flex fw-wrap ls-none p-l-0 m-0">
        
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/series/java/">JAVA</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/design/">è®¾è®¡</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/network/">ç½‘ç»œ</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/framework/">æ¡†æ¶</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/middleware/">ä¸­é—´ä»¶</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/plugin/">æ’ä»¶</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/linux/">LINUX</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/posts/">éšå¿ƒè°ˆ</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/others/">å±±æµ·æ–‡åº“</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content" class="m-auto">
        
<aside class="sidebar"><div>
    
    
        
        
        <a href="/categories/java%e5%b9%b6%e5%8f%91/">JAVAå¹¶å‘</a>
        <ul>
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/lock/abstractqueuedsynchronizer-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">AbstractQueuedSynchronizer æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/lock/reentrantlock-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">ReentrantLock æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/lock/semaphore-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Semaphore æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/lock/reentrantreadwritelock-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">ReentrantReadWriteLock æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/lock/countdownlatch--%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">CountDownLatch æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/lock/cyclicbarrier-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">CyclicBarrier æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/lock/phaser-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Phaser æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/lock/exchanger-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Exchanger æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/datastructure/blockingqueue-%E5%88%86%E6%9E%90/">BlockingQueue åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/datastructure/delayqueue-%E4%BD%BF%E7%94%A8%E4%B8%8E%E5%8E%9F%E7%90%86/">DelayQueue ä½¿ç”¨ä¸åŸç†ï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/datastructure/concurrenthashmap-%E5%88%86%E6%9E%90/">ConcurrentHashMap åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/datastructure/hashedwheeltimer-%E6%97%B6%E9%97%B4%E8%BD%AE/">HashedWheelTimer æ—¶é—´è½®ï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/datastructure/copyonwritearraylist-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">CopyOnWriteArrayList æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/future/future-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Future æºç åˆ†æ</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/future/scheduledfuture-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">ScheduledFuture æºç åˆ†æ</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/future/completablefuture-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">CompletableFuture æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li>ListenableFuture æºç åˆ†æ</li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/threadpool/threadpoolexecutor-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">ThreadPoolExecutor æºç åˆ†æ</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/threadpool/scheduledthreadpoolexecutor-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">ScheduledThreadPoolExecutor æºç åˆ†æ</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/threadpool/forkjoinpool-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">ForkJoinPool æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/threadpool/completionservice-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">CompletionService æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
        </ul>
    
</div></aside>
<article>
    <h1 class="m-b-1">ListenableFuture æºç åˆ†æ</h1>
    <div class="d-flex fd-row jc-center">
        <div class="fc-subtle">
            <span>2024-01-10 23:36:41</span>
        </div>
    </div>
    <div class="post-content">
        <p>åœ¨ <a href="../future-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">Future æºç è§£æ</a> ç¯‡æ—¶æåˆ°è¿‡ä»»åŠ¡æ‰§è¡Œçš„å››ç§æ¨¡å¼ï¼Œå…ˆç®€å•å›é¡¾ä¸€ä¸‹ï¼š</p>
<ol>
<li>
<p>å•ç¨‹æ¨¡å¼ï¼ˆOne-Wayï¼‰</p>
<p>å³åªç®¡å°†ä»»åŠ¡æäº¤æ‰§è¡Œï¼Œä½†å¹¶ä¸å…³å¿ƒå…¶ç»“æœï¼Œè¿™ç§é€šå¸¸ä½¿ç”¨ Runnable å°è£…ä¸ºçº¿ç¨‹æäº¤æ‰§è¡Œã€‚</p>
</li>
<li>
<p>åŒæ­¥é˜»å¡æ¨¡å¼</p>
<p>å³ç›´æ¥å°±æ˜¯è¿è¡Œä»»åŠ¡ï¼Œå½“å‰çº¿ç¨‹ä¼šç›´æ¥è¿è¡Œå®Œä»»åŠ¡å†ç»§ç»­åç»­é€»è¾‘ï¼Œæ¯”å¦‚ç›´æ¥è¿è¡Œ Runnable#runã€‚</p>
</li>
<li>
<p>å¼‚æ­¥é˜»å¡æ¨¡å¼</p>
<p>å°±å¦‚ä¸Šé¢å¯¹ FutureTask çš„åˆ†æï¼Œå°†ä»»åŠ¡ Callable å°è£…ä¸º Future åæäº¤æ‰§è¡Œï¼ŒåŒæ—¶ç«‹å³é˜»å¡çº¿ç¨‹ç­‰å¾…è·å–ç»“æœï¼Œç›´åˆ°ç»“æœäº§ç”Ÿåç»§ç»­è¿è¡Œåç»­é€»è¾‘ï¼ˆåç»­é€»è¾‘åœ¨é€šå¸¸å°±ä¸»çº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼‰ã€‚å³<strong>ä¸»åŠ¨æŸ¥è¯¢</strong></p>
</li>
<li>
<p>å¼‚æ­¥ç›‘å¬æ¨¡å¼</p>
<p>è¿˜æœ‰ä¸€ç§ä»»åŠ¡æ‰§è¡Œæ¨¡å¼å°±æ˜¯å¼‚æ­¥ç›‘å¬æ¨¡å¼ï¼Œå…·ä½“åšæ³•é€šå¸¸æ˜¯å°†ä¸€ä¸ªç»“æœç›‘å¬å™¨æ³¨å†Œç»™ä»»åŠ¡ï¼Œä»»åŠ¡æäº¤æ‰§è¡Œåï¼Œä¸»çº¿ç¨‹ä¸é˜»å¡ç»§ç»­è¿è¡Œï¼Œç­‰ä»»åŠ¡çº¿ç¨‹æ‰§è¡Œå®Œåï¼Œè°ƒç”¨ç»“æœç›‘å¬å™¨ï¼Œè¿è¡Œåç»­é€»è¾‘ï¼ˆé€šå¸¸æ­¤æ—¶åœ¨ä»»åŠ¡çº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­ï¼‰ã€‚å³<strong>è¢«åŠ¨å›è°ƒ</strong></p>
</li>
</ol>
<p>æœ¬æ–‡ä¸»è¦è®²çš„å°±æ˜¯ç¬¬4ç§ï¼Œå³å¼‚æ­¥ç›‘å¬æ¨¡å¼ï¼Œgoogle çš„ guava å·¥å…·åŒ…æä¾›çš„ ListenableFuture ç±»å°±å®ç°äº†è¿™ç§æ¨¡å¼ã€‚æ¥ä¸‹æ¥çœ‹ä¸‹å…¶å…·ä½“çš„ä½¿ç”¨ï¼Œä»¥åŠå…¶å®ç°åŸç†ã€‚</p>
<h2 id="1-listenablefuture-æºç åˆ†æ">1. ListenableFuture æºç åˆ†æ</h2>
<h3 id="11-ä¸€æ®µç®€å•çš„ä»£ç ä¾‹å­">1.1 ä¸€æ®µç®€å•çš„ä»£ç ä¾‹å­</h3>
<p>æˆ‘ä»¬ç…§æ—§ä»ç®€å•çš„ä»£ç ä¾‹å­å…¥æ‰‹åˆ†æï¼Œæœ¬æ¬¡ç›´æ¥ä½¿ç”¨å®˜æ–¹æ¨èçš„æ¡ˆä¾‹ï¼š<a href="https://github.com/google/guava/wiki/ListenableFutureExplained">ListenableFutureExplained</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testcase</span>() <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Yipsen: 1. å…ˆè·å–åŒ…è£…åçš„ ExecutorServiceï¼Œå³ ListeningExecutorService</span>
</span></span><span style="display:flex;"><span>    ListeningExecutorService executor <span style="color:#f92672">=</span> MoreExecutors.<span style="color:#a6e22e">listeningDecorator</span>(Executors.<span style="color:#a6e22e">newFixedThreadPool</span>(10));
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Yipsen: 2. æäº¤ä»»åŠ¡ï¼Œè·å– ListenableFuture</span>
</span></span><span style="display:flex;"><span>    ListenableFuture<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> future <span style="color:#f92672">=</span> executor.<span style="color:#a6e22e">submit</span>(<span style="color:#66d9ef">new</span> Callable<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">call</span>() <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>            TimeUnit.<span style="color:#a6e22e">SECONDS</span>.<span style="color:#a6e22e">sleep</span>(5); <span style="color:#75715e">// Yipsen: æ¨¡æ‹Ÿè€—æ—¶è°ƒç”¨</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;callable return result&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Yipsen: 3. ä¸º Future ç»‘å®šç›‘å¬å™¨ï¼Œå¹¶ç»§ç»­ä½¿ç”¨ executor ç”Ÿæˆçº¿ç¨‹ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©å…¶ä»–çš„ executorï¼‰</span>
</span></span><span style="display:flex;"><span>    Futures.<span style="color:#a6e22e">addCallback</span>(future, <span style="color:#66d9ef">new</span> FutureCallback<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onSuccess</span>(String result) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;success: &#34;</span> <span style="color:#f92672">+</span> result);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onFailure</span>(Throwable throwable) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;failure: &#34;</span> <span style="color:#f92672">+</span> throwable.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }, executor);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Yipsen: 4. ä¸»çº¿ç¨‹å¯ä»¥ç»§ç»­è¿è¡Œåç»­é€»è¾‘ï¼Œä¸ä¼šè¢«é˜»å¡</span>
</span></span><span style="display:flex;"><span>    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;main thread is running now......&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æ‰§è¡Œç»“æœï¼š</p>
<pre tabindex="0"><code class="language-log" data-lang="log">main thread is running now......
success: callable return result
</code></pre><h3 id="12-listenablefuture-æºç åˆ†æ">1.2 ListenableFuture æºç åˆ†æ</h3>
<p>æˆ‘ä»¬é¦–å…ˆçœ‹ä¸‹ ListenableFuture ç±»çš„ç»§æ‰¿ç»“æ„ï¼š</p>
<p>æºç é€»è¾‘éƒ¨åˆ†ï¼Œæˆ‘ä»¬åˆ†ä¸‰æ®µæ¥çœ‹ï¼š1. ç¬¬ä¸€æ®µæ„é€  ListeningExecutorServiceï¼›2. ç¬¬äºŒæ®µæäº¤ä»»åŠ¡çš„é€»è¾‘ï¼Œè·å–çš„ ListenableFuture å¦‚ä½•å·¥ä½œï¼›3. ç¬¬ä¸‰æ®µç»‘å®šç›‘å¬å™¨çš„é€»è¾‘ï¼Œç›‘å¬å™¨å†…çš„å‡½æ•°ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨ã€‚</p>
<h4 id="121-æ„é€ è¿”å›-listeningexecutorservice">1.2.1 æ„é€ è¿”å› ListeningExecutorService</h4>
<p>é¦–å…ˆçœ‹ç¬¬ä¸€æ®µï¼Œç”±äºæ™®é€š JDK çš„ Executor æäº¤éƒ½æ˜¯è¿”å›çš„æ™®é€š Futureï¼Œæ— æ³•è¿”å› ListenableFutureï¼Œå› æ­¤éœ€è¦å…ˆè¿›è¡Œè£…é¥°ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>ListeningExecutorService executor <span style="color:#f92672">=</span> MoreExecutors.<span style="color:#a6e22e">listeningDecorator</span>(Executors.<span style="color:#a6e22e">newFixedThreadPool</span>(10));
</span></span></code></pre></div><p>çœ‹ä¸‹ <code>MoreExecutors#listeningDecorator</code> çš„é€»è¾‘</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> ListeningExecutorService <span style="color:#a6e22e">listeningDecorator</span>(ExecutorService delegate) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (delegate <span style="color:#66d9ef">instanceof</span> ListeningExecutorService)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">?</span> (ListeningExecutorService) delegate
</span></span><span style="display:flex;"><span>        : (delegate <span style="color:#66d9ef">instanceof</span> ScheduledExecutorService)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">?</span> <span style="color:#66d9ef">new</span> ScheduledListeningDecorator((ScheduledExecutorService) delegate)
</span></span><span style="display:flex;"><span>            : <span style="color:#66d9ef">new</span> ListeningDecorator(delegate);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°è¿”å›çš„æ˜¯ä¸€ä¸ª ListeningDecoratorï¼Œå…¶å†…éƒ¨çš„æ ¸å¿ƒæ–¹æ³•ï¼Œéƒ½å§”æ´¾ç»™äº† ExecutorService (delegate)ï¼Œæ˜¯éå¸¸å…¸å‹çš„è£…é¥°/å§”æ´¾è®¾è®¡æ¨¡å¼ã€‚</p>
<h4 id="122-æäº¤ä»»åŠ¡è¿è¡Œè¿”å›-listenablefuture">1.2.2 æäº¤ä»»åŠ¡è¿è¡Œï¼Œè¿”å› ListenableFuture</h4>
<p>æ¥ä¸‹æ¥çœ‹ä¸‹ç¬¬äºŒæ®µï¼Œè¿™ä¸ª ListeningDecorator å¦‚ä½•å¤„ç† submit æ–¹æ³•ï¼Œå®é™…å…¶è°ƒç”¨çš„æ˜¯çˆ¶ç±»çš„é»˜è®¤æ–¹æ³•<code>AbstractExecutorService#submit</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> Future<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">submit</span>(Callable<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> task) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (task <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NullPointerException();
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Yipsen: ListeningDecorator é‡å†™äº† newTaskFor æ–¹æ³•</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ­¤å¤„è¿”å›çš„ä¸å†æ˜¯æ™®é€šçš„ FutureTaskï¼Œè€Œä¼šæ˜¯ ListenableFutureï¼ˆä¹Ÿæ˜¯ RunnableFuture çš„å­ç±»ï¼‰</span>
</span></span><span style="display:flex;"><span>    RunnableFuture<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> ftask <span style="color:#f92672">=</span> newTaskFor(task);
</span></span><span style="display:flex;"><span>    execute(ftask);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ftask;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ListeningDecorator çš„çˆ¶ç±» AbstractListeningExecutorService é‡å†™äº† newTaskFor æ–¹æ³•ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">final</span> <span style="color:#f92672">&lt;</span>T <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">@Nullable</span> Object<span style="color:#f92672">&gt;</span> RunnableFuture<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">newTaskFor</span>(Callable<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> callable) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Yipsen: æ­¤å¤„ä¼šæ„å»ºä¸€ä¸ª ListenableFuture çš„å®ç°ç±» TrustedListenableFutureTaskã€‚</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> TrustedListenableFutureTask.<span style="color:#a6e22e">create</span>(callable);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¹‹åè°ƒç”¨ exectute æ–¹æ³•ï¼Œå…¶å®é™…å°±æ˜¯å§”æ´¾ç»™å‚å…¥çš„<code>Executors.newFixedThreadPool(10)</code>æ‰§è¡Œå™¨å»æ‰§è¡Œï¼Œå› æ­¤æ­¤æ—¶å°±ä¼š<strong>å¼€è¾Ÿä¸€ä¸ªå­çº¿ç¨‹ï¼Œå¹¶å¼€å§‹è¿è¡Œä»»åŠ¡</strong>ã€‚</p>
<p><img src="/images/java/ListenableFuture-Submit.svg" alt="ListenableFuture-Submit"></p>
<h4 id="123-ä¸º-listenablefuture-ç»‘å®šå›è°ƒç›‘å¬å™¨">1.2.3 ä¸º ListenableFuture ç»‘å®šå›è°ƒç›‘å¬å™¨</h4>
<p>æ¥ä¸‹æ¥çœ‹ç¬¬ä¸‰æ®µï¼Œ<code>Futures#addCallback</code>ç»‘å®šç›‘å¬å™¨æ—¶ï¼Œä¼šè§¦å‘å“ªäº›é€»è¾‘</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#f92672">&lt;</span>V <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">@Nullable</span> Object<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addCallback</span>(<span style="color:#66d9ef">final</span> ListenableFuture<span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> future,
</span></span><span style="display:flex;"><span>                                                            <span style="color:#66d9ef">final</span> FutureCallback<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">super</span> V<span style="color:#f92672">&gt;</span> callback,
</span></span><span style="display:flex;"><span>                                                            Executor executor) {
</span></span><span style="display:flex;"><span>    Preconditions.<span style="color:#a6e22e">checkNotNull</span>(callback);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Yipsen: å°† future ä¸ callback ä¸€èµ·å°è£…ä¸º CallbackListener æ„æˆç›‘å¬å™¨</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å†è°ƒç”¨ ListenableFuture çš„ addListener æ–¹æ³•æ·»åŠ å›è°ƒç›‘å¬å™¨ç»™ ListenableFutureã€‚</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//ï¼ˆCallbackListener å®é™…æ˜¯ä¸ª Runnable ä»»åŠ¡ï¼Œåªåšä¸€ä»¶äº‹ï¼šä» future ä¸­å–å€¼ï¼Œå›è°ƒ callback å†…çš„æ–¹æ³•ï¼Œéšåå¯ä»¥çœ‹ä¸‹ï¼‰</span>
</span></span><span style="display:flex;"><span>    future.<span style="color:#a6e22e">addListener</span>(<span style="color:#66d9ef">new</span> CallbackListener<span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span>(future, callback), executor);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æœ¬ä¾‹æ­¤å¤„çš„ ListenableFuture æ˜¯ TrustedListenableFutureTaskï¼Œå…¶æ²¡æœ‰é‡å†™ addListener æ–¹æ³•ï¼Œé»˜è®¤ä½¿ç”¨çˆ¶ç±» AbstractFuture çš„ï¼Œæ¥ä¸‹çœ‹ä¸‹<code>AbstractFuture#addListener</code>çš„é€»è¾‘ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addListener</span>(Runnable listener, Executor executor) {
</span></span><span style="display:flex;"><span>    checkNotNull(listener, <span style="color:#e6db74">&#34;Runnable was null.&#34;</span>);
</span></span><span style="display:flex;"><span>    checkNotNull(executor, <span style="color:#e6db74">&#34;Executor was null.&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Yipsen: å¦‚æœç»‘å®šå›è°ƒç›‘å¬å™¨ listener æ—¶ï¼Œä»»åŠ¡è¿˜æœªå®Œæˆï¼Œåˆ™å°†ç›‘å¬å™¨åŠ å…¥åˆ°ç›‘å¬å™¨åˆ—è¡¨ listeners ä¸­ã€‚</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>isDone()) {
</span></span><span style="display:flex;"><span>        Listener oldHead <span style="color:#f92672">=</span> listeners;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (oldHead <span style="color:#f92672">!=</span> Listener.<span style="color:#a6e22e">TOMBSTONE</span>) {
</span></span><span style="display:flex;"><span>            Listener newNode <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Listener(listener, executor);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>                newNode.<span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> oldHead;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (ATOMIC_HELPER.<span style="color:#a6e22e">casListeners</span>(<span style="color:#66d9ef">this</span>, oldHead, newNode)) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                oldHead <span style="color:#f92672">=</span> listeners; <span style="color:#75715e">// re-read</span>
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">while</span> (oldHead <span style="color:#f92672">!=</span> Listener.<span style="color:#a6e22e">TOMBSTONE</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Yipsen: å¦‚æœç»‘å®šå›è°ƒç›‘å¬å™¨ listener æ—¶ï¼Œä»»åŠ¡éƒ½å·²ç»æ‰§è¡Œå®Œäº†ï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿è¡Œå›è°ƒã€‚</span>
</span></span><span style="display:flex;"><span>    executeListener(listener, executor);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æ­¤å¤„åˆ†ä¸¤ç§æƒ…å†µï¼š</p>
<ol>
<li>å¦‚æœç»™ ListenableFuture ç»‘å®šå›è°ƒç›‘å¬å™¨<code>listener</code>æ—¶ï¼Œä»»åŠ¡å·²ç»æ‰§è¡Œå®Œæˆäº†ï¼Œé‚£ä¹ˆä¼šç›´æ¥æ‰§è¡Œç›‘å¬å™¨<code>executeListener</code></li>
<li>å¦‚æœä»»åŠ¡è¿˜æ²¡æ‰§è¡Œå®Œï¼Œåˆ™åŠ å…¥ç›‘å¬å™¨é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…åç»­ä»»åŠ¡æ‰§è¡Œå®Œåå†æ‰§è¡Œã€‚</li>
</ol>
<p>æˆ‘ä»¬å…ˆçœ‹ä¸‹ç¬¬ä¸€ç§æƒ…å†µï¼Œç›´æ¥è¿è¡Œç›‘å¬å™¨æ—¶å…·ä½“éƒ½åšäº†å“ªäº›é€»è¾‘</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">executeListener</span>(Runnable runnable, Executor executor) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        executor.<span style="color:#a6e22e">execute</span>(runnable);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (RuntimeException e) {
</span></span><span style="display:flex;"><span>        log.<span style="color:#a6e22e">log</span>(Level.<span style="color:#a6e22e">SEVERE</span>,<span style="color:#e6db74">&#34;RuntimeException while executing runnable &#34;</span> <span style="color:#f92672">+</span> runnable <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; with executor &#34;</span> <span style="color:#f92672">+</span> executor,e);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å…¶å®é™…å°±æ˜¯ä½¿ç”¨äº†ä¼ å…¥çš„çº¿ç¨‹æ±  executorï¼Œç›´æ¥è¿è¡Œ<code>CallbackListener</code>ï¼Œï¼ˆCallbackListener å®é™…ä¹Ÿæ˜¯ä¸€ä¸ª Runnable ä»»åŠ¡ï¼‰ï¼Œå³æ‰§è¡Œ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (future <span style="color:#66d9ef">instanceof</span> InternalFutureFailureAccess) {
</span></span><span style="display:flex;"><span>        Throwable failure <span style="color:#f92672">=</span> InternalFutures.<span style="color:#a6e22e">tryInternalFastPathGetFailure</span>((InternalFutureFailureAccess) future);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (failure <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            callback.<span style="color:#a6e22e">onFailure</span>(failure);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">final</span> V value;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Yipsen: ä» ListenableFuture å–å›ç»“æœ</span>
</span></span><span style="display:flex;"><span>        value <span style="color:#f92672">=</span> getDone(future);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (ExecutionException e) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Yipsen: å–å›å¤±è´¥ï¼Œå°±å›è°ƒ onFailure æ–¹æ³•</span>
</span></span><span style="display:flex;"><span>        callback.<span style="color:#a6e22e">onFailure</span>(e.<span style="color:#a6e22e">getCause</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (RuntimeException <span style="color:#f92672">|</span> Error e) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Yipsen: åŒä¸Š</span>
</span></span><span style="display:flex;"><span>        callback.<span style="color:#a6e22e">onFailure</span>(e);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Yipsen: å–å›æˆåŠŸï¼Œå°±å›è°ƒ onSuccess æ–¹æ³•</span>
</span></span><span style="display:flex;"><span>    callback.<span style="color:#a6e22e">onSuccess</span>(value);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>getDone æ–¹æ³•å…·ä½“è¿è¡Œå¦‚ä¸‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@CanIgnoreReturnValue</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ParametricNullness</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#f92672">&lt;</span>V <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">@Nullable</span> Object<span style="color:#f92672">&gt;</span> V <span style="color:#a6e22e">getUninterruptibly</span>(Future<span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> future) <span style="color:#66d9ef">throws</span> ExecutionException {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> interrupted <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (<span style="color:#66d9ef">true</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Yipsen: çœ‹åˆ°è¿™é‡Œåº”è¯¥å°±æ˜ç™½äº†ï¼Œå®é™…å°±æ˜¯è°ƒç”¨ Future#get é˜»å¡è‡ªèº«çº¿ç¨‹ï¼Œç›´åˆ°è¯»å–è¿”å›å€¼</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> future.<span style="color:#a6e22e">get</span>();
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (InterruptedException e) {
</span></span><span style="display:flex;"><span>                interrupted <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (interrupted) {
</span></span><span style="display:flex;"><span>            Thread.<span style="color:#a6e22e">currentThread</span>().<span style="color:#a6e22e">interrupt</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯è§ï¼Œæ–¹æ³•éå¸¸ç›´ç™½ï¼Œè¿è¡Œç›‘å¬å™¨å°±æ˜¯ä» Future#get ä¸­è·å–å€¼ï¼Œè¯¥æ–¹æ³•ä¼šæŠŠå½“å‰çº¿ç¨‹æŒ‚èµ·ï¼Œç›´åˆ° Future å†…çš„ Callable è¿è¡Œå®Œæˆè°ƒç”¨ Future#set åå†å”¤é†’å¤„ç†åç»­é€»è¾‘ã€‚æ­¤å¤„ä¸å†èµ˜è¿°ï¼Œè¯¦ç»†å¯ä»¥çœ‹ä¸‹ <a href="../future-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">Future æºç è§£æ</a> ç¯‡ã€‚</p>
<p>ç”±æ­¤å¯è§ï¼Œåœ¨ä½¿ç”¨æ™®é€šçš„ Future æ—¶ï¼Œä¸»çº¿ç¨‹è°ƒç”¨ get æ–¹æ³•ä¼šé˜»å¡ç›´åˆ°æœ‰ç»“æœå”¤é†’ï¼Œè€Œ ListenableFuture æ¨¡å¼ï¼Œåˆ™æ˜¯å¦å¤–å¯åŠ¨ä¸€ä¸ªå­çº¿ç¨‹ï¼Œå¸®ä¸»çº¿ç¨‹é˜»å¡ï¼Œä»¥åŠè¿è¡Œåç»­é€»è¾‘äº†ã€‚å­çº¿ç¨‹æ›¿çˆ¶åˆ†å¿§äº†å±äºæ˜¯ã€‚</p>
<p>å¥½ï¼Œç°åœ¨å›è¿‡å¤´çœ‹ä¸‹ç¬¬äºŒç§æƒ…å†µï¼Œå°±æ˜¯åŠ å…¥ç›‘å¬å™¨æ—¶ä»»åŠ¡è¿˜æ²¡æ‰§è¡Œå®Œï¼Œè€Œå…¥é˜Ÿåˆ° listeners åï¼Œä»€ä¹ˆæ—¶å€™å†è¢«å–å‡ºå¹¶æ‰§è¡Œï¼Ÿ</p>
<p>ä¸€ä¸ªå¾ˆç›´æ¥çš„æƒ³æ³•ï¼Œæ—¢ç„¶ç›‘å¬å™¨æ˜¯å› ä¸ºä»»åŠ¡æ²¡å®Œæˆè€Œè¢«æ”¾å…¥é˜Ÿä¸­ç­‰å¾…å›è°ƒï¼Œé‚£ä¹ˆå›è°ƒæ—¶æœºè‚¯å®šæ˜¯ä»»åŠ¡å®Œæˆæ—¶åˆ»å¤„ç†ï¼Œè€Œæˆ‘ä»¬çŸ¥é“ Future åœ¨ Callable ä»»åŠ¡å®Œæˆæ—¶ï¼Œä¼šè°ƒç”¨ Future#set æˆ– Future#setException æ–¹æ³•è®¾ç½® Callable ä»»åŠ¡æ‰§è¡Œçš„ç»“æœã€‚</p>
<p>è¿½è¸ª<code>TrustedListenableFutureTask</code>å‘ç°æ²¡æœ‰é‡å†™<code>set</code>æ–¹æ³•ï¼Œå³å®é™…è°ƒç”¨çš„çˆ¶ç±»çš„ï¼š<code>AbstractFuture#set</code>ï¼Œå¯è§ ListenableFuture çš„å¾ˆå¤šæ ¸å¿ƒé€»è¾‘éƒ½åœ¨ AbstractFuture ç±»ä¸­å®ç°äº†ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@CanIgnoreReturnValue</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">@ParametricNullness</span> V value) {
</span></span><span style="display:flex;"><span>    Object valueToSet <span style="color:#f92672">=</span> value <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> NULL : value;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (ATOMIC_HELPER.<span style="color:#a6e22e">casValue</span>(<span style="color:#66d9ef">this</span>, <span style="color:#66d9ef">null</span>, valueToSet)) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Yipsen: åœ¨æŠŠ Callable ä»»åŠ¡æ‰§è¡Œç»“æœ value è®¾ç½®å®Œæˆåï¼Œå¼€å§‹æ‰§è¡Œå–„åå¤„ç† complete æ–¹æ³•</span>
</span></span><span style="display:flex;"><span>        complete(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¦‚åŒ FutureTaskï¼Œåœ¨å®Œæˆè®¾ç½®ç»“æœåï¼Œä¼šè°ƒç”¨ç›¸åº”å–„åæ–¹æ³•ï¼ŒFutureTask æ˜¯å”¤é†’ waiters é‡Œçš„é˜»å¡çº¿ç¨‹ï¼Œè€Œ AbstractFuture åˆ™æ˜¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/** Unblocks all threads and runs all listeners. */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">complete</span>(AbstractFuture<span style="color:#f92672">&lt;?&gt;</span> param) {
</span></span><span style="display:flex;"><span>    AbstractFuture<span style="color:#f92672">&lt;?&gt;</span> future <span style="color:#f92672">=</span> param;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Listener next <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    outer:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#66d9ef">true</span>) {
</span></span><span style="display:flex;"><span>        future.<span style="color:#a6e22e">releaseWaiters</span>();
</span></span><span style="display:flex;"><span>        future.<span style="color:#a6e22e">afterDone</span>();
</span></span><span style="display:flex;"><span>        next <span style="color:#f92672">=</span> future.<span style="color:#a6e22e">clearListeners</span>(next);
</span></span><span style="display:flex;"><span>        future <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Yipsen: éå†å…¨éƒ¨ listeners å†…çš„å›è°ƒç›‘å¬å™¨ã€‚</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (next <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            Listener curr <span style="color:#f92672">=</span> next;
</span></span><span style="display:flex;"><span>            next <span style="color:#f92672">=</span> next.<span style="color:#a6e22e">next</span>;
</span></span><span style="display:flex;"><span>            Runnable task <span style="color:#f92672">=</span> requireNonNull(curr.<span style="color:#a6e22e">task</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (task <span style="color:#66d9ef">instanceof</span> SetFuture) {
</span></span><span style="display:flex;"><span>                SetFuture<span style="color:#f92672">&lt;?&gt;</span> setFuture <span style="color:#f92672">=</span> (SetFuture<span style="color:#f92672">&lt;?&gt;</span>) task;
</span></span><span style="display:flex;"><span>                future <span style="color:#f92672">=</span> setFuture.<span style="color:#a6e22e">owner</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (future.<span style="color:#a6e22e">value</span> <span style="color:#f92672">==</span> setFuture) {
</span></span><span style="display:flex;"><span>                    Object valueToSet <span style="color:#f92672">=</span> getFutureValue(setFuture.<span style="color:#a6e22e">future</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (ATOMIC_HELPER.<span style="color:#a6e22e">casValue</span>(future, setFuture, valueToSet)) {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">continue</span> outer;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Yipsen: ä¸ç¬¬ä¸€ç§æƒ…å†µä¸€æ ·ï¼Œå°±æ˜¯è°ƒç”¨ executeListenerï¼Œå³ç›´æ¥è¿è¡Œ CallbackListenerã€‚</span>
</span></span><span style="display:flex;"><span>                executeListener(task, requireNonNull(curr.<span style="color:#a6e22e">executor</span>));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è‡³æ­¤ï¼ŒCallable ä»»åŠ¡å®Œæˆåï¼Œå¯¹åº”çš„ Future å†…ç»‘å®šçš„å›è°ƒç›‘å¬å™¨ï¼Œå°±ä¼šè¢«å®è¡Œï¼Œå®ç°äº†å¼‚æ­¥å›è°ƒæœºåˆ¶ã€‚</p>
<h2 id="2-æ•´ä½“è°ƒç”¨æœºåˆ¶">2. æ•´ä½“è°ƒç”¨æœºåˆ¶</h2>
<p>// TODO: è¡¥ä¸€å¼ å›¾</p>
<p>æˆ‘ä»¬å¯ä»¥ç¨å¾®æ”¹å†™ä¸‹</p>
<h2 id="3-æ€»ç»“">3. æ€»ç»“</h2>
<p>guava çš„ ListenableFuture å®ç°å·§å¦™çš„ä½¿ç”¨äº†è£…é¥°å§”æ´¾è®¾è®¡æ¨¡å¼ï¼Œå¯¹ JDK è‡ªå¸¦çš„æ‰§è¡Œå™¨è¿›è¡Œäº†èƒ½åŠ›å¢å¼ºï¼Œæ ¸å¿ƒçº¿ç¨‹è¿è¡Œèƒ½åŠ›ä¾æ—§ä½¿ç”¨çš„ JDKï¼Œè€Œä¸ç”¨å¦å¤–å¼€å‘ã€‚</p>
<p>åŒæ—¶æˆ‘ä»¬å‘ç°ä½¿ç”¨å¼‚æ­¥ç›‘å¬æ¨¡å¼ï¼Œä¸»çº¿ç¨‹å¯ä»¥æ— é˜»å¡çš„ä¸€ç›´è¿è¡Œï¼Œä¸æ–­åœ°åˆ›å»ºä¸€ä¸ª Callable ä»»åŠ¡ï¼Œç»‘å®šä¸€ä¸ªæ–°çš„ ListenableFutureï¼Œå¯¹åº”å†ç»‘å®šä¸€ä¸ªæ–°çš„ CallbackListenerã€‚</p>
<p>æ‰§è¡Œè°ƒç”¨é“¾è·¯ï¼šCallable run -&gt; Callable return -&gt; ListenableFuture set -&gt; CallbackListener onSuccessã€‚</p>
<p>guava çš„å®˜æ–¹ä¹Ÿä¸€ç›´åœ¨æ¨èä½¿ç”¨è¿™ç§æ¨¡å¼ï¼Œåœ¨ gRPC æ¨¡å—ä¸­ä¹Ÿå¼•å…¥äº† ListenableFutureï¼Œå¯ä»¥æ”¯æŒæ— é˜»å¡å¼åœ°è¿œç¨‹è°ƒç”¨ï¼Œä»è€Œé™ä½é›ªå´©é£é™©ï¼Œè¾¾åˆ°ä¸€å®šç¨‹åº¦æ•…éšœè§£è€¦çš„ç›®çš„ã€‚</p>
<p>å¦å¤–å¯ä»¥çœ‹åˆ° ListenableFuture çš„ä½¿ç”¨å®é™…ä¼šå‘èµ·ä¸¤ä¸ªå­çº¿ç¨‹ï¼š</p>
<ol>
<li>ç¬¬ä¸€ä¸ª Callable ä»»åŠ¡çº¿ç¨‹ä¼šç”± ListeningExecutorService ä¸­åŒ…è£…çš„ Executor ç”Ÿæˆï¼Œå¹¶åœ¨æäº¤åç«‹å³æ‰§è¡Œã€‚</li>
<li>ç¬¬äºŒä¸ª Callback å›è°ƒçº¿ç¨‹å¯ä»¥ç”±å¦å¤–æŒ‡å®šçš„çº¿ç¨‹æ± ç”Ÿæˆï¼ˆæœ¬æ–‡çš„æ¡ˆä¾‹ä¸ Callable ä»»åŠ¡çº¿ç¨‹ä½¿ç”¨äº†åŒä¸€ä¸ªçº¿ç¨‹æ± ï¼‰ï¼Œå¹¶åœ¨ä»»åŠ¡å®Œæˆåæ‰§è¡Œå›è°ƒå‡½æ•°ã€‚</li>
</ol>

    </div>
</article>
<aside class="catalog">
    <div class="catalog-title">ç›®å½•</div>
    <div class="catalog-list">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#1-listenablefuture-æºç åˆ†æ">1. ListenableFuture æºç åˆ†æ</a>
      <ul>
        <li><a href="#11-ä¸€æ®µç®€å•çš„ä»£ç ä¾‹å­">1.1 ä¸€æ®µç®€å•çš„ä»£ç ä¾‹å­</a></li>
        <li><a href="#12-listenablefuture-æºç åˆ†æ">1.2 ListenableFuture æºç åˆ†æ</a></li>
      </ul>
    </li>
    <li><a href="#2-æ•´ä½“è°ƒç”¨æœºåˆ¶">2. æ•´ä½“è°ƒç”¨æœºåˆ¶</a></li>
    <li><a href="#3-æ€»ç»“">3. æ€»ç»“</a></li>
  </ul>
</nav>
    </div>
</aside>
<div class="division-line"></div>
<div class="misc">
    <div> 
        <a class="post-category" href="/%20categories/java%E5%B9%B6%E5%8F%91/">ğŸ“’JAVAå¹¶å‘</a>
        </div>
    <div></div>
</div>

    </main>
    <footer class="p-x-0 p-b-2 m-auto">
        <div id="pagination">
            
<div class="division-line"></div>
<div class="paginator">
    <div class="prev">
        
        <a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/future/scheduledfuture-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><span>ScheduledFuture æºç åˆ†æ</span></a>
    </div>
    <div class="next">
        
        <a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/future/future-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><span>Future æºç åˆ†æ</span></a>
    </div>
</div>

        </div>
        <div class="position-fixed b-4 r-4">
            <ul class="float-button-bar">
    <li>
        <button class="float-button top" onclick="scrollToTop(this);">UP</button>
    </li>
    <li>
        <button class="float-button toggler" onclick="changeSkin(this);">DARK</button>
    </li>
</ul>
        </div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 27270 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    

<script src="https://cdn.staticfile.net/gumshoe/5.1.1/gumshoe.min.js"></script>
<script>
    var spy = new Gumshoe('#TableOfContents a', {
        nested: true,
        nestedClass: 'active'
    });
</script>

<script>
    const changeSkin = () => {
        document.getElementById('page').classList.toggle('night');
    }
    const scrollToTop = () => {
        window.scrollTo(0, 0);
    }
</script>
</body>

</html>