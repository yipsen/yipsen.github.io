<!DOCTYPE html>
<html lang="en" class="h-100">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=8080&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>ScheduledThreadPoolExecutor æºç åˆ†æ | Yipsen Ye</title>
<meta name="description" content="1. ScheduledThreadPoolExecutor çš„ä½¿ç”¨ ä¸€æ®µç®€å•çš„ä»£ç ä¾‹å­ public static void main(String[] args) { ScheduledExecutorService executor = Executors.newScheduledThreadPool(10); executor.schedule(() -&gt; { System.out.println(&#34;schedule task is running....&#34;); return &#34;schedule task done&#34;; }, 10, TimeUnit.SECONDS); System.out.println(&#34;main thread run here.&#34;); executor.shutdown(); } å…¶è¿è¡Œç»“æœå¦‚ä¸‹ï¼š
main thread run here.schedule task is running.... 2. æºç åˆ†æ ScheduledExecutorService executor = Executors.newScheduledThreadPool(10); // å®é™…è¿”å›çš„ä¾¿æ˜¯ ScheduledThreadPoolExecutor è€Œ ScheduledThreadPoolExecutor å®é™…æ˜¯ ThreadPoolExecutor çš„å­ç±»ï¼Œåœ¨å…¶è®¾è®¡åŸºç¡€ä¸Šæ‰©å±•äº†å®šæ—¶èƒ½åŠ›ï¼Œä¸ ThreadPoolExecutor ä¸åŒçš„æ˜¯ï¼ŒScheduledThreadPoolExecutor å†…çš„ workQueue é‡‡ç”¨çš„æ˜¯ DelayedWorkQueueï¼Œä¸€ä¸ª BlockingQueue å®ç°ï¼Œä½†æ”¯æŒå®šæ—¶èƒ½åŠ›ï¼Œå†…éƒ¨å®ç°æ›´ç±»ä¼¼ DelayQueueã€‚
public ScheduledThreadPoolExecutor(int corePoolSize) { super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS, new DelayedWorkQueue()); } æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹æ ¸å¿ƒé€»è¾‘ï¼Œå³scheduleæ–¹æ³•çš„é€»è¾‘ï¼š
">
<meta name="author" content="yipsen">

<link rel="stylesheet" type="text/css" href="/styles/main.css">
<link rel="stylesheet" type="text/css" href="/styles/standard.css">

</head>

<body id="page" class="ff-consolas m-0">
    <header class="d-flex fd-row fw-wrap jc-between ai-center p-x-1 p-y-1 m-auto">
        <div class="nav-logo">
    <a href="http://localhost:8080/">
        
        <span class="nav-title">Yipsen Ye</span>
    </a>
</div>
<nav class="position-relative d-flex fw-wrap jc-end ai-center p-y-05">
    <ul class="d-flex fw-wrap ls-none p-l-0 m-0">
        
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/series/java/">JAVA</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/design/">è®¾è®¡</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/network/">ç½‘ç»œ</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/framework/">æ¡†æ¶</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/middleware/">ä¸­é—´ä»¶</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/plugin/">æ’ä»¶</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/linux/">LINUX</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/posts/">éšå¿ƒè°ˆ</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/others/">å±±æµ·æ–‡åº“</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content" class="m-auto">
        
<aside class="sidebar"><div>
    
    
        
        
        <a href="/categories/java%e5%b9%b6%e5%8f%91/">JAVAå¹¶å‘</a>
        <ul>
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/lock/abstractqueuedsynchronizer-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">AbstractQueuedSynchronizer æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/lock/reentrantlock-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">ReentrantLock æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/lock/semaphore-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Semaphore æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/lock/reentrantreadwritelock-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">ReentrantReadWriteLock æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/lock/countdownlatch--%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">CountDownLatch æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/lock/cyclicbarrier-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">CyclicBarrier æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/lock/phaser-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Phaser æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/lock/exchanger-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Exchanger æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/datastructure/blockingqueue-%E5%88%86%E6%9E%90/">BlockingQueue åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/datastructure/delayqueue-%E4%BD%BF%E7%94%A8%E4%B8%8E%E5%8E%9F%E7%90%86/">DelayQueue ä½¿ç”¨ä¸åŸç†ï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/datastructure/concurrenthashmap-%E5%88%86%E6%9E%90/">ConcurrentHashMap åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/datastructure/hashedwheeltimer-%E6%97%B6%E9%97%B4%E8%BD%AE/">HashedWheelTimer æ—¶é—´è½®ï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/datastructure/copyonwritearraylist-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">CopyOnWriteArrayList æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/future/future-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Future æºç åˆ†æ</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/future/scheduledfuture-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">ScheduledFuture æºç åˆ†æ</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/future/completablefuture-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">CompletableFuture æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/future/listenablefuture-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">ListenableFuture æºç åˆ†æ</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/threadpool/threadpoolexecutor-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">ThreadPoolExecutor æºç åˆ†æ</a></li>
            
            
            
            <li>ScheduledThreadPoolExecutor æºç åˆ†æ</li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/threadpool/forkjoinpool-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">ForkJoinPool æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
            
            <li><a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/threadpool/completionservice-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">CompletionService æºç åˆ†æï¼ˆæœªå®Œï¼‰</a></li>
            
            
        </ul>
    
</div></aside>
<article>
    <h1 class="m-b-1">ScheduledThreadPoolExecutor æºç åˆ†æ</h1>
    <div class="d-flex fd-row jc-center">
        <div class="fc-subtle">
            <span>2022-01-10 23:36:41</span>
        </div>
    </div>
    <div class="post-content">
        <h2 id="1-scheduledthreadpoolexecutor-çš„ä½¿ç”¨">1. ScheduledThreadPoolExecutor çš„ä½¿ç”¨</h2>
<h3 id="ä¸€æ®µç®€å•çš„ä»£ç ä¾‹å­">ä¸€æ®µç®€å•çš„ä»£ç ä¾‹å­</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>    ScheduledExecutorService executor <span style="color:#f92672">=</span> Executors.<span style="color:#a6e22e">newScheduledThreadPool</span>(10);
</span></span><span style="display:flex;"><span>    executor.<span style="color:#a6e22e">schedule</span>(() <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;schedule task is running....&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;schedule task done&#34;</span>;
</span></span><span style="display:flex;"><span>    }, 10, TimeUnit.<span style="color:#a6e22e">SECONDS</span>);
</span></span><span style="display:flex;"><span>    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;main thread run here.&#34;</span>);
</span></span><span style="display:flex;"><span>    executor.<span style="color:#a6e22e">shutdown</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å…¶è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code class="language-log" data-lang="log">main thread run here.
schedule task is running....
</code></pre><h2 id="2-æºç åˆ†æ">2. æºç åˆ†æ</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>ScheduledExecutorService executor <span style="color:#f92672">=</span> Executors.<span style="color:#a6e22e">newScheduledThreadPool</span>(10); <span style="color:#75715e">// å®é™…è¿”å›çš„ä¾¿æ˜¯ ScheduledThreadPoolExecutor</span>
</span></span></code></pre></div><p>è€Œ ScheduledThreadPoolExecutor å®é™…æ˜¯ ThreadPoolExecutor çš„å­ç±»ï¼Œåœ¨å…¶è®¾è®¡åŸºç¡€ä¸Šæ‰©å±•äº†å®šæ—¶èƒ½åŠ›ï¼Œä¸ ThreadPoolExecutor ä¸åŒçš„æ˜¯ï¼ŒScheduledThreadPoolExecutor å†…çš„ workQueue é‡‡ç”¨çš„æ˜¯ DelayedWorkQueueï¼Œä¸€ä¸ª BlockingQueue å®ç°ï¼Œä½†æ”¯æŒå®šæ—¶èƒ½åŠ›ï¼Œå†…éƒ¨å®ç°æ›´ç±»ä¼¼ DelayQueueã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ScheduledThreadPoolExecutor</span>(<span style="color:#66d9ef">int</span> corePoolSize) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">super</span>(corePoolSize, Integer.<span style="color:#a6e22e">MAX_VALUE</span>, 0, NANOSECONDS, <span style="color:#66d9ef">new</span> DelayedWorkQueue());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹æ ¸å¿ƒé€»è¾‘ï¼Œå³<code>schedule</code>æ–¹æ³•çš„é€»è¾‘ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> ScheduledFuture<span style="color:#f92672">&lt;?&gt;</span> schedule(Runnable command, <span style="color:#66d9ef">long</span> delay, TimeUnit unit) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (command <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> unit <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NullPointerException();
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Yipsen: å°† ThreadPoolExecutor è¿”å›çš„ RunnableFutureï¼ˆå­ç±» FutureTaskï¼‰åŒ…è£…ä¸ºä¸€ä¸ª RunnableScheduledFutureï¼ˆå­ç±» ScheduledFutureTaskï¼‰</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Yipsen: æ³¨æ„è¿™ä¸ª triggerTimeï¼Œå…¶å®é™…å°±æ˜¯é€šè¿‡ delay ä¸å½“å‰æ—¶é—´ now è®¡ç®—å‡ºè¯¥ä»»åŠ¡çš„å…·ä½“æ‰§è¡Œæ—¶é—´ã€‚</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Yipsen: åç»­è¯¥ ScheduledFutureTask ä¼šè¢«æ”¾å…¥åˆ° workQueue é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œï¼Œè¯¥è®¡ç®—å¾—å‡ºçš„ triggerTime å°±æ˜¯å…¶å‡ºé˜Ÿæ¡ä»¶ã€‚</span>
</span></span><span style="display:flex;"><span>    RunnableScheduledFuture<span style="color:#f92672">&lt;?&gt;</span> t <span style="color:#f92672">=</span> decorateTask(command, <span style="color:#66d9ef">new</span> ScheduledFutureTask<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;</span>(command, <span style="color:#66d9ef">null</span>, triggerTime(delay, unit)));
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Yipsen: éšåæ‰§è¡Œ</span>
</span></span><span style="display:flex;"><span>    delayedExecute(t);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> t;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å…·ä½“çœ‹ä¸‹ delayedExecute å³æ‰€è°“å»¶è¿Ÿæ‰§è¡Œçš„é€»è¾‘:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">delayedExecute</span>(RunnableScheduledFuture<span style="color:#f92672">&lt;?&gt;</span> task) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (isShutdown())
</span></span><span style="display:flex;"><span>        reject(task);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Yipsenï¼šä¸ ThreadPoolExecutor ä¸åŒï¼Œç›´æ¥å°±æ˜¯æ”¾å…¥ workQueue é˜Ÿåˆ—ä¸­ï¼Œå³ DelayedWorkQueue ä¸­ã€‚</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span>.<span style="color:#a6e22e">getQueue</span>().<span style="color:#a6e22e">add</span>(task);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (isShutdown() <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">!</span>canRunInCurrentRunState(task.<span style="color:#a6e22e">isPeriodic</span>()) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>            remove(task))
</span></span><span style="display:flex;"><span>            task.<span style="color:#a6e22e">cancel</span>(<span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Yipsen: è¿è¡Œ</span>
</span></span><span style="display:flex;"><span>            ensurePrestart();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°<code>delayedExecute</code>åªæ˜¯æŠŠä»»åŠ¡ç®€å•æ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œæ‰€ä»¥å…³é”®æ‰§è¡Œé€»è¾‘éœ€è¦çœ‹ä¸‹<code>ensurePrestart</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ensurePrestart</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> wc <span style="color:#f92672">=</span> workerCountOf(ctl.<span style="color:#a6e22e">get</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (wc <span style="color:#f92672">&lt;</span> corePoolSize)
</span></span><span style="display:flex;"><span>        addWorker(<span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (wc <span style="color:#f92672">==</span> 0)
</span></span><span style="display:flex;"><span>        addWorker(<span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æ ¸å¿ƒå³æ–°å»ºä¸€ä¸ªæ— åˆå§‹ä»»åŠ¡çš„ Workerï¼Œè¿™éƒ¨åˆ†è¯¦ç»†é€»è¾‘å·²ç»åœ¨ ThreadPoolExecutor ä¸€æ–‡ä¸­åˆ†æè¿‡ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚ç®€å•è¯´å…¶æµç¨‹ä¸»è¦æ˜¯åˆ¤æ–­ Worker æ˜¯å¦å·²æ»¡å®¹é‡ï¼Œå¦‚æœä¸æ»¡åˆ™åˆ›å»ºå¹¶æ‰§è¡Œä»»åŠ¡ï¼Œå¦åˆ™è¯´æ˜å·²æœ‰ Worker åœ¨è¿è¡Œï¼Œå…¶è‡ªç„¶ä¼šä» workQueue ä¸­å–ä»»åŠ¡è¿è¡Œï¼Œè€Œ<code>delayedExecute</code>å·²ç»æŠŠä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ä¸­äº†ã€‚</p>
<p>å½“ç„¶æ­¤å¤„<code>ensurePrestart</code>ä¿è¯äº†å¦‚æœé¢„è®¾çš„ corePoolSize æ˜¯0ï¼Œé‚£ä¹ˆå°±é‡‡ç”¨ maximumPoolSize ä½œä¸ºæœ€å¤§å®¹é‡å‚ç…§ï¼Œå¯ä»¥ä¿è¯çº¿ç¨‹æ± ä¸­è‡³å°‘æœ‰ä¸€ä¸ª Worker å¯ä»¥è¿è¡Œä»»åŠ¡ã€‚</p>
<blockquote>
<p>æ³¨ï¼šThreadPoolExecutor çš„æ„é€ å‡½æ•°å·²ç»ä¿è¯äº† maximumPoolSize ä¸ä¼šä¸º0ã€‚</p>
</blockquote>
<p>å¯ä»¥çœ‹åˆ° <strong>ScheduledThreadPoolExecutor çš„çº¿ç¨‹æ± æ ¸å¿ƒèƒ½åŠ›éƒ½åœ¨é»˜è®¤æ²¿ç”¨ ThreadPoolExecutor çš„å®ç°ï¼Œè€Œå…¶æ‰©å±•çš„å®šæ—¶æ‰§è¡Œèƒ½åŠ›ï¼Œåˆ™ä¾èµ–ç€ DelayedWorkQueue çš„èƒ½åŠ›</strong>ã€‚å…¶å°†ä»»åŠ¡æäº¤åˆ°<code>DelayedWorkQueue</code>ä¸­ï¼Œå¹¶ç­‰å¾… Worker ä»å…¶ä¸­è·å–ä»»åŠ¡æ‰§è¡Œï¼Œæˆ‘ä»¬çœ‹ä¸‹ Worker ä¸­ä»é˜Ÿåˆ—ä¸­å–ä»»åŠ¡çš„é€»è¾‘ï¼Œå³<code>DelayedWorkQueue#poll</code>æˆ–<code>DelayedWorkQueue#task</code>çš„é€»è¾‘:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> RunnableScheduledFuture<span style="color:#f92672">&lt;?&gt;</span> take() <span style="color:#66d9ef">throws</span> InterruptedException {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">final</span> ReentrantLock lock <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">lock</span>;
</span></span><span style="display:flex;"><span>    lock.<span style="color:#a6e22e">lockInterruptibly</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (;;) {
</span></span><span style="display:flex;"><span>            RunnableScheduledFuture<span style="color:#f92672">&lt;?&gt;</span> first <span style="color:#f92672">=</span> queue<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (first <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>                available.<span style="color:#a6e22e">await</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Yipsen: æ‹¿åˆ°é˜Ÿåˆ—çš„é˜Ÿå¤´ä»»åŠ¡ï¼Œçœ‹ä¸‹å¯¹æ¯”ç°æœ‰æ—¶é—´æ˜¯å¦å·²ç»å€’è®¡æ—¶åˆ°0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Yipsen: å¦‚æœæ˜¯ï¼Œåˆ™è¿”å›ä»»åŠ¡ï¼Œäº¤ç”± Worker è¿è¡Œï¼Œå¹¶è°ƒæ•´é˜Ÿåˆ—çš„ä½ç½®ã€‚</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Yipsen: å¦åˆ™å°±ç­‰å¾… ReentrantLock çš„ available æ¡ä»¶ï¼Œçº¿ç¨‹æŒ‚èµ·ã€‚è¯¥é€»è¾‘çš„å®ç°ç±»ä¼¼ DelayedQueue</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">long</span> delay <span style="color:#f92672">=</span> first.<span style="color:#a6e22e">getDelay</span>(NANOSECONDS);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (delay <span style="color:#f92672">&lt;=</span> 0)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> finishPoll(first);
</span></span><span style="display:flex;"><span>                first <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (leader <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>                    available.<span style="color:#a6e22e">await</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    Thread thisThread <span style="color:#f92672">=</span> Thread.<span style="color:#a6e22e">currentThread</span>();
</span></span><span style="display:flex;"><span>                    leader <span style="color:#f92672">=</span> thisThread;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                        available.<span style="color:#a6e22e">awaitNanos</span>(delay);
</span></span><span style="display:flex;"><span>                    } <span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> (leader <span style="color:#f92672">==</span> thisThread)
</span></span><span style="display:flex;"><span>                            leader <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (leader <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> queue<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>            available.<span style="color:#a6e22e">signal</span>();
</span></span><span style="display:flex;"><span>        lock.<span style="color:#a6e22e">unlock</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä»ä¸Šé¢çš„é€»è¾‘å¯ä»¥çœ‹åˆ°ä»é˜Ÿåˆ—ä¸­å–ä»»åŠ¡ï¼Œéƒ½æ˜¯å–çš„é˜Ÿå¤´ï¼Œä¸”ä¼šç­‰å¾…é˜Ÿå¤´åˆ°æœŸã€‚é‚£ä¹ˆä¿è¯æ‰€æœ‰ä»»åŠ¡èƒ½æŒ‰æ—¶æ‰§è¡Œï¼Œå°±å¿…é¡»è¦æ±‚é˜Ÿåˆ—çš„æ’åºæ˜¯æŒ‰æ‰§è¡Œæ—¶é—´æ’åºçš„ï¼Œè¶Šå¿«åˆ°æœŸçš„æ’åœ¨è¶Šå‰é¢ã€‚é‚£ä¹ˆæˆ‘ä»¬çœ‹ä¸‹<code>DelayedWorkQueue</code>æ˜¯å¦æ˜¯è¿™æ ·å¤„ç†çš„ï¼Œæˆ‘ä»¬çœ‹é˜Ÿåˆ—å…¥é˜Ÿæ—¶çš„é€»è¾‘ï¼Œå³<code>DelayedWorkQueue#offer</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">offer</span>(Runnable x) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (x <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NullPointerException();
</span></span><span style="display:flex;"><span>    RunnableScheduledFuture<span style="color:#f92672">&lt;?&gt;</span> e <span style="color:#f92672">=</span> (RunnableScheduledFuture<span style="color:#f92672">&lt;?&gt;</span>)x;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">final</span> ReentrantLock lock <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">lock</span>;
</span></span><span style="display:flex;"><span>    lock.<span style="color:#a6e22e">lock</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> size;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&gt;=</span> queue.<span style="color:#a6e22e">length</span>)
</span></span><span style="display:flex;"><span>            grow();
</span></span><span style="display:flex;"><span>        size <span style="color:#f92672">=</span> i <span style="color:#f92672">+</span> 1;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">==</span> 0) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Yipsen: å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œé‚£å°±ç›´æ¥æ”¾é˜Ÿå¤´å°±å®Œäº‹äº†ã€‚</span>
</span></span><span style="display:flex;"><span>            queue<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> e;
</span></span><span style="display:flex;"><span>            setIndex(e, 0);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Yipsen: å¦‚æœä¸æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œåˆ™éœ€è¦è¿›è¡Œä¸€æ¬¡ siftUp è°ƒæ•´é˜Ÿåˆ—ï¼Œå°†å…ƒç´ æ”¾åˆ°åº”è¯¥åœ¨çš„ä½ç½®ã€‚å³æŒ‰æ—¶é—´æ’åºåçš„ä½ç½®ã€‚</span>
</span></span><span style="display:flex;"><span>            siftUp(i, e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (queue<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> e) {
</span></span><span style="display:flex;"><span>            leader <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>            available.<span style="color:#a6e22e">signal</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>        lock.<span style="color:#a6e22e">unlock</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Yipsen: çœ‹åˆ°è¿™é‡Œåº”è¯¥å¾ˆæ¸…æ¥šäº†ï¼ŒDelayedWorkQueue æ˜¯ä¸€ä¸ªå…¸å‹çš„å †ï¼Œä¹Ÿå³ä¼˜å…ˆé˜Ÿåˆ—ã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">siftUp</span>(<span style="color:#66d9ef">int</span> k, RunnableScheduledFuture<span style="color:#f92672">&lt;?&gt;</span> key) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (k <span style="color:#f92672">&gt;</span> 0) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> parent <span style="color:#f92672">=</span> (k <span style="color:#f92672">-</span> 1) <span style="color:#f92672">&gt;&gt;&gt;</span> 1;
</span></span><span style="display:flex;"><span>        RunnableScheduledFuture<span style="color:#f92672">&lt;?&gt;</span> e <span style="color:#f92672">=</span> queue<span style="color:#f92672">[</span>parent<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (key.<span style="color:#a6e22e">compareTo</span>(e) <span style="color:#f92672">&gt;=</span> 0)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        queue<span style="color:#f92672">[</span>k<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> e;
</span></span><span style="display:flex;"><span>        setIndex(e, k);
</span></span><span style="display:flex;"><span>        k <span style="color:#f92672">=</span> parent;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    queue<span style="color:#f92672">[</span>k<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> key;
</span></span><span style="display:flex;"><span>    setIndex(key, k);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="3-æ€»ç»“">3. æ€»ç»“</h2>
<p>æ€»ç»“ä¸€ä¸‹ï¼Œæ•´ä¸ª ScheduledThreadPoolExecutor çš„è¿è¡Œé€»è¾‘ï¼Œå®é™…ä¸ŠåŸºæœ¬è¿˜æ˜¯ ThreadPoolExecutor çš„æ“ä½œï¼Œè‡³å°‘åœ¨æ­¤åŸºç¡€ä¸Šæ‰©å±•äº†å®šæ—¶æ‰§è¡Œçš„èƒ½åŠ›ï¼Œè€Œè¯¥å®šæ—¶æ‰§è¡Œçš„èƒ½åŠ›ï¼Œéƒ½æ˜¯é ä¸€ä¸ªå»¶è¿Ÿä¼˜å…ˆé˜Ÿåˆ—<code>DelayedWorkQueue</code>è¿™ä¸ªæ•°æ®ç»“æ„æ¥æ”¯æ’‘ï¼Œä»¥æ§åˆ¶å‡ºé˜Ÿæ—¶æœºã€‚</p>
<p>å¦å¤–ä¸€ç‚¹ä¸åŒåœ¨äº ThreadPoolExecutor æ”¾å…¥ workQueue çš„æ˜¯ç”¨æˆ·ä»»åŠ¡æˆ–è€…åŒ…è£…åçš„ RunnableFutureï¼Œè€Œ ScheduledThreadPoolExecutor åˆ™æ˜¯ RunnableScheduledFutureï¼Œè¯¥ RunnableScheduledFuture æ‹¥æœ‰ Runnableï¼ŒFuture èƒ½åŠ›å¤–ï¼Œè¿˜æœ‰ Schedule å®šæ—¶è®¡ç®—ç›¸å…³çš„èƒ½åŠ›ã€‚</p>
<p>æ‰€ä»¥ ScheduledThreadPoolExecutor åœ¨æäº¤ä»»åŠ¡ä¼šï¼Œä¼šè®¡ç®—å®é™…åº”æ‰§è¡Œçš„æ—¶é—´ triggerTimeï¼Œå¹¶å­˜å‚¨åœ¨ RunnableScheduledFuture ä¸­ï¼Œå†æäº¤åˆ°é˜Ÿåˆ—ä¸­ï¼Œä»¥ triggerTime æ’åºã€‚ä¹‹å Worker ä¼šç­‰å¾…é˜Ÿå¤´åˆ°è¾¾ triggerTimeï¼Œé™†é™†ç»­ç»­æå‡ºé˜Ÿåˆ—ï¼Œå¹¶æ‰§è¡Œå…¶ä¸­çš„ç”¨æˆ·ä»»åŠ¡ã€‚ä¾æ¬¡åå¤ã€‚</p>

    </div>
</article>
<aside class="catalog">
    <div class="catalog-title">ç›®å½•</div>
    <div class="catalog-list">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#1-scheduledthreadpoolexecutor-çš„ä½¿ç”¨">1. ScheduledThreadPoolExecutor çš„ä½¿ç”¨</a>
      <ul>
        <li><a href="#ä¸€æ®µç®€å•çš„ä»£ç ä¾‹å­">ä¸€æ®µç®€å•çš„ä»£ç ä¾‹å­</a></li>
      </ul>
    </li>
    <li><a href="#2-æºç åˆ†æ">2. æºç åˆ†æ</a></li>
    <li><a href="#3-æ€»ç»“">3. æ€»ç»“</a></li>
  </ul>
</nav>
    </div>
</aside>
<div class="division-line"></div>
<div class="misc">
    <div> 
        <a class="post-category" href="/%20categories/java%E5%B9%B6%E5%8F%91/">ğŸ“’JAVAå¹¶å‘</a>
        </div>
    <div></div>
</div>

    </main>
    <footer class="p-x-0 p-b-2 m-auto">
        <div id="pagination">
            
<div class="division-line"></div>
<div class="paginator">
    <div class="prev">
        
        <a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/threadpool/threadpoolexecutor-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><span>ThreadPoolExecutor æºç åˆ†æ</span></a>
    </div>
    <div class="next">
        
        <a href="http://localhost:8080/java/java-%E5%B9%B6%E5%8F%91/threadpool/forkjoinpool-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><span>ForkJoinPool æºç åˆ†æï¼ˆæœªå®Œï¼‰</span></a>
    </div>
</div>

        </div>
        <div class="position-fixed b-4 r-4">
            <ul class="float-button-bar">
    <li>
        <button class="float-button top" onclick="scrollToTop(this);">UP</button>
    </li>
    <li>
        <button class="float-button toggler" onclick="changeSkin(this);">DARK</button>
    </li>
</ul>
        </div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 27270 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    

<script src="https://cdn.staticfile.net/gumshoe/5.1.1/gumshoe.min.js"></script>
<script>
    var spy = new Gumshoe('#TableOfContents a', {
        nested: true,
        nestedClass: 'active'
    });
</script>

<script>
    const changeSkin = () => {
        document.getElementById('page').classList.toggle('night');
    }
    const scrollToTop = () => {
        window.scrollTo(0, 0);
    }
</script>
</body>

</html>