<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>kubernetes cluster installation step | Yipsen Ye</title>
<meta name="description" content="ä¸€ã€é…ç½®ä¸»æœºåhostname  é‡å‘½åï¼šå‡è®¾æ˜¯masterèŠ‚ç‚¹å‡†å¤‡å‘½åä¸ºï¼škube-master-01  hostnamectl set-hostname kube-master-01 åŠ å…¥hostsï¼šå‡è®¾æœ¬æœº ip ä¸º 192.168.163.129  vi /etc/hosts 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 192.168.163.129 kube-master-01 äºŒã€å‡†å¤‡å·¥ä½œ  å…³é—­åŸé˜²ç«å¢™ï¼Œè®¾ç½®é˜²ç«å¢™ä¸º iptables å¹¶è®¾ç½®ç©ºè§„åˆ™  # å…³é—­é˜²ç«å¢™ systemctl stop firewalld &amp;amp;&amp;amp; systemctl disable firewalld # å®‰è£… iptables yum -y install iptables-services # é…ç½® iptables systemctl start iptables &amp;amp;&amp;amp; systemctl enable iptables &amp;amp;&amp;amp; iptables -F &amp;amp;&amp;amp; service iptables save å…³é—­ swapï¼Œå…³é—­SELINUX  # å…³é—­ swap swapoff -a # æ°¸ä¹…å…³é—­ swapï¼Œå³åœ¨ fstab é…ç½®æ–‡ä»¶ä¸­é‡‡ç”¨ # å·æ³¨é‡Š swap é‚£ä¸€è¡Œé…ç½® sed -i &amp;#39;/ swap / s/^\(.">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link active"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><article class="post-block">
        <h1 class="post-title">kubernetes cluster installation step</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2022-08-15 22:00:00</span></div></div>
        <div class="post-content">
            <h3 id="ä¸€é…ç½®ä¸»æœºåhostname">ä¸€ã€é…ç½®ä¸»æœºåhostname</h3>
<ol>
<li>é‡å‘½åï¼šå‡è®¾æ˜¯masterèŠ‚ç‚¹å‡†å¤‡å‘½åä¸ºï¼š<code>kube-master-01</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">hostnamectl set-hostname kube-master-01
</code></pre></div><ol start="2">
<li>åŠ å…¥hostsï¼šå‡è®¾æœ¬æœº ip ä¸º <code>192.168.163.129</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">vi /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.163.129 kube-master-01
</code></pre></div><h3 id="äºŒå‡†å¤‡å·¥ä½œ">äºŒã€å‡†å¤‡å·¥ä½œ</h3>
<ol>
<li>å…³é—­åŸé˜²ç«å¢™ï¼Œè®¾ç½®é˜²ç«å¢™ä¸º iptables å¹¶è®¾ç½®ç©ºè§„åˆ™</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># å…³é—­é˜²ç«å¢™</span>
systemctl stop firewalld <span style="color:#f92672">&amp;&amp;</span> systemctl disable firewalld
<span style="color:#75715e"># å®‰è£… iptables</span>
yum -y install iptables-services
<span style="color:#75715e"># é…ç½® iptables</span>
systemctl start iptables <span style="color:#f92672">&amp;&amp;</span> systemctl enable iptables <span style="color:#f92672">&amp;&amp;</span> iptables -F <span style="color:#f92672">&amp;&amp;</span> service iptables save
</code></pre></div><ol start="2">
<li>å…³é—­ swapï¼Œå…³é—­SELINUX</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># å…³é—­ swap</span>
swapoff -a
<span style="color:#75715e"># æ°¸ä¹…å…³é—­ swapï¼Œå³åœ¨ fstab é…ç½®æ–‡ä»¶ä¸­é‡‡ç”¨ # å·æ³¨é‡Š swap é‚£ä¸€è¡Œé…ç½®</span>
sed -i <span style="color:#e6db74">&#39;/ swap / s/^\(.*\)$/#\1/g&#39;</span> /etc/fstab
<span style="color:#75715e"># å…³é—­SELINUX</span>
setenforce <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> sed -i <span style="color:#e6db74">&#39;s/^SELINUX=.*/SELINUX=disabled/&#39;</span> /etc/selinux/config
</code></pre></div><ol start="3">
<li>å®‰è£…ä¾èµ–é¡¹</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># å®‰è£…æ—¶é’ŸåŒæ­¥</span>
yum install -y ntp
<span style="color:#75715e"># å¼€æœºè‡ªå¯åŠ¨</span>
systemctl start ntpd <span style="color:#f92672">&amp;&amp;</span> systemctl enable ntpd
<span style="color:#75715e"># è°ƒæ•´æ—¶åŒºä¸ºä¸œå…«åŒº</span>
timedatectl set-timezone Asia/Shanghai
<span style="color:#75715e"># å°†å½“å‰æ—¶é’Ÿå†™å…¥ç¡¬ä»¶æ—¶é’Ÿ</span>
timedatectl set-local-rtc <span style="color:#ae81ff">0</span>
<span style="color:#75715e"># é‡å¯ä¾èµ–æ—¶é’Ÿçš„æœåŠ¡</span>
systemctl restart rsyslog
systemctl restart crond
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># å¿…é¡»</span>
yum install -y conntrack socat
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># å¯é€‰ï¼Œä½†æœ€å¥½å®‰è£…ï¼Œæœ‰éƒ¨åˆ†å¯èƒ½å·²ç»æœ‰äº†</span>
yum install -y ntpdate ntp ipvsadm ipset jq iptables curl sysstat libseccomp wget vim net-tools git
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># ä¸‹è½½å®‰è£… crictl</span>
wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.22.1/crictl-v1.22.1-linux-amd64.tar.gz
tar zxvf crictl-v1.22.1-linux-amd64.tar.gz
mv crictl /usr/bin/
</code></pre></div><ol start="4">
<li>è°ƒæ•´å†…æ ¸å‚æ•°ï¼šé’ˆå¯¹ kubernetes (å¯é€‰ï¼šæš‚æœªæ‰§è¡Œè¿‡)</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; kubernetes.conf <span style="color:#e6db74">&lt;&lt;EOF
</span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables=1
</span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables=1
</span><span style="color:#e6db74">net.ipv4.ip_forward=1
</span><span style="color:#e6db74">net.ipv4.tcp_tw_recycle=0
</span><span style="color:#e6db74">vm.swappiness=0 # ç¦æ­¢ä½¿ç”¨ swap ç©ºé—´ï¼Œåªæœ‰å½“ç³»ç»Ÿ OOM æ—¶æ‰å…è®¸ä½¿ç”¨å®ƒ
</span><span style="color:#e6db74">vm.overcommit_memory=1 # ä¸æ£€æŸ¥ç‰©ç†å†…å­˜æ˜¯å¦å¤Ÿç”¨
</span><span style="color:#e6db74">vm.panic_on_oom=0 # å¼€å¯ OOM
</span><span style="color:#e6db74">fs.inotify.max_user_instances=8192
</span><span style="color:#e6db74">fs.inotify.max_user_watches=1048576
</span><span style="color:#e6db74">fs.file-max=52706963
</span><span style="color:#e6db74">fs.nr_open=52706963
</span><span style="color:#e6db74">net.ipv6.conf.all.disable_ipv6=1
</span><span style="color:#e6db74">net.netfilter.nf_conntrack_max=2310720
</span><span style="color:#e6db74">EOF</span>
cp kubernetes.conf /etc/sysctl.d/kubernetes.conf
sysctl -p /etc/sysctl.d/kubernetes.conf
</code></pre></div><ol start="5">
<li>ä¿®æ”¹æ—¥å¿—é…ç½®ï¼ˆå¯é€‰ï¼šæš‚æœªæ‰§è¡Œè¿‡ï¼‰</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># æŒä¹…åŒ–ä¿å­˜æ—¥å¿—çš„ç›®å½•</span>
mkdir /var/log/journal
mkdir /etc/systemd/journald.conf.d
cat &gt; /etc/systemd/journald.conf.d/99-prophet.conf <span style="color:#e6db74">&lt;&lt;EOF
</span><span style="color:#e6db74">[Journal]
</span><span style="color:#e6db74"># æŒä¹…åŒ–ä¿å­˜åˆ°ç£ç›˜
</span><span style="color:#e6db74">Storage=persistent
</span><span style="color:#e6db74">
</span><span style="color:#e6db74"># å‹ç¼©å†å²æ—¥å¿—
</span><span style="color:#e6db74">Compress=yes
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">SyncIntervalSec=5m
</span><span style="color:#e6db74">RateLimitInterval=30s
</span><span style="color:#e6db74">RateLimitBurst=1000
</span><span style="color:#e6db74">
</span><span style="color:#e6db74"># æœ€å¤§å ç”¨ç©ºé—´ 10G
</span><span style="color:#e6db74">SystemMaxUse=10G
</span><span style="color:#e6db74">
</span><span style="color:#e6db74"># å•æ—¥å¿—æ–‡ä»¶æœ€å¤§ 200M
</span><span style="color:#e6db74">SystemMaxFileSize=200M
</span><span style="color:#e6db74">
</span><span style="color:#e6db74"># æ—¥å¿—ä¿å­˜æ—¶é—´ 2 å‘¨
</span><span style="color:#e6db74">MaxRetentionSec=2week
</span><span style="color:#e6db74">
</span><span style="color:#e6db74"># ä¸å°†æ—¥å¿—è½¬å‘åˆ° syslog
</span><span style="color:#e6db74">ForwardToSyslog=no
</span><span style="color:#e6db74">EOF</span>
systemctl restart systemd-journald
</code></pre></div><ol start="6">
<li>å‡çº§ CentOS 7 çš„å†…æ ¸åˆ° 4.x ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼šæš‚æœªæ‰§è¡Œè¿‡ï¼‰</li>
</ol>
<p>CentOS 7.x ç³»ç»Ÿè‡ªå¸¦çš„ 3.10.x å†…æ ¸å­˜åœ¨ä¸€äº› bugï¼Œå¯¼è‡´è¿è¡Œçš„ dockerã€kubernetes ä¸ç¨³å®šã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm
<span style="color:#75715e"># å®‰è£…å®Œæˆåæ£€æŸ¥ /boot/grub2/grub.cfg ä¸­å¯¹åº”å†…æ ¸ menuentry ä¸­æ˜¯å¦åŒ…å« initrd16 é…ç½®ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†å®‰è£…ä¸€æ¬¡ï¼</span>
yum --enablerepo<span style="color:#f92672">=</span>elrepo-kernel install -y kernel-lt
<span style="color:#75715e"># è®¾ç½®å¼€æœºä»æ–°å†…æ ¸å¯åŠ¨</span>
grub2-set-default <span style="color:#e6db74">&#34;CentOS Linux (5.4.210-1.el7.elrepo.x86_64) 7 (Core)&#34;</span>
</code></pre></div><ol start="7">
<li>kube-proxy å¼€å¯ ipvs çš„å‰ç½®æ¡ä»¶ï¼ˆå³æ»¡è¶³æ‰ä¼šé‡‡ç”¨ ipvsï¼Œå¯é€‰ï¼Œä½†æœ€å¥½è®¾ç½®ï¼‰</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">modprobe br_netfilter

cat &gt; /etc/sysconfig/modules/ipvs.modules <span style="color:#e6db74">&lt;&lt;EOF
</span><span style="color:#e6db74">#!/bin/bash
</span><span style="color:#e6db74">modprobe -- ip_vs
</span><span style="color:#e6db74">modprobe -- ip_vs_rr
</span><span style="color:#e6db74">modprobe -- ip_vs_wrr
</span><span style="color:#e6db74">modprobe -- ip_vs_sh
</span><span style="color:#e6db74">modprobe -- nf_conntrack_ipv4
</span><span style="color:#e6db74">EOF</span>
chmod <span style="color:#ae81ff">755</span> /etc/sysconfig/modules/ipvs.modules <span style="color:#f92672">&amp;&amp;</span> bash /etc/sysconfig/modules/ipvs.modules <span style="color:#f92672">&amp;&amp;</span> lsmod | grep -e ip_vs -e nf_conntrack_ipv4
</code></pre></div><h3 id="ä¸‰å®‰è£…docker">ä¸‰ã€å®‰è£…docker</h3>
<ol>
<li>æ›´æ–°ç»„ä»¶</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">yum update -y
</code></pre></div><ol start="2">
<li>å®‰è£…docker</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># ç§»é™¤åŸ docker ç‰ˆæœ¬</span>
yum remove docker  docker-common docker-selinux docker-engine
<span style="color:#75715e"># é…ç½®ä¸­å¤®ä»“åº“</span>
yum-config-manager --add-repo http://download.docker.com/linux/centos/docker-ce.repo
<span style="color:#75715e"># é…ç½®é˜¿é‡Œä»“åº“</span>
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
<span style="color:#75715e"># å®‰è£… docker ä¾èµ–é¡¹</span>
yum install -y yum-utils device-mapper-persistent-data lvm2
<span style="color:#75715e"># æŸ¥çœ‹ docker ç‰ˆæœ¬åˆ—è¡¨</span>
<span style="color:#75715e"># yum list docker-ce --showduplicates | sort -r</span>
<span style="color:#75715e"># å®‰è£…æœ€æ–°ç‰ˆ dockerï¼›å¦‚æœå¸Œæœ›å®‰è£…æŒ‡å®šç‰ˆæœ¬ dockerï¼Œå¯ä»¥é€šè¿‡`yum install docker-ce-[version]`å‘½ä»¤æ¥å®‰è£…</span>
yum install -y docker-ce
<span style="color:#75715e"># å¯åŠ¨ dockerï¼Œè®¾ç½®å¼€æœºå¯åŠ¨ docker</span>
systemctl start docker <span style="color:#f92672">&amp;&amp;</span> systemctl enable docker
<span style="color:#75715e"># æŸ¥çœ‹ docker å¯åŠ¨çŠ¶æ€</span>
systemctl status docker
<span style="color:#75715e"># åˆ›å»º /etc/docker ç›®å½•</span>
mkdir /etc/docker
<span style="color:#75715e"># é…ç½® daemon</span>
cat &gt; /etc/docker/daemon.json <span style="color:#e6db74">&lt;&lt;EOF
</span><span style="color:#e6db74">{
</span><span style="color:#e6db74">  &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span><span style="color:#e6db74">  &#34;log-driver&#34;: &#34;json-file&#34;,
</span><span style="color:#e6db74">  &#34;log-opts&#34;: {
</span><span style="color:#e6db74">    &#34;max-size&#34;: &#34;100m&#34;
</span><span style="color:#e6db74">  }
</span><span style="color:#e6db74">}
</span><span style="color:#e6db74">EOF</span>
mkdir -p /etc/systemd/system/docker.service.d
<span style="color:#75715e"># é‡å¯ docker</span>
systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl restart docker <span style="color:#f92672">&amp;&amp;</span> systemctl enable docker
</code></pre></div><h3 id="å››å®‰è£…-kubernetes">å››ã€å®‰è£… kubernetes</h3>
<p>ä»¥ä¸‹æ–¹å¼æœªå°è¯•è¿‡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat <span style="color:#e6db74">&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span><span style="color:#e6db74">[kubernetes]
</span><span style="color:#e6db74">name=Kubernetes
</span><span style="color:#e6db74">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span><span style="color:#e6db74">enabled=1
</span><span style="color:#e6db74">gpgcheck=0
</span><span style="color:#e6db74">repo_gpgcheck=0
</span><span style="color:#e6db74">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span><span style="color:#e6db74">EOF</span>

yum -y install kubeadm-1.18.0 kubectl-1.18.0 kubelet-1.18.0
systemctl enable kubelet.service
</code></pre></div><ol>
<li>ä¸‹è½½å®‰è£… kubernetes</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># æŸ¥çœ‹ kubernetes æœ€æ–°ç¨³å®šç‰ˆæœ¬</span>
<span style="color:#75715e"># curl -sSL &lt;https://dl.k8s.io/release/stable.txt&gt;</span>
<span style="color:#75715e"># ä¸‹è½½ kubernetes v1.22.1 ç‰ˆæœ¬</span>
wget -q &lt;https://dl.k8s.io/v1.22.1/kubernetes-server-linux-amd64.tar.gz&gt;
<span style="color:#75715e"># è§£å‹</span>
tar -zxvf kubernetes-server-linux-amd64.tar.gz
<span style="color:#75715e"># æŸ¥çœ‹å…³é”®è½¯ä»¶æ˜¯å¦å­˜åœ¨ï¼škubeadmã€kubeletã€kubectl</span>
<span style="color:#75715e"># ls kubernetes/server/bin/ | grep -E &#39;kubeadm|kubelet|kubectl&#39;</span>
<span style="color:#75715e"># å¤åˆ¶åˆ°ç³»ç»Ÿç¯å¢ƒè·¯å¾„ /usr/bin</span>
cp -a kubernetes/server/bin/kube<span style="color:#f92672">{</span>adm,ctl,let<span style="color:#f92672">}</span> /usr/bin/
<span style="color:#75715e"># æ£€æŸ¥å¤åˆ¶ç»“æœ</span>
<span style="color:#75715e"># ls /usr/bin/kube*</span>
<span style="color:#75715e"># æ£€æŸ¥ kubeadm ç‰ˆæœ¬ä¿¡æ¯</span>
<span style="color:#75715e"># kubeadm version</span>
<span style="color:#75715e"># æ£€æŸ¥ kubectl ç‰ˆæœ¬ä¿¡æ¯</span>
<span style="color:#75715e"># kubectl version --client</span>
<span style="color:#75715e"># æ£€æŸ¥ kubelet ç‰ˆæœ¬ä¿¡æ¯</span>
<span style="color:#75715e"># kubelet --version</span>
</code></pre></div><ol start="2">
<li>æ–°å¢ kubelet æœåŠ¡</li>
</ol>
<ul>
<li>æ–°å¢æ–‡ä»¶<code>/etc/systemd/system/kubelet.service</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; /etc/systemd/system/kubelet.service <span style="color:#e6db74">&lt;&lt;EOF
</span><span style="color:#e6db74">[Unit]
</span><span style="color:#e6db74">Description=kubelet: The Kubernetes Agent
</span><span style="color:#e6db74">Documentation=http://kubernetes.io/docs/
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">[Service]
</span><span style="color:#e6db74">ExecStart=/usr/bin/kubelet
</span><span style="color:#e6db74">Restart=always
</span><span style="color:#e6db74">StartLimitInterval=0
</span><span style="color:#e6db74">RestartSec=10
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">[Install]
</span><span style="color:#e6db74">WantedBy=multi-user.target
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><ul>
<li>æ–°å¢æ–‡ä»¶å¤¹<code>/etc/systemd/system/kubelet.service.d</code>åŠæ–‡ä»¶<code>kubeadm.conf</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">mkdir -p /etc/systemd/system/kubelet.service.d
cat &gt; /etc/systemd/system/kubelet.service.d/kubeadm.conf <span style="color:#e6db74">&lt;&lt;EOF
</span><span style="color:#e6db74">[Service]
</span><span style="color:#e6db74">Environment=&#34;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&#34;
</span><span style="color:#e6db74">Environment=&#34;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&#34;
</span><span style="color:#e6db74">EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env
</span><span style="color:#e6db74">EnvironmentFile=-/etc/default/kubelet
</span><span style="color:#e6db74">ExecStart=
</span><span style="color:#e6db74">ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><ul>
<li>è®¾ç½®å¼€æœºå¯åŠ¨ kubelet</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">systemctl enable kubelet
</code></pre></div><h3 id="äº”æ­£å¼åˆå§‹åŒ–å®‰è£…åˆ†ä¸ºå®‰è£…-master-æˆ–-worker-èŠ‚ç‚¹é›†ç¾¤ä¸­éœ€ä¼˜å…ˆå®‰è£…ä¸€ä¸ª-master-èŠ‚ç‚¹">äº”ã€æ­£å¼åˆå§‹åŒ–å®‰è£…ï¼ˆåˆ†ä¸ºå®‰è£… master æˆ– worker èŠ‚ç‚¹ï¼Œé›†ç¾¤ä¸­éœ€ä¼˜å…ˆå®‰è£…ä¸€ä¸ª master èŠ‚ç‚¹ï¼‰</h3>
<p>ä»¥ä¸‹æ–¹å¼æœªå°è¯•è¿‡ï¼š(å®‰è£… master èŠ‚ç‚¹)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">
</code></pre></div><h4 id="1-å®‰è£…-master-èŠ‚ç‚¹">1. å®‰è£… master èŠ‚ç‚¹</h4>
<ul>
<li>æ‰§è¡Œå‘½ä»¤</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubeadm init --apiserver-advertise-address<span style="color:#f92672">=</span>192.168.8.100 --image-repository<span style="color:#f92672">=</span>registry.aliyuncs.com/google_containers --kubernetes-version v1.18.0 --service-cidr<span style="color:#f92672">=</span>10.96.0.0/12 --pod-network-cidr<span style="color:#f92672">=</span>10.244.0.0/16 | tee kubeadm-init.log
</code></pre></div><blockquote>
<p>å‚æ•°è§£é‡Šï¼š
apiserver-advertise-addressï¼šæŒ‡å®šæœ¬æœºipï¼ˆå¦åˆ™å¯èƒ½æŠ¥é”™ï¼‰ï¼Œæœ¬ä¾‹ä¸º192.168.163.129
image-repositoryï¼šé‡‡ç”¨ä»é˜¿é‡Œäº‘é•œåƒä¸­æ‹‰å–ï¼Œä»¥é˜²æ­¢å¢™çš„åŸå› è€Œæ‹‰å–å¤±è´¥ï¼Œå‚ç…§é”™è¯¯ç‚¹[]
kubernetes-versionï¼šæŒ‡å®šå®‰è£…çš„ kubernetes ç‰ˆæœ¬å·ï¼Œæœ¬ä¾‹ä¸º v1.22.1
service-cidrï¼š
pod-network-cidrï¼š</p>
</blockquote>
<ul>
<li>æ‰§è¡Œç»“æœ</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"></code></pre></div><ul>
<li>éƒ¨ç½² flannel ç½‘ç»œ</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># éœ€ä¸Šä¼ å…·ä½“ kube-flannel.yml åˆ°`$HOME`ç›®å½•</span>
kubectl apply -f ~/kube-flannel.yml
</code></pre></div><ul>
<li>æŸ¥çœ‹ flannel æ˜¯å¦å¯åŠ¨</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># é‡‡ç”¨ watch æ–¹å¼å®æ—¶ç›‘æ§æŸ¥çœ‹ flannel æ˜¯å¦éƒ¨ç½²æˆåŠŸ</span>
kubectl get pods -n kube-system -o wide -w
</code></pre></div><h4 id="2-å®‰è£…-worker-èŠ‚ç‚¹å¹¶åŠ å…¥é›†ç¾¤ä¸­">2. å®‰è£… worker èŠ‚ç‚¹å¹¶åŠ å…¥é›†ç¾¤ä¸­</h4>
<ul>
<li>æ‰§è¡Œå‘½ä»¤</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubeadm join 192.168.163.129:6443 --token yczemj.n4pgu7me9nij2of4 --discovery-token-ca-cert-hash sha256:ee9b23d74735868c90350cd545d7721f7cbe88404f9685411d870b586bdb128f
</code></pre></div><blockquote>
<p>æ³¨ï¼šè¯¥å‘½ä»¤åœ¨ master èŠ‚ç‚¹å®Œæˆå®‰è£…åä¼šæ‰“å°å‡ºæ¥ï¼Œå¦‚æœæ²¡æœ‰åŠæ—¶è·å–æˆ–è¯ä¹¦è¿‡æœŸï¼Œå¯ä»¥é€šè¿‡åœ¨ master èŠ‚ç‚¹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å†æ¬¡è·å–
<code>kubeadm token create --print-join-command</code></p>
</blockquote>
<ul>
<li>æ‰§è¡Œç»“æœ</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>root@kube-worker-02 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubeadm join 192.168.163.129:6443 --token yczemj.n4pgu7me9nij2of4 --discovery-token-ca-cert-hash sha256:ee9b23d74735868c90350cd545d7721f7cbe88404f9685411d870b586bdb128f</span>
<span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> Running pre-flight checks
<span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> Reading configuration from the cluster...
<span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> FYI: You can look at this config file with <span style="color:#e6db74">&#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39;</span>
<span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Writing kubelet configuration to file <span style="color:#e6db74">&#34;/var/lib/kubelet/config.yaml&#34;</span>
<span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Writing kubelet environment file with flags to file <span style="color:#e6db74">&#34;/var/lib/kubelet/kubeadm-flags.env&#34;</span>
<span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Starting the kubelet
<span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Waiting <span style="color:#66d9ef">for</span> the kubelet to perform the TLS Bootstrap...

This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run <span style="color:#e6db74">&#39;kubectl get nodes&#39;</span> on the control-plane to see this node join the cluster.
</code></pre></div><h4 id="3-é…ç½®-kubectl-å¹¶éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸ">3. é…ç½® kubectl å¹¶éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸ</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># mkdir -p $HOME/.kube</span>
<span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span>
<span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># sudo chown $(id -u):$(id -g) $HOME/.kube/config</span>
<span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get nodes</span>
NAME             STATUS     ROLES                  AGE   VERSION
kube-master-01   NotReady   control-plane,master   18m   v1.22.1
</code></pre></div><blockquote>
<p>NotReady æ˜¯å› ä¸ºæœªéƒ¨ç½² flannelï¼ŒæˆåŠŸéƒ¨ç½² flannel åä¼šæ˜¾ç¤º Ready.</p>
</blockquote>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/posts/%E4%BA%91%E5%8E%9F%E7%94%9F/kubernetes-%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/"><span>kubernetes cluster installation trouble shooting</span></a>
    </div>
    <div class="next">
        
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 27270 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>