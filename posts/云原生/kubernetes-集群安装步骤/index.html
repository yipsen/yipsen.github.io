<!DOCTYPE html>
<html lang="en" class="h-100">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=8080&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>kubernetes cluster installation step | Yipsen Ye</title>
<meta name="description" content="一、配置主机名hostname 重命名：假设是master节点准备命名为：kube-master-01 hostnamectl set-hostname kube-master-01 加入hosts：假设本机 ip 为 192.168.163.129 vi /etc/hosts 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 192.168.163.129 kube-master-01 二、准备工作 关闭原防火墙，设置防火墙为 iptables 并设置空规则 # 关闭防火墙 systemctl stop firewalld &amp;&amp; systemctl disable firewalld # 安装 iptables yum -y install iptables-services # 配置 iptables systemctl start iptables &amp;&amp; systemctl enable iptables &amp;&amp; iptables -F &amp;&amp; service iptables save 关闭 swap，关闭SELINUX # 关闭 swap swapoff -a # 永久关闭 swap，即在 fstab 配置文件中采用 # 号注释 swap 那一行配置 sed -i &#39;/ swap / s/^\(.*\)$/#\1/g&#39; /etc/fstab # 关闭SELINUX setenforce 0 &amp;&amp; sed -i &#39;s/^SELINUX=.*/SELINUX=disabled/&#39; /etc/selinux/config 安装依赖项 # 安装时钟同步 yum install -y ntp # 开机自启动 systemctl start ntpd &amp;&amp; systemctl enable ntpd # 调整时区为东八区 timedatectl set-timezone Asia/Shanghai # 将当前时钟写入硬件时钟 timedatectl set-local-rtc 0 # 重启依赖时钟的服务 systemctl restart rsyslog systemctl restart crond # 必须 yum install -y conntrack socat # 可选，但最好安装，有部分可能已经有了 yum install -y ntpdate ntp ipvsadm ipset jq iptables curl sysstat libseccomp wget vim net-tools git # 下载安装 crictl wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.22.1/crictl-v1.22.1-linux-amd64.tar.gz tar zxvf crictl-v1.22.1-linux-amd64.tar.gz mv crictl /usr/bin/ 调整内核参数：针对 kubernetes (可选：暂未执行过) cat &gt; kubernetes.conf &lt;&lt;EOF net.bridge.bridge-nf-call-iptables=1 net.bridge.bridge-nf-call-ip6tables=1 net.ipv4.ip_forward=1 net.ipv4.tcp_tw_recycle=0 vm.swappiness=0 # 禁止使用 swap 空间，只有当系统 OOM 时才允许使用它 vm.overcommit_memory=1 # 不检查物理内存是否够用 vm.panic_on_oom=0 # 开启 OOM fs.inotify.max_user_instances=8192 fs.inotify.max_user_watches=1048576 fs.file-max=52706963 fs.nr_open=52706963 net.ipv6.conf.all.disable_ipv6=1 net.netfilter.nf_conntrack_max=2310720 EOF cp kubernetes.conf /etc/sysctl.d/kubernetes.conf sysctl -p /etc/sysctl.d/kubernetes.conf 修改日志配置（可选：暂未执行过） # 持久化保存日志的目录 mkdir /var/log/journal mkdir /etc/systemd/journald.conf.d cat &gt; /etc/systemd/journald.conf.d/99-prophet.conf &lt;&lt;EOF [Journal] # 持久化保存到磁盘 Storage=persistent # 压缩历史日志 Compress=yes SyncIntervalSec=5m RateLimitInterval=30s RateLimitBurst=1000 # 最大占用空间 10G SystemMaxUse=10G # 单日志文件最大 200M SystemMaxFileSize=200M # 日志保存时间 2 周 MaxRetentionSec=2week # 不将日志转发到 syslog ForwardToSyslog=no EOF systemctl restart systemd-journald 升级 CentOS 7 的内核到 4.x 版本（可选：暂未执行过） CentOS 7.x 系统自带的 3.10.x 内核存在一些 bug，导致运行的 docker、kubernetes 不稳定。
">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">
<link rel="stylesheet" type="text/css" href="/styles/standard.css">

</head>

<body id="page" class="ff-consolas m-0">
    <header class="d-flex fd-row fw-wrap jc-between ai-center p-x-1 p-y-1 m-auto">
        <div class="nav-logo">
    <a href="http://localhost:8080/">
        
        <span class="nav-title">Yipsen Ye</span>
    </a>
</div>
<nav class="position-relative d-flex fw-wrap jc-end ai-center p-y-05">
    <ul class="d-flex fw-wrap ls-none p-l-0 m-0">
        
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/series/java/">JAVA</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/design/">设计</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/network/">网络</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/framework/">框架</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/middleware/">中间件</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/plugin/">插件</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/linux/">LINUX</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link  active"
                href="http://localhost:8080/posts/">随心谈</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/others/">山海文库</a>
        </li>
        
        <li class="nav-item p-0 m-x-1 m-y-05">
            <a class="nav-link "
                href="http://localhost:8080/about/">关于</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content" class="m-auto">
        
<aside class="sidebar"></aside>
<article>
    <h1 class="m-b-1">kubernetes cluster installation step</h1>
    <div class="d-flex fd-row jc-center">
        <div class="fc-subtle">
            <span>2022-08-15 22:00:00</span>
        </div>
    </div>
    <div class="post-content">
        <h3 id="一配置主机名hostname">一、配置主机名hostname</h3>
<ol>
<li>重命名：假设是master节点准备命名为：<code>kube-master-01</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>hostnamectl set-hostname kube-master-01
</span></span></code></pre></div><ol start="2">
<li>加入hosts：假设本机 ip 为 <code>192.168.163.129</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vi /etc/hosts
</span></span><span style="display:flex;"><span>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
</span></span><span style="display:flex;"><span>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
</span></span><span style="display:flex;"><span>192.168.163.129 kube-master-01
</span></span></code></pre></div><h3 id="二准备工作">二、准备工作</h3>
<ol>
<li>关闭原防火墙，设置防火墙为 iptables 并设置空规则</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 关闭防火墙</span>
</span></span><span style="display:flex;"><span>systemctl stop firewalld <span style="color:#f92672">&amp;&amp;</span> systemctl disable firewalld
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装 iptables</span>
</span></span><span style="display:flex;"><span>yum -y install iptables-services
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置 iptables</span>
</span></span><span style="display:flex;"><span>systemctl start iptables <span style="color:#f92672">&amp;&amp;</span> systemctl enable iptables <span style="color:#f92672">&amp;&amp;</span> iptables -F <span style="color:#f92672">&amp;&amp;</span> service iptables save
</span></span></code></pre></div><ol start="2">
<li>关闭 swap，关闭SELINUX</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 关闭 swap</span>
</span></span><span style="display:flex;"><span>swapoff -a
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 永久关闭 swap，即在 fstab 配置文件中采用 # 号注释 swap 那一行配置</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;/ swap / s/^\(.*\)$/#\1/g&#39;</span> /etc/fstab
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 关闭SELINUX</span>
</span></span><span style="display:flex;"><span>setenforce <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> sed -i <span style="color:#e6db74">&#39;s/^SELINUX=.*/SELINUX=disabled/&#39;</span> /etc/selinux/config
</span></span></code></pre></div><ol start="3">
<li>安装依赖项</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 安装时钟同步</span>
</span></span><span style="display:flex;"><span>yum install -y ntp
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 开机自启动</span>
</span></span><span style="display:flex;"><span>systemctl start ntpd <span style="color:#f92672">&amp;&amp;</span> systemctl enable ntpd
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 调整时区为东八区</span>
</span></span><span style="display:flex;"><span>timedatectl set-timezone Asia/Shanghai
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 将当前时钟写入硬件时钟</span>
</span></span><span style="display:flex;"><span>timedatectl set-local-rtc <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重启依赖时钟的服务</span>
</span></span><span style="display:flex;"><span>systemctl restart rsyslog
</span></span><span style="display:flex;"><span>systemctl restart crond
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 必须</span>
</span></span><span style="display:flex;"><span>yum install -y conntrack socat
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 可选，但最好安装，有部分可能已经有了</span>
</span></span><span style="display:flex;"><span>yum install -y ntpdate ntp ipvsadm ipset jq iptables curl sysstat libseccomp wget vim net-tools git
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 下载安装 crictl</span>
</span></span><span style="display:flex;"><span>wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.22.1/crictl-v1.22.1-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>tar zxvf crictl-v1.22.1-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>mv crictl /usr/bin/
</span></span></code></pre></div><ol start="4">
<li>调整内核参数：针对 kubernetes (可选：暂未执行过)</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; kubernetes.conf <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.ip_forward=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.tcp_tw_recycle=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vm.swappiness=0 # 禁止使用 swap 空间，只有当系统 OOM 时才允许使用它
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vm.overcommit_memory=1 # 不检查物理内存是否够用
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vm.panic_on_oom=0 # 开启 OOM
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fs.inotify.max_user_instances=8192
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fs.inotify.max_user_watches=1048576
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fs.file-max=52706963
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fs.nr_open=52706963
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv6.conf.all.disable_ipv6=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.netfilter.nf_conntrack_max=2310720
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>cp kubernetes.conf /etc/sysctl.d/kubernetes.conf
</span></span><span style="display:flex;"><span>sysctl -p /etc/sysctl.d/kubernetes.conf
</span></span></code></pre></div><ol start="5">
<li>修改日志配置（可选：暂未执行过）</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 持久化保存日志的目录</span>
</span></span><span style="display:flex;"><span>mkdir /var/log/journal
</span></span><span style="display:flex;"><span>mkdir /etc/systemd/journald.conf.d
</span></span><span style="display:flex;"><span>cat &gt; /etc/systemd/journald.conf.d/99-prophet.conf <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Journal]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 持久化保存到磁盘
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Storage=persistent
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 压缩历史日志
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Compress=yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SyncIntervalSec=5m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RateLimitInterval=30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RateLimitBurst=1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 最大占用空间 10G
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SystemMaxUse=10G
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 单日志文件最大 200M
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SystemMaxFileSize=200M
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 日志保存时间 2 周
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MaxRetentionSec=2week
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 不将日志转发到 syslog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ForwardToSyslog=no
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>systemctl restart systemd-journald
</span></span></code></pre></div><ol start="6">
<li>升级 CentOS 7 的内核到 4.x 版本（可选：暂未执行过）</li>
</ol>
<p>CentOS 7.x 系统自带的 3.10.x 内核存在一些 bug，导致运行的 docker、kubernetes 不稳定。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装完成后检查 /boot/grub2/grub.cfg 中对应内核 menuentry 中是否包含 initrd16 配置，如果没有，再安装一次！</span>
</span></span><span style="display:flex;"><span>yum --enablerepo<span style="color:#f92672">=</span>elrepo-kernel install -y kernel-lt
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置开机从新内核启动</span>
</span></span><span style="display:flex;"><span>grub2-set-default <span style="color:#e6db74">&#34;CentOS Linux (5.4.210-1.el7.elrepo.x86_64) 7 (Core)&#34;</span>
</span></span></code></pre></div><ol start="7">
<li>kube-proxy 开启 ipvs 的前置条件（即满足才会采用 ipvs，可选，但最好设置）</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>modprobe br_netfilter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat &gt; /etc/sysconfig/modules/ipvs.modules <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_rr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_wrr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- nf_conntrack_ipv4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>chmod <span style="color:#ae81ff">755</span> /etc/sysconfig/modules/ipvs.modules <span style="color:#f92672">&amp;&amp;</span> bash /etc/sysconfig/modules/ipvs.modules <span style="color:#f92672">&amp;&amp;</span> lsmod | grep -e ip_vs -e nf_conntrack_ipv4
</span></span></code></pre></div><h3 id="三安装docker">三、安装docker</h3>
<ol>
<li>更新组件</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>yum update -y
</span></span></code></pre></div><ol start="2">
<li>安装docker</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 移除原 docker 版本</span>
</span></span><span style="display:flex;"><span>yum remove docker  docker-common docker-selinux docker-engine
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置中央仓库</span>
</span></span><span style="display:flex;"><span>yum-config-manager --add-repo http://download.docker.com/linux/centos/docker-ce.repo
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置阿里仓库</span>
</span></span><span style="display:flex;"><span>yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装 docker 依赖项</span>
</span></span><span style="display:flex;"><span>yum install -y yum-utils device-mapper-persistent-data lvm2
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看 docker 版本列表</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># yum list docker-ce --showduplicates | sort -r</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装最新版 docker；如果希望安装指定版本 docker，可以通过`yum install docker-ce-[version]`命令来安装</span>
</span></span><span style="display:flex;"><span>yum install -y docker-ce
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动 docker，设置开机启动 docker</span>
</span></span><span style="display:flex;"><span>systemctl start docker <span style="color:#f92672">&amp;&amp;</span> systemctl enable docker
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看 docker 启动状态</span>
</span></span><span style="display:flex;"><span>systemctl status docker
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建 /etc/docker 目录</span>
</span></span><span style="display:flex;"><span>mkdir /etc/docker
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置 daemon</span>
</span></span><span style="display:flex;"><span>cat &gt; /etc/docker/daemon.json <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;log-driver&#34;: &#34;json-file&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;log-opts&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;max-size&#34;: &#34;100m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>mkdir -p /etc/systemd/system/docker.service.d
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重启 docker</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl restart docker <span style="color:#f92672">&amp;&amp;</span> systemctl enable docker
</span></span></code></pre></div><h3 id="四安装-kubernetes">四、安装 kubernetes</h3>
<p>方式一: 直接安装(以下方式未尝试过)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubernetes]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">repo_gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>yum -y install kubeadm-1.18.0 kubectl-1.18.0 kubelet-1.18.0
</span></span><span style="display:flex;"><span>systemctl enable kubelet.service
</span></span></code></pre></div><p>方式二: 下载安装</p>
<ol>
<li>下载安装 kubernetes</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 查看 kubernetes 最新稳定版本</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># curl -sSL &lt;https://dl.k8s.io/release/stable.txt&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 下载 kubernetes v1.22.1 版本</span>
</span></span><span style="display:flex;"><span>wget -q &lt;https://dl.k8s.io/v1.22.1/kubernetes-server-linux-amd64.tar.gz&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 解压</span>
</span></span><span style="display:flex;"><span>tar -zxvf kubernetes-server-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看关键软件是否存在：kubeadm、kubelet、kubectl</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ls kubernetes/server/bin/ | grep -E &#39;kubeadm|kubelet|kubectl&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 复制到系统环境路径 /usr/bin</span>
</span></span><span style="display:flex;"><span>cp -a kubernetes/server/bin/kube<span style="color:#f92672">{</span>adm,ctl,let<span style="color:#f92672">}</span> /usr/bin/
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查复制结果</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ls /usr/bin/kube*</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查 kubeadm 版本信息</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubeadm version</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查 kubectl 版本信息</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubectl version --client</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查 kubelet 版本信息</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubelet --version</span>
</span></span></code></pre></div><ol start="2">
<li>新增 kubelet 服务</li>
</ol>
<ul>
<li>新增文件<code>/etc/systemd/system/kubelet.service</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /etc/systemd/system/kubelet.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=kubelet: The Kubernetes Agent
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Documentation=http://kubernetes.io/docs/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/bin/kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=always
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">StartLimitInterval=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RestartSec=10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><ul>
<li>检查内容:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat /etc/systemd/system/kubelet.service
</span></span></code></pre></div><ul>
<li>新增文件夹<code>/etc/systemd/system/kubelet.service.d</code>及文件<code>kubeadm.conf</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir -p /etc/systemd/system/kubelet.service.d
</span></span><span style="display:flex;"><span>cat &gt; /etc/systemd/system/kubelet.service.d/kubeadm.conf <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=&#34;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=&#34;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EnvironmentFile=-/etc/default/kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><ul>
<li>检查内容:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat /etc/systemd/system/kubelet.service.d/kubeadm.conf
</span></span></code></pre></div><ul>
<li>设置开机启动 kubelet</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>systemctl enable --now kubelet
</span></span></code></pre></div><h3 id="五正式初始化安装分为安装-master-或-worker-节点集群中需优先安装一个-master-节点">五、正式初始化安装（分为安装 master 或 worker 节点，集群中需优先安装一个 master 节点）</h3>
<p>以下方式未尝试过：(安装 master 节点)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"></code></pre></div><h4 id="1-安装-master-节点">1. 安装 master 节点</h4>
<ul>
<li>执行命令</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubeadm init --apiserver-advertise-address<span style="color:#f92672">=</span>192.168.0.201 --image-repository<span style="color:#f92672">=</span>registry.aliyuncs.com/google_containers --kubernetes-version v1.22.1 --service-cidr<span style="color:#f92672">=</span>10.96.0.0/12 --pod-network-cidr<span style="color:#f92672">=</span>10.244.0.0/16 | tee kubeadm-init.log
</span></span></code></pre></div><blockquote>
<p>参数解释：
apiserver-advertise-address：指定本机ip（否则可能报错），本例为192.168.163.129
image-repository：采用从阿里云镜像中拉取，以防止墙的原因而拉取失败，参照错误点[]
kubernetes-version：指定安装的 kubernetes 版本号，本例为 v1.22.1
service-cidr：
pod-network-cidr：</p>
</blockquote>
<ul>
<li>执行结果</li>
</ul>
<pre tabindex="0"><code class="language-log" data-lang="log">[root@kube-master-01 ~]# kubeadm init --apiserver-advertise-address=192.168.0.201 --image-repository=registry.aliyuncs.com/google_containers --kubernetes-version v1.22.1 --service-cidr=10.96.0.0/12 --pod-network-cidr=10.244.0.0/16 | tee kubeadm-init.log
[init] Using Kubernetes version: v1.22.1
[preflight] Running pre-flight checks
        [WARNING SystemVerification]: this Docker version is not on the list of validated versions: 24.0.7. Latest validated version: 20.10
[preflight] Pulling images required for setting up a Kubernetes cluster
[preflight] This might take a minute or two, depending on the speed of your internet connection
[preflight] You can also perform this action in beforehand using &#39;kubeadm config images pull&#39;
[certs] Using certificateDir folder &#34;/etc/kubernetes/pki&#34;
[certs] Generating &#34;ca&#34; certificate and key
[certs] Generating &#34;apiserver&#34; certificate and key
[certs] apiserver serving cert is signed for DNS names [kube-master-01 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 192.168.0.201]
[certs] Generating &#34;apiserver-kubelet-client&#34; certificate and key
[certs] Generating &#34;front-proxy-ca&#34; certificate and key
[certs] Generating &#34;front-proxy-client&#34; certificate and key
[certs] Generating &#34;etcd/ca&#34; certificate and key
[certs] Generating &#34;etcd/server&#34; certificate and key
[certs] etcd/server serving cert is signed for DNS names [kube-master-01 localhost] and IPs [192.168.0.201 127.0.0.1 ::1]
[certs] Generating &#34;etcd/peer&#34; certificate and key
[certs] etcd/peer serving cert is signed for DNS names [kube-master-01 localhost] and IPs [192.168.0.201 127.0.0.1 ::1]
[certs] Generating &#34;etcd/healthcheck-client&#34; certificate and key
[certs] Generating &#34;apiserver-etcd-client&#34; certificate and key
[certs] Generating &#34;sa&#34; key and public key
[kubeconfig] Using kubeconfig folder &#34;/etc/kubernetes&#34;
[kubeconfig] Writing &#34;admin.conf&#34; kubeconfig file
[kubeconfig] Writing &#34;kubelet.conf&#34; kubeconfig file
[kubeconfig] Writing &#34;controller-manager.conf&#34; kubeconfig file
[kubeconfig] Writing &#34;scheduler.conf&#34; kubeconfig file
[kubelet-start] Writing kubelet environment file with flags to file &#34;/var/lib/kubelet/kubeadm-flags.env&#34;
[kubelet-start] Writing kubelet configuration to file &#34;/var/lib/kubelet/config.yaml&#34;
[kubelet-start] Starting the kubelet
[control-plane] Using manifest folder &#34;/etc/kubernetes/manifests&#34;
[control-plane] Creating static Pod manifest for &#34;kube-apiserver&#34;
[control-plane] Creating static Pod manifest for &#34;kube-controller-manager&#34;
[control-plane] Creating static Pod manifest for &#34;kube-scheduler&#34;
[etcd] Creating static Pod manifest for local etcd in &#34;/etc/kubernetes/manifests&#34;
[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory &#34;/etc/kubernetes/manifests&#34;. This can take up to 4m0s
</code></pre><ul>
<li>部署 flannel 网络</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 需上传具体 kube-flannel.yml 到`$HOME`目录</span>
</span></span><span style="display:flex;"><span>kubectl apply -f ~/kube-flannel.yml
</span></span></code></pre></div><ul>
<li>查看 flannel 是否启动</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 采用 watch 方式实时监控查看 flannel 是否部署成功</span>
</span></span><span style="display:flex;"><span>kubectl get pods -n kube-system -o wide -w
</span></span></code></pre></div><h4 id="2-安装-worker-节点并加入集群中">2. 安装 worker 节点并加入集群中</h4>
<ul>
<li>执行命令</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubeadm join 192.168.163.129:6443 --token yczemj.n4pgu7me9nij2of4 --discovery-token-ca-cert-hash sha256:ee9b23d74735868c90350cd545d7721f7cbe88404f9685411d870b586bdb128f
</span></span></code></pre></div><blockquote>
<p>注：该命令在 master 节点完成安装后会打印出来，如果没有及时获取或证书过期，可以通过在 master 节点执行以下命令再次获取
<code>kubeadm token create --print-join-command</code></p>
</blockquote>
<ul>
<li>执行结果</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@kube-worker-02 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubeadm join 192.168.163.129:6443 --token yczemj.n4pgu7me9nij2of4 --discovery-token-ca-cert-hash sha256:ee9b23d74735868c90350cd545d7721f7cbe88404f9685411d870b586bdb128f</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> Running pre-flight checks
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> Reading configuration from the cluster...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> FYI: You can look at this config file with <span style="color:#e6db74">&#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Writing kubelet configuration to file <span style="color:#e6db74">&#34;/var/lib/kubelet/config.yaml&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Writing kubelet environment file with flags to file <span style="color:#e6db74">&#34;/var/lib/kubelet/kubeadm-flags.env&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Starting the kubelet
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Waiting <span style="color:#66d9ef">for</span> the kubelet to perform the TLS Bootstrap...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>This node has joined the cluster:
</span></span><span style="display:flex;"><span>* Certificate signing request was sent to apiserver and a response was received.
</span></span><span style="display:flex;"><span>* The Kubelet was informed of the new secure connection details.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Run <span style="color:#e6db74">&#39;kubectl get nodes&#39;</span> on the control-plane to see this node join the cluster.
</span></span></code></pre></div><h4 id="3-配置-kubectl-并验证是否安装成功">3. 配置 kubectl 并验证是否安装成功</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># mkdir -p $HOME/.kube</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># sudo chown $(id -u):$(id -g) $HOME/.kube/config</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get nodes</span>
</span></span><span style="display:flex;"><span>NAME             STATUS     ROLES                  AGE   VERSION
</span></span><span style="display:flex;"><span>kube-master-01   NotReady   control-plane,master   18m   v1.22.1
</span></span></code></pre></div><blockquote>
<p>NotReady 是因为未部署 flannel，成功部署 flannel 后会显示 Ready.</p>
</blockquote>

    </div>
</article>
<aside class="catalog">
    <div class="catalog-title">目录</div>
    <div class="catalog-list">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#一配置主机名hostname">一、配置主机名hostname</a></li>
        <li><a href="#二准备工作">二、准备工作</a></li>
        <li><a href="#三安装docker">三、安装docker</a></li>
        <li><a href="#四安装-kubernetes">四、安装 kubernetes</a></li>
        <li><a href="#五正式初始化安装分为安装-master-或-worker-节点集群中需优先安装一个-master-节点">五、正式初始化安装（分为安装 master 或 worker 节点，集群中需优先安装一个 master 节点）</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</aside>
<div class="division-line"></div>
<div class="misc">
    <div></div>
    <div></div>
</div>

    </main>
    <footer class="p-x-0 p-b-2 m-auto">
        <div id="pagination">
            
<div class="division-line"></div>
<div class="paginator">
    <div class="prev">
        
        <a href="http://localhost:8080/posts/%E4%BA%91%E5%8E%9F%E7%94%9F/kubernetes-%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/"><span>kubernetes cluster installation trouble shooting</span></a>
    </div>
    <div class="next">
        
        <a href="http://localhost:8080/posts/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%BF%83%E5%BE%97/"><span>源码分析心得</span></a>
    </div>
</div>

        </div>
        <div class="position-fixed b-4 r-4">
            <ul class="float-button-bar">
    <li>
        <button class="float-button top" onclick="scrollToTop(this);">UP</button>
    </li>
    <li>
        <button class="float-button toggler" onclick="changeSkin(this);">DARK</button>
    </li>
</ul>
        </div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 27270 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    

<script src="https://cdn.staticfile.net/gumshoe/5.1.1/gumshoe.min.js"></script>
<script>
    var spy = new Gumshoe('#TableOfContents a', {
        nested: true,
        nestedClass: 'active'
    });
</script>

<script>
    const changeSkin = () => {
        document.getElementById('page').classList.toggle('night');
    }
    const scrollToTop = () => {
        window.scrollTo(0, 0);
    }
</script>
</body>

</html>