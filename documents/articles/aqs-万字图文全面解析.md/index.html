<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title> | Yipsen Ye</title>
<meta name="description" content="å‰è¨€ è°ˆåˆ°å¹¶å‘ï¼Œæˆ‘ä»¬ä¸å¾—ä¸è¯´AQS(AbstractQueuedSynchronizer)ï¼Œæ‰€è°“çš„AQSå³æ˜¯æŠ½è±¡çš„é˜Ÿåˆ—å¼çš„åŒæ­¥å™¨ï¼Œå†…éƒ¨å®šä¹‰äº†å¾ˆå¤šé”ç›¸å…³çš„æ–¹æ³•ï¼Œæˆ‘ä»¬ç†ŸçŸ¥çš„ReentrantLockã€ReentrantReadWriteLockã€CountDownLatchã€Semaphoreç­‰éƒ½æ˜¯åŸºäºAQSæ¥å®ç°çš„ã€‚
æˆ‘ä»¬å…ˆçœ‹ä¸‹AQSç›¸å…³çš„UMLå›¾ï¼š
æ€ç»´å¯¼å›¾ï¼š
AQS å®ç°åŸç† AQSä¸­ ç»´æŠ¤äº†ä¸€ä¸ªvolatile int stateï¼ˆä»£è¡¨å…±äº«èµ„æºï¼‰å’Œä¸€ä¸ªFIFOçº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—ï¼ˆå¤šçº¿ç¨‹äº‰ç”¨èµ„æºè¢«é˜»å¡æ—¶ä¼šè¿›å…¥æ­¤é˜Ÿåˆ—ï¼‰ã€‚
è¿™é‡Œvolatileèƒ½å¤Ÿä¿è¯å¤šçº¿ç¨‹ä¸‹çš„å¯è§æ€§ï¼Œå½“state=1åˆ™ä»£è¡¨å½“å‰å¯¹è±¡é”å·²ç»è¢«å æœ‰ï¼Œå…¶ä»–çº¿ç¨‹æ¥åŠ é”æ—¶åˆ™ä¼šå¤±è´¥ï¼ŒåŠ é”å¤±è´¥çš„çº¿ç¨‹ä¼šè¢«æ”¾å…¥ä¸€ä¸ªFIFOçš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œæ¯”åˆ—ä¼šè¢«UNSAFE.park()æ“ä½œæŒ‚èµ·ï¼Œç­‰å¾…å…¶ä»–è·å–é”çš„çº¿ç¨‹é‡Šæ”¾é”æ‰èƒ½å¤Ÿè¢«å”¤é†’ã€‚
å¦å¤–stateçš„æ“ä½œéƒ½æ˜¯é€šè¿‡CASæ¥ä¿è¯å…¶å¹¶å‘ä¿®æ”¹çš„å®‰å…¨æ€§ã€‚
å…·ä½“åŸç†æˆ‘ä»¬å¯ä»¥ç”¨ä¸€å¼ å›¾æ¥ç®€å•æ¦‚æ‹¬ï¼š
AQS ä¸­æä¾›äº†å¾ˆå¤šå…³äºé”çš„å®ç°æ–¹æ³•ï¼Œ
 getState()ï¼šè·å–é”çš„æ ‡å¿— state å€¼ setState()ï¼šè®¾ç½®é”çš„æ ‡å¿— state å€¼ tryAcquire(int)ï¼šç‹¬å æ–¹å¼è·å–é”ã€‚å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å› trueï¼Œå¤±è´¥åˆ™è¿”å› falseã€‚ tryRelease(int)ï¼šç‹¬å æ–¹å¼é‡Šæ”¾é”ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å› trueï¼Œå¤±è´¥åˆ™è¿”å› falseã€‚  è¿™é‡Œè¿˜æœ‰ä¸€äº›æ–¹æ³•å¹¶æ²¡æœ‰åˆ—å‡ºæ¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä»¥ReentrantLockä½œä¸ºçªç ´ç‚¹é€šè¿‡æºç å’Œç”»å›¾çš„å½¢å¼ä¸€æ­¥æ­¥äº†è§£AQSå†…éƒ¨å®ç°åŸç†ã€‚
ç›®å½•ç»“æ„ æ–‡ç« å‡†å¤‡æ¨¡æ‹Ÿå¤šçº¿ç¨‹ç«äº‰é”ã€é‡Šæ”¾é”çš„åœºæ™¯æ¥è¿›è¡Œåˆ†æAQSæºç ï¼š
ä¸‰ä¸ªçº¿ç¨‹(çº¿ç¨‹ä¸€ã€çº¿ç¨‹äºŒã€çº¿ç¨‹ä¸‰)åŒæ—¶æ¥åŠ é”/é‡Šæ”¾é”
ç›®å½•å¦‚ä¸‹ï¼š
 çº¿ç¨‹ä¸€åŠ é”æˆåŠŸæ—¶AQSå†…éƒ¨å®ç° çº¿ç¨‹äºŒ/ä¸‰åŠ é”å¤±è´¥æ—¶AQSä¸­ç­‰å¾…é˜Ÿåˆ—çš„æ•°æ®æ¨¡å‹ çº¿ç¨‹ä¸€é‡Šæ”¾é”åŠçº¿ç¨‹äºŒè·å–é”å®ç°åŸç† é€šè¿‡çº¿ç¨‹åœºæ™¯æ¥è®²è§£å…¬å¹³é”å…·ä½“å®ç°åŸç† é€šè¿‡çº¿ç¨‹åœºæ™¯æ¥è®²è§£ Condition ä¸­ await()å’Œsignal()å®ç°åŸç†  è¿™é‡Œä¼šé€šè¿‡ç”»å›¾æ¥åˆ†ææ¯ä¸ªçº¿ç¨‹åŠ é”ã€é‡Šæ”¾é”åAQSå†…éƒ¨çš„æ•°æ®ç»“æ„å’Œå®ç°åŸç†
åœºæ™¯åˆ†æ çº¿ç¨‹ä¸€åŠ é”æˆåŠŸ å¦‚æœåŒæ—¶æœ‰ä¸‰ä¸ªçº¿ç¨‹å¹¶å‘æŠ¢å é”ï¼Œæ­¤æ—¶çº¿ç¨‹ä¸€æŠ¢å é”æˆåŠŸï¼Œçº¿ç¨‹äºŒå’Œçº¿ç¨‹ä¸‰æŠ¢å é”å¤±è´¥ï¼Œå…·ä½“æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š
æ­¤æ—¶AQSå†…éƒ¨æ•°æ®ä¸ºï¼š
çº¿ç¨‹äºŒã€çº¿ç¨‹ä¸‰åŠ é”å¤±è´¥ï¼š
æœ‰å›¾å¯ä»¥çœ‹å‡ºï¼Œç­‰å¾…é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹Nodeæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œè¿™é‡ŒSIGNALæ˜¯Nodeä¸­waitStatuså±æ€§ï¼ŒNodeä¸­è¿˜æœ‰ä¸€ä¸ªnextWaiterå±æ€§ï¼Œè¿™ä¸ªå¹¶æœªåœ¨å›¾ä¸­ç”»å‡ºæ¥ï¼Œè¿™ä¸ªåˆ°åé¢Conditionä¼šå…·ä½“è®²è§£çš„ã€‚
å…·ä½“çœ‹ä¸‹æŠ¢å é”ä»£ç å®ç°ï¼š
java.util.concurrent.locks.ReentrantLock .NonfairSync: static final class NonfairSync extends Sync { final void lock() { if (compareAndSetState(0, 1)) setExclusiveOwnerThread(Thread.currentThread()); else acquire(1); } protected final boolean tryAcquire(int acquires) { return nonfairTryAcquire(acquires); } } è¿™é‡Œä½¿ç”¨çš„ReentrantLock éå…¬å¹³é”ï¼Œçº¿ç¨‹è¿›æ¥ç›´æ¥åˆ©ç”¨CASå°è¯•æŠ¢å é”ï¼Œå¦‚æœæŠ¢å æˆåŠŸstateå€¼å›è¢«æ”¹ä¸º 1ï¼Œä¸”è®¾ç½®å¯¹è±¡ç‹¬å é”çº¿ç¨‹ä¸ºå½“å‰çº¿ç¨‹ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><article class="post-block">
        <h1 class="post-title"></h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;0001-01-01 00:00:00</span></div></div>
        <div class="post-content">
            <h3 id="å‰è¨€">å‰è¨€</h3>
<p>è°ˆåˆ°å¹¶å‘ï¼Œæˆ‘ä»¬ä¸å¾—ä¸è¯´<code>AQS(AbstractQueuedSynchronizer)</code>ï¼Œæ‰€è°“çš„<code>AQS</code>å³æ˜¯æŠ½è±¡çš„é˜Ÿåˆ—å¼çš„åŒæ­¥å™¨ï¼Œå†…éƒ¨å®šä¹‰äº†å¾ˆå¤šé”ç›¸å…³çš„æ–¹æ³•ï¼Œæˆ‘ä»¬ç†ŸçŸ¥çš„<code>ReentrantLock</code>ã€<code>ReentrantReadWriteLock</code>ã€<code>CountDownLatch</code>ã€<code>Semaphore</code>ç­‰éƒ½æ˜¯åŸºäº<code>AQS</code>æ¥å®ç°çš„ã€‚</p>
<p>æˆ‘ä»¬å…ˆçœ‹ä¸‹<code>AQS</code>ç›¸å…³çš„<code>UML</code>å›¾ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDJjNDZiNGRlMQ.jfif" alt="image.png"></p>
<p>æ€ç»´å¯¼å›¾ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDJjNWQ2OTMzOA.jfif" alt="image.png"></p>
<h3 id="aqs-å®ç°åŸç†">AQS å®ç°åŸç†</h3>
<p><code>AQS</code>ä¸­ ç»´æŠ¤äº†ä¸€ä¸ª<code>volatile int state</code>ï¼ˆä»£è¡¨å…±äº«èµ„æºï¼‰å’Œä¸€ä¸ª<code>FIFO</code>çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—ï¼ˆå¤šçº¿ç¨‹äº‰ç”¨èµ„æºè¢«é˜»å¡æ—¶ä¼šè¿›å…¥æ­¤é˜Ÿåˆ—ï¼‰ã€‚</p>
<p>è¿™é‡Œ<code>volatile</code>èƒ½å¤Ÿä¿è¯å¤šçº¿ç¨‹ä¸‹çš„å¯è§æ€§ï¼Œå½“<code>state=1</code>åˆ™ä»£è¡¨å½“å‰å¯¹è±¡é”å·²ç»è¢«å æœ‰ï¼Œå…¶ä»–çº¿ç¨‹æ¥åŠ é”æ—¶åˆ™ä¼šå¤±è´¥ï¼ŒåŠ é”å¤±è´¥çš„çº¿ç¨‹ä¼šè¢«æ”¾å…¥ä¸€ä¸ª<code>FIFO</code>çš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œæ¯”åˆ—ä¼šè¢«<code>UNSAFE.park()</code>æ“ä½œæŒ‚èµ·ï¼Œç­‰å¾…å…¶ä»–è·å–é”çš„çº¿ç¨‹é‡Šæ”¾é”æ‰èƒ½å¤Ÿè¢«å”¤é†’ã€‚</p>
<p>å¦å¤–<code>state</code>çš„æ“ä½œéƒ½æ˜¯é€šè¿‡<code>CAS</code>æ¥ä¿è¯å…¶å¹¶å‘ä¿®æ”¹çš„å®‰å…¨æ€§ã€‚</p>
<p>å…·ä½“åŸç†æˆ‘ä»¬å¯ä»¥ç”¨ä¸€å¼ å›¾æ¥ç®€å•æ¦‚æ‹¬ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDJjNzdiMjc2NQ.jfif" alt="image.png"></p>
<p><code>AQS</code> ä¸­æä¾›äº†å¾ˆå¤šå…³äºé”çš„å®ç°æ–¹æ³•ï¼Œ</p>
<ul>
<li>getState()ï¼šè·å–é”çš„æ ‡å¿— state å€¼</li>
<li>setState()ï¼šè®¾ç½®é”çš„æ ‡å¿— state å€¼</li>
<li>tryAcquire(int)ï¼šç‹¬å æ–¹å¼è·å–é”ã€‚å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å› trueï¼Œå¤±è´¥åˆ™è¿”å› falseã€‚</li>
<li>tryRelease(int)ï¼šç‹¬å æ–¹å¼é‡Šæ”¾é”ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å› trueï¼Œå¤±è´¥åˆ™è¿”å› falseã€‚</li>
</ul>
<p>è¿™é‡Œè¿˜æœ‰ä¸€äº›æ–¹æ³•å¹¶æ²¡æœ‰åˆ—å‡ºæ¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä»¥<code>ReentrantLock</code>ä½œä¸ºçªç ´ç‚¹é€šè¿‡æºç å’Œç”»å›¾çš„å½¢å¼ä¸€æ­¥æ­¥äº†è§£<code>AQS</code>å†…éƒ¨å®ç°åŸç†ã€‚</p>
<h3 id="ç›®å½•ç»“æ„">ç›®å½•ç»“æ„</h3>
<p>æ–‡ç« å‡†å¤‡æ¨¡æ‹Ÿå¤šçº¿ç¨‹ç«äº‰é”ã€é‡Šæ”¾é”çš„åœºæ™¯æ¥è¿›è¡Œåˆ†æ<code>AQS</code>æºç ï¼š</p>
<p><strong>ä¸‰ä¸ªçº¿ç¨‹(çº¿ç¨‹ä¸€ã€çº¿ç¨‹äºŒã€çº¿ç¨‹ä¸‰)åŒæ—¶æ¥åŠ é”/é‡Šæ”¾é”</strong></p>
<p><strong>ç›®å½•å¦‚ä¸‹ï¼š</strong></p>
<ul>
<li><strong>çº¿ç¨‹ä¸€</strong>åŠ é”æˆåŠŸæ—¶<code>AQS</code>å†…éƒ¨å®ç°</li>
<li><strong>çº¿ç¨‹äºŒ/ä¸‰</strong>åŠ é”å¤±è´¥æ—¶<code>AQS</code>ä¸­ç­‰å¾…é˜Ÿåˆ—çš„æ•°æ®æ¨¡å‹</li>
<li><strong>çº¿ç¨‹ä¸€</strong>é‡Šæ”¾é”åŠ<strong>çº¿ç¨‹äºŒ</strong>è·å–é”å®ç°åŸç†</li>
<li>é€šè¿‡çº¿ç¨‹åœºæ™¯æ¥è®²è§£<strong>å…¬å¹³é”</strong>å…·ä½“å®ç°åŸç†</li>
<li>é€šè¿‡çº¿ç¨‹åœºæ™¯æ¥è®²è§£ Condition ä¸­ a<code>wait()</code>å’Œ<code>signal()</code>å®ç°åŸç†</li>
</ul>
<p>è¿™é‡Œä¼šé€šè¿‡ç”»å›¾æ¥åˆ†ææ¯ä¸ªçº¿ç¨‹åŠ é”ã€é‡Šæ”¾é”å<code>AQS</code>å†…éƒ¨çš„æ•°æ®ç»“æ„å’Œå®ç°åŸç†</p>
<h3 id="åœºæ™¯åˆ†æ">åœºæ™¯åˆ†æ</h3>
<h4 id="çº¿ç¨‹ä¸€åŠ é”æˆåŠŸ">çº¿ç¨‹ä¸€åŠ é”æˆåŠŸ</h4>
<p>å¦‚æœåŒæ—¶æœ‰<strong>ä¸‰ä¸ªçº¿ç¨‹</strong>å¹¶å‘æŠ¢å é”ï¼Œæ­¤æ—¶<strong>çº¿ç¨‹ä¸€</strong>æŠ¢å é”æˆåŠŸï¼Œ<strong>çº¿ç¨‹äºŒ</strong>å’Œ<strong>çº¿ç¨‹ä¸‰</strong>æŠ¢å é”å¤±è´¥ï¼Œå…·ä½“æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDJjNWQyZWIyYw.jfif" alt="image.png"></p>
<p>æ­¤æ—¶<code>AQS</code>å†…éƒ¨æ•°æ®ä¸ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDJjNzc5OTlkNQ.jfif" alt="image.png"></p>
<p><strong>çº¿ç¨‹äºŒ</strong>ã€<strong>çº¿ç¨‹ä¸‰</strong>åŠ é”å¤±è´¥ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDJjOGU1ZTI2OA.jfif" alt="image.png"></p>
<p>æœ‰å›¾å¯ä»¥çœ‹å‡ºï¼Œç­‰å¾…é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹<code>Node</code>æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œè¿™é‡Œ<code>SIGNAL</code>æ˜¯<code>Node</code>ä¸­<code>waitStatus</code>å±æ€§ï¼Œ<code>Node</code>ä¸­è¿˜æœ‰ä¸€ä¸ª<code>nextWaiter</code>å±æ€§ï¼Œè¿™ä¸ªå¹¶æœªåœ¨å›¾ä¸­ç”»å‡ºæ¥ï¼Œè¿™ä¸ªåˆ°åé¢<code>Condition</code>ä¼šå…·ä½“è®²è§£çš„ã€‚</p>
<p>å…·ä½“çœ‹ä¸‹æŠ¢å é”ä»£ç å®ç°ï¼š</p>
<pre tabindex="0"><code>java.util.concurrent.locks.ReentrantLock .NonfairSync:
static final class NonfairSync extends Sync {

    final void lock() {
        if (compareAndSetState(0, 1))
            setExclusiveOwnerThread(Thread.currentThread());
        else
            acquire(1);
    }

    protected final boolean tryAcquire(int acquires) {
        return nonfairTryAcquire(acquires);
    }
}
</code></pre><p>è¿™é‡Œä½¿ç”¨çš„<strong>ReentrantLock éå…¬å¹³é”</strong>ï¼Œçº¿ç¨‹è¿›æ¥ç›´æ¥åˆ©ç”¨<code>CAS</code>å°è¯•æŠ¢å é”ï¼Œå¦‚æœæŠ¢å æˆåŠŸ<code>state</code>å€¼å›è¢«æ”¹ä¸º 1ï¼Œä¸”è®¾ç½®å¯¹è±¡ç‹¬å é”çº¿ç¨‹ä¸ºå½“å‰çº¿ç¨‹ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>protected final boolean compareAndSetState(int expect, int update) {
    return unsafe.compareAndSwapInt(this, stateOffset, expect, update);
}

protected final void setExclusiveOwnerThread(Thread thread) {
    exclusiveOwnerThread = thread;
}
</code></pre><h4 id="çº¿ç¨‹äºŒæŠ¢å é”å¤±è´¥">çº¿ç¨‹äºŒæŠ¢å é”å¤±è´¥</h4>
<p>æˆ‘ä»¬æŒ‰ç…§çœŸå®åœºæ™¯æ¥åˆ†æï¼Œ<strong>çº¿ç¨‹ä¸€</strong>æŠ¢å é”æˆåŠŸåï¼Œ<code>state</code>å˜ä¸º 1ï¼Œ<strong>çº¿ç¨‹äºŒ</strong>é€šè¿‡<code>CAS</code>ä¿®æ”¹<code>state</code>å˜é‡å¿…ç„¶ä¼šå¤±è´¥ã€‚æ­¤æ—¶<code>AQS</code>ä¸­<code>FIFO</code>(First In First Out å…ˆè¿›å…ˆå‡º)é˜Ÿåˆ—ä¸­æ•°æ®å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDMwYjUyNTZkZQ.jfif" alt="image.png"></p>
<p>æˆ‘ä»¬å°†<strong>çº¿ç¨‹äºŒ</strong>æ‰§è¡Œçš„é€»è¾‘ä¸€æ­¥æ­¥æ‹†è§£æ¥çœ‹ï¼š</p>
<p><code>java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire()</code>:</p>
<pre tabindex="0"><code>public final void acquire(int arg) {
    if (!tryAcquire(arg) &amp;&amp;
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
}
</code></pre><p>å…ˆçœ‹çœ‹<code>tryAcquire()</code>çš„å…·ä½“å®ç°ï¼š <code>java.util.concurrent.locks.ReentrantLock .nonfairTryAcquire()</code>:</p>
<pre tabindex="0"><code>final boolean nonfairTryAcquire(int acquires) {
    final Thread current = Thread.currentThread();
    int c = getState();
    if (c == 0) {
        if (compareAndSetState(0, acquires)) {
            setExclusiveOwnerThread(current);
            return true;
        }
    }
    else if (current == getExclusiveOwnerThread()) {
        int nextc = c + acquires;
        if (nextc &lt; 0)
            throw new Error(&quot;Maximum lock count exceeded&quot;);
        setState(nextc);
        return true;
    }
    return false;
}
</code></pre><p><code>nonfairTryAcquire()</code>æ–¹æ³•ä¸­é¦–å…ˆä¼šè·å–<code>state</code>çš„å€¼ï¼Œå¦‚æœä¸ä¸º 0 åˆ™è¯´æ˜å½“å‰å¯¹è±¡çš„é”å·²ç»è¢«å…¶ä»–çº¿ç¨‹æ‰€å æœ‰ï¼Œæ¥ç€åˆ¤æ–­å æœ‰é”çš„çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯åˆ™ç´¯åŠ <code>state</code>å€¼ï¼Œè¿™å°±æ˜¯å¯é‡å…¥é”çš„å…·ä½“å®ç°ï¼Œç´¯åŠ <code>state</code>å€¼ï¼Œé‡Šæ”¾é”çš„æ—¶å€™ä¹Ÿè¦ä¾æ¬¡é€’å‡<code>state</code>å€¼ã€‚</p>
<p>å¦‚æœ<code>state</code>ä¸º 0ï¼Œåˆ™æ‰§è¡Œ<code>CAS</code>æ“ä½œï¼Œå°è¯•æ›´æ–°<code>state</code>å€¼ä¸º 1ï¼Œå¦‚æœæ›´æ–°æˆåŠŸåˆ™ä»£è¡¨å½“å‰çº¿ç¨‹åŠ é”æˆåŠŸã€‚</p>
<p>ä»¥<strong>çº¿ç¨‹äºŒ</strong>ä¸ºä¾‹ï¼Œå› ä¸º<strong>çº¿ç¨‹ä¸€</strong>å·²ç»å°†<code>state</code>ä¿®æ”¹ä¸º 1ï¼Œæ‰€ä»¥<strong>çº¿ç¨‹äºŒ</strong>é€šè¿‡<code>CAS</code>ä¿®æ”¹<code>state</code>çš„å€¼ä¸ä¼šæˆåŠŸã€‚åŠ é”å¤±è´¥ã€‚</p>
<p><strong>çº¿ç¨‹äºŒ</strong>æ‰§è¡Œ<code>tryAcquire()</code>åä¼šè¿”å› falseï¼Œæ¥ç€æ‰§è¡Œ<code>addWaiter(Node.EXCLUSIVE)</code>é€»è¾‘ï¼Œå°†è‡ªå·±åŠ å…¥åˆ°ä¸€ä¸ª<code>FIFO</code>ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š</p>
<p><code>java.util.concurrent.locks.AbstractQueuedSynchronizer.addWaiter()</code>:</p>
<pre tabindex="0"><code>private Node addWaiter(Node mode) {    
    Node node = new Node(Thread.currentThread(), mode);
    Node pred = tail;
    if (pred != null) {
        node.prev = pred;
        if (compareAndSetTail(pred, node)) {
            pred.next = node;
            return node;
        }
    }
    enq(node);
    return node;
}
</code></pre><p>è¿™æ®µä»£ç é¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ªå’Œå½“å‰çº¿ç¨‹ç»‘å®šçš„<code>Node</code>èŠ‚ç‚¹ï¼Œ<code>Node</code>ä¸ºåŒå‘é“¾è¡¨ã€‚æ­¤æ—¶ç­‰å¾…å¯¹å†…ä¸­çš„<code>tail</code>æŒ‡é’ˆä¸ºç©ºï¼Œç›´æ¥è°ƒç”¨<code>enq(node)</code>æ–¹æ³•å°†å½“å‰çº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨ï¼š</p>
<pre tabindex="0"><code>private Node enq(final Node node) {
    for (;;) {
        Node t = tail;
        if (t == null) {
            if (compareAndSetHead(new Node()))
                tail = head;
        } else {
            node.prev = t;
            if (compareAndSetTail(t, node)) {
                t.next = node;
                return t;
            }
        }
    }
}
</code></pre><p>ç¬¬ä¸€éå¾ªç¯æ—¶<code>tail</code>æŒ‡é’ˆä¸ºç©ºï¼Œè¿›å…¥ if é€»è¾‘ï¼Œä½¿ç”¨<code>CAS</code>æ“ä½œè®¾ç½®<code>head</code>æŒ‡é’ˆï¼Œå°†<code>head</code>æŒ‡å‘ä¸€ä¸ªæ–°åˆ›å»ºçš„<code>Node</code>èŠ‚ç‚¹ã€‚æ­¤æ—¶<code>AQS</code>ä¸­æ•°æ®ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDMxZGZmMGI2Zg.jfif" alt="image.png"></p>
<p>æ‰§è¡Œå®Œæˆä¹‹åï¼Œ<code>head</code>ã€<code>tail</code>ã€<code>t</code>éƒ½æŒ‡å‘ç¬¬ä¸€ä¸ª<code>Node</code>å…ƒç´ ã€‚</p>
<p>æ¥ç€æ‰§è¡Œç¬¬äºŒéå¾ªç¯ï¼Œè¿›å…¥<code>else</code>é€»è¾‘ï¼Œæ­¤æ—¶å·²ç»æœ‰äº†<code>head</code>èŠ‚ç‚¹ï¼Œè¿™é‡Œè¦æ“ä½œçš„å°±æ˜¯å°†<strong>çº¿ç¨‹äºŒ</strong>å¯¹åº”çš„<code>Node</code>èŠ‚ç‚¹æŒ‚åˆ°<code>head</code>èŠ‚ç‚¹åé¢ã€‚æ­¤æ—¶é˜Ÿåˆ—ä¸­å°±æœ‰äº†ä¸¤ä¸ª<code>Node</code>èŠ‚ç‚¹ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDMyMTk0MTdmNQ.jfif" alt="image.png"></p>
<p><code>addWaiter()</code>æ–¹æ³•æ‰§è¡Œå®Œåï¼Œä¼šè¿”å›å½“å‰çº¿ç¨‹åˆ›å»ºçš„èŠ‚ç‚¹ä¿¡æ¯ã€‚ç»§ç»­å¾€åæ‰§è¡Œ<code>acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</code> é€»è¾‘ï¼Œæ­¤æ—¶ä¼ å…¥çš„å‚æ•°ä¸º<strong>çº¿ç¨‹äºŒ</strong>å¯¹åº”çš„<code>Node</code>èŠ‚ç‚¹ä¿¡æ¯ï¼š</p>
<p><code>java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued()</code>:</p>
<pre tabindex="0"><code>final boolean acquireQueued(final Node node, int arg) {
    boolean failed = true;
    try {
        boolean interrupted = false;
        for (;;) {
            final Node p = node.predecessor();
            if (p == head &amp;&amp; tryAcquire(arg)) {
                setHead(node);
                p.next = null; // help GC
                failed = false;
                return interrupted;
            }
            if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                parkAndChecknIterrupt())
                interrupted = true;
        }
    } finally {
        if (failed)
            cancelAcquire(node);
    }
}

private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) {
    int ws = pred.waitStatus;
    if (ws == Node.SIGNAL)
        return true;
    if (ws &gt; 0) {
        do {
            node.prev = pred = pred.prev;
        } while (pred.waitStatus &gt; 0);
        pred.next = node;
    } else {
        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);
    }
    return false;
}

private final boolean parkAndCheckInterrupt() {
    LockSupport.park(this);
    return Thread.interrupted();
}
</code></pre><p><code>acquireQueued()</code>è¿™ä¸ªæ–¹æ³•ä¼šå…ˆåˆ¤æ–­å½“å‰ä¼ å…¥çš„<code>Node</code>å¯¹åº”çš„å‰ç½®èŠ‚ç‚¹æ˜¯å¦ä¸º<code>head</code>ï¼Œå¦‚æœæ˜¯åˆ™å°è¯•åŠ é”ã€‚åŠ é”æˆåŠŸè¿‡åˆ™å°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸º<code>head</code>èŠ‚ç‚¹ï¼Œç„¶åç©ºç½®ä¹‹å‰çš„<code>head</code>èŠ‚ç‚¹ï¼Œæ–¹ä¾¿åç»­è¢«åƒåœ¾å›æ”¶æ‰ã€‚</p>
<p>å¦‚æœåŠ é”å¤±è´¥æˆ–è€…<code>Node</code>çš„å‰ç½®èŠ‚ç‚¹ä¸æ˜¯<code>head</code>èŠ‚ç‚¹ï¼Œå°±ä¼šé€šè¿‡<code>shouldParkAfterFailedAcquire</code>æ–¹æ³• å°†<code>head</code>èŠ‚ç‚¹çš„<code>waitStatus</code>å˜ä¸ºäº†<code>SIGNAL=-1</code>ï¼Œæœ€åæ‰§è¡Œ<code>parkAndChecknIterrupt</code>æ–¹æ³•ï¼Œè°ƒç”¨<code>LockSupport.park()</code>æŒ‚èµ·å½“å‰çº¿ç¨‹ã€‚</p>
<p>æ­¤æ—¶<code>AQS</code>ä¸­çš„æ•°æ®å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDMyNzYxZDk2MQ.jfif" alt="image.png"></p>
<p>æ­¤æ—¶<strong>çº¿ç¨‹äºŒ</strong>å°±é™é™çš„å¾…åœ¨<code>AQS</code>çš„ç­‰å¾…é˜Ÿåˆ—é‡Œé¢äº†ï¼Œç­‰ç€å…¶ä»–çº¿ç¨‹é‡Šæ”¾é”æ¥å”¤é†’å®ƒã€‚</p>
<h4 id="çº¿ç¨‹ä¸‰æŠ¢å é”å¤±è´¥">çº¿ç¨‹ä¸‰æŠ¢å é”å¤±è´¥</h4>
<p>çœ‹å®Œäº†<strong>çº¿ç¨‹äºŒ</strong>æŠ¢å é”å¤±è´¥çš„åˆ†æï¼Œé‚£ä¹ˆå†æ¥åˆ†æ<strong>çº¿ç¨‹ä¸‰</strong>æŠ¢å é”å¤±è´¥å°±å¾ˆç®€å•äº†ï¼Œå…ˆçœ‹çœ‹<code>addWaiter(Node mode)</code>æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>private Node addWaiter(Node mode) {
    Node node = new Node(Thread.currentThread(), mode);
    Node pred = tail;
    if (pred != null) {
        node.prev = pred;
        if (compareAndSetTail(pred, node)) {
            pred.next = node;
            return node;
        }
    }
    enq(node);
    return node;
}
</code></pre><p>æ­¤æ—¶ç­‰å¾…é˜Ÿåˆ—çš„<code>tail</code>èŠ‚ç‚¹æŒ‡å‘<strong>çº¿ç¨‹äºŒ</strong>ï¼Œè¿›å…¥<code>if</code>é€»è¾‘åï¼Œé€šè¿‡<code>CAS</code>æŒ‡ä»¤å°†<code>tail</code>èŠ‚ç‚¹é‡æ–°æŒ‡å‘<strong>çº¿ç¨‹ä¸‰</strong>ã€‚æ¥ç€<strong>çº¿ç¨‹ä¸‰</strong>è°ƒç”¨<code>enq()</code>æ–¹æ³•æ‰§è¡Œå…¥é˜Ÿæ“ä½œï¼Œå’Œä¸Šé¢<strong>çº¿ç¨‹äºŒ</strong>æ‰§è¡Œæ–¹å¼æ˜¯ä¸€è‡´çš„ï¼Œå…¥é˜Ÿåä¼šä¿®æ”¹<strong>çº¿ç¨‹äºŒ</strong>å¯¹åº”çš„<code>Node</code>ä¸­çš„<code>waitStatus=SIGNAL</code>ã€‚æœ€å<strong>çº¿ç¨‹ä¸‰</strong>ä¹Ÿä¼šè¢«æŒ‚èµ·ã€‚æ­¤æ—¶ç­‰å¾…é˜Ÿåˆ—çš„æ•°æ®å¦‚å›¾ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDJjOGU1ZTI2OA-1590419214352.jfif" alt="image.png"></p>
<h4 id="çº¿ç¨‹ä¸€é‡Šæ”¾é”">çº¿ç¨‹ä¸€é‡Šæ”¾é”</h4>
<p>ç°åœ¨æ¥åˆ†æä¸‹é‡Šæ”¾é”çš„è¿‡ç¨‹ï¼Œé¦–å…ˆæ˜¯<strong>çº¿ç¨‹ä¸€</strong>é‡Šæ”¾é”ï¼Œé‡Šæ”¾é”åä¼šå”¤é†’<code>head</code>èŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç°åœ¨çš„<strong>çº¿ç¨‹äºŒ</strong>ï¼Œå…·ä½“æ“ä½œæµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDMzMmRmNmZkNQ.jfif" alt="image.png"></p>
<p>æ‰§è¡Œå®Œåç­‰å¾…é˜Ÿåˆ—æ•°æ®å¦‚ä¸‹ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDM0MzkzYzU4Zg.jfif" alt="image.png"></p>
<p>æ­¤æ—¶<strong>çº¿ç¨‹äºŒ</strong>å·²ç»è¢«å”¤é†’ï¼Œç»§ç»­å°è¯•è·å–é”ï¼Œå¦‚æœè·å–é”å¤±è´¥ï¼Œåˆ™ä¼šç»§ç»­è¢«æŒ‚èµ·ã€‚å¦‚æœè·å–é”æˆåŠŸï¼Œåˆ™<code>AQS</code>ä¸­æ•°æ®å¦‚å›¾ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDM1ZDI0OThhYg.jfif" alt="image.png"></p>
<p>æ¥ç€è¿˜æ˜¯ä¸€æ­¥æ­¥æ‹†è§£æ¥çœ‹ï¼Œå…ˆçœ‹çœ‹<strong>çº¿ç¨‹ä¸€</strong>é‡Šæ”¾é”çš„ä»£ç ï¼š</p>
<pre tabindex="0"><code>java.util.concurrent.locks.AbstractQueuedSynchronizer.release()
public final boolean release(int arg) {
    if (tryRelease(arg)) {
        Node h = head;
        if (h != null &amp;&amp; h.waitStatus != 0)
            unparkSuccessor(h);
        return true;
    }
    return false;
}
</code></pre><p>è¿™é‡Œé¦–å…ˆä¼šæ‰§è¡Œ<code>tryRelease()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å…·ä½“å®ç°åœ¨<code>ReentrantLock</code>ä¸­ï¼Œå¦‚æœ<code>tryRelease</code>æ‰§è¡ŒæˆåŠŸï¼Œåˆ™ç»§ç»­åˆ¤æ–­<code>head</code>èŠ‚ç‚¹çš„<code>waitStatus</code>æ˜¯å¦ä¸º 0ï¼Œå‰é¢æˆ‘ä»¬å·²ç»çœ‹åˆ°è¿‡ï¼Œ<code>head</code>çš„<code>waitStatue</code>ä¸º<code>SIGNAL(-1)</code>ï¼Œè¿™é‡Œå°±ä¼šæ‰§è¡Œ<code>unparkSuccessor()</code>æ–¹æ³•æ¥å”¤é†’<code>head</code>çš„åç½®èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šé¢å›¾ä¸­<strong>çº¿ç¨‹äºŒ</strong>å¯¹åº”çš„<code>Node</code>èŠ‚ç‚¹ã€‚</p>
<p>æ­¤æ—¶çœ‹<code>ReentrantLock.tryRelease()</code>ä¸­çš„å…·ä½“å®ç°ï¼š</p>
<pre tabindex="0"><code>protected final boolean tryRelease(int releases) {
    int c = getState() - releases;
    if (Thread.currentThread() != getExclusiveOwnerThread())
        throw new IllegalMonitorStateException();
    boolean free = false;
    if (c == 0) {
        free = true;
        setExclusiveOwnerThread(null);
    }
    setState(c);
    return free;
}
</code></pre><p>æ‰§è¡Œå®Œ<code>ReentrantLock.tryRelease()</code>åï¼Œ<code>state</code>è¢«è®¾ç½®æˆ 0ï¼ŒLock å¯¹è±¡çš„ç‹¬å é”è¢«è®¾ç½®ä¸º nullã€‚æ­¤æ—¶çœ‹ä¸‹<code>AQS</code>ä¸­çš„æ•°æ®ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDM2M2U4NzkwMg.jfif" alt="image.png"></p>
<p>æ¥ç€æ‰§è¡Œ<code>java.util.concurrent.locks.AbstractQueuedSynchronizer.unparkSuccessor()</code>æ–¹æ³•ï¼Œå”¤é†’<code>head</code>çš„åç½®èŠ‚ç‚¹ï¼š</p>
<pre tabindex="0"><code>private void unparkSuccessor(Node node) {
    int ws = node.waitStatus;
    if (ws &lt; 0)
        compareAndSetWaitStatus(node, ws, 0);
    Node s = node.next;
    if (s == null || s.waitStatus &gt; 0) {
        s = null;
        for (Node t = tail; t != null &amp;&amp; t != node; t = t.prev)
            if (t.waitStatus &lt;= 0)
                s = t;
    }
    if (s != null)
        LockSupport.unpark(s.thread);
}
</code></pre><p>è¿™é‡Œä¸»è¦æ˜¯å°†<code>head</code>èŠ‚ç‚¹çš„<code>waitStatus</code>è®¾ç½®ä¸º 0ã€‚</p>
<p>æ­¤æ—¶é‡æ–°å°†<code>head</code>æŒ‡é’ˆæŒ‡å‘<strong>çº¿ç¨‹äºŒ</strong>å¯¹åº”çš„<code>Node</code>èŠ‚ç‚¹ï¼Œä¸”ä½¿ç”¨<code>LockSupport.unpark</code>æ–¹æ³•æ¥å”¤é†’<strong>çº¿ç¨‹äºŒ</strong>ã€‚</p>
<p>è¢«å”¤é†’çš„<strong>çº¿ç¨‹äºŒ</strong>ä¼šæ¥ç€å°è¯•è·å–é”ï¼Œç”¨<code>CAS</code>æŒ‡ä»¤ä¿®æ”¹<code>state</code>æ•°æ®ã€‚ æ‰§è¡Œå®Œæˆåå¯ä»¥æŸ¥çœ‹<code>AQS</code>ä¸­æ•°æ®ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDM0MzkzYzU4Zg-1590419228808.jfif" alt="image.png"></p>
<p>æ­¤æ—¶<strong>çº¿ç¨‹äºŒ</strong>è¢«å”¤é†’ï¼Œ<strong>çº¿ç¨‹äºŒ</strong>æ¥ç€ä¹‹å‰è¢«<code>park</code>çš„åœ°æ–¹ç»§ç»­æ‰§è¡Œï¼Œç»§ç»­æ‰§è¡Œ<code>acquireQueued()</code>æ–¹æ³•ã€‚</p>
<h4 id="çº¿ç¨‹äºŒå”¤é†’ç»§ç»­åŠ é”">çº¿ç¨‹äºŒå”¤é†’ç»§ç»­åŠ é”</h4>
<pre tabindex="0"><code>final boolean acquireQueued(final Node node, int arg) {
    boolean failed = true;
    try {
        boolean interrupted = false;
        for (;;) {
            final Node p = node.predecessor();
            if (p == head &amp;&amp; tryAcquire(arg)) {
                setHead(node);
                p.next = null; // help GC
                failed = false;
                return interrupted;
            }
            if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                parkAndCheckInterrupt())
                interrupted = true;
        }
    } finally {
        if (failed)
            cancelAcquire(node);
    }
}
</code></pre><p>æ­¤æ—¶<strong>çº¿ç¨‹äºŒ</strong>è¢«å”¤é†’ï¼Œç»§ç»­æ‰§è¡Œ<code>for</code>å¾ªç¯ï¼Œåˆ¤æ–­<strong>çº¿ç¨‹äºŒ</strong>çš„å‰ç½®èŠ‚ç‚¹æ˜¯å¦ä¸º<code>head</code>ï¼Œå¦‚æœæ˜¯åˆ™ç»§ç»­ä½¿ç”¨<code>tryAcquire()</code>æ–¹æ³•æ¥å°è¯•è·å–é”ï¼Œå…¶å®å°±æ˜¯ä½¿ç”¨<code>CAS</code>æ“ä½œæ¥ä¿®æ”¹<code>state</code>å€¼ï¼Œå¦‚æœä¿®æ”¹æˆåŠŸåˆ™ä»£è¡¨è·å–é”æˆåŠŸã€‚æ¥ç€å°†<strong>çº¿ç¨‹äºŒ</strong>è®¾ç½®ä¸º<code>head</code>èŠ‚ç‚¹ï¼Œç„¶åç©ºç½®ä¹‹å‰çš„<code>head</code>èŠ‚ç‚¹æ•°æ®ï¼Œè¢«ç©ºç½®çš„èŠ‚ç‚¹æ•°æ®ç­‰ç€è¢«<strong>åƒåœ¾å›æ”¶</strong>ã€‚</p>
<p>æ­¤æ—¶çº¿ç¨‹äºŒè·å–é”æˆåŠŸï¼Œ<code>AQS</code>ä¸­é˜Ÿåˆ—æ•°æ®å¦‚ä¸‹ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDM3ZWI5MzQ5MA.jfif" alt="image.png"></p>
<p>ç­‰å¾…é˜Ÿåˆ—ä¸­çš„æ•°æ®éƒ½ç­‰å¾…ç€è¢«åƒåœ¾å›æ”¶ã€‚</p>
<h4 id="çº¿ç¨‹äºŒé‡Šæ”¾é”çº¿ç¨‹ä¸‰åŠ é”">çº¿ç¨‹äºŒé‡Šæ”¾é”/çº¿ç¨‹ä¸‰åŠ é”</h4>
<p>å½“<strong>çº¿ç¨‹äºŒ</strong>é‡Šæ”¾é”æ—¶ï¼Œä¼šå”¤é†’è¢«æŒ‚èµ·çš„<strong>çº¿ç¨‹ä¸‰</strong>ï¼Œæµç¨‹å’Œä¸Šé¢å¤§è‡´ç›¸åŒï¼Œè¢«å”¤é†’çš„<strong>çº¿ç¨‹ä¸‰</strong>ä¼šå†æ¬¡å°è¯•åŠ é”ï¼Œå…·ä½“ä»£ç å¯ä»¥å‚è€ƒä¸Šé¢å†…å®¹ã€‚å…·ä½“æµç¨‹å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDNhMWEyNmU5NA.jfif" alt="image.png"></p>
<p>æ­¤æ—¶<code>AQS</code>ä¸­é˜Ÿåˆ—æ•°æ®å¦‚å›¾ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDNhYjVmZDRjNw.jfif" alt="image.png"></p>
<h3 id="å…¬å¹³é”å®ç°åŸç†">å…¬å¹³é”å®ç°åŸç†</h3>
<p>ä¸Šé¢æ‰€æœ‰çš„åŠ é”åœºæ™¯éƒ½æ˜¯åŸºäº<strong>éå…¬å¹³é”</strong>æ¥å®ç°çš„ï¼Œ<strong>éå…¬å¹³é”</strong>æ˜¯<code>ReentrantLock</code>çš„é»˜è®¤å®ç°ï¼Œé‚£æˆ‘ä»¬æ¥ç€æ¥çœ‹ä¸€ä¸‹<strong>å…¬å¹³é”</strong>çš„å®ç°åŸç†ï¼Œè¿™é‡Œå…ˆç”¨ä¸€å¼ å›¾æ¥è§£é‡Š<strong>å…¬å¹³é”</strong>å’Œ<strong>éå…¬å¹³é”</strong>çš„åŒºåˆ«ï¼š</p>
<p><strong>éå…¬å¹³é”</strong>æ‰§è¡Œæµç¨‹ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDNjMjExMjgzOQ.jfif" alt="image.png"></p>
<p>è¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ç”¨ä¹‹å‰çš„çº¿ç¨‹æ¨¡å‹æ¥ä¸¾ä¾‹å­ï¼Œå½“<strong>çº¿ç¨‹äºŒ</strong>é‡Šæ”¾é”çš„æ—¶å€™ï¼Œå”¤é†’è¢«æŒ‚èµ·çš„<strong>çº¿ç¨‹ä¸‰</strong>ï¼Œ<strong>çº¿ç¨‹ä¸‰</strong>æ‰§è¡Œ<code>tryAcquire()</code>æ–¹æ³•ä½¿ç”¨<code>CAS</code>æ“ä½œæ¥å°è¯•ä¿®æ”¹<code>state</code>å€¼ï¼Œå¦‚æœæ­¤æ—¶åˆæ¥äº†ä¸€ä¸ª<strong>çº¿ç¨‹å››</strong>ä¹Ÿæ¥æ‰§è¡ŒåŠ é”æ“ä½œï¼ŒåŒæ ·ä¼šæ‰§è¡Œ<code>tryAcquire()</code>æ–¹æ³•ã€‚</p>
<p>è¿™ç§æƒ…å†µå°±ä¼šå‡ºç°ç«äº‰ï¼Œ<strong>çº¿ç¨‹å››</strong>å¦‚æœè·å–é”æˆåŠŸï¼Œ<strong>çº¿ç¨‹ä¸‰</strong>ä»ç„¶éœ€è¦å¾…åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­è¢«æŒ‚èµ·ã€‚è¿™å°±æ˜¯æ‰€è°“çš„<strong>éå…¬å¹³é”</strong>ï¼Œ<strong>çº¿ç¨‹ä¸‰</strong>è¾›è¾›è‹¦è‹¦æ’é˜Ÿç­‰åˆ°è‡ªå·±è·å–é”ï¼Œå´çœ¼å·´å·´çš„çœ‹åˆ°<strong>çº¿ç¨‹å››</strong>æ’é˜Ÿè·å–åˆ°äº†é”ã€‚</p>
<p><strong>å…¬å¹³é”</strong>æ‰§è¡Œæµç¨‹ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDNjMzQ2MmQ2YQ.jfif" alt="image.png"></p>
<p>å…¬å¹³é”åœ¨åŠ é”çš„æ—¶å€™ï¼Œä¼šå…ˆåˆ¤æ–­<code>AQS</code>ç­‰å¾…é˜Ÿåˆ—ä¸­æ˜¯å­˜åœ¨èŠ‚ç‚¹ï¼Œå¦‚æœå­˜åœ¨èŠ‚ç‚¹åˆ™ä¼šç›´æ¥å…¥é˜Ÿç­‰å¾…ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹.</p>
<p>å…¬å¹³é”åœ¨è·å–é”æ˜¯ä¹Ÿæ˜¯é¦–å…ˆä¼šæ‰§è¡Œ<code>acquire()</code>æ–¹æ³•ï¼Œåªä¸è¿‡å…¬å¹³é”å•ç‹¬å®ç°äº†<code>tryAcquire()</code>æ–¹æ³•ï¼š</p>
<p><code>#java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire()</code>:</p>
<pre tabindex="0"><code>public final void acquire(int arg) {
    if (!tryAcquire(arg) &amp;&amp;
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
}
</code></pre><p>è¿™é‡Œä¼šæ‰§è¡Œ<code>ReentrantLock</code>ä¸­å…¬å¹³é”çš„<code>tryAcquire()</code>æ–¹æ³•</p>
<p><code>#java.util.concurrent.locks.ReentrantLock.FairSync.tryAcquire()</code>:</p>
<pre tabindex="0"><code>static final class FairSync extends Sync {
    protected final boolean tryAcquire(int acquires) {
        final Thread current = Thread.currentThread();
        int c = getState();
        if (c == 0) {
            if (!hasQueuedPredecessors() &amp;&amp;
                compareAndSetState(0, acquires)) {
                setExclusiveOwnerThread(current);
                return true;
            }
        }
        else if (current == getExclusiveOwnerThread()) {
            int nextc = c + acquires;
            if (nextc &lt; 0)
                throw new Error(&quot;Maximum lock count exceeded&quot;);
            setState(nextc);
            return true;
        }
        return false;
    }
}
</code></pre><p>è¿™é‡Œä¼šå…ˆåˆ¤æ–­<code>state</code>å€¼ï¼Œå¦‚æœä¸ä¸º 0 ä¸”è·å–é”çš„çº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œç›´æ¥è¿”å› false ä»£è¡¨è·å–é”å¤±è´¥ï¼Œè¢«åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ã€‚å¦‚æœæ˜¯å½“å‰çº¿ç¨‹åˆ™å¯é‡å…¥è·å–é”ã€‚</p>
<p>å¦‚æœ<code>state=0</code>åˆ™ä»£è¡¨æ­¤æ—¶æ²¡æœ‰çº¿ç¨‹æŒæœ‰é”ï¼Œæ‰§è¡Œ<code>hasQueuedPredecessors()</code>åˆ¤æ–­<code>AQS</code>ç­‰å¾…é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å…ƒç´ å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å…¶ä»–ç­‰å¾…çº¿ç¨‹ï¼Œé‚£ä¹ˆè‡ªå·±ä¹Ÿä¼šåŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨ï¼Œåšåˆ°çœŸæ­£çš„å…ˆæ¥ååˆ°ï¼Œæœ‰åºåŠ é”ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p>
<p><code>#java.util.concurrent.locks.AbstractQueuedSynchronizer.hasQueuedPredecessors()</code>:</p>
<pre tabindex="0"><code>public final boolean hasQueuedPredecessors() {
    Node t = tail;
    Node h = head;
    Node s;
    return h != t &amp;&amp;
        ((s = h.next) == null || s.thread != Thread.currentThread());
}
</code></pre><p>è¿™æ®µä»£ç å¾ˆæœ‰æ„æ€ï¼Œè¿”å›<code>false</code>ä»£è¡¨é˜Ÿåˆ—ä¸­æ²¡æœ‰èŠ‚ç‚¹æˆ–è€…ä»…æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å½“å‰çº¿ç¨‹åˆ›å»ºçš„èŠ‚ç‚¹ã€‚è¿”å›<code>true</code>åˆ™ä»£è¡¨é˜Ÿåˆ—ä¸­å­˜åœ¨ç­‰å¾…èŠ‚ç‚¹ï¼Œå½“å‰çº¿ç¨‹éœ€è¦å…¥é˜Ÿç­‰å¾…ã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDNlMDM2NzlhZA.jfif" alt="image.png"></p>
<p>å…ˆåˆ¤æ–­<code>head</code>æ˜¯å¦ç­‰äº<code>tail</code>ï¼Œå¦‚æœé˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ª<code>Node</code>èŠ‚ç‚¹ï¼Œé‚£ä¹ˆ<code>head</code>ä¼šç­‰äº<code>tail</code>ã€‚</p>
<p>æ¥ç€åˆ¤æ–­<code>(s = h.next) == null</code>ï¼Œè¿™ç§å±äºä¸€ç§æç«¯æƒ…å†µï¼Œåœ¨<code>enq()</code>å…¥é˜Ÿæ“ä½œä¸­ï¼Œæ­¤æ—¶ä¸æ˜¯åŸå­æ€§æ“ä½œï¼Œå¯èƒ½å­˜åœ¨è¿™ç§æƒ…å†µï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzE2LzE3MjFjZDI1MTUzNmU3Y2M.jfif" alt="YcAPpD.png"></p>
<p>åœ¨ç¬¬ä¸€ä¸ªçº¢æ¡†å¤„ï¼Œä¾‹å¦‚ <strong>çº¿ç¨‹ä¸€</strong> æ‰§è¡Œå®Œæˆï¼Œæ­¤æ—¶ head å·²ç»æœ‰å€¼ï¼Œè€Œè¿˜æœªæ‰§è¡Œ<code>tail=head</code>çš„æ—¶å€™ï¼Œæ­¤æ—¶ <strong>çº¿ç¨‹äºŒ</strong> åˆ¤æ–­ <code>head != tail</code>æˆç«‹ã€‚è€Œæ¥ç€ <strong>çº¿ç¨‹ä¸€</strong> æ‰§è¡Œå®Œç¬¬äºŒä¸ªçº¢æ¡†å¤„ï¼Œæ­¤æ—¶<code>tail = node</code>ï¼Œä½†æ˜¯å¹¶æœªå°†<code>head.next</code>æŒ‡å‘<code>node</code>ã€‚è€Œè¿™æ—¶ <strong>çº¿ç¨‹äºŒ</strong> å°±ä¼šå¾—åˆ°<code>head.next == null</code>æˆç«‹ï¼Œç›´æ¥è¿”å› trueã€‚è¿™ç§æƒ…å†µä»£è¡¨æœ‰èŠ‚ç‚¹æ­£åœ¨åšå…¥é˜Ÿæ“ä½œã€‚</p>
<p>å¦‚æœ<code>head.next</code>ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆæ¥ç€åˆ¤æ–­<code>head.next</code>èŠ‚ç‚¹æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹ï¼Œå¦‚æœä¸æ˜¯åˆ™è¿”å› falseã€‚å¤§å®¶è¦è®°æ¸…æ¥šï¼Œè¿”å› false ä»£è¡¨ FIFO é˜Ÿåˆ—ä¸­æ²¡æœ‰ç­‰å¾…è·å–é”çš„èŠ‚ç‚¹ï¼Œæ­¤æ—¶çº¿ç¨‹å¯ä»¥ç›´æ¥å°è¯•è·å–é”ï¼Œå¦‚æœè¿”å› true ä»£è¡¨æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œå½“å‰çº¿ç¨‹å¦‚è¦å…¥é˜Ÿæ’åˆ—ï¼Œè¿™å°±æ˜¯ä½“ç°<strong>å…¬å¹³é”</strong>çš„åœ°æ–¹ã€‚</p>
<p><strong>éå…¬å¹³é”</strong>å’Œ<strong>å…¬å¹³é”</strong>çš„åŒºåˆ«ï¼š <strong>éå…¬å¹³é”</strong>æ€§èƒ½é«˜äº<strong>å…¬å¹³é”</strong>æ€§èƒ½ã€‚<strong>éå…¬å¹³é”</strong>å¯ä»¥å‡å°‘<code>CPU</code>å”¤é†’çº¿ç¨‹çš„å¼€é”€ï¼Œæ•´ä½“çš„ååæ•ˆç‡ä¼šé«˜ç‚¹ï¼Œ<code>CPU</code>ä¹Ÿä¸å¿…å–å”¤é†’æ‰€æœ‰çº¿ç¨‹ï¼Œä¼šå‡å°‘å”¤èµ·çº¿ç¨‹çš„æ•°é‡</p>
<p><strong>éå…¬å¹³é”</strong>æ€§èƒ½è™½ç„¶ä¼˜äº<strong>å…¬å¹³é”</strong>ï¼Œä½†æ˜¯ä¼šå­˜åœ¨å¯¼è‡´<strong>çº¿ç¨‹é¥¥é¥¿</strong>çš„æƒ…å†µã€‚åœ¨æœ€åçš„æƒ…å†µä¸‹ï¼Œå¯èƒ½å­˜åœ¨æŸä¸ªçº¿ç¨‹<strong>ä¸€ç›´è·å–ä¸åˆ°é”</strong>ã€‚ä¸è¿‡ç›¸æ¯”æ€§èƒ½è€Œè¨€ï¼Œé¥¥é¥¿é—®é¢˜å¯ä»¥æš‚æ—¶å¿½ç•¥ï¼Œè¿™å¯èƒ½å°±æ˜¯<code>ReentrantLock</code>é»˜è®¤åˆ›å»ºéå…¬å¹³é”çš„åŸå› ä¹‹ä¸€äº†ã€‚</p>
<h3 id="condition-å®ç°åŸç†">Condition å®ç°åŸç†</h3>
<h4 id="condition-ç®€ä»‹">Condition ç®€ä»‹</h4>
<p>ä¸Šé¢å·²ç»ä»‹ç»äº†<code>AQS</code>æ‰€æä¾›çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå½“ç„¶å®ƒè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„ç‰¹æ€§ï¼Œè¿™é‡Œæˆ‘ä»¬æ¥ç»§ç»­è¯´ä¸‹<code>Condition</code>è¿™ä¸ªç»„ä»¶ã€‚</p>
<pre tabindex="0"><code>Condition`æ˜¯åœ¨`java 1.5`ä¸­æ‰å‡ºç°çš„ï¼Œå®ƒç”¨æ¥æ›¿ä»£ä¼ ç»Ÿçš„`Object`çš„`wait()`ã€`notify()`å®ç°çº¿ç¨‹é—´çš„åä½œï¼Œç›¸æ¯”ä½¿ç”¨`Object`çš„`wait()`ã€`notify()`ï¼Œä½¿ç”¨`Condition`ä¸­çš„`await()`ã€`signal()`è¿™ç§æ–¹å¼å®ç°çº¿ç¨‹é—´åä½œæ›´åŠ å®‰å…¨å’Œé«˜æ•ˆã€‚å› æ­¤é€šå¸¸æ¥è¯´æ¯”è¾ƒæ¨èä½¿ç”¨`Condition
</code></pre><p>å…¶ä¸­<code>AbstractQueueSynchronizer</code>ä¸­å®ç°äº†<code>Condition</code>ä¸­çš„æ–¹æ³•ï¼Œä¸»è¦å¯¹å¤–æä¾›<code>awaite(Object.wait())</code>å’Œ<code>signal(Object.notify())</code>è°ƒç”¨ã€‚</p>
<h4 id="condition-demo-ç¤ºä¾‹">Condition Demo ç¤ºä¾‹</h4>
<p>ä½¿ç”¨ç¤ºä¾‹ä»£ç ï¼š</p>
<pre tabindex="0"><code>/**
 * ReentrantLock å®ç°æºç å­¦ä¹ 
 * @author ä¸€æèŠ±ç®—ä¸ç®—æµªæ¼«
 * @date 2020/4/28 7:20
 */
public class ReentrantLockDemo {
    static ReentrantLock lock = new ReentrantLock();

    public static void main(String[] args) {
        Condition condition = lock.newCondition();

        new Thread(() -&gt; {
            lock.lock();
            try {
                System.out.println(&quot;çº¿ç¨‹ä¸€åŠ é”æˆåŠŸ&quot;);
                System.out.println(&quot;çº¿ç¨‹ä¸€æ‰§è¡Œ await è¢«æŒ‚èµ·&quot;);
                condition.await();
                System.out.println(&quot;çº¿ç¨‹ä¸€è¢«å”¤é†’æˆåŠŸ&quot;);
            } catch (Exception e) {
                e.printStackTrace();
            } finally {
                lock.unlock();
                System.out.println(&quot;çº¿ç¨‹ä¸€é‡Šæ”¾é”æˆåŠŸ&quot;);
            }
        }).start();

        new Thread(() -&gt; {
            lock.lock();
            try {
                System.out.println(&quot;çº¿ç¨‹äºŒåŠ é”æˆåŠŸ&quot;);
                condition.signal();
                System.out.println(&quot;çº¿ç¨‹äºŒå”¤é†’çº¿ç¨‹ä¸€&quot;);
            } finally {
                lock.unlock();
                System.out.println(&quot;çº¿ç¨‹äºŒé‡Šæ”¾é”æˆåŠŸ&quot;);
            }
        }).start();
    }
}
</code></pre><p>æ‰§è¡Œç»“æœå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDNlNjc4NTFiMw.jfif" alt="image.png"></p>
<p>è¿™é‡Œ<strong>çº¿ç¨‹ä¸€</strong>å…ˆè·å–é”ï¼Œç„¶åä½¿ç”¨<code>await()</code>æ–¹æ³•æŒ‚èµ·å½“å‰çº¿ç¨‹å¹¶<strong>é‡Šæ”¾é”</strong>ï¼Œ<strong>çº¿ç¨‹äºŒ</strong>è·å–é”åä½¿ç”¨<code>signal</code>å”¤é†’<strong>çº¿ç¨‹ä¸€</strong>ã€‚</p>
<h4 id="condition-å®ç°åŸç†å›¾è§£">Condition å®ç°åŸç†å›¾è§£</h4>
<p>æˆ‘ä»¬è¿˜æ˜¯ç”¨ä¸Šé¢çš„<code>demo</code>ä½œä¸ºå®ä¾‹ï¼Œæ‰§è¡Œçš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDNmOTE5NmRlYw.jfif" alt="image.png"></p>
<p><strong>çº¿ç¨‹ä¸€</strong>æ‰§è¡Œ<code>await()</code>æ–¹æ³•ï¼š</p>
<p>å…ˆçœ‹ä¸‹å…·ä½“çš„ä»£ç å®ç°ï¼Œ<code>#java.util.concurrent.locks.AbstractQueuedSynchronizer.ConditionObject.await()</code>ï¼š</p>
<pre tabindex="0"><code> public final void await() throws InterruptedException {
    if (Thread.interrupted())
        throw new InterruptedException();
    Node node = addConditionWaiter();
    int savedState = fullyRelease(node);
    int interruptMode = 0;
    while (!isOnSyncQueue(node)) {
        LockSupport.park(this);
        if ((interruptMode = checkInterruptWhileWaiting(node)) != 0)
            break;
    }
    if (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)
        interruptMode = REINTERRUPT;
    if (node.nextWaiter != null) // clean up if cancelled
        unlinkCancelledWaiters();
    if (interruptMode != 0)
        reportInterruptAfterWait(interruptMode);
}
</code></pre><p><code>await()</code>æ–¹æ³•ä¸­é¦–å…ˆè°ƒç”¨<code>addConditionWaiter()</code>å°†å½“å‰çº¿ç¨‹åŠ å…¥åˆ°<code>Condition</code>é˜Ÿåˆ—ä¸­ã€‚</p>
<p>æ‰§è¡Œå®Œåæˆ‘ä»¬å¯ä»¥çœ‹ä¸‹<code>Condition</code>é˜Ÿåˆ—ä¸­çš„æ•°æ®ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDQwM2Y0NTRiYw.jfif" alt="image.png"></p>
<p>å…·ä½“å®ç°ä»£ç ä¸ºï¼š</p>
<pre tabindex="0"><code>private Node addConditionWaiter() {
    Node t = lastWaiter;
    if (t != null &amp;&amp; t.waitStatus != Node.CONDITION) {
        unlinkCancelledWaiters();
        t = lastWaiter;
    }
    Node node = new Node(Thread.currentThread(), Node.CONDITION);
    if (t == null)
        firstWaiter = node;
    else
        t.nextWaiter = node;
    lastWaiter = node;
    return node;
}
</code></pre><p>è¿™é‡Œä¼šç”¨å½“å‰çº¿ç¨‹åˆ›å»ºä¸€ä¸ª<code>Node</code>èŠ‚ç‚¹ï¼Œ<code>waitStatus</code>ä¸º<code>CONDITION</code>ã€‚æ¥ç€ä¼šé‡Šæ”¾è¯¥èŠ‚ç‚¹çš„é”ï¼Œè°ƒç”¨ä¹‹å‰è§£æè¿‡çš„<code>release()</code>æ–¹æ³•ï¼Œé‡Šæ”¾é”åæ­¤æ—¶ä¼šå”¤é†’è¢«æŒ‚èµ·çš„<strong>çº¿ç¨‹äºŒ</strong>ï¼Œ<strong>çº¿ç¨‹äºŒ</strong>ä¼šç»§ç»­å°è¯•è·å–é”ã€‚</p>
<p>æ¥ç€è°ƒç”¨<code>isOnSyncQueue()</code>æ–¹æ³•æ˜¯åˆ¤æ–­å½“å‰çš„çº¿ç¨‹èŠ‚ç‚¹æ˜¯ä¸æ˜¯åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå› ä¸ºä¸Šä¸€æ­¥å·²ç»é‡Šæ”¾äº†é”ï¼Œä¹Ÿå°±æ˜¯è¯´æ­¤æ—¶å¯èƒ½æœ‰çº¿ç¨‹å·²ç»è·å–é”åŒæ—¶å¯èƒ½å·²ç»è°ƒç”¨äº†<code>singal()</code>æ–¹æ³•ï¼Œå¦‚æœå·²ç»å”¤é†’ï¼Œé‚£ä¹ˆå°±ä¸åº”è¯¥<code>park</code>äº†ï¼Œè€Œæ˜¯é€€å‡º<code>while</code>æ–¹æ³•ï¼Œä»è€Œç»§ç»­äº‰æŠ¢é”ã€‚</p>
<p>æ­¤æ—¶<strong>çº¿ç¨‹ä¸€</strong>è¢«æŒ‚èµ·ï¼Œ<strong>çº¿ç¨‹äºŒ</strong>è·å–é”æˆåŠŸã€‚</p>
<p>å…·ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDQyNTBmMzA4OQ.jfif" alt="image.png"></p>
<p><strong>çº¿ç¨‹äºŒ</strong>æ‰§è¡Œ<code>signal()</code>æ–¹æ³•ï¼š</p>
<p>é¦–å…ˆæˆ‘ä»¬è€ƒè™‘ä¸‹<strong>çº¿ç¨‹äºŒ</strong>å·²ç»è·å–åˆ°é”ï¼Œæ­¤æ—¶<code>AQS</code>ç­‰å¾…é˜Ÿåˆ—ä¸­å·²ç»æ²¡æœ‰äº†æ•°æ®ã€‚</p>
<p>æ¥ç€å°±æ¥çœ‹çœ‹<strong>çº¿ç¨‹äºŒ</strong>å”¤é†’<strong>çº¿ç¨‹ä¸€</strong>çš„å…·ä½“æ‰§è¡Œæµç¨‹ï¼š</p>
<pre tabindex="0"><code>public final void signal() {
    if (!isHeldExclusively())
        throw new IllegalMonitorStateException();
    Node first = firstWaiter;
    if (first != null)
        doSignal(first);
}
</code></pre><p>å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºè·å–é”çš„çº¿ç¨‹ï¼Œå¦‚æœä¸æ˜¯åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚ æ¥ç€è°ƒç”¨<code>doSignal()</code>æ–¹æ³•æ¥å”¤é†’çº¿ç¨‹ã€‚</p>
<pre tabindex="0"><code>private void doSignal(Node first) {
    do {
        if ( (firstWaiter = first.nextWaiter) == null)
            lastWaiter = null;
        first.nextWaiter = null;
    } while (!transferForSignal(first) &amp;&amp;
             (first = firstWaiter) != null);
}

final boolean transferForSignal(Node node) {
    if (!compareAndSetWaitStatus(node, Node.CONDITION, 0))
        return false;

    Node p = enq(node);
    int ws = p.waitStatus;
    if (ws &gt; 0 || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))
        LockSupport.unpark(node.thread);
    return true;
}

/**
 * Inserts node into queue, initializing if necessary. See picture above.
 * @param node the node to insert
 * @return node's predecessor
 */
private Node enq(final Node node) {
    for (;;) {
        Node t = tail;
        if (t == null) { // Must initialize
            if (compareAndSetHead(new Node()))
                tail = head;
        } else {
            node.prev = t;
            if (compareAndSetTail(t, node)) {
                t.next = node;
                return t;
            }
        }
    }
}
</code></pre><p>è¿™é‡Œå…ˆä»<code>transferForSignal()</code>æ–¹æ³•æ¥çœ‹ï¼Œé€šè¿‡ä¸Šé¢çš„åˆ†ææˆ‘ä»¬çŸ¥é“<code>Condition</code>é˜Ÿåˆ—ä¸­åªæœ‰çº¿ç¨‹ä¸€åˆ›å»ºçš„ä¸€ä¸ª<code>Node</code>èŠ‚ç‚¹ï¼Œä¸”<code>waitStatue</code>ä¸º<code>CONDITION</code>ï¼Œå…ˆé€šè¿‡<code>CAS</code>ä¿®æ”¹å½“å‰èŠ‚ç‚¹<code>waitStatus</code>ä¸º 0ï¼Œç„¶åæ‰§è¡Œ<code>enq()</code>æ–¹æ³•å°†å½“å‰çº¿ç¨‹åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå¹¶è¿”å›å½“å‰çº¿ç¨‹çš„å‰ç½®èŠ‚ç‚¹ã€‚</p>
<p>åŠ å…¥ç­‰å¾…é˜Ÿåˆ—çš„ä»£ç åœ¨ä¸Šé¢ä¹Ÿå·²ç»åˆ†æè¿‡ï¼Œæ­¤æ—¶ç­‰å¾…é˜Ÿåˆ—ä¸­æ•°æ®å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDQyNWZhMmU5ZQ.jfif" alt="image.png"></p>
<p>æ¥ç€å¼€å§‹é€šè¿‡<code>CAS</code>ä¿®æ”¹å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹<code>waitStatus</code>ä¸º<code>SIGNAL</code>ï¼Œå¹¶ä¸”å”¤é†’å½“å‰çº¿ç¨‹ã€‚æ­¤æ—¶<code>AQS</code>ä¸­ç­‰å¾…é˜Ÿåˆ—æ•°æ®ä¸ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC81LzIvMTcxZDJkNDQ0ODQ0ZDI3ZQ.jfif" alt="image.png"></p>
<p><strong>çº¿ç¨‹ä¸€</strong>è¢«å”¤é†’åï¼Œç»§ç»­æ‰§è¡Œ<code>await()</code>æ–¹æ³•ä¸­çš„ while å¾ªç¯ã€‚</p>
<pre tabindex="0"><code>public final void await() throws InterruptedException {
    if (Thread.interrupted())
        throw new InterruptedException();
    Node node = addConditionWaiter();
    int savedState = fullyRelease(node);
    int interruptMode = 0;
    while (!isOnSyncQueue(node)) {
        LockSupport.park(this);
        if ((interruptMode = checkInterruptWhileWaiting(node)) != 0)
            break;
    }
    if (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)
        interruptMode = REINTERRUPT;
    if (node.nextWaiter != null) // clean up if cancelled
        unlinkCancelledWaiters();
    if (interruptMode != 0)
        reportInterruptAfterWait(interruptMode);
}
</code></pre><p>å› ä¸ºæ­¤æ—¶çº¿ç¨‹ä¸€çš„<code>waitStatus</code>å·²ç»è¢«ä¿®æ”¹ä¸º 0ï¼Œæ‰€ä»¥æ‰§è¡Œ<code>isOnSyncQueue()</code>æ–¹æ³•ä¼šè¿”å›<code>false</code>ã€‚è·³å‡º<code>while</code>å¾ªç¯ã€‚</p>
<p>æ¥ç€æ‰§è¡Œ<code>acquireQueued()</code>æ–¹æ³•ï¼Œè¿™é‡Œä¹‹å‰ä¹Ÿæœ‰è®²è¿‡ï¼Œå°è¯•é‡æ–°è·å–é”ï¼Œå¦‚æœè·å–é”å¤±è´¥ç»§ç»­ä¼šè¢«æŒ‚èµ·ã€‚ç›´åˆ°å¦å¤–çº¿ç¨‹é‡Šæ”¾é”æ‰è¢«å”¤é†’ã€‚</p>
<pre tabindex="0"><code>final boolean acquireQueued(final Node node, int arg) {
    boolean failed = true;
    try {
        boolean interrupted = false;
        for (;;) {
            final Node p = node.predecessor();
            if (p == head &amp;&amp; tryAcquire(arg)) {
                setHead(node);
                p.next = null; // help GC
                failed = false;
                return interrupted;
            }
            if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                parkAndCheckInterrupt())
                interrupted = true;
        }
    } finally {
        if (failed)
            cancelAcquire(node);
    }
}
</code></pre><p>æ­¤æ—¶<strong>çº¿ç¨‹ä¸€</strong>çš„æµç¨‹éƒ½å·²ç»åˆ†æå®Œäº†ï¼Œç­‰<strong>çº¿ç¨‹äºŒ</strong>é‡Šæ”¾é”åï¼Œ<strong>çº¿ç¨‹ä¸€</strong>ä¼šç»§ç»­é‡è¯•è·å–é”ï¼Œæµç¨‹åˆ°æ­¤ç»ˆç»“ã€‚</p>
<h4 id="condition-æ€»ç»“">Condition æ€»ç»“</h4>
<p>æˆ‘ä»¬æ€»ç»“ä¸‹ Condition å’Œ wait/notify çš„æ¯”è¾ƒï¼š</p>
<ul>
<li>Condition å¯ä»¥ç²¾å‡†çš„å¯¹å¤šä¸ªä¸åŒæ¡ä»¶è¿›è¡Œæ§åˆ¶ï¼Œwait/notify åªèƒ½å’Œ synchronized å…³é”®å­—ä¸€èµ·ä½¿ç”¨ï¼Œå¹¶ä¸”åªèƒ½å”¤é†’ä¸€ä¸ªæˆ–è€…å…¨éƒ¨çš„ç­‰å¾…é˜Ÿåˆ—ï¼›</li>
<li>Condition éœ€è¦ä½¿ç”¨ Lock è¿›è¡Œæ§åˆ¶ï¼Œä½¿ç”¨çš„æ—¶å€™è¦æ³¨æ„ lock()ååŠæ—¶çš„ unlock()ï¼ŒCondition æœ‰ç±»ä¼¼äº await çš„æœºåˆ¶ï¼Œå› æ­¤ä¸ä¼šäº§ç”ŸåŠ é”æ–¹å¼è€Œäº§ç”Ÿçš„æ­»é”å‡ºç°ï¼ŒåŒæ—¶åº•å±‚å®ç°çš„æ˜¯ park/unpark çš„æœºåˆ¶ï¼Œå› æ­¤ä¹Ÿä¸ä¼šäº§ç”Ÿå…ˆå”¤é†’å†æŒ‚èµ·çš„æ­»é”ï¼Œä¸€å¥è¯å°±æ˜¯ä¸ä¼šäº§ç”Ÿæ­»é”ï¼Œä½†æ˜¯ wait/notify ä¼šäº§ç”Ÿå…ˆå”¤é†’å†æŒ‚èµ·çš„æ­»é”ã€‚</li>
</ul>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>è¿™é‡Œç”¨äº†ä¸€æ­¥ä¸€å›¾çš„æ–¹å¼ç»“åˆä¸‰ä¸ªçº¿ç¨‹ä¾æ¬¡åŠ é”/é‡Šæ”¾é”æ¥å±•ç¤ºäº†<code>ReentrantLock</code>çš„å®ç°æ–¹å¼å’Œå®ç°åŸç†ï¼Œè€Œ<code>ReentrantLock</code>åº•å±‚å°±æ˜¯åŸºäº<code>AQS</code>å®ç°çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯¹<code>AQS</code>æœ‰äº†æ·±åˆ»çš„ç†è§£ã€‚</p>
<p>å¦å¤–è¿˜ä»‹ç»äº†<strong>å…¬å¹³é”</strong>ä¸<strong>éå…¬å¹³é”</strong>çš„å®ç°åŸç†ï¼Œ<code>Condition</code>çš„å®ç°åŸç†ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ä½¿ç”¨<strong>æºç +ç»˜å›¾</strong>çš„è®²è§£æ–¹å¼ï¼Œå°½é‡è®©å¤§å®¶æ›´å®¹æ˜“å»ç†è§£ã€‚</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/articles/java%E4%B8%AD%E7%9A%84spi.md/"><span></span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/golang/22%E8%AE%B2%E9%80%9A%E5%85%B3go%E8%AF%AD%E8%A8%80/00-%E5%BC%80%E7%AF%87%E8%AF%8D-go-%E4%B8%BA%E5%BC%80%E5%8F%91%E8%80%85%E7%9A%84%E9%9C%80%E6%B1%82%E8%AE%BE%E8%AE%A1%E5%B8%A6%E4%BD%A0%E5%AE%9E%E7%8E%B0%E9%AB%98%E6%95%88%E5%B7%A5%E4%BD%9C/"><span>00 å¼€ç¯‡è¯ Go ä¸ºå¼€å‘è€…çš„éœ€æ±‚è®¾è®¡ï¼Œå¸¦ä½ å®ç°é«˜æ•ˆå·¥ä½œ</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 28280 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>