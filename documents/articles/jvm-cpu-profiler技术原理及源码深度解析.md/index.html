<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title> | Yipsen Ye</title>
<meta name="description" content="ç ”å‘äººå‘˜åœ¨é‡åˆ°çº¿ä¸ŠæŠ¥è­¦æˆ–éœ€è¦ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½æ—¶ï¼Œå¸¸å¸¸éœ€è¦åˆ†æç¨‹åºè¿è¡Œè¡Œä¸ºå’Œæ€§èƒ½ç“¶é¢ˆã€‚ProfilingæŠ€æœ¯æ˜¯ä¸€ç§åœ¨åº”ç”¨è¿è¡Œæ—¶æ”¶é›†ç¨‹åºç›¸å…³ä¿¡æ¯çš„åŠ¨æ€åˆ†ææ‰‹æ®µï¼Œå¸¸ç”¨çš„JVM Profilerå¯ä»¥ä»å¤šä¸ªæ–¹é¢å¯¹ç¨‹åºè¿›è¡ŒåŠ¨æ€åˆ†æï¼Œå¦‚CPUã€Memoryã€Threadã€Classesã€GCç­‰ï¼Œå…¶ä¸­CPU Profilingçš„åº”ç”¨æœ€ä¸ºå¹¿æ³›ã€‚CPU Profilingç»å¸¸è¢«ç”¨äºåˆ†æä»£ç çš„æ‰§è¡Œçƒ­ç‚¹ï¼Œå¦‚â€œå“ªä¸ªæ–¹æ³•å ç”¨CPUçš„æ‰§è¡Œæ—¶é—´æœ€é•¿â€ã€â€œæ¯ä¸ªæ–¹æ³•å ç”¨CPUçš„æ¯”ä¾‹æ˜¯å¤šå°‘â€ç­‰ç­‰ï¼Œé€šè¿‡CPU Profilingå¾—åˆ°ä¸Šè¿°ç›¸å…³ä¿¡æ¯åï¼Œç ”å‘äººå‘˜å°±å¯ä»¥è½»æ¾é’ˆå¯¹çƒ­ç‚¹ç“¶é¢ˆè¿›è¡Œåˆ†æå’Œæ€§èƒ½ä¼˜åŒ–ï¼Œè¿›è€Œçªç ´æ€§èƒ½ç“¶é¢ˆï¼Œå¤§å¹…æå‡ç³»ç»Ÿçš„ååé‡ã€‚
æœ¬æ–‡ä»‹ç»äº†JVMå¹³å°ä¸ŠCPU Profilerçš„å®ç°åŸç†ï¼Œå¸Œæœ›èƒ½å¸®åŠ©è¯»è€…åœ¨ä½¿ç”¨ç±»ä¼¼å·¥å…·çš„åŒæ—¶ä¹Ÿèƒ½æ¸…æ¥šå…¶å†…éƒ¨çš„æŠ€æœ¯å®ç°ã€‚
CPU Profilerç®€ä»‹ ç¤¾åŒºå®ç°çš„JVM Profilerå¾ˆå¤šï¼Œæ¯”å¦‚å·²ç»å•†ç”¨ä¸”åŠŸèƒ½å¼ºå¤§çš„JProfilerï¼Œä¹Ÿæœ‰å…è´¹å¼€æºçš„äº§å“ï¼Œå¦‚JVM-Profilerï¼ŒåŠŸèƒ½å„æœ‰æ‰€é•¿ã€‚æˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨çš„Intellij IDEAæœ€æ–°ç‰ˆå†…éƒ¨ä¹Ÿé›†æˆäº†ä¸€ä¸ªç®€å•å¥½ç”¨çš„Profilerï¼Œè¯¦ç»†çš„ä»‹ç»å‚è§å®˜æ–¹Blogã€‚
åœ¨ç”¨IDEAæ‰“å¼€éœ€è¦è¯Šæ–­çš„Javaé¡¹ç›®åï¼Œåœ¨â€œPreferences -&amp;gt; Build, Execution, Deployment -&amp;gt; Java Profilerâ€ç•Œé¢æ·»åŠ ä¸€ä¸ªâ€œCPU Profilerâ€ï¼Œç„¶åå›åˆ°é¡¹ç›®ï¼Œå•å‡»å³ä¸Šè§’çš„â€œRun with Profilerâ€å¯åŠ¨é¡¹ç›®å¹¶å¼€å§‹CPU Profilingè¿‡ç¨‹ã€‚ä¸€å®šæ—¶é—´åï¼ˆæ¨è5minï¼‰ï¼Œåœ¨Profilerç•Œé¢ç‚¹å‡»â€œStop Profiling and Show Resultsâ€ï¼Œå³å¯çœ‹åˆ°Profilingçš„ç»“æœï¼ŒåŒ…å«ç«ç„°å›¾å’Œè°ƒç”¨æ ‘ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
Intellij IDEA - æ€§èƒ½ç«ç„°å›¾
Intellij IDEA - è°ƒç”¨å †æ ˆæ ‘
ç«ç„°å›¾æ˜¯æ ¹æ®è°ƒç”¨æ ˆçš„æ ·æœ¬é›†ç”Ÿæˆçš„å¯è§†åŒ–æ€§èƒ½åˆ†æå›¾ï¼Œã€Šå¦‚ä½•è¯»æ‡‚ç«ç„°å›¾ï¼Ÿã€‹ä¸€æ–‡å¯¹ç«ç„°å›¾è¿›è¡Œäº†ä¸é”™çš„è®²è§£ï¼Œå¤§å®¶å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚ç®€è€Œè¨€ä¹‹ï¼Œçœ‹ç«ç„°å›¾æ—¶æˆ‘ä»¬éœ€è¦å…³æ³¨â€œå¹³é¡¶â€ï¼Œå› ä¸ºé‚£é‡Œå°±æ˜¯æˆ‘ä»¬ç¨‹åºçš„CPUçƒ­ç‚¹ã€‚è°ƒç”¨æ ‘æ˜¯å¦ä¸€ç§å¯è§†åŒ–åˆ†æçš„æ‰‹æ®µï¼Œä¸ç«ç„°å›¾ä¸€æ ·ï¼Œä¹Ÿæ˜¯æ ¹æ®åŒä¸€ä»½æ ·æœ¬é›†è€Œç”Ÿæˆï¼ŒæŒ‰éœ€é€‰æ‹©å³å¯ã€‚
è¿™é‡Œè¦è¯´æ˜ä¸€ä¸‹ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰åœ¨é¡¹ç›®ä¸­å¼•å…¥ä»»ä½•ä¾èµ–ï¼Œä»…ä»…æ˜¯â€œRun with Profilerâ€ï¼ŒProfilerå°±èƒ½è·å–æˆ‘ä»¬ç¨‹åºè¿è¡Œæ—¶çš„ä¿¡æ¯ã€‚è¿™ä¸ªåŠŸèƒ½å…¶å®æ˜¯é€šè¿‡JVM Agentå®ç°çš„ï¼Œä¸ºäº†æ›´å¥½åœ°å¸®åŠ©å¤§å®¶ç³»ç»Ÿæ€§çš„äº†è§£å®ƒï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå…ˆå¯¹JVM Agentåšä¸ªç®€å•çš„ä»‹ç»ã€‚
JVM Agentç®€ä»‹ JVM Agentæ˜¯ä¸€ä¸ªæŒ‰ä¸€å®šè§„åˆ™ç¼–å†™çš„ç‰¹æ®Šç¨‹åºåº“ï¼Œå¯ä»¥åœ¨å¯åŠ¨é˜¶æ®µé€šè¿‡å‘½ä»¤è¡Œå‚æ•°ä¼ é€’ç»™JVMï¼Œä½œä¸ºä¸€ä¸ªä¼´ç”Ÿåº“ä¸ç›®æ ‡JVMè¿è¡Œåœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ã€‚åœ¨Agentä¸­å¯ä»¥é€šè¿‡å›ºå®šçš„æ¥å£è·å–JVMè¿›ç¨‹å†…çš„ç›¸å…³ä¿¡æ¯ã€‚Agentæ—¢å¯ä»¥æ˜¯ç”¨C/C&#43;&#43;/Rustç¼–å†™çš„JVMTI Agentï¼Œä¹Ÿå¯ä»¥æ˜¯ç”¨Javaç¼–å†™çš„Java Agentã€‚
æ‰§è¡ŒJavaå‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°Agentç›¸å…³çš„å‘½ä»¤è¡Œå‚æ•°ï¼š
Plain Text -agentlib:&amp;lt;åº“å&amp;gt;[=&amp;lt;é€‰é¡¹&amp;gt;] åŠ è½½æœ¬æœºä»£ç†åº“ &amp;lt;åº“å&amp;gt;, ä¾‹å¦‚ -agentlib:jdwp å¦è¯·å‚é˜… -agentlib:jdwp=help -agentpath:&amp;lt;è·¯å¾„å&amp;gt;[=&amp;lt;é€‰é¡¹&amp;gt;] æŒ‰å®Œæ•´è·¯å¾„ååŠ è½½æœ¬æœºä»£ç†åº“ -javaagent:&amp;lt;jar è·¯å¾„&amp;gt;[=&amp;lt;é€‰é¡¹&amp;gt;] åŠ è½½ Java ç¼–ç¨‹è¯­è¨€ä»£ç†, è¯·å‚é˜… java.lang.instrument JVMTI Agent JVMTIï¼ˆJVM Tool Interfaceï¼‰æ˜¯JVMæä¾›çš„ä¸€å¥—æ ‡å‡†çš„C/C&#43;&#43;ç¼–ç¨‹æ¥å£ï¼Œæ˜¯å®ç°Debuggerã€Profilerã€Monitorã€Thread Analyserç­‰å·¥å…·çš„ç»Ÿä¸€åŸºç¡€ï¼Œåœ¨ä¸»æµJavaè™šæ‹Ÿæœºä¸­éƒ½æœ‰å®ç°ã€‚">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><article class="post-block">
        <h1 class="post-title"></h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;0001-01-01 00:00:00</span></div></div>
        <div class="post-content">
            <p>ç ”å‘äººå‘˜åœ¨é‡åˆ°çº¿ä¸ŠæŠ¥è­¦æˆ–éœ€è¦ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½æ—¶ï¼Œå¸¸å¸¸éœ€è¦åˆ†æç¨‹åºè¿è¡Œè¡Œä¸ºå’Œæ€§èƒ½ç“¶é¢ˆã€‚ProfilingæŠ€æœ¯æ˜¯ä¸€ç§åœ¨åº”ç”¨è¿è¡Œæ—¶æ”¶é›†ç¨‹åºç›¸å…³ä¿¡æ¯çš„åŠ¨æ€åˆ†ææ‰‹æ®µï¼Œå¸¸ç”¨çš„JVM Profilerå¯ä»¥ä»å¤šä¸ªæ–¹é¢å¯¹ç¨‹åºè¿›è¡ŒåŠ¨æ€åˆ†æï¼Œå¦‚CPUã€Memoryã€Threadã€Classesã€GCç­‰ï¼Œå…¶ä¸­CPU Profilingçš„åº”ç”¨æœ€ä¸ºå¹¿æ³›ã€‚CPU Profilingç»å¸¸è¢«ç”¨äºåˆ†æä»£ç çš„æ‰§è¡Œçƒ­ç‚¹ï¼Œå¦‚â€œå“ªä¸ªæ–¹æ³•å ç”¨CPUçš„æ‰§è¡Œæ—¶é—´æœ€é•¿â€ã€â€œæ¯ä¸ªæ–¹æ³•å ç”¨CPUçš„æ¯”ä¾‹æ˜¯å¤šå°‘â€ç­‰ç­‰ï¼Œé€šè¿‡CPU Profilingå¾—åˆ°ä¸Šè¿°ç›¸å…³ä¿¡æ¯åï¼Œç ”å‘äººå‘˜å°±å¯ä»¥è½»æ¾é’ˆå¯¹çƒ­ç‚¹ç“¶é¢ˆè¿›è¡Œåˆ†æå’Œæ€§èƒ½ä¼˜åŒ–ï¼Œè¿›è€Œçªç ´æ€§èƒ½ç“¶é¢ˆï¼Œå¤§å¹…æå‡ç³»ç»Ÿçš„ååé‡ã€‚</p>
<p>æœ¬æ–‡ä»‹ç»äº†JVMå¹³å°ä¸ŠCPU Profilerçš„å®ç°åŸç†ï¼Œå¸Œæœ›èƒ½å¸®åŠ©è¯»è€…åœ¨ä½¿ç”¨ç±»ä¼¼å·¥å…·çš„åŒæ—¶ä¹Ÿèƒ½æ¸…æ¥šå…¶å†…éƒ¨çš„æŠ€æœ¯å®ç°ã€‚</p>
<h2 id="cpu-profilerç®€ä»‹">CPU Profilerç®€ä»‹</h2>
<p>ç¤¾åŒºå®ç°çš„JVM Profilerå¾ˆå¤šï¼Œæ¯”å¦‚å·²ç»å•†ç”¨ä¸”åŠŸèƒ½å¼ºå¤§çš„<a href="https://www.ej-technologies.com/products/jprofiler/overview.html">JProfiler</a>ï¼Œä¹Ÿæœ‰å…è´¹å¼€æºçš„äº§å“ï¼Œå¦‚<a href="https://github.com/uber-common/jvm-profiler">JVM-Profiler</a>ï¼ŒåŠŸèƒ½å„æœ‰æ‰€é•¿ã€‚æˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨çš„Intellij IDEAæœ€æ–°ç‰ˆå†…éƒ¨ä¹Ÿé›†æˆäº†ä¸€ä¸ªç®€å•å¥½ç”¨çš„Profilerï¼Œè¯¦ç»†çš„ä»‹ç»å‚è§<a href="https://blog.jetbrains.com/idea/2018/09/intellij-idea-2018-3-eap-git-submodules-jvm-profiler-macos-and-linux-and-more/">å®˜æ–¹Blog</a>ã€‚</p>
<p>åœ¨ç”¨IDEAæ‰“å¼€éœ€è¦è¯Šæ–­çš„Javaé¡¹ç›®åï¼Œåœ¨â€œPreferences -&gt; Build, Execution, Deployment -&gt; Java Profilerâ€ç•Œé¢æ·»åŠ ä¸€ä¸ªâ€œCPU Profilerâ€ï¼Œç„¶åå›åˆ°é¡¹ç›®ï¼Œå•å‡»å³ä¸Šè§’çš„â€œRun with Profilerâ€å¯åŠ¨é¡¹ç›®å¹¶å¼€å§‹CPU Profilingè¿‡ç¨‹ã€‚ä¸€å®šæ—¶é—´åï¼ˆæ¨è5minï¼‰ï¼Œåœ¨Profilerç•Œé¢ç‚¹å‡»â€œStop Profiling and Show Resultsâ€ï¼Œå³å¯çœ‹åˆ°Profilingçš„ç»“æœï¼ŒåŒ…å«ç«ç„°å›¾å’Œè°ƒç”¨æ ‘ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/80cac68ffeaf0064ca261d5acf285353439115.png" alt="Intellij IDEA - æ€§èƒ½ç«ç„°å›¾"></p>
<p>Intellij IDEA - æ€§èƒ½ç«ç„°å›¾</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/d212c393113d821841023d66c50cb8b8710861.png" alt="Intellij IDEA - è°ƒç”¨å †æ ˆæ ‘"></p>
<p>Intellij IDEA - è°ƒç”¨å †æ ˆæ ‘</p>
<p>ç«ç„°å›¾æ˜¯æ ¹æ®è°ƒç”¨æ ˆçš„æ ·æœ¬é›†ç”Ÿæˆçš„å¯è§†åŒ–æ€§èƒ½åˆ†æå›¾ï¼Œã€Š<a href="https://www.ruanyifeng.com/blog/2017/09/flame-graph.html">å¦‚ä½•è¯»æ‡‚ç«ç„°å›¾ï¼Ÿ</a>ã€‹ä¸€æ–‡å¯¹ç«ç„°å›¾è¿›è¡Œäº†ä¸é”™çš„è®²è§£ï¼Œå¤§å®¶å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚ç®€è€Œè¨€ä¹‹ï¼Œçœ‹ç«ç„°å›¾æ—¶æˆ‘ä»¬éœ€è¦å…³æ³¨â€œå¹³é¡¶â€ï¼Œå› ä¸ºé‚£é‡Œå°±æ˜¯æˆ‘ä»¬ç¨‹åºçš„CPUçƒ­ç‚¹ã€‚è°ƒç”¨æ ‘æ˜¯å¦ä¸€ç§å¯è§†åŒ–åˆ†æçš„æ‰‹æ®µï¼Œä¸ç«ç„°å›¾ä¸€æ ·ï¼Œä¹Ÿæ˜¯æ ¹æ®åŒä¸€ä»½æ ·æœ¬é›†è€Œç”Ÿæˆï¼ŒæŒ‰éœ€é€‰æ‹©å³å¯ã€‚</p>
<p>è¿™é‡Œè¦è¯´æ˜ä¸€ä¸‹ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰åœ¨é¡¹ç›®ä¸­å¼•å…¥ä»»ä½•ä¾èµ–ï¼Œä»…ä»…æ˜¯â€œRun with Profilerâ€ï¼ŒProfilerå°±èƒ½è·å–æˆ‘ä»¬ç¨‹åºè¿è¡Œæ—¶çš„ä¿¡æ¯ã€‚è¿™ä¸ªåŠŸèƒ½å…¶å®æ˜¯é€šè¿‡JVM Agentå®ç°çš„ï¼Œä¸ºäº†æ›´å¥½åœ°å¸®åŠ©å¤§å®¶ç³»ç»Ÿæ€§çš„äº†è§£å®ƒï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå…ˆå¯¹JVM Agentåšä¸ªç®€å•çš„ä»‹ç»ã€‚</p>
<h2 id="jvm-agentç®€ä»‹">JVM Agentç®€ä»‹</h2>
<p>JVM Agentæ˜¯ä¸€ä¸ªæŒ‰ä¸€å®šè§„åˆ™ç¼–å†™çš„ç‰¹æ®Šç¨‹åºåº“ï¼Œå¯ä»¥åœ¨å¯åŠ¨é˜¶æ®µé€šè¿‡å‘½ä»¤è¡Œå‚æ•°ä¼ é€’ç»™JVMï¼Œä½œä¸ºä¸€ä¸ªä¼´ç”Ÿåº“ä¸ç›®æ ‡JVMè¿è¡Œåœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ã€‚åœ¨Agentä¸­å¯ä»¥é€šè¿‡å›ºå®šçš„æ¥å£è·å–JVMè¿›ç¨‹å†…çš„ç›¸å…³ä¿¡æ¯ã€‚Agentæ—¢å¯ä»¥æ˜¯ç”¨C/C++/Rustç¼–å†™çš„JVMTI Agentï¼Œä¹Ÿå¯ä»¥æ˜¯ç”¨Javaç¼–å†™çš„Java Agentã€‚</p>
<p>æ‰§è¡ŒJavaå‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°Agentç›¸å…³çš„å‘½ä»¤è¡Œå‚æ•°ï¼š</p>
<pre tabindex="0"><code>Plain Text
    -agentlib:&lt;åº“å&gt;[=&lt;é€‰é¡¹&gt;]
                  åŠ è½½æœ¬æœºä»£ç†åº“ &lt;åº“å&gt;, ä¾‹å¦‚ -agentlib:jdwp
                  å¦è¯·å‚é˜… -agentlib:jdwp=help
    -agentpath:&lt;è·¯å¾„å&gt;[=&lt;é€‰é¡¹&gt;]
                  æŒ‰å®Œæ•´è·¯å¾„ååŠ è½½æœ¬æœºä»£ç†åº“
    -javaagent:&lt;jar è·¯å¾„&gt;[=&lt;é€‰é¡¹&gt;]
                  åŠ è½½ Java ç¼–ç¨‹è¯­è¨€ä»£ç†, è¯·å‚é˜… java.lang.instrument
</code></pre><h3 id="jvmti-agent">JVMTI Agent</h3>
<p>JVMTIï¼ˆJVM Tool Interfaceï¼‰æ˜¯JVMæä¾›çš„ä¸€å¥—æ ‡å‡†çš„C/C++ç¼–ç¨‹æ¥å£ï¼Œæ˜¯å®ç°Debuggerã€Profilerã€Monitorã€Thread Analyserç­‰å·¥å…·çš„ç»Ÿä¸€åŸºç¡€ï¼Œåœ¨ä¸»æµJavaè™šæ‹Ÿæœºä¸­éƒ½æœ‰å®ç°ã€‚</p>
<p>å½“æˆ‘ä»¬è¦åŸºäºJVMTIå®ç°ä¸€ä¸ªAgentæ—¶ï¼Œéœ€è¦å®ç°å¦‚ä¸‹å…¥å£å‡½æ•°ï¼š</p>
<pre tabindex="0"><code>// $JAVA_HOME/include/jvmti.h

JNIEXPORT jint JNICALL Agent_OnLoad(JavaVM *vm, char *options, void *reserved);
</code></pre><p>ä½¿ç”¨C/C++å®ç°è¯¥å‡½æ•°ï¼Œå¹¶å°†ä»£ç ç¼–è¯‘ä¸ºåŠ¨æ€è¿æ¥åº“ï¼ˆLinuxä¸Šæ˜¯.soï¼‰ï¼Œé€šè¿‡-agentpathå‚æ•°å°†åº“çš„å®Œæ•´è·¯å¾„ä¼ é€’ç»™Javaè¿›ç¨‹ï¼ŒJVMå°±ä¼šåœ¨å¯åŠ¨é˜¶æ®µçš„åˆé€‚æ—¶æœºæ‰§è¡Œè¯¥å‡½æ•°ã€‚åœ¨å‡½æ•°å†…éƒ¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡JavaVMæŒ‡é’ˆå‚æ•°æ‹¿åˆ°JNIå’ŒJVMTIçš„å‡½æ•°æŒ‡é’ˆè¡¨ï¼Œè¿™æ ·æˆ‘ä»¬å°±æ‹¥æœ‰äº†ä¸JVMè¿›è¡Œå„ç§å¤æ‚äº¤äº’çš„èƒ½åŠ›ã€‚</p>
<p>æ›´å¤šJVMTIç›¸å…³çš„ç»†èŠ‚å¯ä»¥å‚è€ƒ<a href="https://docs.oracle.com/en/java/javase/12/docs/specs/jvmti.html">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
<h3 id="java-agent">Java Agent</h3>
<p>åœ¨å¾ˆå¤šåœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬æ²¡æœ‰å¿…è¦å¿…é¡»ä½¿ç”¨C/C++æ¥å¼€å‘JVMTI Agentï¼Œå› ä¸ºæˆæœ¬é«˜ä¸”ä¸æ˜“ç»´æŠ¤ã€‚JVMè‡ªèº«åŸºäºJVMTIå°è£…äº†ä¸€å¥—Javaçš„Instrument APIæ¥å£ï¼Œå…è®¸ä½¿ç”¨Javaè¯­è¨€å¼€å‘Java Agentï¼ˆåªæ˜¯ä¸€ä¸ªjaråŒ…ï¼‰ï¼Œå¤§å¤§é™ä½äº†Agentçš„å¼€å‘æˆæœ¬ã€‚ç¤¾åŒºå¼€æºçš„äº§å“å¦‚<a href="https://github.com/oldmanpushcart/greys-anatomy">Greys</a>ã€<a href="https://github.com/alibaba/arthas">Arthas</a>ã€<a href="https://github.com/alibaba/jvm-sandbox">JVM-Sandbox</a>ã€<a href="https://github.com/uber-common/jvm-profiler">JVM-Profiler</a>ç­‰éƒ½æ˜¯çº¯Javaç¼–å†™çš„ï¼Œä¹Ÿæ˜¯ä»¥Java Agentå½¢å¼æ¥è¿è¡Œã€‚</p>
<p>åœ¨Java Agentä¸­ï¼Œæˆ‘ä»¬éœ€è¦åœ¨jaråŒ…çš„MANIFEST.MFä¸­å°†Premain-ClassæŒ‡å®šä¸ºä¸€ä¸ªå…¥å£ç±»ï¼Œå¹¶åœ¨è¯¥å…¥å£ç±»ä¸­å®ç°å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>public static void premain(String args, Instrumentation ins) {
    // implement
}
</code></pre><p>è¿™æ ·æ‰“åŒ…å‡ºæ¥çš„jarå°±æ˜¯ä¸€ä¸ªJava Agentï¼Œå¯ä»¥é€šè¿‡-javaagentå‚æ•°å°†jarä¼ é€’ç»™Javaè¿›ç¨‹ä¼´éšå¯åŠ¨ï¼ŒJVMåŒæ ·ä¼šåœ¨å¯åŠ¨é˜¶æ®µçš„åˆé€‚æ—¶æœºæ‰§è¡Œè¯¥æ–¹æ³•ã€‚</p>
<p>åœ¨è¯¥æ–¹æ³•å†…éƒ¨ï¼Œå‚æ•°Instrumentationæ¥å£æä¾›äº†Retransform Classesçš„èƒ½åŠ›ï¼Œæˆ‘ä»¬åˆ©ç”¨è¯¥æ¥å£å°±å¯ä»¥å¯¹å®¿ä¸»è¿›ç¨‹çš„Classè¿›è¡Œä¿®æ”¹ï¼Œå®ç°æ–¹æ³•è€—æ—¶ç»Ÿè®¡ã€æ•…éšœæ³¨å…¥ã€Traceç­‰åŠŸèƒ½ã€‚Instrumentationæ¥å£æä¾›çš„èƒ½åŠ›è¾ƒä¸ºå•ä¸€ï¼Œä»…ä¸Classå­—èŠ‚ç æ“ä½œç›¸å…³ï¼Œä½†ç”±äºæˆ‘ä»¬ç°åœ¨å·²ç»å¤„äºå®¿ä¸»è¿›ç¨‹ç¯å¢ƒå†…ï¼Œå°±å¯ä»¥åˆ©ç”¨JMXç›´æ¥è·å–å®¿ä¸»è¿›ç¨‹çš„å†…å­˜ã€çº¿ç¨‹ã€é”ç­‰ä¿¡æ¯ã€‚æ— è®ºæ˜¯Instrument APIè¿˜æ˜¯JMXï¼Œå®ƒä»¬å†…éƒ¨ä»æ˜¯ç»Ÿä¸€åŸºäºJVMTIæ¥å®ç°ã€‚</p>
<p>æ›´å¤šInstrument APIç›¸å…³çš„ç»†èŠ‚å¯ä»¥å‚è€ƒ<a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.instrument/java/lang/instrument/package-summary.html">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
<h2 id="cpu-profileråŸç†è§£æ">CPU ProfileråŸç†è§£æ</h2>
<p>åœ¨äº†è§£å®ŒProfilerå¦‚ä½•ä»¥Agentçš„å½¢å¼æ‰§è¡Œåï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹å°è¯•æ„é€ ä¸€ä¸ªç®€å•çš„CPU Profilerã€‚ä½†åœ¨æ­¤ä¹‹å‰ï¼Œè¿˜æœ‰å¿…è¦äº†è§£ä¸‹CPU ProfilingæŠ€æœ¯çš„ä¸¤ç§å®ç°æ–¹å¼åŠå…¶åŒºåˆ«ã€‚</p>
<h3 id="sampling-vs-instrumentation">Sampling vs Instrumentation</h3>
<p>ä½¿ç”¨è¿‡JProfilerçš„åŒå­¦åº”è¯¥éƒ½çŸ¥é“ï¼ŒJProfilerçš„CPU ProfilingåŠŸèƒ½æä¾›äº†ä¸¤ç§æ–¹å¼é€‰é¡¹: Samplingå’ŒInstrumentationï¼Œå®ƒä»¬ä¹Ÿæ˜¯å®ç°CPU Profilerçš„ä¸¤ç§æ‰‹æ®µã€‚</p>
<p>Samplingæ–¹å¼é¡¾åæ€ä¹‰ï¼ŒåŸºäºå¯¹StackTraceçš„â€œé‡‡æ ·â€è¿›è¡Œå®ç°ï¼Œæ ¸å¿ƒåŸç†å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¼•å…¥Profilerä¾èµ–ï¼Œæˆ–ç›´æ¥åˆ©ç”¨AgentæŠ€æœ¯æ³¨å…¥ç›®æ ‡JVMè¿›ç¨‹å¹¶å¯åŠ¨Profilerã€‚</li>
<li>å¯åŠ¨ä¸€ä¸ªé‡‡æ ·å®šæ—¶å™¨ï¼Œä»¥å›ºå®šçš„é‡‡æ ·é¢‘ç‡æ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆæ¯«ç§’çº§ï¼‰å¯¹æ‰€æœ‰çº¿ç¨‹çš„è°ƒç”¨æ ˆè¿›è¡ŒDumpã€‚</li>
<li>æ±‡æ€»å¹¶ç»Ÿè®¡æ¯æ¬¡è°ƒç”¨æ ˆçš„Dumpç»“æœï¼Œåœ¨ä¸€å®šæ—¶é—´å†…é‡‡åˆ°è¶³å¤Ÿçš„æ ·æœ¬åï¼Œå¯¼å‡ºç»Ÿè®¡ç»“æœï¼Œå†…å®¹æ˜¯æ¯ä¸ªæ–¹æ³•è¢«é‡‡æ ·åˆ°çš„æ¬¡æ•°åŠæ–¹æ³•çš„è°ƒç”¨å…³ç³»ã€‚</li>
</ol>
<p>Instrumentationåˆ™æ˜¯åˆ©ç”¨Instrument APIï¼Œå¯¹æ‰€æœ‰å¿…è¦çš„Classè¿›è¡Œå­—èŠ‚ç å¢å¼ºï¼Œåœ¨è¿›å…¥æ¯ä¸ªæ–¹æ³•å‰è¿›è¡ŒåŸ‹ç‚¹ï¼Œæ–¹æ³•æ‰§è¡Œç»“æŸåç»Ÿè®¡æœ¬æ¬¡æ–¹æ³•æ‰§è¡Œè€—æ—¶ï¼Œæœ€ç»ˆè¿›è¡Œæ±‡æ€»ã€‚äºŒè€…éƒ½èƒ½å¾—åˆ°æƒ³è¦çš„ç»“æœï¼Œé‚£ä¹ˆå®ƒä»¬æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿæˆ–è€…è¯´ï¼Œå­°ä¼˜å­°åŠ£ï¼Ÿ</p>
<p>Instrumentationæ–¹å¼å¯¹å‡ ä¹æ‰€æœ‰æ–¹æ³•æ·»åŠ äº†é¢å¤–çš„AOPé€»è¾‘ï¼Œè¿™ä¼šå¯¼è‡´å¯¹çº¿ä¸ŠæœåŠ¡é€ æˆå·¨é¢çš„æ€§èƒ½å½±å“ï¼Œä½†å…¶ä¼˜åŠ¿æ˜¯ï¼šç»å¯¹ç²¾å‡†çš„æ–¹æ³•è°ƒç”¨æ¬¡æ•°ã€è°ƒç”¨æ—¶é—´ç»Ÿè®¡ã€‚</p>
<p>Samplingæ–¹å¼åŸºäºæ— ä¾µå…¥çš„é¢å¤–çº¿ç¨‹å¯¹æ‰€æœ‰çº¿ç¨‹çš„è°ƒç”¨æ ˆå¿«ç…§è¿›è¡Œå›ºå®šé¢‘ç‡æŠ½æ ·ï¼Œç›¸å¯¹å‰è€…æ¥è¯´å®ƒçš„æ€§èƒ½å¼€é”€å¾ˆä½ã€‚ä½†ç”±äºå®ƒåŸºäºâ€œé‡‡æ ·â€çš„æ¨¡å¼ï¼Œä»¥åŠJVMå›ºæœ‰çš„åªèƒ½åœ¨å®‰å…¨ç‚¹ï¼ˆSafe Pointï¼‰è¿›è¡Œé‡‡æ ·çš„â€œç¼ºé™·â€ï¼Œä¼šå¯¼è‡´ç»Ÿè®¡ç»“æœå­˜åœ¨ä¸€å®šçš„åå·®ã€‚è­¬å¦‚è¯´ï¼šæŸäº›æ–¹æ³•æ‰§è¡Œæ—¶é—´æçŸ­ï¼Œä½†æ‰§è¡Œé¢‘ç‡å¾ˆé«˜ï¼ŒçœŸå®å ç”¨äº†å¤§é‡çš„CPU Timeï¼Œä½†Sampling Profilerçš„é‡‡æ ·å‘¨æœŸä¸èƒ½æ— é™è°ƒå°ï¼Œè¿™ä¼šå¯¼è‡´æ€§èƒ½å¼€é”€éª¤å¢ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´å¤§é‡çš„æ ·æœ¬è°ƒç”¨æ ˆä¸­å¹¶ä¸å­˜åœ¨åˆšæ‰æåˆ°çš„â€é«˜é¢‘å°æ–¹æ³•â€œï¼Œè¿›è€Œå¯¼è‡´æœ€ç»ˆç»“æœæ— æ³•åæ˜ çœŸå®çš„CPUçƒ­ç‚¹ã€‚æ›´å¤šSamplingç›¸å…³çš„é—®é¢˜å¯ä»¥å‚è€ƒã€Š<a href="https://psy-lob-saw.blogspot.com/2016/02/why-most-sampling-java-profilers-are.html">Why (Most) Sampling Java Profilers Are Fucking Terrible</a>ã€‹ã€‚</p>
<p>å…·ä½“åˆ°â€œå­°ä¼˜å­°åŠ£â€çš„é—®é¢˜å±‚é¢ï¼Œè¿™ä¸¤ç§å®ç°æŠ€æœ¯å¹¶æ²¡æœ‰éå¸¸æ˜æ˜¾çš„é«˜ä¸‹ä¹‹åˆ¤ï¼Œåªæœ‰åœ¨åˆ†åœºæ™¯è®¨è®ºä¸‹æ‰æœ‰æ„ä¹‰ã€‚Samplingç”±äºä½å¼€é”€çš„ç‰¹æ€§ï¼Œæ›´é€‚åˆç”¨åœ¨CPUå¯†é›†å‹çš„åº”ç”¨ä¸­ï¼Œä»¥åŠä¸å¯æ¥å—å¤§é‡æ€§èƒ½å¼€é”€çš„çº¿ä¸ŠæœåŠ¡ä¸­ã€‚è€ŒInstrumentationåˆ™æ›´é€‚åˆç”¨åœ¨I/Oå¯†é›†çš„åº”ç”¨ä¸­ã€å¯¹æ€§èƒ½å¼€é”€ä¸æ•æ„Ÿä»¥åŠç¡®å®éœ€è¦ç²¾ç¡®ç»Ÿè®¡çš„åœºæ™¯ä¸­ã€‚ç¤¾åŒºçš„Profileræ›´å¤šçš„æ˜¯åŸºäºSamplingæ¥å®ç°ï¼Œæœ¬æ–‡ä¹Ÿæ˜¯åŸºäºSamplingæ¥è¿›è¡Œè®²è§£ã€‚</p>
<h3 id="åŸºäºjava-agent--jmxå®ç°">åŸºäºJava Agent + JMXå®ç°</h3>
<p>ä¸€ä¸ªæœ€ç®€å•çš„Sampling CPU Profilerå¯ä»¥ç”¨Java Agent + JMXæ–¹å¼æ¥å®ç°ã€‚ä»¥Java Agentä¸ºå…¥å£ï¼Œè¿›å…¥ç›®æ ‡JVMè¿›ç¨‹åå¼€å¯ä¸€ä¸ªScheduledExecutorServiceï¼Œå®šæ—¶åˆ©ç”¨JMXçš„threadMXBean.dumpAllThreads()æ¥å¯¼å‡ºæ‰€æœ‰çº¿ç¨‹çš„StackTraceï¼Œæœ€ç»ˆæ±‡æ€»å¹¶å¯¼å‡ºå³å¯ã€‚</p>
<p>Uberçš„<a href="https://github.com/uber-common/jvm-profiler">JVM-Profiler</a>å®ç°åŸç†ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå…³é”®éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>// com/uber/profiling/profilers/StacktraceCollectorProfiler.java

/*
 * StacktraceCollectorProfilerç­‰åŒäºæ–‡ä¸­æ‰€è¿°CpuProfilerï¼Œä»…å‘½ååå¥½ä¸åŒè€Œå·²
 * jvm-profilerçš„CpuProfileræŒ‡ä»£çš„æ˜¯CpuLoadæŒ‡æ ‡çš„Profiler
 */

// å®ç°äº†Profileræ¥å£ï¼Œå¤–éƒ¨ç”±ç»Ÿä¸€çš„ScheduledExecutorServiceå¯¹æ‰€æœ‰Profilerå®šæ—¶æ‰§è¡Œ
@Override
public void profile() {
    ThreadInfo[] threadInfos = threadMXBean.dumpAllThreads(false, false);
    // ...
    for (ThreadInfo threadInfo : threadInfos) {
        String threadName = threadInfo.getThreadName();
        // ...
        StackTraceElement[] stackTraceElements = threadInfo.getStackTrace();
        // ...
        for (int i = stackTraceElements.length - 1; i &gt;= 0; i--) {
            StackTraceElement stackTraceElement = stackTraceElements[i];
            // ...
        }
        // ...
    }
}
</code></pre><p>Uberæä¾›çš„å®šæ—¶å™¨é»˜è®¤Intervalæ˜¯100msï¼Œå¯¹äºCPU Profileræ¥è¯´ï¼Œè¿™ç•¥æ˜¾ç²—ç³™ã€‚ä½†ç”±äºdumpAllThreads()çš„æ‰§è¡Œå¼€é”€ä¸å®¹å°è§‘ï¼ŒIntervalä¸å®œè®¾ç½®çš„è¿‡å°ï¼Œæ‰€ä»¥è¯¥æ–¹æ³•çš„CPU Profilingç»“æœä¼šå­˜åœ¨ä¸å°çš„è¯¯å·®ã€‚</p>
<p>JVM-Profilerçš„ä¼˜ç‚¹åœ¨äºæ”¯æŒå¤šç§æŒ‡æ ‡çš„Profilingï¼ˆStackTraceã€CPUBusyã€Memoryã€I/Oã€Methodï¼‰ï¼Œä¸”æ”¯æŒå°†Profilingç»“æœé€šè¿‡Kafkaä¸ŠæŠ¥å›ä¸­å¿ƒServerè¿›è¡Œåˆ†æï¼Œä¹Ÿå³æ”¯æŒé›†ç¾¤è¯Šæ–­ã€‚</p>
<h3 id="åŸºäºjvmti--getstacktraceå®ç°">åŸºäºJVMTI + GetStackTraceå®ç°</h3>
<p>ä½¿ç”¨Javaå®ç°Profilerç›¸å¯¹è¾ƒç®€å•ï¼Œä½†ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œè­¬å¦‚è¯´Java Agentä»£ç ä¸ä¸šåŠ¡ä»£ç å…±äº«AppClassLoaderï¼Œè¢«JVMç›´æ¥åŠ è½½çš„agent.jarå¦‚æœå¼•å…¥äº†ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œå¯èƒ½ä¼šå¯¹ä¸šåŠ¡Classé€ æˆæ±¡æŸ“ã€‚æˆªæ­¢å‘ç¨¿æ—¶ï¼ŒJVM-Profileréƒ½å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œå®ƒå¼•å…¥äº†Kafka-Clientã€http-Clientã€Jacksonç­‰ç»„ä»¶ï¼Œå¦‚æœä¸ä¸šåŠ¡ä»£ç ä¸­çš„ç»„ä»¶ç‰ˆæœ¬å‘ç”Ÿå†²çªï¼Œå¯èƒ½ä¼šå¼•å‘æœªçŸ¥é”™è¯¯ã€‚<a href="https://github.com/oldmanpushcart/greys-anatomy">Greys</a>/<a href="https://github.com/alibaba/arthas">Arthas</a>/<a href="https://github.com/alibaba/jvm-sandbox">JVM-Sandbox</a>çš„è§£å†³æ–¹å¼æ˜¯åˆ†ç¦»å…¥å£ä¸æ ¸å¿ƒä»£ç ï¼Œä½¿ç”¨å®šåˆ¶çš„ClassLoaderåŠ è½½æ ¸å¿ƒä»£ç ï¼Œé¿å…å½±å“ä¸šåŠ¡ä»£ç ã€‚</p>
<p>åœ¨æ›´åº•å±‚çš„C/C++å±‚é¢ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å¯¹æ¥JVMTIæ¥å£ï¼Œä½¿ç”¨åŸç”ŸC APIå¯¹JVMè¿›è¡Œæ“ä½œï¼ŒåŠŸèƒ½æ›´ä¸°å¯Œæ›´å¼ºå¤§ï¼Œä½†å¼€å‘æ•ˆç‡åä½ã€‚åŸºäºä¸ŠèŠ‚åŒæ ·çš„åŸç†å¼€å‘CPU Profilerï¼Œä½¿ç”¨JVMTIéœ€è¦è¿›è¡Œå¦‚ä¸‹è¿™äº›æ­¥éª¤ï¼š</p>
<p>1.ç¼–å†™Agent_OnLoad()ï¼Œåœ¨å…¥å£é€šè¿‡JNIçš„JavaVM*æŒ‡é’ˆçš„GetEnv()å‡½æ•°æ‹¿åˆ°JVMTIçš„jvmtiEnvæŒ‡é’ˆï¼š</p>
<pre tabindex="0"><code>// agent.c

JNIEXPORT jint JNICALL Agent_OnLoad(JavaVM *vm, char *options, void *reserved) {
    jvmtiEnv *jvmti;
    (*vm)-&gt;GetEnv((void **)&amp;jvmti, JVMTI_VERSION_1_0);
    // ...
    return JNI_OK;
}
</code></pre><p>2.å¼€å¯ä¸€ä¸ªçº¿ç¨‹å®šæ—¶å¾ªç¯ï¼Œå®šæ—¶ä½¿ç”¨jvmtiEnvæŒ‡é’ˆé…åˆè°ƒç”¨å¦‚ä¸‹å‡ ä¸ªJVMTIå‡½æ•°ï¼š</p>
<pre tabindex="0"><code>// è·å–æ‰€æœ‰çº¿ç¨‹çš„jthread
jvmtiError GetAllThreads(jvmtiEnv *env, jint *threads_count_ptr, jthread **threads_ptr);

// æ ¹æ®jthreadè·å–è¯¥çº¿ç¨‹ä¿¡æ¯ï¼ˆnameã€daemonã€priority...ï¼‰
jvmtiError GetThreadInfo(jvmtiEnv *env, jthread thread, jvmtiThreadInfo* info_ptr);

// æ ¹æ®jthreadè·å–è¯¥çº¿ç¨‹è°ƒç”¨æ ˆ
jvmtiError GetStackTrace(jvmtiEnv *env,
                         jthread thread,
                         jint start_depth,
                         jint max_frame_count,
                         jvmtiFrameInfo *frame_buffer,
                         jint *count_ptr);
</code></pre><p>ä¸»é€»è¾‘å¤§è‡´æ˜¯ï¼šé¦–å…ˆè°ƒç”¨GetAllThreads()è·å–æ‰€æœ‰çº¿ç¨‹çš„â€œå¥æŸ„â€jthreadï¼Œç„¶åéå†æ ¹æ®jthreadè°ƒç”¨GetThreadInfo()è·å–çº¿ç¨‹ä¿¡æ¯ï¼ŒæŒ‰çº¿ç¨‹åè¿‡æ»¤æ‰ä¸éœ€è¦çš„çº¿ç¨‹åï¼Œç»§ç»­éå†æ ¹æ®jthreadè°ƒç”¨GetStackTrace()è·å–çº¿ç¨‹çš„è°ƒç”¨æ ˆã€‚</p>
<p>3.åœ¨Bufferä¸­ä¿å­˜æ¯ä¸€æ¬¡çš„é‡‡æ ·ç»“æœï¼Œæœ€ç»ˆç”Ÿæˆå¿…è¦çš„ç»Ÿè®¡æ•°æ®å³å¯ã€‚</p>
<p>æŒ‰å¦‚ä¸Šæ­¥éª¤å³å¯å®ç°åŸºäºJVMTIçš„CPU Profilerã€‚ä½†éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå³ä¾¿æ˜¯åŸºäºåŸç”ŸJVMTIæ¥å£ä½¿ç”¨GetStackTrace()çš„æ–¹å¼è·å–è°ƒç”¨æ ˆï¼Œä¹Ÿå­˜åœ¨ä¸JMXç›¸åŒçš„é—®é¢˜â€”â€”åªèƒ½åœ¨å®‰å…¨ç‚¹ï¼ˆSafe Pointï¼‰è¿›è¡Œé‡‡æ ·ã€‚</p>
<h3 id="safepoint-biasé—®é¢˜">SafePoint Biasé—®é¢˜</h3>
<p>åŸºäºSamplingçš„CPU Profileré€šè¿‡é‡‡é›†ç¨‹åºåœ¨ä¸åŒæ—¶é—´ç‚¹çš„è°ƒç”¨æ ˆæ ·æœ¬æ¥è¿‘ä¼¼åœ°æ¨ç®—å‡ºçƒ­ç‚¹æ–¹æ³•ï¼Œå› æ­¤ï¼Œä»ç†è®ºä¸Šæ¥è®²Sampling CPU Profilerå¿…é¡»éµå¾ªä»¥ä¸‹ä¸¤ä¸ªåŸåˆ™ï¼š</p>
<ol>
<li>æ ·æœ¬å¿…é¡»è¶³å¤Ÿå¤šã€‚</li>
<li>ç¨‹åºä¸­æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ä»£ç ç‚¹éƒ½å¿…é¡»ä»¥ç›¸åŒçš„æ¦‚ç‡è¢«Profileré‡‡æ ·ã€‚</li>
</ol>
<p>å¦‚æœåªèƒ½åœ¨å®‰å…¨ç‚¹é‡‡æ ·ï¼Œå°±è¿èƒŒäº†ç¬¬äºŒæ¡åŸåˆ™ã€‚å› ä¸ºæˆ‘ä»¬åªèƒ½é‡‡é›†åˆ°ä½äºå®‰å…¨ç‚¹æ—¶åˆ»çš„è°ƒç”¨æ ˆå¿«ç…§ï¼Œæ„å‘³ç€æŸäº›ä»£ç å¯èƒ½æ°¸è¿œæ²¡æœ‰æœºä¼šè¢«é‡‡æ ·ï¼Œå³ä½¿å®ƒçœŸå®è€—è´¹äº†å¤§é‡çš„CPUæ‰§è¡Œæ—¶é—´ï¼Œè¿™ç§ç°è±¡è¢«ç§°ä¸ºâ€œSafePoint Biasâ€ã€‚</p>
<p>ä¸Šæ–‡æˆ‘ä»¬æåˆ°ï¼ŒåŸºäºJMXä¸åŸºäºJVMTIçš„Profilerå®ç°éƒ½å­˜åœ¨SafePoint Biasï¼Œä½†ä¸€ä¸ªå€¼å¾—äº†è§£çš„ç»†èŠ‚æ˜¯ï¼šå•ç‹¬æ¥è¯´ï¼ŒJVMTIçš„GetStackTrace()å‡½æ•°å¹¶ä¸éœ€è¦åœ¨Callerçš„å®‰å…¨ç‚¹æ‰§è¡Œï¼Œä½†å½“è°ƒç”¨GetStackTrace()è·å–å…¶ä»–çº¿ç¨‹çš„è°ƒç”¨æ ˆæ—¶ï¼Œå¿…é¡»ç­‰å¾…ï¼Œç›´åˆ°ç›®æ ‡çº¿ç¨‹è¿›å…¥å®‰å…¨ç‚¹ï¼›è€Œä¸”ï¼ŒGetStackTrace()ä»…èƒ½é€šè¿‡å•ç‹¬çš„çº¿ç¨‹åŒæ­¥å®šæ—¶è°ƒç”¨ï¼Œä¸èƒ½åœ¨UNIXä¿¡å·å¤„ç†å™¨çš„Handlerä¸­è¢«å¼‚æ­¥è°ƒç”¨ã€‚ç»¼åˆæ¥è¯´ï¼ŒGetStackTrace()å­˜åœ¨ä¸JMXä¸€æ ·çš„SafePoint Biasã€‚æ›´å¤šå®‰å…¨ç‚¹ç›¸å…³çš„çŸ¥è¯†å¯ä»¥å‚è€ƒã€ŠSafepoints: Meaning, Side Effects and Overheadsã€‹ã€‚</p>
<p>é‚£ä¹ˆï¼Œå¦‚ä½•é¿å…SafePoint Biasï¼Ÿç¤¾åŒºæä¾›äº†ä¸€ç§Hackæ€è·¯â€”â€”AsyncGetCallTraceã€‚</p>
<h3 id="åŸºäºjvmti--asyncgetcalltraceå®ç°">åŸºäºJVMTI + AsyncGetCallTraceå®ç°</h3>
<p>å¦‚ä¸ŠèŠ‚æ‰€è¿°ï¼Œå‡å¦‚æˆ‘ä»¬æ‹¥æœ‰ä¸€ä¸ªå‡½æ•°å¯ä»¥è·å–å½“å‰çº¿ç¨‹çš„è°ƒç”¨æ ˆä¸”ä¸å—å®‰å…¨ç‚¹å¹²æ‰°ï¼Œå¦å¤–å®ƒè¿˜æ”¯æŒåœ¨UNIXä¿¡å·å¤„ç†å™¨ä¸­è¢«å¼‚æ­¥è°ƒç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€æ³¨å†Œä¸€ä¸ªUNIXä¿¡å·å¤„ç†å™¨ï¼Œåœ¨Handlerä¸­è°ƒç”¨è¯¥å‡½æ•°è·å–å½“å‰çº¿ç¨‹çš„è°ƒç”¨æ ˆå³å¯ã€‚ç”±äºUNIXä¿¡å·ä¼šè¢«å‘é€ç»™è¿›ç¨‹çš„éšæœºä¸€çº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œå› æ­¤æœ€ç»ˆä¿¡å·ä¼šå‡åŒ€åˆ†å¸ƒåœ¨æ‰€æœ‰çº¿ç¨‹ä¸Šï¼Œä¹Ÿå°±å‡åŒ€è·å–äº†æ‰€æœ‰çº¿ç¨‹çš„è°ƒç”¨æ ˆæ ·æœ¬ã€‚</p>
<p>OracleJDK/OpenJDKå†…éƒ¨æä¾›äº†è¿™ä¹ˆä¸€ä¸ªå‡½æ•°â€”â€”AsyncGetCallTraceï¼Œå®ƒçš„åŸå‹å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>// æ ˆå¸§
typedef struct {
 jint lineno;
 jmethodID method_id;
} AGCT_CallFrame;

// è°ƒç”¨æ ˆ
typedef struct {
    JNIEnv *env;
    jint num_frames;
    AGCT_CallFrame *frames;
} AGCT_CallTrace;

// æ ¹æ®ucontextå°†è°ƒç”¨æ ˆå¡«å……è¿›traceæŒ‡é’ˆ
void AsyncGetCallTrace(AGCT_CallTrace *trace, jint depth, void *ucontext);
</code></pre><p>é€šè¿‡åŸå‹å¯ä»¥çœ‹åˆ°ï¼Œè¯¥å‡½æ•°çš„ä½¿ç”¨æ–¹å¼éå¸¸ç®€æ´ï¼Œç›´æ¥é€šè¿‡ucontextå°±èƒ½è·å–åˆ°å®Œæ•´çš„Javaè°ƒç”¨æ ˆã€‚</p>
<p>é¡¾åæ€ä¹‰ï¼ŒAsyncGetCallTraceæ˜¯â€œasyncâ€çš„ï¼Œä¸å—å®‰å…¨ç‚¹å½±å“ï¼Œè¿™æ ·çš„è¯é‡‡æ ·å°±å¯èƒ½å‘ç”Ÿåœ¨ä»»ä½•æ—¶é—´ï¼ŒåŒ…æ‹¬Nativeä»£ç æ‰§è¡ŒæœŸé—´ã€GCæœŸé—´ç­‰ï¼Œåœ¨è¿™æ—¶æˆ‘ä»¬æ˜¯æ— æ³•è·å–Javaè°ƒç”¨æ ˆçš„ï¼ŒAGCT_CallTraceçš„num_frameså­—æ®µæ­£å¸¸æƒ…å†µä¸‹æ ‡è¯†äº†è·å–åˆ°çš„è°ƒç”¨æ ˆæ·±åº¦ï¼Œä½†åœ¨å¦‚å‰æ‰€è¿°çš„å¼‚å¸¸æƒ…å†µä¸‹å®ƒå°±è¡¨ç¤ºä¸ºè´Ÿæ•°ï¼Œæœ€å¸¸è§çš„-2ä»£è¡¨æ­¤åˆ»æ­£åœ¨GCã€‚</p>
<p>ç”±äºAsyncGetCallTraceéæ ‡å‡†JVMTIå‡½æ•°ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•åœ¨jvmti.hä¸­æ‰¾åˆ°è¯¥å‡½æ•°å£°æ˜ï¼Œä¸”ç”±äºå…¶ç›®æ ‡æ–‡ä»¶ä¹Ÿæ—©å·²é“¾æ¥è¿›JVMäºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥æ— æ³•é€šè¿‡ç®€å•çš„å£°æ˜æ¥è·å–è¯¥å‡½æ•°çš„åœ°å€ï¼Œè¿™éœ€è¦é€šè¿‡ä¸€äº›Trickæ–¹å¼æ¥è§£å†³ã€‚ç®€å•è¯´ï¼ŒAgentæœ€ç»ˆæ˜¯ä½œä¸ºåŠ¨æ€é“¾æ¥åº“åŠ è½½åˆ°ç›®æ ‡JVMè¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­ï¼Œå› æ­¤å¯ä»¥åœ¨Agent_OnLoadå†…é€šè¿‡glibcæä¾›çš„dlsym()å‡½æ•°æ‹¿åˆ°å½“å‰åœ°å€ç©ºé—´ï¼ˆå³ç›®æ ‡JVMè¿›ç¨‹åœ°å€ç©ºé—´ï¼‰åä¸ºâ€œAsyncGetCallTraceâ€çš„ç¬¦å·åœ°å€ã€‚è¿™æ ·å°±æ‹¿åˆ°äº†è¯¥å‡½æ•°çš„æŒ‡é’ˆï¼ŒæŒ‰ç…§ä¸Šè¿°åŸå‹è¿›è¡Œç±»å‹è½¬æ¢åï¼Œå°±å¯ä»¥æ­£å¸¸è°ƒç”¨äº†ã€‚</p>
<p>é€šè¿‡AsyncGetCallTraceå®ç°CPU Profilerçš„å¤§è‡´æµç¨‹ï¼š</p>
<p>1.ç¼–å†™Agent_OnLoad()ï¼Œåœ¨å…¥å£æ‹¿åˆ°jvmtiEnvå’ŒAsyncGetCallTraceæŒ‡é’ˆï¼Œè·å–AsyncGetCallTraceæ–¹å¼å¦‚ä¸‹:</p>
<pre tabindex="0"><code>typedef void (*AsyncGetCallTrace)(AGCT_CallTrace *traces, jint depth, void *ucontext);
// ...
AsyncGetCallTrace agct_ptr = (AsyncGetCallTrace)dlsym(RTLD_DEFAULT, &quot;AsyncGetCallTrace&quot;);
if (agct_ptr == NULL) {
    void *libjvm = dlopen(&quot;libjvm.so&quot;, RTLD_NOW);
    if (!libjvm) {
        // å¤„ç†dlerror()...
    }
    agct_ptr = (AsyncGetCallTrace)dlsym(libjvm, &quot;AsyncGetCallTrace&quot;);
}
</code></pre><p>2.åœ¨OnLoadé˜¶æ®µï¼Œæˆ‘ä»¬è¿˜éœ€è¦åšä¸€ä»¶äº‹ï¼Œå³æ³¨å†ŒOnClassLoadå’ŒOnClassPrepareè¿™ä¸¤ä¸ªHookï¼ŒåŸå› æ˜¯jmethodIDæ˜¯å»¶è¿Ÿåˆ†é…çš„ï¼Œä½¿ç”¨AGCTè·å–Tracesä¾èµ–é¢„å…ˆåˆ†é…å¥½çš„æ•°æ®ã€‚æˆ‘ä»¬åœ¨OnClassPrepareçš„CallBackä¸­å°è¯•è·å–è¯¥Classçš„æ‰€æœ‰Methodsï¼Œè¿™æ ·å°±ä½¿JVMTIæå‰åˆ†é…äº†æ‰€æœ‰æ–¹æ³•çš„jmethodIDï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>void JNICALL OnClassLoad(jvmtiEnv *jvmti, JNIEnv* jni, jthread thread, jclass klass) {}

void JNICALL OnClassPrepare(jvmtiEnv *jvmti, JNIEnv *jni, jthread thread, jclass klass) {
    jint method_count;
    jmethodID *methods;
    jvmti-&gt;GetClassMethods(klass, &amp;method_count, &amp;methods);
    delete [] methods;
}

// ...

jvmtiEventCallbacks callbacks = {0};
callbacks.ClassLoad = OnClassLoad;
callbacks.ClassPrepare = OnClassPrepare;
jvmti-&gt;SetEventCallbacks(&amp;callbacks, sizeof(callbacks));
jvmti-&gt;SetEventNotificationMode(JVMTI_ENABLE, JVMTI_EVENT_CLASS_LOAD, NULL);
jvmti-&gt;SetEventNotificationMode(JVMTI_ENABLE, JVMTI_EVENT_CLASS_PREPARE, NULL);
</code></pre><p>3.åˆ©ç”¨SIGPROFä¿¡å·æ¥è¿›è¡Œå®šæ—¶é‡‡æ ·ï¼š</p>
<pre tabindex="0"><code>// è¿™é‡Œä¿¡å·handlerä¼ è¿›æ¥çš„çš„ucontextå³AsyncGetCallTraceéœ€è¦çš„ucontext
void signal_handler(int signo, siginfo_t *siginfo, void *ucontext) {
    // ä½¿ç”¨AsyncCallTraceè¿›è¡Œé‡‡æ ·ï¼Œæ³¨æ„å¤„ç†num_framesä¸ºè´Ÿçš„å¼‚å¸¸æƒ…å†µ
}

// ...

// æ³¨å†ŒSIGPROFä¿¡å·çš„handler
struct sigaction sa;
sigemptyset(&amp;sa.sa_mask);
sa.sa_sigaction = signal_handler;
sa.sa_flags = SA_RESTART | SA_SIGINFO;
sigaction(SIGPROF, &amp;sa, NULL);

// å®šæ—¶äº§ç”ŸSIGPROFä¿¡å·
// intervalæ˜¯nanosecondsè¡¨ç¤ºçš„é‡‡æ ·é—´éš”ï¼ŒAsyncGetCallTraceç›¸å¯¹äºåŒæ­¥é‡‡æ ·æ¥è¯´å¯ä»¥é€‚å½“é«˜é¢‘ä¸€äº›
long sec = interval / 1000000000;
long usec = (interval % 1000000000) / 1000;
struct itimerval tv = {{sec, usec}, {sec, usec}};
setitimer(ITIMER_PROF, &amp;tv, NULL);
</code></pre><p>4.åœ¨Bufferä¸­ä¿å­˜æ¯ä¸€æ¬¡çš„é‡‡æ ·ç»“æœï¼Œæœ€ç»ˆç”Ÿæˆå¿…è¦çš„ç»Ÿè®¡æ•°æ®å³å¯ã€‚</p>
<p>æŒ‰å¦‚ä¸Šæ­¥éª¤å³å¯å®ç°åŸºäºAsyncGetCallTraceçš„CPU Profilerï¼Œè¿™æ˜¯ç¤¾åŒºä¸­ç›®å‰æ€§èƒ½å¼€é”€æœ€ä½ã€ç›¸å¯¹æ•ˆç‡æœ€é«˜çš„CPU Profilerå®ç°æ–¹å¼ï¼Œåœ¨Linuxç¯å¢ƒä¸‹ç»“åˆperf_eventsè¿˜èƒ½åšåˆ°åŒæ—¶é‡‡æ ·Javaæ ˆä¸Nativeæ ˆï¼Œä¹Ÿå°±èƒ½åŒæ—¶åˆ†æNativeä»£ç ä¸­å­˜åœ¨çš„æ€§èƒ½çƒ­ç‚¹ã€‚è¯¥æ–¹å¼çš„å…¸å‹å¼€æºå®ç°æœ‰<a href="https://github.com/jvm-profiling-tools/async-profiler">Async-Profiler</a>å’Œ<a href="https://github.com/jvm-profiling-tools/honest-profiler">Honest-Profiler</a>ï¼ŒAsync-Profilerå®ç°è´¨é‡è¾ƒé«˜ï¼Œæ„Ÿå…´è¶£çš„è¯å»ºè®®å¤§å®¶é˜…è¯»å‚è€ƒæ–‡ç« ã€‚æœ‰è¶£çš„æ˜¯ï¼ŒIntelliJ IDEAå†…ç½®çš„Java Profilerï¼Œå…¶å®å°±æ˜¯Async-Profilerçš„åŒ…è£…ã€‚æ›´å¤šå…³äºAsyncGetCallTraceçš„å†…å®¹ï¼Œå¤§å®¶å¯ä»¥å‚è€ƒã€Š<a href="https://psy-lob-saw.blogspot.com/2016/06/the-pros-and-cons-of-agct.html">The Pros and Cons of AsyncGetCallTrace Profilers</a>ã€‹ã€‚</p>
<h3 id="ç”Ÿæˆæ€§èƒ½ç«ç„°å›¾">ç”Ÿæˆæ€§èƒ½ç«ç„°å›¾</h3>
<p>ç°åœ¨æˆ‘ä»¬æ‹¥æœ‰äº†é‡‡æ ·è°ƒç”¨æ ˆçš„èƒ½åŠ›ï¼Œä½†æ˜¯è°ƒç”¨æ ˆæ ·æœ¬é›†æ˜¯ä»¥äºŒç»´æ•°ç»„çš„æ•°æ®ç»“æ„å½¢å¼å­˜åœ¨äºå†…å­˜ä¸­çš„ï¼Œå¦‚ä½•å°†å…¶è½¬æ¢ä¸ºå¯è§†åŒ–çš„ç«ç„°å›¾å‘¢ï¼Ÿ</p>
<p>ç«ç„°å›¾é€šå¸¸æ˜¯ä¸€ä¸ªsvgæ–‡ä»¶ï¼Œéƒ¨åˆ†ä¼˜ç§€é¡¹ç›®å¯ä»¥æ ¹æ®æ–‡æœ¬æ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆç«ç„°å›¾æ–‡ä»¶ï¼Œä»…å¯¹æ–‡æœ¬æ–‡ä»¶çš„æ ¼å¼æœ‰ä¸€å®šè¦æ±‚ã€‚FlameGraphé¡¹ç›®çš„æ ¸å¿ƒåªæ˜¯ä¸€ä¸ªPerlè„šæœ¬ï¼Œå¯ä»¥æ ¹æ®æˆ‘ä»¬æä¾›çš„è°ƒç”¨æ ˆæ–‡æœ¬ç”Ÿæˆç›¸åº”çš„ç«ç„°å›¾svgæ–‡ä»¶ã€‚è°ƒç”¨æ ˆçš„æ–‡æœ¬æ ¼å¼ç›¸å½“ç®€å•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>base_func;func1;func2;func3 10
base_func;funca;funcb 15
</code></pre><p>å°†æˆ‘ä»¬é‡‡æ ·åˆ°çš„è°ƒç”¨æ ˆæ ·æœ¬é›†è¿›è¡Œæ•´åˆåï¼Œéœ€è¾“å‡ºå¦‚ä¸Šæ‰€ç¤ºçš„æ–‡æœ¬æ ¼å¼ã€‚æ¯ä¸€è¡Œä»£è¡¨ä¸€â€œç±»â€œè°ƒç”¨æ ˆï¼Œç©ºæ ¼å·¦è¾¹æ˜¯è°ƒç”¨æ ˆçš„æ–¹æ³•åæ’åˆ—ï¼Œä»¥åˆ†å·åˆ†å‰²ï¼Œå·¦æ ˆåº•å³æ ˆé¡¶ï¼Œç©ºæ ¼å³è¾¹æ˜¯è¯¥æ ·æœ¬å‡ºç°çš„æ¬¡æ•°ã€‚</p>
<p>å°†æ ·æœ¬æ–‡ä»¶äº¤ç»™flamegraph.plè„šæœ¬æ‰§è¡Œï¼Œå°±èƒ½è¾“å‡ºç›¸åº”çš„ç«ç„°å›¾äº†ï¼š</p>
<pre tabindex="0"><code>$ flamegraph.pl stacktraces.txt &gt; stacktraces.svg
</code></pre><p>æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/ae2b3dda630d2de82eb632a6e8d5bee9336049.png" alt="é€šè¿‡flamegraph.plç”Ÿæˆçš„ç«ç„°å›¾"></p>
<p>é€šè¿‡flamegraph.plç”Ÿæˆçš„ç«ç„°å›¾</p>
<h2 id="hotspotçš„dynamic-attachæœºåˆ¶è§£æ">HotSpotçš„Dynamic Attachæœºåˆ¶è§£æ</h2>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†CPU Profilerå®Œæ•´çš„å·¥ä½œåŸç†ï¼Œç„¶è€Œä½¿ç”¨è¿‡JProfiler/Arthasçš„åŒå­¦å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼Œå¾ˆå¤šæƒ…å†µä¸‹å¯ä»¥ç›´æ¥å¯¹çº¿ä¸Šè¿è¡Œä¸­çš„æœåŠ¡è¿›è¡ŒProflingï¼Œå¹¶ä¸éœ€è¦åœ¨Javaè¿›ç¨‹çš„å¯åŠ¨å‚æ•°æ·»åŠ Agentå‚æ•°ï¼Œè¿™æ˜¯é€šè¿‡ä»€ä¹ˆæ‰‹æ®µåšåˆ°çš„ï¼Ÿç­”æ¡ˆæ˜¯Dynamic Attachã€‚</p>
<p>JDKåœ¨1.6ä»¥åæä¾›äº†Attach APIï¼Œå…è®¸å‘è¿è¡Œä¸­çš„JVMè¿›ç¨‹æ·»åŠ Agentï¼Œè¿™é¡¹æ‰‹æ®µè¢«å¹¿æ³›ä½¿ç”¨åœ¨å„ç§Profilerå’Œå­—èŠ‚ç å¢å¼ºå·¥å…·ä¸­ï¼Œå…¶å®˜æ–¹ç®€ä»‹å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>This is a Sun extension that allows a tool to â€˜attachâ€™ to another process running Java code and launch a JVM TI agent or a java.lang.instrument agent in that process.</p>
</blockquote>
<p>æ€»çš„æ¥è¯´ï¼ŒDynamic Attachæ˜¯HotSpotæä¾›çš„ä¸€ç§ç‰¹æ®Šèƒ½åŠ›ï¼Œå®ƒå…è®¸ä¸€ä¸ªè¿›ç¨‹å‘å¦ä¸€ä¸ªè¿è¡Œä¸­çš„JVMè¿›ç¨‹å‘é€ä¸€äº›å‘½ä»¤å¹¶æ‰§è¡Œï¼Œå‘½ä»¤å¹¶ä¸é™äºåŠ è½½Agentï¼Œè¿˜åŒ…æ‹¬Dumpå†…å­˜ã€Dumpçº¿ç¨‹ç­‰ç­‰ã€‚</p>
<h3 id="é€šè¿‡suntoolsè¿›è¡Œattach">é€šè¿‡sun.toolsè¿›è¡ŒAttach</h3>
<p>Attachè™½ç„¶æ˜¯HotSpotæä¾›çš„èƒ½åŠ›ï¼Œä½†JDKåœ¨Javaå±‚é¢ä¹Ÿå¯¹å…¶åšäº†å°è£…ã€‚</p>
<p>å‰æ–‡å·²ç»æåˆ°ï¼Œå¯¹äºJava Agentæ¥è¯´ï¼ŒPreMainæ–¹æ³•åœ¨Agentä½œä¸ºå¯åŠ¨å‚æ•°è¿è¡Œçš„æ—¶å€™æ‰§è¡Œï¼Œå…¶å®æˆ‘ä»¬è¿˜å¯ä»¥é¢å¤–å®ç°ä¸€ä¸ªAgentMainæ–¹æ³•ï¼Œå¹¶åœ¨MANIFEST.MFä¸­å°†Agent-ClassæŒ‡å®šä¸ºè¯¥Classï¼š</p>
<pre tabindex="0"><code>public static void agentmain(String args, Instrumentation ins) {
    // implement
}
</code></pre><p>è¿™æ ·æ‰“åŒ…å‡ºæ¥çš„jarï¼Œæ—¢å¯ä»¥ä½œä¸º-javaagentå‚æ•°å¯åŠ¨ï¼Œä¹Ÿå¯ä»¥è¢«Attachåˆ°è¿è¡Œä¸­çš„ç›®æ ‡JVMè¿›ç¨‹ã€‚JDKå·²ç»å°è£…äº†ç®€å•çš„APIè®©æˆ‘ä»¬ç›´æ¥Attachä¸€ä¸ªJava Agentï¼Œä¸‹é¢ä»¥Arthasä¸­çš„ä»£ç è¿›è¡Œæ¼”ç¤ºï¼š</p>
<pre tabindex="0"><code>// com/taobao/arthas/core/Arthas.java

import com.sun.tools.attach.VirtualMachine;
import com.sun.tools.attach.VirtualMachineDescriptor;

// ...

private void attachAgent(Configure configure) throws Exception {
    VirtualMachineDescriptor virtualMachineDescriptor = null;
  
    // æ‹¿åˆ°æ‰€æœ‰JVMè¿›ç¨‹ï¼Œæ‰¾å‡ºç›®æ ‡è¿›ç¨‹
    for (VirtualMachineDescriptor descriptor : VirtualMachine.list()) {
        String pid = descriptor.id();
        if (pid.equals(Integer.toString(configure.getJavaPid()))) {
            virtualMachineDescriptor = descriptor;
        }
    }
    VirtualMachine virtualMachine = null;
    try {
        // é’ˆå¯¹æŸä¸ªJVMè¿›ç¨‹è°ƒç”¨VirtualMachine.attach()æ–¹æ³•ï¼Œæ‹¿åˆ°VirtualMachineå®ä¾‹
        if (null == virtualMachineDescriptor) {
            virtualMachine = VirtualMachine.attach(&quot;&quot; + configure.getJavaPid());
        } else {
            virtualMachine = VirtualMachine.attach(virtualMachineDescriptor);
        }

        // ...

        // è°ƒç”¨VirtualMachine#loadAgent()ï¼Œå°†arthasAgentPathæŒ‡å®šçš„jar attachåˆ°ç›®æ ‡JVMè¿›ç¨‹ä¸­
        // ç¬¬äºŒä¸ªå‚æ•°ä¸ºattachå‚æ•°ï¼Œå³agentmainçš„é¦–ä¸ªStringå‚æ•°args
        virtualMachine.loadAgent(arthasAgentPath, configure.getArthasCore() + &quot;;&quot; + configure.toString());
    } finally {
        if (null != virtualMachine) {
            // è°ƒç”¨VirtualMachine#detach()é‡Šæ”¾
            virtualMachine.detach();
        }
    }
}
</code></pre><h3 id="ç›´æ¥å¯¹hotspotè¿›è¡Œattach">ç›´æ¥å¯¹HotSpotè¿›è¡ŒAttach</h3>
<p>sun.toolså°è£…çš„APIè¶³å¤Ÿç®€å•æ˜“ç”¨ï¼Œä½†åªèƒ½ä½¿ç”¨Javaç¼–å†™ï¼Œä¹Ÿåªèƒ½ç”¨åœ¨Java Agentä¸Šï¼Œå› æ­¤æœ‰äº›æ—¶å€™æˆ‘ä»¬å¿…é¡»æ‰‹å·¥å¯¹JVMè¿›ç¨‹ç›´æ¥è¿›è¡ŒAttachã€‚å¯¹äºJVMTIï¼Œé™¤äº†Agent_OnLoad()ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€å®ç°ä¸€ä¸ªAgent_OnAttach()å‡½æ•°ï¼Œå½“å°†JVMTI Agent Attachåˆ°ç›®æ ‡è¿›ç¨‹æ—¶ï¼Œä»è¯¥å‡½æ•°å¼€å§‹æ‰§è¡Œï¼š</p>
<pre tabindex="0"><code>// $JAVA_HOME/include/jvmti.h

JNIEXPORT jint JNICALL Agent_OnAttach(JavaVM *vm, char *options, void *reserved);
</code></pre><p>ä¸‹é¢æˆ‘ä»¬ä»¥Async-Profilerä¸­çš„jattachæºç ä¸ºçº¿ç´¢ï¼Œæ¢ç©¶ä¸€ä¸‹å¦‚ä½•åˆ©ç”¨Attachæœºåˆ¶ç»™è¿è¡Œä¸­çš„JVMè¿›ç¨‹å‘é€å‘½ä»¤ã€‚jattachæ˜¯Async-Profileræä¾›çš„ä¸€ä¸ªDriverï¼Œä½¿ç”¨æ–¹å¼æ¯”è¾ƒç›´è§‚ï¼š</p>
<pre tabindex="0"><code>Usage:
    jattach &lt;pid&gt; &lt;cmd&gt; [args ...]
Args:
    &lt;pid&gt;  ç›®æ ‡JVMè¿›ç¨‹çš„è¿›ç¨‹ID
    &lt;cmd&gt;  è¦æ‰§è¡Œçš„å‘½ä»¤
    &lt;args&gt; å‘½ä»¤å‚æ•°
</code></pre><p>ä½¿ç”¨æ–¹å¼å¦‚ï¼š</p>
<pre tabindex="0"><code>$ jattach 1234 load /absolute/path/to/agent/libagent.so true
</code></pre><p>æ‰§è¡Œä¸Šè¿°å‘½ä»¤ï¼Œlibagent.soå°±è¢«åŠ è½½åˆ°IDä¸º1234çš„JVMè¿›ç¨‹ä¸­å¹¶å¼€å§‹æ‰§è¡ŒAgent_OnAttachå‡½æ•°äº†ã€‚æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œæ‰§è¡ŒAttachçš„è¿›ç¨‹euidåŠegidï¼Œä¸è¢«Attachçš„ç›®æ ‡JVMè¿›ç¨‹å¿…é¡»ç›¸åŒã€‚æ¥ä¸‹æ¥å¼€å§‹åˆ†æjattachæºç ã€‚</p>
<p>å¦‚ä¸‹æ‰€ç¤ºçš„Mainå‡½æ•°æè¿°äº†ä¸€æ¬¡Attachçš„æ•´ä½“æµç¨‹ï¼š</p>
<pre tabindex="0"><code>// async-profiler/src/jattach/jattach.c

int main(int argc, char** argv) {
    // è§£æå‘½ä»¤è¡Œå‚æ•°
    // æ£€æŸ¥euidä¸egid
    // ...

    if (!check_socket(nspid) &amp;&amp; !start_attach_mechanism(pid, nspid)) {
        perror(&quot;Could not start attach mechanism&quot;);
        return 1;
    }

    int fd = connect_socket(nspid);
    if (fd == -1) {
        perror(&quot;Could not connect to socket&quot;);
        return 1;
    }

    printf(&quot;Connected to remote JVM\n&quot;);
    if (!write_command(fd, argc - 2, argv + 2)) {
        perror(&quot;Error writing to socket&quot;);
        close(fd);
        return 1;
    }
    printf(&quot;Response code = &quot;);
    fflush(stdout);

    int result = read_response(fd);
    close(fd);
    return result;
}
</code></pre><p>å¿½ç•¥æ‰å‘½ä»¤è¡Œå‚æ•°è§£æä¸æ£€æŸ¥euidå’Œegidçš„è¿‡ç¨‹ã€‚jattaché¦–å…ˆè°ƒç”¨äº†check_socketå‡½æ•°è¿›è¡Œäº†â€œsocketæ£€æŸ¥ï¼Ÿâ€ï¼Œcheck_socketæºç å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>// async-profiler/src/jattach/jattach.c

// Check if remote JVM has already opened socket for Dynamic Attach
static int check_socket(int pid) {
    char path[MAX_PATH];
    snprintf(path, MAX_PATH, &quot;%s/.java_pid%d&quot;, get_temp_directory(), pid); // get_temp_directory()åœ¨Linuxä¸‹å›ºå®šè¿”å›&quot;/tmp&quot;
    struct stat stats;
    return stat(path, &amp;stats) == 0 &amp;&amp; S_ISSOCK(stats.st_mode);
}
</code></pre><p>æˆ‘ä»¬çŸ¥é“ï¼ŒUNIXæ“ä½œç³»ç»Ÿæä¾›äº†ä¸€ç§åŸºäºæ–‡ä»¶çš„Socketæ¥å£ï¼Œç§°ä¸ºâ€œUNIX Socketâ€ï¼ˆä¸€ç§å¸¸ç”¨çš„è¿›ç¨‹é—´é€šä¿¡æ–¹å¼ï¼‰ã€‚åœ¨è¯¥å‡½æ•°ä¸­ä½¿ç”¨S_ISSOCKå®æ¥åˆ¤æ–­è¯¥æ–‡ä»¶æ˜¯å¦è¢«ç»‘å®šåˆ°äº†UNIX Socketï¼Œå¦‚æ­¤çœ‹æ¥ï¼Œâ€œ/tmp/.java_pidâ€æ–‡ä»¶å¾ˆæœ‰å¯èƒ½å°±æ˜¯å¤–éƒ¨è¿›ç¨‹ä¸JVMè¿›ç¨‹é—´é€šä¿¡çš„æ¡¥æ¢ã€‚</p>
<p>æŸ¥é˜…å®˜æ–¹æ–‡æ¡£ï¼Œå¾—åˆ°å¦‚ä¸‹æè¿°ï¼š</p>
<blockquote>
<p>The attach listener thread then communicates with the source JVM in an OS dependent manner: - On Solaris, the Doors IPC mechanism is used. The door is attached to a file in the file system so that clients can access it. - On Linux, a Unix domain socket is used. This socket is bound to a file in the filesystem so that clients can access it. - On Windows, the created thread is given the name of a pipe which is served by the client. The result of the operations are written to this pipe by the target JVM.</p>
</blockquote>
<p>è¯æ˜äº†æˆ‘ä»¬çš„çŒœæƒ³æ˜¯æ­£ç¡®çš„ã€‚ç›®å‰ä¸ºæ­¢check_socketå‡½æ•°çš„ä½œç”¨å¾ˆå®¹æ˜“ç†è§£äº†ï¼šåˆ¤æ–­å¤–éƒ¨è¿›ç¨‹ä¸ç›®æ ‡JVMè¿›ç¨‹ä¹‹é—´æ˜¯å¦å·²ç»å»ºç«‹äº†UNIX Socketè¿æ¥ã€‚</p>
<p>å›åˆ°Mainå‡½æ•°ï¼Œåœ¨ä½¿ç”¨check_socketç¡®å®šè¿æ¥å°šæœªå»ºç«‹åï¼Œç´§æ¥ç€è°ƒç”¨start_attach_mechanismå‡½æ•°ï¼Œå‡½æ•°åå¾ˆç›´è§‚åœ°æè¿°äº†å®ƒçš„ä½œç”¨ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>// async-profiler/src/jattach/jattach.c

// Force remote JVM to start Attach listener.
// HotSpot will start Attach listener in response to SIGQUIT if it sees .attach_pid file
static int start_attach_mechanism(int pid, int nspid) {
    char path[MAX_PATH];
    snprintf(path, MAX_PATH, &quot;/proc/%d/cwd/.attach_pid%d&quot;, nspid, nspid);

    int fd = creat(path, 0660);
    if (fd == -1 || (close(fd) == 0 &amp;&amp; !check_file_owner(path))) {
        // Failed to create attach trigger in current directory. Retry in /tmp
        snprintf(path, MAX_PATH, &quot;%s/.attach_pid%d&quot;, get_temp_directory(), nspid);
        fd = creat(path, 0660);
        if (fd == -1) {
            return 0;
        }
        close(fd);
    }

    // We have to still use the host namespace pid here for the kill() call
    kill(pid, SIGQUIT);

    // Start with 20 ms sleep and increment delay each iteration
    struct timespec ts = {0, 20000000};
    int result;
    do {
        nanosleep(&amp;ts, NULL);
        result = check_socket(nspid);
    } while (!result &amp;&amp; (ts.tv_nsec += 20000000) &lt; 300000000);

    unlink(path);
    return result;
}
</code></pre><p>start_attach_mechanismå‡½æ•°é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªåä¸ºâ€œ/tmp/.attach_pidâ€çš„ç©ºæ–‡ä»¶ï¼Œç„¶åå‘ç›®æ ‡JVMè¿›ç¨‹å‘é€äº†ä¸€ä¸ªSIGQUITä¿¡å·ï¼Œè¿™ä¸ªä¿¡å·ä¼¼ä¹è§¦å‘äº†JVMçš„æŸç§æœºåˆ¶ï¼Ÿç´§æ¥ç€ï¼Œstart_attach_mechanismå‡½æ•°å¼€å§‹é™·å…¥äº†ä¸€ç§ç­‰å¾…ï¼Œæ¯20msè°ƒç”¨ä¸€æ¬¡check_socketå‡½æ•°æ£€æŸ¥è¿æ¥æ˜¯å¦è¢«å»ºç«‹ï¼Œå¦‚æœç­‰äº†300msè¿˜æ²¡æœ‰æˆåŠŸå°±æ”¾å¼ƒã€‚å‡½æ•°çš„æœ€åè°ƒç”¨Unlinkåˆ æ‰.attach_pidæ–‡ä»¶å¹¶è¿”å›ã€‚</p>
<p>å¦‚æ­¤çœ‹æ¥ï¼ŒHotSpotä¼¼ä¹æä¾›äº†ä¸€ç§ç‰¹æ®Šçš„æœºåˆ¶ï¼Œåªè¦ç»™å®ƒå‘é€ä¸€ä¸ªSIGQUITä¿¡å·ï¼Œå¹¶é¢„å…ˆå‡†å¤‡å¥½.attach_pidæ–‡ä»¶ï¼ŒHotSpotä¼šä¸»åŠ¨åˆ›å»ºä¸€ä¸ªåœ°å€ä¸ºâ€œ/tmp/.java_pidâ€çš„UNIX Socketï¼Œæ¥ä¸‹æ¥ä¸»åŠ¨Connectè¿™ä¸ªåœ°å€å³å¯å»ºç«‹è¿æ¥æ‰§è¡Œå‘½ä»¤ã€‚</p>
<p>æŸ¥é˜…æ–‡æ¡£ï¼Œå¾—åˆ°å¦‚ä¸‹æè¿°ï¼š</p>
<blockquote>
<p>Dynamic attach has an attach listener thread in the target JVM. This is a thread that is started when the first attach request occurs. On Linux and Solaris, the client creates a file named .attach_pid(pid) and sends a SIGQUIT to the target JVM process. The existence of this file causes the SIGQUIT handler in HotSpot to start the attach listener thread. On Windows, the client uses the Win32 CreateRemoteThread function to create a new thread in the target process.</p>
</blockquote>
<p>è¿™æ ·ä¸€æ¥å°±å¾ˆæ˜ç¡®äº†ï¼Œåœ¨Linuxä¸Šæˆ‘ä»¬åªéœ€åˆ›å»ºä¸€ä¸ªâ€œ/tmp/.attach_pidâ€æ–‡ä»¶ï¼Œå¹¶å‘ç›®æ ‡JVMè¿›ç¨‹å‘é€ä¸€ä¸ªSIGQUITä¿¡å·ï¼ŒHotSpotå°±ä¼šå¼€å§‹ç›‘å¬â€œ/tmp/.java_pidâ€åœ°å€ä¸Šçš„UNIX Socketï¼Œæ¥æ”¶å¹¶æ‰§è¡Œç›¸å…³Attachçš„å‘½ä»¤ã€‚è‡³äºä¸ºä»€ä¹ˆä¸€å®šè¦åˆ›å»º.attach_pidæ–‡ä»¶æ‰å¯ä»¥è§¦å‘Attach Listenerçš„åˆ›å»ºï¼Œç»æŸ¥é˜…èµ„æ–™ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸¤ç§è¯´æ³•ï¼šä¸€æ˜¯JVMä¸æ­¢æ¥æ”¶ä»å¤–éƒ¨Attachè¿›ç¨‹å‘é€çš„SIGQUITä¿¡å·ï¼Œå¿…é¡»é…åˆå¤–éƒ¨è¿›ç¨‹åˆ›å»ºçš„å¤–éƒ¨æ–‡ä»¶æ‰èƒ½ç¡®å®šè¿™æ˜¯ä¸€æ¬¡Attachè¯·æ±‚ï¼›äºŒæ˜¯ä¸ºäº†å®‰å…¨ã€‚</p>
<p>ç»§ç»­çœ‹jattachçš„æºç ï¼Œæœä¸å…¶ç„¶ï¼Œå®ƒè°ƒç”¨äº†connect_socketå‡½æ•°å¯¹â€œ/tmp/.java_pidâ€è¿›è¡Œè¿æ¥ï¼Œconnect_socketæºç å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>// async-profiler/src/jattach/jattach.c

// Connect to UNIX domain socket created by JVM for Dynamic Attach
static int connect_socket(int pid) {
    int fd = socket(PF_UNIX, SOCK_STREAM, 0);
    if (fd == -1) {
        return -1;
    }

    struct sockaddr_un addr;
    addr.sun_family = AF_UNIX;
    snprintf(addr.sun_path, sizeof(addr.sun_path), &quot;%s/.java_pid%d&quot;, get_temp_directory(), pid);

    if (connect(fd, (struct sockaddr*)&amp;addr, sizeof(addr)) == -1) {
        close(fd);
        return -1;
    }
    return fd;
}
</code></pre><p>ä¸€ä¸ªå¾ˆæ™®é€šçš„Socketåˆ›å»ºå‡½æ•°ï¼Œè¿”å›Socketæ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p>å›åˆ°Mainå‡½æ•°ï¼Œä¸»æµç¨‹ç´§æ¥ç€è°ƒç”¨write_commandå‡½æ•°å‘è¯¥Socketå†™å…¥äº†ä»å‘½ä»¤è¡Œä¼ è¿›æ¥çš„å‚æ•°ï¼Œå¹¶ä¸”è°ƒç”¨read_responseå‡½æ•°æ¥æ”¶ä»ç›®æ ‡JVMè¿›ç¨‹è¿”å›çš„æ•°æ®ã€‚ä¸¤ä¸ªå¾ˆå¸¸è§çš„Socketè¯»å†™å‡½æ•°ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>// async-profiler/src/jattach/jattach.c

// Send command with arguments to socket
static int write_command(int fd, int argc, char** argv) {
    // Protocol version
    if (write(fd, &quot;1&quot;, 2) &lt;= 0) {
        return 0;
    }

    int i;
    for (i = 0; i &lt; 4; i++) {
        const char* arg = i &lt; argc ? argv[i] : &quot;&quot;;
        if (write(fd, arg, strlen(arg) + 1) &lt;= 0) {
            return 0;
        }
    }
    return 1;
}

// Mirror response from remote JVM to stdout
static int read_response(int fd) {
    char buf[8192];
    ssize_t bytes = read(fd, buf, sizeof(buf) - 1);
    if (bytes &lt;= 0) {
        perror(&quot;Error reading response&quot;);
        return 1;
    }

    // First line of response is the command result code
    buf[bytes] = 0;
    int result = atoi(buf);

    do {
        fwrite(buf, 1, bytes, stdout);
        bytes = read(fd, buf, sizeof(buf));
    } while (bytes &gt; 0);
    return result;
}
</code></pre><p>æµè§ˆwrite_commandå‡½æ•°å°±å¯çŸ¥å¤–éƒ¨è¿›ç¨‹ä¸ç›®æ ‡JVMè¿›ç¨‹ä¹‹é—´å‘é€çš„æ•°æ®æ ¼å¼ç›¸å½“ç®€å•ï¼ŒåŸºæœ¬å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>&lt;PROTOCOL VERSION&gt;\0&lt;COMMAND&gt;\0&lt;ARG1&gt;\0&lt;ARG2&gt;\0&lt;ARG3&gt;\0
</code></pre><p>ä»¥å…ˆå‰æˆ‘ä»¬ä½¿ç”¨çš„Loadå‘½ä»¤ä¸ºä¾‹ï¼Œå‘é€ç»™HotSpotæ—¶æ ¼å¼å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>1\0load\0/absolute/path/to/agent/libagent.so\0true\0\0
</code></pre><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†å¦‚ä½•æ‰‹å·¥å¯¹JVMè¿›ç¨‹ç›´æ¥è¿›è¡ŒAttachã€‚</p>
<h3 id="attachè¡¥å……ä»‹ç»">Attachè¡¥å……ä»‹ç»</h3>
<p>Loadå‘½ä»¤ä»…ä»…æ˜¯HotSpotæ‰€æ”¯æŒçš„è¯¸å¤šå‘½ä»¤ä¸­çš„ä¸€ç§ï¼Œç”¨äºåŠ¨æ€åŠ è½½åŸºäºJVMTIçš„Agentï¼Œå®Œæ•´çš„å‘½ä»¤è¡¨å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>static AttachOperationFunctionInfo funcs[] = {
  { &quot;agentProperties&quot;,  get_agent_properties },
  { &quot;datadump&quot;,         data_dump },
  { &quot;dumpheap&quot;,         dump_heap },
  { &quot;load&quot;,             JvmtiExport::load_agent_library },
  { &quot;properties&quot;,       get_system_properties },
  { &quot;threaddump&quot;,       thread_dump },
  { &quot;inspectheap&quot;,      heap_inspection },
  { &quot;setflag&quot;,          set_flag },
  { &quot;printflag&quot;,        print_flag },
  { &quot;jcmd&quot;,             jcmd },
  { NULL,               NULL }
};
</code></pre><p>è¯»è€…å¯ä»¥å°è¯•ä¸‹threaddumpå‘½ä»¤ï¼Œç„¶åå¯¹ç›¸åŒçš„è¿›ç¨‹è¿›è¡Œjstackï¼Œå¯¹æ¯”è§‚å¯Ÿè¾“å‡ºï¼Œå…¶å®æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œå…¶å®ƒå‘½ä»¤å¤§å®¶å¯ä»¥è‡ªè¡Œè¿›è¡Œæ¢ç´¢ã€‚</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>æ€»çš„æ¥è¯´ï¼Œå–„ç”¨å„ç±»Profileræ˜¯æå‡æ€§èƒ½ä¼˜åŒ–æ•ˆç‡çš„ä¸€æŠŠåˆ©å™¨ï¼Œäº†è§£Profileræœ¬èº«çš„å®ç°åŸç†æ›´èƒ½å¸®åŠ©æˆ‘ä»¬é¿å…å¯¹å·¥å…·çš„å„ç§è¯¯ç”¨ã€‚CPU Profileræ‰€ä¾èµ–çš„Attachã€JVMTIã€Instrumentationã€JMXç­‰çš†æ˜¯JVMå¹³å°æ¯”è¾ƒé€šç”¨çš„æŠ€æœ¯ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å»å®ç°Memory Profilerã€Thread Profilerã€GC Analyzerç­‰å·¥å…·ä¹Ÿæ²¡æœ‰æƒ³è±¡ä¸­é‚£ä¹ˆç¥ç§˜å’Œå¤æ‚äº†ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><a href="https://docs.oracle.com/en/java/javase/12/docs/specs/jvmti.html">JVM Tool Interface</a></li>
<li><a href="https://psy-lob-saw.blogspot.com/2016/06/the-pros-and-cons-of-agct.html">The Pros and Cons of AsyncGetCallTrace Profilers</a></li>
<li><a href="https://psy-lob-saw.blogspot.com/2016/02/why-most-sampling-java-profilers-are.html">Why (Most) Sampling Java Profilers Are Fucking Terrible</a></li>
<li><a href="https://psy-lob-saw.blogspot.com/2015/12/safepoints.html">Safepoints: Meaning, Side Effects and Overheads</a></li>
<li><a href="https://openjdk.java.net/groups/hotspot/docs/Serviceability.html">Serviceability in HotSpot</a></li>
<li><a href="https://www.ruanyifeng.com/blog/2017/09/flame-graph.html">å¦‚ä½•è¯»æ‡‚ç«ç„°å›¾ï¼Ÿ</a></li>
<li><a href="https://blog.jetbrains.com/idea/2018/09/intellij-idea-2018-3-eap-git-submodules-jvm-profiler-macos-and-linux-and-more/">IntelliJ IDEA 2018.3 EAP: Git Submodules, JVM Profiler (macOS and Linux) and more</a></li>
</ul>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/articles/mysql-%E6%97%A5%E5%BF%97%E8%AF%A6%E8%A7%A3.md/"><span></span></a>
    </div>
    <div class="next">
        
        <a href="/documents/articles/java%E4%B8%AD%E7%9A%84spi.md/"><span></span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 28280 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>