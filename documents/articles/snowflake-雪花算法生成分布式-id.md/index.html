<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title> | Yipsen Ye</title>
<meta name="description" content="SnowFlake é›ªèŠ±ç®—æ³•åŸºæœ¬æ¦‚å¿µ SnowFlake é›ªèŠ±ç®—æ³•æ˜¯ Twitter å¼€æºçš„åˆ†å¸ƒå¼å”¯ä¸€ ID ç”Ÿæˆç®—æ³•ï¼Œå…¶å…·æœ‰ç®€æ´ã€é«˜æ€§èƒ½ã€ä½å»¶è¿Ÿã€ID æŒ‰æ—¶é—´è¶‹åŠ¿æœ‰åºç­‰ç‰¹ç‚¹ã€‚å¦‚é‡‡ç”¨ 12 ä½åºåˆ—å·ï¼Œåˆ™ç†è®ºæ”¯æŒæ¯æ¯«ç§’ç”Ÿæˆ 4096 ä¸ªä¸åŒæ•°å­—ï¼Œèƒ½å¤Ÿæ»¡è¶³ç»å¤§å¤šæ•°é«˜å¹¶å‘åœºæ™¯ä¸‹çš„äº’è”ç½‘åº”ç”¨ã€‚SnowFlake é›ªèŠ±ç®—æ³•èƒ½ä¿è¯åœ¨ datacenterId å’Œ workerId å”¯ä¸€çš„æƒ…å†µä¸‹ä¸ä¼šç”Ÿæˆé‡å¤å€¼ã€‚å¦‚æœå•ä½æ¯«ç§’å¹¶å‘é‡ &amp;gt;4096ï¼Œå°†ä¼šç­‰åˆ°ä¸‹ä¸€æ¯«ç§’ç»§ç»­ç”Ÿæˆ IDã€‚å› æ­¤å¦‚æœå•å°æœåŠ¡å™¨å¹¶å‘é‡å¤§äº 4096/msï¼Œæ˜¯æ—¶å€™è€ƒè™‘è‡ªç ”ç®—æ³•äº†ã€‚
SnowFlake çš„ç»“æ„å¦‚ä¸‹ï¼š
0 - 0000000000 0000000000 0000000000 0000000000 0 - 00000 - 00000 - 000000000000 æ€»å…± 64 ä¸ª bit ä½ï¼Œå¯¹åº”äº Java åŸºæœ¬æ•°æ®ç±»å‹çš„ Long ç±»å‹ 1 ä½ç¬¦å·ä½ï¼Œæ­£æ•°æ˜¯ 0ï¼Œè´Ÿæ•°æ˜¯ 1ï¼Œid ä¸€èˆ¬æ˜¯æ­£æ•°ï¼Œå› æ­¤æœ€é«˜ä½æ˜¯ 0 41 ä½æ—¶é—´æˆ³ï¼ˆæ¯«ç§’çº§ï¼‰ï¼Œ41 ä½æ—¶é—´æˆ³ä¸æ˜¯å­˜å‚¨å½“å‰æ—¶é—´çš„æ—¶é—´æˆ³ï¼Œè€Œæ˜¯å­˜å‚¨æ—¶é—´æˆ³å·®å€¼ï¼ˆå½“å‰æ—¶é—´æˆ³ - å¼€å§‹æ—¶é—´æˆ³ï¼‰ã€‚å¼€å§‹æ—¶é—´æˆ³ä¸€èˆ¬æ˜¯ Id ç”Ÿæˆå™¨å¼€å§‹æŠ•å…¥ä½¿ç”¨çš„æ—¶é—´ï¼Œå¯åœ¨ç¨‹åºä¸­æŒ‡å®šã€‚
 41 ä½æ—¶é—´æˆ³ï¼Œå¯ä»¥ä½¿ç”¨ 69 å¹´ï¼Œå¹´æ•° = (1L &amp;laquo; 41) / (1000L * 60 * 60 * 24 * 365) â‰ˆ 69 10 ä½æœºå™¨ä½ï¼Œå¯ä»¥éƒ¨ç½² 1024 ä¸ªèŠ‚ç‚¹ï¼ŒåŒ…æ‹¬ 5 ä½ datacenterId å’Œ 5 ä½ workerId 12 ä½åºåˆ—å·ï¼Œæ¯«ç§’å†…è®¡æ•°ï¼Œæ”¯æŒæ¯ä¸ªèŠ‚ç‚¹æ¯æ¯«ç§’äº§ç”Ÿ 4096 ä¸ªä¸é‡å¤ ID åºå·  åŸºäºåŸç‰ˆç®—æ³•çš„æ”¹è¿› å¢åŠ æ¯«ç§’å†…åˆå§‹ id éšæœºç”Ÿæˆ æ¯«ç§’å†…åˆå§‹ id éšæœºç”Ÿæˆå¯ä»¥æœ‰æ•ˆé¿å…é€†å‘å·¥ç¨‹å¯¼è‡´ id çš„å¯æ¨æµ‹æ€§ã€‚å…·ä½“å¼€å‘æ—¶é€šè¿‡å¯é…ç½®å‚æ•°å†³å®šæ˜¯å¦å¯ç”¨å•ä½æ¯«ç§’å†…éšæœºç”Ÿæˆèµ·å§‹ IDã€‚éšæœºç”Ÿæˆçš„èµ·å§‹ ID å¯èƒ½å¾ˆå¤§ï¼Œä¼šå¾ˆå¿«åˆ°è¾¾å•ä½æ¯«ç§’å†…çš„æœ€å¤§å€¼ï¼Œæ¯”å¦‚ 4095ï¼ˆ12 ä½åºåˆ—å·æƒ…å†µä¸‹ï¼‰ï¼Œæ‰€ä»¥éœ€è¦å¯¹ 4095 å¤„ç†ï¼Œæ¯”å¦‚å–æ¨¡ã€æˆ–è€…å’ŒäºŒè¿›åˆ¶ä½æ•°&amp;amp;è¿ç®— å¾ªç¯ä½¿ç”¨å•ä½æ¯«ç§’å†…çš„å¯ç”¨æ•°å­—ï¼Œé¿å…æµªè´¹ã€‚">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><article class="post-block">
        <h1 class="post-title"></h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;0001-01-01 00:00:00</span></div></div>
        <div class="post-content">
            <h3 id="snowflake-é›ªèŠ±ç®—æ³•åŸºæœ¬æ¦‚å¿µ">SnowFlake é›ªèŠ±ç®—æ³•åŸºæœ¬æ¦‚å¿µ</h3>
<p>SnowFlake é›ªèŠ±ç®—æ³•æ˜¯ Twitter å¼€æºçš„åˆ†å¸ƒå¼å”¯ä¸€ ID ç”Ÿæˆç®—æ³•ï¼Œå…¶å…·æœ‰ç®€æ´ã€é«˜æ€§èƒ½ã€ä½å»¶è¿Ÿã€ID æŒ‰æ—¶é—´è¶‹åŠ¿æœ‰åºç­‰ç‰¹ç‚¹ã€‚å¦‚é‡‡ç”¨ 12 ä½åºåˆ—å·ï¼Œåˆ™ç†è®ºæ”¯æŒæ¯æ¯«ç§’ç”Ÿæˆ 4096 ä¸ªä¸åŒæ•°å­—ï¼Œèƒ½å¤Ÿæ»¡è¶³ç»å¤§å¤šæ•°é«˜å¹¶å‘åœºæ™¯ä¸‹çš„äº’è”ç½‘åº”ç”¨ã€‚SnowFlake é›ªèŠ±ç®—æ³•èƒ½ä¿è¯åœ¨ datacenterId å’Œ workerId å”¯ä¸€çš„æƒ…å†µä¸‹ä¸ä¼šç”Ÿæˆé‡å¤å€¼ã€‚å¦‚æœå•ä½æ¯«ç§’å¹¶å‘é‡ &gt;4096ï¼Œå°†ä¼šç­‰åˆ°ä¸‹ä¸€æ¯«ç§’ç»§ç»­ç”Ÿæˆ IDã€‚å› æ­¤å¦‚æœå•å°æœåŠ¡å™¨å¹¶å‘é‡å¤§äº 4096/msï¼Œæ˜¯æ—¶å€™è€ƒè™‘è‡ªç ”ç®—æ³•äº†ã€‚</p>
<p>SnowFlake çš„ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/50ba2570-e86c-11ea-8115-8d7d715b7847" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<pre tabindex="0"><code>0 - 0000000000 0000000000 0000000000 0000000000 0 - 00000 - 00000 - 000000000000
</code></pre><p>æ€»å…± 64 ä¸ª bit ä½ï¼Œå¯¹åº”äº Java åŸºæœ¬æ•°æ®ç±»å‹çš„ Long ç±»å‹ 1 ä½ç¬¦å·ä½ï¼Œæ­£æ•°æ˜¯ 0ï¼Œè´Ÿæ•°æ˜¯ 1ï¼Œid ä¸€èˆ¬æ˜¯æ­£æ•°ï¼Œå› æ­¤æœ€é«˜ä½æ˜¯ 0 41 ä½æ—¶é—´æˆ³ï¼ˆæ¯«ç§’çº§ï¼‰ï¼Œ41 ä½æ—¶é—´æˆ³ä¸æ˜¯å­˜å‚¨å½“å‰æ—¶é—´çš„æ—¶é—´æˆ³ï¼Œè€Œæ˜¯å­˜å‚¨æ—¶é—´æˆ³å·®å€¼ï¼ˆå½“å‰æ—¶é—´æˆ³ - å¼€å§‹æ—¶é—´æˆ³ï¼‰ã€‚å¼€å§‹æ—¶é—´æˆ³ä¸€èˆ¬æ˜¯ Id ç”Ÿæˆå™¨å¼€å§‹æŠ•å…¥ä½¿ç”¨çš„æ—¶é—´ï¼Œå¯åœ¨ç¨‹åºä¸­æŒ‡å®šã€‚</p>
<ul>
<li>41 ä½æ—¶é—´æˆ³ï¼Œå¯ä»¥ä½¿ç”¨ 69 å¹´ï¼Œå¹´æ•° = (1L &laquo; 41) / (1000L * 60 * 60 * 24 * 365) â‰ˆ 69</li>
<li>10 ä½æœºå™¨ä½ï¼Œå¯ä»¥éƒ¨ç½² 1024 ä¸ªèŠ‚ç‚¹ï¼ŒåŒ…æ‹¬ 5 ä½ datacenterId å’Œ 5 ä½ workerId</li>
<li>12 ä½åºåˆ—å·ï¼Œæ¯«ç§’å†…è®¡æ•°ï¼Œæ”¯æŒæ¯ä¸ªèŠ‚ç‚¹æ¯æ¯«ç§’äº§ç”Ÿ 4096 ä¸ªä¸é‡å¤ ID åºå·</li>
</ul>
<h3 id="åŸºäºåŸç‰ˆç®—æ³•çš„æ”¹è¿›">åŸºäºåŸç‰ˆç®—æ³•çš„æ”¹è¿›</h3>
<h4 id="å¢åŠ æ¯«ç§’å†…åˆå§‹-id-éšæœºç”Ÿæˆ">å¢åŠ æ¯«ç§’å†…åˆå§‹ id éšæœºç”Ÿæˆ</h4>
<p>æ¯«ç§’å†…åˆå§‹ id éšæœºç”Ÿæˆå¯ä»¥æœ‰æ•ˆé¿å…é€†å‘å·¥ç¨‹å¯¼è‡´ id çš„å¯æ¨æµ‹æ€§ã€‚å…·ä½“å¼€å‘æ—¶é€šè¿‡å¯é…ç½®å‚æ•°å†³å®šæ˜¯å¦å¯ç”¨å•ä½æ¯«ç§’å†…éšæœºç”Ÿæˆèµ·å§‹ IDã€‚éšæœºç”Ÿæˆçš„èµ·å§‹ ID å¯èƒ½å¾ˆå¤§ï¼Œä¼šå¾ˆå¿«åˆ°è¾¾å•ä½æ¯«ç§’å†…çš„æœ€å¤§å€¼ï¼Œæ¯”å¦‚ 4095ï¼ˆ12 ä½åºåˆ—å·æƒ…å†µä¸‹ï¼‰ï¼Œæ‰€ä»¥éœ€è¦å¯¹ 4095 å¤„ç†ï¼Œæ¯”å¦‚å–æ¨¡ã€æˆ–è€…å’ŒäºŒè¿›åˆ¶ä½æ•°&amp;è¿ç®— å¾ªç¯ä½¿ç”¨å•ä½æ¯«ç§’å†…çš„å¯ç”¨æ•°å­—ï¼Œé¿å…æµªè´¹ã€‚</p>
<h4 id="å¢åŠ -workeriddatacenterid-è‡ªåŠ¨ç”Ÿæˆ">å¢åŠ  workerIdã€datacenterId è‡ªåŠ¨ç”Ÿæˆ</h4>
<p>ä¸ºäº†èƒ½å¤Ÿç®€å•å¿«æ·åœ°ä½¿ç”¨ SnowFlake ç®—æ³•ï¼Œå¯ä»¥åŸºäº mac\hostip\jvmid ç­‰ä¿¡æ¯è‡ªåŠ¨ç”Ÿæˆ workerIdã€datacenterIdï¼Œå°½æœ€å¤§å¯èƒ½ä¸é‡å¤ã€‚è¦å®Œå…¨ä¿è¯ workerIdã€datacenterId çš„å”¯ä¸€æ€§è¿˜å¾—å€ŸåŠ©ç¬¬ä¸‰æ–¹å·¥å…·ï¼Œæ¯”å¦‚ Redisã€ZooKeeper ç­‰å¼€æºä¸­é—´ä»¶ã€‚</p>
<p>åœ¨å•ä¸ªæ•°æ®ä¸­å¿ƒæœºå™¨æ•°è¿œ &lt;32 å°ã€æ•°æ®ä¸­å¿ƒæ•°è¿œ &lt;32 ä¸ªæ—¶ï¼Œä½¿ç”¨æœ¬æ–‡ä»‹ç»çš„æ–¹æ³•åœ¨ä¸åŒæœºå™¨ä¸Šç”Ÿæˆå®Œå…¨ç›¸åŒçš„ workerIdã€datacenterId çš„æ¦‚ç‡æä½ã€‚</p>
<p>å…·ä½“å¼€å‘æ—¶ä¹Ÿä¿ç•™åŸç”Ÿæ¥å£ï¼Œè®©ä½¿ç”¨è€…ï¼ˆæ¯”å¦‚ä¸šåŠ¡ç³»ç»Ÿï¼‰ä¼ å…¥è‡ªè¡Œç”Ÿæˆçš„ workerIdã€datacenterId ï¼Œè°ƒç”¨æ–¹å¯ä»¥å€ŸåŠ© Redisã€ZK ç­‰ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶è‡ªè¡Œä¿è¯æœºå™¨å·å’Œæ•°æ®ä¸­å¿ƒå·å”¯ä¸€ã€‚</p>
<h4 id="æ—¶é’Ÿå›æ‹¨å¤„ç†">æ—¶é’Ÿå›æ‹¨å¤„ç†</h4>
<p><strong>è¿è¡Œæ—¶</strong></p>
<p>è‹¥åå·®åœ¨æŒ‡å®šæ—¶é—´ï¼ˆå¯é…ç½®ï¼‰ä»¥å†…ï¼Œåˆ™ç­‰å¾… 2 å€çš„æ—¶é—´å·®åå¼€å§‹ç”Ÿæˆï¼›è‹¥ä¸¤è€…åå·®å¤§äºæŸä¸ªè®¾å®šçš„æ—¶é—´é˜ˆå€¼ï¼ˆå¯é…ç½®ï¼‰ï¼Œåˆ™ç«‹å³æŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…é˜»å¡ã€‚</p>
<p><strong>ç³»ç»Ÿé‡å¯æ—¶</strong></p>
<p>jvmId å˜åŒ–ï¼ŒåŸºäº mac\hostip\jvmid ç”Ÿæˆçš„æœºå™¨ WorkerId å˜åŒ–ï¼Œå³ä½¿åœ¨æ—¶é’Ÿå›æ‹¨æ—¶ä¹Ÿå¯ä»¥å°½æœ€å¤§å¯èƒ½é¿å…ç”Ÿæˆé‡å¤ idã€‚</p>
<p>å½“ç„¶ä¹Ÿå¯ä»¥å€ŸåŠ©ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶å®ç°æ—¶é—´å›æ‹¨å¤„ç†ï¼Œæ¯”å¦‚ç®—æ³•è¿è¡Œæ—¶å°† lastTimestamp å†™å…¥ redisï¼Œç³»ç»Ÿå¯åŠ¨æ—¶è¯»å– redis å­˜å‚¨çš„ lastTimestamp å€¼å’Œå½“å‰æ—¶é—´æ¯”è¾ƒã€‚è‹¥å½“å‰æ—¶é—´æˆ³ &lt;lastTimestampï¼Œåˆ™å¯åŠ¨å¤±è´¥ã€‚</p>
<h4 id="å­—ç¬¦ä¸²ä½æ•°è¡¥é½">å­—ç¬¦ä¸²ä½æ•°è¡¥é½</h4>
<p>æ­£æ•°çš„ Long ç±»å‹è½¬æ¢ä¸º 10 è¿›åˆ¶æ•°èŒƒå›´ï¼š0~9,223,372,036,854,775,807ï¼Œå¯è§é•¿åº¦ä¸ºæœ€å¤š 19 ä½ï¼Œå› æ­¤ SnowFlake ç®—æ³•ç”Ÿæˆçš„ id ä½æ•°ç»Ÿä¸€è®¾å®šä¸º 19 ä½ä¸ºå®œã€‚</p>
<p>ä¸€èˆ¬åˆšå¼€å§‹ä½¿ç”¨æ—¶ä¸º 18 ä½ï¼Œä½†æ—¶é—´è·ç¦»èµ·å§‹æ—¶é—´è¶…è¿‡ä¸€å®šå€¼åï¼Œä¼šå˜ä¸º 19 ä½ã€‚</p>
<p>æ¶ˆè€—å®Œ 18 ä½æ‰€éœ€çš„æ—¶é—´ï¼š1*10^18 / (3600 * 24 * 365 * 1000 * 2^22) â‰ˆ 7.56 å¹´ï¼Œå³æ—¶é—´å·®è¶…è¿‡ 7.56 å¹´ï¼Œå°±ä¼šè¾¾åˆ° 19 ä½ã€‚</p>
<p>å› æ­¤æˆ‘ä»¬è®¾ç½®åˆå§‹æ—¶é—´ &lt; å½“å‰æ—¶é—´ - 7.56 å¹´ï¼Œä¿è¯é›ªèŠ±ç®—æ³•ç”Ÿæˆçš„ id ä½æ•°ç»Ÿä¸€ä¸º 19 ä½ã€‚</p>
<h3 id="æ¥å£è®¾è®¡">æ¥å£è®¾è®¡</h3>
<h4 id="åŸå§‹ç®—æ³•æ¥å£">åŸå§‹ç®—æ³•æ¥å£</h4>
<p>ä½¿ç”¨è€…å¯ä»¥ä¼ å…¥è‡ªè¡Œç”Ÿæˆçš„ workerIdã€datacenterIdï¼ŒåŸæ±åŸå‘³çš„ SnowFlakeã€‚</p>
<h4 id="è‡ªåŠ¨ç”Ÿæˆ-workeriddatacenterid-æ¥å£">è‡ªåŠ¨ç”Ÿæˆ workerIdã€datacenterId æ¥å£</h4>
<p>ç®€åŒ– SnowFlake çš„ä½¿ç”¨ï¼Œä¸ä¿è¯ 100%ä¸é‡å¤ï¼Œå°½æœ€å¤§æ¦‚ç‡ä¸é‡å¤ã€‚</p>
<h4 id="ä¸šåŠ¡å®šåˆ¶æ¥å£">ä¸šåŠ¡å®šåˆ¶æ¥å£</h4>
<p>è°ƒæ•´é›ªèŠ±ç®—æ³•çš„ bit ä½ï¼Œå³å¯ä»¥æ ¹æ®ä¸šåŠ¡å¯¹ 64 ä¸ª bit ä½ä½œå‡ºè°ƒæ•´ã€‚</p>
<p>æœ‰çš„åœºæ™¯ä¸‹æˆ‘ä»¬éœ€è¦å®šåˆ¶é›ªèŠ±ç®—æ³•ï¼Œæ¯”å¦‚ç”Ÿæˆ 15 ä½çš„ 10 è¿›åˆ¶æ•°å­—ã€‚</p>
<p>ç”Ÿæˆ 15 ä½åè¿›åˆ¶æ•°å­—éœ€è¦ 53 ä½äºŒè¿›åˆ¶æ•°ï¼Œé™¤äº† 41 ä½æ—¶é—´æˆ³ + 1 ä½ç¬¦å·ä½ä¹‹å¤–ï¼Œè¿˜æœ‰ 11 ä½å¯ä»¥ç”¨ï¼Œå¯ä»¥é‡‡ç”¨ 2 + 3 + 6ï¼ˆdatacenterId + workerId + seqIdï¼‰ã€‚</p>
<p>15 ä½çš„åœºæ™¯ä¸‹ç†è®ºæ”¯æŒå•ä½æ¯«ç§’ 64 ç¬”ï¼Œæ¯ç§’ 64000 ç¬”ä¸é‡å¤ï¼Œä»ä¸­å°è§„æ¨¡ä¸šåŠ¡é‡æ¥çœ‹ï¼Œ tps&gt;64000 çš„æ€§èƒ½ç“¶é¢ˆçŸ­æœŸä¸å¤§å¯èƒ½å‡ºç°ã€‚</p>
<h4 id="è®¢å•å·ç”Ÿæˆ">è®¢å•å·ç”Ÿæˆ</h4>
<p>ä¸šåŠ¡ç³»ç»Ÿä½¿ç”¨åŸºäº snowflake çš„ ID ç”Ÿæˆå™¨ï¼Œæ¯”å¦‚æ‹¼æ¥ä¸€äº›ä¸šåŠ¡å­—æ®µï¼Œæ¯”å¦‚ç”Ÿæˆè®¢å•å·æ—¶ä¼ å…¥ pid\appId\æ—¶é—´æˆ³ç­‰ã€‚</p>
<h3 id="ç®—æ³•å®ç°">ç®—æ³•å®ç°</h3>
<p>æœ¬æ–‡æä¾› Java ç‰ˆçš„ç®—æ³•å®ç°ï¼Œæ¬¢è¿è¯„è®ºåŒºç•™è¨€æ‰¹è¯„æŒ‡æ­£ã€‚</p>
<pre tabindex="0"><code>import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.lang.management.ManagementFactory;
import java.net.InetAddress;
import java.net.NetworkInterface;
import java.util.Date;
import java.util.concurrent.ThreadLocalRandom;

/**
 * @author NiaoGe
 * &lt;p&gt;
 * é›ªèŠ±ç®—æ³•ç”Ÿæˆå”¯ä¸€ id,å‚è€ƒå¼€æºé¡¹ç›®ï¼š
 * https://gitee.com/yu120/sequence
 * https://apidoc.gitee.com/loolly/hutool/cn/hutool/core/util/IdUtil.html
 * &lt;/p&gt;
 */

public class IdGenerator {
    private static final Logger logger = LoggerFactory.getLogger(IdGenerator.class);

    //å·¥ä½œæœºå™¨ id
    private long workerId;
    //æ•°æ®ä¸­å¿ƒ id
    private long datacenterId;
    //åºåˆ—å·
    private long sequence = 0L;

    //åŸºå‡†æ—¶é—´ï¼Œä¸€èˆ¬å–ç³»ç»Ÿçš„æœ€è¿‘æ—¶é—´ï¼ˆä¸€æ—¦ç¡®å®šä¸èƒ½å˜åŠ¨ï¼‰
    private long twepoch;

    private long workerIdBits;
    private long datacenterIdBits;
    private long maxWorkerId;
    private long maxDatacenterId;

    //æ¯«ç§’å†…è‡ªå¢ä½æ•°
    private long sequenceBits;
    //ä½ä¸è¿ç®—ä¿è¯æ¯«ç§’å†… Id èŒƒå›´
    private long sequenceMask;

    //å·¥ä½œæœºå™¨ id éœ€è¦å·¦ç§»çš„ä½æ•°
    private long workerIdShift;
    //æ•°æ®ä¸­å¿ƒ id éœ€è¦å·¦ç§»ä½æ•°
    private long datacenterIdShift;
    //æ—¶é—´æˆ³éœ€è¦å·¦ç§»ä½æ•°
    private long timestampLeftShift;

    //ä¸Šæ¬¡ç”Ÿæˆ id çš„æ—¶é—´æˆ³ï¼Œåˆå§‹å€¼ä¸ºè´Ÿæ•°
    private long lastTimestamp = -1L;

    //true è¡¨ç¤ºæ¯«ç§’å†…åˆå§‹åºåˆ—é‡‡ç”¨éšæœºå€¼
    private boolean randomSequence;
    //éšæœºåˆå§‹åºåˆ—è®¡æ•°å™¨
    private long count = 0L;

    //å…è®¸æ—¶é’Ÿå›æ‹¨çš„æ¯«ç§’æ•°
    private long timeOffset;

    private final ThreadLocalRandom tlr = ThreadLocalRandom.current();

    /**
     * æ— å‚æ„é€ å™¨ï¼Œè‡ªåŠ¨ç”Ÿæˆ workerId/datacenterId
     */
    public IdGenerator() {
        this(false, 10, null, 5L, 5L, 12L);
    }

    /**
     * æœ‰å‚æ„é€ å™¨,è°ƒç”¨è€…è‡ªè¡Œä¿è¯æ•°æ®ä¸­å¿ƒ ID+æœºå™¨ ID çš„å”¯ä¸€æ€§
     * æ ‡å‡† snowflake å®ç°
     *
     * @param workerId     å·¥ä½œæœºå™¨ ID
     * @param datacenterId æ•°æ®ä¸­å¿ƒ ID
     */
    public IdGenerator(long workerId, long datacenterId) {
        this(workerId, datacenterId, false, 10, null, 5L, 5L, 12L);
    }

    /**
     * @param randomSequence   true è¡¨ç¤ºæ¯æ¯«ç§’å†…èµ·å§‹åºå·ä½¿ç”¨éšæœºå€¼
     * @param timeOffset       å…è®¸æ—¶é—´å›æ‹¨çš„æ¯«ç§’æ•°
     * @param epochDate        åŸºå‡†æ—¶é—´
     * @param workerIdBits     workerId ä½æ•°
     * @param datacenterIdBits datacenterId ä½æ•°
     * @param sequenceBits     sequence ä½æ•°
     */
    public IdGenerator(boolean randomSequence, long timeOffset, Date epochDate, long workerIdBits, long datacenterIdBits, long sequenceBits) {
        if (null != epochDate) {
            this.twepoch = epochDate.getTime();
        } else {
            // 2012/12/12 23:59:59 GMT
            this.twepoch = 1355327999000L;
        }

        this.workerIdBits = workerIdBits;
        this.datacenterIdBits = datacenterIdBits;
        this.maxWorkerId = -1L ^ (-1L &lt;&lt; workerIdBits);
        this.maxDatacenterId = -1L ^ (-1L &lt;&lt; datacenterIdBits);

        this.sequenceBits = sequenceBits;
        this.sequenceMask = -1L ^ (-1L &lt;&lt; sequenceBits);

        this.workerIdShift = sequenceBits;
        this.datacenterIdShift = sequenceBits + workerIdBits;
        this.timestampLeftShift = sequenceBits + workerIdBits + datacenterIdBits;

        this.datacenterId = getDatacenterId(maxDatacenterId);
        this.workerId = getMaxWorkerId(datacenterId, maxWorkerId);
        this.randomSequence = randomSequence;
        this.timeOffset = timeOffset;
        String initialInfo = String.format(&quot;worker starting. timestamp left shift %d, datacenter id bits %d, worker id bits %d, sequence bits %d, datacenterid  %d, workerid %d&quot;,
                timestampLeftShift, datacenterIdBits, workerIdBits, sequenceBits, datacenterId, workerId);
        logger.info(initialInfo);
    }

    /**
     * è‡ªå®šä¹‰ workerId+datacenterId+å…¶å®ƒåˆå§‹é…ç½®
     * è°ƒæ•´ workerIdã€datacenterIdã€sequence ä½æ•°å®šåˆ¶é›ªèŠ±ç®—æ³•,æ§åˆ¶ç”Ÿæˆçš„ Id çš„ä½æ•°
     *
     * @param workerId         å·¥ä½œæœºå™¨ ID
     * @param datacenterId     æ•°æ®ä¸­å¿ƒ ID
     * @param randomSequence   true è¡¨ç¤ºæ¯æ¯«ç§’å†…èµ·å§‹åºå·ä½¿ç”¨éšæœºå€¼
     * @param timeOffset       å…è®¸æ—¶é—´å›æ‹¨çš„æ¯«ç§’æ•°
     * @param epochDate        åŸºå‡†æ—¶é—´
     * @param workerIdBits     workerId ä½æ•°
     * @param datacenterIdBits datacenterId ä½æ•°
     * @param sequenceBits     sequence ä½æ•°
     */
    public IdGenerator(long workerId, long datacenterId, boolean randomSequence, long timeOffset, Date epochDate, long workerIdBits, long datacenterIdBits, long sequenceBits) {
        this.workerIdBits = workerIdBits;
        this.datacenterIdBits = datacenterIdBits;
        this.maxWorkerId = -1L ^ (-1L &lt;&lt; workerIdBits);
        this.maxDatacenterId = -1L ^ (-1L &lt;&lt; datacenterIdBits);

        if (workerId &gt; maxWorkerId || workerId &lt; 0) {
            throw new IllegalArgumentException(String.format(&quot;worker Id can't be greater than %d or less than 0\r\n&quot;, maxWorkerId));
        }
        if (datacenterId &gt; maxDatacenterId || datacenterId &lt; 0) {
            throw new IllegalArgumentException(String.format(&quot;datacenter Id can't be greater than %d or less than 0\r\n&quot;, maxDatacenterId));
        }

        if (null != epochDate) {
            this.twepoch = epochDate.getTime();
        } else {
            // 2012/12/12 23:59:59 GMT
            this.twepoch = 1355327999000L;
        }

        this.sequenceBits = sequenceBits;
        this.sequenceMask = -1L ^ (-1L &lt;&lt; sequenceBits);

        this.workerIdShift = sequenceBits;
        this.datacenterIdShift = sequenceBits + workerIdBits;
        this.timestampLeftShift = sequenceBits + workerIdBits + datacenterIdBits;

        this.workerId = workerId;
        this.datacenterId = datacenterId;
        this.timeOffset = timeOffset;
        this.randomSequence = randomSequence;

        String initialInfo = String.format(&quot;worker starting. timestamp left shift %d, datacenter id bits %d, worker id bits %d, sequence bits %d, datacenterid  %d, workerid %d&quot;,
                timestampLeftShift, datacenterIdBits, workerIdBits, sequenceBits, datacenterId, workerId);
        logger.info(initialInfo);
    }

    private static long getDatacenterId(long maxDatacenterId) {
        long id = 0L;
        try {
            InetAddress ip = InetAddress.getLocalHost();
            NetworkInterface network = NetworkInterface.getByInetAddress(ip);
            if (network == null) {
                id = 1L;
            } else {
                byte[] mac = network.getHardwareAddress();
                if (null != mac) {
                    id = ((0x000000FF &amp; (long) mac[mac.length - 1]) | (0x0000FF00 &amp; (((long) mac[mac.length - 2]) &lt;&lt; 8))) &gt;&gt; 6;
                    id = id % (maxDatacenterId + 1);
                }
            }
        } catch (Exception e) {
            throw new RuntimeException(&quot;GetDatacenterId Exception&quot;, e);
        }
        return id;
    }

    private static long getMaxWorkerId(long datacenterId, long maxWorkerId) {
        StringBuilder macIpPid = new StringBuilder();
        macIpPid.append(datacenterId);
        try {
            String name = ManagementFactory.getRuntimeMXBean().getName();
            if (name != null &amp;&amp; !name.isEmpty()) {
                //GET jvmPid
                macIpPid.append(name.split(&quot;@&quot;)[0]);
            }
            //GET hostIpAddress
            String hostIp = InetAddress.getLocalHost().getHostAddress();
            String ipStr = hostIp.replaceAll(&quot;\\.&quot;, &quot;&quot;);
            macIpPid.append(ipStr);
        } catch (Exception e) {
            throw new RuntimeException(&quot;GetMaxWorkerId Exception&quot;, e);
        }
        //MAC + PID + IP çš„ hashcode å–ä½ 16 ä½
        return (macIpPid.toString().hashCode() &amp; 0xffff) % (maxWorkerId + 1);
    }

    public synchronized long nextId() {
        long currentTimestamp = timeGen();

        //è·å–å½“å‰æ—¶é—´æˆ³å¦‚æœå°äºä¸Šæ¬¡æ—¶é—´æˆ³ï¼Œåˆ™è¡¨ç¤ºæ—¶é—´æˆ³è·å–å‡ºç°å¼‚å¸¸
        if (currentTimestamp &lt; lastTimestamp) {
            // æ ¡éªŒæ—¶é—´åç§»å›æ‹¨é‡
            long offset = lastTimestamp - currentTimestamp;
            if (offset &gt; timeOffset) {
                throw new RuntimeException(&quot;Clock moved backwards, refusing to generate id for [&quot; + offset + &quot;ms]&quot;);
            }

            try {
                // æ—¶é—´å›é€€ timeOffset æ¯«ç§’å†…ï¼Œåˆ™å…è®¸ç­‰å¾… 2 å€çš„åç§»é‡åé‡æ–°è·å–ï¼Œè§£å†³å°èŒƒå›´çš„æ—¶é—´å›æ‹¨é—®é¢˜
                this.wait(offset &lt;&lt; 1);
            } catch (Exception e) {
                throw new RuntimeException(e);
            }

            currentTimestamp = timeGen();
            if (currentTimestamp &lt; lastTimestamp) {
                throw new RuntimeException(&quot;Clock moved backwards, refusing to generate id for [&quot; + offset + &quot;ms]&quot;);
            }
        }

        //å¦‚æœè·å–çš„å½“å‰æ—¶é—´æˆ³ç­‰äºä¸Šæ¬¡æ—¶é—´æˆ³ï¼ˆå³åŒä¸€æ¯«ç§’å†…ï¼‰ï¼Œåˆ™åºåˆ—å·è‡ªå¢
        if (lastTimestamp == currentTimestamp) {
            // randomSequence ä¸º true è¡¨ç¤ºéšæœºç”Ÿæˆå…è®¸èŒƒå›´å†…çš„èµ·å§‹åºåˆ—,å¦åˆ™æ¯«ç§’å†…èµ·å§‹å€¼ä» 0L å¼€å§‹è‡ªå¢
            long tempSequence = sequence + 1;
            if (randomSequence) {
                sequence = tempSequence &amp; sequenceMask;
                count = (count + 1) &amp; sequenceMask;
                if (count == 0) {
                    currentTimestamp = this.tillNextMillis(lastTimestamp);
                }
            } else {
                sequence = tempSequence &amp; sequenceMask;
                if (sequence == 0) {
                    currentTimestamp = this.tillNextMillis(lastTimestamp);
                }
            }
        } else {
            sequence = randomSequence ? tlr.nextLong(sequenceMask + 1) : 0L;
            count = 0L;
        }

        lastTimestamp = currentTimestamp;

        return ((currentTimestamp - twepoch) &lt;&lt; timestampLeftShift) |
                (datacenterId &lt;&lt; datacenterIdShift) |
                (workerId &lt;&lt; workerIdShift) |
                sequence;
    }

    private long tillNextMillis(long lastTimestamp) {
        long timestamp = timeGen();
        while (timestamp &lt;= lastTimestamp) {
            timestamp = timeGen();
        }
        return timestamp;
    }

    private long timeGen() {
        return System.currentTimeMillis();
    }

    /**
     * æµ‹è¯•
     * @param args
     */
    public static void main(String[] args) {
//        for (int i = 0; i &lt; 10; i++) {
//            IdGenerator idGenerator = new IdGenerator();
//            new Thread(() -&gt; {
//                for (int j = 0; j &lt; 100; j++) {
//                    System.out.println(idGenerator.nextId());
//                }
//            }).start();
//        }

//        IdGenerator idGenerator = new IdGenerator(1, 1);
//        for (int j = 0; j &lt; 2000; j++) {
//            System.out.println(System.currentTimeMillis() + &quot; &quot; + idGenerator.nextId());
//        }

//        IdGenerator idGenerator = new IdGenerator(true, 10, null, 3L, 2L, 7L);
//        for (int j = 0; j &lt; 2000; j++) {
//            System.out.println(System.currentTimeMillis() + &quot; &quot; + idGenerator.nextId());
//        }

        IdGenerator shortIdGenerator = new IdGenerator(7, 3, true, 10, null, 3, 2, 7);
        for (int j = 0; j &lt; 1000; j++) {
            System.out.println(System.currentTimeMillis() + &quot; &quot; + shortIdGenerator.nextId());
        }
    }
}
</code></pre><p>è®¢å•å·ç”Ÿæˆæ¡ˆä¾‹</p>
<pre tabindex="0"><code>import java.text.SimpleDateFormat;
import java.util.Date;

/**
 * ä½¿ç”¨ IdGenerator ç”Ÿæˆå”¯ä¸€è®¢å•å·
 */
public class OrderNoGenerator {

    private IdGenerator idGenerator;

    /**
     * æ— å‚æ„é€ å™¨ï¼Œè‡ªåŠ¨ç”Ÿæˆ workerId/datacenterId
     */
    public OrderNoGenerator() {
        this.idGenerator = new IdGenerator();
    }

    /**
     * æœ‰å‚æ„é€ å™¨,ä½¿ç”¨è€…è‡ªè¡Œä¿è¯æ•°æ®ä¸­å¿ƒ ID+æœºå™¨ ID çš„å”¯ä¸€æ€§
     *
     * @param idGenerator
     */
    public OrderNoGenerator(IdGenerator idGenerator) {
        this.idGenerator = idGenerator;
    }

    /**
     * ç”Ÿæˆè®¢å•å·
     * @param env        1=dev,2=sit,3=uat,4=prd
     * @param pid        1=äº§å“çº¿ 1,2=äº§å“çº¿ 2,3=äº§å“çº¿ 3
     * @param dateFormat æ—¥æœŸæ ¼å¼
     * @return
     */
    public String getOrderNo(String env, String pid,  String dateFormat) {
        if (dateFormat == null || dateFormat.isEmpty()) {
            dateFormat = &quot;yyMMddHH&quot;;
        }
        String dateStr = new SimpleDateFormat(dateFormat).format(new Date());
        return env + pid + dateStr + idGenerator.nextId();
    }

    /**
     * æµ‹è¯•
     *
     * @param args
     */
    public static void main(String[] args) {
        OrderNoGenerator orderNoGenerator = new OrderNoGenerator();
        for (int i = 0; i &lt; 1000; i++) {
            System.out.println(System.currentTimeMillis() + &quot; &quot; + orderNoGenerator.getOrderNo(&quot;3&quot;, &quot;1&quot;,  null));
        }

        System.out.println(&quot;-------------------------------------------------&quot;);
        //é›ªèŠ±ç®—æ³•ç”Ÿæˆ 15 ä½ ID
        IdGenerator shortIdGenerator = new IdGenerator(1, 2, false, 10, null, 3L, 2L, 7L);
        OrderNoGenerator shortOrderNoGenerator = new OrderNoGenerator(shortIdGenerator);
        for (int i = 0; i &lt; 1000; i++) {
            System.out.println(System.currentTimeMillis() + &quot; &quot; + shortOrderNoGenerator.getOrderNo(&quot;3&quot;, &quot;1&quot;,  null));
        }
    }
}
</code></pre>
        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/articles/%E4%BA%92%E8%81%94%E7%BD%91%E5%B9%B6%E5%8F%91%E9%99%90%E6%B5%81%E5%AE%9E%E6%88%98.md/"><span></span></a>
    </div>
    <div class="next">
        
        <a href="/documents/articles/mysql%E7%9A%84mvcc%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6.md/"><span></span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 27270 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>