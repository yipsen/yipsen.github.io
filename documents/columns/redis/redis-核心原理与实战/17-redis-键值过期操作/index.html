<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>17 Redis é”®å€¼è¿‡æœŸæ“ä½œ | Yipsen Ye</title>
<meta name="description" content="è¿‡æœŸè®¾ç½® Redis ä¸­è®¾ç½®è¿‡æœŸæ—¶é—´ä¸»è¦é€šè¿‡ä»¥ä¸‹å››ç§æ–¹å¼ï¼š
 expire key secondsï¼šè®¾ç½® key åœ¨ n ç§’åè¿‡æœŸï¼› pexpire key millisecondsï¼šè®¾ç½® key åœ¨ n æ¯«ç§’åè¿‡æœŸï¼› expireat key timestampï¼šè®¾ç½® key åœ¨æŸä¸ªæ—¶é—´æˆ³ï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰ä¹‹åè¿‡æœŸï¼› pexpireat key millisecondsTimestampï¼šè®¾ç½® key åœ¨æŸä¸ªæ—¶é—´æˆ³ï¼ˆç²¾ç¡®åˆ°æ¯«ç§’ï¼‰ä¹‹åè¿‡æœŸï¼›  ä¸‹é¢åˆ†åˆ«æ¥çœ‹ä»¥ä¸Šè¿™äº›å‘½ä»¤çš„å…·ä½“å®ç°ã€‚
expireï¼šN ç§’åè¿‡æœŸ 127.0.0.1:6379&amp;gt; set key valueOK127.0.0.1:6379&amp;gt; expire key 100(integer) 1127.0.0.1:6379&amp;gt; ttl key(integer) 97å…¶ä¸­å‘½ä»¤ ttl çš„å…¨ç§°æ˜¯ Time To Liveï¼Œè¡¨ç¤ºæ­¤é”®å€¼åœ¨ n ç§’åè¿‡æœŸã€‚ä¾‹å¦‚ï¼Œä¸Šé¢çš„ç»“æœ 97 è¡¨ç¤º key åœ¨ 97s åè¿‡æœŸã€‚
pexpireï¼šN æ¯«ç§’åè¿‡æœŸ 127.0.0.1:6379&amp;gt; set key2 value2OK127.0.0.1:6379&amp;gt; pexpire key2 100000(integer) 1127.">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="nav-logo">
    <a href="http://yipsen.github.io/">
        
        <span class="nav-title">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æ–‡ç« </a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/redis%20%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e4%b8%8e%e5%ae%9e%e6%88%98/">Redis æ ¸å¿ƒåŸç†ä¸å®æˆ˜</a>
            <ul>
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">17 Redis é”®å€¼è¿‡æœŸæ“ä½œ</h1>
        <div class="post-info">
            <div class="post-date"> 
                <span>2022-09-28 19:38:10</span>
            </div>
        </div>
        <div class="post-content">
            <h3 id="è¿‡æœŸè®¾ç½®">è¿‡æœŸè®¾ç½®</h3>
<p>Redis ä¸­è®¾ç½®è¿‡æœŸæ—¶é—´ä¸»è¦é€šè¿‡ä»¥ä¸‹å››ç§æ–¹å¼ï¼š</p>
<ul>
<li>expire key secondsï¼šè®¾ç½® key åœ¨ n ç§’åè¿‡æœŸï¼›</li>
<li>pexpire key millisecondsï¼šè®¾ç½® key åœ¨ n æ¯«ç§’åè¿‡æœŸï¼›</li>
<li>expireat key timestampï¼šè®¾ç½® key åœ¨æŸä¸ªæ—¶é—´æˆ³ï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰ä¹‹åè¿‡æœŸï¼›</li>
<li>pexpireat key millisecondsTimestampï¼šè®¾ç½® key åœ¨æŸä¸ªæ—¶é—´æˆ³ï¼ˆç²¾ç¡®åˆ°æ¯«ç§’ï¼‰ä¹‹åè¿‡æœŸï¼›</li>
</ul>
<p>ä¸‹é¢åˆ†åˆ«æ¥çœ‹ä»¥ä¸Šè¿™äº›å‘½ä»¤çš„å…·ä½“å®ç°ã€‚</p>
<h4 id="expiren-ç§’åè¿‡æœŸ"><strong>expireï¼šN ç§’åè¿‡æœŸ</strong></h4>
<pre tabindex="0"><code>127.0.0.1:6379&gt; set key value
OK
127.0.0.1:6379&gt; expire key 100
(integer) 1
127.0.0.1:6379&gt; ttl key
(integer) 97

</code></pre><p>å…¶ä¸­å‘½ä»¤ ttl çš„å…¨ç§°æ˜¯ Time To Liveï¼Œè¡¨ç¤ºæ­¤é”®å€¼åœ¨ n ç§’åè¿‡æœŸã€‚ä¾‹å¦‚ï¼Œä¸Šé¢çš„ç»“æœ 97 è¡¨ç¤º key åœ¨ 97s åè¿‡æœŸã€‚</p>
<h4 id="pexpiren-æ¯«ç§’åè¿‡æœŸ"><strong>pexpireï¼šN æ¯«ç§’åè¿‡æœŸ</strong></h4>
<pre tabindex="0"><code>127.0.0.1:6379&gt; set key2 value2
OK
127.0.0.1:6379&gt; pexpire key2 100000
(integer) 1
127.0.0.1:6379&gt; pttl key2
(integer) 94524

</code></pre><p>å…¶ä¸­ <code>pexpire key2 100000</code> è¡¨ç¤ºè®¾ç½® key2 åœ¨ 100000 æ¯«ç§’ï¼ˆ100 ç§’ï¼‰åè¿‡æœŸã€‚</p>
<h4 id="expireatè¿‡æœŸæ—¶é—´æˆ³ç²¾ç¡®åˆ°ç§’"><strong>expireatï¼šè¿‡æœŸæ—¶é—´æˆ³ç²¾ç¡®åˆ°ç§’</strong></h4>
<pre tabindex="0"><code>127.0.0.1:6379&gt; set key3 value3
OK
127.0.0.1:6379&gt; expireat key3 1573472683
(integer) 1
127.0.0.1:6379&gt; ttl key3
(integer) 67

</code></pre><p>å…¶ä¸­ <code>expireat key3 1573472683</code> è¡¨ç¤º key3 åœ¨æ—¶é—´æˆ³ 1573472683 åè¿‡æœŸï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰ï¼Œä½¿ç”¨ ttl æŸ¥è¯¢å¯ä»¥å‘ç°åœ¨ 67s å key3 ä¼šè¿‡æœŸã€‚</p>
<blockquote>
<p>å°è´´å£«ï¼šåœ¨ Redis å¯ä»¥ä½¿ç”¨ time å‘½ä»¤æŸ¥è¯¢å½“å‰æ—¶é—´çš„æ—¶é—´æˆ³ï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<p>127.0.0.1:6379&gt; time</p>
<ol>
<li>
<p>&ldquo;1573472563&rdquo;</p>
</li>
<li>
<p>&ldquo;248426&rdquo;</p>
</li>
</ol>
</blockquote>
<h4 id="pexpireatè¿‡æœŸæ—¶é—´æˆ³ç²¾ç¡®åˆ°æ¯«ç§’"><strong>pexpireatï¼šè¿‡æœŸæ—¶é—´æˆ³ç²¾ç¡®åˆ°æ¯«ç§’</strong></h4>
<pre tabindex="0"><code>127.0.0.1:6379&gt; set key4 value4
OK
127.0.0.1:6379&gt; pexpireat key4 1573472683000
(integer) 1
127.0.0.1:6379&gt; pttl key4
(integer) 3522

</code></pre><p>å…¶ä¸­ <code>pexpireat key4 1573472683000</code> è¡¨ç¤º key4 åœ¨æ—¶é—´æˆ³ 1573472683000 åè¿‡æœŸï¼ˆç²¾ç¡®åˆ°æ¯«ç§’ï¼‰ï¼Œä½¿ç”¨ ttl æŸ¥è¯¢å¯ä»¥å‘ç°åœ¨ 3522ms å key4 ä¼šè¿‡æœŸã€‚</p>
<h4 id="å­—ç¬¦ä¸²ä¸­çš„è¿‡æœŸæ“ä½œ"><strong>å­—ç¬¦ä¸²ä¸­çš„è¿‡æœŸæ“ä½œ</strong></h4>
<p>å­—ç¬¦ä¸²ä¸­å‡ ä¸ªç›´æ¥æ“ä½œè¿‡æœŸæ—¶é—´çš„æ–¹æ³•ï¼Œå¦‚ä¸‹åˆ—è¡¨ï¼š</p>
<ul>
<li>set key value ex secondsï¼šè®¾ç½®é”®å€¼å¯¹çš„åŒæ—¶æŒ‡å®šè¿‡æœŸæ—¶é—´ï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰ï¼›</li>
<li>set key value px millisecondsï¼šè®¾ç½®é”®å€¼å¯¹çš„åŒæ—¶æŒ‡å®šè¿‡æœŸæ—¶é—´ï¼ˆç²¾ç¡®åˆ°æ¯«ç§’ï¼‰ï¼›</li>
<li>setex key seconds valuleï¼šè®¾ç½®é”®å€¼å¯¹çš„åŒæ—¶æŒ‡å®šè¿‡æœŸæ—¶é—´ï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰ã€‚</li>
</ul>
<p>å®ç°ç¤ºä¾‹å¦‚ä¸‹ã€‚</p>
<p><strong>1. set key value ex seconds</strong></p>
<pre tabindex="0"><code>127.0.0.1:6379&gt; set k v ex 100
OK
127.0.0.1:6379&gt; ttl k
(integer) 97

</code></pre><p><strong>2. set key value ex milliseconds</strong></p>
<pre tabindex="0"><code>127.0.0.1:6379&gt; set k2 v2 px 100000
OK
127.0.0.1:6379&gt; pttl k2
(integer) 92483

</code></pre><p><strong>3. setex key seconds valule</strong></p>
<pre tabindex="0"><code>127.0.0.1:6379&gt; setex k3 100 v3
OK
127.0.0.1:6379&gt; ttl k3
(integer) 91

</code></pre><h3 id="ç§»é™¤è¿‡æœŸæ—¶é—´">ç§»é™¤è¿‡æœŸæ—¶é—´</h3>
<p>ä½¿ç”¨å‘½ä»¤ï¼š <code>persist key</code> å¯ä»¥ç§»é™¤é”®å€¼çš„è¿‡æœŸæ—¶é—´ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚</p>
<pre tabindex="0"><code>127.0.0.1:6379&gt; ttl k3
(integer) 97
127.0.0.1:6379&gt; persist k3
(integer) 1
127.0.0.1:6379&gt; ttl k3
(integer) -1

</code></pre><p>å¯ä»¥çœ‹å‡ºç¬¬ä¸€æ¬¡ä½¿ç”¨ ttl æŸ¥è¯¢ k3 ä¼šåœ¨ 97s åè¿‡æœŸï¼Œå½“ä½¿ç”¨äº† persist å‘½ä»¤ä¹‹åï¼Œåœ¨æŸ¥è¯¢ k3 çš„å­˜æ´»æ—¶é—´å‘ç°ç»“æœæ˜¯ -1ï¼Œå®ƒè¡¨ç¤º k3 æ°¸ä¸è¿‡æœŸã€‚</p>
<h3 id="javaå®ç°è¿‡æœŸæ“ä½œ">Javaå®ç°è¿‡æœŸæ“ä½œ</h3>
<p>æœ¬æ–‡å°†ä½¿ç”¨ Jedis æ¡†æ¶æ¥å®ç°å¯¹ Redis è¿‡æœŸæ—¶é—´çš„æ“ä½œï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public class TTLTest {
    public static void main(String[] args) throws InterruptedException {
        // åˆ›å»º Redis è¿æ¥
        Jedis jedis = new Jedis(&quot;xxx.xxx.xxx.xxx&quot;, 6379);
        // è®¾ç½® Redis å¯†ç (å¦‚æœæ²¡æœ‰å¯†ç ï¼Œæ­¤è¡Œå¯çœç•¥)
        jedis.auth(&quot;xxx&quot;);
        // å­˜å‚¨é”®å€¼å¯¹ï¼ˆé»˜è®¤æƒ…å†µä¸‹æ°¸ä¸è¿‡æœŸï¼‰
        jedis.set(&quot;k&quot;, &quot;v&quot;);
        // æŸ¥è¯¢ TTLï¼ˆè¿‡æœŸæ—¶é—´ï¼‰
        Long ttl = jedis.ttl(&quot;k&quot;);
        // æ‰“å°è¿‡æœŸæ—¥å¿—
        System.out.println(&quot;è¿‡æœŸæ—¶é—´ï¼š&quot; + ttl);
        // è®¾ç½® 100s åè¿‡æœŸ
        jedis.expire(&quot;k&quot;, 100);
        // ç­‰å¾… 1s åæ‰§è¡Œ
        Thread.sleep(1000);
        // æ‰“å°è¿‡æœŸæ—¥å¿—
        System.out.println(&quot;æ‰§è¡Œ expire åçš„ TTL=&quot; + jedis.ttl(&quot;k&quot;));
    }
}

</code></pre><p>ç¨‹åºçš„æ‰§è¡Œç»“æœä¸ºï¼š</p>
<pre tabindex="0"><code>è¿‡æœŸæ—¶é—´ï¼š-1
æ‰§è¡Œ expire åçš„ TTL=99

</code></pre><p>å¯ä»¥çœ‹å‡ºä½¿ç”¨ Jedis æ¥æ“ä½œ Redis çš„è¿‡æœŸæ—¶é—´è¿˜æ˜¯å¾ˆæ–¹ä¾¿çš„ï¼Œå¯ç›´æ¥ä½¿ç”¨ <code>jedis.ttl(&quot;k&quot;)</code> æŸ¥è¯¢é”®å€¼çš„ç”Ÿå­˜æ—¶é—´ï¼Œä½¿ç”¨ <code>jedis.expire(&quot;k&quot;,seconds)</code> æ–¹æ³•è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰ã€‚</p>
<blockquote>
<p>å°è´´å£«ï¼šä½¿ç”¨ Jedis ä¹‹å‰ï¼Œå…ˆè¦æŠŠ Jedis å¼•å…¥åˆ°ç¨‹åºä¸­ï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯ Maven é¡¹ç›®çš„ï¼Œç›´æ¥åœ¨ pom.xml æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹å¼•ç”¨ï¼š</p>
</blockquote>
<pre tabindex="0"><code>&lt;!-- https://mvnrepository.com/artifact/redis.clients/jedis --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;redis.clients&lt;/groupId&gt;
    &lt;artifactId&gt;jedis&lt;/artifactId&gt;
    &lt;version&gt;version&lt;/version&gt;
&lt;/dependency&gt;

</code></pre><p><strong>æ›´å¤šè¿‡æœŸæ“ä½œæ–¹æ³•</strong>ï¼Œå¦‚ä¸‹åˆ—è¡¨ï¼š</p>
<ul>
<li>pexpire(String key, long milliseconds)ï¼šè®¾ç½® n æ¯«ç§’åè¿‡æœŸï¼›</li>
<li>expireAt(String key, long unixTime)ï¼šè®¾ç½®æŸä¸ªæ—¶é—´æˆ³åè¿‡æœŸï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰ï¼›</li>
<li>pexpireAt(String key, long millisecondsTimestamp)ï¼šè®¾ç½®æŸä¸ªæ—¶é—´æˆ³åè¿‡æœŸï¼ˆç²¾ç¡®åˆ°æ¯«ç§’ï¼‰ï¼›</li>
<li>persist(String key)ï¼šç§»é™¤è¿‡æœŸæ—¶é—´ã€‚</li>
</ul>
<p>å®Œæ•´ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>public class TTLTest {
    public static void main(String[] args) throws InterruptedException {
        // åˆ›å»º Redis è¿æ¥
        Jedis jedis = new Jedis(&quot;xxx.xxx.xxx.xxx&quot;, 6379);
        // è®¾ç½® Redis å¯†ç (å¦‚æœæ²¡æœ‰å¯†ç ï¼Œæ­¤è¡Œå¯çœç•¥)
        jedis.auth(&quot;xxx&quot;);
        // å­˜å‚¨é”®å€¼å¯¹ï¼ˆé»˜è®¤æƒ…å†µä¸‹æ°¸ä¸è¿‡æœŸï¼‰
        jedis.set(&quot;k&quot;, &quot;v&quot;);
        // æŸ¥è¯¢ TTLï¼ˆè¿‡æœŸæ—¶é—´ï¼‰
        Long ttl = jedis.ttl(&quot;k&quot;);
        // æ‰“å°è¿‡æœŸæ—¥å¿—
        System.out.println(&quot;è¿‡æœŸæ—¶é—´ï¼š&quot; + ttl);
        // è®¾ç½® 100s åè¿‡æœŸ
        jedis.expire(&quot;k&quot;, 100);
        // ç­‰å¾… 1s åæ‰§è¡Œ
        Thread.sleep(1000);
        // æ‰“å°è¿‡æœŸæ—¥å¿—
        System.out.println(&quot;æ‰§è¡Œ expire åçš„ TTL=&quot; + jedis.ttl(&quot;k&quot;));
        // è®¾ç½® n æ¯«ç§’åè¿‡æœŸ
        jedis.pexpire(&quot;k&quot;, 100000);
        // è®¾ç½®æŸä¸ªæ—¶é—´æˆ³åè¿‡æœŸï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰
        jedis.expireAt(&quot;k&quot;, 1573468990);
        // è®¾ç½®æŸä¸ªæ—¶é—´æˆ³åè¿‡æœŸï¼ˆç²¾ç¡®åˆ°æ¯«ç§’ï¼‰
        jedis.pexpireAt(&quot;k&quot;, 1573468990000L);
        // ç§»é™¤è¿‡æœŸæ—¶é—´
        jedis.persist(&quot;k&quot;);
    }
}

</code></pre><h3 id="æŒä¹…åŒ–ä¸­çš„è¿‡æœŸé”®">æŒä¹…åŒ–ä¸­çš„è¿‡æœŸé”®</h3>
<p>ä¸Šé¢æˆ‘ä»¬è®²äº†è¿‡æœŸé”®åœ¨ Redis æ­£å¸¸è¿è¡Œä¸­ä¸€äº›ä½¿ç”¨æ¡ˆä¾‹ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ Redis åœ¨æŒä¹…åŒ–çš„è¿‡ç¨‹ä¸­æ˜¯å¦‚ä½•å¤„ç†è¿‡æœŸé”®çš„ã€‚</p>
<p>Redis æŒä¹…åŒ–æ–‡ä»¶æœ‰ä¸¤ç§æ ¼å¼ï¼šRDBï¼ˆRedis Databaseï¼‰å’Œ AOFï¼ˆAppend Only Fileï¼‰ï¼Œä¸‹é¢æˆ‘ä»¬åˆ†åˆ«æ¥çœ‹è¿‡æœŸé”®åœ¨è¿™ä¸¤ç§æ ¼å¼ä¸­çš„å‘ˆç°çŠ¶æ€ã€‚</p>
<h4 id="rdb-ä¸­çš„è¿‡æœŸé”®"><strong>RDB ä¸­çš„è¿‡æœŸé”®</strong></h4>
<p>RDB æ–‡ä»¶åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼ŒRDB æ–‡ä»¶ç”Ÿæˆé˜¶æ®µå’ŒåŠ è½½é˜¶æ®µã€‚</p>
<p><strong>1. RDB æ–‡ä»¶ç”Ÿæˆ</strong></p>
<p>ä»å†…å­˜çŠ¶æ€æŒä¹…åŒ–æˆ RDBï¼ˆæ–‡ä»¶ï¼‰çš„æ—¶å€™ï¼Œä¼šå¯¹ key è¿›è¡Œè¿‡æœŸæ£€æŸ¥ï¼Œè¿‡æœŸçš„é”®ä¸ä¼šè¢«ä¿å­˜åˆ°æ–°çš„ RDB æ–‡ä»¶ä¸­ï¼Œå› æ­¤ Redis ä¸­çš„è¿‡æœŸé”®ä¸ä¼šå¯¹ç”Ÿæˆæ–° RDB æ–‡ä»¶äº§ç”Ÿä»»ä½•å½±å“ã€‚</p>
<p><strong>2. RDB æ–‡ä»¶åŠ è½½</strong></p>
<p>RDB åŠ è½½åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>å¦‚æœ Redis æ˜¯ä¸»æœåŠ¡å™¨è¿è¡Œæ¨¡å¼çš„è¯ï¼Œåœ¨è½½å…¥ RDB æ–‡ä»¶æ—¶ï¼Œç¨‹åºä¼šå¯¹æ–‡ä»¶ä¸­ä¿å­˜çš„é”®è¿›è¡Œæ£€æŸ¥ï¼Œè¿‡æœŸé”®ä¸ä¼šè¢«è½½å…¥åˆ°æ•°æ®åº“ä¸­ã€‚æ‰€ä»¥è¿‡æœŸé”®ä¸ä¼šå¯¹è½½å…¥ RDB æ–‡ä»¶çš„ä¸»æœåŠ¡å™¨é€ æˆå½±å“ï¼›</li>
<li>å¦‚æœ Redis æ˜¯ä»æœåŠ¡å™¨è¿è¡Œæ¨¡å¼çš„è¯ï¼Œåœ¨è½½å…¥ RDB æ–‡ä»¶æ—¶ï¼Œä¸è®ºé”®æ˜¯å¦è¿‡æœŸéƒ½ä¼šè¢«è½½å…¥åˆ°æ•°æ®åº“ä¸­ã€‚ä½†ç”±äºä¸»ä»æœåŠ¡å™¨åœ¨è¿›è¡Œæ•°æ®åŒæ­¥æ—¶ï¼Œä»æœåŠ¡å™¨çš„æ•°æ®ä¼šè¢«æ¸…ç©ºã€‚æ‰€ä»¥ä¸€èˆ¬æ¥è¯´ï¼Œè¿‡æœŸé”®å¯¹è½½å…¥ RDB æ–‡ä»¶çš„ä»æœåŠ¡å™¨ä¹Ÿä¸ä¼šé€ æˆå½±å“ã€‚</li>
</ul>
<p>RDB æ–‡ä»¶åŠ è½½çš„æºç å¯ä»¥åœ¨ rdb.c æ–‡ä»¶çš„ rdbLoad() å‡½æ•°ä¸­æ‰¾åˆ°ï¼Œæºç æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>/* Check if the key already expired. This function is used when loading
* an RDB file from disk, either at startup, or when an RDB was
* received from the master. In the latter case, the master is
* responsible for key expiry. If we would expire keys here, the
* snapshot taken by the master may not be reflected on the slave. 
*
* å¦‚æœæœåŠ¡å™¨ä¸ºä¸»èŠ‚ç‚¹çš„è¯ï¼Œ
* é‚£ä¹ˆåœ¨é”®å·²ç»è¿‡æœŸçš„æ—¶å€™ï¼Œä¸å†å°†å®ƒä»¬å…³è”åˆ°æ•°æ®åº“ä¸­å»
*/
if (server.masterhost == NULL &amp;&amp; expiretime != -1 &amp;&amp; expiretime &lt; now) {
    decrRefCount(key);
    decrRefCount(val);
    // è·³è¿‡
    continue;
}

</code></pre><h4 id="aof-ä¸­çš„è¿‡æœŸé”®"><strong>AOF ä¸­çš„è¿‡æœŸé”®</strong></h4>
<p><strong>1. AOF æ–‡ä»¶å†™å…¥</strong></p>
<p>å½“ Redis ä»¥ AOF æ¨¡å¼æŒä¹…åŒ–æ—¶ï¼Œå¦‚æœæ•°æ®åº“æŸä¸ªè¿‡æœŸé”®è¿˜æ²¡è¢«åˆ é™¤ï¼Œé‚£ä¹ˆ AOF æ–‡ä»¶ä¼šä¿ç•™æ­¤è¿‡æœŸé”®ï¼Œå½“æ­¤è¿‡æœŸé”®è¢«åˆ é™¤åï¼ŒRedis ä¼šå‘ AOF æ–‡ä»¶è¿½åŠ ä¸€æ¡ DEL å‘½ä»¤æ¥æ˜¾å¼åœ°åˆ é™¤è¯¥é”®å€¼ã€‚</p>
<p><strong>2. AOF é‡å†™</strong></p>
<p>æ‰§è¡Œ AOF é‡å†™æ—¶ï¼Œä¼šå¯¹ Redis ä¸­çš„é”®å€¼å¯¹è¿›è¡Œæ£€æŸ¥å·²è¿‡æœŸçš„é”®ä¸ä¼šè¢«ä¿å­˜åˆ°é‡å†™åçš„ AOF æ–‡ä»¶ä¸­ï¼Œå› æ­¤ä¸ä¼šå¯¹ AOF é‡å†™é€ æˆä»»ä½•å½±å“ã€‚</p>
<h3 id="ä¸»ä»åº“çš„è¿‡æœŸé”®">ä¸»ä»åº“çš„è¿‡æœŸé”®</h3>
<p>å½“ Redis è¿è¡Œåœ¨ä¸»ä»æ¨¡å¼ä¸‹æ—¶ï¼Œä»åº“ä¸ä¼šè¿›è¡Œè¿‡æœŸæ‰«æï¼Œä»åº“å¯¹è¿‡æœŸçš„å¤„ç†æ˜¯è¢«åŠ¨çš„ã€‚ä¹Ÿå°±æ˜¯å³ä½¿ä»åº“ä¸­çš„ key è¿‡æœŸäº†ï¼Œå¦‚æœæœ‰å®¢æˆ·ç«¯è®¿é—®ä»åº“æ—¶ï¼Œä¾ç„¶å¯ä»¥å¾—åˆ° key å¯¹åº”çš„å€¼ï¼Œåƒæœªè¿‡æœŸçš„é”®å€¼å¯¹ä¸€æ ·è¿”å›ã€‚</p>
<p>ä»åº“çš„è¿‡æœŸé”®å¤„ç†ä¾é ä¸»æœåŠ¡å™¨æ§åˆ¶ï¼Œä¸»åº“åœ¨ key åˆ°æœŸæ—¶ï¼Œä¼šåœ¨ AOF æ–‡ä»¶é‡Œå¢åŠ ä¸€æ¡ del æŒ‡ä»¤ï¼ŒåŒæ­¥åˆ°æ‰€æœ‰çš„ä»åº“ï¼Œä»åº“é€šè¿‡æ‰§è¡Œè¿™æ¡ del æŒ‡ä»¤æ¥åˆ é™¤è¿‡æœŸçš„ keyã€‚</p>
<h3 id="å°ç»“">å°ç»“</h3>
<p>æœ¬æ–‡æˆ‘ä»¬çŸ¥é“äº† Redis ä¸­çš„å››ç§è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ–¹å¼ï¼šexpireã€pexpireã€expireatã€pexpireatï¼Œå…¶ä¸­æ¯”è¾ƒå¸¸ç”¨çš„æ˜¯ expire è®¾ç½®é”®å€¼ n ç§’åè¿‡æœŸã€‚</p>
<p>å­—ç¬¦ä¸²ä¸­å¯ä»¥åœ¨æ·»åŠ é”®å€¼çš„åŒæ—¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå¹¶å¯ä»¥ä½¿ç”¨ persist å‘½ä»¤ç§»é™¤è¿‡æœŸæ—¶é—´ã€‚åŒæ—¶æˆ‘ä»¬ä¹ŸçŸ¥é“äº†è¿‡æœŸé”®åœ¨ RDB å†™å…¥å’Œ AOF é‡å†™æ—¶éƒ½ä¸ä¼šè¢«è®°å½•ã€‚</p>
<p>è¿‡æœŸé”®åœ¨ä¸»ä»æ¨¡å¼ä¸‹ï¼Œä»åº“å¯¹è¿‡æœŸé”®çš„å¤„ç†è¦å®Œå…¨ä¾é ä¸»åº“ï¼Œä¸»åº“åˆ é™¤è¿‡æœŸé”®ä¹‹åä¼šå‘é€ del å‘½ä»¤ç»™æ‰€æœ‰çš„ä»åº“ã€‚</p>
<p>æœ¬æ–‡çš„çŸ¥è¯†ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Redis%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E6%88%98/assets/3e0fac90-5de5-11ea-b393-df0a55152c2b" alt="image.png"></p>

        </div>
    </article>
</div>
<div class="division-line"></div>
<div class="others">
    <div>æ ‡ç­¾ï¼šğŸ·ï¸<a class="post-tag" href="/tags/redis/">redis</a>&nbsp;</div>
    <div>åˆ†ç±»ï¼š ğŸ“’<a class="post-category" href="/categories/redis-%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E6%88%98/">Redis æ ¸å¿ƒåŸç†ä¸å®æˆ˜</a>&nbsp; </div>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="http://yipsen.github.io/documents/columns/redis/redis-%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E6%88%98/16-redis-%E4%BA%8B%E5%8A%A1%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/"><span>16 Redis äº‹åŠ¡æ·±å…¥è§£æ</span></a>
    </div>
    <div class="next">
        
        <a href="http://yipsen.github.io/documents/columns/redis/redis-%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E6%88%98/18-redis-%E8%BF%87%E6%9C%9F%E7%AD%96%E7%95%A5%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><span>18 Redis è¿‡æœŸç­–ç•¥ä¸æºç åˆ†æ</span></a>
    </div>
</div>

        </div>
        <div id="float">
            <ul class="float-button-bar">
    <li>
        <button class="float-button top" onclick="scrollToTop(this);">UP</button>
    </li>
    <li>
        <button class="float-button toggler" onclick="changeSkin(this);">DARK</button>
    </li>
</ul>
        </div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 2020 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    const changeSkin = () => {
        document.getElementById('page').classList.toggle('night');
    }
    const scrollToTop = () => {
        window.scrollTo(0, 0);
    }
</script>
</body>

</html>