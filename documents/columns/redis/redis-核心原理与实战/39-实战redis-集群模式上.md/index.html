<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title> | Yipsen Ye</title>
<meta name="description" content="Redis Cluster æ˜¯ Redis 3.0 ç‰ˆæœ¬æ¨å‡ºçš„ Redis é›†ç¾¤æ–¹æ¡ˆï¼Œå®ƒå°†æ•°æ®åˆ†å¸ƒåœ¨ä¸åŒçš„æœåŠ¡åŒºä¸Šï¼Œä»¥æ­¤æ¥é™ä½ç³»ç»Ÿå¯¹å•ä¸»èŠ‚ç‚¹çš„ä¾èµ–ï¼Œå¹¶ä¸”å¯ä»¥å¤§å¤§çš„æé«˜ Redis æœåŠ¡çš„è¯»å†™æ€§èƒ½ã€‚
Redis å°†æ‰€æœ‰çš„æ•°æ®åˆ†ä¸º 16384 ä¸ª slotsï¼ˆæ§½ï¼‰ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£å…¶ä¸­çš„ä¸€éƒ¨åˆ†æ§½ä½ï¼Œå½“æœ‰ Redis å®¢æˆ·ç«¯è¿æ¥é›†ç¾¤æ—¶ï¼Œä¼šå¾—åˆ°ä¸€ä»½é›†ç¾¤çš„æ§½ä½é…ç½®ä¿¡æ¯ï¼Œè¿™æ ·å®ƒå°±å¯ä»¥ç›´æ¥æŠŠè¯·æ±‚å‘½ä»¤å‘é€ç»™å¯¹åº”çš„èŠ‚ç‚¹è¿›è¡Œå¤„ç†ã€‚
Redis Cluster æ˜¯æ— ä»£ç†æ¨¡å¼å»ä¸­å¿ƒåŒ–çš„è¿è¡Œæ¨¡å¼ï¼Œå®¢æˆ·ç«¯å‘é€çš„ç»å¤§æ•°å‘½ä»¤ä¼šç›´æ¥äº¤ç»™ç›¸å…³èŠ‚ç‚¹æ‰§è¡Œï¼Œè¿™æ ·å¤§éƒ¨åˆ†æƒ…å†µè¯·æ±‚å‘½ä»¤æ— éœ€è½¬å‘ï¼Œæˆ–ä»…è½¬å‘ä¸€æ¬¡çš„æƒ…å†µä¸‹å°±èƒ½å®Œæˆè¯·æ±‚ä¸å“åº”ï¼Œæ‰€ä»¥é›†ç¾¤å•ä¸ªèŠ‚ç‚¹çš„æ€§èƒ½ä¸å•æœº Redis æœåŠ¡å™¨çš„æ€§èƒ½æ˜¯éå¸¸æ¥è¿‘çš„ï¼Œå› æ­¤åœ¨ç†è®ºæƒ…å†µä¸‹ï¼Œå½“æ°´å¹³æ‰©å±•ä¸€å€çš„ä¸»èŠ‚ç‚¹å°±ç›¸å½“äºè¯·æ±‚å¤„ç†çš„æ€§èƒ½ä¹Ÿæé«˜äº†ä¸€å€ï¼Œæ‰€ä»¥ Redis Cluster çš„æ€§èƒ½æ˜¯éå¸¸é«˜çš„ã€‚
Redis Cluster æ¶æ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š
æ­å»º Redis Cluster Redis Cluster çš„æ­å»ºæ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯ä½¿ç”¨ Redis æºç ä¸­æä¾›çš„ create-cluster å·¥å…·å¿«é€Ÿçš„æ­å»º Redis é›†ç¾¤ç¯å¢ƒï¼Œå¦ä¸€ç§æ˜¯é…ç½®æ–‡ä»¶çš„æ–¹å¼æ‰‹åŠ¨åˆ›å»º Redis é›†ç¾¤ç¯å¢ƒã€‚
å¿«é€Ÿæ­å»º Redis Cluster create-cluster å·¥å…·åœ¨ utils/create-cluster ç›®å½•ä¸‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
ä½¿ç”¨å‘½ä»¤ ./create-cluster start å°±å¯ä»¥æ€¥é€Ÿåˆ›å»ºä¸€ä¸ª Redis é›†ç¾¤ï¼Œæ‰§è¡Œå¦‚ä¸‹ï¼š
$ ./create-cluster start # åˆ›å»ºé›†ç¾¤ Starting 30001 Starting 30002 Starting 30003 Starting 30004 Starting 30005 Starting 30006 æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æŠŠä»¥ä¸Šåˆ›å»ºçš„ 6 ä¸ªèŠ‚ç‚¹é€šè¿‡ create å‘½ä»¤ç»„æˆä¸€ä¸ªé›†ç¾¤ï¼Œæ‰§è¡Œå¦‚ä¸‹ï¼š">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><article class="post-block">
        <h1 class="post-title"></h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;0001-01-01 00:00:00</span></div></div>
        <div class="post-content">
            <p>Redis Cluster æ˜¯ Redis 3.0 ç‰ˆæœ¬æ¨å‡ºçš„ Redis é›†ç¾¤æ–¹æ¡ˆï¼Œå®ƒå°†æ•°æ®åˆ†å¸ƒåœ¨ä¸åŒçš„æœåŠ¡åŒºä¸Šï¼Œä»¥æ­¤æ¥é™ä½ç³»ç»Ÿå¯¹å•ä¸»èŠ‚ç‚¹çš„ä¾èµ–ï¼Œå¹¶ä¸”å¯ä»¥å¤§å¤§çš„æé«˜ Redis æœåŠ¡çš„è¯»å†™æ€§èƒ½ã€‚</p>
<p>Redis å°†æ‰€æœ‰çš„æ•°æ®åˆ†ä¸º 16384 ä¸ª slotsï¼ˆæ§½ï¼‰ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£å…¶ä¸­çš„ä¸€éƒ¨åˆ†æ§½ä½ï¼Œå½“æœ‰ Redis å®¢æˆ·ç«¯è¿æ¥é›†ç¾¤æ—¶ï¼Œä¼šå¾—åˆ°ä¸€ä»½é›†ç¾¤çš„æ§½ä½é…ç½®ä¿¡æ¯ï¼Œè¿™æ ·å®ƒå°±å¯ä»¥ç›´æ¥æŠŠè¯·æ±‚å‘½ä»¤å‘é€ç»™å¯¹åº”çš„èŠ‚ç‚¹è¿›è¡Œå¤„ç†ã€‚</p>
<p>Redis Cluster æ˜¯æ— ä»£ç†æ¨¡å¼å»ä¸­å¿ƒåŒ–çš„è¿è¡Œæ¨¡å¼ï¼Œå®¢æˆ·ç«¯å‘é€çš„ç»å¤§æ•°å‘½ä»¤ä¼šç›´æ¥äº¤ç»™ç›¸å…³èŠ‚ç‚¹æ‰§è¡Œï¼Œè¿™æ ·å¤§éƒ¨åˆ†æƒ…å†µè¯·æ±‚å‘½ä»¤æ— éœ€è½¬å‘ï¼Œæˆ–ä»…è½¬å‘ä¸€æ¬¡çš„æƒ…å†µä¸‹å°±èƒ½å®Œæˆè¯·æ±‚ä¸å“åº”ï¼Œæ‰€ä»¥é›†ç¾¤å•ä¸ªèŠ‚ç‚¹çš„æ€§èƒ½ä¸å•æœº Redis æœåŠ¡å™¨çš„æ€§èƒ½æ˜¯éå¸¸æ¥è¿‘çš„ï¼Œå› æ­¤åœ¨ç†è®ºæƒ…å†µä¸‹ï¼Œå½“æ°´å¹³æ‰©å±•ä¸€å€çš„ä¸»èŠ‚ç‚¹å°±ç›¸å½“äºè¯·æ±‚å¤„ç†çš„æ€§èƒ½ä¹Ÿæé«˜äº†ä¸€å€ï¼Œæ‰€ä»¥ Redis Cluster çš„æ€§èƒ½æ˜¯éå¸¸é«˜çš„ã€‚</p>
<p>Redis Cluster æ¶æ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Redis%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E6%88%98/assets/b74ff8b0-8579-11ea-ab1b-af991e0896fe" alt="image.png"></p>
<h3 id="æ­å»º-redis-cluster">æ­å»º Redis Cluster</h3>
<p>Redis Cluster çš„æ­å»ºæ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯ä½¿ç”¨ Redis æºç ä¸­æä¾›çš„ create-cluster å·¥å…·å¿«é€Ÿçš„æ­å»º Redis é›†ç¾¤ç¯å¢ƒï¼Œå¦ä¸€ç§æ˜¯é…ç½®æ–‡ä»¶çš„æ–¹å¼æ‰‹åŠ¨åˆ›å»º Redis é›†ç¾¤ç¯å¢ƒã€‚</p>
<h4 id="å¿«é€Ÿæ­å»º-redis-cluster"><strong>å¿«é€Ÿæ­å»º Redis Cluster</strong></h4>
<p>create-cluster å·¥å…·åœ¨ utils/create-cluster ç›®å½•ä¸‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Redis%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E6%88%98/assets/c9c920c0-8579-11ea-a9ff-29e53f17413b" alt="image.png"></p>
<p>ä½¿ç”¨å‘½ä»¤ <code>./create-cluster start</code> å°±å¯ä»¥æ€¥é€Ÿåˆ›å»ºä¸€ä¸ª Redis é›†ç¾¤ï¼Œæ‰§è¡Œå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>$ ./create-cluster start # åˆ›å»ºé›†ç¾¤
Starting 30001
Starting 30002
Starting 30003
Starting 30004
Starting 30005
Starting 30006

</code></pre><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æŠŠä»¥ä¸Šåˆ›å»ºçš„ 6 ä¸ªèŠ‚ç‚¹é€šè¿‡ create å‘½ä»¤ç»„æˆä¸€ä¸ªé›†ç¾¤ï¼Œæ‰§è¡Œå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>[@iZ2ze0nc5n41zomzyqtksmZ:create-cluster]$ ./create-cluster create # ç»„å»ºé›†ç¾¤
&gt;&gt;&gt; Performing hash slots allocation on 6 nodes...
Master[0] -&gt; Slots 0 - 5460
Master[1] -&gt; Slots 5461 - 10922
Master[2] -&gt; Slots 10923 - 16383
Adding replica 127.0.0.1:30005 to 127.0.0.1:30001
Adding replica 127.0.0.1:30006 to 127.0.0.1:30002
Adding replica 127.0.0.1:30004 to 127.0.0.1:30003
&gt;&gt;&gt; Trying to optimize slaves allocation for anti-affinity
[WARNING] Some slaves are in the same host as their master
M: 445f2a86fe36d397613839d8cc1ae6702c976593 127.0.0.1:30001
   slots:[0-5460] (5461 slots) master
M: 63bb14023c0bf58926738cbf857ea304bff8eb50 127.0.0.1:30002
   slots:[5461-10922] (5462 slots) master
M: 864d4dfe32e3e0b81a64cec8b393bbd26a65cbcc 127.0.0.1:30003
   slots:[10923-16383] (5461 slots) master
S: 64828ab44566fc5ad656e831fd33de87be1387a0 127.0.0.1:30004
   replicates 445f2a86fe36d397613839d8cc1ae6702c976593
S: 0b17b00542706343583aa73149ec5ff63419f140 127.0.0.1:30005
   replicates 63bb14023c0bf58926738cbf857ea304bff8eb50
S: e35f06ca9b700073472d72001a39ea4dfcb541cd 127.0.0.1:30006
   replicates 864d4dfe32e3e0b81a64cec8b393bbd26a65cbcc
Can I set the above configuration? (type 'yes' to accept): yes
&gt;&gt;&gt; Nodes configuration updated
&gt;&gt;&gt; Assign a different config epoch to each node
&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster
Waiting for the cluster to join
.
&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:30001)
M: 445f2a86fe36d397613839d8cc1ae6702c976593 127.0.0.1:30001
   slots:[0-5460] (5461 slots) master
   1 additional replica(s)
M: 864d4dfe32e3e0b81a64cec8b393bbd26a65cbcc 127.0.0.1:30003
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
S: e35f06ca9b700073472d72001a39ea4dfcb541cd 127.0.0.1:30006
   slots: (0 slots) slave
   replicates 864d4dfe32e3e0b81a64cec8b393bbd26a65cbcc
S: 0b17b00542706343583aa73149ec5ff63419f140 127.0.0.1:30005
   slots: (0 slots) slave
   replicates 63bb14023c0bf58926738cbf857ea304bff8eb50
M: 63bb14023c0bf58926738cbf857ea304bff8eb50 127.0.0.1:30002
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
S: 64828ab44566fc5ad656e831fd33de87be1387a0 127.0.0.1:30004
   slots: (0 slots) slave
   replicates 445f2a86fe36d397613839d8cc1ae6702c976593
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.

</code></pre><p>åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä¼šè¯¢é—®ä½ æ˜¯å¦é€šè¿‡æŠŠ 30001ã€30002ã€30003 ä½œä¸ºä¸»èŠ‚ç‚¹ï¼ŒæŠŠ 30004ã€30005ã€30006 ä½œä¸ºå®ƒä»¬çš„ä»èŠ‚ç‚¹ï¼Œè¾“å…¥ <code>yes</code> åä¼šæ‰§è¡Œå®Œæˆã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥å…ˆä½¿ç”¨ redis-cli è¿æ¥åˆ°é›†ç¾¤ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>$ redis-cli -c -p 30001

</code></pre><p>åœ¨ä½¿ç”¨ nodes å‘½ä»¤æ¥æŸ¥çœ‹é›†ç¾¤çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>127.0.0.1:30001&gt; cluster nodes
864d4dfe32e3e0b81a64cec8b393bbd26a65cbcc 127.0.0.1:30003@40003 master - 0 1585125835078 3 connected 10923-16383
e35f06ca9b700073472d72001a39ea4dfcb541cd 127.0.0.1:30006@40006 slave 864d4dfe32e3e0b81a64cec8b393bbd26a65cbcc 0 1585125835078 6 connected
0b17b00542706343583aa73149ec5ff63419f140 127.0.0.1:30005@40005 slave 63bb14023c0bf58926738cbf857ea304bff8eb50 0 1585125835078 5 connected
63bb14023c0bf58926738cbf857ea304bff8eb50 127.0.0.1:30002@40002 master - 0 1585125834175 2 connected 5461-10922
445f2a86fe36d397613839d8cc1ae6702c976593 127.0.0.1:30001@40001 myself,master - 0 1585125835000 1 connected 0-5460
64828ab44566fc5ad656e831fd33de87be1387a0 127.0.0.1:30004@40004 slave 445f2a86fe36d397613839d8cc1ae6702c976593 0 1585125835000 4 connected

</code></pre><p>å¯ä»¥çœ‹å‡º 30001ã€30002ã€30003 éƒ½ä¸ºä¸»èŠ‚ç‚¹ï¼Œ30001 å¯¹åº”çš„æ§½ä½æ˜¯ 0~5460ï¼Œ30002 å¯¹åº”çš„æ§½ä½æ˜¯ 5461~10922ï¼Œ30003 å¯¹åº”çš„æ§½ä½æ˜¯ 10923~16383ï¼Œæ€»å…±æœ‰æ§½ä½ 16384 ä¸ªï¼ˆ0~16383ï¼‰ã€‚</p>
<p>create-cluster æ­å»ºçš„æ–¹å¼è™½ç„¶é€Ÿåº¦å¾ˆå¿«ï¼Œä½†æ˜¯è¯¥æ–¹å¼æ­å»ºçš„é›†ç¾¤ä¸»ä»èŠ‚ç‚¹æ•°é‡å›ºå®šä»¥åŠæ§½ä½åˆ†é…æ¨¡å¼å›ºå®šï¼Œå¹¶ä¸”å®‰è£…åœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šï¼Œæ‰€ä»¥åªèƒ½ç”¨äºæµ‹è¯•ç¯å¢ƒã€‚</p>
<p>æˆ‘ä»¬æµ‹è¯•å®Œæˆä¹‹åï¼Œå¯ä»¥<strong>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼Œå…³é—­å¹¶æ¸…ç†é›†ç¾¤</strong>ï¼š</p>
<pre tabindex="0"><code>$ ./create-cluster stop # å…³é—­é›†ç¾¤
Stopping 30001
Stopping 30002
Stopping 30003
Stopping 30004
Stopping 30005
Stopping 30006
$ ./create-cluster clean # æ¸…ç†é›†ç¾¤

</code></pre><h4 id="æ‰‹åŠ¨æ­å»º-redis-cluster"><strong>æ‰‹åŠ¨æ­å»º Redis Cluster</strong></h4>
<p>ç”±äº create-cluster æœ¬èº«çš„é™åˆ¶ï¼Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­æˆ‘ä»¬éœ€è¦ä½¿ç”¨æ‰‹åŠ¨æ·»åŠ é…ç½®çš„æ–¹å¼æ­å»º Redis é›†ç¾¤ï¼Œä¸ºæ­¤æˆ‘ä»¬å…ˆè¦æŠŠ Redis å®‰è£…åŒ…å¤åˆ¶åˆ° node1 åˆ° node6 æ–‡ä»¶ä¸­ï¼Œå› ä¸ºæˆ‘ä»¬è¦å®‰è£… 6 ä¸ªèŠ‚ç‚¹ï¼Œ3 ä¸» 3 ä»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Redis%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E6%88%98/assets/dba0b1a0-8579-11ea-9270-3f924eb97e89" alt="image.png"></p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Redis%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E6%88%98/assets/f7eb6e40-8579-11ea-a9ff-29e53f17413b" alt="image.png"></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è¿›è¡Œé…ç½®å¹¶å¯åŠ¨ Redis é›†ç¾¤ã€‚</p>
<p><strong>1. è®¾ç½®é…ç½®æ–‡ä»¶</strong></p>
<p>æˆ‘ä»¬éœ€è¦ä¿®æ”¹æ¯ä¸ªèŠ‚ç‚¹å†…çš„ redis.conf æ–‡ä»¶ï¼Œè®¾ç½® <code>cluster-enabled yes</code> è¡¨ç¤ºå¼€å¯é›†ç¾¤æ¨¡å¼ï¼Œå¹¶ä¸”ä¿®æ”¹å„è‡ªçš„ç«¯å£ï¼Œæˆ‘ä»¬ç»§ç»­ä½¿ç”¨ 30001 åˆ° 30006ï¼Œé€šè¿‡ <code>port 3000X</code> è®¾ç½®ã€‚</p>
<p><strong>2. å¯åŠ¨å„ä¸ªèŠ‚ç‚¹</strong></p>
<p>redis.conf é…ç½®å¥½ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯åŠ¨æ‰€æœ‰çš„èŠ‚ç‚¹äº†ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>cd /usr/local/soft/mycluster/node1 
./src/redis-server redis.conf

</code></pre><p><strong>3. åˆ›å»ºé›†ç¾¤å¹¶åˆ†é…æ§½ä½</strong></p>
<p>ä¹‹å‰æˆ‘ä»¬å·²ç»å¯åŠ¨äº† 6 ä¸ªèŠ‚ç‚¹ï¼Œä½†è¿™äº›èŠ‚ç‚¹éƒ½åœ¨å„è‡ªçš„é›†ç¾¤ä¹‹å†…å¹¶æœªäº’è”äº’é€šï¼Œå› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æŠŠè¿™äº›èŠ‚ç‚¹ä¸²è¿æˆä¸€ä¸ªé›†ç¾¤ï¼Œå¹¶ä¸ºå®ƒä»¬æŒ‡å®šå¯¹åº”çš„æ§½ä½ï¼Œæ‰§è¡Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>redis-cli --cluster create 127.0.0.1:30001 127.0.0.1:30002 127.0.0.1:30003 127.0.0.1:30004 127.0.0.1:30005 127.0.0.1:30006 --cluster-replicas 1

</code></pre><p>å…¶ä¸­ create åé¢è·Ÿå¤šä¸ªèŠ‚ç‚¹ï¼Œè¡¨ç¤ºæŠŠè¿™äº›èŠ‚ç‚¹ä½œä¸ºæ•´ä¸ªé›†ç¾¤çš„èŠ‚ç‚¹ï¼Œè€Œ cluster-replicas è¡¨ç¤ºç»™é›†ç¾¤ä¸­çš„ä¸»èŠ‚ç‚¹æŒ‡å®šä»èŠ‚ç‚¹çš„æ•°é‡ï¼Œ1 è¡¨ç¤ºä¸ºæ¯ä¸ªä¸»èŠ‚ç‚¹è®¾ç½®ä¸€ä¸ªä»èŠ‚ç‚¹ã€‚</p>
<p>åœ¨æ‰§è¡Œäº† create å‘½ä»¤ä¹‹åï¼Œç³»ç»Ÿä¼šä¸ºæˆ‘ä»¬æŒ‡å®šèŠ‚ç‚¹çš„è§’è‰²å’Œæ§½ä½åˆ†é…è®¡åˆ’ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>&gt;&gt;&gt; Performing hash slots allocation on 6 nodes...
Master[0] -&gt; Slots 0 - 5460
Master[1] -&gt; Slots 5461 - 10922
Master[2] -&gt; Slots 10923 - 16383
Adding replica 127.0.0.1:30005 to 127.0.0.1:30001
Adding replica 127.0.0.1:30006 to 127.0.0.1:30002
Adding replica 127.0.0.1:30004 to 127.0.0.1:30003
&gt;&gt;&gt; Trying to optimize slaves allocation for anti-affinity
[WARNING] Some slaves are in the same host as their master
M: bdd1c913f87eacbdfeabc71befd0d06c913c891c 127.0.0.1:30001
   slots:[0-5460] (5461 slots) master
M: bdd1c913f87eacbdfeabc71befd0d06c913c891c 127.0.0.1:30002
   slots:[5461-10922] (5462 slots) master
M: bdd1c913f87eacbdfeabc71befd0d06c913c891c 127.0.0.1:30003
   slots:[10923-16383] (5461 slots) master
S: bdd1c913f87eacbdfeabc71befd0d06c913c891c 127.0.0.1:30004
   replicates bdd1c913f87eacbdfeabc71befd0d06c913c891c
S: bdd1c913f87eacbdfeabc71befd0d06c913c891c 127.0.0.1:30005
   replicates bdd1c913f87eacbdfeabc71befd0d06c913c891c
S: bdd1c913f87eacbdfeabc71befd0d06c913c891c 127.0.0.1:30006
   replicates bdd1c913f87eacbdfeabc71befd0d06c913c891c
Can I set the above configuration? (type 'yes' to accept): 

</code></pre><p>ä»ä»¥ä¸Šä¿¡æ¯å¯ä»¥çœ‹å‡ºï¼ŒRedis æ‰“ç®—æŠŠ 30001ã€30002ã€30003 è®¾ç½®ä¸ºä¸»èŠ‚ç‚¹ï¼Œå¹¶ä¸ºä»–ä»¬åˆ†é…çš„æ§½ä½ï¼Œ30001 å¯¹åº”çš„æ§½ä½æ˜¯ 0~5460ï¼Œ30002 å¯¹åº”çš„æ§½ä½æ˜¯ 5461~10922ï¼Œ30003 å¯¹åº”çš„æ§½ä½æ˜¯ 10923~16383ï¼Œå¹¶ä¸”æŠŠ 30005 è®¾ç½®ä¸º 30001 çš„ä»èŠ‚ç‚¹ã€30006 è®¾ç½®ä¸º 30002 çš„ä»èŠ‚ç‚¹ã€30004 è®¾ç½®ä¸º 30003 çš„ä»èŠ‚ç‚¹ï¼Œæˆ‘ä»¬åªéœ€è¦è¾“å…¥ <code>yes</code> å³å¯ç¡®è®¤å¹¶æ‰§è¡Œåˆ†é…ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>Can I set the above configuration? (type 'yes' to accept): yes
&gt;&gt;&gt; Nodes configuration updated
&gt;&gt;&gt; Assign a different config epoch to each node
&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster
Waiting for the cluster to join
....
&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:30001)
M: 887397e6fefe8ad19ea7569e99f5eb8a803e3785 127.0.0.1:30001
   slots:[0-5460] (5461 slots) master
   1 additional replica(s)
S: abec9f98f9c01208ba77346959bc35e8e274b6a3 127.0.0.1:30005
   slots: (0 slots) slave
   replicates 887397e6fefe8ad19ea7569e99f5eb8a803e3785
S: 1a324d828430f61be6eaca7eb2a90728dd5049de 127.0.0.1:30004
   slots: (0 slots) slave
   replicates f5958382af41d4e1f5b0217c1413fe19f390b55f
S: dc0702625743c48c75ea935c87813c4060547cef 127.0.0.1:30006
   slots: (0 slots) slave
   replicates 3da35c40c43b457a113b539259f17e7ed616d13d
M: 3da35c40c43b457a113b539259f17e7ed616d13d 127.0.0.1:30002
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
M: f5958382af41d4e1f5b0217c1413fe19f390b55f 127.0.0.1:30003
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.

</code></pre><p>æ˜¾ç¤º OK è¡¨ç¤ºæ•´ä¸ªé›†ç¾¤å°±å·²ç»æˆåŠŸå¯åŠ¨äº†ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ redis-cli è¿æ¥å¹¶æµ‹è¯•ä¸€ä¸‹é›†ç¾¤çš„è¿è¡ŒçŠ¶æ€ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>$ redis-cli -c -p 30001 # è¿æ¥åˆ°é›†ç¾¤
127.0.0.1:30001&gt; cluster info # æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯
cluster_state:ok # çŠ¶æ€æ­£å¸¸
cluster_slots_assigned:16384 # æ§½ä½æ•°
cluster_slots_ok:16384 # æ­£å¸¸çš„æ§½ä½æ•°
cluster_slots_pfail:0 
cluster_slots_fail:0
cluster_known_nodes:6 # é›†ç¾¤çš„èŠ‚ç‚¹æ•°
cluster_size:3 # é›†ç¾¤ä¸»èŠ‚ç‚¹æ•°
cluster_current_epoch:6
cluster_my_epoch:1
cluster_stats_messages_ping_sent:130
cluster_stats_messages_pong_sent:127
cluster_stats_messages_sent:257
cluster_stats_messages_ping_received:122
cluster_stats_messages_pong_received:130
cluster_stats_messages_meet_received:5
cluster_stats_messages_received:257

</code></pre><p>ç›¸å…³å­—æ®µçš„è¯´æ˜å·²ç»æ ‡è¯†åœ¨ä¸Šè¿°çš„ä»£ç ä¸­äº†ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚</p>
<h3 id="åŠ¨æ€å¢åˆ èŠ‚ç‚¹">åŠ¨æ€å¢åˆ èŠ‚ç‚¹</h3>
<p>æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®å®é™…çš„ä¸šåŠ¡æƒ…å†µï¼Œå¯¹å·²ç»åœ¨è¿è¡Œçš„é›†ç¾¤è¿›è¡ŒåŠ¨æ€çš„æ·»åŠ æˆ–åˆ é™¤èŠ‚ç‚¹ï¼Œé‚£æˆ‘ä»¬å°±éœ€è¦è¿›è¡Œä»¥ä¸‹æ“ä½œã€‚</p>
<h4 id="å¢åŠ ä¸»èŠ‚ç‚¹"><strong>å¢åŠ ä¸»èŠ‚ç‚¹</strong></h4>
<p><strong>æ·»åŠ æ–¹å¼ä¸€ï¼šcluster meet</strong></p>
<p>ä½¿ç”¨ <code>cluster meet ip:port</code> å‘½ä»¤å°±å¯ä»¥æŠŠä¸€ä¸ªèŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤ä¸­ï¼Œæ‰§è¡Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>127.0.0.1:30001&gt; cluster meet 127.0.0.1 30007
OK
127.0.0.1:30001&gt; cluster nodes
dc0702625743c48c75ea935c87813c4060547cef 127.0.0.1:30006@40006 slave 3da35c40c43b457a113b539259f17e7ed616d13d 0 1585142916000 6 connected
df0190853a53d8e078205d0e2fa56046f20362a7 127.0.0.1:30007@40007 master - 0 1585142917740 0 connected
f5958382af41d4e1f5b0217c1413fe19f390b55f 127.0.0.1:30003@40003 master - 0 1585142916738 3 connected 10923-16383
3da35c40c43b457a113b539259f17e7ed616d13d 127.0.0.1:30002@40002 master - 0 1585142913000 2 connected 5461-10922
abec9f98f9c01208ba77346959bc35e8e274b6a3 127.0.0.1:30005@40005 slave 887397e6fefe8ad19ea7569e99f5eb8a803e3785 0 1585142917000 5 connected
887397e6fefe8ad19ea7569e99f5eb8a803e3785 127.0.0.1:30001@40001 myself,master - 0 1585142915000 1 connected 0-5460
1a324d828430f61be6eaca7eb2a90728dd5049de 127.0.0.1:30004@40004 slave f5958382af41d4e1f5b0217c1413fe19f390b55f 0 1585142916000 4 connected

</code></pre><p>å¯ä»¥çœ‹å‡ºç«¯å£ä¸º 30007 çš„èŠ‚ç‚¹å¹¶åŠ å…¥åˆ°é›†ç¾¤ä¸­ï¼Œå¹¶è®¾ç½®æˆäº†ä¸»èŠ‚ç‚¹ã€‚</p>
<p><strong>æ·»åŠ æ–¹å¼äºŒï¼šadd-node</strong></p>
<p>ä½¿ç”¨ <code>redis-cli --cluster add-node æ·»åŠ èŠ‚ç‚¹ip:port é›†ç¾¤æŸèŠ‚ç‚¹ip:port</code> ä¹Ÿå¯ä»¥æŠŠä¸€ä¸ªèŠ‚ç‚¹æ·»åŠ åˆ°é›†ç¾¤ä¸­ï¼Œæ‰§è¡Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>$ redis-cli --cluster add-node 127.0.0.1:30008 127.0.0.1:30001
&gt;&gt;&gt; Adding node 127.0.0.1:30008 to cluster 127.0.0.1:30001
&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:30001)
M: 887397e6fefe8ad19ea7569e99f5eb8a803e3785 127.0.0.1:30001
   slots:[0-5460] (5461 slots) master
   1 additional replica(s)
S: dc0702625743c48c75ea935c87813c4060547cef 127.0.0.1:30006
   slots: (0 slots) slave
   replicates 3da35c40c43b457a113b539259f17e7ed616d13d
M: df0190853a53d8e078205d0e2fa56046f20362a7 127.0.0.1:30007
   slots: (0 slots) master
M: f5958382af41d4e1f5b0217c1413fe19f390b55f 127.0.0.1:30003
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
M: 1d09d26fd755298709efe60278457eaa09cefc26 127.0.0.1:30008
   slots: (0 slots) master
M: 3da35c40c43b457a113b539259f17e7ed616d13d 127.0.0.1:30002
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
S: abec9f98f9c01208ba77346959bc35e8e274b6a3 127.0.0.1:30005
   slots: (0 slots) slave
   replicates 887397e6fefe8ad19ea7569e99f5eb8a803e3785
S: 1a324d828430f61be6eaca7eb2a90728dd5049de 127.0.0.1:30004
   slots: (0 slots) slave
   replicates f5958382af41d4e1f5b0217c1413fe19f390b55f
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.
[ERR] Node 127.0.0.1:30008 is not empty. Either the node already knows other nodes (check with CLUSTER NODES) or contains some key in database 0.

</code></pre><p>ä»ä»¥ä¸Šç»“æœå¯ä»¥çœ‹å‡º 30008 èŠ‚ç‚¹ä¹Ÿè¢«è®¾ç½®æˆäº†ä¸»èŠ‚ç‚¹ã€‚</p>
<h4 id="æ·»åŠ ä»èŠ‚ç‚¹"><strong>æ·»åŠ ä»èŠ‚ç‚¹</strong></h4>
<p>ä½¿ç”¨ <code>cluster replicate nodeId</code> å‘½ä»¤å°±å¯ä»¥æŠŠå½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºç›®æ ‡èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ï¼Œæ‰§è¡Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>127.0.0.1:30008&gt; cluster replicate df0190853a53d8e078205d0e2fa56046f20362a7
OK
127.0.0.1:30008&gt; cluster nodes
df0190853a53d8e078205d0e2fa56046f20362a7 127.0.0.1:30007@40007 master - 0 1585147827000 0 connected
abec9f98f9c01208ba77346959bc35e8e274b6a3 127.0.0.1:30005@40005 slave 887397e6fefe8ad19ea7569e99f5eb8a803e3785 0 1585147827000 1 connected
1a324d828430f61be6eaca7eb2a90728dd5049de 127.0.0.1:30004@40004 slave f5958382af41d4e1f5b0217c1413fe19f390b55f 0 1585147823000 3 connected
887397e6fefe8ad19ea7569e99f5eb8a803e3785 127.0.0.1:30001@40001 master - 0 1585147826000 1 connected 0-5460
dc0702625743c48c75ea935c87813c4060547cef 127.0.0.1:30006@40006 slave 3da35c40c43b457a113b539259f17e7ed616d13d 0 1585147826930 2 connected
f5958382af41d4e1f5b0217c1413fe19f390b55f 127.0.0.1:30003@40003 master - 0 1585147826000 3 connected 10923-16383
1d09d26fd755298709efe60278457eaa09cefc26 127.0.0.1:30008@40008 myself,slave df0190853a53d8e078205d0e2fa56046f20362a7 0 1585147823000 7 connected
3da35c40c43b457a113b539259f17e7ed616d13d 127.0.0.1:30002@40002 master - 0 1585147827933 2 connected 5461-10922

</code></pre><p>å¯ä»¥çœ‹å‡º 30008 å·²ç»å˜ä¸º 30007 çš„ä»èŠ‚ç‚¹äº†ã€‚</p>
<h4 id="åˆ é™¤èŠ‚ç‚¹"><strong>åˆ é™¤èŠ‚ç‚¹</strong></h4>
<p>ä½¿ç”¨ <code>cluster forget nodeId</code> å‘½ä»¤å°±å¯ä»¥æŠŠä¸€ä¸ªèŠ‚ç‚¹ä»é›†ç¾¤ä¸­ç§»é™¤ã€‚</p>
<p>æ­¤å‘½ä»¤å’Œ meet å‘½ä»¤ä¸åŒçš„æ—¶ï¼Œåˆ é™¤èŠ‚ç‚¹éœ€è¦æŠŠä½¿ç”¨èŠ‚ç‚¹çš„ Id è¿›è¡Œåˆ é™¤ï¼Œå¯ä»¥é€šè¿‡ <code>cluster nodes</code> å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹çš„ Id ä¿¡æ¯ï¼Œå…¶ä¸­æ¯ä¸€è¡Œçš„æœ€å‰é¢çš„ 40 ä½å­—æ¯å’Œæ•°ç»„çš„ç»„åˆå°±æ˜¯è¯¥èŠ‚ç‚¹çš„ Idï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Redis%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E6%88%98/assets/09adf080-857a-11ea-a60a-8194ba77d48b" alt="image.png"></p>
<p>æ‰§è¡Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>127.0.0.1:30001&gt; cluster forget df0190853a53d8e078205d0e2fa56046f20362a7
OK

</code></pre><p>æ­¤æ—¶æˆ‘ä»¬ä½¿ç”¨ <code>cluster nodes</code> å‘½ä»¤æŸ¥çœ‹é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯ï¼š</p>
<pre tabindex="0"><code>127.0.0.1:30001&gt; cluster nodes
dc0702625743c48c75ea935c87813c4060547cef 127.0.0.1:30006@40006 slave 3da35c40c43b457a113b539259f17e7ed616d13d 0 1585143789940 6 connected
f5958382af41d4e1f5b0217c1413fe19f390b55f 127.0.0.1:30003@40003 master - 0 1585143791000 3 connected 10923-16383
3da35c40c43b457a113b539259f17e7ed616d13d 127.0.0.1:30002@40002 master - 0 1585143789000 2 connected 5461-10922
abec9f98f9c01208ba77346959bc35e8e274b6a3 127.0.0.1:30005@40005 slave 887397e6fefe8ad19ea7569e99f5eb8a803e3785 0 1585143789000 5 connected
887397e6fefe8ad19ea7569e99f5eb8a803e3785 127.0.0.1:30001@40001 myself,master - 0 1585143786000 1 connected 0-5460
1a324d828430f61be6eaca7eb2a90728dd5049de 127.0.0.1:30004@40004 slave f5958382af41d4e1f5b0217c1413fe19f390b55f 0 1585143791945 4 connected

</code></pre><p>å¯ä»¥çœ‹å‡ºä¹‹å‰çš„ç«¯å£ä¸º 30007 çš„èŠ‚ç‚¹å·²ç»è¢«æˆ‘ä»¬æˆåŠŸçš„ç§»é™¤äº†ã€‚</p>
<h3 id="å°ç»“">å°ç»“</h3>
<p>æœ¬æ–‡è®²äº† Redis é›†ç¾¤çš„ä¸¤ç§æ­å»ºæ–¹å¼ï¼šcreate-cluster start å’Œ cluster createï¼Œå‰ä¸€ç§æ–¹å¼è™½ç„¶é€Ÿåº¦æ¯”è¾ƒå¿«ï¼Œä½†å®ƒåªèƒ½åˆ›å»ºæ•°é‡å›ºå®šçš„ä¸»ä»èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ‰€æœ‰èŠ‚ç‚¹éƒ½åœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šï¼Œå› æ­¤åªèƒ½ç”¨äºæµ‹è¯•ç¯å¢ƒã€‚æˆ‘ä»¬è¿˜è®²äº† Redis é›†ç¾¤åŠ¨æ€æ·»åŠ ä¸»ã€ä»èŠ‚ç‚¹å’Œåˆ é™¤ä»»æ„èŠ‚ç‚¹çš„åŠŸèƒ½ã€‚</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/redis/redis-%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E6%88%98/40-%E5%AE%9E%E6%88%98redis-%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F%E4%B8%8B.md/"><span></span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/redis/redis-%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E6%88%98/38-%E5%AE%9E%E6%88%98redis-%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F%E4%B8%8B.md/"><span></span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 28280 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>