<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>08 å®‰å…¨é‡ç‚¹ è®¤è¯å’Œæˆæƒ | Yipsen Ye</title>
<meta name="description" content="æœ¬èŠ‚æˆ‘ä»¬å°†å¼€å§‹å­¦ä¹ å°† K8S åº”ç”¨äºç”Ÿäº§ç¯å¢ƒä¸­è‡³å…³é‡è¦çš„ä¸€ç¯ï¼Œæƒé™æ§åˆ¶ã€‚å½“ç„¶ï¼Œä¸ä»…æ˜¯ K8S å¯¹äºä»»ä½•åº”ç”¨äºç”Ÿäº§ç¯å¢ƒä¸­çš„ç³»ç»Ÿï¼Œæƒé™ç®¡ç†æˆ–è€…è¯´è®¿é—®æ§åˆ¶éƒ½æ˜¯å¾ˆé‡è¦çš„ã€‚
æ•´ä½“æ¦‚è§ˆ é€šè¿‡å‰é¢çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ K8S ä¸­å‡ ä¹æ‰€æœ‰çš„æ“ä½œéƒ½éœ€è¦ç»è¿‡ kube-apiserver å¤„ç†ï¼Œæ‰€ä»¥ä¸ºäº†å®‰å…¨èµ·è§ï¼ŒK8S ä¸ºå®ƒæä¾›äº†ä¸‰ç±»å®‰å…¨è®¿é—®çš„æªæ–½ã€‚åˆ†åˆ«æ˜¯ï¼šç”¨äºè¯†åˆ«ç”¨æˆ·èº«ä»½çš„è®¤è¯ï¼ˆAuthenticationï¼‰ï¼Œç”¨äºæ§åˆ¶ç”¨æˆ·å¯¹èµ„æºè®¿é—®çš„æˆæƒï¼ˆAuthorizationï¼‰ä»¥åŠç”¨äºèµ„æºç®¡ç†æ–¹é¢çš„å‡†å…¥æ§åˆ¶ï¼ˆAdmission Controlï¼‰ã€‚
ä¸‹é¢çš„å›¾åŸºæœ¬å±•ç¤ºäº†è¿™ä¸€è¿‡ç¨‹ã€‚æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚åˆ†åˆ«ç»è¿‡è®¤è¯ï¼Œæˆæƒï¼Œå‡†å…¥æ§åˆ¶ä¹‹åï¼Œæ‰èƒ½çœŸæ­£æ‰§è¡Œã€‚
å½“ç„¶ï¼Œè¿™é‡Œè¯´åŸºæœ¬å±•ç¤ºæ˜¯å› ä¸ºæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ kubectl proxy çš„æ–¹å¼ç›´æ¥é€šè¿‡ HTTP è¯·æ±‚è®¿é—® kube-apiserver è€Œæ— éœ€ä»»ä½•è®¤è¯è¿‡ç¨‹ã€‚
å¦å¤–ï¼Œä¹Ÿå¯é€šè¿‡åœ¨ kube-apiserver æ‰€å¯åŠ¨çš„æœºå™¨ä¸Šï¼Œç›´æ¥è®¿é—®å¯åŠ¨æ—¶ --insecure-port å‚æ•°é…ç½®çš„ç«¯å£è¿›è¡Œç»•è¿‡è®¤è¯å’Œæˆæƒï¼Œé»˜è®¤æ˜¯ 8080ã€‚ä¸ºäº†é¿å…å®‰å…¨é—®é¢˜ï¼Œä¹Ÿå¯å°†æ­¤å‚æ•°è®¾ç½®ä¸º 0 ä»¥è§„é¿é—®é¢˜ã€‚æ³¨æ„ï¼šè¿™ä¸ªå‚æ•°å’Œ --insecure-bind-address éƒ½å·²è¿‡æœŸï¼Œå¹¶å°†åœ¨æœªæ¥çš„ç‰ˆæœ¬ç§»é™¤ã€‚
&#43;-----------------------------------------------------------------------------------------------------------&#43; | | | &#43;---------------------------------------------------------------------------&#43; &#43;--------&#43; | | | | | | | | &#43;--------&#43; | &#43;------------------&#43; &#43;----------------&#43; &#43;--------------&#43; &#43;------&#43; | | | | | | | | | | | | | Admission | | | | | | | | | Client &#43;------&amp;gt; | Authentication &#43;-&amp;gt; | Authorization &#43;-&amp;gt; | Control &#43;-&amp;gt; |Logic | &#43;--&amp;gt; | Others | | | | | | | | | | | | | | | | | | | &#43;--------&#43; | &#43;------------------&#43; &#43;----------------&#43; &#43;--------------&#43; &#43;------&#43; | | | | | | | | | | | | | | | | | | Kube-apiserver | | | | | &#43;---------------------------------------------------------------------------&#43; &#43;--------&#43; | | | &#43;-----------------------------------------------------------------------------------------------------------&#43; è®¤è¯ï¼ˆAuthenticationï¼‰ è®¤è¯ï¼Œæ— éæ˜¯åˆ¤æ–­å½“å‰å‘èµ·è¯·æ±‚çš„ç”¨æˆ·èº«ä»½æ˜¯å¦æ­£ç¡®ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬é€šå¸¸ç™»å½•æœåŠ¡å™¨æ—¶å€™éœ€è¦è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œæˆ–è€… SSH Keys ä¹‹ç±»çš„ã€‚">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/kubernetes%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/">Kubernetesä»ä¸Šæ‰‹åˆ°å®è·µ</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/01-%E5%BC%80%E7%AF%87-kubernetes-%E6%98%AF%E4%BB%80%E4%B9%88%E4%BB%A5%E5%8F%8A%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%AE%83/">01 å¼€ç¯‡ï¼š Kubernetes æ˜¯ä»€ä¹ˆä»¥åŠä¸ºä»€ä¹ˆéœ€è¦å®ƒ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/02-%E5%88%9D%E6%AD%A5%E8%AE%A4%E8%AF%86kubernetes-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/">02 åˆæ­¥è®¤è¯†ï¼šKubernetes åŸºç¡€æ¦‚å¿µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/03-%E5%AE%8F%E8%A7%82%E8%AE%A4%E8%AF%86%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84/">03 å®è§‚è®¤è¯†ï¼šæ•´ä½“æ¶æ„</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/04-%E6%90%AD%E5%BB%BA-kubernetes-%E9%9B%86%E7%BE%A4-%E6%9C%AC%E5%9C%B0%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA/">04 æ­å»º Kubernetes é›†ç¾¤ - æœ¬åœ°å¿«é€Ÿæ­å»º</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/05-%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA-kubernetes-%E9%9B%86%E7%BE%A4-%E7%94%9F%E4%BA%A7%E5%8F%AF%E7%94%A8/">05 åŠ¨æ‰‹å®è·µï¼šæ­å»ºä¸€ä¸ª Kubernetes é›†ç¾¤ - ç”Ÿäº§å¯ç”¨</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/06-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%88%9D%E8%AF%86-kubectl/">06 é›†ç¾¤ç®¡ç†ï¼šåˆè¯† kubectl</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/07-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E4%BB%A5-redis-%E4%B8%BA%E4%BE%8B-%E9%83%A8%E7%BD%B2%E5%8F%8A%E8%AE%BF%E9%97%AE/">07 é›†ç¾¤ç®¡ç†ï¼šä»¥ Redis ä¸ºä¾‹-éƒ¨ç½²åŠè®¿é—®</a></li>
                
                
                
                    <li>08 å®‰å…¨é‡ç‚¹ è®¤è¯å’Œæˆæƒ</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/09-%E5%BA%94%E7%94%A8%E5%8F%91%E5%B8%83%E9%83%A8%E7%BD%B2%E5%AE%9E%E9%99%85%E9%A1%B9%E7%9B%AE/">09 åº”ç”¨å‘å¸ƒï¼šéƒ¨ç½²å®é™…é¡¹ç›®</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/10-%E5%BA%94%E7%94%A8%E7%AE%A1%E7%90%86%E5%88%9D%E8%AF%86-helm/">10 åº”ç”¨ç®¡ç†ï¼šåˆè¯† Helm</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/11-%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5%E4%BB%A5-helm-%E9%83%A8%E7%BD%B2%E9%A1%B9%E7%9B%AE/">11 éƒ¨ç½²å®è·µï¼šä»¥ Helm éƒ¨ç½²é¡¹ç›®</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/12-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bkube-apiserver/">12 åº–ä¸è§£ç‰›ï¼škube-apiserver</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/13-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Betcd/">13 åº–ä¸è§£ç‰›ï¼šetcd</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/14-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bcontroller-manager/">14 åº–ä¸è§£ç‰›ï¼šcontroller-manager</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/15-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bkube-scheduler/">15 åº–ä¸è§£ç‰›ï¼škube-scheduler</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/16-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bkubelet/">16 åº–ä¸è§£ç‰›ï¼škubelet</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/17-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bkube-proxy/">17 åº–ä¸è§£ç‰›ï¼škube-proxy</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/18-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bcontainer-runtime-docker/">18 åº–ä¸è§£ç‰›ï¼šContainer Runtime ï¼ˆDockerï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/19-troubleshoot/">19 Troubleshoot</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/20-%E6%89%A9%E5%B1%95%E5%A2%9E%E5%BC%BAdashboard/">20 æ‰©å±•å¢å¼ºï¼šDashboard</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/21-%E6%89%A9%E5%B1%95%E5%A2%9E%E5%BC%BAcoredns/">21 æ‰©å±•å¢å¼ºï¼šCoreDNS</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/22-%E6%9C%8D%E5%8A%A1%E5%A2%9E%E5%BC%BAingress/">22 æœåŠ¡å¢å¼ºï¼šIngress</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/23-%E7%9B%91%E6%8E%A7%E5%AE%9E%E8%B7%B5%E5%AF%B9-k8s-%E9%9B%86%E7%BE%A4%E8%BF%9B%E8%A1%8C%E7%9B%91%E6%8E%A7/">23 ç›‘æ§å®è·µï¼šå¯¹ K8S é›†ç¾¤è¿›è¡Œç›‘æ§</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/24-%E6%80%BB%E7%BB%93/">24 æ€»ç»“</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">08 å®‰å…¨é‡ç‚¹ è®¤è¯å’Œæˆæƒ</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2021-12-22 01:47:34</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/kubernetes/">kubernetes</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/">Kubernetesä»ä¸Šæ‰‹åˆ°å®è·µ</a>
                
            </div></div>
        <div class="post-content">
            <p>æœ¬èŠ‚æˆ‘ä»¬å°†å¼€å§‹å­¦ä¹ å°† K8S åº”ç”¨äºç”Ÿäº§ç¯å¢ƒä¸­è‡³å…³é‡è¦çš„ä¸€ç¯ï¼Œæƒé™æ§åˆ¶ã€‚å½“ç„¶ï¼Œä¸ä»…æ˜¯ K8S å¯¹äºä»»ä½•åº”ç”¨äºç”Ÿäº§ç¯å¢ƒä¸­çš„ç³»ç»Ÿï¼Œæƒé™ç®¡ç†æˆ–è€…è¯´è®¿é—®æ§åˆ¶éƒ½æ˜¯å¾ˆé‡è¦çš„ã€‚</p>
<h2 id="æ•´ä½“æ¦‚è§ˆ">æ•´ä½“æ¦‚è§ˆ</h2>
<p>é€šè¿‡å‰é¢çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ K8S ä¸­å‡ ä¹æ‰€æœ‰çš„æ“ä½œéƒ½éœ€è¦ç»è¿‡ <code>kube-apiserver</code> å¤„ç†ï¼Œæ‰€ä»¥ä¸ºäº†å®‰å…¨èµ·è§ï¼ŒK8S ä¸ºå®ƒæä¾›äº†ä¸‰ç±»å®‰å…¨è®¿é—®çš„æªæ–½ã€‚åˆ†åˆ«æ˜¯ï¼šç”¨äºè¯†åˆ«ç”¨æˆ·èº«ä»½çš„è®¤è¯ï¼ˆAuthenticationï¼‰ï¼Œç”¨äºæ§åˆ¶ç”¨æˆ·å¯¹èµ„æºè®¿é—®çš„æˆæƒï¼ˆAuthorizationï¼‰ä»¥åŠç”¨äºèµ„æºç®¡ç†æ–¹é¢çš„å‡†å…¥æ§åˆ¶ï¼ˆAdmission Controlï¼‰ã€‚</p>
<p>ä¸‹é¢çš„å›¾åŸºæœ¬å±•ç¤ºäº†è¿™ä¸€è¿‡ç¨‹ã€‚æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚åˆ†åˆ«ç»è¿‡è®¤è¯ï¼Œæˆæƒï¼Œå‡†å…¥æ§åˆ¶ä¹‹åï¼Œæ‰èƒ½çœŸæ­£æ‰§è¡Œã€‚</p>
<p>å½“ç„¶ï¼Œè¿™é‡Œè¯´<strong>åŸºæœ¬å±•ç¤º</strong>æ˜¯å› ä¸ºæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ <code>kubectl proxy</code> çš„æ–¹å¼ç›´æ¥é€šè¿‡ HTTP è¯·æ±‚è®¿é—® <code>kube-apiserver</code> è€Œæ— éœ€ä»»ä½•è®¤è¯è¿‡ç¨‹ã€‚</p>
<p>å¦å¤–ï¼Œä¹Ÿå¯é€šè¿‡åœ¨ <code>kube-apiserver</code> æ‰€å¯åŠ¨çš„æœºå™¨ä¸Šï¼Œç›´æ¥è®¿é—®å¯åŠ¨æ—¶ <code>--insecure-port</code> å‚æ•°é…ç½®çš„ç«¯å£è¿›è¡Œç»•è¿‡è®¤è¯å’Œæˆæƒï¼Œé»˜è®¤æ˜¯ 8080ã€‚ä¸ºäº†é¿å…å®‰å…¨é—®é¢˜ï¼Œä¹Ÿå¯å°†æ­¤å‚æ•°è®¾ç½®ä¸º 0 ä»¥è§„é¿é—®é¢˜ã€‚æ³¨æ„ï¼šè¿™ä¸ªå‚æ•°å’Œ <code>--insecure-bind-address</code> éƒ½å·²è¿‡æœŸï¼Œå¹¶å°†åœ¨æœªæ¥çš„ç‰ˆæœ¬ç§»é™¤ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">+-----------------------------------------------------------------------------------------------------------+
|                                                                                                           |
|               +---------------------------------------------------------------------------+    +--------+ |
|               |                                                                           |    |        | |
| +--------+    |   +------------------+   +----------------+   +--------------+   +------+ |    |        | |
| |        |    |   |                  |   |                |   | Admission    |   |      | |    |        | |
| | Client +------&gt; | Authentication   +-&gt; | Authorization  +-&gt; | Control      +-&gt; |Logic | +--&gt; | Others | |
| |        |    |   |                  |   |                |   |              |   |      | |    |        | |
| +--------+    |   +------------------+   +----------------+   +--------------+   +------+ |    |        | |
|               |                                                                           |    |        | |
|               |                                                                           |    |        | |
|               |                          Kube-apiserver                                   |    |        | |
|               +---------------------------------------------------------------------------+    +--------+ |
|                                                                                                           |
+-----------------------------------------------------------------------------------------------------------+
</code></pre></div><h2 id="è®¤è¯authentication">è®¤è¯ï¼ˆAuthenticationï¼‰</h2>
<p>è®¤è¯ï¼Œæ— éæ˜¯åˆ¤æ–­å½“å‰å‘èµ·è¯·æ±‚çš„ç”¨æˆ·èº«ä»½æ˜¯å¦æ­£ç¡®ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬é€šå¸¸ç™»å½•æœåŠ¡å™¨æ—¶å€™éœ€è¦è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œæˆ–è€… SSH Keys ä¹‹ç±»çš„ã€‚</p>
<p>åœ¨è®²è®¤è¯å‰ï¼Œæˆ‘ä»¬åº”è¯¥å…ˆç†ä¸€ä¸‹ K8S ä¸­çš„ç”¨æˆ·ã€‚</p>
<p>K8S ä¸­æœ‰ä¸¤ç±»ç”¨æˆ·ï¼Œä¸€èˆ¬ç”¨æˆ·åŠ <code>Service Account</code>ã€‚</p>
<ul>
<li>ä¸€èˆ¬ç”¨æˆ·ï¼šä¸€èˆ¬ç”¨æˆ·åªèƒ½é€šè¿‡å¤–éƒ¨æœåŠ¡è¿›è¡Œç®¡ç†ï¼Œç”±ç®¡ç†å‘˜è¿›è¡Œç§é’¥åˆ†å‘ã€‚è¿™ä¹Ÿæ„å‘³ç€ K8S ä¸­å¹¶æ²¡æœ‰ä»»ä½•è¡¨ç¤ºä¸€èˆ¬ç”¨æˆ·çš„å¯¹è±¡ï¼Œæ‰€ä»¥ä¸€èˆ¬ç”¨æˆ·æ˜¯æ— æ³•é€šè¿‡ API ç›´æ¥æ·»åŠ åˆ°é›†ç¾¤çš„ã€‚</li>
<li><code>Service Account</code>ï¼šç”± K8S API ç®¡ç†çš„ç”¨æˆ·ï¼Œä¸ç‰¹å®šçš„ <code>NameSpace</code>ï¼ˆå‘½åç©ºé—´ï¼‰ç»‘å®šã€‚ç”± <code>API Server</code> è‡ªåŠ¨åˆ›å»ºæˆ–è€…é€šè¿‡ API æ‰‹åŠ¨è¿›è¡Œåˆ›å»ºã€‚ åŒæ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨æŒ‚è½½åˆ° <code>Pod</code> ä¸­å®¹å™¨çš„ <code>/var/run/secrets/kubernetes.io/serviceaccount/</code> ç›®å½•ä¸­ï¼Œå…¶ä¸­ä¼šåŒ…å« <code>NameSpace</code> <code>token</code> ç­‰ä¿¡æ¯ï¼Œå¹¶å…è®¸é›†ç¾¤å†…è¿›ç¨‹ä¸ <code>API Server</code> è¿›è¡Œäº¤äº’ã€‚</li>
</ul>
<p>å¯¹é›†ç¾¤æ“ä½œçš„ API éƒ½æ˜¯ä¸ç”¨æˆ·ç›¸å…³è”çš„ï¼Œæˆ–è€…è¢«è§†ä¸ºåŒ¿åè¯·æ±‚ã€‚åŒ¿åè¯·æ±‚å¯é€šè¿‡ <code>kube-apiserver</code> çš„ <code>--anonymous-auth</code> å‚æ•°è¿›è¡Œæ§åˆ¶ï¼Œé»˜è®¤æ˜¯å¼€å¯çš„ï¼ŒåŒ¿åç”¨æˆ·é»˜è®¤çš„ç”¨æˆ·åä¸º <code>system:anonymous</code>ï¼Œæ‰€å±ç»„ä¸º <code>system:unauthenticated</code>ã€‚</p>
<p>ç†å®Œ K8S ä¸­çš„ç”¨æˆ·ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ K8S ä¸­çš„è®¤è¯æœºåˆ¶ã€‚</p>
<p>K8S æ”¯æŒä»¥ä¸‹è®¤è¯æœºåˆ¶ï¼š</p>
<ul>
<li>X509 å®¢æˆ·ç«¯è¯ä¹¦ï¼šè¿™ä¸ªè®¤è¯æœºåˆ¶æˆ‘ä»¬å¹¶ä¸é™Œç”Ÿï¼Œæˆ‘ä»¬å‰é¢æ­å»ºé›†ç¾¤æ—¶ï¼Œè™½ç„¶æ²¡æœ‰æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œä½† <code>kubeadm</code> å·²ç»æ·»åŠ äº†é»˜è®¤å‚æ•° <code>--client-ca-file=/etc/kubernetes/pki/ca.crt</code> è€Œåœ¨è¿›è¡Œè®¤è¯æ—¶ï¼Œå°†ä¼šä½¿ç”¨å®¢æˆ·ç«¯è¯ä¹¦ subject çš„ <code>CN</code> åŸŸï¼ˆCommon Nameï¼‰ç”¨ä½œç”¨æˆ·åï¼Œ<code>O</code> åŸŸï¼ˆOrganizationï¼‰ç”¨ä½œç»„åã€‚</li>
<li>å¼•å¯¼ Tokenï¼šè¿™ä¸ªæˆ‘ä»¬ä¹Ÿä¸ä¼šé™Œç”Ÿï¼Œå‰é¢æˆ‘ä»¬æ­å»ºé›†ç¾¤æ—¶ï¼Œå½“é›†ç¾¤é€šè¿‡ <code>kubeadm init</code> åˆå§‹åŒ–å®Œæˆåï¼Œå°†ä¼šå±•ç¤ºä¸€è¡Œæç¤ºï¼Œå…¶ä¸­ä¾¿æºå¸¦ç€å¼•å¯¼ Tokenã€‚å¦‚æœä¸ä½¿ç”¨ <code>kubeadm</code> æ—¶ï¼Œéœ€è¦è®¾ç½® <code>--enable-bootstrap-token-auth=true</code>ã€‚</li>
<li>é™æ€ Token æ–‡ä»¶ï¼šå¯åŠ¨ <code>Kube-apiserver</code> æ—¶ï¼Œè®¾ç½® <code>--token-auth-file=SOMEFILE</code> å¹¶åœ¨è¯·æ±‚æ—¶ï¼ŒåŠ ä¸Š <code>Authorization: Bearer TOKEN</code> çš„è¯·æ±‚å¤´å³å¯ã€‚</li>
<li>é™æ€å¯†ç æ–‡ä»¶ï¼šä¸é™æ€ Token æ–‡ä»¶ç±»ä¼¼ï¼Œè®¾ç½® <code>--basic-auth-file=SOMEFILE</code> å¹¶åœ¨è¯·æ±‚æ—¶ï¼ŒåŠ ä¸Š <code>Authorization: Basic BASE64ENCODED(USER:PASSWORD)</code> çš„å¤´å³å¯ã€‚</li>
<li>Service Account Tokenï¼šè¿™æ˜¯é»˜è®¤å¯ç”¨çš„æœºåˆ¶ï¼Œå…³äº <code>Service Account</code> å‰é¢ä¹Ÿå·²ç»ä»‹ç»è¿‡äº†ï¼Œä¸å†èµ˜è¿°ã€‚</li>
<li>OpenIDï¼šå…¶å®æ˜¯æä¾›äº† <a href="https://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html">OAuth2</a> çš„è®¤è¯æ”¯æŒï¼Œåƒ Azure æˆ– Google è¿™ç±»äº‘å‚å•†éƒ½æä¾›äº†ç›¸å…³æ”¯æŒã€‚</li>
<li>è®¤è¯ä»£ç†ï¼šä¸»è¦æ˜¯é…åˆèº«ä»½éªŒè¯ä»£ç†è¿›è¡Œä½¿ç”¨ï¼Œæ¯”å¦‚æä¾›ä¸€ä¸ªé€šç”¨çš„æˆæƒç½‘å…³ä¾›ç”¨æˆ·ä½¿ç”¨ã€‚</li>
<li>Webhookï¼šæä¾› Webhook é…åˆä¸€ä¸ªè¿œç«¯æœåŠ¡å™¨ä½¿ç”¨ã€‚</li>
</ul>
<p>å¯é€‰æ‹©åŒæ—¶å¼€å¯å¤šä¸ªè®¤è¯æœºåˆ¶ã€‚æ¯”å¦‚å½“æˆ‘ä»¬ä½¿ç”¨ <code>kubeadm</code> åˆ›å»ºé›†ç¾¤æ—¶ï¼Œé»˜è®¤ä¾¿ä¼šå¼€å¯ X509 å®¢æˆ·ç«¯è¯ä¹¦å’Œå¼•å¯¼ Token ç­‰è®¤è¯æœºåˆ¶ã€‚</p>
<h2 id="æˆæƒauthorization">æˆæƒï¼ˆAuthorizationï¼‰</h2>
<p>æˆæƒï¼Œä¹Ÿå°±æ˜¯åœ¨éªŒè¯å½“å‰å‘èµ·è¯·æ±‚çš„ç”¨æˆ·æ˜¯å¦æœ‰ç›¸å…³çš„æƒé™ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨ Linux ç³»ç»Ÿä¸­å¸¸è§çš„æ–‡ä»¶å¤¹æƒé™ä¹‹ç±»çš„ã€‚</p>
<p>æˆæƒæ˜¯ä»¥è®¤è¯çš„ç»“æœä¸ºåŸºç¡€çš„ï¼Œæˆæƒæœºåˆ¶æ£€æŸ¥ç”¨æˆ·é€šè¿‡è®¤è¯åçš„è¯·æ±‚ä¸­æ‰€åŒ…å«çš„å±æ€§æ¥è¿›è¡Œåˆ¤æ–­ã€‚</p>
<p>K8S æ”¯æŒå¤šç§æˆæƒæœºåˆ¶ï¼Œç”¨æˆ·æƒ³è¦æ­£ç¡®æ“ä½œèµ„æºï¼Œåˆ™å¿…é¡»è·å¾—æˆæƒï¼Œæ‰€ä»¥ K8S é»˜è®¤æƒ…å†µä¸‹çš„æƒé™éƒ½æ˜¯æ‹’ç»ã€‚å½“æŸç§æˆæƒæœºåˆ¶é€šè¿‡æˆ–è€…æ‹’ç»åï¼Œä¾¿ä¼šç«‹å³è¿”å›ï¼Œä¸å†å»è¯·æ±‚å…¶ä»–çš„æˆæƒæœºåˆ¶ï¼›å½“æ‰€æœ‰æˆæƒæœºåˆ¶éƒ½æœªé€šè¿‡æ—¶ä¾¿ä¼šè¿”å› 403 é”™è¯¯äº†ã€‚</p>
<p>K8S æ”¯æŒä»¥ä¸‹æˆæƒæœºåˆ¶ï¼š</p>
<ul>
<li>ABAC(Attribute-Based Access Control)ï¼šåŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼Œåœ¨ä½¿ç”¨æ—¶éœ€è¦å…ˆé…ç½® <code>--authorization-mode=ABAC</code> å’Œ <code>--authorization-policy-file=SOME_FILENAME</code> ã€‚ABAC æœ¬èº«è®¾è®¡æ˜¯éå¸¸å¥½çš„ï¼Œä½†æ˜¯åœ¨ K8S ä¸­ä½¿ç”¨å´æœ‰ç‚¹è¿‡äºç¹çï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</li>
<li>RBAC(Role-based access control)ï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼Œè‡ª K8S 1.6 å¼€å§‹ betaï¼Œ1.8 è¿›å…¥ç¨³å®šç‰ˆï¼Œå·²è¢«å¤§é‡ä½¿ç”¨ã€‚è€Œå½“æˆ‘ä»¬ä½¿ç”¨ <code>kubeadm</code> å®‰è£…é›†ç¾¤çš„æ—¶å€™ï¼Œé»˜è®¤å°†ä¼šæ·»åŠ  <code>--authorization-mode=Node,RBAC</code> çš„å‚æ•°ï¼Œè¡¨ç¤ºåŒæ—¶å¼€å¯ <code>Node</code> å’Œ <code>RBAC</code> æˆæƒæœºåˆ¶ã€‚å½“ç„¶ï¼Œå¦‚æœä½ å¯¹ <a href="https://www.mongodb.com/cn">MongoDB</a> æœ‰æ‰€äº†è§£æˆ–è€…æ¯”è¾ƒç†Ÿæ‚‰çš„è¯ï¼Œè¿™éƒ¨åˆ†çš„å†…å®¹å°±ä¼šå¾ˆå®¹æ˜“ç†è§£ï¼Œå› ä¸º MongoDB çš„æƒé™æ§åˆ¶ä¹Ÿä½¿ç”¨äº† <code>RBAC</code> ï¼ˆRole-based access controlï¼‰ã€‚</li>
<li>Nodeï¼šè¿™æ˜¯ä¸€ç§ç‰¹æ®Šç”¨é€”çš„æˆæƒæœºåˆ¶ï¼Œä¸“é—¨ç”¨äºå¯¹ <code>kubelet</code> å‘å‡ºçš„ API è¯·æ±‚åšæˆæƒéªŒè¯ã€‚</li>
<li>Webhookï¼šä½¿ç”¨å¤–éƒ¨çš„ Server é€šè¿‡ API è¿›è¡Œæˆæƒæ ¡éªŒï¼Œéœ€è¦åœ¨å¯åŠ¨æ—¶å€™å¢åŠ  <code>--authorization-webhook-config-file=SOME_FILENAME</code> ä»¥åŠ <code>--authorization-mode=Webhook</code></li>
<li>AlwaysAllowï¼šé»˜è®¤é…ç½®ï¼Œå…è®¸å…¨éƒ¨ã€‚</li>
<li>AlwaysDenyï¼šé€šå¸¸ç”¨äºæµ‹è¯•ï¼Œç¦æ­¢å…¨éƒ¨ã€‚</li>
</ul>
<h2 id="è§’è‰²role">è§’è‰²ï¼ˆRoleï¼‰</h2>
<p>ä¸Šé¢æåˆ°äº† <code>RBAC</code>ï¼Œä¸ºäº†èƒ½æ›´å¥½çš„ç†è§£ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè®¤è¯†ä¸‹ K8S ä¸­çš„è§’è‰²ã€‚K8S ä¸­çš„è§’è‰²ä»ç±»åˆ«ä¸Šä¸»è¦æœ‰ä¸¤ç±»ï¼Œ<code>Role</code> å’Œ <code>ClusterRole</code>ã€‚</p>
<ul>
<li><code>Role</code>ï¼šå¯ä»¥å½“ä½œæ˜¯ä¸€ç»„æƒé™çš„é›†åˆï¼Œä½†è¢«é™åˆ¶åœ¨æŸä¸ª <code>Namespace</code> å†…ï¼ˆK8S çš„ <code>Namespace</code>ï¼‰ã€‚</li>
<li><code>ClusterRole</code>ï¼šå¯¹äºé›†ç¾¤çº§åˆ«çš„èµ„æºæ˜¯ä¸è¢« <code>Namespace</code> æ‰€é™åˆ¶çš„ï¼Œå¹¶ä¸”è¿˜æœ‰ä¸€äº›éèµ„æºç±»çš„è¯·æ±‚ï¼Œæ‰€ä»¥ä¾¿äº§ç”Ÿäº†å®ƒã€‚</li>
</ul>
<p>å½“å·²ç»äº†è§£åˆ°è§’è‰²åï¼Œå‰©ä¸‹ç»™ç”¨æˆ·æˆæƒä¹Ÿå°±åªæ˜¯éœ€è¦åšä¸€æ¬¡ç»‘å®šå³å¯ã€‚åœ¨ K8S ä¸­å°†è¿™ä¸€è¿‡ç¨‹ç§°ä¹‹ä¸º bindingï¼Œå³ <code>rolebinding</code> å’Œ <code>clusterrolebinding</code>ã€‚ æˆ‘ä»¬æ¥çœ‹ä¸‹é›†ç¾¤åˆšåˆå§‹åŒ–åçš„æƒ…å†µï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">âœ  ~ kubectl get roles --all-namespaces<span style="color:#f92672">=</span>true
NAMESPACE     NAME                                             AGE
kube-public   kubeadm:bootstrap-signer-clusterinfo             1h
kube-public   system:controller:bootstrap-signer               1h
kube-system   extension-apiserver-authentication-reader        1h
kube-system   kube-proxy                                       1h
kube-system   kubeadm:kubelet-config-1.12                      1h
kube-system   kubeadm:nodes-kubeadm-config                     1h
kube-system   system::leader-locking-kube-controller-manager   1h
kube-system   system::leader-locking-kube-scheduler            1h
kube-system   system:controller:bootstrap-signer               1h
kube-system   system:controller:cloud-provider                 1h
kube-system   system:controller:token-cleaner                  1h
âœ  ~ kubectl get rolebindings --all-namespaces<span style="color:#f92672">=</span>true
NAMESPACE     NAME                                             AGE
kube-public   kubeadm:bootstrap-signer-clusterinfo             1h
kube-public   system:controller:bootstrap-signer               1h
kube-system   kube-proxy                                       1h
kube-system   kubeadm:kubelet-config-1.12                      1h
kube-system   kubeadm:nodes-kubeadm-config                     1h
kube-system   system::leader-locking-kube-controller-manager   1h
kube-system   system::leader-locking-kube-scheduler            1h
kube-system   system:controller:bootstrap-signer               1h
kube-system   system:controller:cloud-provider                 1h
kube-system   system:controller:token-cleaner                  1h
</code></pre></div><p>å¯ä»¥çœ‹åˆ°é»˜è®¤å·²ç»å­˜åœ¨äº†ä¸€äº› <code>role</code> å’Œ <code>rolebindings</code>ã€‚ å¯¹äºè¿™éƒ¨åˆ†æš‚ä¸”ä¸åšè¿‡å¤šè¯´æ˜ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å¯¹äºé›†ç¾¤å…¨å±€æœ‰æ•ˆçš„ <code>ClusterRole</code> ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">âœ  ~ kubectl get clusterroles
NAME                                                                   AGE
admin                                                                  1h
cluster-admin                                                          1h
edit                                                                   1h
flannel                                                                1h
system:aggregate-to-admin                                              1h
system:aggregate-to-edit                                               1h
system:aggregate-to-view                                               1h
system:auth-delegator                                                  1h
system:aws-cloud-provider                                              1h
system:basic-user                                                      1h
system:certificates.k8s.io:certificatesigningrequests:nodeclient       1h
system:certificates.k8s.io:certificatesigningrequests:selfnodeclient   1h
system:controller:attachdetach-controller                              1h
system:controller:certificate-controller                               1h
system:controller:clusterrole-aggregation-controller                   1h
system:controller:cronjob-controller                                   1h
system:controller:daemon-set-controller                                1h
system:controller:deployment-controller                                1h
system:controller:disruption-controller                                1h
system:controller:endpoint-controller                                  1h
system:controller:expand-controller                                    1h
system:controller:generic-garbage-collector                            1h
system:controller:horizontal-pod-autoscaler                            1h
system:controller:job-controller                                       1h
system:controller:namespace-controller                                 1h
system:controller:node-controller                                      1h
system:controller:persistent-volume-binder                             1h
system:controller:pod-garbage-collector                                1h
system:controller:pv-protection-controller                             1h
system:controller:pvc-protection-controller                            1h
system:controller:replicaset-controller                                1h
system:controller:replication-controller                               1h
system:controller:resourcequota-controller                             1h
system:controller:route-controller                                     1h
system:controller:service-account-controller                           1h
system:controller:service-controller                                   1h
system:controller:statefulset-controller                               1h
system:controller:ttl-controller                                       1h
system:coredns                                                         1h
system:csi-external-attacher                                           1h
system:csi-external-provisioner                                        1h
system:discovery                                                       1h
system:heapster                                                        1h
system:kube-aggregator                                                 1h
system:kube-controller-manager                                         1h
system:kube-dns                                                        1h
system:kube-scheduler                                                  1h
system:kubelet-api-admin                                               1h
system:node                                                            1h
system:node-bootstrapper                                               1h
system:node-problem-detector                                           1h
system:node-proxier                                                    1h
system:persistent-volume-provisioner                                   1h
system:volume-scheduler                                                1h
view                                                                   1h
âœ  ~ kubectl get clusterrolebindings
NAME                                                   AGE
cluster-admin                                          1h
flannel                                                1h
kubeadm:kubelet-bootstrap                              1h
kubeadm:node-autoapprove-bootstrap                     1h
kubeadm:node-autoapprove-certificate-rotation          1h
kubeadm:node-proxier                                   1h
system:aws-cloud-provider                              1h
system:basic-user                                      1h
system:controller:attachdetach-controller              1h
system:controller:certificate-controller               1h
system:controller:clusterrole-aggregation-controller   1h
system:controller:cronjob-controller                   1h
system:controller:daemon-set-controller                1h
system:controller:deployment-controller                1h
system:controller:disruption-controller                1h
system:controller:endpoint-controller                  1h
system:controller:expand-controller                    1h
system:controller:generic-garbage-collector            1h
system:controller:horizontal-pod-autoscaler            1h
system:controller:job-controller                       1h
system:controller:namespace-controller                 1h
system:controller:node-controller                      1h
system:controller:persistent-volume-binder             1h
system:controller:pod-garbage-collector                1h
system:controller:pv-protection-controller             1h
system:controller:pvc-protection-controller            1h
system:controller:replicaset-controller                1h
system:controller:replication-controller               1h
system:controller:resourcequota-controller             1h
system:controller:route-controller                     1h
system:controller:service-account-controller           1h
system:controller:service-controller                   1h
system:controller:statefulset-controller               1h
system:controller:ttl-controller                       1h
system:coredns                                         1h
system:discovery                                       1h
system:kube-controller-manager                         1h
system:kube-dns                                        1h
system:kube-scheduler                                  1h
system:node                                            1h
system:node-proxier                                    1h
system:volume-scheduler                                1h
</code></pre></div><p>å¯ä»¥çœ‹åˆ° K8S ä¸­é»˜è®¤å·²ç»æœ‰å¾ˆå¤šçš„ <code>ClusterRole</code> å’Œ <code>clusterrolebindings</code> äº†ï¼Œæˆ‘ä»¬é€‰æ‹©å…¶ä¸­ä¸€ä¸ªåšä¸‹æ¢ç©¶ã€‚</p>
<h2 id="æŸ¥çœ‹ç”¨æˆ·æƒé™">æŸ¥çœ‹ç”¨æˆ·æƒé™</h2>
<p>æˆ‘ä»¬ä¸€ç›´éƒ½åœ¨ä½¿ç”¨ <code>kubectl</code> å¯¹é›†ç¾¤è¿›è¡Œæ“ä½œï¼Œé‚£ä¹ˆå½“å‰ç”¨æˆ·æ˜¯ä»€ä¹ˆæƒé™å‘¢ï¼Ÿ å¯¹åº”äº <code>RBAC</code> ä¸­åˆæ˜¯ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">âœ  ~ kubectl config current-context   <span style="color:#75715e"># è·å–å½“å‰ä¸Šä¸‹æ–‡</span>
kubernetes-admin@kubernetes  <span style="color:#75715e"># åä¸º kubernetes-admin çš„ç”¨æˆ·ï¼Œåœ¨åä¸º kubernetes çš„ cluster ä¸Š</span>
âœ  ~ kubectl config view users -o yaml  <span style="color:#75715e"># æŸ¥çœ‹ user é…ç½®ï¼Œä»¥ä¸‹çœç•¥äº†éƒ¨åˆ†å†…å®¹</span>
apiVersion: v1
clusters:                                   
- cluster:                            
    ...
contexts:                    
- context:  
    cluster: kubernetes
    user: kubernetes-admin
  name: kubernetes-admin@kubernetes
current-context: kubernetes-admin@kubernetes
kind: Config
preferences: <span style="color:#f92672">{}</span>
users:
- name: kubernetes-admin
  user:
    client-certificate-data: REDACTED
    client-key-data: REDACTED
</code></pre></div><p><code>client-certificate-data</code> çš„éƒ¨åˆ†é»˜è®¤æ˜¯ä¸æ˜¾ç¤ºçš„ï¼Œè€Œå®ƒçš„<strong>å†…å®¹å®é™…æ˜¯é€šè¿‡ base64 åŠ å¯†åçš„è¯ä¹¦å†…å®¹</strong>ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›è¡ŒæŸ¥çœ‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">âœ  ~ kubectl config view users --raw -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{ .users[?(@.name == &#34;kubernetes-admin&#34;)].user.client-certificate-data}&#39;</span> |base64 -d  
-----BEGIN CERTIFICATE-----
MIIC8jCCAdqgAwIBAgIIGuC27C9B8LIwDQYJKoZIhvcNAQELBQAwFTETMBEGA1UE
...
kae1A/d4D5Cm5Qt7M5gr3SxqE5t+O7DP0YhuEPlfY7RzYDksYa8<span style="color:#f92672">=</span>
-----END CERTIFICATE-----
âœ  ~ kubectl config view users --raw -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{ .users[?(@.name == &#34;kubernetes-admin&#34;)].user.client-certificate-data}&#39;</span> |base64 -d |openssl x509 -text -noout  <span style="color:#75715e"># é™äºç¯‡å¹… çœç•¥éƒ¨åˆ†è¾“å‡º</span>
Certificate:
    Data:
        Version: <span style="color:#ae81ff">3</span> <span style="color:#f92672">(</span>0x2<span style="color:#f92672">)</span>
        Serial Number: <span style="color:#ae81ff">1936748965290700978</span> <span style="color:#f92672">(</span>0x1ae0b6ec2f41f0b2<span style="color:#f92672">)</span>
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN<span style="color:#f92672">=</span>kubernetes
        Subject: O<span style="color:#f92672">=</span>system:masters, CN<span style="color:#f92672">=</span>kubernetes-admin
        ...
</code></pre></div><p>æ ¹æ®å‰é¢è®¤è¯éƒ¨åˆ†çš„å†…å®¹ï¼Œæˆ‘ä»¬çŸ¥é“å½“å‰çš„ç”¨æˆ·æ˜¯ <code>kubernetes-admin</code> ï¼ˆCN åŸŸï¼‰ï¼Œæ‰€å±ç»„æ˜¯ <code>system:masters</code> ï¼ˆO åŸŸï¼‰ ã€‚</p>
<p>æˆ‘ä»¬çœ‹ä¸‹ <code>clusterrolebindings</code> ä¸­çš„ <code>cluster-admin</code> ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">âœ  ~ kubectl get clusterrolebindings  cluster-admin  -o yaml                         
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: <span style="color:#e6db74">&#34;true&#34;</span>
  ...
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: cluster-admin
  resourceVersion: <span style="color:#e6db74">&#34;116&#34;</span>
  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/cluster-admin
  uid: 71c550f1-e0e4-11e8-866a-fa163e938a99
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:masters
</code></pre></div><p>é‡ç‚¹å†…å®¹åœ¨ <code>roleRef</code> å’Œ <code>subjects</code> ä¸­ï¼Œåä¸º <code>cluster-admin</code> çš„ <code>ClusterRole</code> ä¸åä¸º <code>system:masters</code> çš„ <code>Group</code> ç›¸ç»‘å®šã€‚æˆ‘ä»¬ç»§ç»­æ¢ç©¶ä¸‹å®ƒä»¬æ‰€ä»£è¡¨çš„å«ä¹‰ã€‚</p>
<p>å…ˆçœ‹çœ‹è¿™ä¸ª <code>ClusterRole</code> çš„å®é™…å†…å®¹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">âœ  ~ kubectl get clusterrole cluster-admin -o yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: <span style="color:#e6db74">&#34;true&#34;</span>
  ...
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: cluster-admin
  resourceVersion: <span style="color:#e6db74">&#34;58&#34;</span>
  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterroles/cluster-admin
  uid: 71307108-e0e4-11e8-866a-fa163e938a99
rules:
- apiGroups:
  - <span style="color:#e6db74">&#39;*&#39;</span>
  resources:
  - <span style="color:#e6db74">&#39;*&#39;</span>
  verbs:
  - <span style="color:#e6db74">&#39;*&#39;</span>
- nonResourceURLs:
  - <span style="color:#e6db74">&#39;*&#39;</span>
  verbs:
  - <span style="color:#e6db74">&#39;*&#39;</span>
</code></pre></div><p><code>rules</code> ä¸­å®šä¹‰äº†å®ƒæ‰€èƒ½æ“ä½œçš„èµ„æºåŠå¯¹åº”åŠ¨ä½œï¼Œ<code>*</code> æ˜¯é€šé…ç¬¦ã€‚</p>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—å‡ºç»“è®ºäº†ï¼Œå½“å‰ç”¨æˆ· <code>kubernetes-admin</code> å±äº <code>system:masters</code> ç»„ï¼Œè€Œè¿™ä¸ªç»„ä¸ <code>cluster-admin</code> è¿™ä¸ª <code>ClusterRole</code> æ‰€ç»‘å®šï¼Œæ‰€ä»¥ç”¨æˆ·ä¹Ÿå°±ç»§æ‰¿äº†å…¶æƒé™ã€‚å…·å¤‡äº†å¯¹å¤šç§èµ„æºå’Œ API çš„ç›¸å…³æ“ä½œæƒé™ã€‚</p>
<h2 id="å®è·µåˆ›å»ºæƒé™å¯æ§çš„ç”¨æˆ·">å®è·µï¼šåˆ›å»ºæƒé™å¯æ§çš„ç”¨æˆ·</h2>
<p>å‰é¢æ˜¯é€šè¿‡å®é™…ç”¨æˆ·æ¥åæ¨å®ƒæ‰€å…·å¤‡çš„æƒé™ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹å®è·µçš„éƒ¨åˆ†ï¼Œåˆ›å»ºç”¨æˆ·å¹¶ä¸ºå®ƒè¿›è¡Œæˆæƒã€‚</p>
<p>æˆ‘ä»¬è¦åˆ›å»ºçš„ç”¨æˆ·åä¸º <code>backend</code> æ‰€å±ç»„ä¸º <code>dev</code>ã€‚</p>
<h3 id="åˆ›å»º-namespace">åˆ›å»º NameSpace</h3>
<p>ä¸ºäº†æ¼”ç¤ºï¼Œè¿™é‡Œåˆ›å»ºä¸€ä¸ªæ–°çš„ <code>NameSpace</code> ï¼Œåä¸º <code>work</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">âœ  ~ kubectl create namespace work
namespace/work created
âœ  ~ kubectl get ns work
NAME   STATUS   AGE
work   Active   14s
</code></pre></div><h3 id="åˆ›å»ºç”¨æˆ·">åˆ›å»ºç”¨æˆ·</h3>
<h4 id="åˆ›å»ºç§é’¥">åˆ›å»ºç§é’¥</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">âœ  ~ mkdir work
âœ  ~ cd work
âœ  work openssl genrsa -out backend.key <span style="color:#ae81ff">2048</span>
Generating RSA private key, <span style="color:#ae81ff">2048</span> bit long modulus
..........................................+++                            
........................+++                   
e is <span style="color:#ae81ff">65537</span> <span style="color:#f92672">(</span>0x10001<span style="color:#f92672">)</span>            
âœ  work ls                                       
backend.key 

âœ  work cat backend.key                                              
-----BEGIN RSA PRIVATE KEY-----                                          
MIIEpAIBAAKCAQEAzk7blZthwSzachPxrk6pHsuaImTVh6Iw8mNDmtn6sqOqBfZS
...
bNKDWDk8HZREugaOAwjt7xaWOlr9SPCCoXrWoaA1z2215IC4qSA2Nw<span style="color:#f92672">==</span>
-----END RSA PRIVATE KEY-----
</code></pre></div><h4 id="ä½¿ç”¨ç§é’¥ç”Ÿæˆè¯ä¹¦è¯·æ±‚å‰é¢å·²ç»è®²è¿‡å…³äºè®¤è¯çš„éƒ¨åˆ†åœ¨è¿™é‡Œéœ€è¦æŒ‡å®š-subject-ä¿¡æ¯ä¼ é€’ç”¨æˆ·åå’Œç»„å">ä½¿ç”¨ç§é’¥ç”Ÿæˆè¯ä¹¦è¯·æ±‚ã€‚å‰é¢å·²ç»è®²è¿‡å…³äºè®¤è¯çš„éƒ¨åˆ†ï¼Œåœ¨è¿™é‡Œéœ€è¦æŒ‡å®š <code>subject</code> ä¿¡æ¯ï¼Œä¼ é€’ç”¨æˆ·åå’Œç»„å</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">âœ  work openssl req -new -key backend.key -out backend.csr -subj <span style="color:#e6db74">&#34;/CN=backend/O=dev&#34;</span>
âœ  work ls
backend.csr  backend.key
âœ  work cat backend.csr
-----BEGIN CERTIFICATE REQUEST-----
MIICZTCCAU0CAQAwIDEQMA4GA1UEAwwHYmFja2VuZDEMMAoGA1UECgwDZGV2MIIB
...
lpoSVlNA0trJoiEiZjUqMfXX6ogBhQC4aeRfmbXkW2ZCNxsIm3PDk1Y<span style="color:#f92672">=</span>
-----END CERTIFICATE REQUEST-----
</code></pre></div><h4 id="ä½¿ç”¨-ca-è¿›è¡Œç­¾åk8s-é»˜è®¤çš„è¯ä¹¦ç›®å½•ä¸º-etckubernetespki">ä½¿ç”¨ CA è¿›è¡Œç­¾åã€‚K8S é»˜è®¤çš„è¯ä¹¦ç›®å½•ä¸º <code>/etc/kubernetes/pki</code></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">âœ  work openssl x509 -req -in backend.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out backend.crt -days <span style="color:#ae81ff">365</span>
Signature ok
subject<span style="color:#f92672">=</span>/CN<span style="color:#f92672">=</span>backend/O<span style="color:#f92672">=</span>dev
Getting CA Private Key
âœ  work ls
backend.crt  backend.csr  backend.key
</code></pre></div><p>æŸ¥çœ‹ç”Ÿæˆçš„è¯ä¹¦æ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">âœ  work openssl x509 -in backend.crt -text -noout
Certificate:
    Data:
        Version: <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>0x0<span style="color:#f92672">)</span>
        Serial Number:
            d9:7f:62:f7:38:66:2a:7b
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN<span style="color:#f92672">=</span>kubernetes
        Subject: CN<span style="color:#f92672">=</span>backend, O<span style="color:#f92672">=</span>dev
        ...
</code></pre></div><p>å¯ä»¥çœ‹åˆ° <code>CN</code> åŸŸå’Œ <code>O</code> åŸŸå·²ç»æ­£ç¡®è®¾ç½®</p>
<h4 id="æ·»åŠ -context">æ·»åŠ  context</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">âœ  work kubectl config set-credentials backend --client-certificate<span style="color:#f92672">=</span>/root/work/backend.crt  --client-key<span style="color:#f92672">=</span>/root/work/backend.key
User <span style="color:#e6db74">&#34;backend&#34;</span> set.
âœ  work kubectl config set-context backend-context --cluster<span style="color:#f92672">=</span>kubernetes --namespace<span style="color:#f92672">=</span>work --user<span style="color:#f92672">=</span>backend
Context <span style="color:#e6db74">&#34;backend-context&#34;</span> created.
</code></pre></div><h4 id="ä½¿ç”¨æ–°ç”¨æˆ·æµ‹è¯•è®¿é—®">ä½¿ç”¨æ–°ç”¨æˆ·æµ‹è¯•è®¿é—®</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">âœ  work kubectl --context<span style="color:#f92672">=</span>backend-context get pods
Error from server <span style="color:#f92672">(</span>Forbidden<span style="color:#f92672">)</span>: pods is forbidden: User <span style="color:#e6db74">&#34;backend&#34;</span> cannot list resource <span style="color:#e6db74">&#34;pods&#34;</span> in API group <span style="color:#e6db74">&#34;&#34;</span> in the namespace <span style="color:#e6db74">&#34;work&#34;</span>
<span style="color:#75715e"># å¯èƒ½çœ‹å¾—ä¸å¤Ÿæ¸…æ¥šï¼Œæˆ‘ä»¬æ·»åŠ  `-v` å‚æ•°æ¥æ˜¾ç¤ºè¯¦æƒ…</span>
âœ  work kubectl --context<span style="color:#f92672">=</span>backend-context get pods -n work -v <span style="color:#ae81ff">5</span>
I1109 05:35:11.870639   <span style="color:#ae81ff">18626</span> helpers.go:201<span style="color:#f92672">]</span> server response object: <span style="color:#f92672">[{</span>
  <span style="color:#e6db74">&#34;kind&#34;</span>: <span style="color:#e6db74">&#34;Status&#34;</span>,
  <span style="color:#e6db74">&#34;apiVersion&#34;</span>: <span style="color:#e6db74">&#34;v1&#34;</span>,
  <span style="color:#e6db74">&#34;metadata&#34;</span>: <span style="color:#f92672">{}</span>,
  <span style="color:#e6db74">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;Failure&#34;</span>,
  <span style="color:#e6db74">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;pods is forbidden: User \&#34;backend\&#34; cannot list resource \&#34;pods\&#34; in API group \&#34;\&#34; in the namespace \&#34;work\&#34;&#34;</span>,
  <span style="color:#e6db74">&#34;reason&#34;</span>: <span style="color:#e6db74">&#34;Forbidden&#34;</span>,
  <span style="color:#e6db74">&#34;details&#34;</span>: <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;kind&#34;</span>: <span style="color:#e6db74">&#34;pods&#34;</span>
  <span style="color:#f92672">}</span>,
  <span style="color:#e6db74">&#34;code&#34;</span>: <span style="color:#ae81ff">403</span>
<span style="color:#f92672">}]</span>
F1109 05:35:11.870688   <span style="color:#ae81ff">18626</span> helpers.go:119<span style="color:#f92672">]</span> Error from server <span style="color:#f92672">(</span>Forbidden<span style="color:#f92672">)</span>: pods is forbidden: User <span style="color:#e6db74">&#34;backend&#34;</span> cannot list resource <span style="color:#e6db74">&#34;pods&#34;</span> in API group <span style="color:#e6db74">&#34;&#34;</span> in the namespace <span style="color:#e6db74">&#34;work&#34;</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°å·²ç»ä½¿ç”¨äº†æ–°çš„ <code>backend</code> ç”¨æˆ·ï¼Œå¹¶ä¸”é»˜è®¤çš„ <code>Namespace</code> è®¾ç½®æˆäº† <code>work</code>ã€‚</p>
<h4 id="åˆ›å»º-role">åˆ›å»º Role</h4>
<p>æˆ‘ä»¬æƒ³è¦è®©è¿™ä¸ªç”¨æˆ·åªå…·å¤‡æŸ¥çœ‹ <code>Pod</code> çš„æƒé™ã€‚å…ˆæ¥åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">âœ  work cat <span style="color:#e6db74">&lt;&lt;EOF &gt; backend-role.yaml 
</span><span style="color:#e6db74">kind: Role
</span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span><span style="color:#e6db74">metadata:
</span><span style="color:#e6db74">  namespace: work
</span><span style="color:#e6db74">  name: backend-role
</span><span style="color:#e6db74">rules:
</span><span style="color:#e6db74">- apiGroups: [&#34;&#34;]
</span><span style="color:#e6db74">  resources: [&#34;pods&#34;]
</span><span style="color:#e6db74">  verbs: [&#34;get&#34;, &#34;list&#34;, &#34;watch&#34;]
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><p>åˆ›å»ºå¹¶æŸ¥çœ‹å·²ç”Ÿæˆçš„ <code>Role</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">âœ  work kubectl create -f backend-role.yaml 
role.rbac.authorization.k8s.io/backend-role created
âœ  work kubectl get roles  -n work -o yaml
apiVersion: v1
items:
- apiVersion: rbac.authorization.k8s.io/v1
  kind: Role
  metadata:
    ...
    name: backend-role
    namespace: work
    selfLink: /apis/rbac.authorization.k8s.io/v1/namespaces/work/roles/backend-role
  rules:
  - apiGroups:
    - <span style="color:#e6db74">&#34;&#34;</span>
    resources:
    - pods
    verbs:
    - get
    - list
    - watch
kind: List
metadata:
  resourceVersion: <span style="color:#e6db74">&#34;&#34;</span>
  selfLink: <span style="color:#e6db74">&#34;&#34;</span>
</code></pre></div><h4 id="åˆ›å»º-rolebinding">åˆ›å»º Rolebinding</h4>
<p>å…ˆåˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">âœ  work cat <span style="color:#e6db74">&lt;&lt;EOF &gt; backend-rolebind.yaml
</span><span style="color:#e6db74">kind: RoleBinding
</span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span><span style="color:#e6db74">metadata:
</span><span style="color:#e6db74">  name: backend-rolebinding          
</span><span style="color:#e6db74">  namespace: work
</span><span style="color:#e6db74">subjects:      
</span><span style="color:#e6db74">- kind: User
</span><span style="color:#e6db74">  name: backend
</span><span style="color:#e6db74">  apiGroup: &#34;&#34;     
</span><span style="color:#e6db74">roleRef:    
</span><span style="color:#e6db74">  kind: Role 
</span><span style="color:#e6db74">  name: backend-role
</span><span style="color:#e6db74">  apiGroup: &#34;&#34;
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><p>åˆ›å»ºå¹¶æŸ¥çœ‹å·²ç”Ÿæˆçš„ Rolebinding ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">âœ  work kubectl create -f backend-rolebind.yaml
rolebinding.rbac.authorization.k8s.io/backend-rolebinding created
âœ  work kubectl get rolebinding -o yaml -n work
apiVersion: v1
items:
- apiVersion: rbac.authorization.k8s.io/v1
  kind: RoleBinding
  metadata:
    name: backend-rolebinding
    namespace: work
    ...
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: Role
    name: backend-role
  subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: backend
kind: List
metadata:
  resourceVersion: <span style="color:#e6db74">&#34;&#34;</span>
  selfLink: <span style="color:#e6db74">&#34;&#34;</span>
</code></pre></div><h4 id="æµ‹è¯•ç”¨æˆ·æƒé™">æµ‹è¯•ç”¨æˆ·æƒé™</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">âœ  work kubectl --context<span style="color:#f92672">=</span>backend-context get pods -n work
No resources found.
âœ  work kubectl --context<span style="color:#f92672">=</span>backend-context get ns
Error from server <span style="color:#f92672">(</span>Forbidden<span style="color:#f92672">)</span>: namespaces is forbidden: User <span style="color:#e6db74">&#34;backend&#34;</span> cannot list resource <span style="color:#e6db74">&#34;namespaces&#34;</span> in API group <span style="color:#e6db74">&#34;&#34;</span> at the cluster scope
âœ  work kubectl --context<span style="color:#f92672">=</span>backend-context get deploy -n work
Error from server <span style="color:#f92672">(</span>Forbidden<span style="color:#f92672">)</span>: deployments.extensions is forbidden: User <span style="color:#e6db74">&#34;backend&#34;</span> cannot list resource <span style="color:#e6db74">&#34;deployments&#34;</span> in API group <span style="color:#e6db74">&#34;extensions&#34;</span> in the namespace <span style="color:#e6db74">&#34;work&#34;</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°ç”¨æˆ·å·²ç»å…·å¤‡æŸ¥çœ‹ <code>Pod</code> çš„æƒé™ï¼Œä½†å¹¶ä¸èƒ½æŸ¥çœ‹ <code>Namespace</code> æˆ–è€… <code>deployment</code> ç­‰å…¶ä»–èµ„æºã€‚å½“ç„¶ï¼ŒK8S ä¹Ÿå†…ç½®äº†ä¸€ç§å¾ˆæ–¹ä¾¿çš„è°ƒè¯•æœºåˆ¶ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">âœ  work kubectl auth can-i list pods -n work --as<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;backend&#34;</span>
yes
âœ  work kubectl auth can-i list deploy -n work --as<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;backend&#34;</span>
no - no RBAC policy matched
</code></pre></div><p><code>--as</code> æ˜¯ä¸€ç§å»ºç«‹åœ¨ K8S è®¤è¯æœºåˆ¶ä¹‹ä¸Šçš„æœºåˆ¶ï¼Œå¯ä»¥ä¾¿äºç³»ç»Ÿç®¡ç†å‘˜éªŒè¯æˆæƒæƒ…å†µï¼Œæˆ–è¿›è¡Œè°ƒè¯•ã€‚</p>
<p>ä½ ä¹Ÿå¯ä»¥ä»¿ç…§ <code>~/.kube/config</code> æ–‡ä»¶çš„å†…å®¹ï¼Œå°†å½“å‰ç”Ÿæˆçš„è¯ä¹¦åŠç§é’¥æ–‡ä»¶ç­‰å†™å…¥åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Œé€šè¿‡æŒ‡å®š <code>KUBECONFIG</code> çš„ç¯å¢ƒå˜é‡ï¼Œæˆ–è€…ç»™ <code>kubectl</code> ä¼ é€’ <code>--kubeconfig</code> å‚æ•°æ¥ä½¿ç”¨ã€‚</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº† K8S çš„è®¤è¯åŠæˆæƒé€»è¾‘ï¼ŒK8S æ”¯æŒå¤šç§è®¤è¯åŠæˆæƒæ¨¡å¼ï¼Œå¯æŒ‰éœ€ä½¿ç”¨ã€‚é€šè¿‡ X509 å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯çš„æ–¹å¼ä½¿ç”¨æ¯”è¾ƒæ–¹ä¾¿ä¹Ÿæ¯”è¾ƒæ¨èï¼Œåœ¨å®¢æˆ·ç«¯è¯ä¹¦çš„ <code>CN</code> åŸŸå’Œ <code>O</code> åŸŸå¯ä»¥æŒ‡å®šç”¨æˆ·åå’Œæ‰€å±ç»„åã€‚</p>
<p>RBAC çš„æˆæƒæ¨¡å¼ç°åœ¨ä½¿ç”¨æœ€å¤šï¼Œå¯ä»¥é€šè¿‡å¯¹ <code>Role</code> å’Œ <code>subjects</code> (å¯ä»¥æ˜¯ç”¨æˆ·æˆ–ç»„) è¿›è¡Œç»‘å®šï¼Œä»¥è¾¾åˆ°æˆæƒçš„ç›®çš„ã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬å®é™…æ–°åˆ›å»ºäº†ä¸€ä¸ªç”¨æˆ·ï¼Œå¹¶å¯¹å…¶æˆäºˆäº†é¢„æœŸçš„æƒé™ã€‚åœ¨æ­¤è¿‡ç¨‹ä¸­ä¹Ÿæ¶‰åŠåˆ°äº† <code>openssl</code> å®¢æˆ·ç«¯çš„å¸¸è§„æ“ä½œï¼Œåœ¨ä¹‹åä¹Ÿä¼šå¸¸å¸¸ç”¨åˆ°ã€‚</p>
<p>ä¸‹èŠ‚ï¼Œæˆ‘ä»¬å°†å¼€å§‹éƒ¨ç½²å®é™…çš„é¡¹ç›®åˆ° K8S ä¸­ï¼Œé€æ­¥æŒæ¡ç”Ÿæˆç¯å¢ƒä¸­å¯¹ K8S çš„ä½¿ç”¨å®è·µã€‚</p>
<p>PS: ä¹Ÿè®¸ä½ ä¼šè§‰å¾—åˆ‡æ¢ <code>Namespace</code> ä¹‹ç±»çš„æ“ä½œå¾ˆç¹çï¼Œæœ‰ä¸€ä¸ªé¡¹ç›®ï¼š<a href="https://github.com/ahmetb/kubectx">kubectx</a> å¯å¸®ä½ ç®€åŒ–è¿™äº›æ­¥éª¤ï¼Œæ¨èå°è¯•ã€‚</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/07-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E4%BB%A5-redis-%E4%B8%BA%E4%BE%8B-%E9%83%A8%E7%BD%B2%E5%8F%8A%E8%AE%BF%E9%97%AE/"><span>07 é›†ç¾¤ç®¡ç†ï¼šä»¥ Redis ä¸ºä¾‹-éƒ¨ç½²åŠè®¿é—®</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/09-%E5%BA%94%E7%94%A8%E5%8F%91%E5%B8%83%E9%83%A8%E7%BD%B2%E5%AE%9E%E9%99%85%E9%A1%B9%E7%9B%AE/"><span>09 åº”ç”¨å‘å¸ƒï¼šéƒ¨ç½²å®é™…é¡¹ç›®</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 27270 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>