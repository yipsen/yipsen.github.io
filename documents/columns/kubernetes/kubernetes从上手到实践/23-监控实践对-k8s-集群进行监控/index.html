<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>23 ç›‘æ§å®è·µï¼šå¯¹ K8S é›†ç¾¤è¿›è¡Œç›‘æ§ | Yipsen Ye</title>
<meta name="description" content="æ•´ä½“æ¦‚è§ˆ é€šè¿‡å‰é¢çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å¯¹ K8S æœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œä¹Ÿå…·å¤‡äº†ä¸€å®šçš„é›†ç¾¤ç®¡ç†å’Œæ’é”™èƒ½åŠ›ã€‚ä½†å¦‚æœè¦åº”ç”¨äºç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸å¯èƒ½éšæ—¶éšåœ°çš„éƒ½ç›¯ç€é›†ç¾¤ï¼Œæˆ‘ä»¬éœ€è¦æ‰©å±•æˆ‘ä»¬å¯¹é›†ç¾¤çš„æ„ŸçŸ¥èƒ½åŠ›ã€‚
æœ¬èŠ‚ï¼Œæˆ‘ä»¬å°†ä»‹ç»ä¸‹ K8S é›†ç¾¤ç›‘æ§ç›¸å…³çš„å†…å®¹ã€‚
ç›‘æ§ä»€ä¹ˆ é™¤å» K8S å¤–ï¼Œæˆ‘ä»¬å¹³æ—¶è‡ªå·±å¼€å‘çš„ç³»ç»Ÿæˆ–è€…è´Ÿè´£çš„é¡¹ç›®ï¼Œä¸€èˆ¬éƒ½æ˜¯æœ‰ç›‘æ§çš„ã€‚ç›‘æ§å¯ä»¥æå‡æˆ‘ä»¬çš„æ„ŸçŸ¥èƒ½åŠ›ï¼Œä¾¿äºæˆ‘ä»¬åŠæ—¶äº†è§£é›†ç¾¤çš„å˜åŒ–ï¼Œä»¥åŠçŸ¥é“å“ªé‡Œå‡ºç°äº†é—®é¢˜ã€‚
K8S æ˜¯ä¸€ä¸ªå…¸å‹çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œç»„ä»¶å¾ˆå¤šï¼Œé‚£ä¹ˆç›‘æ§çš„ç›®æ ‡ï¼Œå°±å˜çš„å¾ˆé‡è¦äº†ã€‚
æ€»ä½“æ¥è®²ï¼Œå¯¹ K8S é›†ç¾¤çš„ç›‘æ§çš„è¯ï¼Œä¸»è¦æœ‰ä»¥ä¸‹æ–¹é¢ï¼š
 èŠ‚ç‚¹æƒ…å†µ K8S é›†ç¾¤è‡ªèº«çŠ¶æ€ éƒ¨ç½²åœ¨ K8S å†…çš„åº”ç”¨çš„çŠ¶æ€  Prometheus å¯¹äº K8S çš„ç›‘æ§ï¼Œæˆ‘ä»¬é€‰æ‹© CNCF æ——ä¸‹æ¬¡äº K8S æ¯•ä¸šçš„é¡¹ç›® Prometheus ã€‚
Prometheus æ˜¯ä¸€ä¸ªéå¸¸çµæ´»æ˜“äºæ‰©å±•çš„ç›‘æ§ç³»ç»Ÿï¼Œå®ƒé€šè¿‡å„ç§ exporter æš´éœ²æ•°æ®ï¼Œå¹¶ç”± prometheus server å®šæ—¶å»æ‹‰æ•°æ®ï¼Œç„¶åå­˜å‚¨ã€‚
å®ƒè‡ªå·±æä¾›äº†ä¸€ä¸ªç®€å•çš„å‰ç«¯ç•Œé¢ï¼Œå¯åœ¨å…¶ä¸­ä½¿ç”¨ PromQL çš„è¯­æ³•è¿›è¡ŒæŸ¥è¯¢ï¼Œå¹¶è¿›è¡Œå›¾å½¢åŒ–å±•ç¤ºã€‚
å®‰è£… Prometheus  è¿™é‡Œæ¨èä¸€ä¸ªé¡¹ç›® Prometheus Operator, å°½ç®¡è¯¥é¡¹ç›®è¿˜å¤„äº Beta é˜¶æ®µï¼Œä½†æ˜¯å®ƒç»™åœ¨ K8S ä¸­æ­å»ºåŸºäº Prometheus çš„ç›‘æ§æä¾›äº†å¾ˆå¤§çš„ä¾¿åˆ©ã€‚
 æˆ‘ä»¬æ­¤å¤„é€‰æ‹©ä»¥ä¸€èˆ¬çš„æ–¹å¼è¿›è¡Œéƒ¨ç½²ï¼Œå¸¦ä½ äº†è§£å…¶æ•´ä½“çš„è¿‡ç¨‹ã€‚
  åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ Namespaceï¼š
apiVersion: v1kind: Namespacemetadata:name: monitoring# å°†æ–‡ä»¶ä¿å­˜ä¸º namespace.">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/kubernetes%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/">Kubernetesä»ä¸Šæ‰‹åˆ°å®è·µ</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/01-%E5%BC%80%E7%AF%87-kubernetes-%E6%98%AF%E4%BB%80%E4%B9%88%E4%BB%A5%E5%8F%8A%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%AE%83/">01 å¼€ç¯‡ï¼š Kubernetes æ˜¯ä»€ä¹ˆä»¥åŠä¸ºä»€ä¹ˆéœ€è¦å®ƒ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/02-%E5%88%9D%E6%AD%A5%E8%AE%A4%E8%AF%86kubernetes-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/">02 åˆæ­¥è®¤è¯†ï¼šKubernetes åŸºç¡€æ¦‚å¿µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/03-%E5%AE%8F%E8%A7%82%E8%AE%A4%E8%AF%86%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84/">03 å®è§‚è®¤è¯†ï¼šæ•´ä½“æ¶æ„</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/04-%E6%90%AD%E5%BB%BA-kubernetes-%E9%9B%86%E7%BE%A4-%E6%9C%AC%E5%9C%B0%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA/">04 æ­å»º Kubernetes é›†ç¾¤ - æœ¬åœ°å¿«é€Ÿæ­å»º</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/05-%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA-kubernetes-%E9%9B%86%E7%BE%A4-%E7%94%9F%E4%BA%A7%E5%8F%AF%E7%94%A8/">05 åŠ¨æ‰‹å®è·µï¼šæ­å»ºä¸€ä¸ª Kubernetes é›†ç¾¤ - ç”Ÿäº§å¯ç”¨</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/06-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%88%9D%E8%AF%86-kubectl/">06 é›†ç¾¤ç®¡ç†ï¼šåˆè¯† kubectl</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/07-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E4%BB%A5-redis-%E4%B8%BA%E4%BE%8B-%E9%83%A8%E7%BD%B2%E5%8F%8A%E8%AE%BF%E9%97%AE/">07 é›†ç¾¤ç®¡ç†ï¼šä»¥ Redis ä¸ºä¾‹-éƒ¨ç½²åŠè®¿é—®</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/08-%E5%AE%89%E5%85%A8%E9%87%8D%E7%82%B9-%E8%AE%A4%E8%AF%81%E5%92%8C%E6%8E%88%E6%9D%83/">08 å®‰å…¨é‡ç‚¹ è®¤è¯å’Œæˆæƒ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/09-%E5%BA%94%E7%94%A8%E5%8F%91%E5%B8%83%E9%83%A8%E7%BD%B2%E5%AE%9E%E9%99%85%E9%A1%B9%E7%9B%AE/">09 åº”ç”¨å‘å¸ƒï¼šéƒ¨ç½²å®é™…é¡¹ç›®</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/10-%E5%BA%94%E7%94%A8%E7%AE%A1%E7%90%86%E5%88%9D%E8%AF%86-helm/">10 åº”ç”¨ç®¡ç†ï¼šåˆè¯† Helm</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/11-%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5%E4%BB%A5-helm-%E9%83%A8%E7%BD%B2%E9%A1%B9%E7%9B%AE/">11 éƒ¨ç½²å®è·µï¼šä»¥ Helm éƒ¨ç½²é¡¹ç›®</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/12-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bkube-apiserver/">12 åº–ä¸è§£ç‰›ï¼škube-apiserver</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/13-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Betcd/">13 åº–ä¸è§£ç‰›ï¼šetcd</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/14-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bcontroller-manager/">14 åº–ä¸è§£ç‰›ï¼šcontroller-manager</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/15-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bkube-scheduler/">15 åº–ä¸è§£ç‰›ï¼škube-scheduler</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/16-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bkubelet/">16 åº–ä¸è§£ç‰›ï¼škubelet</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/17-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bkube-proxy/">17 åº–ä¸è§£ç‰›ï¼škube-proxy</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/18-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bcontainer-runtime-docker/">18 åº–ä¸è§£ç‰›ï¼šContainer Runtime ï¼ˆDockerï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/19-troubleshoot/">19 Troubleshoot</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/20-%E6%89%A9%E5%B1%95%E5%A2%9E%E5%BC%BAdashboard/">20 æ‰©å±•å¢å¼ºï¼šDashboard</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/21-%E6%89%A9%E5%B1%95%E5%A2%9E%E5%BC%BAcoredns/">21 æ‰©å±•å¢å¼ºï¼šCoreDNS</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/22-%E6%9C%8D%E5%8A%A1%E5%A2%9E%E5%BC%BAingress/">22 æœåŠ¡å¢å¼ºï¼šIngress</a></li>
                
                
                
                    <li>23 ç›‘æ§å®è·µï¼šå¯¹ K8S é›†ç¾¤è¿›è¡Œç›‘æ§</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/24-%E6%80%BB%E7%BB%93/">24 æ€»ç»“</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">23 ç›‘æ§å®è·µï¼šå¯¹ K8S é›†ç¾¤è¿›è¡Œç›‘æ§</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2021-12-22 01:47:50</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/kubernetes/">kubernetes</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/">Kubernetesä»ä¸Šæ‰‹åˆ°å®è·µ</a>
                
            </div></div>
        <div class="post-content">
            <h2 id="æ•´ä½“æ¦‚è§ˆ">æ•´ä½“æ¦‚è§ˆ</h2>
<p>é€šè¿‡å‰é¢çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å¯¹ K8S æœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œä¹Ÿå…·å¤‡äº†ä¸€å®šçš„é›†ç¾¤ç®¡ç†å’Œæ’é”™èƒ½åŠ›ã€‚ä½†å¦‚æœè¦åº”ç”¨äºç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸å¯èƒ½éšæ—¶éšåœ°çš„éƒ½ç›¯ç€é›†ç¾¤ï¼Œæˆ‘ä»¬éœ€è¦æ‰©å±•æˆ‘ä»¬å¯¹é›†ç¾¤çš„æ„ŸçŸ¥èƒ½åŠ›ã€‚</p>
<p>æœ¬èŠ‚ï¼Œæˆ‘ä»¬å°†ä»‹ç»ä¸‹ K8S é›†ç¾¤ç›‘æ§ç›¸å…³çš„å†…å®¹ã€‚</p>
<h2 id="ç›‘æ§ä»€ä¹ˆ">ç›‘æ§ä»€ä¹ˆ</h2>
<p>é™¤å» K8S å¤–ï¼Œæˆ‘ä»¬å¹³æ—¶è‡ªå·±å¼€å‘çš„ç³»ç»Ÿæˆ–è€…è´Ÿè´£çš„é¡¹ç›®ï¼Œä¸€èˆ¬éƒ½æ˜¯æœ‰ç›‘æ§çš„ã€‚ç›‘æ§å¯ä»¥æå‡æˆ‘ä»¬çš„æ„ŸçŸ¥èƒ½åŠ›ï¼Œä¾¿äºæˆ‘ä»¬åŠæ—¶äº†è§£é›†ç¾¤çš„å˜åŒ–ï¼Œä»¥åŠçŸ¥é“å“ªé‡Œå‡ºç°äº†é—®é¢˜ã€‚</p>
<p>K8S æ˜¯ä¸€ä¸ªå…¸å‹çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œç»„ä»¶å¾ˆå¤šï¼Œé‚£ä¹ˆç›‘æ§çš„ç›®æ ‡ï¼Œå°±å˜çš„å¾ˆé‡è¦äº†ã€‚</p>
<p>æ€»ä½“æ¥è®²ï¼Œå¯¹ K8S é›†ç¾¤çš„ç›‘æ§çš„è¯ï¼Œä¸»è¦æœ‰ä»¥ä¸‹æ–¹é¢ï¼š</p>
<ul>
<li>èŠ‚ç‚¹æƒ…å†µ</li>
<li>K8S é›†ç¾¤è‡ªèº«çŠ¶æ€</li>
<li>éƒ¨ç½²åœ¨ K8S å†…çš„åº”ç”¨çš„çŠ¶æ€</li>
</ul>
<h2 id="prometheus">Prometheus</h2>
<p>å¯¹äº K8S çš„ç›‘æ§ï¼Œæˆ‘ä»¬é€‰æ‹© CNCF æ——ä¸‹æ¬¡äº K8S æ¯•ä¸šçš„é¡¹ç›® <a href="https://prometheus.io/">Prometheus</a> ã€‚</p>
<p>Prometheus æ˜¯ä¸€ä¸ªéå¸¸çµæ´»æ˜“äºæ‰©å±•çš„ç›‘æ§ç³»ç»Ÿï¼Œå®ƒé€šè¿‡å„ç§ <code>exporter</code> æš´éœ²æ•°æ®ï¼Œå¹¶ç”± <code>prometheus server</code> å®šæ—¶å»æ‹‰æ•°æ®ï¼Œç„¶åå­˜å‚¨ã€‚</p>
<p>å®ƒè‡ªå·±æä¾›äº†ä¸€ä¸ªç®€å•çš„å‰ç«¯ç•Œé¢ï¼Œå¯åœ¨å…¶ä¸­ä½¿ç”¨ <a href="https://prometheus.io/docs/prometheus/latest/querying/basics/">PromQL</a> çš„è¯­æ³•è¿›è¡ŒæŸ¥è¯¢ï¼Œå¹¶è¿›è¡Œå›¾å½¢åŒ–å±•ç¤ºã€‚</p>
<h2 id="å®‰è£…-prometheus">å®‰è£… Prometheus</h2>
<blockquote>
<p>è¿™é‡Œæ¨èä¸€ä¸ªé¡¹ç›® <a href="https://github.com/coreos/prometheus-operator">Prometheus Operator</a>, å°½ç®¡è¯¥é¡¹ç›®è¿˜å¤„äº Beta é˜¶æ®µï¼Œä½†æ˜¯å®ƒç»™åœ¨ K8S ä¸­æ­å»ºåŸºäº Prometheus çš„ç›‘æ§æä¾›äº†å¾ˆå¤§çš„ä¾¿åˆ©ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬æ­¤å¤„é€‰æ‹©ä»¥ä¸€èˆ¬çš„æ–¹å¼è¿›è¡Œéƒ¨ç½²ï¼Œå¸¦ä½ äº†è§£å…¶æ•´ä½“çš„è¿‡ç¨‹ã€‚</p>
<ul>
<li>
<p>åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ <code>Namespace</code>ï¼š</p>
<pre tabindex="0"><code>apiVersion: v1
kind: Namespace
metadata:
  name: monitoring

# å°†æ–‡ä»¶ä¿å­˜ä¸º namespace.yaml çš„æ–‡ä»¶ï¼Œå¹¶æ‰§è¡Œ kubectl apply -f namespace.yaml å³å¯ï¼Œåé¢ä¸å†èµ˜è¿°ã€‚
</code></pre><pre tabindex="0"><code>master $ kubectl apply -f namespace.yaml
namespace/monitoring created
</code></pre></li>
<li>
<p>RBAC</p>
<p>æˆ‘ä»¬çš„é›†ç¾¤ä½¿ç”¨ <code>kubeadm</code> åˆ›å»ºï¼Œé»˜è®¤å¼€å¯äº† <code>RBAC</code>ï¼Œæ‰€ä»¥ç°åœ¨éœ€è¦åˆ›å»ºç›¸å…³çš„ Role å’Œ bindingã€‚</p>
<pre tabindex="0"><code>apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus
subjects:
- kind: ServiceAccount
  name: prometheus-k8s
  namespace: monitoring
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus
rules:
- apiGroups: [&quot;&quot;]
  resources:
  - nodes
  - nodes/proxy
  - services
  - endpoints
  - pods
  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]
- apiGroups: [&quot;&quot;]
  resources:
  - configmaps
  verbs: [&quot;get&quot;]
- nonResourceURLs: [&quot;/metrics&quot;]
  verbs: [&quot;get&quot;]
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus-k8s
  namespace: monitoring
</code></pre><p>æ‰§è¡Œåˆ›å»º</p>
<pre tabindex="0"><code>master $ kubectl  apply -f rbac.yaml
clusterrolebinding.rbac.authorization.k8s.io/prometheus created
clusterrole.rbac.authorization.k8s.io/prometheus created
serviceaccount/prometheus-k8s created
</code></pre></li>
<li>
<p>åˆ›å»º Promethes çš„é…ç½®æ–‡ä»¶</p>
<p>å…¶ä¸­çš„å†…å®¹ä¸»è¦å‚è€ƒ <a href="https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml">Prometheus å®˜æ–¹æä¾›çš„ç¤ºä¾‹</a> å’Œ <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config">Prometheus å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
<pre tabindex="0"><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-core
  namespace: monitoring
data:
  prometheus.yaml: |
    global:
      scrape_interval: 30s
      scrape_timeout: 30s
    scrape_configs:
    - job_name: 'kubernetes-apiservers'

      kubernetes_sd_configs:
      - role: endpoints
      scheme: https

      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

      relabel_configs:
      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
        action: keep
        regex: default;kubernetes;https

    # Scrape config for nodes (kubelet).
    - job_name: 'kubernetes-nodes'
      scheme: https

      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

      kubernetes_sd_configs:
      - role: node

      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - target_label: __address__
        replacement: kubernetes.default.svc:443
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /api/v1/nodes/${1}/proxy/metrics

    # Scrape config for Kubelet cAdvisor.
    - job_name: 'kubernetes-cadvisor'

      scheme: https

      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

      kubernetes_sd_configs:
      - role: node

      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - target_label: __address__
        replacement: kubernetes.default.svc:443
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor

    - job_name: 'kubernetes-service-endpoints'

      kubernetes_sd_configs:
      - role: endpoints

      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_service_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_service_name]
        action: replace
        target_label: kubernetes_name

    - job_name: 'kubernetes-services'

      metrics_path: /probe
      params:
        module: [http_2xx]

      kubernetes_sd_configs:
      - role: service

      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - target_label: __address__
        replacement: blackbox-exporter.example.com:9115
      - source_labels: [__param_target]
        target_label: instance
      - action: labelmap
        regex: __meta_kubernetes_service_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_service_name]
        target_label: kubernetes_name

    - job_name: 'kubernetes-ingresses'

      metrics_path: /probe
      params:
        module: [http_2xx]

      kubernetes_sd_configs:
      - role: ingress

      relabel_configs:
      - source_labels: [__meta_kubernetes_ingress_scheme,__address__,__meta_kubernetes_ingress_path]
        regex: (.+);(.+);(.+)
        replacement: ${1}://${2}${3}
        target_label: __param_target
      - target_label: __address__
        replacement: blackbox-exporter.example.com:9115
      - source_labels: [__param_target]
        target_label: instance
      - action: labelmap
        regex: __meta_kubernetes_ingress_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_ingress_name]
        target_label: kubernetes_name

    - job_name: 'kubernetes-pods'

      kubernetes_sd_configs:
      - role: pod

      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: kubernetes_pod_name
</code></pre></li>
<li>
<p>éƒ¨ç½² Prometheus</p>
<pre tabindex="0"><code>apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: prometheus-core
  namespace: monitoring
  labels:
    app: prometheus
    component: core
spec:
  replicas: 1
  template:
    metadata:
      name: prometheus-main
      labels:
        app: prometheus
        component: core
    spec:
      serviceAccountName: prometheus-k8s
      containers:
      - name: prometheus
        image: taobeier/prometheus:v2.6.0
        args:
          - '--storage.tsdb.retention=24h'
          - '--storage.tsdb.path=/prometheus'
          - '--config.file=/etc/prometheus/prometheus.yaml'
        ports:
        - name: webui
          containerPort: 9090
        resources:
          requests:
            cpu: 500m
            memory: 500M
          limits:
            cpu: 500m
            memory: 500M
        volumeMounts:
        - name: data
          mountPath: /prometheus
        - name: config-volume
          mountPath: /etc/prometheus
      volumes:
      - name: data
        emptyDir: {}
      - name: config-volume
        configMap:
          name: prometheus-core
</code></pre></li>
<li>
<p>æŸ¥çœ‹éƒ¨ç½²æƒ…å†µ</p>
<pre tabindex="0"><code>master $ kubectl  -n monitoring get all
NAME                                   READY     STATUS    RESTARTS   AGE
pod/prometheus-core-86b8455f76-mvrn4   1/1       Running   0          12s

NAME                              DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/prometheus-core   1         1         1            1           12s

NAME                                         DESIRED   CURRENT   READY     AGE
replicaset.apps/prometheus-core-86b8455f76   1         1         1         12s
</code></pre><p>Prometheus çš„ä¸»ä½“å°±å·²ç»éƒ¨ç½²å®Œæˆã€‚</p>
</li>
<li>
<p>ä½¿ç”¨ <code>Service</code> å°† <code>Promethes</code> çš„æœåŠ¡æš´éœ²å‡ºæ¥</p>
<pre tabindex="0"><code>apiVersion: v1
kind: Service
metadata:
  labels:
    app: prometheus
    component: core
  name: prometheus
  namespace: monitoring
spec:
  ports:
  - protocol: TCP
    port: 9090
    targetPort: 9090
  selector:
    app: prometheus
    component: core
  type: NodePort
</code></pre><p>è¿™é‡Œä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼Œç›´æ¥ä½¿ç”¨äº† <code>NodePort</code> çš„æ–¹å¼æš´éœ²æœåŠ¡ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥å‚è€ƒä¸Šä¸€èŠ‚ï¼Œä½¿ç”¨ <code>Ingress</code> çš„æ–¹å¼å°†æœåŠ¡æš´éœ²å‡ºæ¥ã€‚</p>
</li>
<li>
<p>æŸ¥è¯¢å½“å‰çŠ¶æ€</p>
<p>æˆ‘ä»¬ä½¿ç”¨ Promethes è‡ªå¸¦çš„ PromQL è¯­æ³•ï¼ŒæŸ¥è¯¢åœ¨å½“å‰ <code>monitoring</code> Namespace ä¸­ up çš„ä»»åŠ¡ã€‚è¿™é‡Œå¯¹æŸ¥è¯¢çš„ç»“æœæš‚ä¸è¿›è¡Œå±•å¼€ã€‚</p>
</li>
</ul>
<p><img src="/images/d72ab8bf672fc08849784a29e9b95724eb4e16b6c56681f888613cd7c8944a09.png" alt="picture 17"></p>
<h2 id="å®‰è£…-node-exporter">å®‰è£… Node exporter</h2>
<p>æˆ‘ä»¬åˆšæ‰åœ¨ä»‹ç»æ—¶ï¼Œæåˆ°è¿‡ <code>Promethes</code> æ”¯æŒå¤šç§ <code>exporter</code> æš´éœ²æŒ‡æ ‡ã€‚æˆ‘ä»¬ç°åœ¨ä½¿ç”¨ <a href="https://github.com/prometheus/node_exporter">Node exporter</a> å®Œæˆå¯¹é›†ç¾¤ä¸­æœºå™¨çš„åŸºç¡€ç›‘æ§ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªéœ€è¦è€ƒè™‘çš„ç‚¹ï¼š</p>
<ul>
<li>
<p>ä½¿ç”¨ä»€ä¹ˆæ–¹å¼éƒ¨ç½² Node exporter ï¼Ÿ</p>
<p>Node exporter æœ‰å·²ç»ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„è¿›è¡Œéƒ¨ç½²ã€‚å½“æˆ‘ä»¬è¦ç›‘æ§é›†ç¾¤ä¸­æ‰€æœ‰çš„æœºå™¨æ—¶ï¼Œæˆ‘ä»¬æ˜¯è¯¥å°†å®ƒç›´æ¥éƒ¨ç½²åœ¨æœºå™¨ä¸Šï¼Œè¿˜æ˜¯éƒ¨ç½²åœ¨é›†ç¾¤å†…ï¼Ÿ</p>
<p>æˆ‘å»ºè®®æ˜¯ç›´æ¥éƒ¨ç½²åœ¨é›†ç¾¤å†…ï¼Œä½¿ç”¨ <code>DaemonSet</code> çš„æ–¹å¼è¿›è¡Œéƒ¨ç½²ã€‚è¿™é‡Œçš„è€ƒè™‘æ˜¯å½“æˆ‘ä»¬ç›´æ¥éƒ¨ç½²åœ¨å®¿ä¸»æœºä¸Šæ—¶ï¼Œæˆ‘ä»¬æœ€èµ·ç éœ€è¦ä¿è¯ä¸¤ç‚¹ï¼š1. Promethes æœåŠ¡å¯ä¸å®ƒæ­£å¸¸é€šä¿¡ï¼ˆPromethes é‡‡ç”¨ Pull çš„æ–¹å¼é‡‡é›†æ•°æ®ï¼‰ ï¼›2. éœ€è¦æœåŠ¡ä¿æ´»ï¼Œå¦‚æœ exporter æŒ‚æ‰äº†ï¼Œé‚£è‡ªç„¶å°±å–ä¸åˆ°æ•°æ®ã€‚</p>
<p><code>DaemonSet</code> æ˜¯ä¸€ç§å¾ˆåˆé€‚çš„çš„éƒ¨ç½²æ–¹å¼ï¼Œå¯ç›´æ¥å°† Node exporter éƒ¨ç½²è‡³é›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šã€‚</p>
</li>
<li>
<p>åˆ›å»º <code>DaemonSet</code></p>
<pre tabindex="0"><code>apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  name: prometheus-node-exporter
  namespace: monitoring
  labels:
    app: prometheus
    component: node-exporter
spec:
  template:
    metadata:
      name: prometheus-node-exporter
      labels:
        app: prometheus
        component: node-exporter
    spec:
      tolerations:
      - key: node-role.kubernetes.io/master
        effect: NoSchedule
      containers:
      - image: taobeier/node-exporter:v0.17.0
        name: prometheus-node-exporter
        ports:
        - name: prom-node-exp
          containerPort: 9100
          hostPort: 9100
      hostNetwork: true
      hostPID: true
</code></pre></li>
<li>
<p>è®© Promethes æŠ“å–æ•°æ®</p>
<pre tabindex="0"><code>apiVersion: v1
kind: Service
metadata:
  annotations:
    prometheus.io/scrape: 'true'
  name: prometheus-node-exporter
  namespace: monitoring
  labels:
    app: prometheus
    component: node-exporter
spec:
  clusterIP: None
  ports:
    - name: prometheus-node-exporter
      port: 9100
      protocol: TCP
  selector:
    app: prometheus
    component: node-exporter
  type: ClusterIP
</code></pre><p>è¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨äº†æ·»åŠ  <code>annotations</code> çš„æ–¹å¼ï¼Œè®© Promethes è‡ªåŠ¨çš„é€šè¿‡ Kubernetes SD å‘ç°æˆ‘ä»¬æ–°æ·»åŠ çš„ exporter ï¼ˆæˆ–è€…è¯´èµ„æºï¼‰</p>
<p>æˆ‘ä»¬è®¿é—® Promethes çš„ web ç«¯ï¼Œè¿›è¡ŒéªŒè¯ã€‚</p>
</li>
</ul>
<p><img src="/images/bb9fe7eb0f2136b434e671db07550d6ec9809d239b0316123671c86590e4c886.png" alt="picture 18"></p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† <code>Prometheus</code> çš„åŸºæœ¬æƒ…å†µï¼Œä¹Ÿéƒ¨ç½²äº† <code>Prometheus</code> çš„ä¸»ä½“æœåŠ¡ã€‚</p>
<p>ä½†è¿™æ˜¯ç»“æŸä¹ˆï¼Ÿè¿™å¹¶ä¸æ˜¯ï¼Œè¿™æ‰åˆšåˆšå¼€å§‹ã€‚</p>
<p>æˆ‘ä»¬æåˆ° <code>Prometheus</code> æ”¯æŒå¤šç§ <code>exporter</code> æš´éœ²å„ç§æŒ‡æ ‡ï¼Œè€Œä¸”æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ <a href="https://grafana.com/">Grafana</a> ä½œä¸ºæˆ‘ä»¬ç›‘æ§çš„å±•ç¤ºæ‰‹æ®µã€‚</p>
<p>å¦‚æœè¦åš Dashboard æ¨èä½¿ç”¨ <a href="https://grafana.com/dashboards/162">Kubernetes cluster monitoring (via Prometheus)</a> ã€‚</p>
<p>å¦å¤–ï¼Œç›‘æ§å…¶å®æ¶‰åŠçš„å†…å®¹å¾ˆå¤šï¼ŒåŒ…æ‹¬æ•°æ®æŒä¹…åŒ–æ–¹å¼ã€‚ä»¥åŠæ˜¯å¦è€ƒè™‘ä¸é›†ç¾¤å¤–çš„ Prometheus é›†ç¾¤åšé‚¦è”æ¨¡å¼ç­‰ã€‚è¿™é‡Œéœ€è¦è€ƒè™‘çš„å®é™…æƒ…å†µè¾ƒå¤šï¼Œæš‚ä¸ä¸€ä¸€å±•å¼€äº†ã€‚</p>
<p>Prometheus å·²ç»ä» CNCF æ¯•ä¸šï¼Œå…¶åœ¨äº‘åŸç”Ÿæ—¶ä»£ä¸‹ä½œä¸ºæ ‡å‡†çš„ç›‘æ§æŠ€æœ¯æ ˆä¹ŸåŸºæœ¬ç¡®ç«‹ã€‚è‡³äºåº”ç”¨ç›‘æ§ï¼Œä¹Ÿå¯ä½¿ç”¨å®ƒçš„ SDK æ¥å®Œæˆã€‚</p>
<p>ä¸‹èŠ‚ï¼Œæˆ‘ä»¬å°†å¯¹æœ¬å°å†Œè¿›è¡Œä¸€æ¬¡æ€»ç»“ã€‚</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/22-%E6%9C%8D%E5%8A%A1%E5%A2%9E%E5%BC%BAingress/"><span>22 æœåŠ¡å¢å¼ºï¼šIngress</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/24-%E6%80%BB%E7%BB%93/"><span>24 æ€»ç»“</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 27270 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>