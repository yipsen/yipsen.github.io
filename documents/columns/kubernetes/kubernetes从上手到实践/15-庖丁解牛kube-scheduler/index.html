<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>15 åº–ä¸è§£ç‰›ï¼škube-scheduler | Yipsen Ye</title>
<meta name="description" content="æ•´ä½“æ¦‚è§ˆ &#43;----------------------------------------------------------&#43; | Master | | &#43;-------------------------&#43; | | &#43;-------&amp;gt;| API Server |&amp;lt;--------&#43; | | | | | | | | v &#43;-------------------------&#43; v | | &#43;----------------&#43; ^ &#43;--------------------&#43; | | | | | | | | | | Scheduler | | | Controller Manager | | | | | | | | | | &#43;----------------&#43; v &#43;--------------------&#43; | | &#43;------------------------------------------------------&#43; | | | | | | | Cluster state store | | | | | | | &#43;------------------------------------------------------&#43; | &#43;----------------------------------------------------------&#43; åœ¨ç¬¬ 3 èŠ‚ã€Šå®è§‚è®¤è¯†ï¼šæ•´ä½“æ¶æ„ã€‹ ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿè®¤è¯†åˆ°äº† Scheduler çš„å­˜åœ¨ï¼ŒçŸ¥é“äº† Master æ˜¯ K8S æ˜¯é›†ç¾¤çš„å¤§è„‘ï¼ŒController Manager è´Ÿè´£å°†é›†ç¾¤è°ƒæ•´è‡³é¢„æœŸçš„çŠ¶æ€ï¼Œè€Œ Scheduler åˆ™æ˜¯é›†ç¾¤è°ƒåº¦å™¨ï¼Œå°†é¢„æœŸçš„ Pod èµ„æºè°ƒåº¦åˆ°æ­£ç¡®çš„ Node èŠ‚ç‚¹ä¸Šï¼Œè¿›è€Œä»¤è¯¥ Pod å¯å®Œæˆå¯åŠ¨ã€‚æœ¬èŠ‚æˆ‘ä»¬ä¸€åŒæ¥çœ‹çœ‹å®ƒå¦‚ä½•å‘æŒ¥å¦‚æ­¤å¤§çš„ä½œç”¨ã€‚">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/kubernetes%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/">Kubernetesä»ä¸Šæ‰‹åˆ°å®è·µ</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/01-%E5%BC%80%E7%AF%87-kubernetes-%E6%98%AF%E4%BB%80%E4%B9%88%E4%BB%A5%E5%8F%8A%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%AE%83/">01 å¼€ç¯‡ï¼š Kubernetes æ˜¯ä»€ä¹ˆä»¥åŠä¸ºä»€ä¹ˆéœ€è¦å®ƒ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/02-%E5%88%9D%E6%AD%A5%E8%AE%A4%E8%AF%86kubernetes-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/">02 åˆæ­¥è®¤è¯†ï¼šKubernetes åŸºç¡€æ¦‚å¿µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/03-%E5%AE%8F%E8%A7%82%E8%AE%A4%E8%AF%86%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84/">03 å®è§‚è®¤è¯†ï¼šæ•´ä½“æ¶æ„</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/04-%E6%90%AD%E5%BB%BA-kubernetes-%E9%9B%86%E7%BE%A4-%E6%9C%AC%E5%9C%B0%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA/">04 æ­å»º Kubernetes é›†ç¾¤ - æœ¬åœ°å¿«é€Ÿæ­å»º</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/05-%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA-kubernetes-%E9%9B%86%E7%BE%A4-%E7%94%9F%E4%BA%A7%E5%8F%AF%E7%94%A8/">05 åŠ¨æ‰‹å®è·µï¼šæ­å»ºä¸€ä¸ª Kubernetes é›†ç¾¤ - ç”Ÿäº§å¯ç”¨</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/06-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%88%9D%E8%AF%86-kubectl/">06 é›†ç¾¤ç®¡ç†ï¼šåˆè¯† kubectl</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/07-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E4%BB%A5-redis-%E4%B8%BA%E4%BE%8B-%E9%83%A8%E7%BD%B2%E5%8F%8A%E8%AE%BF%E9%97%AE/">07 é›†ç¾¤ç®¡ç†ï¼šä»¥ Redis ä¸ºä¾‹-éƒ¨ç½²åŠè®¿é—®</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/08-%E5%AE%89%E5%85%A8%E9%87%8D%E7%82%B9-%E8%AE%A4%E8%AF%81%E5%92%8C%E6%8E%88%E6%9D%83/">08 å®‰å…¨é‡ç‚¹ è®¤è¯å’Œæˆæƒ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/09-%E5%BA%94%E7%94%A8%E5%8F%91%E5%B8%83%E9%83%A8%E7%BD%B2%E5%AE%9E%E9%99%85%E9%A1%B9%E7%9B%AE/">09 åº”ç”¨å‘å¸ƒï¼šéƒ¨ç½²å®é™…é¡¹ç›®</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/10-%E5%BA%94%E7%94%A8%E7%AE%A1%E7%90%86%E5%88%9D%E8%AF%86-helm/">10 åº”ç”¨ç®¡ç†ï¼šåˆè¯† Helm</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/11-%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5%E4%BB%A5-helm-%E9%83%A8%E7%BD%B2%E9%A1%B9%E7%9B%AE/">11 éƒ¨ç½²å®è·µï¼šä»¥ Helm éƒ¨ç½²é¡¹ç›®</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/12-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bkube-apiserver/">12 åº–ä¸è§£ç‰›ï¼škube-apiserver</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/13-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Betcd/">13 åº–ä¸è§£ç‰›ï¼šetcd</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/14-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bcontroller-manager/">14 åº–ä¸è§£ç‰›ï¼šcontroller-manager</a></li>
                
                
                
                    <li>15 åº–ä¸è§£ç‰›ï¼škube-scheduler</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/16-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bkubelet/">16 åº–ä¸è§£ç‰›ï¼škubelet</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/17-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bkube-proxy/">17 åº–ä¸è§£ç‰›ï¼škube-proxy</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/18-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bcontainer-runtime-docker/">18 åº–ä¸è§£ç‰›ï¼šContainer Runtime ï¼ˆDockerï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/19-troubleshoot/">19 Troubleshoot</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/20-%E6%89%A9%E5%B1%95%E5%A2%9E%E5%BC%BAdashboard/">20 æ‰©å±•å¢å¼ºï¼šDashboard</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/21-%E6%89%A9%E5%B1%95%E5%A2%9E%E5%BC%BAcoredns/">21 æ‰©å±•å¢å¼ºï¼šCoreDNS</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/22-%E6%9C%8D%E5%8A%A1%E5%A2%9E%E5%BC%BAingress/">22 æœåŠ¡å¢å¼ºï¼šIngress</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/23-%E7%9B%91%E6%8E%A7%E5%AE%9E%E8%B7%B5%E5%AF%B9-k8s-%E9%9B%86%E7%BE%A4%E8%BF%9B%E8%A1%8C%E7%9B%91%E6%8E%A7/">23 ç›‘æ§å®è·µï¼šå¯¹ K8S é›†ç¾¤è¿›è¡Œç›‘æ§</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/24-%E6%80%BB%E7%BB%93/">24 æ€»ç»“</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">15 åº–ä¸è§£ç‰›ï¼škube-scheduler</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2021-12-22 01:47:41</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/kubernetes/">kubernetes</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/">Kubernetesä»ä¸Šæ‰‹åˆ°å®è·µ</a>
                
            </div></div>
        <div class="post-content">
            <h2 id="æ•´ä½“æ¦‚è§ˆ">æ•´ä½“æ¦‚è§ˆ</h2>
<pre tabindex="0"><code>+----------------------------------------------------------+          
| Master                                                   |          
|              +-------------------------+                 |          
|     +-------&gt;|        API Server       |&lt;--------+       |          
|     |        |                         |         |       |          
|     v        +-------------------------+         v       |          
|   +----------------+     ^      +--------------------+   |          
|   |                |     |      |                    |   |          
|   |   Scheduler    |     |      | Controller Manager |   |          
|   |                |     |      |                    |   |          
|   +----------------+     v      +--------------------+   |          
| +------------------------------------------------------+ |          
| |                                                      | |          
| |                Cluster state store                   | |          
| |                                                      | |          
| +------------------------------------------------------+ |          
+----------------------------------------------------------+          
</code></pre><p>åœ¨ç¬¬ 3 èŠ‚ã€Šå®è§‚è®¤è¯†ï¼šæ•´ä½“æ¶æ„ã€‹ ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿè®¤è¯†åˆ°äº† <code>Scheduler</code> çš„å­˜åœ¨ï¼ŒçŸ¥é“äº† Master æ˜¯ K8S æ˜¯é›†ç¾¤çš„å¤§è„‘ï¼Œ<code>Controller Manager</code> è´Ÿè´£å°†é›†ç¾¤è°ƒæ•´è‡³é¢„æœŸçš„çŠ¶æ€ï¼Œè€Œ <code>Scheduler</code> åˆ™æ˜¯é›†ç¾¤è°ƒåº¦å™¨ï¼Œå°†é¢„æœŸçš„ <code>Pod</code> èµ„æºè°ƒåº¦åˆ°æ­£ç¡®çš„ <code>Node</code> èŠ‚ç‚¹ä¸Šï¼Œè¿›è€Œä»¤è¯¥ <code>Pod</code> å¯å®Œæˆå¯åŠ¨ã€‚æœ¬èŠ‚æˆ‘ä»¬ä¸€åŒæ¥çœ‹çœ‹å®ƒå¦‚ä½•å‘æŒ¥å¦‚æ­¤å¤§çš„ä½œç”¨ã€‚</p>
<p><strong>ä¸‹æ–‡ç»Ÿä¸€ä½¿ç”¨ kube-scheduler è¿›è¡Œè¡¨è¿°</strong></p>
<h2 id="kube-scheduler-æ˜¯ä»€ä¹ˆ"><code>kube-scheduler</code> æ˜¯ä»€ä¹ˆ</h2>
<p>å¼•ç”¨<a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-scheduler/">å®˜æ–¹æ–‡æ¡£</a>ä¸€å¥è¯ï¼š</p>
<blockquote>
<p>The Kubernetes scheduler is a policy-rich, topology-aware, workload-specific function that significantly impacts availability, performance, and capacity.</p>
</blockquote>
<p><code>kube-scheduler</code> æ˜¯ä¸€ä¸ªç­–ç•¥ä¸°å¯Œï¼Œæ‹“æ‰‘æ„ŸçŸ¥çš„è°ƒåº¦ç¨‹åºï¼Œä¼šæ˜¾è‘—å½±å“å¯ç”¨æ€§ï¼Œæ€§èƒ½å’Œå®¹é‡ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“èµ„æºè°ƒåº¦æœ¬å°±æ˜¯ K8S è¿™ç±»ç³»ç»Ÿä¸­çš„ä¸€ä¸ªå¾ˆå¤æ‚çš„äº‹æƒ…ï¼Œæ—¢è¦èƒ½æ»¡è¶³ç³»ç»Ÿå¯¹èµ„æºåˆ©ç”¨ç‡çš„éœ€è¦ï¼ŒåŒæ ·è¿˜éœ€è¦é¿å…èµ„æºç«äº‰ï¼Œæ¯”å¦‚è¯´ç«¯å£å†²çªä¹‹ç±»çš„ã€‚</p>
<p>ä¸ºäº†èƒ½å®Œæˆè¿™æ ·çš„éœ€æ±‚ï¼Œ<code>kube-scheduler</code> ä¾¿åœ¨ä¸æ–­çš„è¿­ä»£å’Œå‘å±•ï¼Œé€šè¿‡æ”¯æŒå¤šç§ç­–ç•¥æ»¡è¶³å„ç±»éœ€æ±‚ï¼Œé€šè¿‡æ„ŸçŸ¥æ‹“æ‰‘é¿å…èµ„æºç«äº‰å’Œä¿éšœç³»ç»Ÿçš„å¯ç”¨æ€§åŠå®¹é‡ç­‰ã€‚</p>
<p>æˆ‘ä»¬åœ¨ç¬¬ 5 èŠ‚ä¸‹è½½æœåŠ¡ç«¯äºŒè¿›åˆ¶æ–‡ä»¶è§£å‹åï¼Œä¾¿å¯çœ‹åˆ° <code>kube-scheduler</code> çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚å½“ç»™å®ƒä¼ é€’ <code>--help</code> æŸ¥çœ‹å…¶æ”¯æŒå‚æ•°çš„æ—¶å€™ï¼Œä¾¿å¯ä»¥çœ‹åˆ°å®ƒæ”¯æŒä½¿ç”¨ <code>--address</code> æˆ–è€… <code>--bind-address</code> ç­‰å‚æ•°æŒ‡å®šæ‰€å¯åŠ¨çš„ HTTP server æ‰€ç»‘å®šçš„åœ°å€ä¹‹ç±»çš„ã€‚</p>
<p>å®ƒå’Œ <code>kube-controller-manager</code> æœ‰ç‚¹ç±»ä¼¼ï¼ŒåŒæ ·æ˜¯é€šè¿‡å®šæ—¶çš„å‘ <code>kube-apiserver</code> è¯·æ±‚è·å–ä¿¡æ¯ï¼Œå¹¶è¿›è¡Œå¤„ç†ã€‚è€Œä»–ä»¬æ‰€èµ·åˆ°çš„ä½œç”¨å¹¶ä¸ç›¸åŒã€‚</p>
<h2 id="kube-scheduler-æœ‰ä»€ä¹ˆä½œç”¨"><code>kube-scheduler</code> æœ‰ä»€ä¹ˆä½œç”¨</h2>
<p>ä»ä¸Šå±‚çš„è§’åº¦æ¥çœ‹ï¼Œ<code>kube-scheduler</code> çš„ä½œç”¨å°±æ˜¯å°†å¾…è°ƒåº¦çš„ <code>Pod</code> è°ƒåº¦è‡³æœ€ä½³çš„ <code>Node</code> ä¸Šï¼Œè€Œè¿™ä¸ªè¿‡ç¨‹ä¸­åˆ™éœ€è¦æ ¹æ®ä¸åŒçš„ç­–ç•¥ï¼Œè€ƒè™‘åˆ° <code>Node</code> çš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œæ¯”å¦‚ç«¯å£ï¼Œå†…å­˜ï¼Œå­˜å‚¨ç­‰ã€‚</p>
<h2 id="kube-scheduler-æ˜¯å¦‚ä½•å·¥ä½œçš„"><code>kube-scheduler</code> æ˜¯å¦‚ä½•å·¥ä½œçš„</h2>
<p>æ•´ä½“çš„è¿‡ç¨‹å¯é€šè¿‡ <code>pkg/scheduler/core/generic_scheduler.go</code> çš„ä»£ç æ¥çœ‹</p>
<pre tabindex="0"><code>func (g *genericScheduler) Schedule(pod *v1.Pod, nodeLister algorithm.NodeLister) (string, error) {
trace := utiltrace.New(fmt.Sprintf(&quot;Scheduling %s/%s&quot;, pod.Namespace, pod.Name))
defer trace.LogIfLong(100 * time.Millisecond)

if err := podPassesBasicChecks(pod, g.pvcLister); err != nil {
return &quot;&quot;, err
}

nodes, err := nodeLister.List()
if err != nil {
return &quot;&quot;, err
}
if len(nodes) == 0 {
return &quot;&quot;, ErrNoNodesAvailable
}

err = g.cache.UpdateNodeNameToInfoMap(g.cachedNodeInfoMap)
if err != nil {
return &quot;&quot;, err
}

trace.Step(&quot;Computing predicates&quot;)
startPredicateEvalTime := time.Now()
filteredNodes, failedPredicateMap, err := g.findNodesThatFit(pod, nodes)
if err != nil {
return &quot;&quot;, err
}

if len(filteredNodes) == 0 {
return &quot;&quot;, &amp;FitError{
Pod:              pod,
NumAllNodes:      len(nodes),
FailedPredicates: failedPredicateMap,
}
}
metrics.SchedulingAlgorithmPredicateEvaluationDuration.Observe(metrics.SinceInMicroseconds(startPredicateEvalTime))
metrics.SchedulingLatency.WithLabelValues(metrics.PredicateEvaluation).Observe(metrics.SinceInSeconds(startPredicateEvalTime))

trace.Step(&quot;Prioritizing&quot;)
startPriorityEvalTime := time.Now()
// When only one node after predicate, just use it.
if len(filteredNodes) == 1 {
metrics.SchedulingAlgorithmPriorityEvaluationDuration.Observe(metrics.SinceInMicroseconds(startPriorityEvalTime))
return filteredNodes[0].Name, nil
}

metaPrioritiesInterface := g.priorityMetaProducer(pod, g.cachedNodeInfoMap)
priorityList, err := PrioritizeNodes(pod, g.cachedNodeInfoMap, metaPrioritiesInterface, g.prioritizers, filteredNodes, g.extenders)
if err != nil {
return &quot;&quot;, err
}
metrics.SchedulingAlgorithmPriorityEvaluationDuration.Observe(metrics.SinceInMicroseconds(startPriorityEvalTime))
metrics.SchedulingLatency.WithLabelValues(metrics.PriorityEvaluation).Observe(metrics.SinceInSeconds(startPriorityEvalTime))

trace.Step(&quot;Selecting host&quot;)
return g.selectHost(priorityList)
}
</code></pre><p>å®ƒçš„è¾“å…¥æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li><code>pod</code>ï¼šå¾…è°ƒåº¦çš„ <code>Pod</code> å¯¹è±¡ï¼›</li>
<li><code>nodeLister</code>ï¼šæ‰€æœ‰å¯ç”¨çš„ <code>Node</code> åˆ—è¡¨</li>
</ul>
<p>å¤‡æ³¨ï¼š<code>nodeLister</code> çš„å®ç°ç¨å¾®ç”¨äº†ç‚¹æŠ€å·§ï¼Œè¿”å›çš„æ˜¯ <code>[]*v1.Node</code> è€Œä¸æ˜¯ <code>v1.NodeList</code> å¯é¿å…æ‹·è´å¸¦æ¥çš„æ€§èƒ½æŸå¤±ã€‚</p>
<pre tabindex="0"><code>type NodeLister interface {
List() ([]*v1.Node, error)
}
</code></pre><h3 id="å¤„ç†é˜¶æ®µ">å¤„ç†é˜¶æ®µ</h3>
<p><code>kube-scheduler</code> å°†å¤„ç†é˜¶æ®µä¸»è¦åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µ <code>Computing predicates</code>ï¼Œ<code>Prioritizing</code>å’Œ <code>Selecting host</code>ï¼š</p>
<ul>
<li>
<p><code>Computing predicates</code>ï¼šä¸»è¦è§£å†³çš„é—®é¢˜æ˜¯ <code>Pod</code> èƒ½å¦è°ƒåº¦åˆ°é›†ç¾¤çš„ <code>Node</code> ä¸Šï¼›</p>
<p>ä¸»è¦æ˜¯é€šè¿‡ä¸€ä¸ªåä¸º <code>podFitsOnNode</code> çš„å‡½æ•°è¿›è¡Œå®ç°ï¼Œåœ¨æ£€æŸ¥çš„è¿‡ç¨‹ä¸­ä¹Ÿä¼šå…ˆå»æ£€æŸ¥ä¸‹æ˜¯å¦å·²ç»æœ‰å·²ç¼“å­˜çš„åˆ¤æ–­ç»“æœï¼Œ å½“ç„¶ä¹Ÿä¼šæ£€æŸ¥ <code>Pod</code> æ˜¯å¦æ˜¯å¯è°ƒåº¦çš„ï¼Œä»¥é˜²æœ‰ <code>Pod Affinity</code> (äº²åˆæ€§) ä¹‹ç±»çš„å­˜åœ¨ã€‚</p>
</li>
<li>
<p><code>Prioritizing</code>ï¼šä¸»è¦è§£å†³çš„é—®é¢˜æ˜¯åœ¨ä¸Šä¸ªé˜¶æ®µé€šè¿‡ <code>findNodesThatFit</code> å¾—åˆ°äº† <code>filteredNodes</code> çš„åŸºç¡€ä¹‹ä¸Šè§£å†³å“ªäº› <code>Node</code> æ˜¯æœ€ä¼˜çš„ï¼Œå¾—åˆ°ä¸€ä¸ªä¼˜å…ˆçº§åˆ—è¡¨ <code>priorityList</code>;</p>
<p>è‡³äºä¼˜å…ˆçº§çš„éƒ¨åˆ†ï¼Œä¸»è¦æ˜¯é€šè¿‡ä¸‹é¢çš„ä»£ç ï¼š</p>
<pre tabindex="0"><code>for i := range nodes {
result = append(result, schedulerapi.HostPriority{Host: nodes[i].Name, Score: 0})
for j := range priorityConfigs {
result[i].Score += results[j][i].Score * priorityConfigs[j].Weight
}
}
</code></pre><p>ç»™æ¯ä¸ªç»è¿‡ç¬¬ä¸€æ­¥ç­›é€‰å‡ºæ¥çš„ <code>Node</code> ä¸€ä¸ª <code>Score</code>ï¼Œå†æŒ‰ç…§å„ç§æ¡ä»¶è¿›è¡Œæ‰“åˆ†ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªä¼˜å…ˆçº§åˆ—è¡¨ã€‚</p>
</li>
<li>
<p><code>Selecting host</code>ï¼šåˆ™æ˜¯æœ€ç»ˆé€‰æ‹© <code>Node</code> è°ƒåº¦åˆ°å“ªå°æœºå™¨ä¸Šã€‚</p>
<p>æœ€åï¼Œåˆ™æ˜¯é€šè¿‡ <code>selectHost</code> é€‰æ‹©å‡ºæœ€ç»ˆè¦è°ƒåº¦åˆ°å“ªå°æœºå™¨ä¸Šã€‚</p>
<pre tabindex="0"><code>func (g *genericScheduler) selectHost(priorityList schedulerapi.HostPriorityList) (string, error) {
    if len(priorityList) == 0 {
        return &quot;&quot;, fmt.Errorf(&quot;empty priorityList&quot;)
    }

    sort.Sort(sort.Reverse(priorityList))
    maxScore := priorityList[0].Score
    firstAfterMaxScore := sort.Search(len(priorityList), func(i int) bool { return priorityList[i].Score &lt; maxScore })

    g.lastNodeIndexLock.Lock()
    ix := int(g.lastNodeIndex % uint64(firstAfterMaxScore))
    g.lastNodeIndex++
    g.lastNodeIndexLock.Unlock()

    return priorityList[ix].Host, nil
}
</code></pre></li>
</ul>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† <code>kube-scheduler</code> ä»¥åŠå®ƒåœ¨è°ƒåº¦ <code>Pod</code> çš„è¿‡ç¨‹ä¸­çš„å¤§è‡´æ­¥éª¤ã€‚</p>
<p>ä¸è¿‡å®ƒå®é™…ä½¿ç”¨çš„å„ç§ç­–ç•¥åŠåˆ¤æ–­æ¡ä»¶å¾ˆå¤šï¼Œæ— æ³•åœ¨ä¸€èŠ‚ä¸­å®Œå…¨éƒ½è¯¦ç»†ä»‹ç»ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥æŒ‰ç…§æœ¬èŠ‚ä¸­æä¾›çš„æ€è·¯å¤§è‡´å»çœ‹çœ‹å®ƒçš„å®ç°ã€‚</p>
<p>æˆ‘ä»¬é€šè¿‡å‰é¢å‡ èŠ‚çš„ä»‹ç»ï¼Œå·²ç»çŸ¥é“äº†å½“å®é™…è¿›è¡Œéƒ¨ç½²æ“ä½œçš„æ—¶å€™ï¼Œé¦–å…ˆä¼šé€šè¿‡ <code>kubectl</code> ä¹‹ç±»çš„å®¢æˆ·ç«¯å·¥å…·ä¸ <code>kube-apiserver</code> è¿›è¡Œäº¤äº’ï¼Œåœ¨ç»è¿‡ä¸€ç³»åˆ—çš„å¤„ç†åï¼Œæ•°æ®å°†æŒä¹…åŒ–åˆ° <code>etcd</code> ä¸­ï¼›</p>
<p>æ­¤æ—¶ï¼Œ<code>kube-controller-manager</code> é€šè¿‡æŒç»­çš„è§‚å¯Ÿï¼Œå¼€å§‹æŒ‰ç…§æˆ‘ä»¬çš„é…ç½®ï¼Œå°†é›†ç¾¤çš„çŠ¶æ€è°ƒæ•´è‡³é¢„æœŸçŠ¶æ€ï¼›</p>
<p>è€Œ <code>kube-scheduler</code> ä¹Ÿåœ¨å‘æŒ¥ä½œç”¨ï¼Œå†³å®š <code>Pod</code> åº”è¯¥è°ƒåº¦è‡³å“ªä¸ªæˆ–è€…å“ªäº› <code>Node</code> ä¸Šï¼›ä¹‹ååˆ™é€šè¿‡å…¶ä»–ç»„ä»¶çš„åä½œï¼Œæœ€æ€»å°†è¯¥ <code>Pod</code> åœ¨ç›¸åº”çš„ <code>Node</code> ä¸Šéƒ¨ç½²å¯åŠ¨ã€‚</p>
<p>æˆ‘ä»¬åœ¨ä¸‹èŠ‚å°†è¦ä»‹ç»çš„ <code>kubelet</code> ä¾¿æ˜¯åé¢è¿™éƒ¨åˆ†â€œå®é™…éƒ¨ç½²åŠ¨ä½œâ€ç›¸å…³çš„ç»„ä»¶ä¸­å°¤ä¸ºé‡è¦çš„ä¸€ä¸ªï¼Œä¸‹èŠ‚æˆ‘ä»¬å†è¯¦ç»†ä»‹ç»å®ƒæ˜¯å¦‚ä½•å®Œæˆè¿™äº›åŠŸèƒ½çš„ã€‚</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/14-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bcontroller-manager/"><span>14 åº–ä¸è§£ç‰›ï¼šcontroller-manager</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/16-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bkubelet/"><span>16 åº–ä¸è§£ç‰›ï¼škubelet</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 28280 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>