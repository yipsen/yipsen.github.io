<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>09 应用发布：部署实际项目 | Yipsen Ye</title>
<meta name="description" content="本节我们开始学习如何将实际项目部署至 K8S 中，开启生产实践之路。
整体概览 本节所用示例项目是一个混合了 Go，NodeJS，Python 等语言的项目，灵感来自于知名程序员 Kenneth Reitz 的 Say Thanks 项目。本项目实现的功能主要有两个：1. 用户通过前端发送感谢消息 2. 有个工作进程会持续的计算收到感谢消息的排行榜。项目代码可在 GitHub 上获得。接下来几节中如果需要用到此项目我会统一称之为 saythx 项目。
saythx 项目的基础结构如下图：
构建镜像 前端 我们使用了前端框架 Vue，所以在做生产部署时，需要先在 Node JS 的环境下进行打包构建。包管理器使用的是 Yarn。然后使用 Nginx 提供服务，并进行反向代理，将请求正确的代理至后端。
FROMnode:10.13 as builderWORKDIR/appCOPY . /appRUN yarn install \  &amp;amp;&amp;amp; yarn buildFROMnginx:1.15COPY nginx.conf /etc/nginx/conf.d/default.confCOPY --from=builder /app/dist /usr/share/nginx/html/EXPOSE80Nginx 的配置文件如下：
upstream backend-up { server saythx-backend:8080; } server { listen 80; server_name localhost; charset utf-8; location / { root /usr/share/nginx/html; try_files $uri $uri/ /index.">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="nav-logo">
    <a href="http://yipsen.github.io/">
        
        <span class="nav-title">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">文章</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">附表</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">关于</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/kubernetes%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/">Kubernetes从上手到实践</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/01-%E5%BC%80%E7%AF%87-kubernetes-%E6%98%AF%E4%BB%80%E4%B9%88%E4%BB%A5%E5%8F%8A%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%AE%83/">01 开篇： Kubernetes 是什么以及为什么需要它</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/02-%E5%88%9D%E6%AD%A5%E8%AE%A4%E8%AF%86kubernetes-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/">02 初步认识：Kubernetes 基础概念</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/03-%E5%AE%8F%E8%A7%82%E8%AE%A4%E8%AF%86%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84/">03 宏观认识：整体架构</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/04-%E6%90%AD%E5%BB%BA-kubernetes-%E9%9B%86%E7%BE%A4-%E6%9C%AC%E5%9C%B0%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA/">04 搭建 Kubernetes 集群 - 本地快速搭建</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/05-%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA-kubernetes-%E9%9B%86%E7%BE%A4-%E7%94%9F%E4%BA%A7%E5%8F%AF%E7%94%A8/">05 动手实践：搭建一个 Kubernetes 集群 - 生产可用</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/06-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%88%9D%E8%AF%86-kubectl/">06 集群管理：初识 kubectl</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/07-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E4%BB%A5-redis-%E4%B8%BA%E4%BE%8B-%E9%83%A8%E7%BD%B2%E5%8F%8A%E8%AE%BF%E9%97%AE/">07 集群管理：以 Redis 为例-部署及访问</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/08-%E5%AE%89%E5%85%A8%E9%87%8D%E7%82%B9-%E8%AE%A4%E8%AF%81%E5%92%8C%E6%8E%88%E6%9D%83/">08 安全重点 认证和授权</a></li>
                
                
                
                    <li>09 应用发布：部署实际项目</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/10-%E5%BA%94%E7%94%A8%E7%AE%A1%E7%90%86%E5%88%9D%E8%AF%86-helm/">10 应用管理：初识 Helm</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/11-%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5%E4%BB%A5-helm-%E9%83%A8%E7%BD%B2%E9%A1%B9%E7%9B%AE/">11 部署实践：以 Helm 部署项目</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/12-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bkube-apiserver/">12 庖丁解牛：kube-apiserver</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/13-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Betcd/">13 庖丁解牛：etcd</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/14-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bcontroller-manager/">14 庖丁解牛：controller-manager</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/15-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bkube-scheduler/">15 庖丁解牛：kube-scheduler</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/16-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bkubelet/">16 庖丁解牛：kubelet</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/17-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bkube-proxy/">17 庖丁解牛：kube-proxy</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/18-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bcontainer-runtime-docker/">18 庖丁解牛：Container Runtime （Docker）</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/19-troubleshoot/">19 Troubleshoot</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/20-%E6%89%A9%E5%B1%95%E5%A2%9E%E5%BC%BAdashboard/">20 扩展增强：Dashboard</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/21-%E6%89%A9%E5%B1%95%E5%A2%9E%E5%BC%BAcoredns/">21 扩展增强：CoreDNS</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/22-%E6%9C%8D%E5%8A%A1%E5%A2%9E%E5%BC%BAingress/">22 服务增强：Ingress</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/23-%E7%9B%91%E6%8E%A7%E5%AE%9E%E8%B7%B5%E5%AF%B9-k8s-%E9%9B%86%E7%BE%A4%E8%BF%9B%E8%A1%8C%E7%9B%91%E6%8E%A7/">23 监控实践：对 K8S 集群进行监控</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/24-%E6%80%BB%E7%BB%93/">24 总结</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">09 应用发布：部署实际项目</h1>
        <div class="post-info">
            <div class="post-date"> 
                <span>2021-12-22 01:47:35</span>
            </div>
        </div>
        <div class="post-content">
            <p>本节我们开始学习如何将实际项目部署至 K8S 中，开启生产实践之路。</p>
<h2 id="整体概览">整体概览</h2>
<p>本节所用示例项目是一个混合了 Go，NodeJS，Python 等语言的项目，灵感来自于知名程序员 <a href="https://github.com/kennethreitz">Kenneth Reitz</a> 的 <a href="https://saythanks.io/">Say Thanks</a> 项目。本项目实现的功能主要有两个：1. 用户通过前端发送感谢消息 2. 有个工作进程会持续的计算收到感谢消息的排行榜。项目代码可在 <a href="https://github.com/tao12345666333/saythx">GitHub 上获得</a>。接下来几节中如果需要用到此项目我会统一称之为 saythx 项目。</p>
<p>saythx 项目的基础结构如下图：</p>
<p><img src="/images/329e053e2055fded086788903a1caaf1a94f42108c100c3106251338c095b63f.png" alt="picture 7"></p>
<h2 id="构建镜像">构建镜像</h2>
<h3 id="前端">前端</h3>
<p>我们使用了前端框架 <a href="https://vuejs.org/">Vue</a>，所以在做生产部署时，需要先在 <a href="https://nodejs.org/">Node JS</a> 的环境下进行打包构建。包管理器使用的是 <a href="https://yarnpkg.com/">Yarn</a>。然后使用 <a href="https://nginx.com/">Nginx</a> 提供服务，并进行反向代理，将请求正确的代理至后端。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> node:10.13 as builder</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> . /app<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> yarn install <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        <span style="color:#f92672">&amp;&amp;</span> yarn build<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> nginx:1.15</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> nginx.conf /etc/nginx/conf.d/default.conf<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>builder /app/dist /usr/share/nginx/html/<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 80</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>Nginx 的配置文件如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#66d9ef">upstream</span> <span style="color:#e6db74">backend-up</span> {
    <span style="color:#f92672">server</span> saythx-backend:<span style="color:#ae81ff">8080</span>;
}
<span style="color:#66d9ef">server</span> {
    <span style="color:#f92672">listen</span>       <span style="color:#ae81ff">80</span>;
    <span style="color:#f92672">server_name</span>  <span style="color:#e6db74">localhost</span>;

    <span style="color:#f92672">charset</span>     <span style="color:#e6db74">utf-8</span>;

    <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
        <span style="color:#f92672">root</span> <span style="color:#e6db74">/usr/share/nginx/html</span>;
        <span style="color:#f92672">try_files</span> $uri $uri/ <span style="color:#e6db74">/index.html</span>;
    }

    <span style="color:#f92672">location</span> ~ <span style="color:#e6db74">^/(api)</span> {
        <span style="color:#f92672">proxy_pass</span>   <span style="color:#e6db74">http://backend-up</span>;
    }
}
</code></pre></div><p>将 API 的请求反向代理到后端服务上。其余请求全部留给前端进行处理。</p>
<h3 id="后端">后端</h3>
<p>后端是使用 <a href="https://golang.org/">Golang</a> 编写的 API 服务，对请求进行相应处理，并将数据存储至 <a href="http://redis.io/">Redis</a> 当中。依赖管理使用的是 <a href="https://github.com/golang/dep">dep</a>。由于 Golang 是编译型语言，编译完成后会生成一个二进制文件，为了让镜像尽可能小，所以 Dockerfile 和前端的差不多，都使用了<a href="https://docs.docker.com/develop/develop-images/multistage-build/">多阶段构建</a>的特性。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> golang:1.11.1 as builder</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /go/src/be</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> . /go/src/be<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> go get -u github.com/golang/dep/cmd/dep <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        <span style="color:#f92672">&amp;&amp;</span> dep ensure <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        <span style="color:#f92672">&amp;&amp;</span> go build<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> debian:stretch-slim</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>builder /go/src/be/be /usr/bin/be<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;/usr/bin/be&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 8080</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>注意这里会暴露出来后端服务所监听的端口。</p>
<h3 id="work">Work</h3>
<p>Work 端使用的是 <a href="https://python.org/">Python</a>，用于计算已经存储至 Redis 当中的数据，并生成排行榜。依赖使用 <a href="https://github.com/pypa/pip">pip</a> 进行安装。对于 Python 的镜像选择，我做了一组<a href="http://moelove.info/docker-python-perf/">性能对比的测试</a> 有兴趣可以了解下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> python:3.7-slim</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> . /app<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> pip install -r requirements.txt<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;python&#34;</span>, <span style="color:#e6db74">&#34;work.py&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><h3 id="构建发布">构建发布</h3>
<p>接下来，我们只要在对应项目目录中，执行 <code>docker build [OPTIONS] PATH</code> 即可。一般我们会使用 <code>-t name:tag</code> 的方式打 tag。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 以下分别是在各模块自己的目录内</span>
➜  be docker build -t  taobeier/saythx-be .
➜  fe docker build -t  taobeier/saythx-fe .
➜  work docker build -t  taobeier/saythx-work .
</code></pre></div><p>需要注意的是，前端项目由于目录内包含开发时的 <code>node_modules</code> 等文件，需要注意添加 <code>.dockerignore</code> 文件，忽略一些非预期的文件。关于 Docker 的 build 原理，有想深入理解的，可参考我之前写的 <a href="http://moelove.info/2018/09/04/Docker-%E6%B7%B1%E5%85%A5%E7%AF%87%E4%B9%8B-Build-%E5%8E%9F%E7%90%86/">Docker 深入篇之 Build 原理</a> 。 当镜像构建完成后，我们需要将它们发布至镜像仓库。这里我们直接使用官方的 <a href="https://hub.docker.com/">Docker Hub</a>，执行 <code>docker login</code> 输入用户名密码验证成功后便可进行发布（需要先去 Docker Hub 注册帐号）。</p>
<p>登录成功后，默认情况下在 <code>$HOME/.docker/config.json</code> 中会存储用户相关凭证。</p>
<p>接下来进行发布只需要执行 <code>docker push</code> 即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜  ~ docker push taobeier/saythx-be
➜  ~ docker push taobeier/saythx-fe
➜  ~ docker push taobeier/saythx-work
</code></pre></div><h2 id="容器编排-docker-compose">容器编排 Docker Compose</h2>
<p><a href="https://docs.docker.com/compose/overview/">Docker Compose</a> 是一种较为简单的可进行容器编排的技术，需要创建一个配置文件，通常情况下为 <code>docker-compose.yml</code> 。在 saythx 项目的根目录下我已经创建好了 <code>docker-compose.yml</code> 的配置文件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3&#39;</span>

<span style="color:#f92672">services</span>:
  <span style="color:#f92672">saythx-frontend</span>:
    <span style="color:#f92672">build</span>:
      <span style="color:#f92672">context</span>: <span style="color:#ae81ff">fe/.</span>
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">taobeier/saythx-fe</span>
    <span style="color:#f92672">ports</span>:
      - <span style="color:#e6db74">&#34;8088:80&#34;</span>
    <span style="color:#f92672">depends_on</span>:
      - <span style="color:#ae81ff">saythx-backend</span>
    <span style="color:#f92672">networks</span>:
      - <span style="color:#ae81ff">saythx</span>

  <span style="color:#f92672">saythx-backend</span>:
    <span style="color:#f92672">build</span>:
      <span style="color:#f92672">context</span>: <span style="color:#ae81ff">be/.</span>
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">taobeier/saythx-be</span>
    <span style="color:#f92672">depends_on</span>:
      - <span style="color:#ae81ff">saythx-redis</span>
    <span style="color:#f92672">networks</span>:
      - <span style="color:#ae81ff">saythx</span>
    <span style="color:#f92672">environment</span>:
      - <span style="color:#ae81ff">REDIS_HOST=saythx-redis</span>
    
  <span style="color:#f92672">saythx-work</span>:
    <span style="color:#f92672">build</span>:
      <span style="color:#f92672">context</span>: <span style="color:#ae81ff">work/.</span>
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">taobeier/saythx-work</span>
    <span style="color:#f92672">depends_on</span>:
      - <span style="color:#ae81ff">saythx-redis</span>
    <span style="color:#f92672">networks</span>:
      - <span style="color:#ae81ff">saythx</span>
    <span style="color:#f92672">environment</span>:
      - <span style="color:#ae81ff">REDIS_HOST=saythx-redis</span>
      - <span style="color:#ae81ff">REDIS_PORT=6379</span>

  <span style="color:#f92672">saythx-redis</span>:
    <span style="color:#f92672">image</span>: <span style="color:#e6db74">&#34;redis:5&#34;</span>
    <span style="color:#f92672">networks</span>:
      - <span style="color:#ae81ff">saythx</span>

<span style="color:#f92672">networks</span>:
  <span style="color:#f92672">saythx</span>:
</code></pre></div><p>在项目的根目录下执行 <code>docker-compose up</code> 即可启动该项目。在浏览器中访问 <a href="http://127.0.0.1:8088/">http://127.0.0.1:8088/</a> 即可看到项目的前端界面。如下图：</p>
<p>打开另外的终端，进入项目根目录内，执行 <code>docker-compose ps</code> 命令即可看到当前的服务情况。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜  saythx git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ docker-compose ps

          Name                        Command               State          Ports
----------------------------------------------------------------------------------------
saythx_saythx-backend_1    /usr/bin/be                      Up      8080/tcp
saythx_saythx-frontend_1   nginx -g daemon off;             Up      0.0.0.0:8088-&gt;80/tcp
saythx_saythx-redis_1      docker-entrypoint.sh redis ...   Up      6379/tcp
saythx_saythx-work_1       python work.py                   Up
</code></pre></div><p>可以看到各组件均是 <code>Up</code> 的状态，相关端口也已经暴露出来。</p>
<p>可在浏览器直接访问体验。由于 <code>Docker Compose</code> 并非本册的重点，故不做太多介绍，可参考官方文档进行学习。接下来进入本节的重点内容，将项目部署至 K8S 中。</p>
<h2 id="编写配置文件并部署">编写配置文件并部署</h2>
<p>在 K8S 中进行部署或者说与 K8S 交互的方式主要有三种：</p>
<ul>
<li>命令式</li>
<li>命令式对象配置</li>
<li>声明式对象配置</li>
</ul>
<p>第 7 节介绍过的 <code>kubectl run redis --image='redis:alpine'</code> 这种方式便是命令式，这种方式很简单，但是可重用性低。毕竟你的命令执行完后，其他人也并不清楚到底发生了什么。</p>
<p>命令式对象配置，主要是编写配置文件，但是通过类似 <code>kubectl create</code> 之类命令式的方式进行操作。</p>
<p>再有一种便是声明式对象配置，主要也是通过编写配置文件，但是使用 <code>kubectl apply</code> 之类的放好似进行操作。与第二种命令式对象配置的区别主要在于对对象的操作将会得到保留。但同时这种方式有时候也并不好进行调试。</p>
<p>接下来，为 saythx 项目编写配置文件，让它可以部署至 K8S 中。当然，这里我们已经创建过了 <code>docker-compose.yml</code> 的配置文件，并且也验证了其可用性，可以直接使用 <a href="https://github.com/kubernetes/kompose">Kompose</a> 工具将 <code>docker-compose.yml</code> 的配置文件进行转换。</p>
<p>但这里采用直接编写的方式。同时，我们部署至一个新的名为 <code>work</code> 的 <code>Namespace</code> 中。</p>
<h3 id="namespace">Namespace</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Namespace</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">work</span>
</code></pre></div><p>指定了 <code>Namespace</code> name 为 <code>work</code>。然后进行部署</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜  conf git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ kubectl apply -f namespace.yaml 
namespace/work created
</code></pre></div><h3 id="redis-资源">Redis 资源</h3>
<p>从前面的 <code>docker-compose.yml</code> 中也能发现，saythx 中各个组件，只有 Redis 是无任何依赖的。我们先对它进行部署。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">saythx-redis</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">work</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">redis</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis:5</span>
        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
        <span style="color:#f92672">ports</span>:
        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">6379</span>
</code></pre></div><p>由于这是本册内第一次出现完整的 <code>Deployment</code> 配置文件，故而进行重点介绍。</p>
<ul>
<li><code>apiVersion</code> ：指定了 API 的版本号，当前我们使用的 K8S 中， <code>Deployment</code> 的版本号为 <code>apps/v1</code>，而在 1.9 之前使用的版本则为 <code>apps/v1beta2</code>，在 1.8 之前的版本使用的版本为 <code>extensions/v1beta1</code>。在编写配置文件时需要格外注意。</li>
<li><code>kind</code> ：指定了资源的类型。这里指定为 <code>Deployment</code> 说明是一次部署。</li>
<li><code>metadata</code> ：指定了资源的元信息。例如其中的 <code>name</code> 和 <code>namespace</code> 分别表示资源名称和所归属的 <code>Namespace</code>。</li>
<li><code>spec</code> ：指定了对资源的配置信息。例如其中的 <code>replicas</code> 指定了副本数当前指定为 1 。<code>template.spec</code> 则指定了 <code>Pod</code> 中容器的配置信息，这里的 <code>Pod</code> 中只部署了一个容器。</li>
</ul>
<p>配置文件已经生产，现在对它进行部署。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜  conf git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ kubectl -n work get all
No resources found.
➜  conf git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ kubectl apply -f redis-deployment.yaml
deployment.apps/saythx-redis created
➜  conf git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ kubectl -n work get all
NAME                                READY     STATUS    RESTARTS   AGE
pod/saythx-redis-79d8f9864d-x8fp9   1/1       Running   <span style="color:#ae81ff">0</span>          4s

NAME                           DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/saythx-redis   <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           4s

NAME                                      DESIRED   CURRENT   READY     AGE
replicaset.apps/saythx-redis-79d8f9864d   <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         4s
</code></pre></div><p>可以看到 <code>Pod</code> 已经在正常运行了。我们进入 <code>Pod</code> 内进行测试。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜  conf git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ kubectl -n work exec -it saythx-redis-79d8f9864d-x8fp9 bash
root@saythx-redis-79d8f9864d-x8fp9:/data# redis-cli
127.0.0.1:6379&gt; ping
PONG
</code></pre></div><p>响应正常。</p>
<h3 id="redis-service">Redis service</h3>
<p>由于 <code>Redis</code> 是后端服务的依赖，我们将它作为 <code>Service</code> 暴露出来。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">saythx-redis</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">work</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">6379</span>
    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">6379</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span>
</code></pre></div><p>关于 <code>Service</code> 的内容，可参考第 7 节，我们详细做过解释。这里直接使用配置文件进行部署。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜  conf git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ kubectl apply -f redis-service.yaml
service/saythx-redis created
➜  conf git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ kubectl get svc -n work
NAME           TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>          AGE
saythx-redis   NodePort   10.107.31.242   &lt;none&gt;        6379:31467/TCP   1m
</code></pre></div><h3 id="后端服务">后端服务</h3>
<p>接下来，我们对后端服务进行部署。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">backend</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">saythx-backend</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">work</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">backend</span>
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">backend</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">env</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">REDIS_HOST</span>
          <span style="color:#f92672">value</span>: <span style="color:#ae81ff">saythx-redis</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">taobeier/saythx-be</span>
        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">backend</span>
        <span style="color:#f92672">ports</span>:
        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span>
</code></pre></div><p>可以看到这里通过环境变量的方式，将 <code>REDIS_HOST</code> 传递给了后端服务。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜  conf git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ kubectl apply -f backend-deployment.yaml
deployment.apps/saythx-backend created
➜  conf git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ kubectl -n work get all
NAME                                 READY     STATUS              RESTARTS   AGE
pod/saythx-backend-c5f9f6d95-lmtxn   0/1       ContainerCreating   <span style="color:#ae81ff">0</span>          5s
pod/saythx-redis-8558c7d7d-kcmzk     1/1       Running             <span style="color:#ae81ff">0</span>          17m

NAME                   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>          AGE
service/saythx-redis   NodePort   10.107.31.242   &lt;none&gt;        6379:31467/TCP   1m

NAME                             DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/saythx-backend   <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">0</span>           5s
deployment.apps/saythx-redis     <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           17m

NAME                                       DESIRED   CURRENT   READY     AGE
replicaset.apps/saythx-backend-c5f9f6d95   <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">0</span>         5s
replicaset.apps/saythx-redis-8558c7d7d     <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         17m
</code></pre></div><h3 id="后端-service">后端 Service</h3>
<p>后端服务是前端项目的依赖，故而我们也将其作为 <code>Service</code> 暴露出来。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">backend</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">saythx-backend</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">work</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8080</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">backend</span>
  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span>
</code></pre></div><p>通过配置文件进行部署。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜  conf git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ kubectl apply -f backend-service.yaml
service/saythx-backend created
➜  conf git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ kubectl get svc -n work
NAME                     TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>          AGE
service/saythx-backend   NodePort   10.104.0.47     &lt;none&gt;        8080:32051/TCP   8s
service/saythx-redis     NodePort   10.107.31.242   &lt;none&gt;        6379:31467/TCP   3m
</code></pre></div><p>我们同样使用 <code>NodePort</code> 将其暴露出来，并在本地进行测试。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜  conf git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ curl http://127.0.0.1:32051/api/v1/list
<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;HonorDatas&#34;</span>:null<span style="color:#f92672">}</span>
</code></pre></div><p>服务可正常响应。</p>
<h3 id="前端-1">前端</h3>
<p>接下来我们编写前端的配置文件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">frontend</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">saythx-frontend</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">work</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">frontend</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">frontend</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">taobeier/saythx-fe</span>
        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">frontend</span>
        <span style="color:#f92672">ports</span>:
        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</code></pre></div><p>需要注意的是，我们必须在后端 <code>Service</code> 暴露出来后才能进行前端的部署，因为前端镜像中 Nginx 的反向代理配置中会去检查后端是否可达。使用配置文件进行部署。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜  conf git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ kubectl apply -f frontend-deployment.yaml
deployment.apps/saythx-frontend created
➜  conf git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ kubectl -n work get all
NAME                                   READY     STATUS    RESTARTS   AGE
pod/saythx-backend-c5f9f6d95-lmtxn     1/1       Running   <span style="color:#ae81ff">0</span>          16m
pod/saythx-frontend-678d544b86-wp9gr   1/1       Running   <span style="color:#ae81ff">0</span>          30s
pod/saythx-redis-8558c7d7d-kcmzk       1/1       Running   <span style="color:#ae81ff">0</span>          34m

NAME                     TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>          AGE
service/saythx-backend   NodePort   10.104.0.47     &lt;none&gt;        8080:32051/TCP   15m
service/saythx-redis     NodePort   10.107.31.242   &lt;none&gt;        6379:31467/TCP   18m

NAME                              DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/saythx-backend    <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           16m
deployment.apps/saythx-frontend   <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           30s
deployment.apps/saythx-redis      <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           34m

NAME                                         DESIRED   CURRENT   READY     AGE
replicaset.apps/saythx-backend-c5f9f6d95     <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         16m
replicaset.apps/saythx-frontend-678d544b86   <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         30s
replicaset.apps/saythx-redis-8558c7d7d       <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         34m
</code></pre></div><h3 id="前端-service">前端 Service</h3>
<p>接下来，我们需要让前端可以被直接访问到，同样的需要将它以 <code>Service</code> 的形式暴露出来。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">frontend</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">saythx-frontend</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">work</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;80&#34;</span>
    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">frontend</span>
  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span>
</code></pre></div><p>创建 <code>Service</code> 。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜  conf git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ kubectl apply -f frontend-service.yaml
service/saythx-frontend created
➜  conf git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ kubectl -n work get svc
NAME              TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>          AGE
saythx-backend    NodePort   10.104.0.47     &lt;none&gt;        8080:32051/TCP   17m
saythx-frontend   NodePort   10.96.221.71    &lt;none&gt;        80:32682/TCP     11s
saythx-redis      NodePort   10.107.31.242   &lt;none&gt;        6379:31467/TCP   20m
</code></pre></div><p>我们可以直接通过 Node 的 32682 端口进行访问。</p>
<h3 id="work-1">Work</h3>
<p>最后，是我们的 Work 组件，为它编写配置文件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">work</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">saythx-work</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">work</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">work</span>
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">work</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">env</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">REDIS_HOST</span>
          <span style="color:#f92672">value</span>: <span style="color:#ae81ff">saythx-redis</span>
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">REDIS_PORT</span>
          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;6379&#34;</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">taobeier/saythx-work</span>
        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">work</span>
</code></pre></div><p>同样的，我们通过环境变量的方式传递了 Redis 相关的配置进去。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜  conf git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ kubectl apply -f work-deployment.yaml
deployment.apps/saythx-work created
➜  conf git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ kubectl -n work get all
NAME                                   READY     STATUS              RESTARTS   AGE
pod/saythx-backend-c5f9f6d95-lmtxn     1/1       Running             <span style="color:#ae81ff">0</span>          22m
pod/saythx-frontend-678d544b86-wp9gr   1/1       Running             <span style="color:#ae81ff">0</span>          5m
pod/saythx-redis-8558c7d7d-kcmzk       1/1       Running             <span style="color:#ae81ff">0</span>          39m
pod/saythx-work-6b9958dc47-hh9td       0/1       ContainerCreating   <span style="color:#ae81ff">0</span>          7s

NAME                      TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>          AGE
service/saythx-backend    NodePort   10.104.0.47     &lt;none&gt;        8080:32051/TCP   20m
service/saythx-frontend   NodePort   10.96.221.71    &lt;none&gt;        80:32682/TCP     3m
service/saythx-redis      NodePort   10.107.31.242   &lt;none&gt;        6379:31467/TCP   23m

NAME                              DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/saythx-backend    <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           22m
deployment.apps/saythx-frontend   <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           5m
deployment.apps/saythx-redis      <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           39m
deployment.apps/saythx-work       <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">0</span>           7s

NAME                                         DESIRED   CURRENT   READY     AGE
replicaset.apps/saythx-backend-c5f9f6d95     <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         22m
replicaset.apps/saythx-frontend-678d544b86   <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         5m
replicaset.apps/saythx-redis-8558c7d7d       <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         39m
replicaset.apps/saythx-work-6b9958dc47       <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">0</span>         7s
</code></pre></div><p>现在均已经部署完成。并且可直接通过 Node 端口进行访问。</p>
<h2 id="扩缩容">扩缩容</h2>
<p>如果我们觉得排行榜生成效率较低，则可通过扩容 Work 来得到解决。具体做法是可修改 work 的 <code>Deployment</code> 配置文件，将 <code>spec.replicas</code> 设置为预期的数值，之后执行 <code>kubectl -f work-deployment.yaml</code> 即可。</p>
<p>或者可直接通过命令行进行操作</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜  conf git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ kubectl -n work scale --replicas<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>  deployment/saythx-work
</code></pre></div><p>上面的命令是将 <code>saythx-work</code> 的部署副本数设置为 2 。缩容也差不多是类似的操作。</p>
<h2 id="总结">总结</h2>
<p>通过本节的学习，我们已经学习到了如何将项目实际部署至 K8S 中，可以手动编写配置也可以利用一些工具进行辅助。同时也了解到了如何应对应用的扩缩容。</p>
<p>但如果应用需要进行升级的话，则需要去更改配置文件中相关的配置，这个过程会较为繁琐，并且整体项目线上的版本管理也是个问题：比如组件的个人升级，回滚之间如果有依赖的话，会比较麻烦。我们在接下来的两节来学习如何解决这个问题。</p>

        </div>
    </article>
</div>
<div class="division-line"></div>
<div class="others">
    <div>标签：🏷️<a class="post-tag" href="/tags/kubernetes/">kubernetes</a>&nbsp;</div>
    <div>分类： 📒<a class="post-category" href="/categories/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/">Kubernetes从上手到实践</a>&nbsp; </div>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/08-%E5%AE%89%E5%85%A8%E9%87%8D%E7%82%B9-%E8%AE%A4%E8%AF%81%E5%92%8C%E6%8E%88%E6%9D%83/"><span>08 安全重点 认证和授权</span></a>
    </div>
    <div class="next">
        
        <a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/10-%E5%BA%94%E7%94%A8%E7%AE%A1%E7%90%86%E5%88%9D%E8%AF%86-helm/"><span>10 应用管理：初识 Helm</span></a>
    </div>
</div>

        </div>
        <div id="float">
            <ul class="float-button-bar">
    <li>
        <button class="float-button top" onclick="scrollToTop(this);">UP</button>
    </li>
    <li>
        <button class="float-button toggler" onclick="changeSkin(this);">DARK</button>
    </li>
</ul>
        </div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 2020 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    const changeSkin = () => {
        document.getElementById('page').classList.toggle('night');
    }
    const scrollToTop = () => {
        window.scrollTo(0, 0);
    }
</script>
</body>

</html>