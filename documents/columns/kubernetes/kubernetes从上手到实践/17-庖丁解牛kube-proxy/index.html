<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>17 åº–ä¸è§£ç‰›ï¼škube-proxy | Yipsen Ye</title>
<meta name="description" content="æ•´ä½“æ¦‚è§ˆ åœ¨ç¬¬ 3 èŠ‚ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ° kube-proxy çš„å­˜åœ¨ï¼Œè€Œåœ¨ç¬¬ 7 ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ åˆ°äº†å¦‚ä½•å°†è¿è¡Œäº K8S ä¸­çš„æœåŠ¡ä»¥ Service çš„æ–¹å¼æš´éœ²å‡ºæ¥ï¼Œä»¥ä¾›è®¿é—®ã€‚
æœ¬èŠ‚ï¼Œæˆ‘ä»¬æ¥ä»‹ç»ä¸‹ kube-proxy äº†è§£ä¸‹å®ƒæ˜¯å¦‚ä½•æ”¯æ’‘èµ·è¿™ç§ç±»ä¼¼æœåŠ¡å‘ç°å’Œä»£ç†ç›¸å…³åŠŸèƒ½çš„ã€‚
kube-proxy æ˜¯ä»€ä¹ˆ kube-proxy æ˜¯ K8S è¿è¡Œäºæ¯ä¸ª Node ä¸Šçš„ç½‘ç»œä»£ç†ç»„ä»¶ï¼Œæä¾›äº† TCP å’Œ UDP çš„è¿æ¥è½¬å‘æ”¯æŒã€‚
æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œå½“ Pod åœ¨åˆ›å»ºå’Œé”€æ¯çš„è¿‡ç¨‹ä¸­ï¼ŒIP å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè€Œè¿™å°±å®¹æ˜“é€ æˆå¯¹å…¶æœ‰ä¾èµ–çš„æœåŠ¡çš„å¼‚å¸¸ï¼Œæ‰€ä»¥é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½ä¼šä½¿ç”¨ Service å°†åç«¯ Pod æš´éœ²å‡ºæ¥ï¼Œè€Œ Service åˆ™è¾ƒä¸ºç¨³å®šã€‚
è¿˜æ˜¯ä»¥æˆ‘ä»¬ä¹‹å‰çš„ SayThx é¡¹ç›®ä¸ºä¾‹ï¼Œä½†æˆ‘ä»¬åªéƒ¨ç½²å…¶ä¸­æ²¡æœ‰ä»»ä½•ä¾èµ–çš„åç«¯èµ„æº Redis ã€‚
master $ git clone https://github.com/tao12345666333/saythx.gitCloning into &#39;saythx&#39;...remote: Enumerating objects: 110, done.remote: Counting objects: 100% (110/110), done.remote: Compressing objects: 100% (82/82), done.remote: Total 110 (delta 27), reused 102 (delta 20), pack-reused 0Receiving objects: 100% (110/110), 119.">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/kubernetes%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/">Kubernetesä»ä¸Šæ‰‹åˆ°å®è·µ</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/01-%E5%BC%80%E7%AF%87-kubernetes-%E6%98%AF%E4%BB%80%E4%B9%88%E4%BB%A5%E5%8F%8A%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%AE%83/">01 å¼€ç¯‡ï¼š Kubernetes æ˜¯ä»€ä¹ˆä»¥åŠä¸ºä»€ä¹ˆéœ€è¦å®ƒ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/02-%E5%88%9D%E6%AD%A5%E8%AE%A4%E8%AF%86kubernetes-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/">02 åˆæ­¥è®¤è¯†ï¼šKubernetes åŸºç¡€æ¦‚å¿µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/03-%E5%AE%8F%E8%A7%82%E8%AE%A4%E8%AF%86%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84/">03 å®è§‚è®¤è¯†ï¼šæ•´ä½“æ¶æ„</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/04-%E6%90%AD%E5%BB%BA-kubernetes-%E9%9B%86%E7%BE%A4-%E6%9C%AC%E5%9C%B0%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA/">04 æ­å»º Kubernetes é›†ç¾¤ - æœ¬åœ°å¿«é€Ÿæ­å»º</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/05-%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA-kubernetes-%E9%9B%86%E7%BE%A4-%E7%94%9F%E4%BA%A7%E5%8F%AF%E7%94%A8/">05 åŠ¨æ‰‹å®è·µï¼šæ­å»ºä¸€ä¸ª Kubernetes é›†ç¾¤ - ç”Ÿäº§å¯ç”¨</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/06-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%88%9D%E8%AF%86-kubectl/">06 é›†ç¾¤ç®¡ç†ï¼šåˆè¯† kubectl</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/07-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E4%BB%A5-redis-%E4%B8%BA%E4%BE%8B-%E9%83%A8%E7%BD%B2%E5%8F%8A%E8%AE%BF%E9%97%AE/">07 é›†ç¾¤ç®¡ç†ï¼šä»¥ Redis ä¸ºä¾‹-éƒ¨ç½²åŠè®¿é—®</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/08-%E5%AE%89%E5%85%A8%E9%87%8D%E7%82%B9-%E8%AE%A4%E8%AF%81%E5%92%8C%E6%8E%88%E6%9D%83/">08 å®‰å…¨é‡ç‚¹ è®¤è¯å’Œæˆæƒ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/09-%E5%BA%94%E7%94%A8%E5%8F%91%E5%B8%83%E9%83%A8%E7%BD%B2%E5%AE%9E%E9%99%85%E9%A1%B9%E7%9B%AE/">09 åº”ç”¨å‘å¸ƒï¼šéƒ¨ç½²å®é™…é¡¹ç›®</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/10-%E5%BA%94%E7%94%A8%E7%AE%A1%E7%90%86%E5%88%9D%E8%AF%86-helm/">10 åº”ç”¨ç®¡ç†ï¼šåˆè¯† Helm</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/11-%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5%E4%BB%A5-helm-%E9%83%A8%E7%BD%B2%E9%A1%B9%E7%9B%AE/">11 éƒ¨ç½²å®è·µï¼šä»¥ Helm éƒ¨ç½²é¡¹ç›®</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/12-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bkube-apiserver/">12 åº–ä¸è§£ç‰›ï¼škube-apiserver</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/13-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Betcd/">13 åº–ä¸è§£ç‰›ï¼šetcd</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/14-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bcontroller-manager/">14 åº–ä¸è§£ç‰›ï¼šcontroller-manager</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/15-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bkube-scheduler/">15 åº–ä¸è§£ç‰›ï¼škube-scheduler</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/16-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bkubelet/">16 åº–ä¸è§£ç‰›ï¼škubelet</a></li>
                
                
                
                    <li>17 åº–ä¸è§£ç‰›ï¼škube-proxy</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/18-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bcontainer-runtime-docker/">18 åº–ä¸è§£ç‰›ï¼šContainer Runtime ï¼ˆDockerï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/19-troubleshoot/">19 Troubleshoot</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/20-%E6%89%A9%E5%B1%95%E5%A2%9E%E5%BC%BAdashboard/">20 æ‰©å±•å¢å¼ºï¼šDashboard</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/21-%E6%89%A9%E5%B1%95%E5%A2%9E%E5%BC%BAcoredns/">21 æ‰©å±•å¢å¼ºï¼šCoreDNS</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/22-%E6%9C%8D%E5%8A%A1%E5%A2%9E%E5%BC%BAingress/">22 æœåŠ¡å¢å¼ºï¼šIngress</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/23-%E7%9B%91%E6%8E%A7%E5%AE%9E%E8%B7%B5%E5%AF%B9-k8s-%E9%9B%86%E7%BE%A4%E8%BF%9B%E8%A1%8C%E7%9B%91%E6%8E%A7/">23 ç›‘æ§å®è·µï¼šå¯¹ K8S é›†ç¾¤è¿›è¡Œç›‘æ§</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/24-%E6%80%BB%E7%BB%93/">24 æ€»ç»“</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">17 åº–ä¸è§£ç‰›ï¼škube-proxy</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2021-12-22 01:47:43</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/kubernetes/">kubernetes</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/">Kubernetesä»ä¸Šæ‰‹åˆ°å®è·µ</a>
                
            </div></div>
        <div class="post-content">
            <h2 id="æ•´ä½“æ¦‚è§ˆ">æ•´ä½“æ¦‚è§ˆ</h2>
<p>åœ¨ç¬¬ 3 èŠ‚ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ° <code>kube-proxy</code> çš„å­˜åœ¨ï¼Œè€Œåœ¨ç¬¬ 7 ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ åˆ°äº†å¦‚ä½•å°†è¿è¡Œäº K8S ä¸­çš„æœåŠ¡ä»¥ <code>Service</code> çš„æ–¹å¼æš´éœ²å‡ºæ¥ï¼Œä»¥ä¾›è®¿é—®ã€‚</p>
<p>æœ¬èŠ‚ï¼Œæˆ‘ä»¬æ¥ä»‹ç»ä¸‹ <code>kube-proxy</code> äº†è§£ä¸‹å®ƒæ˜¯å¦‚ä½•æ”¯æ’‘èµ·è¿™ç§ç±»ä¼¼æœåŠ¡å‘ç°å’Œä»£ç†ç›¸å…³åŠŸèƒ½çš„ã€‚</p>
<h2 id="kube-proxy-æ˜¯ä»€ä¹ˆ"><code>kube-proxy</code> æ˜¯ä»€ä¹ˆ</h2>
<p><code>kube-proxy</code> æ˜¯ K8S è¿è¡Œäºæ¯ä¸ª <code>Node</code> ä¸Šçš„ç½‘ç»œä»£ç†ç»„ä»¶ï¼Œæä¾›äº† TCP å’Œ UDP çš„è¿æ¥è½¬å‘æ”¯æŒã€‚</p>
<p>æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œå½“ <code>Pod</code> åœ¨åˆ›å»ºå’Œé”€æ¯çš„è¿‡ç¨‹ä¸­ï¼ŒIP å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè€Œè¿™å°±å®¹æ˜“é€ æˆå¯¹å…¶æœ‰ä¾èµ–çš„æœåŠ¡çš„å¼‚å¸¸ï¼Œæ‰€ä»¥é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½ä¼šä½¿ç”¨ <code>Service</code> å°†åç«¯ <code>Pod</code> æš´éœ²å‡ºæ¥ï¼Œè€Œ <code>Service</code> åˆ™è¾ƒä¸ºç¨³å®šã€‚</p>
<p>è¿˜æ˜¯ä»¥æˆ‘ä»¬ä¹‹å‰çš„ <a href="https://github.com/tao12345666333/saythx"><code>SayThx</code></a> é¡¹ç›®ä¸ºä¾‹ï¼Œä½†æˆ‘ä»¬åªéƒ¨ç½²å…¶ä¸­æ²¡æœ‰ä»»ä½•ä¾èµ–çš„åç«¯èµ„æº <code>Redis</code> ã€‚</p>
<pre tabindex="0"><code>master $ git clone https://github.com/tao12345666333/saythx.git
Cloning into 'saythx'...
remote: Enumerating objects: 110, done.
remote: Counting objects: 100% (110/110), done.
remote: Compressing objects: 100% (82/82), done.
remote: Total 110 (delta 27), reused 102 (delta 20), pack-reused 0
Receiving objects: 100% (110/110), 119.42 KiB | 0 bytes/s, done.
Resolving deltas: 100% (27/27), done.
Checking connectivity... done.
master $ cd saythx/deploy
master $ ls
backend-deployment.yaml  frontend-deployment.yaml  namespace.yaml         redis-service.yaml
backend-service.yaml     frontend-service.yaml     redis-deployment.yaml  work-deployment.yaml
</code></pre><p>è¿›å…¥é…ç½®æ–‡ä»¶æ‰€åœ¨ç›®å½•åï¼Œå¼€å§‹åˆ›å»ºç›¸å…³èµ„æºï¼š</p>
<pre tabindex="0"><code>master $ kubectl apply -f namespace.yaml
namespace/work created
master $ kubectl apply -f redis-deployment.yaml
deployment.apps/saythx-redis created
master $ kubectl  apply -f redis-service.yaml
service/saythx-redis created
master $ kubectl -n work get all
NAME                               READY     STATUS    RESTARTS   AGE
pod/saythx-redis-8558c7d7d-wsn2w   1/1       Running   0          21s

NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
service/saythx-redis   NodePort   10.103.193.175   &lt;none&gt;        6379:31269/TCP   6s

NAME                           DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/saythx-redis   1         1         1            1           21s

NAME                                     DESIRED   CURRENT   READY     AGE
replicaset.apps/saythx-redis-8558c7d7d   1         1         1         21s
</code></pre><p>å¯ä»¥çœ‹åˆ° Redis æ­£åœ¨è¿è¡Œï¼Œå¹¶é€šè¿‡ <code>NodePort</code> ç±»å‹çš„ <code>Service</code> æš´éœ²å‡ºæ¥ï¼Œæˆ‘ä»¬è®¿é—®æ¥ç¡®è®¤ä¸‹ã€‚</p>
<pre tabindex="0"><code>master $ docker run --rm -it --network host redis:alpine redis-cli -p 31269
Unable to find image 'redis:alpine' locally
alpine: Pulling from library/redis
4fe2ade4980c: Already exists
fb758dc2e038: Pull complete
989f7b0c858b: Pull complete
8dd99d530347: Pull complete
7137334fa8f0: Pull complete
30610ca64487: Pull complete
Digest: sha256:8fd83c5986f444f1a5521e3eda7395f0f21ff16d33cc3b89d19ca7c58293c5dd
Status: Downloaded newer image for redis:alpine
127.0.0.1:31269&gt; set name kubernetes
OK
127.0.0.1:31269&gt; get name 
&quot;kubernetes&quot;
</code></pre><p>å¯ä»¥çœ‹åˆ°å·²ç»å¯ä»¥æ­£å¸¸è®¿é—®ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ <code>31269</code> è¿™ä¸ªç«¯å£çš„çŠ¶æ€ã€‚</p>
<pre tabindex="0"><code>master $ netstat  -ntlp |grep 31269
tcp6       0      0 :::31269                :::*                    LISTEN      2716/kube-proxy
</code></pre><p>å¯ä»¥çœ‹åˆ°è¯¥ç«¯å£æ˜¯ç”± <code>kube-proxy</code> æ‰€å ç”¨çš„ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼ŒæŸ¥çœ‹å½“å‰é›†ç¾¤çš„ <code>Service</code> å’Œ <code>Endpoint</code></p>
<pre tabindex="0"><code>master $ kubectl -n work get svc
NAME           TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
saythx-redis   NodePort   10.103.193.175   &lt;none&gt;        6379:31269/TCP   10m
master $ kubectl -n work get endpoints
NAME           ENDPOINTS        AGE
saythx-redis   10.32.0.2:6379   10m
master $ kubectl -n work get pod -o wide
NAME                           READY     STATUS    RESTARTS   AGE       IP          NODE      NOMINATED NODE
saythx-redis-8558c7d7d-wsn2w   1/1       Running   0          12m       10.32.0.2   node01    &lt;none&gt;
</code></pre><p>å¯ä»¥å¾ˆç›´è§‚çš„çœ‹åˆ° <code>Endpoint</code> å½“ä¸­çš„ä¾¿æ˜¯ <code>Pod</code> çš„ IPï¼Œç°åœ¨æˆ‘ä»¬å°†è¯¥æœåŠ¡è¿›è¡Œæ‰©å®¹ï¼ˆå®é™…æƒ…å†µä¸‹å¹¶ä¸ä¼šè¿™æ ·å¤„ç†ï¼‰ã€‚</p>
<p>ç›´æ¥é€šè¿‡ <code>kubectl scale</code> æ“ä½œ</p>
<pre tabindex="0"><code>master $ kubectl  -n work scale --replicas=2 deploy/saythx-redis
deployment.extensions/saythx-redis scaled
master $ kubectl  -n work get all
NAME                               READY     STATUS    RESTARTS   AGE
pod/saythx-redis-8558c7d7d-sslpj   1/1       Running   0          10s
pod/saythx-redis-8558c7d7d-wsn2w   1/1       Running   0          16m

NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
service/saythx-redis   NodePort   10.103.193.175   &lt;none&gt;        6379:31269/TCP   16m

NAME                           DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/saythx-redis   2         2         2            2           16m
</code></pre><p>æŸ¥çœ‹ <code>Endpoint</code> ä¿¡æ¯ï¼š</p>
<pre tabindex="0"><code>master $ kubectl -n work get endpoints
NAME           ENDPOINTS                       AGE
saythx-redis   10.32.0.2:6379,10.32.0.3:6379   17m
</code></pre><p>å¯ä»¥çœ‹åˆ° <code>Endpoint</code> å·²ç»è‡ªåŠ¨å‘ç”Ÿäº†å˜åŒ–ï¼Œè€Œè¿™ä¹Ÿæ„å‘³ç€ <code>Service</code> ä»£ç†çš„åç«¯èŠ‚ç‚¹å°†å¢åŠ ä¸€ä¸ªã€‚</p>
<h2 id="kube-proxy-å¦‚ä½•å·¥ä½œ"><code>kube-proxy</code> å¦‚ä½•å·¥ä½œ</h2>
<p><code>kube-proxy</code> åœ¨ Linux ç³»ç»Ÿä¸Šå½“å‰æ”¯æŒä¸‰ç§æ¨¡å¼ï¼Œå¯é€šè¿‡ <code>--proxy-mode</code> é…ç½®ï¼š</p>
<ul>
<li><code>userspace</code>ï¼šè¿™æ˜¯å¾ˆæ—©æœŸçš„ä¸€ç§æ–¹æ¡ˆï¼Œä½†æ•ˆç‡ä¸Šæ˜¾è‘—ä¸è¶³ï¼Œä¸æ¨èä½¿ç”¨ã€‚</li>
<li><code>iptables</code>ï¼šå½“å‰çš„é»˜è®¤æ¨¡å¼ã€‚æ¯” <code>userspace</code> è¦å¿«ï¼Œä½†é—®é¢˜æ˜¯ä¼šç»™æœºå™¨ä¸Šäº§ç”Ÿå¾ˆå¤š <code>iptables</code> è§„åˆ™ã€‚</li>
<li><code>ipvs</code>ï¼šä¸ºäº†è§£å†³ <code>iptables</code> çš„æ€§èƒ½é—®é¢˜è€Œå¼•å…¥ï¼Œé‡‡ç”¨å¢é‡çš„æ–¹å¼è¿›è¡Œæ›´æ–°ã€‚</li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬ä»¥ <code>iptables</code> çš„æ¨¡å¼ç¨ä½œä»‹ç»ã€‚</p>
<pre tabindex="0"><code>master $ iptables -t nat -L 
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination
KUBE-SERVICES  all  --  anywhere             anywhere             /* kubernetes service portals */
DOCKER     all  --  anywhere             anywhere             ADDRTYPE match dst-type LOCAL

Chain INPUT (policy ACCEPT)
target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination
KUBE-SERVICES  all  --  anywhere             anywhere             /* kubernetes service portals */
DOCKER     all  --  anywhere            !127.0.0.0/8          ADDRTYPE match dst-type LOCAL

Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination
KUBE-POSTROUTING  all  --  anywhere             anywhere             /* kubernetes postrouting rules */
MASQUERADE  all  --  172.18.0.0/24        anywhere

Chain DOCKER (2 references)
target     prot opt source               destination
RETURN     all  --  anywhere             anywhere

Chain KUBE-MARK-DROP (0 references)
target     prot opt source               destination
MARK       all  --  anywhere             anywhere             MARK or 0x8000

Chain KUBE-MARK-MASQ (7 references)
target     prot opt source               destination
MARK       all  --  anywhere             anywhere             MARK or 0x4000

Chain KUBE-NODEPORTS (1 references)
target     prot opt source               destination
KUBE-MARK-MASQ  tcp  --  anywhere             anywhere             /* work/saythx-redis: */ tcp dpt:31269
KUBE-SVC-SMQNAAUIAENDDGYQ  tcp  --  anywhere             anywhere             /* work/saythx-redis: */ tcp dpt:31269

Chain KUBE-POSTROUTING (1 references)
target     prot opt source               destination
MASQUERADE  all  --  anywhere             anywhere             /* kubernetes service traffic requiring SNAT */ mark match 0x4000/0x4000

Chain KUBE-SEP-2LZPYBS4HUAJKDFL (1 references)
target     prot opt source               destination
KUBE-MARK-MASQ  all  --  10.32.0.2            anywhere             /* kube-system/kube-dns:dns-tcp */
DNAT       tcp  --  anywhere             anywhere             /* kube-system/kube-dns:dns-tcp */ tcp to:10.32.0.2:53

Chain KUBE-SEP-3E4LNQKKWZF7G6SH (1 references)
target     prot opt source               destination
KUBE-MARK-MASQ  all  --  10.32.0.1            anywhere             /* kube-system/kube-dns:dns-tcp */
DNAT       tcp  --  anywhere             anywhere             /* kube-system/kube-dns:dns-tcp */ tcp to:10.32.0.1:53

Chain KUBE-SEP-3IDG7DUGN3QC2UZF (1 references)
target     prot opt source               destination
KUBE-MARK-MASQ  all  --  172.17.0.120         anywhere             /* default/kubernetes:https */
DNAT       tcp  --  anywhere             anywhere             /* default/kubernetes:https */ tcp to:172.17.0.120:6443

Chain KUBE-SEP-JZWS2VPNIEMNMNB2 (1 references)
target     prot opt source               destination
KUBE-MARK-MASQ  all  --  10.32.0.2            anywhere             /* kube-system/kube-dns:dns */
DNAT       udp  --  anywhere             anywhere             /* kube-system/kube-dns:dns */ udp to:10.32.0.2:53

Chain KUBE-SEP-OEY6JJQSBCQPRKHS (1 references)
target     prot opt source               destination
KUBE-MARK-MASQ  all  --  10.32.0.1            anywhere             /* kube-system/kube-dns:dns */
DNAT       udp  --  anywhere             anywhere             /* kube-system/kube-dns:dns */ udp to:10.32.0.1:53

Chain KUBE-SEP-QX7VDAS5KDY6V3EV (1 references)
target     prot opt source               destination
KUBE-MARK-MASQ  all  --  10.32.0.2            anywhere             /* work/saythx-redis: */
DNAT       tcp  --  anywhere             anywhere             /* work/saythx-redis: */ tcp to:10.32.0.2:6379

Chain KUBE-SERVICES (2 references)
target     prot opt source               destination
KUBE-SVC-SMQNAAUIAENDDGYQ  tcp  --  anywhere             10.103.193.175       /* work/saythx-redis: cluster IP */ tcp dpt:6379
KUBE-NODEPORTS  all  --  anywhere             anywhere             /* kubernetes service nodeports; NOTE: this must be the last rule in this chain */ ADDRTYPE match dst-type LOCAL

Chain KUBE-SVC-ERIFXISQEP7F7OF4 (1 references)
target     prot opt source               destination
KUBE-SEP-3E4LNQKKWZF7G6SH  all  --  anywhere             anywhere             /* kube-system/kube-dns:dns-tcp */ statistic mode random probability 0.50000000000
KUBE-SEP-2LZPYBS4HUAJKDFL  all  --  anywhere             anywhere             /* kube-system/kube-dns:dns-tcp */

Chain KUBE-SVC-SMQNAAUIAENDDGYQ (2 references)
target     prot opt source               destination
KUBE-SEP-QX7VDAS5KDY6V3EV  all  --  anywhere             anywhere             /* work/saythx-redis: */
</code></pre><p>ä»¥ä¸Šè¾“å‡ºå·²ç»å°½é‡åˆ æ‰äº†æ— å…³çš„å†…å®¹ã€‚</p>
<p>å½“å¼€å§‹è®¿é—®çš„æ—¶å€™å…ˆè¦ç»è¿‡ <code>PREROUTING</code> é“¾ï¼Œè½¬åˆ° <code>KUBE-SERVICES</code> é“¾ï¼Œå½“æŸ¥è¯¢åˆ°åŒ¹é…çš„è§„åˆ™ä¹‹åï¼Œè¯·æ±‚å°†è½¬å‘ <code>KUBE-SVC-SMQNAAUIAENDDGYQ</code> é“¾ï¼Œè¿›è€Œåˆ°è¾¾ <code>KUBE-SEP-QX7VDAS5KDY6V3EV</code> å¯¹åº”äºæˆ‘ä»¬çš„ <code>Pod</code>ã€‚(æ³¨ï¼šä¸ºäº†ç®€æ´ï¼Œä¸Šè¿° iptables è§„åˆ™æ˜¯éƒ¨ç½²ä¸€ä¸ª <code>Pod</code> æ—¶çš„åœºæ™¯)</p>
<p>å½“ææ‡‚äº†è¿™äº›ä¹‹åï¼Œå¦‚æœä½ æƒ³äº†è§£è¿™äº› <code>iptables</code> è§„åˆ™å®é™…åˆæ˜¯å¦‚ä½•åˆ›å»ºå’Œç»´æŠ¤çš„ï¼Œé‚£å¯ä»¥å‚è€ƒä¸‹ <code>proxier</code> çš„å…·ä½“å®ç°ï¼Œè¿™é‡Œä¸å†å±•å¼€ã€‚</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>æœ¬èŠ‚ä¸­æˆ‘ä»¬ä»‹ç»äº† <code>kube-proxy</code> çš„ä¸»è¦åŠŸèƒ½å’ŒåŸºæœ¬æµç¨‹ï¼Œäº†è§£åˆ°äº†å®ƒå¯¹äºæœåŠ¡æ³¨å†Œå‘ç°å’Œä»£ç†è®¿é—®ç­‰èµ·åˆ°äº†å¾ˆå¤§çš„ä½œç”¨ã€‚è€Œå®ƒåœ¨ Linux ä¸‹çš„ä»£ç†æ¨¡å¼ä¹Ÿæœ‰ <code>userspace</code>ï¼Œ<code>iptables</code> å’Œ <code>ipvs</code> ç­‰ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹æˆ‘ä»¬ä½¿ç”¨ <code>iptables</code> çš„ä»£ç†æ¨¡å¼ï¼Œå½“åˆ›å»ºæ–°çš„ <code>Service</code> ï¼Œæˆ–è€… <code>Pod</code> è¿›è¡Œå˜åŒ–æ—¶ï¼Œ<code>kube-proxy</code> ä¾¿ä¼šå»ç»´æŠ¤ <code>iptables</code> è§„åˆ™ï¼Œä»¥ç¡®ä¿è¯·æ±‚å¯ä»¥æ­£ç¡®çš„åˆ°è¾¾åç«¯æœåŠ¡ã€‚</p>
<p>å½“ç„¶ï¼Œæœ¬èŠ‚ä¸­å¹¶æ²¡æœ‰æåˆ° <code>kube-proxy</code> çš„ <code>session affinity</code> ç›¸å…³çš„ç‰¹æ€§ï¼Œå¦‚æœ‰éœ€è¦å¯è¿›è¡Œä¸‹å°è¯•ã€‚</p>
<p>ä¸‹èŠ‚ï¼Œæˆ‘ä»¬å°†ä»‹ç»å®é™…è¿è¡Œç€å®¹å™¨çš„ <code>Docker</code>ï¼Œå¤§è‡´äº†è§£ä¸‹åœ¨ K8S ä¸­å®ƒæ‰€èµ·çš„ä½œç”¨ï¼ŒåŠä»–ä»¬ä¹‹é—´çš„äº¤äº’æ–¹å¼ã€‚</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/16-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bkubelet/"><span>16 åº–ä¸è§£ç‰›ï¼škubelet</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/kubernetes/kubernetes%E4%BB%8E%E4%B8%8A%E6%89%8B%E5%88%B0%E5%AE%9E%E8%B7%B5/18-%E5%BA%96%E4%B8%81%E8%A7%A3%E7%89%9Bcontainer-runtime-docker/"><span>18 åº–ä¸è§£ç‰›ï¼šContainer Runtime ï¼ˆDockerï¼‰</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 27270 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>