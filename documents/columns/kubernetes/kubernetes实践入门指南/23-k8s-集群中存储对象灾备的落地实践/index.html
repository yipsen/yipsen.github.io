<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>23 K8s é›†ç¾¤ä¸­å­˜å‚¨å¯¹è±¡ç¾å¤‡çš„è½åœ°å®è·µ | Yipsen Ye</title>
<meta name="description" content="è°ˆåˆ°å­˜å‚¨å¯¹è±¡çš„ç¾å¤‡ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³è±¡æˆå½“ä½ å¯åŠ¨äº†æŒ‚è½½å·çš„ Pod çš„æ—¶å€™ï¼Œçªç„¶é›†ç¾¤æœºå™¨å®•æœºçš„åœºæ™¯ï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•åº”å¯¹å­˜å‚¨å¯¹è±¡çš„å®¹é”™èƒ½åŠ›å‘¢ï¼Ÿåº”ç”¨çš„é«˜å¯ç”¨å›ºç„¶æœ€å¥½ï¼Œä½†æ˜¯ç¾å¤‡æ–¹æ¡ˆä¸€ç›´éƒ½æ˜¯æœ€åä¸€é“é—¨æ§›ï¼Œåœ¨å¾ˆå¤šæé™æƒ…å†µä¸‹ï¼Œå®¹é”™çš„å¤‡ä»½æ˜¯ä½ å®‰å¿ƒæä¾›æœåŠ¡çš„ä¿éšœã€‚
åœ¨è™šæ‹Ÿæœºæ—¶ä»£ï¼Œæˆ‘ä»¬é€šè¿‡æ§åˆ¶åº”ç”¨å¹³å‡åˆ†é…åˆ°å„ä¸ªè™šæ‹Ÿæœºä¸­å’Œå®šæœŸè®¡åˆ’æ‰§è¡Œçš„æ•°æ®å¤‡ä»½ï¼Œè®©ä¸šåŠ¡å¯é æ€§ä¸æ–­åœ°æé«˜ã€‚ç°åœ¨å‡çº§åˆ° Kubernetes æ—¶ä»£ï¼Œæ‰€æœ‰ä¸šåŠ¡éƒ½è¢« Kubernetes æ‰˜ç®¡ï¼Œé›†ç¾¤å¯ä»¥è¿…é€Ÿè°ƒåº¦å¹¶è‡ªç»´æŠ¤åº”ç”¨çš„å®¹å™¨çŠ¶æ€ï¼Œéšæ—¶å¯ä»¥æ‰©ç¼©èµ„æºæ¥åº”å¯¹çªå‘æƒ…å†µã€‚
å¬ç¬”è€…è¿™ä¹ˆè¯´ï¼Œæ„Ÿè§‰å¥½åƒå¹¶ä¸éœ€è¦å¯¹å­˜å‚¨æœ‰å¤šå¤§çš„æ‹…å¿ƒï¼Œåªè¦æŒ‚è½½çš„æ˜¯ç½‘ç»œå­˜å‚¨ï¼Œå³ä½¿åº”ç”¨é›†ç¾¤åäº†ï¼Œæ•°æ®è¿˜åœ¨ä¹ˆï¼Œå¥½åƒä¹Ÿæ²¡æœ‰å¤šå¤§çš„äº‹æƒ…ï¼Œé‚£ä¹ˆå­¦è¿™ä¸ªå­˜å‚¨å¯¹è±¡çš„ç¾å¤‡åˆæœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿ
ç¬”è€…æƒ³è¯´äº‹æƒ…è¿œæ²¡æœ‰æƒ³è±¡ä¸­é‚£ä¹ˆç®€å•ï¼Œæˆ‘ä»¬éœ€è¦å¸¦å…¥æ¥è¿‘ä¸šåŠ¡çš„åœºæ™¯ä¸­ï¼Œå†æ¥é€šè¿‡ç ´åé›†ç¾¤çŠ¶æ€ï¼Œçœ‹çœ‹è¯»å­˜å‚¨å¯¹è±¡æ˜¯å¦æœ‰ç ´åæ€§ã€‚
å› ä¸ºæˆ‘ä»¬ä»è™šæ‹Ÿæœºæ—¶ä»£å‡çº§åˆ° Kubernetes æ—¶ä»£ï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯åˆ©ç”¨åŠ¨æ€æ‰©ç¼©çš„èµ„æºæ¥å‡å°‘ä¸šåŠ¡ä¸­æ–­çš„æ—¶é—´ï¼Œè®©åº”ç”¨å¯ä»¥éšéœ€æ‰©ç¼©ï¼Œéšéœ€è‡ªæ„ˆã€‚æ‰€ä»¥åœ¨ Kubernetes æ—¶ä»£ï¼Œæˆ‘ä»¬è¦çš„å¹¶ä¸æ˜¯æ•°æ®ä¸¢ä¸ä¸¢çš„é—®é¢˜ï¼Œè€Œæ˜¯èƒ½ä¸èƒ½æœ‰å¿«é€Ÿä¿éšœè®©ä¸šåŠ¡æ¢å¤æ—¶é—´è¶Šæ¥è¶ŠçŸ­ï¼Œç”šè‡³è®©ç”¨æˆ·æ²¡æœ‰æ„ŸçŸ¥ã€‚è¿™ä¸ªå¯èƒ½å®ç°å—ï¼Ÿ
ç¬”è€…è®¤ä¸º Kubernetes é€šè¿‡ä¸æ–­ä¸°å¯Œçš„èµ„æºå¯¹è±¡å·²ç»å¿«æ¥è¿‘å®ç°è¿™ä¸ªç›®æ ‡äº†ã€‚æ‰€ä»¥ç¬”è€…è¿™é‡Œå¸¦ç€å¤§å®¶ä¸€èµ·æ¢³ç†ä¸€éå„ç§å­˜å‚¨å¯¹è±¡çš„ç¾å¤‡åœ¨ Kubernetes è½åœ°çš„å®è·µç»éªŒï¼Œä»¥å¤‡ä¸æ—¶ä¹‹éœ€ã€‚
NFS å­˜å‚¨å¯¹è±¡çš„ç¾å¤‡è½åœ°ç»éªŒ é¦–å…ˆæˆ‘ä»¬åº”è¯¥ç†è§£ PV/PVC åˆ›å»º NFS ç½‘ç»œå·çš„é…ç½®æ–¹æ³•ï¼Œæ³¨æ„ mountOptions å‚æ•°çš„ä½¿ç”¨å§¿åŠ¿ã€‚å¦‚ä¸‹ä¾‹å­å‚è€ƒï¼š
### nfs-pv.yamlapiVersion: v1kind: PersistentVolumemetadata:name: nfs-pvspec:capacity:storage: 10GivolumeMode: FilesystemaccessModes:- ReadWriteManypersistentVolumeReclaimPolicy: RecyclestorageClassName: nfsmountOptions:- hard- nfsvers=4.1nfs:path: /opt/k8s-pods/data # æŒ‡å®š nfs çš„æŒ‚è½½ç‚¹server: 192.168.1.40 # æŒ‡å®š nfs æœåŠ¡åœ°å€---### nfs-pvc.">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/kubernetes%e5%ae%9e%e8%b7%b5%e5%85%a5%e9%97%a8%e6%8c%87%e5%8d%97/">Kuberneteså®è·µå…¥é—¨æŒ‡å—</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/00-%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E4%BB%AC%E8%A6%81%E5%AD%A6%E4%B9%A0-kubernetes-%E6%8A%80%E6%9C%AF/">00 ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦å­¦ä¹  Kubernetes æŠ€æœ¯</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/01-%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86-kubernetes-%E7%9A%84%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6/">01 é‡æ–°è®¤è¯† Kubernetes çš„æ ¸å¿ƒç»„ä»¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/02-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-kubernets-%E7%9A%84%E7%BC%96%E6%8E%92%E5%AF%B9%E8%B1%A1/">02 æ·±å…¥ç†è§£ Kubernets çš„ç¼–æ’å¯¹è±¡</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/03-devops-%E5%9C%BA%E6%99%AF%E4%B8%8B%E8%90%BD%E5%9C%B0-k8s-%E7%9A%84%E5%9B%B0%E9%9A%BE%E5%88%86%E6%9E%90/">03 DevOps åœºæ™¯ä¸‹è½åœ° K8s çš„å›°éš¾åˆ†æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/04-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%E4%B8%8B%E8%90%BD%E5%9C%B0-k8s-%E7%9A%84%E5%9B%B0%E9%9A%BE%E5%88%86%E6%9E%90/">04 å¾®æœåŠ¡åº”ç”¨åœºæ™¯ä¸‹è½åœ° K8s çš„å›°éš¾åˆ†æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/05-%E8%A7%A3%E5%86%B3-k8s-%E8%90%BD%E5%9C%B0%E9%9A%BE%E9%A2%98%E7%9A%84%E6%96%B9%E6%B3%95%E8%AE%BA%E6%8F%90%E7%82%BC/">05 è§£å†³ K8s è½åœ°éš¾é¢˜çš„æ–¹æ³•è®ºæç‚¼</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/06-%E7%BB%83%E4%B9%A0%E7%AF%87k8s-%E6%A0%B8%E5%BF%83%E5%AE%9E%E8%B7%B5%E7%9F%A5%E8%AF%86%E6%8E%8C%E6%8F%A1/">06 ç»ƒä¹ ç¯‡ï¼šK8s æ ¸å¿ƒå®è·µçŸ¥è¯†æŒæ¡</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/07-%E5%AE%B9%E5%99%A8%E5%BC%95%E6%93%8E-containerd-%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5/">07 å®¹å™¨å¼•æ“ containerd è½åœ°å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/08-k8s-%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E5%B7%A5%E5%85%B7-kubeadm-%E7%9A%84%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5/">08 K8s é›†ç¾¤å®‰è£…å·¥å…· kubeadm çš„è½åœ°å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/09-%E5%8D%97%E5%8C%97%E5%90%91%E6%B5%81%E9%87%8F%E7%BB%84%E4%BB%B6-ipvs-%E7%9A%84%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5/">09 å—åŒ—å‘æµé‡ç»„ä»¶ IPVS çš„è½åœ°å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/10-%E4%B8%9C%E8%A5%BF%E5%90%91%E6%B5%81%E9%87%8F%E7%BB%84%E4%BB%B6-calico-%E7%9A%84%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5/">10 ä¸œè¥¿å‘æµé‡ç»„ä»¶ Calico çš„è½åœ°å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/11-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0-dns-%E7%9A%84%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5/">11 æœåŠ¡å‘ç° DNS çš„è½åœ°å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/12-%E7%BB%83%E4%B9%A0%E7%AF%87k8s-%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE%E6%B5%8B%E9%AA%8C/">12 ç»ƒä¹ ç¯‡ï¼šK8s é›†ç¾¤é…ç½®æµ‹éªŒ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/13-%E7%90%86%E8%A7%A3%E5%AF%B9%E6%96%B9%E6%9A%B4%E9%9C%B2%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%AF%B9%E8%B1%A1-ingress-%E5%92%8C-service/">13 ç†è§£å¯¹æ–¹æš´éœ²æœåŠ¡çš„å¯¹è±¡ Ingress å’Œ Service</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/14-%E5%BA%94%E7%94%A8%E7%BD%91%E5%85%B3-openresty-%E5%AF%B9%E6%8E%A5-k8s-%E5%AE%9E%E8%B7%B5/">14 åº”ç”¨ç½‘å…³ OpenResty å¯¹æ¥ K8s å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/15-service-%E5%B1%82%E5%BC%95%E6%B5%81%E6%8A%80%E6%9C%AF%E5%AE%9E%E8%B7%B5/">15 Service å±‚å¼•æµæŠ€æœ¯å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/16-cilium-%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E7%9A%84%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5/">16 Cilium å®¹å™¨ç½‘ç»œçš„è½åœ°å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/17-%E5%BA%94%E7%94%A8%E6%B5%81%E9%87%8F%E7%9A%84%E4%BC%98%E9%9B%85%E6%97%A0%E6%8D%9F%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5/">17 åº”ç”¨æµé‡çš„ä¼˜é›…æ— æŸåˆ‡æ¢å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/18-%E7%BB%83%E4%B9%A0%E7%AF%87%E5%BA%94%E7%94%A8%E6%B5%81%E9%87%8F%E6%97%A0%E6%8D%9F%E5%88%87%E6%8D%A2%E6%8A%80%E6%9C%AF%E6%B5%8B%E9%AA%8C/">18 ç»ƒä¹ ç¯‡ï¼šåº”ç”¨æµé‡æ— æŸåˆ‡æ¢æŠ€æœ¯æµ‹éªŒ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/19-%E4%BD%BF%E7%94%A8-rook-%E6%9E%84%E5%BB%BA%E7%94%9F%E4%BA%A7%E5%8F%AF%E7%94%A8%E5%AD%98%E5%82%A8%E7%8E%AF%E5%A2%83%E5%AE%9E%E8%B7%B5/">19 ä½¿ç”¨ Rook æ„å»ºç”Ÿäº§å¯ç”¨å­˜å‚¨ç¯å¢ƒå®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/20-%E6%9C%89%E7%8A%B6%E6%80%81%E5%BA%94%E7%94%A8%E7%9A%84%E9%BB%98%E8%AE%A4%E7%89%B9%E6%80%A7%E8%90%BD%E5%9C%B0%E5%88%86%E6%9E%90/">20 æœ‰çŠ¶æ€åº”ç”¨çš„é»˜è®¤ç‰¹æ€§è½åœ°åˆ†æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/21-%E6%A1%88%E4%BE%8B%E5%88%86%E5%B8%83%E5%BC%8F-mysql-%E9%9B%86%E7%BE%A4%E5%B7%A5%E5%85%B7-vitess-%E5%AE%9E%E8%B7%B5%E5%88%86%E6%9E%90/">21 æ¡ˆä¾‹ï¼šåˆ†å¸ƒå¼ MySQL é›†ç¾¤å·¥å…· Vitess å®è·µåˆ†æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/22-%E5%AD%98%E5%82%A8%E5%AF%B9%E8%B1%A1-pvpvcstorage-classes-%E7%9A%84%E7%AE%A1%E7%90%86%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5/">22 å­˜å‚¨å¯¹è±¡ PVã€PVCã€Storage Classes çš„ç®¡ç†è½åœ°å®è·µ</a></li>
                
                
                
                    <li>23 K8s é›†ç¾¤ä¸­å­˜å‚¨å¯¹è±¡ç¾å¤‡çš„è½åœ°å®è·µ</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/24-%E7%BB%83%E4%B9%A0%E7%AF%87k8s-%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE%E6%B5%8B%E9%AA%8C/">24 ç»ƒä¹ ç¯‡ï¼šK8s é›†ç¾¤é…ç½®æµ‹éªŒ</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">23 K8s é›†ç¾¤ä¸­å­˜å‚¨å¯¹è±¡ç¾å¤‡çš„è½åœ°å®è·µ</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2021-12-22 01:48:29</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/kubernetes/">kubernetes</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/">Kuberneteså®è·µå…¥é—¨æŒ‡å—</a>
                
            </div></div>
        <div class="post-content">
            <p>è°ˆåˆ°å­˜å‚¨å¯¹è±¡çš„ç¾å¤‡ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³è±¡æˆå½“ä½ å¯åŠ¨äº†æŒ‚è½½å·çš„ Pod çš„æ—¶å€™ï¼Œçªç„¶é›†ç¾¤æœºå™¨å®•æœºçš„åœºæ™¯ï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•åº”å¯¹å­˜å‚¨å¯¹è±¡çš„å®¹é”™èƒ½åŠ›å‘¢ï¼Ÿåº”ç”¨çš„é«˜å¯ç”¨å›ºç„¶æœ€å¥½ï¼Œä½†æ˜¯ç¾å¤‡æ–¹æ¡ˆä¸€ç›´éƒ½æ˜¯æœ€åä¸€é“é—¨æ§›ï¼Œåœ¨å¾ˆå¤šæé™æƒ…å†µä¸‹ï¼Œå®¹é”™çš„å¤‡ä»½æ˜¯ä½ å®‰å¿ƒæä¾›æœåŠ¡çš„ä¿éšœã€‚</p>
<p>åœ¨è™šæ‹Ÿæœºæ—¶ä»£ï¼Œæˆ‘ä»¬é€šè¿‡æ§åˆ¶åº”ç”¨å¹³å‡åˆ†é…åˆ°å„ä¸ªè™šæ‹Ÿæœºä¸­å’Œå®šæœŸè®¡åˆ’æ‰§è¡Œçš„æ•°æ®å¤‡ä»½ï¼Œè®©ä¸šåŠ¡å¯é æ€§ä¸æ–­åœ°æé«˜ã€‚ç°åœ¨å‡çº§åˆ° Kubernetes æ—¶ä»£ï¼Œæ‰€æœ‰ä¸šåŠ¡éƒ½è¢« Kubernetes æ‰˜ç®¡ï¼Œé›†ç¾¤å¯ä»¥è¿…é€Ÿè°ƒåº¦å¹¶è‡ªç»´æŠ¤åº”ç”¨çš„å®¹å™¨çŠ¶æ€ï¼Œéšæ—¶å¯ä»¥æ‰©ç¼©èµ„æºæ¥åº”å¯¹çªå‘æƒ…å†µã€‚</p>
<p>å¬ç¬”è€…è¿™ä¹ˆè¯´ï¼Œæ„Ÿè§‰å¥½åƒå¹¶ä¸éœ€è¦å¯¹å­˜å‚¨æœ‰å¤šå¤§çš„æ‹…å¿ƒï¼Œåªè¦æŒ‚è½½çš„æ˜¯ç½‘ç»œå­˜å‚¨ï¼Œå³ä½¿åº”ç”¨é›†ç¾¤åäº†ï¼Œæ•°æ®è¿˜åœ¨ä¹ˆï¼Œå¥½åƒä¹Ÿæ²¡æœ‰å¤šå¤§çš„äº‹æƒ…ï¼Œé‚£ä¹ˆå­¦è¿™ä¸ªå­˜å‚¨å¯¹è±¡çš„ç¾å¤‡åˆæœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿ</p>
<p>ç¬”è€…æƒ³è¯´äº‹æƒ…è¿œæ²¡æœ‰æƒ³è±¡ä¸­é‚£ä¹ˆç®€å•ï¼Œæˆ‘ä»¬éœ€è¦å¸¦å…¥æ¥è¿‘ä¸šåŠ¡çš„åœºæ™¯ä¸­ï¼Œå†æ¥é€šè¿‡ç ´åé›†ç¾¤çŠ¶æ€ï¼Œçœ‹çœ‹è¯»å­˜å‚¨å¯¹è±¡æ˜¯å¦æœ‰ç ´åæ€§ã€‚</p>
<p>å› ä¸ºæˆ‘ä»¬ä»è™šæ‹Ÿæœºæ—¶ä»£å‡çº§åˆ° Kubernetes æ—¶ä»£ï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯åˆ©ç”¨åŠ¨æ€æ‰©ç¼©çš„èµ„æºæ¥å‡å°‘ä¸šåŠ¡ä¸­æ–­çš„æ—¶é—´ï¼Œè®©åº”ç”¨å¯ä»¥éšéœ€æ‰©ç¼©ï¼Œéšéœ€è‡ªæ„ˆã€‚æ‰€ä»¥åœ¨ Kubernetes æ—¶ä»£ï¼Œæˆ‘ä»¬è¦çš„å¹¶ä¸æ˜¯æ•°æ®ä¸¢ä¸ä¸¢çš„é—®é¢˜ï¼Œè€Œæ˜¯èƒ½ä¸èƒ½æœ‰å¿«é€Ÿä¿éšœè®©ä¸šåŠ¡æ¢å¤æ—¶é—´è¶Šæ¥è¶ŠçŸ­ï¼Œç”šè‡³è®©ç”¨æˆ·æ²¡æœ‰æ„ŸçŸ¥ã€‚è¿™ä¸ªå¯èƒ½å®ç°å—ï¼Ÿ</p>
<p>ç¬”è€…è®¤ä¸º Kubernetes é€šè¿‡ä¸æ–­ä¸°å¯Œçš„èµ„æºå¯¹è±¡å·²ç»å¿«æ¥è¿‘å®ç°è¿™ä¸ªç›®æ ‡äº†ã€‚æ‰€ä»¥ç¬”è€…è¿™é‡Œå¸¦ç€å¤§å®¶ä¸€èµ·æ¢³ç†ä¸€éå„ç§å­˜å‚¨å¯¹è±¡çš„ç¾å¤‡åœ¨ Kubernetes è½åœ°çš„å®è·µç»éªŒï¼Œä»¥å¤‡ä¸æ—¶ä¹‹éœ€ã€‚</p>
<h3 id="nfs-å­˜å‚¨å¯¹è±¡çš„ç¾å¤‡è½åœ°ç»éªŒ">NFS å­˜å‚¨å¯¹è±¡çš„ç¾å¤‡è½åœ°ç»éªŒ</h3>
<p>é¦–å…ˆæˆ‘ä»¬åº”è¯¥ç†è§£ PV/PVC åˆ›å»º NFS ç½‘ç»œå·çš„é…ç½®æ–¹æ³•ï¼Œæ³¨æ„ mountOptions å‚æ•°çš„ä½¿ç”¨å§¿åŠ¿ã€‚å¦‚ä¸‹ä¾‹å­å‚è€ƒï¼š</p>
<pre tabindex="0"><code>### nfs-pv.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: nfs-pv
spec:
  capacity:
    storage: 10Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Recycle
  storageClassName: nfs
  mountOptions:
    - hard
    - nfsvers=4.1
  nfs:
    path: /opt/k8s-pods/data   # æŒ‡å®š nfs çš„æŒ‚è½½ç‚¹
    server: 192.168.1.40  # æŒ‡å®š nfs æœåŠ¡åœ°å€
---
### nfs-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nfs-pvc
spec:
  storageClassName: nfs
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 10Gi

</code></pre><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒPersistentVolume æ˜¯ NFS ç±»å‹çš„ï¼Œå› æ­¤éœ€è¦è¾…åŠ©ç¨‹åº /sbin/mount.nfs æ¥æ”¯æŒæŒ‚è½½ NFS æ–‡ä»¶ç³»ç»Ÿã€‚</p>
<pre tabindex="0"><code>[kadmin@k8s-master ~]$ kubectl get pvc nfs-pvc
NAME      STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE
nfs-pvc   Bound    nfs-pv   10Gi       RWX            nfs            3m54s
[kadmin@k8s-master ~]$
[kadmin@k8s-master ~]$ kubectl get pv nfs-pv
NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM             STORAGECLASS   REASON   AGE
nfs-pv   10Gi       RWX            Recycle          Bound    default/nfs-pvc   nfs                     18m

</code></pre><p>æ‰§è¡Œä¸€ä¸ª Pod æŒ‚è½½ NFS å·ï¼š</p>
<pre tabindex="0"><code>### nfs-pv-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-pv-pod
spec:
  volumes:
    - name: nginx-pv-storage
      persistentVolumeClaim:
        claimName: nfs-pvc
  containers:
    - name: nginx
      image: nginx
      ports:
        - containerPort: 80
          name: &quot;nginx-server&quot;
      volumeMounts:
        - mountPath: &quot;/usr/share/nginx/html&quot;
          name: nginx-pv-storage

å¤åˆ¶
[kadmin@k8s-master ~]$ kubectl create -f nfs-pv-pod.yaml
pod/nginx-pv-pod created
[kadmin@k8s-master ~]$
[kadmin@k8s-master ~]$ kubectl get pod nginx-pv-pod -o wide
NAME           READY   STATUS    RESTARTS   AGE   IP              NODE           NOMINATED NODE   READINESS GATES
nginx-pv-pod   1/1     Running   0          66s   172.16.140.28   k8s-worker-2   &lt;none&gt;           &lt;none&gt;

[kadmin@k8s-master ~]$ curl http://172.16.140.28
Hello, NFS Storage NGINX

</code></pre><p>å½“ä½ åœ¨ä¸€ä¸ª Pod é‡Œé¢æŒ‚è½½äº† NFS å·ä¹‹åï¼Œå°±éœ€è¦è€ƒè™‘å¦‚ä½•æŠŠæ•°æ®å¤‡ä»½å‡ºæ¥ã€‚<a href="https://github.com/vmware-tanzu/velero">velero</a> ä½œä¸ºäº‘åŸç”Ÿçš„å¤‡ä»½æ¢å¤å·¥å…·å‡ºç°äº†ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¤‡ä»½æŒä¹…åŒ–æ•°æ®å¯¹è±¡ã€‚velero æ¡ˆä¾‹å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>velero backup create backupName --include-cluster-resources=true --ordered-resources 'pods=ns1/pod1,ns1/pod2;persistentvolumes=pv4,pv8' --include-namespaces=ns1

</code></pre><p>æ³¨æ„ velero é»˜è®¤æ²¡æ³•å¤‡ä»½å·ï¼Œæ‰€ä»¥å®ƒé›†æˆäº†å¼€æºç»„ä»¶ <a href="https://github.com/restic/restic">restic</a> æ”¯æŒäº†å­˜å‚¨å·çš„æ”¯æŒã€‚å› ä¸ºç›®å‰è¿˜å¤„äºè¯•éªŒé˜¶æ®µï¼Œæ³¨æ„è¯·ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚</p>
<h3 id="ceph-æ•°æ®å¤‡ä»½åŠæ¢å¤">Ceph æ•°æ®å¤‡ä»½åŠæ¢å¤</h3>
<p>Rook æ˜¯ç®¡ç† Ceph é›†ç¾¤çš„äº‘åŸç”Ÿç®¡ç†ç³»ç»Ÿï¼Œåœ¨æ—©å‰çš„è¯¾ç¨‹ä¸­æˆ‘å·²ç»å’Œå¤§å®¶å®è·µè¿‡ä½¿ç”¨ Rook åˆ›å»º Ceph é›†ç¾¤çš„æ–¹æ³•ã€‚ç°åœ¨å‡è®¾ Ceph é›†ç¾¤ç˜«ç—ªäº†åº”è¯¥å¦‚ä½•ä¿®å¤å®ƒã€‚æ˜¯çš„ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹å·¥ä¿®å¤å®ƒã€‚æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<p>ç¬¬ä¸€æ­¥ï¼Œåœæ­¢ Ceph operator æŠŠ Ceph é›†ç¾¤çš„æ§åˆ¶å™¨å…³æ‰ï¼Œä¸è®©å®ƒèƒ½è‡ªåŠ¨è´Ÿè½½è‡ªå·±çš„ç¨‹åºã€‚</p>
<pre tabindex="0"><code>kubectl -n rook-ceph scale deployment rook-ceph-operator --replicas=0

</code></pre><p>ç¬¬äºŒæ­¥ï¼Œè¿™ä¸ª Ceph çš„ monmap ä¿æŒè·Ÿè¸ª Ceph èŠ‚ç‚¹çš„å®¹é”™æ•°é‡ã€‚æˆ‘ä»¬å…ˆé€šè¿‡æ›´æ–°ä¿æŒå¥åº·ç›‘æ§èŠ‚ç‚¹çš„å®ä¾‹æ­£å¸¸è¿è¡Œã€‚æ­¤å¤„ä¸º rook-ceph-mon-bï¼Œä¸å¥åº·çš„å®ä¾‹ä¸º rook-ceph-mon-a å’Œ rook-ceph-mon-cã€‚å¤‡ä»½ rook-ceph-mon-b çš„ Deployment å¯¹è±¡ï¼š</p>
<pre tabindex="0"><code>kubectl -n rook-ceph get deployment rook-ceph-mon-b -o yaml &gt; rook-ceph-mon-b-deployment.yaml

</code></pre><p>ä¿®æ”¹ç›‘æ§å®ä¾‹çš„å‘½ä»¤ï¼š</p>
<pre tabindex="0"><code>kubectl -n rook-ceph patch deployment rook-ceph-mon-b -p '{&quot;spec&quot;: {&quot;template&quot;: {&quot;spec&quot;: {&quot;containers&quot;: [{&quot;name&quot;: &quot;mon&quot;, &quot;command&quot;: [&quot;sleep&quot;, &quot;infinity&quot;], &quot;args&quot;: []}]}}}}'

</code></pre><p>è¿›å…¥å¥åº·çš„ç›‘æ§å®ä¾‹ä¸­ï¼š</p>
<pre tabindex="0"><code>kubectl -n rook-ceph exec -it &lt;mon-pod&gt; bash

# set a few simple variables
cluster_namespace=rook-ceph
good_mon_id=b
monmap_path=/tmp/monmap

# extract the monmap to a file, by pasting the ceph mon command
# from the good mon deployment and adding the
# `--extract-monmap=${monmap_path}` flag
ceph-mon \
    --fsid=41a537f2-f282-428e-989f-a9e07be32e47 \
    --keyring=/etc/ceph/keyring-store/keyring \
    --log-to-stderr=true \
    --err-to-stderr=true \
    --mon-cluster-log-to-stderr=true \
    --log-stderr-prefix=debug \
    --default-log-to-file=false \
    --default-mon-cluster-log-to-file=false \
    --mon-host=$ROOK_CEPH_MON_HOST \
    --mon-initial-members=$ROOK_CEPH_MON_INITIAL_MEMBERS \
    --id=b \
    --setuser=ceph \
    --setgroup=ceph \
    --foreground \
    --public-addr=10.100.13.242 \
    --setuser-match-path=/var/lib/ceph/mon/ceph-b/store.db \
    --public-bind-addr=$ROOK_POD_IP \
    --extract-monmap=${monmap_path}

# review the contents of the monmap
monmaptool --print /tmp/monmap

# remove the bad mon(s) from the monmap
monmaptool ${monmap_path} --rm &lt;bad_mon&gt;

# in this example we remove mon0 and mon2:
monmaptool ${monmap_path} --rm a
monmaptool ${monmap_path} --rm c

# inject the modified monmap into the good mon, by pasting
# the ceph mon command and adding the
# `--inject-monmap=${monmap_path}` flag, like this
ceph-mon \
    --fsid=41a537f2-f282-428e-989f-a9e07be32e47 \
    --keyring=/etc/ceph/keyring-store/keyring \
    --log-to-stderr=true \
    --err-to-stderr=true \
    --mon-cluster-log-to-stderr=true \
    --log-stderr-prefix=debug \
    --default-log-to-file=false \
    --default-mon-cluster-log-to-file=false \
    --mon-host=$ROOK_CEPH_MON_HOST \
    --mon-initial-members=$ROOK_CEPH_MON_INITIAL_MEMBERS \
    --id=b \
    --setuser=ceph \
    --setgroup=ceph \
    --foreground \
    --public-addr=10.100.13.242 \
    --setuser-match-path=/var/lib/ceph/mon/ceph-b/store.db \
    --public-bind-addr=$ROOK_POD_IP \
    --inject-monmap=${monmap_path}

</code></pre><p>ç¼–è¾‘ rook configmap æ–‡ä»¶ï¼š</p>
<pre tabindex="0"><code>kubectl -n rook-ceph edit configmap rook-ceph-mon-endpoints

</code></pre><p>åœ¨ data å­—æ®µé‚£é‡Œå»æ‰è¿‡æœŸçš„ a å’Œ bï¼š</p>
<pre tabindex="0"><code>data: a=10.100.35.200:6789;b=10.100.13.242:6789;c=10.100.35.12:6789

</code></pre><p>å˜æˆï¼š</p>
<pre tabindex="0"><code>data: b=10.100.13.242:6789

</code></pre><p>æ›´æ–° secret é…ç½®ï¼š</p>
<pre tabindex="0"><code>mon_host=$(kubectl -n rook-ceph get svc rook-ceph-mon-b -o jsonpath='{.spec.clusterIP}')
kubectl -n rook-ceph patch secret rook-ceph-config -p '{&quot;stringData&quot;: {&quot;mon_host&quot;: &quot;[v2:'&quot;${mon_host}&quot;':3300,v1:'&quot;${mon_host}&quot;':6789]&quot;, &quot;mon_initial_members&quot;: &quot;'&quot;${good_mon_id}&quot;'&quot;}}'

</code></pre><p>é‡å¯ç›‘æ§å®ä¾‹ï¼š</p>
<pre tabindex="0"><code>kubectl replace --force -f rook-ceph-mon-b-deployment.yaml

</code></pre><p>é‡å¯ operator:</p>
<pre tabindex="0"><code># create the operator. it is safe to ignore the errors that a number of resources already exist.
kubectl -n rook-ceph scale deployment rook-ceph-operator --replicas=1

</code></pre><h3 id="jenkins-æŒ‚è½½-pvc-åº”ç”¨çš„æ•°æ®æ¢å¤">Jenkins æŒ‚è½½ PVC åº”ç”¨çš„æ•°æ®æ¢å¤</h3>
<p>å‡è®¾ Jenkins æ•°æ®æŸåï¼Œæƒ³ä¿®å¤ Jenkins çš„æ•°æ®ç›®å½•ï¼Œå¯ä»¥é‡‡ç”¨æŠŠ PVC æŒ‚è½½å¸¦ä¸´æ—¶é•œåƒå¹¶é…åˆ <code>kubectl cp</code> å®ç°ï¼Œæ­¥éª¤å¦‚ä¸‹ã€‚</p>
<p>\1. è·å¾—å½“å‰ Jenkins å®¹å™¨çš„è¿è¡Œæƒé™ï¼š</p>
<pre tabindex="0"><code>$ kubectl --namespace=cje-cluster-example get pods cjoc-0 -o jsonpath='{.spec.securityContext}'
map[fsGroup:1000]

</code></pre><p>\2. å…³é—­å®¹å™¨ï¼š</p>
<pre tabindex="0"><code>$ kubectl --namespace=cje-cluster-example scale statefulset/cjoc --replicas=0
statefulset.apps &quot;cjoc&quot; scaled

</code></pre><p>\3. æŸ¥çœ‹ PVCï¼š</p>
<pre tabindex="0"><code>$ kubectl --namespace=cje-cluster-example get pvc
NAME                  STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
jenkins-home-cjoc-0   Bound     pvc-6b27e963-b770-11e8-bcbf-42010a8400c1   20Gi       RWO            standard       46d
jenkins-home-mm1-0    Bound     pvc-b2b7e305-ba66-11e8-bcbf-42010a8400c1   50Gi       RWO            standard       42d
jenkins-home-mm2-0    Bound     pvc-6561b8da-c0c8-11e8-bcbf-42010a8400c1   50Gi       RWO            standard       34d

</code></pre><p>\4. æŒ‚è½½ PVC åˆ°ä¸´æ—¶é•œåƒä¸­æ–¹ä¾¿æ¢å¤æ•°æ®ï¼š</p>
<pre tabindex="0"><code>$ cat &lt;&lt;EOF | kubectl --namespace=cje-cluster-example create -f -
kind: Pod
apiVersion: v1
metadata:
  name: rescue-pod
spec:
  securityContext:
    runAsUser: 1000
    fsGroup: 1000
  volumes:
    - name: rescue-storage
      persistentVolumeClaim:
       claimName: jenkins-home-cjoc-0
  containers:
    - name: rescue-container
      image: nginx
      command: [&quot;/bin/sh&quot;]
      args: [&quot;-c&quot;, &quot;while true; do echo hello; sleep 10;done&quot;]
      volumeMounts:
        - mountPath: &quot;/tmp/jenkins-home&quot;
          name: rescue-storage
EOF
pod &quot;rescue-pod&quot; created

</code></pre><p>\5. å¤åˆ¶å¤‡ä»½æ•°æ®åˆ°ä¸´æ—¶é•œåƒï¼š</p>
<pre tabindex="0"><code>kubectl cp oc-jenkins-home.backup.tar.gz rescue-pod:/tmp/

</code></pre><p>\6. è§£å‹æ•°æ®åˆ° PVC æŒ‚è½½å·ï¼š</p>
<pre tabindex="0"><code>kubectl exec --namespace=cje-cluster-example rescue-pod -it -- tar -xzf /tmp/oc-jenkins-home.backup.tar.gz -C /tmp/jenkins-home

</code></pre><p>\7. åˆ é™¤ä¸´æ—¶é•œåƒ Podï¼š</p>
<pre tabindex="0"><code>kubectl --namespace=cje-cluster-example delete pod rescue-pod

</code></pre><p>\8. æ¢å¤ Jenkins å®¹å™¨ï¼š</p>
<pre tabindex="0"><code>kubectl --namespace=cje-cluster-example scale statefulset/cjoc --replicas=1

</code></pre><h3 id="kubernetes-é›†ç¾¤çš„å¤‡ä»½">Kubernetes é›†ç¾¤çš„å¤‡ä»½</h3>
<p>Kubernetes é›†ç¾¤æ˜¯åˆ†å¸ƒå¼é›†ç¾¤ï¼Œæˆ‘ä»¬å¤‡ä»½é›†ç¾¤çš„å…ƒæ•°æ®çš„ç›®çš„ä¸€èˆ¬æœ‰ä¸¤ä¸ªä¸»è¦ç›®çš„ï¼š</p>
<ul>
<li>èƒ½å¿«é€Ÿæ¢å¤æ§åˆ¶èŠ‚ç‚¹è€Œä¸æ˜¯è®¡ç®—èŠ‚ç‚¹</li>
<li>èƒ½æ¢å¤åº”ç”¨å®¹å™¨</li>
</ul>
<p>ä»é›†ç¾¤å¤‡ä»½çš„éš¾åº¦æ¥è®²ï¼Œæˆ‘ä»¬è¦æ¸…æ¥šç†è§£é›†ç¾¤æ§åˆ¶èŠ‚ç‚¹ä¸Šæœ‰å“ªäº›å…³é”®æ•°æ®æ˜¯éœ€è¦å¤‡ä»½çš„ï¼šè‡ªç­¾åè¯ä¹¦ã€etcd æ•°æ®ã€kubeconfigã€‚</p>
<p>æ‹¿å•ä¸ªæ§åˆ¶å‡ ç‚¹æœåŠ¡å™¨ä¸Šçš„å¤‡ä»½æ­¥éª¤æ¥çœ‹ï¼š</p>
<pre tabindex="0"><code># Backup certificates
sudo cp -r /etc/kubernetes/pki backup/
# Make etcd snapshot
sudo docker run --rm -v $(pwd)/backup:/backup \
    --network host \
    -v /etc/kubernetes/pki/etcd:/etc/kubernetes/pki/etcd \
    --env ETCDCTL_API=3 \
    k8s.gcr.io/etcd:3.4.3-0 \
    etcdctl --endpoints=https://127.0.0.1:2379 \
    --cacert=/etc/kubernetes/pki/etcd/ca.crt \
    --cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt \
    --key=/etc/kubernetes/pki/etcd/healthcheck-client.key \
    snapshot save /backup/etcd-snapshot-latest.db

# Backup kubeadm-config
sudo cp /etc/kubeadm/kubeadm-config.yaml backup/

</code></pre><p>æ•°æ®æ¢å¤ä¸€ä¸ªæ§åˆ¶èŠ‚ç‚¹çš„æ“ä½œå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code># Restore certificates
sudo cp -r backup/pki /etc/kubernetes/

# Restore etcd backup
sudo mkdir -p /var/lib/etcd
sudo docker run --rm \
    -v $(pwd)/backup:/backup \
    -v /var/lib/etcd:/var/lib/etcd \
    --env ETCDCTL_API=3 \
    k8s.gcr.io/etcd:3.4.3-0 \
    /bin/sh -c &quot;etcdctl snapshot restore '/backup/etcd-snapshot-latest.db' ; \
    mv /default.etcd/member/ /var/lib/etcd/&quot;

# Restore kubeadm-config
sudo mkdir /etc/kubeadm
sudo cp backup/kubeadm-config.yaml /etc/kubeadm/

# Initialize the master with backup
sudo kubeadm init --ignore-preflight-errors=DirAvailable--var-lib-etcd \
    --config /etc/kubeadm/kubeadm-config.yaml

</code></pre><p>é€šè¿‡ä»¥ä¸Šæ¡ˆä¾‹çŸ¥é“ Kubernetes é›†ç¾¤ä¸­ etcd æ•°æ®çš„å¤‡ä»½å’Œæ¢å¤ï¼Œå­¦ä¼šå–„ç”¨å’Œ <code>kubectl cp</code> çš„é…åˆä½¿ç”¨ã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>ä¾èµ– Kubernetes åŸç”Ÿçš„æ•°æ®å¤åˆ¶èƒ½åŠ› <code>kubectl cp</code> å’Œ cronjobï¼Œæˆ‘ä»¬å¯ä»¥åº”å¯¹å¤§éƒ¨åˆ†çš„æ•°æ®å¤‡ä»½å’Œæ¢å¤å·¥ä½œã€‚å½“éœ€è¦å¤„ç†åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¤‡ä»½å’Œæ¢å¤çš„æ—¶å€™ï¼Œå¤§éƒ¨åˆ†æƒ…å†µå¹¶ä¸æ˜¯å»å¤‡ä»½æ•°æ®ï¼Œè€Œæ˜¯å°è¯•ä»æœ‰æ•ˆèŠ‚ç‚¹ä¸­å»é™¤æ•…éšœèŠ‚ç‚¹ï¼Œè®©é›†ç¾¤èƒ½è‡ªæ„ˆã€‚è¿™æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç‰¹ç‚¹ï¼Œå®ƒå¯ä»¥è‡ªæ„ˆã€‚ä½†æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¼±ç‚¹ä¹Ÿåœ¨äºè‡ªæ„ˆæ˜¯æœ‰æ¡ä»¶çš„ï¼Œå¦‚æœæ•…éšœèŠ‚ç‚¹è¶…è¿‡å¯ç”¨èŠ‚ç‚¹æ•° Quorumï¼Œå†æ™ºèƒ½ä¹Ÿæ˜¯æ— ç”¨çš„ã€‚æ‰€ä»¥å¤‡ä»½ä»ç„¶æ˜¯æœ€åä¸€é“é˜²çº¿ã€‚ä¸€å®šè¦åšå®šæœŸçš„å¹¶ä¸”å†—ä½™çš„<strong>æ•°æ®å¤‡ä»½</strong>ã€‚</p>
<h3 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h3>
<ul>
<li><a href="https://github.com/rook/rook/blob/master/Documentation/ceph-disaster-recovery.md">https://github.com/rook/rook/blob/master/Documentation/ceph-disaster-recovery.md</a></li>
<li><a href="https://zh.wikipedia.org/wiki/Quorum_(%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F)">https://zh.wikipedia.org/wiki/Quorum_(%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F)</a></li>
</ul>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/22-%E5%AD%98%E5%82%A8%E5%AF%B9%E8%B1%A1-pvpvcstorage-classes-%E7%9A%84%E7%AE%A1%E7%90%86%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5/"><span>22 å­˜å‚¨å¯¹è±¡ PVã€PVCã€Storage Classes çš„ç®¡ç†è½åœ°å®è·µ</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/24-%E7%BB%83%E4%B9%A0%E7%AF%87k8s-%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE%E6%B5%8B%E9%AA%8C/"><span>24 ç»ƒä¹ ç¯‡ï¼šK8s é›†ç¾¤é…ç½®æµ‹éªŒ</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 27270 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>