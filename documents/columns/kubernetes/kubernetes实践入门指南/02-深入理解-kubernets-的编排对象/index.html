<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>02 æ·±å…¥ç†è§£ Kubernets çš„ç¼–æ’å¯¹è±¡ | Yipsen Ye</title>
<meta name="description" content="Kubernetes ç³»ç»Ÿæ˜¯ä¸€å¥—åˆ†å¸ƒå¼å®¹å™¨åº”ç”¨ç¼–æ’ç³»ç»Ÿï¼Œå½“æˆ‘ä»¬ç”¨å®ƒæ¥æ‰¿è½½ä¸šåŠ¡è´Ÿè½½æ—¶ä¸»è¦ä½¿ç”¨çš„ç¼–æ’å¯¹è±¡æœ‰ Deploymentã€ReplicaSetã€StatefulSetã€DaemonSet ç­‰ã€‚è¯»è€…å¯èƒ½å¥½å¥‡çš„åœ°æ–¹æ˜¯ Kubernetes ç®¡ç†çš„å¯¹è±¡ä¸æ˜¯ Pod å—ï¼Ÿä¸ºä»€ä¹ˆä¸å»è®²è®²å¦‚ä½•çµæ´»é…ç½® Pod å‚æ•°ã€‚å…¶å®è¿™äº›å¯¹è±¡éƒ½æ˜¯å¯¹ Pod å¯¹è±¡çš„æ‰©å±•å°è£…ã€‚å¹¶ä¸”è¿™äº›å¯¹è±¡ä½œä¸ºæ ¸å¿ƒå·¥ä½œè´Ÿè½½ API å›ºåŒ–åœ¨ Kubernetes ç³»ç»Ÿä¸­äº†ã€‚æ‰€ä»¥ ï¼Œæˆ‘ä»¬æœ‰å¿…è¦è®¤çœŸçš„å›é¡¾å’Œç†è§£è¿™äº›ç¼–æ’å¯¹è±¡ï¼Œä¾æ®ç”Ÿäº§å®è·µçš„åœºæ™¯éœ€è¦ï¼Œåˆç†çš„é…ç½®è¿™äº›ç¼–æ’å¯¹è±¡ï¼Œè®© Kubernetes ç³»ç»Ÿèƒ½æ›´å¥½çš„æ”¯æŒæˆ‘ä»¬çš„ä¸šåŠ¡éœ€è¦ã€‚æœ¬æ–‡ä¼šä»å®é™…åº”ç”¨å‘å¸ƒçš„åœºæ™¯å…¥æ‰‹ï¼Œåˆ†æå’Œæ¢³ç†å…·ä½“åœºæ™¯ä¸­éœ€è¦è€ƒè™‘çš„ç¼–æ’å› ç´ ï¼Œå¹¶æ•´ç†å‡ºä¸€å¥—å¯ä»¥çµæ´»ä½¿ç”¨çš„ç¼–æ’å¯¹è±¡ä½¿ç”¨å®è·µã€‚
å¸¸è§„ä¸šåŠ¡å®¹å™¨éƒ¨ç½²ç­–ç•¥ ç­–ç•¥ä¸€ï¼šå¼ºåˆ¶è¿è¡Œä¸å°‘äº 2 ä¸ªå®¹å™¨å®ä¾‹å‰¯æœ¬ åœ¨åº”å¯¹å¸¸è§„ä¸šåŠ¡å®¹å™¨çš„åœºæ™¯ä¹‹ä¸‹ï¼ŒKubernetes æä¾›äº† Deployment æ ‡å‡†ç¼–æ’å¯¹è±¡ï¼Œä»å‘½ä»¤ä¸Šæˆ‘ä»¬å°±å¯ä»¥ç†è§£å®ƒçš„ä½œç”¨å°±æ˜¯ç”¨æ¥éƒ¨ç½²å®¹å™¨åº”ç”¨çš„ã€‚Deployment ç®¡ç†çš„æ˜¯ä¸šåŠ¡å®¹å™¨ Podï¼Œå› ä¸ºå®¹å™¨æŠ€æœ¯å…·å¤‡è™šæ‹Ÿæœºçš„å¤§éƒ¨åˆ†ç‰¹æ€§ï¼Œå¾€å¾€è®©ç”¨æˆ·è¯¯è§£è®¤ä¸ºå®¹å™¨å°±æ˜¯æ–°ä¸€ä»£çš„è™šæ‹Ÿæœºã€‚ä»æ™®é€šç”¨æˆ·çš„å°è±¡æ¥çœ‹ï¼Œè™šæ‹Ÿæœºç»™ç”¨æˆ·çš„æ˜ è±¡æ˜¯ç¨³å®šå¯é ã€‚å¦‚æœç”¨æˆ·æƒ³å½“ç„¶åœ°æŠŠä¸šåŠ¡å®¹å™¨ Pod ä¹Ÿå½’ç±»ä¸ºç¨³å®šå¯é çš„å®ä¾‹ï¼Œé‚£å°±æ˜¯å®Œå…¨é”™è¯¯çš„ç†è§£äº†ã€‚å®¹å™¨ç»„ Pod æ›´å¤šçš„æ—¶å€™æ˜¯è¢«è®¾è®¡ä¸ºçŸ­ç”Ÿå‘½å‘¨æœŸçš„å®ä¾‹ï¼Œå®ƒæ— æ³•åƒè™šæ‹Ÿæœºé‚£æ ·æŒä¹…åœ°ä¿å­˜è¿›ç¨‹çŠ¶æ€ã€‚å› ä¸ºå®¹å™¨ç»„ Pod å®ä¾‹çš„è„†å¼±æ€§ï¼Œæ¯æ¬¡å‘å¸ƒçš„å®ä¾‹æ•°ä¸€å®šæ˜¯å¤šå‰¯æœ¬ï¼Œé»˜è®¤æœ€å°‘æ˜¯ 2 ä¸ªã€‚
éƒ¨ç½²å¤šå‰¯æœ¬ç¤ºä¾‹ï¼š
apiVersion: apps/v1kind: Deploymentmetadata:name: nginx-deploymentlabels:app: nginxspec:replicas: 2selector:matchLabels:app: nginxtemplate:metadata:labels:app: nginxspec:containers:- name: nginximage: nginx:1.7.9ports:- containerPort: 80ç­–ç•¥äºŒï¼šé‡‡ç”¨èŠ‚ç‚¹äº²å’Œï¼ŒPod é—´äº²å’Œ/åäº²å’Œç¡®ä¿ Pod å®ç°é«˜å¯ç”¨è¿è¡Œ å½“è¿ç»´å‘å¸ƒå¤šä¸ªå‰¯æœ¬å®ä¾‹çš„ä¸šåŠ¡å®¹å™¨çš„æ—¶å€™ï¼Œä¸€å®šéœ€è¦ä»”ç»†æ³¨æ„åˆ°ä¸€ä¸ªäº‹å®ã€‚Kubernetes çš„è°ƒåº¦é»˜è®¤ç­–ç•¥æ˜¯é€‰å–æœ€ç©ºé—²çš„èµ„æºä¸»æœºæ¥éƒ¨ç½²å®¹å™¨åº”ç”¨ï¼Œä¸è€ƒè™‘ä¸šåŠ¡é«˜å¯ç”¨çš„å®é™…æƒ…å†µã€‚å½“ä½ çš„é›†ç¾¤ä¸­éƒ¨ç½²çš„ä¸šåŠ¡è¶Šå¤šï¼Œä½ çš„ä¸šåŠ¡é£é™©ä¼šè¶Šå¤§ã€‚ä¸€æ—¦ä½ çš„ä¸šåŠ¡å®¹å™¨æ‰€åœ¨çš„ä¸»æœºå‡ºç°å®•æœºä¹‹åï¼Œå¸¦æ¥çš„å®¹å™¨é‡å¯åŠ¨é£æš´ä¹Ÿä¼šå³å¯åˆ°æ¥ã€‚ä¸ºäº†å®ç°ä¸šåŠ¡å®¹é”™å’Œé«˜å¯ç”¨çš„åœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘é€šè¿‡ Node çš„äº²å’Œæ€§å’Œ Pod çš„åäº²å’Œæ€§æ¥è¾¾åˆ°åˆç†çš„éƒ¨ç½²ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼ŒKubernetes çš„è°ƒåº¦ç³»ç»Ÿæ¥å£æ˜¯å¼€æ”¾å¼çš„ï¼Œä½ å¯ä»¥å®ç°è‡ªå·±çš„ä¸šåŠ¡è°ƒåº¦ç­–ç•¥æ¥æ›¿æ¢é»˜è®¤çš„è°ƒåº¦ç­–ç•¥ã€‚æˆ‘ä»¬è¿™é‡Œçš„ç­–ç•¥æ˜¯å°½é‡é‡‡ç”¨ Kubernetes åŸç”Ÿèƒ½åŠ›æ¥å®ç°ã€‚">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/kubernetes%e5%ae%9e%e8%b7%b5%e5%85%a5%e9%97%a8%e6%8c%87%e5%8d%97/">Kuberneteså®è·µå…¥é—¨æŒ‡å—</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/00-%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E4%BB%AC%E8%A6%81%E5%AD%A6%E4%B9%A0-kubernetes-%E6%8A%80%E6%9C%AF/">00 ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦å­¦ä¹  Kubernetes æŠ€æœ¯</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/01-%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86-kubernetes-%E7%9A%84%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6/">01 é‡æ–°è®¤è¯† Kubernetes çš„æ ¸å¿ƒç»„ä»¶</a></li>
                
                
                
                    <li>02 æ·±å…¥ç†è§£ Kubernets çš„ç¼–æ’å¯¹è±¡</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/03-devops-%E5%9C%BA%E6%99%AF%E4%B8%8B%E8%90%BD%E5%9C%B0-k8s-%E7%9A%84%E5%9B%B0%E9%9A%BE%E5%88%86%E6%9E%90/">03 DevOps åœºæ™¯ä¸‹è½åœ° K8s çš„å›°éš¾åˆ†æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/04-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%E4%B8%8B%E8%90%BD%E5%9C%B0-k8s-%E7%9A%84%E5%9B%B0%E9%9A%BE%E5%88%86%E6%9E%90/">04 å¾®æœåŠ¡åº”ç”¨åœºæ™¯ä¸‹è½åœ° K8s çš„å›°éš¾åˆ†æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/05-%E8%A7%A3%E5%86%B3-k8s-%E8%90%BD%E5%9C%B0%E9%9A%BE%E9%A2%98%E7%9A%84%E6%96%B9%E6%B3%95%E8%AE%BA%E6%8F%90%E7%82%BC/">05 è§£å†³ K8s è½åœ°éš¾é¢˜çš„æ–¹æ³•è®ºæç‚¼</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/06-%E7%BB%83%E4%B9%A0%E7%AF%87k8s-%E6%A0%B8%E5%BF%83%E5%AE%9E%E8%B7%B5%E7%9F%A5%E8%AF%86%E6%8E%8C%E6%8F%A1/">06 ç»ƒä¹ ç¯‡ï¼šK8s æ ¸å¿ƒå®è·µçŸ¥è¯†æŒæ¡</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/07-%E5%AE%B9%E5%99%A8%E5%BC%95%E6%93%8E-containerd-%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5/">07 å®¹å™¨å¼•æ“ containerd è½åœ°å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/08-k8s-%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E5%B7%A5%E5%85%B7-kubeadm-%E7%9A%84%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5/">08 K8s é›†ç¾¤å®‰è£…å·¥å…· kubeadm çš„è½åœ°å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/09-%E5%8D%97%E5%8C%97%E5%90%91%E6%B5%81%E9%87%8F%E7%BB%84%E4%BB%B6-ipvs-%E7%9A%84%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5/">09 å—åŒ—å‘æµé‡ç»„ä»¶ IPVS çš„è½åœ°å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/10-%E4%B8%9C%E8%A5%BF%E5%90%91%E6%B5%81%E9%87%8F%E7%BB%84%E4%BB%B6-calico-%E7%9A%84%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5/">10 ä¸œè¥¿å‘æµé‡ç»„ä»¶ Calico çš„è½åœ°å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/11-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0-dns-%E7%9A%84%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5/">11 æœåŠ¡å‘ç° DNS çš„è½åœ°å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/12-%E7%BB%83%E4%B9%A0%E7%AF%87k8s-%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE%E6%B5%8B%E9%AA%8C/">12 ç»ƒä¹ ç¯‡ï¼šK8s é›†ç¾¤é…ç½®æµ‹éªŒ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/13-%E7%90%86%E8%A7%A3%E5%AF%B9%E6%96%B9%E6%9A%B4%E9%9C%B2%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%AF%B9%E8%B1%A1-ingress-%E5%92%8C-service/">13 ç†è§£å¯¹æ–¹æš´éœ²æœåŠ¡çš„å¯¹è±¡ Ingress å’Œ Service</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/14-%E5%BA%94%E7%94%A8%E7%BD%91%E5%85%B3-openresty-%E5%AF%B9%E6%8E%A5-k8s-%E5%AE%9E%E8%B7%B5/">14 åº”ç”¨ç½‘å…³ OpenResty å¯¹æ¥ K8s å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/15-service-%E5%B1%82%E5%BC%95%E6%B5%81%E6%8A%80%E6%9C%AF%E5%AE%9E%E8%B7%B5/">15 Service å±‚å¼•æµæŠ€æœ¯å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/16-cilium-%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E7%9A%84%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5/">16 Cilium å®¹å™¨ç½‘ç»œçš„è½åœ°å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/17-%E5%BA%94%E7%94%A8%E6%B5%81%E9%87%8F%E7%9A%84%E4%BC%98%E9%9B%85%E6%97%A0%E6%8D%9F%E5%88%87%E6%8D%A2%E5%AE%9E%E8%B7%B5/">17 åº”ç”¨æµé‡çš„ä¼˜é›…æ— æŸåˆ‡æ¢å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/18-%E7%BB%83%E4%B9%A0%E7%AF%87%E5%BA%94%E7%94%A8%E6%B5%81%E9%87%8F%E6%97%A0%E6%8D%9F%E5%88%87%E6%8D%A2%E6%8A%80%E6%9C%AF%E6%B5%8B%E9%AA%8C/">18 ç»ƒä¹ ç¯‡ï¼šåº”ç”¨æµé‡æ— æŸåˆ‡æ¢æŠ€æœ¯æµ‹éªŒ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/19-%E4%BD%BF%E7%94%A8-rook-%E6%9E%84%E5%BB%BA%E7%94%9F%E4%BA%A7%E5%8F%AF%E7%94%A8%E5%AD%98%E5%82%A8%E7%8E%AF%E5%A2%83%E5%AE%9E%E8%B7%B5/">19 ä½¿ç”¨ Rook æ„å»ºç”Ÿäº§å¯ç”¨å­˜å‚¨ç¯å¢ƒå®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/20-%E6%9C%89%E7%8A%B6%E6%80%81%E5%BA%94%E7%94%A8%E7%9A%84%E9%BB%98%E8%AE%A4%E7%89%B9%E6%80%A7%E8%90%BD%E5%9C%B0%E5%88%86%E6%9E%90/">20 æœ‰çŠ¶æ€åº”ç”¨çš„é»˜è®¤ç‰¹æ€§è½åœ°åˆ†æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/21-%E6%A1%88%E4%BE%8B%E5%88%86%E5%B8%83%E5%BC%8F-mysql-%E9%9B%86%E7%BE%A4%E5%B7%A5%E5%85%B7-vitess-%E5%AE%9E%E8%B7%B5%E5%88%86%E6%9E%90/">21 æ¡ˆä¾‹ï¼šåˆ†å¸ƒå¼ MySQL é›†ç¾¤å·¥å…· Vitess å®è·µåˆ†æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/22-%E5%AD%98%E5%82%A8%E5%AF%B9%E8%B1%A1-pvpvcstorage-classes-%E7%9A%84%E7%AE%A1%E7%90%86%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5/">22 å­˜å‚¨å¯¹è±¡ PVã€PVCã€Storage Classes çš„ç®¡ç†è½åœ°å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/23-k8s-%E9%9B%86%E7%BE%A4%E4%B8%AD%E5%AD%98%E5%82%A8%E5%AF%B9%E8%B1%A1%E7%81%BE%E5%A4%87%E7%9A%84%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5/">23 K8s é›†ç¾¤ä¸­å­˜å‚¨å¯¹è±¡ç¾å¤‡çš„è½åœ°å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/24-%E7%BB%83%E4%B9%A0%E7%AF%87k8s-%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE%E6%B5%8B%E9%AA%8C/">24 ç»ƒä¹ ç¯‡ï¼šK8s é›†ç¾¤é…ç½®æµ‹éªŒ</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">02 æ·±å…¥ç†è§£ Kubernets çš„ç¼–æ’å¯¹è±¡</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2021-12-22 01:48:07</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/kubernetes/">kubernetes</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/">Kuberneteså®è·µå…¥é—¨æŒ‡å—</a>
                
            </div></div>
        <div class="post-content">
            <p>Kubernetes ç³»ç»Ÿæ˜¯ä¸€å¥—åˆ†å¸ƒå¼å®¹å™¨åº”ç”¨ç¼–æ’ç³»ç»Ÿï¼Œå½“æˆ‘ä»¬ç”¨å®ƒæ¥æ‰¿è½½ä¸šåŠ¡è´Ÿè½½æ—¶ä¸»è¦ä½¿ç”¨çš„ç¼–æ’å¯¹è±¡æœ‰ Deploymentã€ReplicaSetã€StatefulSetã€DaemonSet ç­‰ã€‚è¯»è€…å¯èƒ½å¥½å¥‡çš„åœ°æ–¹æ˜¯ Kubernetes ç®¡ç†çš„å¯¹è±¡ä¸æ˜¯ Pod å—ï¼Ÿä¸ºä»€ä¹ˆä¸å»è®²è®²å¦‚ä½•çµæ´»é…ç½® Pod å‚æ•°ã€‚å…¶å®è¿™äº›å¯¹è±¡éƒ½æ˜¯å¯¹ Pod å¯¹è±¡çš„æ‰©å±•å°è£…ã€‚å¹¶ä¸”è¿™äº›å¯¹è±¡ä½œä¸ºæ ¸å¿ƒå·¥ä½œè´Ÿè½½ API å›ºåŒ–åœ¨ Kubernetes ç³»ç»Ÿä¸­äº†ã€‚æ‰€ä»¥ ï¼Œæˆ‘ä»¬æœ‰å¿…è¦è®¤çœŸçš„å›é¡¾å’Œç†è§£è¿™äº›ç¼–æ’å¯¹è±¡ï¼Œä¾æ®ç”Ÿäº§å®è·µçš„åœºæ™¯éœ€è¦ï¼Œåˆç†çš„é…ç½®è¿™äº›ç¼–æ’å¯¹è±¡ï¼Œè®© Kubernetes ç³»ç»Ÿèƒ½æ›´å¥½çš„æ”¯æŒæˆ‘ä»¬çš„ä¸šåŠ¡éœ€è¦ã€‚æœ¬æ–‡ä¼šä»å®é™…åº”ç”¨å‘å¸ƒçš„åœºæ™¯å…¥æ‰‹ï¼Œåˆ†æå’Œæ¢³ç†å…·ä½“åœºæ™¯ä¸­éœ€è¦è€ƒè™‘çš„ç¼–æ’å› ç´ ï¼Œå¹¶æ•´ç†å‡ºä¸€å¥—å¯ä»¥çµæ´»ä½¿ç”¨çš„ç¼–æ’å¯¹è±¡ä½¿ç”¨å®è·µã€‚</p>
<h3 id="å¸¸è§„ä¸šåŠ¡å®¹å™¨éƒ¨ç½²ç­–ç•¥">å¸¸è§„ä¸šåŠ¡å®¹å™¨éƒ¨ç½²ç­–ç•¥</h3>
<h4 id="ç­–ç•¥ä¸€å¼ºåˆ¶è¿è¡Œä¸å°‘äº-2-ä¸ªå®¹å™¨å®ä¾‹å‰¯æœ¬"><strong>ç­–ç•¥ä¸€ï¼šå¼ºåˆ¶è¿è¡Œä¸å°‘äº 2 ä¸ªå®¹å™¨å®ä¾‹å‰¯æœ¬</strong></h4>
<p>åœ¨åº”å¯¹å¸¸è§„ä¸šåŠ¡å®¹å™¨çš„åœºæ™¯ä¹‹ä¸‹ï¼ŒKubernetes æä¾›äº† Deployment æ ‡å‡†ç¼–æ’å¯¹è±¡ï¼Œä»å‘½ä»¤ä¸Šæˆ‘ä»¬å°±å¯ä»¥ç†è§£å®ƒçš„ä½œç”¨å°±æ˜¯ç”¨æ¥éƒ¨ç½²å®¹å™¨åº”ç”¨çš„ã€‚Deployment ç®¡ç†çš„æ˜¯ä¸šåŠ¡å®¹å™¨ Podï¼Œå› ä¸ºå®¹å™¨æŠ€æœ¯å…·å¤‡è™šæ‹Ÿæœºçš„å¤§éƒ¨åˆ†ç‰¹æ€§ï¼Œå¾€å¾€è®©ç”¨æˆ·è¯¯è§£è®¤ä¸ºå®¹å™¨å°±æ˜¯æ–°ä¸€ä»£çš„è™šæ‹Ÿæœºã€‚ä»æ™®é€šç”¨æˆ·çš„å°è±¡æ¥çœ‹ï¼Œè™šæ‹Ÿæœºç»™ç”¨æˆ·çš„æ˜ è±¡æ˜¯ç¨³å®šå¯é ã€‚å¦‚æœç”¨æˆ·æƒ³å½“ç„¶åœ°æŠŠä¸šåŠ¡å®¹å™¨ Pod ä¹Ÿå½’ç±»ä¸ºç¨³å®šå¯é çš„å®ä¾‹ï¼Œé‚£å°±æ˜¯å®Œå…¨é”™è¯¯çš„ç†è§£äº†ã€‚å®¹å™¨ç»„ Pod æ›´å¤šçš„æ—¶å€™æ˜¯è¢«è®¾è®¡ä¸ºçŸ­ç”Ÿå‘½å‘¨æœŸçš„å®ä¾‹ï¼Œå®ƒæ— æ³•åƒè™šæ‹Ÿæœºé‚£æ ·æŒä¹…åœ°ä¿å­˜è¿›ç¨‹çŠ¶æ€ã€‚å› ä¸ºå®¹å™¨ç»„ Pod å®ä¾‹çš„è„†å¼±æ€§ï¼Œæ¯æ¬¡å‘å¸ƒçš„å®ä¾‹æ•°ä¸€å®šæ˜¯å¤šå‰¯æœ¬ï¼Œé»˜è®¤æœ€å°‘æ˜¯ 2 ä¸ªã€‚</p>
<p>éƒ¨ç½²å¤šå‰¯æœ¬ç¤ºä¾‹ï¼š</p>
<pre tabindex="0"><code class="language-config" data-lang="config">apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    app: nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.7.9
        ports:
        - containerPort: 80

</code></pre><h4 id="ç­–ç•¥äºŒé‡‡ç”¨èŠ‚ç‚¹äº²å’Œpod-é—´äº²å’Œåäº²å’Œç¡®ä¿-pod-å®ç°é«˜å¯ç”¨è¿è¡Œ"><strong>ç­–ç•¥äºŒï¼šé‡‡ç”¨èŠ‚ç‚¹äº²å’Œï¼ŒPod é—´äº²å’Œ/åäº²å’Œç¡®ä¿ Pod å®ç°é«˜å¯ç”¨è¿è¡Œ</strong></h4>
<p>å½“è¿ç»´å‘å¸ƒå¤šä¸ªå‰¯æœ¬å®ä¾‹çš„ä¸šåŠ¡å®¹å™¨çš„æ—¶å€™ï¼Œä¸€å®šéœ€è¦ä»”ç»†æ³¨æ„åˆ°ä¸€ä¸ªäº‹å®ã€‚Kubernetes çš„è°ƒåº¦é»˜è®¤ç­–ç•¥æ˜¯é€‰å–æœ€ç©ºé—²çš„èµ„æºä¸»æœºæ¥éƒ¨ç½²å®¹å™¨åº”ç”¨ï¼Œä¸è€ƒè™‘ä¸šåŠ¡é«˜å¯ç”¨çš„å®é™…æƒ…å†µã€‚å½“ä½ çš„é›†ç¾¤ä¸­éƒ¨ç½²çš„ä¸šåŠ¡è¶Šå¤šï¼Œä½ çš„ä¸šåŠ¡é£é™©ä¼šè¶Šå¤§ã€‚ä¸€æ—¦ä½ çš„ä¸šåŠ¡å®¹å™¨æ‰€åœ¨çš„ä¸»æœºå‡ºç°å®•æœºä¹‹åï¼Œå¸¦æ¥çš„å®¹å™¨é‡å¯åŠ¨é£æš´ä¹Ÿä¼šå³å¯åˆ°æ¥ã€‚ä¸ºäº†å®ç°ä¸šåŠ¡å®¹é”™å’Œé«˜å¯ç”¨çš„åœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘é€šè¿‡ Node çš„äº²å’Œæ€§å’Œ Pod çš„åäº²å’Œæ€§æ¥è¾¾åˆ°åˆç†çš„éƒ¨ç½²ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼ŒKubernetes çš„è°ƒåº¦ç³»ç»Ÿæ¥å£æ˜¯å¼€æ”¾å¼çš„ï¼Œä½ å¯ä»¥å®ç°è‡ªå·±çš„ä¸šåŠ¡è°ƒåº¦ç­–ç•¥æ¥æ›¿æ¢é»˜è®¤çš„è°ƒåº¦ç­–ç•¥ã€‚æˆ‘ä»¬è¿™é‡Œçš„ç­–ç•¥æ˜¯å°½é‡é‡‡ç”¨ Kubernetes åŸç”Ÿèƒ½åŠ›æ¥å®ç°ã€‚</p>
<p>ä¸ºäº†æ›´å¥½åœ°ç†è§£é«˜å¯ç”¨çš„é‡è¦æ€§ï¼Œæˆ‘ä»¬æ·±å…¥æ¢è®¨ä¸€äº›å®é™…çš„ä¸šåŠ¡åœºæ™¯ã€‚</p>
<p><strong>é¦–å…ˆï¼ŒKubernetes å¹¶ä¸æ˜¯è°·æ­Œå†…éƒ¨ä½¿ç”¨çš„ Borg ç³»ç»Ÿ</strong>ï¼Œå¤§éƒ¨åˆ†ä¸­å°ä¼ä¸šä½¿ç”¨çš„ Kubernetes éƒ¨ç½²æ–¹æ¡ˆéƒ½æ˜¯äººå·¥æ‰©å±•çš„ç§æœ‰èµ„æºæ± ã€‚å½“ä½ å‘å¸ƒå®¹å™¨åˆ°é›†ç¾¤ä¸­ï¼Œé›†ç¾¤ä¸ä¼šå› ä¸ºèµ„æºä¸å¤Ÿèƒ½è‡ªåŠ¨æ‰©å±•ä¸»æœºå¹¶è‡ªåŠ¨è´Ÿè½½éƒ¨ç½²å®¹å™¨ Podã€‚å³ä½¿æ˜¯åœ¨å…¬æœ‰äº‘ä¸Šçš„ Kubernetes æœåŠ¡ï¼Œåªæœ‰å½“ä½ é€‰æ‹© Serverlesss Kubernetes ç±»å‹æ—¶æ‰èƒ½å®ç°èµ„æºçš„å¼¹æ€§ä¼¸ç¼©ã€‚å¾ˆå¤šä¼ ç»Ÿä¼ä¸šåœ¨è½åœ° Kubernetes æŠ€æœ¯æ—¶æ¯”è¾ƒå…³å¿ƒçš„å¼¹æ€§ä¼¸ç¼©èƒ½åŠ›ï¼Œç›®å‰åªèƒ½æŠ˜ä¸­æ»¡è¶³äºåœ¨æœ‰é™é™æ€èµ„æºçš„é™åˆ¶å†…åŠ¨æ€å¯åœå®¹å™¨ç»„ Podï¼Œå®ç°ç±»ä¼¼çš„ä¸šåŠ¡å®¹å™¨çš„å¼¹æ€§ã€‚ç”¨ä¸€ä¸ªä¸å¤ªæ°å½“çš„æ¯”å–»å°±æ˜¯æˆ¿å±‹ä¸­ä»‹ä¸­ï¼Œä»ç‹¬ç«‹å…¬å¯“å˜æˆäº†æ ¼å­é—´å…¬å¯“ï¼Œç©ºé—´å¹¶æ²¡æœ‰å®è´¨æ€§æ‰©å¤§ã€‚åœ¨å®é™…æœ‰é™èµ„æºçš„æƒ…å†µä¸‹ï¼ŒKubernetes æä¾›äº†æ‰“æ ‡ç­¾çš„åŠŸèƒ½ï¼Œä½ å¯ä»¥ç»™ä¸»æœºã€å®¹å™¨ç»„ Pod æ‰“ä¸Šå„ç§æ ‡ç­¾ï¼Œè¿™äº›æ ‡ç­¾çš„çµæ´»è¿ç”¨ï¼Œå¯ä»¥å¸®ä½ å¿«é€Ÿå®ç°ä¸šåŠ¡çš„é«˜å¯ç”¨è¿è¡Œã€‚</p>
<p>**å…¶æ¬¡ï¼Œå®è·µä¸­ä½ ä¼šå‘ç°ï¼Œä¸ºäº†é«˜æ•ˆæœ‰æ•ˆçš„æ§åˆ¶ä¸šåŠ¡å®¹å™¨ï¼Œä½ æ˜¯éœ€è¦èµ„æºä¸»æœºçš„ã€‚**ä½ ä¸èƒ½ä»»ç”± Kubernetes è°ƒåº¦æ¥åˆ†é…ä¸»æœºå¯åŠ¨å®¹å™¨ï¼Œè¿™ä¸ªåœ¨æ—©æœŸèµ„æºå……è£•çš„æƒ…å†µä¸‹çœ‹ä¸åˆ°é—®é¢˜ã€‚å½“ä½ çš„ä¸šåŠ¡å¤æ‚ä¹‹åï¼Œä½ ä¼šéƒ¨ç½²æ›´å¤šçš„å®¹å™¨åˆ°èµ„æºæ± ä¸­ï¼Œè¿™ä¸ªæ—¶é—´ä½ çš„ä¸šåŠ¡è¿è¡Œçš„æ½œåœ¨å±æœºå°±ä¼šå‡ºç°ã€‚å› ä¸ºä½ æ²¡æœ‰ç®¡ç†è°ƒåº¦èµ„æºï¼Œå¯¼è‡´å¾ˆå¤šå…³é”®ä¸šåŠ¡æ˜¯è¿è¡Œåœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šï¼Œå½“ä¸»æœºå®•æœºå‘ç”Ÿæ—¶ï¼Œè®©ä½ å¾ˆéš¾å¤„ç†è¿™ç§ç¾éš¾ã€‚æ‰€ä»¥åœ¨å®é™…çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œä¸šåŠ¡ä¹‹é—´çš„å…³ç³»éœ€è¦æ¢³ç†æ¸…æ¥šï¼Œè®¾è®¡å•å…ƒåŒ–ä¸»æœºèµ„æºæ¨¡å—ï¼Œæ¯”å¦‚ 2 å°ä¸»æœºä¸ºä¸€ä¸ªå•å…ƒï¼Œéƒ¨ç½²å›ºå®šçš„ä¸šåŠ¡å®¹å™¨ç»„ Podï¼Œå¹¶ä¸”è®©å®¹å™¨ç»„ Pod èƒ½è¶³å¤Ÿåˆ†æ•£çš„è¿è¡Œåœ¨è¿™ä¸¤å°ä¸»æœºä¹‹ä¸Šï¼Œå½“ä»»ä½•ä¸€å°ä¸»æœºå®•æœºä¹Ÿä¸ä¼šå½±å“åˆ°ä¸»ä½“ä¸šåŠ¡ï¼Œå®ç°çœŸæ­£çš„é«˜å¯ç”¨ã€‚</p>
<p><strong>ä¸»æœºäº²å’Œæ€§ç¤ºä¾‹</strong></p>
<pre tabindex="0"><code>pods/pod-with-node-affinity.yaml 

apiVersion: v1
kind: Pod
metadata:
  name: with-node-affinity
spec:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.io/e2e-az-name
            operator: In
            values:
            - e2e-az1
            - e2e-az2
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 1
        preference:
          matchExpressions:
          - key: another-node-label-key
            operator: In
            values:
            - another-node-label-value
  containers:
  - name: with-node-affinity
    image: gcr.azk8s.cn/google-samples/node-hello:1.0

</code></pre><p>ç›®å‰æœ‰ä¸¤ç§ç±»å‹çš„èŠ‚ç‚¹äº²å’Œï¼Œåˆ†åˆ«ä¸º requiredDuringSchedulingIgnoredDuringExecution å’Œ preferredDuringSchedulingIgnoredDuringExecutionã€‚ä½ å¯ä»¥è§†å®ƒä»¬ä¸ºâ€œç¡¬â€å’Œâ€œè½¯â€ï¼Œæ„æ€æ˜¯ï¼Œå‰è€…æŒ‡å®šäº†å°† pod è°ƒåº¦åˆ°ä¸€ä¸ªèŠ‚ç‚¹ä¸Šå¿…é¡»æ»¡è¶³çš„è§„åˆ™ï¼Œåè€…æŒ‡å®šè°ƒåº¦å™¨å°†å°è¯•æ‰§è¡Œä½†ä¸èƒ½ä¿è¯çš„åå¥½ã€‚</p>
<p><strong>Pod é—´äº²å’Œä¸åäº²å’Œç¤ºä¾‹</strong></p>
<p>ä½¿ç”¨åäº²å’Œæ€§é¿å…å•ç‚¹æ•…éšœä¾‹å­ï¼š</p>
<pre tabindex="0"><code>     affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: &quot;app&quot;
                    operator: In
                    values:
                    - zk
              topologyKey: &quot;kubernetes.io/hostname&quot;

</code></pre><p>æ„æ€æ˜¯ä»¥ä¸»æœºçš„ hostname å‘½åç©ºé—´æ¥è°ƒåº¦ï¼Œè¿è¡Œæ‰“äº†æ ‡ç­¾é”® <code>&quot;app&quot;</code> å¹¶å«æœ‰ <code>&quot;zk&quot;</code> å€¼çš„ Pod åœ¨ä¸åŒèŠ‚ç‚¹ä¸Šéƒ¨ç½²ã€‚</p>
<h4 id="ç­–ç•¥ä¸‰ä½¿ç”¨-prestop-hook-å’Œ-readinessprobe-ä¿è¯æœåŠ¡å¹³æ»‘æ›´æ–°ä¸ä¸­æ–­"><strong>ç­–ç•¥ä¸‰ï¼šä½¿ç”¨ preStop Hook å’Œ readinessProbe ä¿è¯æœåŠ¡å¹³æ»‘æ›´æ–°ä¸ä¸­æ–­</strong></h4>
<p>æˆ‘ä»¬éƒ¨ç½²åº”ç”¨ä¹‹åï¼Œæ¥ä¸‹æ¥ä¼šåšçš„å·¥ä½œå°±æ˜¯æœåŠ¡æ›´æ–°çš„æ“ä½œã€‚å¦‚ä½•ä¿è¯å®¹å™¨æ›´æ–°çš„æ—¶å€™ï¼Œä¸šåŠ¡ä¸ä¸­æ–­æ˜¯æœ€é‡è¦çš„å…³å¿ƒäº‹é¡¹ã€‚å‚è€ƒç¤ºä¾‹ï¼š</p>
<pre tabindex="0"><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      component: nginx
  template:
    metadata:
      labels:
        component: nginx
    spec:
      containers:
      - name: nginx
        image: xds2000/nginx-hostname
        ports:
        - name: http
          hostPort: 80
          containerPort: 80
          protocol: TCP
        readinessProbe:
          httpGet:
            path: /
            port: 80
            httpHeaders:
            - name: X-Custom-Header
              value: Awesome
          initialDelaySeconds: 15
          timeoutSeconds: 1
        lifecycle:
          preStop:
            exec:
              command: [&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;sleep 30&quot;]

</code></pre><p>ç»™ Pod é‡Œçš„ container åŠ  readinessProbeï¼ˆå°±ç»ªæ£€æŸ¥ï¼‰ï¼Œé€šå¸¸æ˜¯å®¹å™¨å®Œå…¨å¯åŠ¨åç›‘å¬ä¸€ä¸ª HTTP ç«¯å£ï¼Œkubelet å‘é€å°±ç»ªæ£€æŸ¥æ¢æµ‹åŒ…ï¼Œæ­£å¸¸å“åº”è¯´æ˜å®¹å™¨å·²ç»å°±ç»ªï¼Œç„¶åä¿®æ”¹å®¹å™¨çŠ¶æ€ä¸º Readyï¼Œå½“ Pod ä¸­æ‰€æœ‰å®¹å™¨éƒ½ Ready ä¹‹åè¿™ä¸ª Pod æ‰ä¼šè¢« Endpoint Controller åŠ è¿› Service å¯¹åº” <code>Endpoint IP:Port</code> åˆ—è¡¨ï¼Œç„¶å kube-proxy å†æ›´æ–°èŠ‚ç‚¹è½¬å‘è§„åˆ™ï¼Œæ›´æ–°å®Œäº†å³ä¾¿ç«‹å³æœ‰è¯·æ±‚è¢«è½¬å‘åˆ°æ–°çš„ Pod ä¹Ÿèƒ½ä¿è¯èƒ½å¤Ÿæ­£å¸¸å¤„ç†è¿æ¥ï¼Œé¿å…äº†è¿æ¥å¼‚å¸¸ã€‚</p>
<p>ç»™ Pod é‡Œçš„ container åŠ  preStop hookï¼Œè®© Pod çœŸæ­£é”€æ¯å‰å…ˆ sleep ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œç•™ç‚¹æ—¶é—´ç»™ Endpoint controller å’Œ kube-proxy æ›´æ–° Endpoint å’Œè½¬å‘è§„åˆ™ï¼Œè¿™æ®µæ—¶é—´ Pod å¤„äº Terminating çŠ¶æ€ï¼Œå³ä¾¿åœ¨è½¬å‘è§„åˆ™æ›´æ–°å®Œå…¨ä¹‹å‰æœ‰è¯·æ±‚è¢«è½¬å‘åˆ°è¿™ä¸ª Terminating çš„ Podï¼Œä¾ç„¶å¯ä»¥è¢«æ­£å¸¸å¤„ç†ï¼Œå› ä¸ºå®ƒè¿˜åœ¨ sleepï¼Œæ²¡æœ‰è¢«çœŸæ­£é”€æ¯ã€‚</p>
<h4 id="ç­–ç•¥å››é€šè¿‡æ³›åŸŸåè½¬å‘å—åŒ—å‘æµé‡èŒƒå¼"><strong>ç­–ç•¥å››ï¼šé€šè¿‡æ³›åŸŸåè½¬å‘å—åŒ—å‘æµé‡èŒƒå¼</strong></h4>
<p>å¸¸è§„é›†ç¾¤å¯¹å¤–æš´éœ²ä¸€ä¸ªå…¬ç½‘ IP ä½œä¸ºæµé‡å…¥å£ï¼ˆå¯ä»¥æ˜¯ Ingress æˆ– Serviceï¼‰ï¼Œå†é€šè¿‡ DNS è§£æé…ç½®ä¸€ä¸ªæ³›åŸŸåæŒ‡å‘è¯¥ IPï¼ˆæ¯”å¦‚ *.test.foo.ioï¼‰ï¼Œç°å¸Œæœ›æ ¹æ®è¯·æ±‚ä¸­ä¸åŒ Host è½¬å‘åˆ°ä¸åŒçš„åç«¯ Serviceã€‚æ¯”å¦‚ a.test.foo.io çš„è¯·æ±‚è¢«è½¬å‘åˆ° my-svc-aï¼Œb.test.foo.io çš„è¯·æ±‚è½¬å‘åˆ° my-svc-bã€‚å½“å‰ Kubernetes çš„ Ingress å¹¶ä¸åŸç”Ÿæ”¯æŒè¿™ç§æ³›åŸŸåè½¬å‘è§„åˆ™ï¼Œæˆ‘ä»¬éœ€è¦å€ŸåŠ© Nginx çš„ Lua ç¼–ç¨‹èƒ½åŠ›è§£å†³å®ç°æ³›åŸŸåè½¬å‘ã€‚</p>
<p>Nginx proxy ç¤ºä¾‹ï¼ˆproxy.yamlï¼‰ï¼š</p>
<pre tabindex="0"><code>apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    component: nginx
  name: proxy
spec:
  replicas: 1
  selector:
    matchLabels:
      component: nginx
  template:
    metadata:
      labels:
        component: nginx
    spec:
      containers:
      - name: nginx
        image: &quot;openresty/openresty:centos&quot;
        ports:
        - name: http
          containerPort: 80
          protocol: TCP
        volumeMounts:
        - mountPath: /usr/local/openresty/nginx/conf/nginx.conf
          name: config
          subPath: nginx.conf
      - name: dnsmasq
        image: &quot;janeczku/go-dnsmasq:release-1.0.7&quot;
        args:
          - --listen
          - &quot;127.0.0.1:53&quot;
          - --default-resolver
          - --append-search-domains
          - --hostsfile=/etc/hosts
          - --verbose
      volumes:
      - name: config
        configMap:
          name: configmap-nginx

---

apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    component: nginx
  name: configmap-nginx
data:
  nginx.conf: |-
    worker_processes  1;

    error_log  /error.log;

    events {
        accept_mutex on;
        multi_accept on;
        use epoll;
        worker_connections  1024;
    }

    http {
        include       mime.types;
        default_type  application/octet-stream;
        log_format  main  '$time_local $remote_user $remote_addr $host $request_uri $request_method $http_cookie '
                          '$status $body_bytes_sent &quot;$http_referer&quot; '
                          '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; '
                          '$request_time $upstream_response_time &quot;$upstream_cache_status&quot;';

        log_format  browser '$time_iso8601 $cookie_km_uid $remote_addr $host $request_uri $request_method '
                          '$status $body_bytes_sent &quot;$http_referer&quot; '
                          '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; '
                          '$request_time $upstream_response_time &quot;$upstream_cache_status&quot; $http_x_requested_with $http_x_real_ip $upstream_addr $request_body';

        log_format client '{&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,'
                          '&quot;time_local&quot;:&quot;$time_local&quot;,'
                          '&quot;remote_user&quot;:&quot;$remote_user&quot;,'
                          '&quot;http_x_forwarded_for&quot;:&quot;$http_x_forwarded_for&quot;,'
                          '&quot;host&quot;:&quot;$server_addr&quot;,'
                          '&quot;remote_addr&quot;:&quot;$remote_addr&quot;,'
                          '&quot;http_x_real_ip&quot;:&quot;$http_x_real_ip&quot;,'
                          '&quot;body_bytes_sent&quot;:$body_bytes_sent,'
                          '&quot;request_time&quot;:$request_time,'
                          '&quot;status&quot;:$status,'
                          '&quot;upstream_response_time&quot;:&quot;$upstream_response_time&quot;,'
                          '&quot;upstream_response_status&quot;:&quot;$upstream_status&quot;,'
                          '&quot;request&quot;:&quot;$request&quot;,'
                          '&quot;http_referer&quot;:&quot;$http_referer&quot;,'
                          '&quot;http_user_agent&quot;:&quot;$http_user_agent&quot;}';

        access_log  /access.log  main;

        sendfile        on;

        keepalive_timeout 120s 100s;
        keepalive_requests 500;
        send_timeout 60000s;
        client_header_buffer_size 4k;
        proxy_ignore_client_abort on;
        proxy_buffers 16 32k;
        proxy_buffer_size 64k;

        proxy_busy_buffers_size 64k;

        proxy_send_timeout 60000;
        proxy_read_timeout 60000;
        proxy_connect_timeout 60000;
        proxy_cache_valid 200 304 2h;
        proxy_cache_valid 500 404 2s;
        proxy_cache_key $host$request_uri$cookie_user;
        proxy_cache_methods GET HEAD POST;

        proxy_redirect off;
        proxy_http_version 1.1;
        proxy_set_header Host                $http_host;
        proxy_set_header X-Real-IP           $remote_addr;
        proxy_set_header X-Forwarded-For     $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto   $scheme;
        proxy_set_header X-Frame-Options     SAMEORIGIN;

        server_tokens off;
        client_max_body_size 50G;
        add_header X-Cache $upstream_cache_status;
        autoindex off;

        resolver      127.0.0.1:53 ipv6=off;

        server {
            listen 80;

            location / {
                set $service  '';
                rewrite_by_lua '
                    local host = ngx.var.host
                    local m = ngx.re.match(host, &quot;(.+).test.foo.io&quot;)
                    if m then
                        ngx.var.service = &quot;my-svc-&quot; .. m[1]
                    end
                ';
                proxy_pass http://$service;
            }
        }
    }

</code></pre><p>ç”¨ Service çš„ç¤ºä¾‹ï¼ˆservice.yamlï¼‰ï¼š</p>
<pre tabindex="0"><code>apiVersion: v1
kind: Service
metadata:
  labels:
    component: nginx
  name: service-nginx
spec:
  type: LoadBalancer
  ports:
  - name: http
    port: 80
    targetPort: http
  selector:
    component: nginx

</code></pre><p>ç”¨ Ingress çš„ç¤ºä¾‹ï¼ˆingress.yamlï¼‰ï¼š</p>
<pre tabindex="0"><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-nginx
spec:
  rules:
  - host: &quot;*.test.foo.io&quot;
    http:
      paths:
      - backend:
          serviceName: service-nginx
          servicePort: 80
        path: /

</code></pre><h3 id="æœ‰çŠ¶æ€ä¸šåŠ¡å®¹å™¨éƒ¨ç½²ç­–ç•¥">æœ‰çŠ¶æ€ä¸šåŠ¡å®¹å™¨éƒ¨ç½²ç­–ç•¥</h3>
<p>StatefulSet æ—¨åœ¨ä¸æœ‰çŠ¶æ€çš„åº”ç”¨åŠåˆ†å¸ƒå¼ç³»ç»Ÿä¸€èµ·ä½¿ç”¨ã€‚ä¸ºäº†ç†è§£ StatefulSet çš„åŸºæœ¬ç‰¹æ€§ï¼Œæˆ‘ä»¬ä½¿ç”¨ StatefulSet éƒ¨ç½²ä¸€ä¸ªç®€å•çš„ Web åº”ç”¨ã€‚</p>
<p>åˆ›å»ºä¸€ä¸ª StatefulSet ç¤ºä¾‹ï¼ˆweb.yamlï¼‰ï¼š</p>
<pre tabindex="0"><code>apiVersion: v1
kind: Service
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  ports:
  - port: 80
    name: web
  clusterIP: None
  selector:
    app: nginx
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: web
spec:
  serviceName: &quot;nginx&quot;
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: gcr.azk8s.cn/google_containers/nginx-slim:0.8
        ports:
        - containerPort: 80
          name: web
        volumeMounts:
        - name: www
          mountPath: /usr/share/nginx/html
  volumeClaimTemplates:
  - metadata:
      name: www
    spec:
      accessModes: [ &quot;ReadWriteOnce&quot; ]
      resources:
        requests:
          storage: 1Gi

</code></pre><p>æ³¨æ„ StatefulSet å¯¹è±¡è¿è¡Œçš„ç‰¹ç‚¹ä¹‹ä¸€å°±æ˜¯ï¼ŒStatefulSet ä¸­çš„ Pod æ‹¥æœ‰ä¸€ä¸ªå”¯ä¸€çš„é¡ºåºç´¢å¼•å’Œç¨³å®šçš„ç½‘ç»œèº«ä»½æ ‡è¯†ã€‚è¿™ä¸ªè¾“å‡ºæœ€ç»ˆå°†çœ‹èµ·æ¥åƒå¦‚ä¸‹æ ·å­ï¼š</p>
<pre tabindex="0"><code>kubectl get pods -l app=nginx
NAME      READY     STATUS    RESTARTS   AGE
web-0     1/1       Running   0          1m
web-1     1/1       Running   0          1m

</code></pre><p>å¾ˆå¤šæ–‡æ¡£åœ¨æåŠ Statefulset å¯¹è±¡çš„æ¦‚å¿µæ—¶ï¼Œç”¨æˆ·å®¹æ˜“æœ›æ–‡ç”Ÿä¹‰ï¼Œå¸¸å¸¸æŠŠæŒ‚ç›˜çš„å®¹å™¨å®ä¾‹å½“æˆæœ‰çŠ¶æ€å®ä¾‹ã€‚è¿™æ˜¯ä¸å‡†ç¡®çš„è§£é‡Šã€‚åœ¨ Kubernetes çš„ä¸–ç•Œé‡Œï¼Œæœ‰ç¨³å®šçš„ç½‘ç»œèº«ä»½æ ‡è¯†çš„å®¹å™¨ç»„æ‰æ˜¯æœ‰çŠ¶æ€çš„åº”ç”¨ã€‚ä¾‹å¦‚ï¼š</p>
<pre tabindex="0"><code>for i in 0 1; do kubectl exec web-$i -- sh -c 'hostname'; done
web-0
web-1

</code></pre><p>å¦å¤–ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>kubectl run</code> è¿è¡Œä¸€ä¸ªæä¾› <code>nslookup</code> å‘½ä»¤çš„å®¹å™¨ã€‚é€šè¿‡å¯¹ Pod çš„ä¸»æœºåæ‰§è¡Œ <code>nslookup</code>ï¼Œä½ å¯ä»¥æ£€æŸ¥ä»–ä»¬åœ¨é›†ç¾¤å†…éƒ¨çš„ DNS åœ°å€ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>kubectl run -i --tty --image busybox:1.28 dns-test --restart=Never --rm   
nslookup web-0.nginx
Server:    10.0.0.10
Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local

Name:      web-0.nginx
Address 1: 10.244.1.6

nslookup web-1.nginx
Server:    10.0.0.10
Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local

Name:      web-1.nginx
Address 1: 10.244.2.6

</code></pre><h4 id="ç­–ç•¥äº”çµæ´»è¿ç”¨-statefulset-çš„-pod-ç®¡ç†ç­–ç•¥"><strong>ç­–ç•¥äº”ï¼šçµæ´»è¿ç”¨ StatefulSet çš„ Pod ç®¡ç†ç­–ç•¥</strong></h4>
<p>é€šå¸¸å¯¹äºå¸¸è§„åˆ†å¸ƒå¼å¾®æœåŠ¡ä¸šåŠ¡ç³»ç»Ÿæ¥è¯´ï¼ŒStatefulSet çš„é¡ºåºæ€§ä¿è¯æ˜¯ä¸å¿…è¦çš„ã€‚è¿™äº›ç³»ç»Ÿä»…ä»…è¦æ±‚å”¯ä¸€æ€§å’Œèº«ä»½æ ‡å¿—ã€‚ä¸ºäº†åŠ å¿«è¿™ä¸ªéƒ¨ç½²ç­–ç•¥ï¼Œæˆ‘ä»¬é€šè¿‡å¼•å…¥ .spec.podManagementPolicy è§£å†³ã€‚</p>
<p>Parallel pod ç®¡ç†ç­–ç•¥å‘Šè¯‰ StatefulSet æ§åˆ¶å™¨å¹¶è¡Œçš„ç»ˆæ­¢æ‰€æœ‰ Podï¼Œåœ¨å¯åŠ¨æˆ–ç»ˆæ­¢å¦ä¸€ä¸ª Pod å‰ï¼Œä¸å¿…ç­‰å¾…è¿™äº› Pod å˜æˆ Running å’Œ Ready æˆ–è€…å®Œå…¨ç»ˆæ­¢çŠ¶æ€ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>apiVersion: v1
kind: Service
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  ports:
  - port: 80
    name: web
  clusterIP: None
  selector:
    app: nginx
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: web
spec:
  serviceName: &quot;nginx&quot;
  podManagementPolicy: &quot;Parallel&quot;
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: gcr.azk8s.cn/google_containers/nginx-slim:0.8
        ports:
        - containerPort: 80
          name: web
        volumeMounts:
        - name: www
          mountPath: /usr/share/nginx/html
  volumeClaimTemplates:
  - metadata:
      name: www
    spec:
      accessModes: [ &quot;ReadWriteOnce&quot; ]
      resources:
        requests:
          storage: 1Gi

</code></pre><h3 id="ä¸šåŠ¡è¿ç»´ç±»å®¹å™¨éƒ¨ç½²ç­–ç•¥">ä¸šåŠ¡è¿ç»´ç±»å®¹å™¨éƒ¨ç½²ç­–ç•¥</h3>
<p>åœ¨æˆ‘ä»¬éƒ¨ç½² Kubernetes æ‰©å±• DNSã€Ingressã€Calico èƒ½åŠ›æ—¶éœ€è¦åœ¨æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹éƒ¨ç½²å®ˆæŠ¤è¿›ç¨‹çš„ç¨‹åºï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦é‡‡ç”¨ DaemonSet æ¥éƒ¨ç½²ç³»ç»Ÿä¸šåŠ¡å®¹å™¨ã€‚é»˜è®¤ DaemonSet é‡‡ç”¨æ»šåŠ¨æ›´æ–°ç­–ç•¥æ¥æ›´æ–°å®¹å™¨ï¼Œå¯ä»¥é€šè¿‡æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ç¡®è®¤ï¼š</p>
<pre tabindex="0"><code>kubectl get ds/&lt;daemonset-name&gt; -o go-template='{{.spec.updateStrategy.type}}{{&quot;\n&quot;}}'

RollingUpdate

</code></pre><p>åœ¨æ—¥å¸¸å·¥ä½œä¸­ï¼Œæˆ‘ä»¬å¯¹å®ˆæŠ¤è¿›ç¨‹åªéœ€è¦æ‰§è¡Œæ›´æ¢é•œåƒçš„æ“ä½œï¼š</p>
<pre tabindex="0"><code>kubectl set image ds/&lt;daemonset-name&gt; &lt;container-name&gt;=&lt;container-new-image&gt;

</code></pre><p>æŸ¥çœ‹æ»šåŠ¨æ›´æ–°çŠ¶æ€ç¡®è®¤å½“å‰è¿›åº¦ï¼š</p>
<pre tabindex="0"><code>kubectl rollout status ds/&lt;daemonset-name&gt;

</code></pre><p>å½“æ»šåŠ¨æ›´æ–°å®Œæˆæ—¶ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>daemonset &quot;&lt;daemonset-name&gt;&quot; successfully rolled out

</code></pre><p>æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€äº›å®šæœŸæ‰§è¡Œè„šæœ¬ä»»åŠ¡çš„éœ€æ±‚ï¼Œè¿™äº›éœ€æ±‚å¯ä»¥é€šè¿‡ Kubernetes æä¾›çš„ CronJob å¯¹è±¡æ¥ç®¡ç†ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: hello
spec:
  schedule: &quot;*/1 * * * *&quot;
  successfulJobsHistoryLimit: 0
  failedJobsHistoryLimit: 0
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: hello
            image: busybox
            args:
            - /bin/sh
            - -c
            - date; echo Hello from the Kubernetes cluster
          restartPolicy: OnFailure

</code></pre><h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>æœ¬æ–‡ä»å®é™…ä¸šåŠ¡éœ€æ±‚å‡ºå‘ï¼Œå¸¦ç€è¯»è€…ä¸€èµ·æ¢³ç†äº† Kubernetes çš„å·¥ä½œè´Ÿè½½å®šä¹‰çš„ç¨³å®šç‰ˆæœ¬çš„ç¼–æ’å¯¹è±¡ Deploymentã€StatefulSetã€DaemonSetã€CronJobã€‚æ‰€æœ‰æä¾›çš„èµ„æ–™éƒ½æ˜¯æ¥è‡ªè¡Œä¸šåˆ†äº«çš„å®è·µç»éªŒçš„æ€»ç»“ï¼Œå»æ‰äº†å¾ˆå¤šæ–‡æ¡£çš„ç¹çæˆ–è€…ä¸æ­£ç¡®çš„ä»‹ç»ï¼Œå¸®åŠ©è¯»è€…æ­£ç¡®å»ºç«‹åˆç†çš„ç¼–æ’å¯¹è±¡çš„ä½¿ç”¨ç­–ç•¥ã€‚å½“ç„¶ï¼Œé™¤äº†è¿™äº›æ ¸å¿ƒç¼–æ’å¯¹è±¡ä¹‹å¤–ï¼ŒKubernetes è¿˜æä¾›äº†æ‰©å±•æ¥å£ï¼Œæˆ‘ä»¬é€šè¿‡ Operator ç¼–ç¨‹æ¡†æ¶å°±å¯ä»¥è‡ªå®šä¹‰éœ€è¦çš„ç¼–æ’å¯¹è±¡ï¼ŒæŠŠè‡ªå·±çš„è¿ç»´ç»éªŒç”¨ä»£ç è§„èŒƒèµ·æ¥ï¼Œè®©ä½ çš„æŒç»­å‘å¸ƒçš„æµç¨‹æ›´åŠ æ–¹ä¾¿å¿«æ·ã€‚</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/01-%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86-kubernetes-%E7%9A%84%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6/"><span>01 é‡æ–°è®¤è¯† Kubernetes çš„æ ¸å¿ƒç»„ä»¶</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/kubernetes/kubernetes%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/03-devops-%E5%9C%BA%E6%99%AF%E4%B8%8B%E8%90%BD%E5%9C%B0-k8s-%E7%9A%84%E5%9B%B0%E9%9A%BE%E5%88%86%E6%9E%90/"><span>03 DevOps åœºæ™¯ä¸‹è½åœ° K8s çš„å›°éš¾åˆ†æ</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 27270 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>