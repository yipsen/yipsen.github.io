<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>14 ä¸¾ä¸€åä¸‰ï¼šNetty é«˜æ€§èƒ½å†…å­˜ç®¡ç†è®¾è®¡ï¼ˆä¸‹ï¼‰ | Yipsen Ye</title>
<meta name="description" content="åœ¨ä¸Šä¸€èŠ‚è¯¾ï¼Œæˆ‘ä»¬å­¦ä¹ äº† Netty çš„å†…å­˜è§„æ ¼åˆ†ç±»ä»¥åŠå†…å­˜ç®¡ç†çš„æ ¸å¿ƒç»„ä»¶ï¼Œä»Šå¤©è¿™èŠ‚è¯¾æˆ‘ä»¬ç»§ç»­ä»‹ç» Netty å†…å­˜åˆ†é…ä¸å›æ”¶çš„å®ç°åŸç†ã€‚æœ‰äº†ä¸ŠèŠ‚è¯¾çš„åŸºç¡€ï¼Œç›¸ä¿¡æ¥ä¸‹æ¥çš„å­¦ä¹ è¿‡ç¨‹ä¼šäº‹åŠåŠŸå€ã€‚
æœ¬èŠ‚è¯¾ä¼šä¾§é‡äºè¯¦ç»†åˆ†æä¸åŒåœºæ™¯ä¸‹ Netty å†…å­˜åˆ†é…å’Œå›æ”¶çš„å®ç°è¿‡ç¨‹ï¼Œè®©ä½ å¯¹ Netty å†…å­˜æ± çš„æ•´ä½“è®¾è®¡æœ‰ä¸€ä¸ªæ›´åŠ æ¸…æ™°çš„è®¤è¯†ã€‚
å†…å­˜åˆ†é…å®ç°åŸç† Netty ä¸­è´Ÿè´£çº¿ç¨‹åˆ†é…çš„ç»„ä»¶æœ‰ä¸¤ä¸ªï¼šPoolArenaå’ŒPoolThreadCacheã€‚PoolArena æ˜¯å¤šä¸ªçº¿ç¨‹å…±äº«çš„ï¼Œæ¯ä¸ªçº¿ç¨‹ä¼šå›ºå®šç»‘å®šä¸€ä¸ª PoolArenaï¼ŒPoolThreadCache æ˜¯æ¯ä¸ªçº¿ç¨‹ç§æœ‰çš„ç¼“å­˜ç©ºé—´ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚
åœ¨ä¸ŠèŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† PoolChunkã€PoolSubpageã€PoolChunkListï¼Œå®ƒä»¬éƒ½æ˜¯ PoolArena ä¸­æ‰€ç”¨åˆ°çš„æ¦‚å¿µã€‚PoolArena ä¸­ç®¡ç†çš„å†…å­˜å•ä½ä¸º PoolChunkï¼Œæ¯ä¸ª PoolChunk ä¼šè¢«åˆ’åˆ†ä¸º 2048 ä¸ª 8K çš„ Pageã€‚åœ¨ç”³è¯·çš„å†…å­˜å¤§äº 8K æ—¶ï¼ŒPoolChunk ä¼šä»¥ Page ä¸ºå•ä½è¿›è¡Œå†…å­˜åˆ†é…ã€‚å½“ç”³è¯·çš„å†…å­˜å¤§å°å°äº 8K æ—¶ï¼Œä¼šç”± PoolSubpage ç®¡ç†æ›´å°ç²’åº¦çš„å†…å­˜åˆ†é…ã€‚
PoolArena åˆ†é…çš„å†…å­˜è¢«é‡Šæ”¾åï¼Œä¸ä¼šç«‹å³ä¼šè¿˜ç»™ PoolChunkï¼Œè€Œä¸”ä¼šç¼“å­˜åœ¨æœ¬åœ°ç§æœ‰ç¼“å­˜ PoolThreadCache ä¸­ï¼Œåœ¨ä¸‹ä¸€æ¬¡è¿›è¡Œå†…å­˜åˆ†é…æ—¶ï¼Œä¼šä¼˜å…ˆä» PoolThreadCache ä¸­æŸ¥æ‰¾åŒ¹é…çš„å†…å­˜å—ã€‚
ç”±æ­¤å¯è§ï¼ŒNetty ä¸­ä¸åŒçš„å†…å­˜è§„æ ¼é‡‡ç”¨çš„åˆ†é…ç­–ç•¥æ˜¯ä¸åŒçš„ï¼Œæˆ‘ä»¬ä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªåœºæ™¯é€ä¸€è¿›è¡Œåˆ†æã€‚
 åˆ†é…å†…å­˜å¤§äº 8K æ—¶ï¼ŒPoolChunk ä¸­é‡‡ç”¨çš„ Page çº§åˆ«çš„å†…å­˜åˆ†é…ç­–ç•¥ã€‚ åˆ†é…å†…å­˜å°äº 8K æ—¶ï¼Œç”± PoolSubpage è´Ÿè´£ç®¡ç†çš„å†…å­˜åˆ†é…ç­–ç•¥ã€‚ åˆ†é…å†…å­˜å°äº 8K æ—¶ï¼Œä¸ºäº†æé«˜å†…å­˜åˆ†é…æ•ˆç‡ï¼Œç”± PoolThreadCache æœ¬åœ°çº¿ç¨‹ç¼“å­˜æä¾›çš„å†…å­˜åˆ†é…ã€‚  PoolChunk ä¸­ Page çº§åˆ«çš„å†…å­˜åˆ†é… æ¯ä¸ª PoolChunk é»˜è®¤å¤§å°ä¸º 16Mï¼ŒPoolChunk æ˜¯é€šè¿‡ä¼™ä¼´ç®—æ³•ç®¡ç†å¤šä¸ª Pageï¼Œæ¯ä¸ª PoolChunk è¢«åˆ’åˆ†ä¸º 2048 ä¸ª Pageï¼Œæœ€ç»ˆé€šè¿‡ä¸€é¢—æ»¡äºŒå‰æ ‘å®ç°ï¼Œæˆ‘ä»¬å†ä¸€èµ·å›é¡¾ä¸‹ PoolChunk çš„äºŒå‰æ ‘ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/netty%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e5%89%96%e6%9e%90%e4%b8%8erpc%e5%ae%9e%e8%b7%b5/">Nettyæ ¸å¿ƒåŸç†å‰–æä¸RPCå®è·µ</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/00-%E5%AD%A6%E5%A5%BD-netty%E6%98%AF%E4%BD%A0%E4%BF%AE%E7%82%BC-java-%E5%86%85%E5%8A%9F%E7%9A%84%E5%BF%85%E7%BB%8F%E4%B9%8B%E8%B7%AF/">00 å­¦å¥½ Nettyï¼Œæ˜¯ä½ ä¿®ç‚¼ Java å†…åŠŸçš„å¿…ç»ä¹‹è·¯</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/01-%E5%88%9D%E8%AF%86-netty%E4%B8%BA%E4%BB%80%E4%B9%88-netty-%E8%BF%99%E4%B9%88%E6%B5%81%E8%A1%8C/">01 åˆè¯† Nettyï¼šä¸ºä»€ä¹ˆ Netty è¿™ä¹ˆæµè¡Œï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/02-%E7%BA%B5%E8%A7%88%E5%85%A8%E5%B1%80%E6%8A%8A%E6%8F%A1-netty-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E8%84%89%E7%BB%9C/">02 çºµè§ˆå…¨å±€ï¼šæŠŠæ¡ Netty æ•´ä½“æ¶æ„è„‰ç»œ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/03-%E5%BC%95%E5%AF%BC%E5%99%A8%E4%BD%9C%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E9%83%BD%E8%A6%81%E5%81%9A%E4%BA%9B%E4%BB%80%E4%B9%88/">03 å¼•å¯¼å™¨ä½œç”¨ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¯åŠ¨éƒ½è¦åšäº›ä»€ä¹ˆï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/04-%E4%BA%8B%E4%BB%B6%E8%B0%83%E5%BA%A6%E5%B1%82%E4%B8%BA%E4%BB%80%E4%B9%88-eventloop-%E6%98%AF-netty-%E7%9A%84%E7%B2%BE%E9%AB%93/">04 äº‹ä»¶è°ƒåº¦å±‚ï¼šä¸ºä»€ä¹ˆ EventLoop æ˜¯ Netty çš„ç²¾é«“ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/05-%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92%E5%B1%82pipeline-%E5%A6%82%E4%BD%95%E5%8D%8F%E8%B0%83%E5%90%84%E7%B1%BB-handler-/">05 æœåŠ¡ç¼–æ’å±‚ï¼šPipeline å¦‚ä½•åè°ƒå„ç±» Handler ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/06-%E7%B2%98%E5%8C%85%E6%8B%86%E5%8C%85%E9%97%AE%E9%A2%98%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%95%B4%E7%9A%84%E7%BD%91%E7%BB%9C%E5%8C%85/">06 ç²˜åŒ…æ‹†åŒ…é—®é¢˜ï¼šå¦‚ä½•è·å–ä¸€ä¸ªå®Œæ•´çš„ç½‘ç»œåŒ…ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/07-%E6%8E%A5%E5%A4%B4%E6%9A%97%E8%AF%AD%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8-netty-%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E9%80%9A%E4%BF%A1/">07 æ¥å¤´æš—è¯­ï¼šå¦‚ä½•åˆ©ç”¨ Netty å®ç°è‡ªå®šä¹‰åè®®é€šä¿¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/08-%E5%BC%80%E7%AE%B1%E5%8D%B3%E7%94%A8netty-%E6%94%AF%E6%8C%81%E5%93%AA%E4%BA%9B%E5%B8%B8%E7%94%A8%E7%9A%84%E8%A7%A3%E7%A0%81%E5%99%A8/">08 å¼€ç®±å³ç”¨ï¼šNetty æ”¯æŒå“ªäº›å¸¸ç”¨çš„è§£ç å™¨ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/09-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93writeandflush-%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E5%89%96%E6%9E%90/">09 æ•°æ®ä¼ è¾“ï¼šwriteAndFlush å¤„ç†æµç¨‹å‰–æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/10-%E5%8F%8C%E5%88%83%E5%89%91%E5%90%88%E7%90%86%E7%AE%A1%E7%90%86-netty-%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98/">10 åŒåˆƒå‰‘ï¼šåˆç†ç®¡ç† Netty å †å¤–å†…å­˜</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/11-%E5%8F%A6%E8%B5%B7%E7%82%89%E7%81%B6netty-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E8%BD%BD%E4%BD%93-bytebuf-%E8%AF%A6%E8%A7%A3/">11 å¦èµ·ç‚‰ç¶ï¼šNetty æ•°æ®ä¼ è¾“è½½ä½“ ByteBuf è¯¦è§£</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/12-%E4%BB%96%E5%B1%B1%E4%B9%8B%E7%9F%B3%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%99%A8-jemalloc-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/">12 ä»–å±±ä¹‹çŸ³ï¼šé«˜æ€§èƒ½å†…å­˜åˆ†é…å™¨ jemalloc åŸºæœ¬åŸç†</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/13-%E4%B8%BE%E4%B8%80%E5%8F%8D%E4%B8%89netty-%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E8%AE%BE%E8%AE%A1%E4%B8%8A/">13 ä¸¾ä¸€åä¸‰ï¼šNetty é«˜æ€§èƒ½å†…å­˜ç®¡ç†è®¾è®¡ï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li>14 ä¸¾ä¸€åä¸‰ï¼šNetty é«˜æ€§èƒ½å†…å­˜ç®¡ç†è®¾è®¡ï¼ˆä¸‹ï¼‰</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/15-%E8%BD%BB%E9%87%8F%E7%BA%A7%E5%AF%B9%E8%B1%A1%E5%9B%9E%E6%94%B6%E7%AB%99recycler-%E5%AF%B9%E8%B1%A1%E6%B1%A0%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90/">15 è½»é‡çº§å¯¹è±¡å›æ”¶ç«™ï¼šRecycler å¯¹è±¡æ± æŠ€æœ¯è§£æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/16-io-%E5%8A%A0%E9%80%9F%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%E7%9A%84-netty-%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF/">16 IO åŠ é€Ÿï¼šä¸ä¼—ä¸åŒçš„ Netty é›¶æ‹·è´æŠ€æœ¯</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/17-%E6%BA%90%E7%A0%81%E7%AF%87%E4%BB%8E-linux-%E5%87%BA%E5%8F%91%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">17 æºç ç¯‡ï¼šä» Linux å‡ºå‘æ·±å…¥å‰–ææœåŠ¡ç«¯å¯åŠ¨æµç¨‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/18-%E6%BA%90%E7%A0%81%E7%AF%87%E8%A7%A3%E5%AF%86-netty-reactor-%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/">18 æºç ç¯‡ï¼šè§£å¯† Netty Reactor çº¿ç¨‹æ¨¡å‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/19-%E6%BA%90%E7%A0%81%E7%AF%87%E4%B8%80%E4%B8%AA%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E5%9C%A8-netty-%E4%B8%AD%E7%9A%84%E6%97%85%E7%A8%8B/">19 æºç ç¯‡ï¼šä¸€ä¸ªç½‘ç»œè¯·æ±‚åœ¨ Netty ä¸­çš„æ—…ç¨‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/20-%E6%8A%80%E5%B7%A7%E7%AF%87netty-%E7%9A%84-fastthreadlocal-%E7%A9%B6%E7%AB%9F%E6%AF%94-threadlocal-%E5%BF%AB%E5%9C%A8%E5%93%AA%E5%84%BF/">20 æŠ€å·§ç¯‡ï¼šNetty çš„ FastThreadLocal ç©¶ç«Ÿæ¯” ThreadLocal å¿«åœ¨å“ªå„¿ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/21-%E6%8A%80%E5%B7%A7%E7%AF%87%E5%BB%B6%E8%BF%9F%E4%BB%BB%E5%8A%A1%E5%A4%84%E7%90%86%E7%A5%9E%E5%99%A8%E4%B9%8B%E6%97%B6%E9%97%B4%E8%BD%AE-hashedwheeltimer/">21 æŠ€å·§ç¯‡ï¼šå»¶è¿Ÿä»»åŠ¡å¤„ç†ç¥å™¨ä¹‹æ—¶é—´è½® HashedWheelTimer</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/22-%E6%8A%80%E5%B7%A7%E7%AF%87%E9%AB%98%E6%80%A7%E8%83%BD%E6%97%A0%E9%94%81%E9%98%9F%E5%88%97-mpsc-queue/">22 æŠ€å·§ç¯‡ï¼šé«˜æ€§èƒ½æ— é”é˜Ÿåˆ— Mpsc Queue</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/23-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E9%AB%98%E6%80%A7%E8%83%BD%E5%88%86%E5%B8%83%E5%BC%8F-rpc-%E6%A1%86%E6%9E%B6/">23 æ¶æ„è®¾è®¡ï¼šå¦‚ä½•å®ç°ä¸€ä¸ªé«˜æ€§èƒ½åˆ†å¸ƒå¼ RPC æ¡†æ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/24-%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E4%B8%8E%E8%AE%A2%E9%98%85%E6%90%AD%E5%BB%BA%E7%94%9F%E4%BA%A7%E8%80%85%E5%92%8C%E6%B6%88%E8%B4%B9%E8%80%85%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A1%86%E6%9E%B6/">24 æœåŠ¡å‘å¸ƒä¸è®¢é˜…ï¼šæ­å»ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åŸºç¡€æ¡†æ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/25-%E8%BF%9C%E7%A8%8B%E9%80%9A%E4%BF%A1%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE%E8%AE%BE%E8%AE%A1%E4%BB%A5%E5%8F%8A%E7%BC%96%E8%A7%A3%E7%A0%81%E7%9A%84%E5%AE%9E%E7%8E%B0/">25 è¿œç¨‹é€šä¿¡ï¼šé€šä¿¡åè®®è®¾è®¡ä»¥åŠç¼–è§£ç çš„å®ç°</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/26-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%9C%BA%E5%88%B6%E7%9A%84%E5%AE%9E%E7%8E%B0/">26 æœåŠ¡æ²»ç†ï¼šæœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡æœºåˆ¶çš„å®ç°</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/27-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%BA%E7%94%A8%E6%88%B7%E5%B1%8F%E8%94%BD-rpc-%E8%B0%83%E7%94%A8%E7%9A%84%E5%BA%95%E5%B1%82%E7%BB%86%E8%8A%82/">27 åŠ¨æ€ä»£ç†ï¼šä¸ºç”¨æˆ·å±è”½ RPC è°ƒç”¨çš„åº•å±‚ç»†èŠ‚</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/28-%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93rpc-%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93%E4%B8%8E%E8%BF%9B%E9%98%B6%E5%BB%B6%E4%BC%B8/">28 å®æˆ˜æ€»ç»“ï¼šRPC å®æˆ˜æ€»ç»“ä¸è¿›é˜¶å»¶ä¼¸</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/29-%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3netty-%E4%B8%AD%E5%BA%94%E7%94%A8%E4%BA%86%E5%93%AA%E4%BA%9B%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">29 ç¼–ç¨‹æ€æƒ³ï¼šNetty ä¸­åº”ç”¨äº†å“ªäº›è®¾è®¡æ¨¡å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/30-%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93netty-%E5%9C%A8%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">30 å®è·µæ€»ç»“ï¼šNetty åœ¨é¡¹ç›®å¼€å‘ä¸­çš„ä¸€äº›æœ€ä½³å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/31-%E7%BB%93%E6%9D%9F%E8%AF%AD-%E6%8A%80%E6%9C%AF%E6%88%90%E9%95%BF%E4%B9%8B%E8%B7%AF%E5%A6%82%E4%BD%95%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB/">31 ç»“æŸè¯­ æŠ€æœ¯æˆé•¿ä¹‹è·¯ï¼šå¦‚ä½•æ‰“é€ è‡ªå·±çš„æŠ€æœ¯ä½“ç³»</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">14 ä¸¾ä¸€åä¸‰ï¼šNetty é«˜æ€§èƒ½å†…å­˜ç®¡ç†è®¾è®¡ï¼ˆä¸‹ï¼‰</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2021-12-22 01:54:35</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/netty/">netty</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/">Nettyæ ¸å¿ƒåŸç†å‰–æä¸RPCå®è·µ</a>
                
            </div></div>
        <div class="post-content">
            <p>åœ¨ä¸Šä¸€èŠ‚è¯¾ï¼Œæˆ‘ä»¬å­¦ä¹ äº† Netty çš„å†…å­˜è§„æ ¼åˆ†ç±»ä»¥åŠå†…å­˜ç®¡ç†çš„æ ¸å¿ƒç»„ä»¶ï¼Œä»Šå¤©è¿™èŠ‚è¯¾æˆ‘ä»¬ç»§ç»­ä»‹ç» Netty å†…å­˜åˆ†é…ä¸å›æ”¶çš„å®ç°åŸç†ã€‚æœ‰äº†ä¸ŠèŠ‚è¯¾çš„åŸºç¡€ï¼Œç›¸ä¿¡æ¥ä¸‹æ¥çš„å­¦ä¹ è¿‡ç¨‹ä¼šäº‹åŠåŠŸå€ã€‚</p>
<p>æœ¬èŠ‚è¯¾ä¼šä¾§é‡äºè¯¦ç»†åˆ†æä¸åŒåœºæ™¯ä¸‹ Netty å†…å­˜åˆ†é…å’Œå›æ”¶çš„å®ç°è¿‡ç¨‹ï¼Œè®©ä½ å¯¹ Netty å†…å­˜æ± çš„æ•´ä½“è®¾è®¡æœ‰ä¸€ä¸ªæ›´åŠ æ¸…æ™°çš„è®¤è¯†ã€‚</p>
<h3 id="å†…å­˜åˆ†é…å®ç°åŸç†">å†…å­˜åˆ†é…å®ç°åŸç†</h3>
<p>Netty ä¸­è´Ÿè´£çº¿ç¨‹åˆ†é…çš„ç»„ä»¶æœ‰ä¸¤ä¸ªï¼š<strong>PoolArena</strong>å’Œ<strong>PoolThreadCache</strong>ã€‚PoolArena æ˜¯å¤šä¸ªçº¿ç¨‹å…±äº«çš„ï¼Œæ¯ä¸ªçº¿ç¨‹ä¼šå›ºå®šç»‘å®šä¸€ä¸ª PoolArenaï¼ŒPoolThreadCache æ˜¯æ¯ä¸ªçº¿ç¨‹ç§æœ‰çš„ç¼“å­˜ç©ºé—´ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F_HVVWANQ2JAASi2VFvKEg368.png" alt="Drawing 0.png"></p>
<p>åœ¨ä¸ŠèŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† PoolChunkã€PoolSubpageã€PoolChunkListï¼Œå®ƒä»¬éƒ½æ˜¯ PoolArena ä¸­æ‰€ç”¨åˆ°çš„æ¦‚å¿µã€‚PoolArena ä¸­ç®¡ç†çš„å†…å­˜å•ä½ä¸º PoolChunkï¼Œæ¯ä¸ª PoolChunk ä¼šè¢«åˆ’åˆ†ä¸º 2048 ä¸ª 8K çš„ Pageã€‚åœ¨ç”³è¯·çš„å†…å­˜å¤§äº 8K æ—¶ï¼ŒPoolChunk ä¼šä»¥ Page ä¸ºå•ä½è¿›è¡Œå†…å­˜åˆ†é…ã€‚å½“ç”³è¯·çš„å†…å­˜å¤§å°å°äº 8K æ—¶ï¼Œä¼šç”± PoolSubpage ç®¡ç†æ›´å°ç²’åº¦çš„å†…å­˜åˆ†é…ã€‚</p>
<p>PoolArena åˆ†é…çš„å†…å­˜è¢«é‡Šæ”¾åï¼Œä¸ä¼šç«‹å³ä¼šè¿˜ç»™ PoolChunkï¼Œè€Œä¸”ä¼šç¼“å­˜åœ¨æœ¬åœ°ç§æœ‰ç¼“å­˜ PoolThreadCache ä¸­ï¼Œåœ¨ä¸‹ä¸€æ¬¡è¿›è¡Œå†…å­˜åˆ†é…æ—¶ï¼Œä¼šä¼˜å…ˆä» PoolThreadCache ä¸­æŸ¥æ‰¾åŒ¹é…çš„å†…å­˜å—ã€‚</p>
<p>ç”±æ­¤å¯è§ï¼ŒNetty ä¸­ä¸åŒçš„å†…å­˜è§„æ ¼é‡‡ç”¨çš„åˆ†é…ç­–ç•¥æ˜¯ä¸åŒçš„ï¼Œæˆ‘ä»¬ä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªåœºæ™¯é€ä¸€è¿›è¡Œåˆ†æã€‚</p>
<ul>
<li>åˆ†é…å†…å­˜å¤§äº 8K æ—¶ï¼ŒPoolChunk ä¸­é‡‡ç”¨çš„ Page çº§åˆ«çš„å†…å­˜åˆ†é…ç­–ç•¥ã€‚</li>
<li>åˆ†é…å†…å­˜å°äº 8K æ—¶ï¼Œç”± PoolSubpage è´Ÿè´£ç®¡ç†çš„å†…å­˜åˆ†é…ç­–ç•¥ã€‚</li>
<li>åˆ†é…å†…å­˜å°äº 8K æ—¶ï¼Œä¸ºäº†æé«˜å†…å­˜åˆ†é…æ•ˆç‡ï¼Œç”± PoolThreadCache æœ¬åœ°çº¿ç¨‹ç¼“å­˜æä¾›çš„å†…å­˜åˆ†é…ã€‚</li>
</ul>
<h4 id="poolchunk-ä¸­-page-çº§åˆ«çš„å†…å­˜åˆ†é…">PoolChunk ä¸­ Page çº§åˆ«çš„å†…å­˜åˆ†é…</h4>
<p>æ¯ä¸ª PoolChunk é»˜è®¤å¤§å°ä¸º 16Mï¼ŒPoolChunk æ˜¯é€šè¿‡ä¼™ä¼´ç®—æ³•ç®¡ç†å¤šä¸ª Pageï¼Œæ¯ä¸ª PoolChunk è¢«åˆ’åˆ†ä¸º 2048 ä¸ª Pageï¼Œæœ€ç»ˆé€šè¿‡ä¸€é¢—æ»¡äºŒå‰æ ‘å®ç°ï¼Œæˆ‘ä»¬å†ä¸€èµ·å›é¡¾ä¸‹ PoolChunk çš„äºŒå‰æ ‘ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F_HVV2AAm7jAAkM7nU1E0A130.png" alt="Drawing 1.png"></p>
<p>å‡å¦‚ç”¨æˆ·éœ€è¦ä¾æ¬¡ç”³è¯· 8Kã€16Kã€8K çš„å†…å­˜ï¼Œé€šè¿‡è¿™é‡Œä¾‹å­æˆ‘ä»¬è¯¦ç»†æè¿°ä¸‹ PoolChunk å¦‚ä½•åˆ†é… Page çº§åˆ«çš„å†…å­˜ï¼Œæ–¹ä¾¿å¤§å®¶ç†è§£ä¼™ä¼´ç®—æ³•çš„åŸç†ã€‚</p>
<p>é¦–å…ˆçœ‹ä¸‹åˆ†é…é€»è¾‘ allocateRun çš„æºç ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚PoolChunk åˆ†é… Page ä¸»è¦åˆ†ä¸ºä¸‰æ­¥ï¼šé¦–å…ˆæ ¹æ®åˆ†é…å†…å­˜å¤§å°è®¡ç®—äºŒå‰æ ‘æ‰€åœ¨èŠ‚ç‚¹çš„é«˜åº¦ï¼Œç„¶åæŸ¥æ‰¾å¯¹åº”é«˜åº¦ä¸­æ˜¯å¦å­˜åœ¨å¯ç”¨èŠ‚ç‚¹ï¼Œå¦‚æœåˆ†é…æˆåŠŸåˆ™å‡å»å·²åˆ†é…çš„å†…å­˜å¤§å°å¾—åˆ°å‰©ä½™å¯ç”¨ç©ºé—´ã€‚</p>
<pre tabindex="0"><code>private long allocateRun(int normCapacity) {

    // æ ¹æ®åˆ†é…å†…å­˜å¤§å°è®¡ç®—äºŒå‰æ ‘å¯¹åº”çš„èŠ‚ç‚¹é«˜åº¦

    int d = maxOrder - (log2(normCapacity) - pageShifts);

    // æŸ¥æ‰¾å¯¹åº”é«˜åº¦ä¸­æ˜¯å¦å­˜åœ¨å¯ç”¨èŠ‚ç‚¹

    int id = allocateNode(d);

    if (id &lt; 0) {

        return id;

    }

    // å‡å»å·²åˆ†é…çš„å†…å­˜å¤§å°

    freeBytes -= runLength(id);

    return id;

}
</code></pre><p>ç»“åˆ PoolChunk çš„äºŒå‰æ ‘ç»“æ„ä»¥åŠ allocateRun æºç æˆ‘ä»¬å¼€å§‹åˆ†ææ¨¡æ‹Ÿçš„ç¤ºä¾‹ï¼š</p>
<p>ç¬¬ä¸€æ¬¡åˆ†é… 8K å¤§å°çš„å†…å­˜æ—¶ï¼Œé€šè¿‡ d = maxOrder - (log2(normCapacity) - pageShifts) è®¡ç®—å¾—åˆ°äºŒå‰æ ‘æ‰€åœ¨èŠ‚ç‚¹é«˜åº¦ä¸º 11ï¼Œå…¶ä¸­ maxOrder ä¸ºäºŒå‰æ ‘çš„æœ€å¤§é«˜åº¦ï¼ŒnormCapacity ä¸º 8Kï¼ŒpageShifts é»˜è®¤å€¼ä¸º 13ï¼Œå› ä¸ºåªæœ‰å½“ç”³è¯·å†…å­˜å¤§å°å¤§äº 2^13 = 8K æ—¶æ‰ä¼šä½¿ç”¨ allocateRun åˆ†é…å†…å­˜ã€‚ç„¶åä»ç¬¬ 11 å±‚æŸ¥æ‰¾å¯ç”¨çš„ Pageï¼Œä¸‹æ ‡ä¸º 2048 çš„èŠ‚ç‚¹å¯ä»¥è¢«ç”¨äºåˆ†é…å†…å­˜ï¼Œå³ Page[0] è¢«åˆ†é…ä½¿ç”¨ï¼Œæ­¤æ—¶èµ‹å€¼ memoryMap[2048] = 12ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹å·²ç»ä¸å¯ç”¨ï¼Œç„¶åé€’å½’æ›´æ–°çˆ¶èŠ‚ç‚¹çš„å€¼ï¼Œçˆ¶èŠ‚ç‚¹çš„å€¼å–ä¸¤ä¸ªå­èŠ‚ç‚¹çš„æœ€å°å€¼ï¼ŒmemoryMap[1024] = 11ï¼ŒmemoryMap[512] = 10ï¼Œä»¥æ­¤ç±»æ¨ç›´è‡³ memoryMap[1] = 1ï¼Œæ›´æ–°åçš„äºŒå‰æ ‘åˆ†é…ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F_HcU2AUwUeAAS29sFoCrk381.png" alt="å›¾ç‰‡3.png"></p>
<p>ç¬¬äºŒæ¬¡åˆ†é… 16K å¤§å°å†…å­˜æ—¶ï¼Œè®¡ç®—å¾—åˆ°æ‰€éœ€èŠ‚ç‚¹çš„é«˜åº¦ä¸º 10ã€‚æ­¤æ—¶ 1024 èŠ‚ç‚¹å·²ç»åˆ†é…äº†ä¸€ä¸ª 8K å†…å­˜ï¼Œä¸å†æ»¡è¶³æ¡ä»¶ï¼Œç»§ç»­å¯»æ‰¾åˆ° 1025 èŠ‚ç‚¹ã€‚1025 èŠ‚ç‚¹å¹¶æœªä½¿ç”¨è¿‡ï¼Œæ»¡è¶³åˆ†é…æ¡ä»¶ï¼Œäºæ˜¯å°† 1025 èŠ‚ç‚¹çš„ä¸¤ä¸ªå­èŠ‚ç‚¹ 2050 å’Œ 2051 å…¨éƒ¨åˆ†é…å‡ºå»ï¼Œå¹¶èµ‹å€¼ memoryMap[2050] = 12ï¼ŒmemoryMap[2051] = 12ï¼Œå†æ¬¡é€’å½’æ›´æ–°çˆ¶èŠ‚ç‚¹çš„å€¼ï¼Œæ›´æ–°åçš„äºŒå‰æ ‘åˆ†é…ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/CgqCHl_HcVyANkl0AASIJd7RNAc086.png" alt="å›¾ç‰‡4.png"></p>
<p>ç¬¬ä¸‰æ¬¡å†æ¬¡åˆ†é… 8K å¤§å°çš„å†…å­˜æ—¶ï¼Œä¾ç„¶ä»äºŒå‰æ ‘ç¬¬ 11 å±‚å¼€å§‹æŸ¥æ‰¾ï¼Œ2048 å·²ç»è¢«ä½¿ç”¨ï¼Œ2049 å¯ä»¥è¢«åˆ†é…ï¼Œèµ‹å€¼ memoryMap[2049] = 12ï¼Œå¹¶é€’å½’æ›´æ–°çˆ¶èŠ‚ç‚¹å€¼ï¼ŒmemoryMap[1024] = 12ï¼ŒmemoryMap[512] = 12ï¼Œä»¥æ­¤ç±»æ¨ç›´è‡³ memoryMap[1] = 1ï¼Œæœ€ç»ˆçš„äºŒå‰æ ‘åˆ†é…ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/CgqCHl_HcWWAZpDsAASgCUhZxLw922.png" alt="å›¾ç‰‡5.png"></p>
<p>è‡³æ­¤ï¼ŒPoolChunk ä¸­ Page çº§åˆ«çš„å†…å­˜åˆ†é…å·²ç»ä»‹ç»å®Œäº†ï¼Œå¯ä»¥çœ‹å‡ºä¼™ä¼´ç®—æ³•å°½å¯èƒ½ä¿è¯äº†åˆ†é…å†…å­˜åœ°å€çš„è¿ç»­æ€§ï¼Œæœ‰æ•ˆåœ°é™ä½äº†å†…å­˜ç¢ç‰‡ã€‚</p>
<h4 id="subpage-çº§åˆ«çš„å†…å­˜åˆ†é…">Subpage çº§åˆ«çš„å†…å­˜åˆ†é…</h4>
<p>ä¸ºäº†æé«˜å†…å­˜åˆ†é…çš„åˆ©ç”¨ç‡ï¼Œåœ¨åˆ†é…å°äº 8K çš„å†…å­˜æ—¶ï¼ŒPoolChunk ä¸åœ¨åˆ†é…å•ç‹¬çš„ Pageï¼Œè€Œæ˜¯å°† Page åˆ’åˆ†ä¸ºæ›´å°çš„å†…å­˜å—ï¼Œç”± PoolSubpage è¿›è¡Œç®¡ç†ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬çœ‹ä¸‹ PoolSubpage çš„åˆ›å»ºè¿‡ç¨‹ï¼Œç”±äºåˆ†é…çš„å†…å­˜å°äº 8Kï¼Œæ‰€ä»¥èµ°åˆ°äº† allocateSubpage æºç ä¸­ï¼š</p>
<pre tabindex="0"><code>private long allocateSubpage(int normCapacity) {

    // æ ¹æ®å†…å­˜å¤§å°æ‰¾åˆ° PoolArena ä¸­ subpage æ•°ç»„å¯¹åº”çš„å¤´ç»“ç‚¹

    PoolSubpage&lt;T&gt; head = arena.findSubpagePoolHead(normCapacity);

    int d = maxOrder; // å› ä¸ºåˆ†é…å†…å­˜å°äº 8Kï¼Œæ‰€ä»¥ä»æ»¡äºŒå‰æ ‘æœ€åº•å±‚å¼€å§‹æŸ¥æ‰¾

    synchronized (head) {

        int id = allocateNode(d); // åœ¨æ»¡äºŒå‰æ ‘ä¸­æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„èŠ‚ç‚¹

        if (id &lt; 0) {

            return id;

        }

        final PoolSubpage&lt;T&gt;[] subpages = this.subpages; // è®°å½•å“ªäº› Page è¢«è½¬åŒ–ä¸º Subpage

        final int pageSize = this.pageSize; 

        freeBytes -= pageSize;

        int subpageIdx = subpageIdx(id); // pageId åˆ° subpageId çš„è½¬åŒ–ï¼Œä¾‹å¦‚ pageId=2048 å¯¹åº”çš„ subpageId=0

        PoolSubpage&lt;T&gt; subpage = subpages[subpageIdx];

        if (subpage == null) {

            // åˆ›å»º PoolSubpageï¼Œå¹¶åˆ‡åˆ†ä¸ºç›¸åŒå¤§å°çš„å­å†…å­˜å—ï¼Œç„¶ååŠ å…¥ PoolArena å¯¹åº”çš„åŒå‘é“¾è¡¨ä¸­

            subpage = new PoolSubpage&lt;T&gt;(head, this, id, runOffset(id), pageSize, normCapacity);

            subpages[subpageIdx] = subpage;

        } else {

            subpage.init(head, normCapacity);

        }

        return subpage.allocate(); // æ‰§è¡Œå†…å­˜åˆ†é…å¹¶è¿”å›å†…å­˜åœ°å€

    }

}
</code></pre><p>å‡å¦‚æˆ‘ä»¬éœ€è¦åˆ†é… 20B å¤§å°çš„å†…å­˜ï¼Œä¸€èµ·åˆ†æä¸‹ä¸Šè¿°æºç çš„æ‰§è¡Œè¿‡ç¨‹ï¼š</p>
<ol>
<li>å› ä¸º 20B å°äº 512Bï¼Œå±äº Tiny åœºæ™¯ï¼ŒæŒ‰ç…§å†…å­˜è§„æ ¼çš„åˆ†ç±» 20B éœ€è¦å‘ä¸Šå–æ•´åˆ° 32Bã€‚</li>
<li>æ ¹æ®å†…å­˜è§„æ ¼çš„å¤§å°æ‰¾åˆ° PoolArena ä¸­ tinySubpagePools æ•°ç»„å¯¹åº”çš„å¤´ç»“ç‚¹ï¼Œ32B å¯¹åº”çš„ tinySubpagePools[1]ã€‚</li>
<li>åœ¨æ»¡äºŒå‰æ ‘ä¸­å¯»æ‰¾å¯ç”¨çš„èŠ‚ç‚¹ç”¨äºå†…å­˜åˆ†é…ï¼Œå› ä¸ºæˆ‘ä»¬åˆ†é…çš„å†…å­˜å°äº 8Kï¼Œæ‰€ä»¥ç›´æ¥ä»äºŒå‰æ ‘çš„æœ€åº•å±‚å¼€å§‹æŸ¥æ‰¾ã€‚å‡å¦‚ 2049 èŠ‚ç‚¹æ˜¯å¯ç”¨çš„ï¼Œé‚£ä¹ˆè¿”å›çš„ id = 2049ã€‚</li>
<li>æ‰¾åˆ°å¯ç”¨èŠ‚ç‚¹åï¼Œå› ä¸º pageIdx æ˜¯ä»å¶å­èŠ‚ç‚¹ 2048 å¼€å§‹è®°å½•ç´¢å¼•ï¼Œè€Œ subpageIdx éœ€è¦ä» 0 å¼€å§‹çš„ï¼Œæ‰€ä»¥éœ€è¦å°† pageIdx è½¬åŒ–ä¸º subpageIdxï¼Œä¾‹å¦‚ 2048 å¯¹åº”çš„ subpageIdx = 0ï¼Œ2049 å¯¹åº”çš„ subpageIdx = 1ï¼Œä»¥æ­¤ç±»æ¨ã€‚</li>
<li>å¦‚æœ PoolChunk ä¸­ subpages æ•°ç»„çš„ subpageIdx ä¸‹æ ‡å¯¹åº”çš„ PoolSubpage ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå°†åˆ›å»ºä¸€ä¸ªæ–°çš„ PoolSubpageï¼Œå¹¶å°† PoolSubpage åˆ‡åˆ†ä¸ºç›¸åŒå¤§å°çš„å­å†…å­˜å—ï¼Œç¤ºä¾‹å¯¹åº”çš„å­å†…å­˜å—å¤§å°ä¸º 32Bï¼Œæœ€åå°†æ–°åˆ›å»ºçš„ PoolSubpage èŠ‚ç‚¹ä¸ tinySubpagePools[1] å¯¹åº”çš„ head èŠ‚ç‚¹è¿æ¥æˆåŒå‘é“¾è¡¨ã€‚</li>
<li>æœ€å PoolSubpage æ‰§è¡Œå†…å­˜åˆ†é…å¹¶è¿”å›å†…å­˜åœ°å€ã€‚</li>
</ol>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è·Ÿè¿›ä¸€ä¸‹ subpage.allocate() æºç ï¼Œçœ‹ä¸‹ PoolSubpage æ˜¯å¦‚ä½•æ‰§è¡Œå†…å­˜åˆ†é…çš„ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>long allocate() {

    if (elemSize == 0) {

        return toHandle(0);

    }

    if (numAvail == 0 || !doNotDestroy) {

        return -1;

    }

    final int bitmapIdx = getNextAvail(); // åœ¨ bitmap ä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªç´¢å¼•æ®µï¼Œç„¶åå°†è¯¥ bit ç½®ä¸º 1

    int q = bitmapIdx &gt;&gt;&gt; 6; // å®šä½åˆ° bitmap çš„æ•°ç»„ä¸‹æ ‡

    int r = bitmapIdx &amp; 63; // å–åˆ°èŠ‚ç‚¹å¯¹åº”ä¸€ä¸ª long ç±»å‹ä¸­çš„äºŒè¿›åˆ¶ä½

    assert (bitmap[q] &gt;&gt;&gt; r &amp; 1) == 0;

    bitmap[q] |= 1L &lt;&lt; r;

    if (-- numAvail == 0) {

        removeFromPool(); // å¦‚æœ PoolSubpage æ²¡æœ‰å¯åˆ†é…çš„å†…å­˜å—ï¼Œä» PoolArena åŒå‘é“¾è¡¨ä¸­åˆ é™¤

    }

    return toHandle(bitmapIdx);

}
</code></pre><p>PoolSubpage é€šè¿‡ä½å›¾ bitmap è®°å½•æ¯ä¸ªå†…å­˜å—æ˜¯å¦å·²ç»è¢«ä½¿ç”¨ã€‚åœ¨ä¸Šè¿°çš„ç¤ºä¾‹ä¸­ï¼Œ8K/32B = 256ï¼Œå› ä¸ºæ¯ä¸ª long æœ‰ 64 ä½ï¼Œæ‰€ä»¥éœ€è¦ 256/64 = 4 ä¸ª long ç±»å‹çš„å³å¯æè¿°å…¨éƒ¨çš„å†…å­˜å—åˆ†é…çŠ¶æ€ï¼Œå› æ­¤ bitmap æ•°ç»„çš„é•¿åº¦ä¸º 4ï¼Œä» bitmap[0] å¼€å§‹è®°å½•ï¼Œæ¯åˆ†é…ä¸€ä¸ªå†…å­˜å—ï¼Œå°±ä¼šç§»åŠ¨åˆ° bitmap[0] ä¸­çš„ä¸‹ä¸€ä¸ªäºŒè¿›åˆ¶ä½ï¼Œç›´è‡³ bitmap[0] çš„æ‰€æœ‰äºŒè¿›åˆ¶ä½éƒ½èµ‹å€¼ä¸º 1ï¼Œç„¶åç»§ç»­åˆ†é… bitmap[1]ï¼Œä»¥æ­¤ç±»æ¨ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ 2049 èŠ‚ç‚¹è¿›è¡Œå†…å­˜åˆ†é…æ—¶ï¼Œbitmap[0] ä¸­çš„äºŒè¿›åˆ¶ä½å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F_HVYCALlpoAAIr-7_6X50667.png" alt="Drawing 5.png"></p>
<p>å½“ bitmap åˆ†æˆæˆåŠŸåï¼ŒPoolSubpage ä¼šå°†å¯ç”¨èŠ‚ç‚¹çš„ä¸ªæ•° numAvail å‡ 1ï¼Œå½“ numAvail é™ä¸º 0 æ—¶ï¼Œè¡¨ç¤º PoolSubpage å·²ç»æ²¡æœ‰å¯åˆ†é…çš„å†…å­˜å—ï¼Œæ­¤æ—¶éœ€è¦ä» PoolArena ä¸­ tinySubpagePools[1] çš„åŒå‘é“¾è¡¨ä¸­åˆ é™¤ã€‚</p>
<p>è‡³æ­¤ï¼Œæ•´ä¸ª PoolChunk ä¸­ Subpage çš„å†…å­˜åˆ†é…è¿‡ç¨‹å·²ç»å®Œæˆäº†ï¼Œå¯è§ PoolChunk çš„ä¼™ä¼´ç®—æ³•å‡ ä¹è´¯ç©¿äº†æ•´ä¸ªæµç¨‹ï¼Œä½å›¾ bitmap çš„è®¾è®¡ä¹Ÿæ˜¯éå¸¸å·§å¦™çš„ï¼Œä¸ä»…èŠ‚çœäº†å†…å­˜ç©ºé—´ï¼Œè€Œä¸”åŠ å¿«äº†å®šä½å†…å­˜å—çš„é€Ÿåº¦ã€‚</p>
<h4 id="poolthreadcache-çš„å†…å­˜åˆ†é…">PoolThreadCache çš„å†…å­˜åˆ†é…</h4>
<p>ä¸ŠèŠ‚è¯¾å·²ç»ä»‹ç»äº† PoolThreadCache çš„åŸºæœ¬æ¦‚å¿µï¼Œæˆ‘ä»¬çŸ¥é“ PoolArena åˆ†é…çš„å†…å­˜è¢«é‡Šæ”¾æ—¶ï¼ŒNetty å¹¶æ²¡æœ‰å°†ç¼“å­˜å½’è¿˜ç»™ PoolChunkï¼Œè€Œæ˜¯ä½¿ç”¨ PoolThreadCache ç¼“å­˜èµ·æ¥ï¼Œå½“ä¸‹æ¬¡æœ‰åŒæ ·è§„æ ¼çš„å†…å­˜åˆ†é…æ—¶ï¼Œç›´æ¥ä» PoolThreadCache å–å‡ºä½¿ç”¨å³å¯ã€‚æ‰€ä»¥ä¸‹é¢æˆ‘ä»¬ä» PoolArena#allocate() çš„æºç ä¸­çœ‹ä¸‹ PoolThreadCache æ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚</p>
<pre tabindex="0"><code>private void allocate(PoolThreadCache cache, PooledByteBuf&lt;T&gt; buf, final int reqCapacity) {

    final int normCapacity = normalizeCapacity(reqCapacity);

    if (isTinyOrSmall(normCapacity)) { // capacity &lt; pageSize

        int tableIdx;

        PoolSubpage&lt;T&gt;[] table;

        boolean tiny = isTiny(normCapacity);

        if (tiny) { // &lt; 512

            if (cache.allocateTiny(this, buf, reqCapacity, normCapacity)) {

                return;

            }

            tableIdx = tinyIdx(normCapacity);

            table = tinySubpagePools;

        } else {

            if (cache.allocateSmall(this, buf, reqCapacity, normCapacity)) {

                return;

            }

            tableIdx = smallIdx(normCapacity);

            table = smallSubpagePools;

        }
        // çœç•¥å…¶ä»–ä»£ç 

    }

    if (normCapacity &lt;= chunkSize) {

        if (cache.allocateNormal(this, buf, reqCapacity, normCapacity)) {

            return;

        }

        synchronized (this) {

            allocateNormal(buf, reqCapacity, normCapacity);

            ++allocationsNormal;

        }

    } else {

        allocateHuge(buf, reqCapacity);

    }

}
</code></pre><p>ä»æºç ä¸­å¯ä»¥çœ‹å‡ºåœ¨åˆ†é… Tinyã€Small å’Œ Normal ç±»å‹çš„å†…å­˜æ—¶ï¼Œéƒ½ä¼šå°è¯•å…ˆä» PoolThreadCache ä¸­è¿›è¡Œåˆ†é…ï¼Œæºç ç»“æ„æ¯”è¾ƒæ¸…æ™°ï¼Œæˆ‘ä»¬æ•´ä½“æ¢³ç†ä¸€éæµç¨‹ï¼š</p>
<ol>
<li>å¯¹ç”³è¯·çš„å†…å­˜å¤§å°åšå‘ä¸Šå–æ•´ï¼Œä¾‹å¦‚ 20B çš„å†…å­˜å¤§å°ä¼šå–æ•´ä¸º 32Bã€‚</li>
<li>å½“ç”³è¯·çš„å†…å­˜å¤§å°å°äº 8K æ—¶ï¼Œåˆ†ä¸º Tiny å’Œ Small ä¸¤ç§æƒ…å†µï¼Œåˆ†åˆ«éƒ½ä¼šä¼˜å…ˆå°è¯•ä» PoolThreadCache åˆ†é…å†…å­˜ï¼Œå¦‚æœ PoolThreadCache åˆ†é…å¤±è´¥ï¼Œæ‰ä¼šèµ° PoolArena çš„åˆ†é…æµç¨‹ã€‚</li>
<li>å½“ç”³è¯·çš„å†…å­˜å¤§å°å¤§äº 8Kï¼Œä½†æ˜¯å°äº Chunk çš„é»˜è®¤å¤§å° 16Mï¼Œå±äº Normal çš„å†…å­˜åˆ†é…ï¼Œä¹Ÿä¼šä¼˜å…ˆå°è¯•ä» PoolThreadCache åˆ†é…å†…å­˜ï¼Œå¦‚æœ PoolThreadCache åˆ†é…å¤±è´¥ï¼Œæ‰ä¼šèµ° PoolArena çš„åˆ†é…æµç¨‹ã€‚</li>
<li>å½“ç”³è¯·çš„å†…å­˜å¤§å°å¤§äº Chunk çš„ 16Mï¼Œåˆ™ä¸ä¼šç»è¿‡ PoolThreadCacheï¼Œç›´æ¥è¿›è¡Œåˆ†é…ã€‚</li>
</ol>
<p>PoolThreadCache å…·ä½“åˆ†é…å†…å­˜çš„è¿‡ç¨‹ä½¿ç”¨åˆ°äº†ä¸€ä¸ªé‡è¦çš„æ•°æ®ç»“æ„ MemoryRegionCacheï¼Œå…³äº MemoryRegionCache çš„æ¦‚å¿µä½ å¯ä»¥å›é¡¾ä¸‹ä¸ŠèŠ‚è¯¾çš„å†…å®¹ï¼Œåœ¨è¿™é‡Œæˆ‘å°±ä¸å†èµ˜è¿°äº†ã€‚å‡å¦‚æˆ‘ä»¬ç°åœ¨éœ€è¦åˆ†é… 32B å¤§å°çš„å †å¤–å†…å­˜ï¼Œä¼šä» MemoryRegionCache æ•°ç»„ tinySubPageDirectCaches[1] ä¸­å–å‡ºå¯¹åº”çš„ MemoryRegionCache èŠ‚ç‚¹ï¼Œå°è¯•ä» MemoryRegionCache çš„é˜Ÿåˆ—ä¸­å–å‡ºå¯ç”¨çš„å†…å­˜å—ã€‚</p>
<h3 id="å†…å­˜å›æ”¶å®ç°åŸç†">å†…å­˜å›æ”¶å®ç°åŸç†</h3>
<p>é€šè¿‡ä¹‹å‰çš„ä»‹ç»æˆ‘ä»¬çŸ¥é“ï¼Œå½“ç”¨æˆ·çº¿ç¨‹é‡Šæ”¾å†…å­˜æ—¶ä¼šå°†å†…å­˜å—ç¼“å­˜åˆ°æœ¬åœ°çº¿ç¨‹çš„ç§æœ‰ç¼“å­˜ PoolThreadCache ä¸­ï¼Œè¿™æ ·åœ¨ä¸‹æ¬¡åˆ†é…å†…å­˜æ—¶ä¼šæé«˜åˆ†é…æ•ˆç‡ï¼Œä½†æ˜¯å½“å†…å­˜å—è¢«ç”¨å®Œä¸€æ¬¡åï¼Œå†æ²¡æœ‰åˆ†é…éœ€æ±‚ï¼Œé‚£ä¹ˆä¸€ç›´é©»ç•™åœ¨å†…å­˜ä¸­åˆä¼šé€ æˆæµªè´¹ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±çœ‹ä¸‹ Netty æ˜¯å¦‚ä½•å®ç°å†…å­˜é‡Šæ”¾çš„å‘¢ï¼Ÿç›´æ¥è·Ÿè¿›ä¸‹ PoolThreadCache çš„æºç ã€‚</p>
<pre tabindex="0"><code>private boolean allocate(MemoryRegionCache&lt;?&gt; cache, PooledByteBuf buf, int reqCapacity) {

    if (cache == null) {

        return false;

    }

    // é»˜è®¤æ¯æ‰§è¡Œ 8192 æ¬¡ allocate()ï¼Œå°±ä¼šè°ƒç”¨ä¸€æ¬¡ trim() è¿›è¡Œå†…å­˜æ•´ç†

    boolean allocated = cache.allocate(buf, reqCapacity);

    if (++ allocations &gt;= freeSweepAllocationThreshold) {

        allocations = 0;

        trim();

    }

    return allocated;

}

void trim() {

    trim(tinySubPageDirectCaches);

    trim(smallSubPageDirectCaches);

    trim(normalDirectCaches);

    trim(tinySubPageHeapCaches);

    trim(smallSubPageHeapCaches);

    trim(normalHeapCaches);

}
</code></pre><p>ä»æºç ä¸­å¯ä»¥çœ‹å‡ºï¼ŒNetty è®°å½•äº† allocate() çš„æ‰§è¡Œæ¬¡æ•°ï¼Œé»˜è®¤æ¯æ‰§è¡Œ 8192 æ¬¡ï¼Œå°±ä¼šè§¦å‘ PoolThreadCache è°ƒç”¨ä¸€æ¬¡ trim() è¿›è¡Œå†…å­˜æ•´ç†ï¼Œä¼šå¯¹ PoolThreadCache ä¸­ç»´æŠ¤çš„å…­ä¸ª MemoryRegionCache æ•°ç»„åˆ†åˆ«è¿›è¡Œæ•´ç†ã€‚æˆ‘ä»¬ç»§ç»­è·Ÿè¿› trim çš„æºç ï¼Œå®šä½åˆ°æ ¸å¿ƒé€»è¾‘ã€‚</p>
<pre tabindex="0"><code>public final void trim() {

    int free = size - allocations;

    allocations = 0;

    // We not even allocated all the number that are

    if (free &gt; 0) {

        free(free, false);

    }

}

private int free(int max, boolean finalizer) {

    int numFreed = 0;

    for (; numFreed &lt; max; numFreed++) {

        Entry&lt;T&gt; entry = queue.poll();

        if (entry != null) {

            freeEntry(entry, finalizer);

        } else {

            // all cleared

            return numFreed;

        }

    }

    return numFreed;

}
</code></pre><p>é€šè¿‡ size - allocations è¡¡é‡å†…å­˜åˆ†é…æ‰§è¡Œçš„é¢‘ç¹ç¨‹åº¦ï¼Œå…¶ä¸­ size ä¸ºè¯¥ MemoryRegionCache å¯¹åº”çš„å†…å­˜è§„æ ¼å¤§å°ï¼Œsize ä¸ºå›ºå®šå€¼ï¼Œä¾‹å¦‚ Tiny ç±»å‹é»˜è®¤ä¸º 512ã€‚allocations è¡¨ç¤º MemoryRegionCache è·ç¦»ä¸Šä¸€æ¬¡å†…å­˜æ•´ç†å·²ç»å‘ç”Ÿäº†å¤šå°‘æ¬¡ allocate è°ƒç”¨ï¼Œå½“è°ƒç”¨æ¬¡æ•°å°äº size æ—¶ï¼Œè¡¨ç¤º MemoryRegionCache ä¸­ç¼“å­˜çš„å†…å­˜å—å¹¶ä¸å¸¸ç”¨ï¼Œä»é˜Ÿåˆ—ä¸­å–å‡ºå†…å­˜å—ä¾æ¬¡é‡Šæ”¾ã€‚</p>
<p>æ­¤å¤– Netty åœ¨çº¿ç¨‹é€€å‡ºçš„æ—¶å€™è¿˜ä¼šå›æ”¶è¯¥çº¿ç¨‹çš„æ‰€æœ‰å†…å­˜ï¼ŒPoolThreadCache é‡è½½äº† finalize() æ–¹æ³•ï¼Œåœ¨é”€æ¯å‰æ‰§è¡Œç¼“å­˜å›æ”¶çš„é€»è¾‘ï¼Œå¯¹åº”æºç å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>@Override

protected void finalize() throws Throwable {

    try {

        super.finalize();

    } finally {

        free(true);

    }

}

void free(boolean finalizer) {

    if (freed.compareAndSet(false, true)) {

        int numFreed = free(tinySubPageDirectCaches, finalizer) +

                free(smallSubPageDirectCaches, finalizer) +

                free(normalDirectCaches, finalizer) +

                free(tinySubPageHeapCaches, finalizer) +

                free(smallSubPageHeapCaches, finalizer) +

                free(normalHeapCaches, finalizer);

        if (numFreed &gt; 0 &amp;&amp; logger.isDebugEnabled()) {

            logger.debug(&quot;Freed {} thread-local buffer(s) from thread: {}&quot;, numFreed,

                    Thread.currentThread().getName());

        }

        if (directArena != null) {

            directArena.numThreadCaches.getAndDecrement();

        }

        if (heapArena != null) {

            heapArena.numThreadCaches.getAndDecrement();

        }

    }

}
</code></pre><p>çº¿ç¨‹é”€æ¯æ—¶ PoolThreadCache ä¼šä¾æ¬¡é‡Šæ”¾æ‰€æœ‰ MemoryRegionCache ä¸­çš„å†…å­˜æ•°æ®ï¼Œå…¶ä¸­ free æ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘ä¸ä¹‹å‰å†…å­˜æ•´ç† trim ä¸­é‡Šæ”¾å†…å­˜çš„è¿‡ç¨‹æ˜¯ä¸€è‡´çš„ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡Œç¿»é˜…æºç ã€‚</p>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæ•´ä¸ª Netty å†…å­˜æ± çš„åˆ†é…å’Œé‡Šæ”¾åŸç†æˆ‘ä»¬å·²ç»åˆ†æå®Œäº†ï¼Œå…¶ä¸­å·§å¦™çš„è®¾è®¡æ€è·¯ä»¥åŠæºç ç»†èŠ‚çš„å®ç°ï¼Œéƒ½æ˜¯éå¸¸å€¼å¾—æˆ‘ä»¬å­¦ä¹ çš„å®è´µèµ„æºã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>æœ€åï¼Œæˆ‘ä»¬å¯¹ Netty å†…å­˜æ± çš„è®¾è®¡æ€æƒ³åšä¸€ä¸ªçŸ¥è¯†ç‚¹æ€»ç»“ï¼š</p>
<ul>
<li>åˆ†å››ç§å†…å­˜è§„æ ¼ç®¡ç†å†…å­˜ï¼Œåˆ†åˆ«ä¸º Tinyã€Samllã€Normalã€Hugeï¼ŒPoolChunk è´Ÿè´£ç®¡ç† 8K ä»¥ä¸Šçš„å†…å­˜åˆ†é…ï¼ŒPoolSubpage ç”¨äºç®¡ç† 8K ä»¥ä¸‹çš„å†…å­˜åˆ†é…ã€‚å½“ç”³è¯·å†…å­˜å¤§äº 16M æ—¶ï¼Œä¸ä¼šç»è¿‡å†…å­˜æ± ï¼Œç›´æ¥åˆ†é…ã€‚</li>
<li>è®¾è®¡äº†æœ¬åœ°çº¿ç¨‹ç¼“å­˜æœºåˆ¶ PoolThreadCacheï¼Œç”¨äºæå‡å†…å­˜åˆ†é…æ—¶çš„å¹¶å‘æ€§èƒ½ã€‚ç”¨äºç”³è¯· Tinyã€Samllã€Normal ä¸‰ç§ç±»å‹çš„å†…å­˜æ—¶ï¼Œä¼šä¼˜å…ˆå°è¯•ä» PoolThreadCache ä¸­åˆ†é…ã€‚</li>
<li>PoolChunk ä½¿ç”¨ä¼™ä¼´ç®—æ³•ç®¡ç† Pageï¼Œä»¥äºŒå‰æ ‘çš„æ•°æ®ç»“æ„å®ç°ï¼Œæ˜¯æ•´ä¸ªå†…å­˜æ± åˆ†é…çš„æ ¸å¿ƒæ‰€åœ¨ã€‚</li>
<li>æ¯è°ƒç”¨ PoolThreadCache çš„ allocate() æ–¹æ³•åˆ°ä¸€å®šæ¬¡æ•°ï¼Œä¼šè§¦å‘æ£€æŸ¥ PoolThreadCache ä¸­ç¼“å­˜çš„ä½¿ç”¨é¢‘ç‡ï¼Œä½¿ç”¨é¢‘ç‡è¾ƒä½çš„å†…å­˜å—ä¼šè¢«é‡Šæ”¾ã€‚</li>
<li>çº¿ç¨‹é€€å‡ºæ—¶ï¼ŒNetty ä¼šå›æ”¶è¯¥çº¿ç¨‹å¯¹åº”çš„æ‰€æœ‰å†…å­˜ã€‚</li>
</ul>
<p>Netty ä¸­å¼•å…¥ç±»ä¼¼ jemalloc çš„å†…å­˜æ± ç®¡ç†æŠ€æœ¯å¯ä»¥è¯´æ˜¯ä¸€å¤§çªç ´ï¼Œå°† Netty çš„æ€§èƒ½åˆæå‡äº†ä¸€ä¸ªå°é˜¶ï¼Œè€Œè¿™ç§æ€æƒ³ä¸ä»…å¯ä»¥ç”¨äº Nettyï¼Œåœ¨å¾ˆå¯¹ç¼“å­˜çš„åœºæ™¯ä¸‹éƒ½å¯ä»¥å€Ÿé‰´å­¦ä¹ ï¼Œå¸Œæœ›è¿™äº›ä¼˜ç§€çš„è®¾è®¡æ€æƒ³èƒ½å¤Ÿå¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œåœ¨å®é™…å·¥ä½œä¸­å­¦ä»¥è‡´ç”¨ã€‚</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/13-%E4%B8%BE%E4%B8%80%E5%8F%8D%E4%B8%89netty-%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E8%AE%BE%E8%AE%A1%E4%B8%8A/"><span>13 ä¸¾ä¸€åä¸‰ï¼šNetty é«˜æ€§èƒ½å†…å­˜ç®¡ç†è®¾è®¡ï¼ˆä¸Šï¼‰</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/15-%E8%BD%BB%E9%87%8F%E7%BA%A7%E5%AF%B9%E8%B1%A1%E5%9B%9E%E6%94%B6%E7%AB%99recycler-%E5%AF%B9%E8%B1%A1%E6%B1%A0%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90/"><span>15 è½»é‡çº§å¯¹è±¡å›æ”¶ç«™ï¼šRecycler å¯¹è±¡æ± æŠ€æœ¯è§£æ</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 27270 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>