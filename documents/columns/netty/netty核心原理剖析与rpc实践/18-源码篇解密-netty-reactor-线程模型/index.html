<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>18 æºç ç¯‡ï¼šè§£å¯† Netty Reactor çº¿ç¨‹æ¨¡å‹ | Yipsen Ye</title>
<meta name="description" content="é€šè¿‡ç¬¬ä¸€ç«  Netty åŸºç¡€è¯¾ç¨‹çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“ Reactor çº¿ç¨‹æ¨¡å‹æ˜¯ Netty å®ç°é«˜æ€§èƒ½çš„æ ¸å¿ƒæ‰€åœ¨ï¼Œåœ¨ Netty ä¸­ EventLoop æ˜¯ Reactor çº¿ç¨‹æ¨¡å‹çš„æ ¸å¿ƒå¤„ç†å¼•æ“ï¼Œé‚£ä¹ˆ EventLoop åˆ°åº•æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿåˆæ˜¯å¦‚ä½•ä¿è¯é«˜æ€§èƒ½å’Œçº¿ç¨‹å®‰å…¨æ€§çš„å‘¢ï¼Ÿä»Šå¤©è¿™èŠ‚è¯¾è®©æˆ‘ä»¬ä¸€èµ·ä¸€æ¢ç©¶ç«Ÿã€‚
 è¯´æ˜ï¼šæœ¬æ–‡å‚è€ƒçš„ Netty æºç ç‰ˆæœ¬ä¸º 4.1.42.Finalã€‚
 Reactor çº¿ç¨‹æ‰§è¡Œçš„ä¸»æµç¨‹ åœ¨ã€Šäº‹ä»¶è°ƒåº¦å±‚ï¼šä¸ºä»€ä¹ˆ EventLoop æ˜¯ Netty çš„ç²¾é«“ã€‹çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† EventLoop çš„æ¦‚è²Œï¼Œå› ä¸º Netty æ˜¯åŸºäº NIO å®ç°çš„ï¼Œæ‰€ä»¥æ¨èä½¿ç”¨ NioEventLoop å®ç°ï¼Œæˆ‘ä»¬å†æ¬¡é€šè¿‡ NioEventLoop çš„æ ¸å¿ƒå…¥å£ run() æ–¹æ³•å›é¡¾ Netty Reactor çº¿ç¨‹æ¨¡å‹æ‰§è¡Œçš„ä¸»æµç¨‹ï¼Œå¹¶ä»¥æ­¤ä¸ºåŸºç¡€ç»§ç»­æ·±å…¥ç ”ç©¶ NioEventLoop çš„é€»è¾‘ç»†èŠ‚ã€‚
protected void run() {for (;;) {try {try {switch (selectStrategy.calculateStrategy(selectNowSupplier, hasTasks())) {case SelectStrategy.CONTINUE:continue;case SelectStrategy.BUSY_WAIT:case SelectStrategy.SELECT:select(wakenUp.getAndSet(false)); // è½®è¯¢ I/O äº‹ä»¶if (wakenUp.">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/netty%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e5%89%96%e6%9e%90%e4%b8%8erpc%e5%ae%9e%e8%b7%b5/">Nettyæ ¸å¿ƒåŸç†å‰–æä¸RPCå®è·µ</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/00-%E5%AD%A6%E5%A5%BD-netty%E6%98%AF%E4%BD%A0%E4%BF%AE%E7%82%BC-java-%E5%86%85%E5%8A%9F%E7%9A%84%E5%BF%85%E7%BB%8F%E4%B9%8B%E8%B7%AF/">00 å­¦å¥½ Nettyï¼Œæ˜¯ä½ ä¿®ç‚¼ Java å†…åŠŸçš„å¿…ç»ä¹‹è·¯</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/01-%E5%88%9D%E8%AF%86-netty%E4%B8%BA%E4%BB%80%E4%B9%88-netty-%E8%BF%99%E4%B9%88%E6%B5%81%E8%A1%8C/">01 åˆè¯† Nettyï¼šä¸ºä»€ä¹ˆ Netty è¿™ä¹ˆæµè¡Œï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/02-%E7%BA%B5%E8%A7%88%E5%85%A8%E5%B1%80%E6%8A%8A%E6%8F%A1-netty-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E8%84%89%E7%BB%9C/">02 çºµè§ˆå…¨å±€ï¼šæŠŠæ¡ Netty æ•´ä½“æ¶æ„è„‰ç»œ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/03-%E5%BC%95%E5%AF%BC%E5%99%A8%E4%BD%9C%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E9%83%BD%E8%A6%81%E5%81%9A%E4%BA%9B%E4%BB%80%E4%B9%88/">03 å¼•å¯¼å™¨ä½œç”¨ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¯åŠ¨éƒ½è¦åšäº›ä»€ä¹ˆï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/04-%E4%BA%8B%E4%BB%B6%E8%B0%83%E5%BA%A6%E5%B1%82%E4%B8%BA%E4%BB%80%E4%B9%88-eventloop-%E6%98%AF-netty-%E7%9A%84%E7%B2%BE%E9%AB%93/">04 äº‹ä»¶è°ƒåº¦å±‚ï¼šä¸ºä»€ä¹ˆ EventLoop æ˜¯ Netty çš„ç²¾é«“ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/05-%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92%E5%B1%82pipeline-%E5%A6%82%E4%BD%95%E5%8D%8F%E8%B0%83%E5%90%84%E7%B1%BB-handler-/">05 æœåŠ¡ç¼–æ’å±‚ï¼šPipeline å¦‚ä½•åè°ƒå„ç±» Handler ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/06-%E7%B2%98%E5%8C%85%E6%8B%86%E5%8C%85%E9%97%AE%E9%A2%98%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%95%B4%E7%9A%84%E7%BD%91%E7%BB%9C%E5%8C%85/">06 ç²˜åŒ…æ‹†åŒ…é—®é¢˜ï¼šå¦‚ä½•è·å–ä¸€ä¸ªå®Œæ•´çš„ç½‘ç»œåŒ…ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/07-%E6%8E%A5%E5%A4%B4%E6%9A%97%E8%AF%AD%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8-netty-%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E9%80%9A%E4%BF%A1/">07 æ¥å¤´æš—è¯­ï¼šå¦‚ä½•åˆ©ç”¨ Netty å®ç°è‡ªå®šä¹‰åè®®é€šä¿¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/08-%E5%BC%80%E7%AE%B1%E5%8D%B3%E7%94%A8netty-%E6%94%AF%E6%8C%81%E5%93%AA%E4%BA%9B%E5%B8%B8%E7%94%A8%E7%9A%84%E8%A7%A3%E7%A0%81%E5%99%A8/">08 å¼€ç®±å³ç”¨ï¼šNetty æ”¯æŒå“ªäº›å¸¸ç”¨çš„è§£ç å™¨ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/09-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93writeandflush-%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E5%89%96%E6%9E%90/">09 æ•°æ®ä¼ è¾“ï¼šwriteAndFlush å¤„ç†æµç¨‹å‰–æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/10-%E5%8F%8C%E5%88%83%E5%89%91%E5%90%88%E7%90%86%E7%AE%A1%E7%90%86-netty-%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98/">10 åŒåˆƒå‰‘ï¼šåˆç†ç®¡ç† Netty å †å¤–å†…å­˜</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/11-%E5%8F%A6%E8%B5%B7%E7%82%89%E7%81%B6netty-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E8%BD%BD%E4%BD%93-bytebuf-%E8%AF%A6%E8%A7%A3/">11 å¦èµ·ç‚‰ç¶ï¼šNetty æ•°æ®ä¼ è¾“è½½ä½“ ByteBuf è¯¦è§£</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/12-%E4%BB%96%E5%B1%B1%E4%B9%8B%E7%9F%B3%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%99%A8-jemalloc-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/">12 ä»–å±±ä¹‹çŸ³ï¼šé«˜æ€§èƒ½å†…å­˜åˆ†é…å™¨ jemalloc åŸºæœ¬åŸç†</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/13-%E4%B8%BE%E4%B8%80%E5%8F%8D%E4%B8%89netty-%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E8%AE%BE%E8%AE%A1%E4%B8%8A/">13 ä¸¾ä¸€åä¸‰ï¼šNetty é«˜æ€§èƒ½å†…å­˜ç®¡ç†è®¾è®¡ï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/14-%E4%B8%BE%E4%B8%80%E5%8F%8D%E4%B8%89netty-%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E8%AE%BE%E8%AE%A1%E4%B8%8B/">14 ä¸¾ä¸€åä¸‰ï¼šNetty é«˜æ€§èƒ½å†…å­˜ç®¡ç†è®¾è®¡ï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/15-%E8%BD%BB%E9%87%8F%E7%BA%A7%E5%AF%B9%E8%B1%A1%E5%9B%9E%E6%94%B6%E7%AB%99recycler-%E5%AF%B9%E8%B1%A1%E6%B1%A0%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90/">15 è½»é‡çº§å¯¹è±¡å›æ”¶ç«™ï¼šRecycler å¯¹è±¡æ± æŠ€æœ¯è§£æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/16-io-%E5%8A%A0%E9%80%9F%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%E7%9A%84-netty-%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF/">16 IO åŠ é€Ÿï¼šä¸ä¼—ä¸åŒçš„ Netty é›¶æ‹·è´æŠ€æœ¯</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/17-%E6%BA%90%E7%A0%81%E7%AF%87%E4%BB%8E-linux-%E5%87%BA%E5%8F%91%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">17 æºç ç¯‡ï¼šä» Linux å‡ºå‘æ·±å…¥å‰–ææœåŠ¡ç«¯å¯åŠ¨æµç¨‹</a></li>
                
                
                
                    <li>18 æºç ç¯‡ï¼šè§£å¯† Netty Reactor çº¿ç¨‹æ¨¡å‹</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/19-%E6%BA%90%E7%A0%81%E7%AF%87%E4%B8%80%E4%B8%AA%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E5%9C%A8-netty-%E4%B8%AD%E7%9A%84%E6%97%85%E7%A8%8B/">19 æºç ç¯‡ï¼šä¸€ä¸ªç½‘ç»œè¯·æ±‚åœ¨ Netty ä¸­çš„æ—…ç¨‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/20-%E6%8A%80%E5%B7%A7%E7%AF%87netty-%E7%9A%84-fastthreadlocal-%E7%A9%B6%E7%AB%9F%E6%AF%94-threadlocal-%E5%BF%AB%E5%9C%A8%E5%93%AA%E5%84%BF/">20 æŠ€å·§ç¯‡ï¼šNetty çš„ FastThreadLocal ç©¶ç«Ÿæ¯” ThreadLocal å¿«åœ¨å“ªå„¿ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/21-%E6%8A%80%E5%B7%A7%E7%AF%87%E5%BB%B6%E8%BF%9F%E4%BB%BB%E5%8A%A1%E5%A4%84%E7%90%86%E7%A5%9E%E5%99%A8%E4%B9%8B%E6%97%B6%E9%97%B4%E8%BD%AE-hashedwheeltimer/">21 æŠ€å·§ç¯‡ï¼šå»¶è¿Ÿä»»åŠ¡å¤„ç†ç¥å™¨ä¹‹æ—¶é—´è½® HashedWheelTimer</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/22-%E6%8A%80%E5%B7%A7%E7%AF%87%E9%AB%98%E6%80%A7%E8%83%BD%E6%97%A0%E9%94%81%E9%98%9F%E5%88%97-mpsc-queue/">22 æŠ€å·§ç¯‡ï¼šé«˜æ€§èƒ½æ— é”é˜Ÿåˆ— Mpsc Queue</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/23-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E9%AB%98%E6%80%A7%E8%83%BD%E5%88%86%E5%B8%83%E5%BC%8F-rpc-%E6%A1%86%E6%9E%B6/">23 æ¶æ„è®¾è®¡ï¼šå¦‚ä½•å®ç°ä¸€ä¸ªé«˜æ€§èƒ½åˆ†å¸ƒå¼ RPC æ¡†æ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/24-%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E4%B8%8E%E8%AE%A2%E9%98%85%E6%90%AD%E5%BB%BA%E7%94%9F%E4%BA%A7%E8%80%85%E5%92%8C%E6%B6%88%E8%B4%B9%E8%80%85%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A1%86%E6%9E%B6/">24 æœåŠ¡å‘å¸ƒä¸è®¢é˜…ï¼šæ­å»ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åŸºç¡€æ¡†æ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/25-%E8%BF%9C%E7%A8%8B%E9%80%9A%E4%BF%A1%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE%E8%AE%BE%E8%AE%A1%E4%BB%A5%E5%8F%8A%E7%BC%96%E8%A7%A3%E7%A0%81%E7%9A%84%E5%AE%9E%E7%8E%B0/">25 è¿œç¨‹é€šä¿¡ï¼šé€šä¿¡åè®®è®¾è®¡ä»¥åŠç¼–è§£ç çš„å®ç°</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/26-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%9C%BA%E5%88%B6%E7%9A%84%E5%AE%9E%E7%8E%B0/">26 æœåŠ¡æ²»ç†ï¼šæœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡æœºåˆ¶çš„å®ç°</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/27-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%BA%E7%94%A8%E6%88%B7%E5%B1%8F%E8%94%BD-rpc-%E8%B0%83%E7%94%A8%E7%9A%84%E5%BA%95%E5%B1%82%E7%BB%86%E8%8A%82/">27 åŠ¨æ€ä»£ç†ï¼šä¸ºç”¨æˆ·å±è”½ RPC è°ƒç”¨çš„åº•å±‚ç»†èŠ‚</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/28-%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93rpc-%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93%E4%B8%8E%E8%BF%9B%E9%98%B6%E5%BB%B6%E4%BC%B8/">28 å®æˆ˜æ€»ç»“ï¼šRPC å®æˆ˜æ€»ç»“ä¸è¿›é˜¶å»¶ä¼¸</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/29-%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3netty-%E4%B8%AD%E5%BA%94%E7%94%A8%E4%BA%86%E5%93%AA%E4%BA%9B%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">29 ç¼–ç¨‹æ€æƒ³ï¼šNetty ä¸­åº”ç”¨äº†å“ªäº›è®¾è®¡æ¨¡å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/30-%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93netty-%E5%9C%A8%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">30 å®è·µæ€»ç»“ï¼šNetty åœ¨é¡¹ç›®å¼€å‘ä¸­çš„ä¸€äº›æœ€ä½³å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/31-%E7%BB%93%E6%9D%9F%E8%AF%AD-%E6%8A%80%E6%9C%AF%E6%88%90%E9%95%BF%E4%B9%8B%E8%B7%AF%E5%A6%82%E4%BD%95%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB/">31 ç»“æŸè¯­ æŠ€æœ¯æˆé•¿ä¹‹è·¯ï¼šå¦‚ä½•æ‰“é€ è‡ªå·±çš„æŠ€æœ¯ä½“ç³»</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">18 æºç ç¯‡ï¼šè§£å¯† Netty Reactor çº¿ç¨‹æ¨¡å‹</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2021-12-22 01:54:40</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/netty/">netty</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/">Nettyæ ¸å¿ƒåŸç†å‰–æä¸RPCå®è·µ</a>
                
            </div></div>
        <div class="post-content">
            <p>é€šè¿‡ç¬¬ä¸€ç«  Netty åŸºç¡€è¯¾ç¨‹çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“ Reactor çº¿ç¨‹æ¨¡å‹æ˜¯ Netty å®ç°é«˜æ€§èƒ½çš„æ ¸å¿ƒæ‰€åœ¨ï¼Œåœ¨ Netty ä¸­ EventLoop æ˜¯ Reactor çº¿ç¨‹æ¨¡å‹çš„æ ¸å¿ƒå¤„ç†å¼•æ“ï¼Œé‚£ä¹ˆ EventLoop åˆ°åº•æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿåˆæ˜¯å¦‚ä½•ä¿è¯é«˜æ€§èƒ½å’Œçº¿ç¨‹å®‰å…¨æ€§çš„å‘¢ï¼Ÿä»Šå¤©è¿™èŠ‚è¯¾è®©æˆ‘ä»¬ä¸€èµ·ä¸€æ¢ç©¶ç«Ÿã€‚</p>
<blockquote>
<p>è¯´æ˜ï¼šæœ¬æ–‡å‚è€ƒçš„ Netty æºç ç‰ˆæœ¬ä¸º 4.1.42.Finalã€‚</p>
</blockquote>
<h3 id="reactor-çº¿ç¨‹æ‰§è¡Œçš„ä¸»æµç¨‹">Reactor çº¿ç¨‹æ‰§è¡Œçš„ä¸»æµç¨‹</h3>
<p>åœ¨ã€Šäº‹ä»¶è°ƒåº¦å±‚ï¼šä¸ºä»€ä¹ˆ EventLoop æ˜¯ Netty çš„ç²¾é«“ã€‹çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† EventLoop çš„æ¦‚è²Œï¼Œå› ä¸º Netty æ˜¯åŸºäº NIO å®ç°çš„ï¼Œæ‰€ä»¥æ¨èä½¿ç”¨ NioEventLoop å®ç°ï¼Œæˆ‘ä»¬å†æ¬¡é€šè¿‡ NioEventLoop çš„æ ¸å¿ƒå…¥å£ run() æ–¹æ³•å›é¡¾ Netty Reactor çº¿ç¨‹æ¨¡å‹æ‰§è¡Œçš„ä¸»æµç¨‹ï¼Œå¹¶ä»¥æ­¤ä¸ºåŸºç¡€ç»§ç»­æ·±å…¥ç ”ç©¶ NioEventLoop çš„é€»è¾‘ç»†èŠ‚ã€‚</p>
<pre tabindex="0"><code>protected void run() {

    for (;;) {

        try {

            try {

                switch (selectStrategy.calculateStrategy(selectNowSupplier, hasTasks())) {

                case SelectStrategy.CONTINUE:

                    continue;

                case SelectStrategy.BUSY_WAIT:

                case SelectStrategy.SELECT:

                    select(wakenUp.getAndSet(false)); // è½®è¯¢ I/O äº‹ä»¶

                    if (wakenUp.get()) {

                        selector.wakeup();

                    }

                default:

                }

            } catch (IOException e) {

                rebuildSelector0();

                handleLoopException(e);

                continue;

            }

            cancelledKeys = 0;

            needsToSelectAgain = false;

            final int ioRatio = this.ioRatio;

            if (ioRatio == 100) {

                try {

                    processSelectedKeys(); // å¤„ç† I/O äº‹ä»¶

                } finally {

                    runAllTasks(); // å¤„ç†æ‰€æœ‰ä»»åŠ¡

                }

            } else {

                final long ioStartTime = System.nanoTime();

                try {

                    processSelectedKeys(); // å¤„ç† I/O äº‹ä»¶

                } finally {

                    final long ioTime = System.nanoTime() - ioStartTime;

                    runAllTasks(ioTime * (100 - ioRatio) / ioRatio); // å¤„ç†å®Œ I/O äº‹ä»¶ï¼Œå†å¤„ç†å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—

                }

            }

        } catch (Throwable t) {

            handleLoopException(t);

        }

        try {

            if (isShuttingDown()) {

                closeAll();

                if (confirmShutdown()) {

                    return;

                }

            }

        } catch (Throwable t) {

            handleLoopException(t);

        }

    }

}
</code></pre><p>NioEventLoop çš„ run() æ–¹æ³•æ˜¯ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œæ²¡æœ‰ä»»ä½•é€€å‡ºæ¡ä»¶ï¼Œåœ¨ä¸é—´æ–­å¾ªç¯æ‰§è¡Œä»¥ä¸‹ä¸‰ä»¶äº‹æƒ…ï¼Œå¯ä»¥ç”¨ä¸‹é¢è¿™å¼ å›¾å½¢è±¡åœ°è¡¨ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Cip5yF_ZyhCAM3GUAASrdEcuR2U593.png" alt="Lark20201216-164824.png"></p>
<ul>
<li>è½®è¯¢ I/O äº‹ä»¶ï¼ˆselectï¼‰ï¼šè½®è¯¢ Selector é€‰æ‹©å™¨ä¸­å·²ç»æ³¨å†Œçš„æ‰€æœ‰ Channel çš„ I/O äº‹ä»¶ã€‚</li>
<li>å¤„ç† I/O äº‹ä»¶ï¼ˆprocessSelectedKeysï¼‰ï¼šå¤„ç†å·²ç»å‡†å¤‡å°±ç»ªçš„ I/O äº‹ä»¶ã€‚</li>
<li>å¤„ç†å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼ˆrunAllTasksï¼‰ï¼šReactor çº¿ç¨‹è¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„èŒè´£ï¼Œå°±æ˜¯å¤„ç†ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„é I/O ä»»åŠ¡ã€‚Netty æä¾›äº† ioRatio å‚æ•°ç”¨äºè°ƒæ•´ I/O äº‹ä»¶å¤„ç†å’Œä»»åŠ¡å¤„ç†çš„æ—¶é—´æ¯”ä¾‹ã€‚</li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬å¯¹ NioEventLoop çš„ä¸‰ä¸ªæ­¥éª¤è¿›è¡Œè¯¦ç»†çš„ä»‹ç»ã€‚</p>
<h4 id="è½®è¯¢-io-äº‹ä»¶">è½®è¯¢ I/O äº‹ä»¶</h4>
<p>æˆ‘ä»¬é¦–å…ˆèšç„¦åœ¨è½®è¯¢ I/O äº‹ä»¶çš„å…³é”®ä»£ç ç‰‡æ®µï¼š</p>
<pre tabindex="0"><code>case SelectStrategy.CONTINUE:

    continue;

case SelectStrategy.BUSY_WAIT:

case SelectStrategy.SELECT:

    select(wakenUp.getAndSet(false));

    if (wakenUp.get()) {

        selector.wakeup();

    }
</code></pre><p>NioEventLoop é€šè¿‡æ ¸å¿ƒæ–¹æ³• select() ä¸æ–­è½®è¯¢æ³¨å†Œçš„ I/O äº‹ä»¶ã€‚å½“æ²¡æœ‰ I/O äº‹ä»¶äº§ç”Ÿæ—¶ï¼Œä¸ºäº†é¿å… NioEventLoop çº¿ç¨‹ä¸€ç›´å¾ªç¯ç©ºè½¬ï¼Œåœ¨è·å– I/O äº‹ä»¶æˆ–è€…å¼‚æ­¥ä»»åŠ¡æ—¶éœ€è¦é˜»å¡çº¿ç¨‹ï¼Œç­‰å¾… I/O äº‹ä»¶å°±ç»ªæˆ–è€…å¼‚æ­¥ä»»åŠ¡äº§ç”Ÿåæ‰å”¤é†’çº¿ç¨‹ã€‚NioEventLoop ä½¿ç”¨ wakeUp å˜é‡è¡¨ç¤ºæ˜¯å¦å”¤é†’ selectorï¼ŒNetty åœ¨æ¯ä¸€æ¬¡æ‰§è¡Œæ–°çš„ä¸€è½®å¾ªç¯ä¹‹å‰ï¼Œéƒ½ä¼šå°† wakeUp è®¾ç½®ä¸º falseã€‚</p>
<p>Netty æä¾›äº†é€‰æ‹©ç­–ç•¥ SelectStrategy å¯¹è±¡ï¼Œå®ƒç”¨äºæ§åˆ¶ select å¾ªç¯è¡Œä¸ºï¼ŒåŒ…å« CONTINUEã€SELECTã€BUSY_WAIT ä¸‰ç§ç­–ç•¥ï¼Œå› ä¸º NIO å¹¶ä¸æ”¯æŒ BUSY_WAITï¼Œæ‰€ä»¥ BUSY_WAIT ä¸ SELECT çš„æ‰§è¡Œé€»è¾‘æ˜¯ä¸€æ ·çš„ã€‚åœ¨ I/O äº‹ä»¶å¾ªç¯çš„è¿‡ç¨‹ä¸­ Netty é€‰æ‹©ä½¿ç”¨ä½•ç§ç­–ç•¥ï¼Œå…·ä½“çš„åˆ¤æ–­ä¾æ®å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>// DefaultSelectStrategy#calculateStrategy

public int calculateStrategy(IntSupplier selectSupplier, boolean hasTasks) throws Exception {

    return hasTasks ? selectSupplier.get() : SelectStrategy.SELECT;

}

// NioEventLoop#selectNowSupplier

private final IntSupplier selectNowSupplier = new IntSupplier() {

    @Override

    public int get() throws Exception {

        return selectNow();

    }

}

// NioEventLoop#selectNow

int selectNow() throws IOException {

    try {

        return selector.selectNow();

    } finally {

        if (wakenUp.get()) {

            selector.wakeup();

        }

    }

}
</code></pre><p>å¦‚æœå½“å‰ NioEventLoop çº¿ç¨‹å­˜åœ¨å¼‚æ­¥ä»»åŠ¡ï¼Œä¼šé€šè¿‡ selectSupplier.get() æœ€ç»ˆè°ƒç”¨åˆ° selectNow() æ–¹æ³•ï¼ŒselectNow() æ˜¯éé˜»å¡ï¼Œæ‰§è¡Œåç«‹å³è¿”å›ã€‚å¦‚æœå­˜åœ¨å°±ç»ªçš„ I/O äº‹ä»¶ï¼Œé‚£ä¹ˆä¼šèµ°åˆ° default åˆ†æ”¯åç›´æ¥è·³å‡ºï¼Œç„¶åæ‰§è¡Œ I/O äº‹ä»¶å¤„ç† processSelectedKeys å’Œå¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—å¤„ç† runAllTasks çš„é€»è¾‘ã€‚æ‰€ä»¥åœ¨å­˜åœ¨å¼‚æ­¥ä»»åŠ¡çš„åœºæ™¯ï¼ŒNioEventLoop ä¼šä¼˜å…ˆä¿è¯ CPU èƒ½å¤ŸåŠæ—¶å¤„ç†å¼‚æ­¥ä»»åŠ¡ã€‚</p>
<p>å½“ NioEventLoop çº¿ç¨‹çš„ä¸å­˜åœ¨å¼‚æ­¥ä»»åŠ¡ï¼Œå³ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œè¿”å›çš„æ˜¯ SELECT ç­–ç•¥, å°±ä¼šè°ƒç”¨ select(boolean oldWakenUp) æ–¹æ³•ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ select() å†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p>
<pre tabindex="0"><code>private void select(boolean oldWakenUp) throws IOException {

    Selector selector = this.selector;

    try {

        int selectCnt = 0;

        long currentTimeNanos = System.nanoTime();

        long selectDeadLineNanos = currentTimeNanos + delayNanos(currentTimeNanos); // è®¡ç®— select é˜»å¡æ“ä½œçš„æœ€åæˆªæ­¢æ—¶é—´

        long normalizedDeadlineNanos = selectDeadLineNanos - initialNanoTime();

        if (nextWakeupTime != normalizedDeadlineNanos) {

            nextWakeupTime = normalizedDeadlineNanos;

        }

        for (;;) {

            // ------ 1. æ£€æµ‹ select é˜»å¡æ“ä½œæ˜¯å¦è¶…è¿‡æˆªæ­¢æ—¶é—´ ------

            long timeoutMillis = (selectDeadLineNanos - currentTimeNanos + 500000L) / 1000000L;

            if (timeoutMillis &lt;= 0) {

                if (selectCnt == 0) {

                    selector.selectNow();

                    selectCnt = 1;

                }

                break;

            }

            // ------ 2. è½®è¯¢è¿‡ç¨‹ä¸­å¦‚æœæœ‰ä»»åŠ¡äº§ç”Ÿï¼Œä¸­æ–­æœ¬æ¬¡è½®è¯¢

            if (hasTasks() &amp;&amp; wakenUp.compareAndSet(false, true)) {

                selector.selectNow();

                selectCnt = 1;

                break;

            }

            // ------ 3. select é˜»å¡ç­‰å¾…è·å– I/O äº‹ä»¶ ------

            int selectedKeys = selector.select(timeoutMillis);

            selectCnt ++;

            if (selectedKeys != 0 || oldWakenUp || wakenUp.get() || hasTasks() || hasScheduledTasks()) {

                break;

            }

            if (Thread.interrupted()) {

                if (logger.isDebugEnabled()) {

                    logger.debug(&quot;Selector.select() returned prematurely because &quot; +

                            &quot;Thread.currentThread().interrupt() was called. Use &quot; +

                            &quot;NioEventLoop.shutdownGracefully() to shutdown the NioEventLoop.&quot;);

                }

                selectCnt = 1;

                break;

            }

            // ------ 4. è§£å†³è‡­åæ˜­è‘—çš„ JDK epoll ç©ºè½®è¯¢ Bug ------

            long time = System.nanoTime();

            if (time - TimeUnit.MILLISECONDS.toNanos(timeoutMillis) &gt;= currentTimeNanos) {

                selectCnt = 1;

            } else if (SELECTOR_AUTO_REBUILD_THRESHOLD &gt; 0 &amp;&amp;

                    selectCnt &gt;= SELECTOR_AUTO_REBUILD_THRESHOLD) {

                selector = selectRebuildSelector(selectCnt);

                selectCnt = 1;

                break;

            }

            currentTimeNanos = time;

        }

        if (selectCnt &gt; MIN_PREMATURE_SELECTOR_RETURNS) {

            if (logger.isDebugEnabled()) {

                logger.debug(&quot;Selector.select() returned prematurely {} times in a row for Selector {}.&quot;,

                        selectCnt - 1, selector);

            }

        }

    } catch (CancelledKeyException e) {

        if (logger.isDebugEnabled()) {

            logger.debug(CancelledKeyException.class.getSimpleName() + &quot; raised by a Selector {} - JDK bug?&quot;,

                    selector, e);

        }

    }

}
</code></pre><p>Netty ä¸ºäº†è§£å†³è‡­åæ˜­è‘—çš„ JDK epoll ç©ºè½®è¯¢ Bugï¼Œé€ æˆæ•´ä¸ª select() æ–¹æ³•æ˜¯ç›¸å¯¹æ¯”è¾ƒå¤æ‚çš„ï¼Œæˆ‘æŠŠå®ƒåˆ’åˆ†æˆå››ä¸ªéƒ¨åˆ†é€ä¸€æ‹†è§£æ¥çœ‹ã€‚</p>
<p><strong>ç¬¬ä¸€æ­¥ï¼Œæ£€æµ‹ select é˜»å¡æ“ä½œæ˜¯å¦è¶…è¿‡æˆªæ­¢æ—¶é—´ã€‚</strong> åœ¨è¿›å…¥æ— é™å¾ªç¯ä¹‹å‰ï¼ŒNetty é¦–å…ˆè®°å½•äº†å½“å‰æ—¶é—´ currentTimeNanos ä»¥åŠå®šæ—¶ä»»åŠ¡é˜Ÿåˆ—ä¸­æœ€è¿‘å¾…æ‰§è¡Œä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ selectDeadLineNanosï¼ŒNetty ä¸­å®šæ—¶ä»»åŠ¡é˜Ÿåˆ—æ˜¯æŒ‰ç…§å»¶è¿Ÿæ—¶é—´ä»å°åˆ°å¤§è¿›è¡Œæ’åˆ—çš„ï¼Œé€šè¿‡è°ƒç”¨ delayNanos(currentTimeNanos) æ–¹æ³•å¯ä»¥è·å¾—ç¬¬ä¸€ä¸ªå¾…æ‰§è¡Œå®šæ—¶ä»»åŠ¡çš„å»¶è¿Ÿæ—¶é—´ã€‚ç„¶åä»£ç ä¼šè¿›å…¥æ— é™å¾ªç¯ã€‚é¦–å…ˆåˆ¤æ–­ currentTimeNanos æ˜¯å¦è¶…è¿‡ selectDeadLineNanos 0.5ms ä»¥ä¸Šï¼Œå¦‚æœè¶…è¿‡è¯´æ˜å½“å‰ä»»åŠ¡é˜Ÿåˆ—ä¸­æœ‰å®šæ—¶ä»»åŠ¡éœ€è¦ç«‹åˆ»æ‰§è¡Œï¼Œæ‰€ä»¥æ­¤æ—¶ä¼šé€€å‡ºæ— é™å¾ªç¯ã€‚é€€å‡ºä¹‹å‰å¦‚æœä»æœªæ‰§è¡Œè¿‡ select æ“ä½œï¼Œé‚£ä¹ˆä¼šç«‹å³ä¸€æ¬¡éé˜»å¡çš„ selectNow æ“ä½œã€‚é‚£ä¹ˆè¿™é‡Œæœ‰ä¸€ä¸ªç–‘é—®ï¼Œä¸ºä»€ä¹ˆä¼šç•™å‡º 0.5ms çš„æ—¶é—´çª—å£å‘¢ï¼Ÿåœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºçš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ select æ“ä½œæ²¡æœ‰è·å¾—åˆ°ä»»ä½• I/O äº‹ä»¶å°±ç«‹å³åœæ­¢é˜»å¡è¿”å›ã€‚</p>
<p>å…¶ä¸­æœ‰ä¸€ç‚¹å®¹æ˜“æ··æ·†ï¼ŒNetty çš„ä»»åŠ¡é˜Ÿåˆ—åŒ…æ‹¬æ™®é€šä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡ä»¥åŠå°¾éƒ¨ä»»åŠ¡ï¼ŒhasTask() åˆ¤æ–­çš„æ˜¯æ™®é€šä»»åŠ¡é˜Ÿåˆ—å’Œå°¾éƒ¨é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œè€Œ delayNanos(currentTimeNanos) æ–¹æ³•è·å–çš„æ˜¯å®šæ—¶ä»»åŠ¡çš„å»¶è¿Ÿæ—¶é—´ã€‚</p>
<p><strong>ç¬¬äºŒæ­¥ï¼Œè½®è¯¢è¿‡ç¨‹ä¸­åŠæ—¶å¤„ç†äº§ç”Ÿçš„ä»»åŠ¡ã€‚</strong> Netty ä¸ºäº†ä¿è¯ä»»åŠ¡èƒ½å¤ŸåŠæ—¶æ‰§è¡Œï¼Œä¼šç«‹å³ä¸€æ¬¡éé˜»å¡çš„ selectNow æ“ä½œåï¼Œç«‹å³è·³å‡ºå¾ªç¯å›åˆ°äº‹ä»¶å¾ªç¯çš„ä¸»æµç¨‹ï¼Œç¡®ä¿æ¥ä¸‹æ¥èƒ½å¤Ÿä¼˜å…ˆæ‰§è¡Œ runAllTasksã€‚</p>
<p><strong>ç¬¬ä¸‰æ­¥ï¼Œselect é˜»å¡ç­‰å¾…è·å– I/O äº‹ä»¶ã€‚</strong> æ‰§è¡Œ select é˜»å¡æ“ä½œï¼Œè¯´æ˜ä»»åŠ¡é˜Ÿåˆ—å·²ç»ä¸ºç©ºï¼Œè€Œä¸”ç¬¬ä¸€ä¸ªå¾…æ‰§è¡Œå®šæ—¶ä»»åŠ¡è¿˜æ²¡æœ‰åˆ°è¾¾ä»»åŠ¡æ‰§è¡Œçš„æˆªæ­¢æ—¶é—´ï¼Œéœ€è¦é˜»å¡ç­‰å¾… timeoutMillis çš„è¶…æ—¶æ—¶é—´ã€‚å‡è®¾ä¸€ç§æç«¯æƒ…å†µï¼Œå¦‚æœå®šæ—¶ä»»åŠ¡çš„æˆªæ­¢æ—¶é—´éå¸¸ä¹…ï¼Œé‚£ä¹ˆ select æ“ä½œå²‚ä¸æ˜¯ä¼šä¸€ç›´é˜»å¡é€ æˆ Netty æ— æ³•å·¥ä½œï¼Ÿæ‰€ä»¥ Netty åœ¨å¤–éƒ¨çº¿ç¨‹æ·»åŠ ä»»åŠ¡çš„æ—¶å€™ï¼Œå¯ä»¥å”¤é†’ select é˜»å¡æ“ä½œï¼Œå…·ä½“æºç å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>// SingleThreadEventExecutor#execute

public void execute(Runnable task) {

    // çœç•¥å…¶ä»–ä»£ç 

    if (!addTaskWakesUp &amp;&amp; wakesUpForTask(task)) {

        wakeup(inEventLoop); 

    }

}

// NioEventLoop#wakeup

protected void wakeup(boolean inEventLoop) {

    // å¦‚æœæ˜¯å¤–éƒ¨çº¿ç¨‹ï¼Œè®¾ç½® wakenUp ä¸ºtrueï¼Œåˆ™å”¤é†’ select é˜»å¡æ“ä½œ

    if (!inEventLoop &amp;&amp; wakenUp.compareAndSet(false, true)) {

        selector.wakeup(); 

    }

}
</code></pre><p>selector.wakeup() æ“ä½œçš„å¼€é”€æ˜¯éå¸¸å¤§çš„ï¼Œæ‰€ä»¥ Netty å¹¶ä¸æ˜¯æ¯æ¬¡éƒ½ç›´æ¥è°ƒç”¨ï¼Œåœ¨æ¯æ¬¡è°ƒç”¨ä¹‹å‰éƒ½ä¼šå…ˆæ‰§è¡Œ wakenUp.compareAndSet(false, true)ï¼Œåªæœ‰è®¾ç½®æˆåŠŸä¹‹åæ‰ä¼šæ‰§è¡Œ selector.wakeup() æ“ä½œã€‚</p>
<p><strong>ç¬¬å››æ­¥ï¼Œè§£å†³è‡­åæ˜­è‘—çš„ JDK epoll ç©ºè½®è¯¢ Bugã€‚</strong> åœ¨ä¹‹å‰çš„è¯¾ç¨‹ä¸­å·²ç»åˆæ­¥ä»‹ç»äº† Netty çš„è§£å†³æ–¹æ¡ˆï¼Œåœ¨è¿™é‡Œç»“åˆæ•´ä½“ select æ“ä½œæˆ‘ä»¬å†åšä¸€æ¬¡å›é¡¾ã€‚å®é™…ä¸Š Netty å¹¶æ²¡æœ‰ä»æ ¹æºä¸Šè§£å†³è¯¥é—®é¢˜ï¼Œè€Œæ˜¯å·§å¦™åœ°è§„é¿äº†è¿™ä¸ªé—®é¢˜ã€‚Netty å¼•å…¥äº†è®¡æ•°å˜é‡ selectCntï¼Œç”¨äºè®°å½• select æ“ä½œçš„æ¬¡æ•°ï¼Œå¦‚æœäº‹ä»¶è½®è¯¢æ—¶é—´å°äº timeoutMillisï¼Œå¹¶ä¸”åœ¨è¯¥æ—¶é—´å‘¨æœŸå†…è¿ç»­å‘ç”Ÿè¶…è¿‡ SELECTOR_AUTO_REBUILD_THRESHOLDï¼ˆé»˜è®¤512ï¼‰ æ¬¡ç©ºè½®è¯¢ï¼Œè¯´æ˜å¯èƒ½è§¦å‘äº† epoll ç©ºè½®è¯¢ Bugã€‚Netty é€šè¿‡é‡å»ºæ–°çš„ Selector å¯¹è±¡ï¼Œå°†å¼‚å¸¸çš„ Selector ä¸­æ‰€æœ‰çš„ SelectionKey ä¼šé‡æ–°æ³¨å†Œåˆ°æ–°å»ºçš„ Selectorï¼Œé‡å»ºå®Œæˆä¹‹åå¼‚å¸¸çš„ Selector å°±å¯ä»¥åºŸå¼ƒäº†ã€‚</p>
<p>NioEventLoop è½®è¯¢ I/O äº‹ä»¶ select çš„è¿‡ç¨‹å·²ç»è®²å®Œäº†ï¼Œæˆ‘ä»¬ç®€å•æ€»ç»“ select è¿‡ç¨‹æ‰€åšçš„äº‹æƒ…ã€‚select æ“ä½œä¹Ÿæ˜¯ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œåœ¨äº‹ä»¶è½®è¯¢ä¹‹å‰æ£€æŸ¥ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œç¡®ä¿ä»»åŠ¡é˜Ÿåˆ—ä¸­å¾…æ‰§è¡Œçš„ä»»åŠ¡èƒ½å¤ŸåŠæ—¶æ‰§è¡Œã€‚å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸­å·²ç»ä¸ºç©ºï¼Œç„¶åæ‰§è¡Œ select é˜»å¡æ“ä½œè·å–ç­‰å¾…è·å– I/O äº‹ä»¶ã€‚Netty é€šè¿‡å¼•å…¥è®¡æ•°å™¨å˜é‡ï¼Œå¹¶ç»Ÿè®¡åœ¨ä¸€å®šæ—¶é—´çª—å£å†… select æ“ä½œçš„æ‰§è¡Œæ¬¡æ•°ï¼Œè¯†åˆ«å‡ºå¯èƒ½å­˜åœ¨å¼‚å¸¸çš„ Selector å¯¹è±¡ï¼Œç„¶åé‡‡ç”¨é‡å»º Selector çš„æ–¹å¼å·§å¦™åœ°é¿å…äº† JDK epoll ç©ºè½®è¯¢çš„é—®é¢˜ã€‚</p>
<h4 id="å¤„ç†-io-äº‹ä»¶">å¤„ç† I/O äº‹ä»¶</h4>
<p>é€šè¿‡ select è¿‡ç¨‹æˆ‘ä»¬å·²ç»è·å–åˆ°å‡†å¤‡å°±ç»ªçš„ I/O äº‹ä»¶ï¼Œæ¥ä¸‹æ¥å°±éœ€è¦è°ƒç”¨ processSelectedKeys() æ–¹æ³•å¤„ç† I/O äº‹ä»¶ã€‚åœ¨å¼€å§‹å¤„ç† I/O äº‹ä»¶ä¹‹å‰ï¼ŒNetty é€šè¿‡ ioRatio å‚æ•°æ§åˆ¶ I/O äº‹ä»¶å¤„ç†å’Œä»»åŠ¡å¤„ç†çš„æ—¶é—´æ¯”ä¾‹ï¼Œé»˜è®¤ä¸º ioRatio = 50ã€‚å¦‚æœ ioRatio = 100ï¼Œè¡¨ç¤ºæ¯æ¬¡éƒ½å¤„ç†å®Œ I/O äº‹ä»¶åï¼Œä¼šæ‰§è¡Œæ‰€æœ‰çš„ taskã€‚å¦‚æœ ioRatio &lt; 100ï¼Œä¹Ÿä¼šä¼˜å…ˆå¤„ç†å®Œ I/O äº‹ä»¶ï¼Œå†å¤„ç†å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ã€‚æ‰€ä»¥ä¸è®ºå¦‚ä½• processSelectedKeys() éƒ½æ˜¯å…ˆæ‰§è¡Œçš„ï¼Œæ¥ä¸‹æ¥è·Ÿè¿›ä¸‹ processSelectedKeys() çš„æºç ï¼š</p>
<pre tabindex="0"><code>private void processSelectedKeys() {

    if (selectedKeys != null) {

        processSelectedKeysOptimized();

    } else {

        processSelectedKeysPlain(selector.selectedKeys());

    }

}
</code></pre><p>å¤„ç† I/O äº‹ä»¶æ—¶æœ‰ä¸¤ç§é€‰æ‹©ï¼Œä¸€ç§æ˜¯å¤„ç† Netty ä¼˜åŒ–è¿‡çš„ selectedKeysï¼Œå¦å¤–ä¸€ç§æ˜¯æ­£å¸¸çš„å¤„ç†é€»è¾‘ã€‚æ ¹æ®æ˜¯å¦è®¾ç½®äº† selectedKeys æ¥åˆ¤æ–­ä½¿ç”¨å“ªç§ç­–ç•¥ï¼Œè¿™ä¸¤ç§ç­–ç•¥ä½¿ç”¨çš„ selectedKeys é›†åˆæ˜¯ä¸ä¸€æ ·çš„ã€‚Netty ä¼˜åŒ–è¿‡çš„ selectedKeys æ˜¯ SelectedSelectionKeySet ç±»å‹ï¼Œè€Œæ­£å¸¸é€»è¾‘ä½¿ç”¨çš„æ˜¯ JDK HashSet ç±»å‹ã€‚ä¸‹é¢æˆ‘ä»¬é€ä¸€ä»‹ç»ä¸¤ç§ç­–ç•¥çš„å®ç°ã€‚</p>
<p><strong>1. processSelectedKeysPlain</strong></p>
<p>é¦–å…ˆçœ‹ä¸‹æ­£å¸¸çš„å¤„ç†é€»è¾‘ processSelectedKeysPlain çš„æºç ï¼š</p>
<pre tabindex="0"><code>private void processSelectedKeysPlain(Set&lt;SelectionKey&gt; selectedKeys) {

    if (selectedKeys.isEmpty()) {

        return;

    }

    Iterator&lt;SelectionKey&gt; i = selectedKeys.iterator();

    for (;;) {

        final SelectionKey k = i.next();

        final Object a = k.attachment();

        i.remove();

        if (a instanceof AbstractNioChannel) {

            // I/O äº‹ä»¶ç”± Netty è´Ÿè´£å¤„ç†

            processSelectedKey(k, (AbstractNioChannel) a);

        } else {

            // ç”¨æˆ·è‡ªå®šä¹‰ä»»åŠ¡

            @SuppressWarnings(&quot;unchecked&quot;)

            NioTask&lt;SelectableChannel&gt; task = (NioTask&lt;SelectableChannel&gt;) a;

            processSelectedKey(k, task);

        }

        if (!i.hasNext()) {

            break;

        }

        if (needsToSelectAgain) {

            selectAgain();

            selectedKeys = selector.selectedKeys();

            if (selectedKeys.isEmpty()) {

                break;

            } else {

                i = selectedKeys.iterator();

            }

        }

    }

}
</code></pre><p>Netty ä¼šéå†ä¾æ¬¡å¤„ç†å·²ç»å°±ç»ªçš„ SelectionKeyï¼ŒSelectionKey ä¸Šé¢å¯ä»¥æŒ‚è½½ attachmentã€‚å†æ ¹æ® attachment å±æ€§å¯ä»¥åˆ¤æ–­ SelectionKey çš„ç±»å‹ï¼ŒSelectionKey çš„ç±»å‹å¯èƒ½æ˜¯ AbstractNioChannel å’Œ NioTaskï¼Œè¿™ä¸¤ç§ç±»å‹å¯¹åº”çš„å¤„ç†æ–¹å¼ä¹Ÿæ˜¯ä¸åŒçš„ï¼ŒAbstractNioChannel ç±»å‹ç”± Netty æ¡†æ¶è´Ÿè´£å¤„ç†ï¼ŒNioTask æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ taskï¼Œä¸€èˆ¬ä¸ä¼šæ˜¯è¿™ç§ç±»å‹ã€‚æˆ‘ä»¬ç€é‡çœ‹ä¸‹ AbstractNioChannel çš„å¤„ç†åœºæ™¯ï¼Œè·Ÿè¿› processSelectedKey() çš„æºç ï¼š</p>
<pre tabindex="0"><code>private void processSelectedKey(SelectionKey k, AbstractNioChannel ch) {

    final AbstractNioChannel.NioUnsafe unsafe = ch.unsafe();

    if (!k.isValid()) { // æ£€æŸ¥ Key æ˜¯å¦åˆæ³•

        final EventLoop eventLoop;

        try {

            eventLoop = ch.eventLoop();

        } catch (Throwable ignored) {

            return;

        }

        if (eventLoop != this || eventLoop == null) {

            return;

        }

        unsafe.close(unsafe.voidPromise()); // Key ä¸åˆæ³•ï¼Œç›´æ¥å…³é—­è¿æ¥

        return;

    }

    try {

        int readyOps = k.readyOps();

        // å¤„ç†è¿æ¥äº‹ä»¶

        if ((readyOps &amp; SelectionKey.OP_CONNECT) != 0) {

            int ops = k.interestOps();

            ops &amp;= ~SelectionKey.OP_CONNECT;

            k.interestOps(ops);

            unsafe.finishConnect();

        }

        // å¤„ç†å¯å†™äº‹ä»¶

        if ((readyOps &amp; SelectionKey.OP_WRITE) != 0) {

            ch.unsafe().forceFlush();

        }

        // å¤„ç†å¯è¯»äº‹ä»¶

        if ((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) != 0 || readyOps == 0) {

            unsafe.read();

        }

    } catch (CancelledKeyException ignored) {

        unsafe.close(unsafe.voidPromise());

    }

}
</code></pre><p>ä»ä¸Šè¿°æºç å¯çŸ¥ï¼ŒprocessSelectedKey ä¸€å…±å¤„ç†äº† OP_CONNECTã€OP_WRITEã€OP_READ ä¸‰ä¸ªäº‹ä»¶ï¼Œæˆ‘ä»¬åˆ†åˆ«äº†è§£ä¸‹è¿™ä¸‰ä¸ªäº‹ä»¶çš„å¤„ç†è¿‡ç¨‹ã€‚</p>
<p>OP_CONNECT è¿æ¥å»ºç«‹äº‹ä»¶ã€‚è¡¨ç¤º TCP è¿æ¥å»ºç«‹æˆåŠŸ, Channel å¤„äº Active çŠ¶æ€ã€‚å¤„ç† OP_CONNECT äº‹ä»¶é¦–å…ˆå°†è¯¥äº‹ä»¶ä»äº‹ä»¶é›†åˆä¸­æ¸…é™¤ï¼Œé¿å…äº‹ä»¶é›†åˆä¸­ä¸€ç›´å­˜åœ¨è¿æ¥å»ºç«‹äº‹ä»¶ï¼Œç„¶åè°ƒç”¨ unsafe.finishConnect() æ–¹æ³•é€šçŸ¥ä¸Šå±‚è¿æ¥å·²ç»å»ºç«‹ã€‚å¯ä»¥è·Ÿè¿› unsafe.finishConnect() çš„æºç å‘ç°ä¼šåº•å±‚è°ƒç”¨çš„ pipeline().fireChannelActive() æ–¹æ³•ï¼Œè¿™æ—¶ä¼šäº§ç”Ÿä¸€ä¸ª Inbound äº‹ä»¶ï¼Œç„¶åä¼šåœ¨ Pipeline ä¸­è¿›è¡Œä¼ æ’­ï¼Œä¾æ¬¡è°ƒç”¨ ChannelHandler çš„ channelActive() æ–¹æ³•ï¼Œé€šçŸ¥å„ä¸ª ChannelHandler è¿æ¥å»ºç«‹æˆåŠŸã€‚</p>
<ul>
<li><strong>OP_WRITEï¼Œå¯å†™äº‹ä»¶</strong>ã€‚è¡¨ç¤ºä¸Šå±‚å¯ä»¥å‘ Channel å†™å…¥æ•°æ®ï¼Œé€šè¿‡æ‰§è¡Œ ch.unsafe().forceFlush() æ“ä½œï¼Œå°†æ•°æ®å†²åˆ·åˆ°å®¢æˆ·ç«¯ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ javaChannel çš„ write() æ–¹æ³•æ‰§è¡Œåº•å±‚å†™æ“ä½œã€‚</li>
<li><strong>OP_READï¼Œå¯è¯»äº‹ä»¶</strong>ã€‚è¡¨ç¤º Channel æ”¶åˆ°äº†å¯ä»¥è¢«è¯»å–çš„æ–°æ•°æ®ã€‚Netty å°† READ å’Œ Accept äº‹ä»¶è¿›è¡Œäº†ç»Ÿä¸€çš„å°è£…ï¼Œéƒ½é€šè¿‡ unsafe.read() è¿›è¡Œå¤„ç†ã€‚unsafe.read() çš„é€»è¾‘å¯ä»¥å½’çº³ä¸ºå‡ ä¸ªæ­¥éª¤ï¼šä» Channel ä¸­è¯»å–æ•°æ®å¹¶å­˜å‚¨åˆ°åˆ†é…çš„ ByteBufï¼›è°ƒç”¨ pipeline.fireChannelRead() æ–¹æ³•äº§ç”Ÿ Inbound äº‹ä»¶ï¼Œç„¶åä¾æ¬¡è°ƒç”¨ ChannelHandler çš„ channelRead() æ–¹æ³•å¤„ç†æ•°æ®ï¼›è°ƒç”¨ pipeline.fireChannelReadComplete() æ–¹æ³•å®Œæˆè¯»æ“ä½œï¼›æœ€ç»ˆæ‰§è¡Œ removeReadOp() æ¸…é™¤ OP_READ äº‹ä»¶ã€‚</li>
</ul>
<p>æˆ‘ä»¬å†æ¬¡å›åˆ° processSelectedKeysPlain çš„ä¸»æµç¨‹ï¼Œæ¥ä¸‹æ¥ä¼šåˆ¤æ–­ needsToSelectAgain å†³å®šæ˜¯å¦éœ€è¦é‡æ–°è½®è¯¢ã€‚å¦‚æœ needsToSelectAgain == trueï¼Œä¼šè°ƒç”¨ selectAgain() æ–¹æ³•è¿›è¡Œé‡æ–°è½®è¯¢ï¼Œè¯¥æ–¹æ³•ä¼šå°† needsToSelectAgain å†æ¬¡ç½®ä¸º falseï¼Œç„¶åè°ƒç”¨ selectorNow() åç«‹å³è¿”å›ã€‚</p>
<p>æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ Reactor çº¿ç¨‹çš„ä¸»æµç¨‹ï¼Œä¼šå‘ç°æ¯æ¬¡åœ¨å¤„ç† I/O äº‹ä»¶ä¹‹å‰ï¼ŒneedsToSelectAgain éƒ½ä¼šè¢«è®¾ç½®ä¸º falseï¼Œé‚£ä¹ˆåœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ needsToSelectAgain ä¼šå†æ¬¡è®¾ç½®ä¸º true å‘¢ï¼Ÿæˆ‘ä»¬é€šè¿‡æŸ¥æ‰¾å˜é‡çš„å¼•ç”¨ï¼Œæœ€åå®šä½åˆ° AbstractChannel#doDeregisterã€‚è¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯å°† Channel ä»å½“å‰æ³¨å†Œçš„ Selector å¯¹è±¡ä¸­ç§»é™¤ï¼Œæ–¹æ³•å†…éƒ¨å¯èƒ½ä¼šæŠŠ needsToSelectAgain è®¾ç½®ä¸º trueï¼Œå…·ä½“æºç å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>protected void doDeregister() throws Exception {

    eventLoop().cancel(selectionKey());

}

void cancel(SelectionKey key) {

    key.cancel();

    cancelledKeys ++;

    // å½“å–æ¶ˆçš„ Key è¶…è¿‡é»˜è®¤é˜ˆå€¼ 256ï¼ŒneedsToSelectAgain è®¾ç½®ä¸º true

    if (cancelledKeys &gt;= CLEANUP_INTERVAL) {

        cancelledKeys = 0;

        needsToSelectAgain = true;

    }

}
</code></pre><p>å½“ Netty åœ¨å¤„ç† I/O äº‹ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‘ç°è¶…è¿‡é»˜è®¤é˜ˆå€¼ 256 ä¸ª Channel ä» Selector å¯¹è±¡ä¸­ç§»é™¤åï¼Œä¼šå°† needsToSelectAgai è®¾ç½®ä¸º trueï¼Œé‡æ–°åšä¸€æ¬¡è½®è¯¢æ“ä½œï¼Œä»è€Œç¡®ä¿ keySet çš„æœ‰æ•ˆæ€§ã€‚</p>
<p><strong>2. processSelectedKeysOptimized</strong></p>
<p>ä»‹ç»å®Œæ­£å¸¸çš„ I/O äº‹ä»¶å¤„ç† processSelectedKeysPlain ä¹‹åï¼Œå›è¿‡å¤´æˆ‘ä»¬å†æ¥åˆ†æ Netty ä¼˜åŒ–çš„ processSelectedKeysOptimized å°±ä¼šè½»æ¾å¾ˆå¤šï¼ŒNetty æ˜¯å¦é‡‡ç”¨ SelectedSelectionKeySet ç±»å‹çš„ä¼˜åŒ–ç­–ç•¥ç”± DISABLE_KEYSET_OPTIMIZATION å‚æ•°å†³å®šã€‚é‚£ä¹ˆåˆ°åº• SelectedSelectionKeySet æ˜¯å¦‚ä½•è¿›è¡Œä¼˜åŒ–çš„å‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­è·Ÿè¿›ä¸‹ processSelectedKeysOptimized çš„æºç ï¼š</p>
<pre tabindex="0"><code>private void processSelectedKeysOptimized() {

    for (int i = 0; i &lt; selectedKeys.size; ++i) {

        final SelectionKey k = selectedKeys.keys[i];

        selectedKeys.keys[i] = null;

        final Object a = k.attachment();

        if (a instanceof AbstractNioChannel) {

            processSelectedKey(k, (AbstractNioChannel) a);

        } else {

            @SuppressWarnings(&quot;unchecked&quot;)

            NioTask&lt;SelectableChannel&gt; task = (NioTask&lt;SelectableChannel&gt;) a;

            processSelectedKey(k, task);

        }

        if (needsToSelectAgain) {

            selectedKeys.reset(i + 1);

            selectAgain();

            i = -1;

        }

    }

}
</code></pre><p>å¯ä»¥å‘ç° processSelectedKeysOptimized ä¸ processSelectedKeysPlain çš„ä»£ç ç»“æ„éå¸¸ç›¸ä¼¼ï¼Œå…¶ä¸­æœ€é‡è¦çš„ä¸€ç‚¹å°±æ˜¯ selectedKeys çš„éå†æ–¹å¼æ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦çœ‹ä¸‹ SelectedSelectionKeySet çš„æºç ä¸€æ¢ç©¶ç«Ÿã€‚</p>
<pre tabindex="0"><code>final class SelectedSelectionKeySet extends AbstractSet&lt;SelectionKey&gt; {

    SelectionKey[] keys;

    int size;

    SelectedSelectionKeySet() {

        keys = new SelectionKey[1024];

    }

    @Override

    public boolean add(SelectionKey o) {

        if (o == null) {

            return false;

        }

        keys[size++] = o;

        if (size == keys.length) {

            increaseCapacity();

        }

        return true;

    }

    

    // çœç•¥å…¶ä»–ä»£ç 

}
</code></pre><p>å› ä¸º SelectedSelectionKeySet å†…éƒ¨ä½¿ç”¨çš„æ˜¯ SelectionKey æ•°ç»„ï¼Œæ‰€ä»¥ processSelectedKeysOptimized å¯ä»¥ç›´æ¥é€šè¿‡éå†æ•°ç»„å–å‡º I/O äº‹ä»¶ï¼Œç›¸æ¯” JDK HashSet çš„éå†æ•ˆç‡æ›´é«˜ã€‚SelectedSelectionKeySet å†…éƒ¨é€šè¿‡ size å˜é‡è®°å½•æ•°æ®çš„é€»è¾‘é•¿åº¦ï¼Œæ¯æ¬¡æ‰§è¡Œ add æ“ä½œæ—¶ï¼Œä¼šæŠŠå¯¹è±¡æ·»åŠ åˆ° SelectionKey[] å°¾éƒ¨ã€‚å½“ size ç­‰äº SelectionKey[] çš„çœŸå®é•¿åº¦æ—¶ï¼ŒSelectionKey[] ä¼šè¿›è¡Œæ‰©å®¹ã€‚ç›¸æ¯”äº HashSetï¼ŒSelectionKey[] ä¸éœ€è¦è€ƒè™‘å“ˆå¸Œå†²çªçš„é—®é¢˜ï¼Œæ‰€ä»¥å¯ä»¥å®ç° O(1) æ—¶é—´å¤æ‚åº¦çš„ add æ“ä½œã€‚</p>
<p>é‚£ä¹ˆ SelectedSelectionKeySet æ˜¯ä»€ä¹ˆæ—¶å€™ç”Ÿæˆçš„å‘¢ï¼Ÿé€šè¿‡æŸ¥æ‰¾ SelectedSelectionKeySet çš„å¼•ç”¨å®šä½åˆ° NioEventLoop#openSelector æ–¹æ³•ï¼Œæ‘˜å½•æ ¸å¿ƒæºç ç‰‡æ®µå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>private SelectorTuple openSelector() {

    // çœç•¥å…¶ä»–ä»£ç 

    final SelectedSelectionKeySet selectedKeySet = new SelectedSelectionKeySet();

    Object maybeException = AccessController.doPrivileged(new PrivilegedAction&lt;Object&gt;() {

        @Override

        public Object run() {

            try {

                Field selectedKeysField = selectorImplClass.getDeclaredField(&quot;selectedKeys&quot;);

                Field publicSelectedKeysField = selectorImplClass.getDeclaredField(&quot;publicSelectedKeys&quot;);

                if (PlatformDependent.javaVersion() &gt;= 9 &amp;&amp; PlatformDependent.hasUnsafe()) {

                    long selectedKeysFieldOffset = PlatformDependent.objectFieldOffset(selectedKeysField);

                    long publicSelectedKeysFieldOffset =

                            PlatformDependent.objectFieldOffset(publicSelectedKeysField);

                    if (selectedKeysFieldOffset != -1 &amp;&amp; publicSelectedKeysFieldOffset != -1) {

                        PlatformDependent.putObject(

                                unwrappedSelector, selectedKeysFieldOffset, selectedKeySet);

                        PlatformDependent.putObject(

                                unwrappedSelector, publicSelectedKeysFieldOffset, selectedKeySet);

                        return null;

                    }

                }

                // çœç•¥å…¶ä»–ä»£ç 

            } catch (NoSuchFieldException e) {

                return e;

            } catch (IllegalAccessException e) {

                return e;

            }

        }

    });    

    // çœç•¥å…¶ä»–ä»£ç 

}
</code></pre><p>Netty é€šè¿‡åå°„çš„æ–¹å¼ï¼Œå°† Selector å¯¹è±¡å†…éƒ¨çš„ selectedKeys å’Œ publicSelectedKeys æ›¿æ¢ä¸º SelectedSelectionKeySetï¼ŒåŸå…ˆ selectedKeys å’Œ publicSelectedKeys è¿™ä¸¤ä¸ªå­—æ®µéƒ½æ˜¯ HashSet ç±»å‹ã€‚è¿™çœŸæ˜¯å¾ˆæ£’çš„ä¸€ä¸ªå°æŠ€å·§ï¼Œå¯¹äº JDK åº•å±‚çš„ä¼˜åŒ–ä¸€èˆ¬æ˜¯å¾ˆå°‘è§çš„ï¼ŒNetty åœ¨ç»†èŠ‚ä¼˜åŒ–ä¸Šè¿½æ±‚æè‡´çš„ç²¾ç¥å€¼å¾—æˆ‘ä»¬å­¦ä¹ ã€‚</p>
<p>åˆ°è¿™é‡Œï¼ŒReactor çº¿ç¨‹ä¸»æµç¨‹çš„ç¬¬äºŒæ­¥ã€‚å¤„ç† I/O äº‹ä»¶ processSelectedKeys å·²ç»è®²å®Œäº†ï¼Œç®€å•æ€»ç»“ä¸€ä¸‹ processSelectedKeys çš„è¦ç‚¹ã€‚å¤„ç† I/O äº‹ä»¶æ—¶æœ‰ä¸¤ç§é€‰æ‹©ï¼Œä¸€ç§æ˜¯å¤„ç† Netty ä¼˜åŒ–è¿‡çš„ selectedKeysï¼Œå¦å¤–ä¸€ç§æ˜¯æ­£å¸¸çš„å¤„ç†é€»è¾‘ï¼Œä¸¤ç§ç­–ç•¥çš„å¤„ç†é€»è¾‘æ˜¯ç›¸ä¼¼çš„ï¼Œéƒ½æ˜¯é€šè¿‡è·å– SelectionKey ä¸ŠæŒ‚è½½çš„ attachment åˆ¤æ–­ SelectionKey çš„ç±»å‹ï¼Œä¸åŒçš„ SelectionKey çš„ç±»å‹åˆä¼šè°ƒç”¨ä¸åŒçš„å¤„ç†æ–¹æ³•ï¼Œç„¶åé€šè¿‡ Pipeline è¿›è¡Œäº‹ä»¶ä¼ æ’­ã€‚Netty ä¼˜åŒ–è¿‡çš„ selectedKeys æ˜¯ä½¿ç”¨æ•°ç»„å­˜å‚¨çš„ SelectionKeyï¼Œç›¸æ¯”äº JDK çš„ HashSet éå†æ•ˆç‡æ›´é«˜æ•ˆã€‚processSelectedKeys è¿˜åšäº†æ›´å¤šçš„ä¼˜åŒ–å¤„ç†ï¼Œå¦‚æœå‘ç°è¶…è¿‡é»˜è®¤é˜ˆå€¼ 256 ä¸ª Channel ä» Selector å¯¹è±¡ä¸­ç§»é™¤åï¼Œä¼šé‡æ–°åšä¸€æ¬¡è½®è¯¢æ“ä½œï¼Œä»¥ç¡®ä¿ keySet çš„æœ‰æ•ˆæ€§ã€‚</p>
<h4 id="å¤„ç†å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—">å¤„ç†å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—</h4>
<p>ç»§ç»­åˆ†æ Reactor çº¿ç¨‹ä¸»æµç¨‹çš„æœ€åä¸€æ­¥ï¼Œå¤„ç†å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ— runAllTasksã€‚ä¸ºä»€ä¹ˆ Netty èƒ½å¤Ÿä¿è¯ Channel çš„æ“ä½œéƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„å‘¢ï¼Ÿè¿™è¦å½’åŠŸäº Netty çš„ä»»åŠ¡æœºåˆ¶ã€‚ä¸‹é¢æˆ‘ä»¬ä»ä»»åŠ¡æ·»åŠ å’Œä»»åŠ¡æ‰§è¡Œä¸¤ä¸ªæ–¹é¢ä»‹ç» Netty çš„ä»»åŠ¡æœºåˆ¶ã€‚</p>
<ul>
<li><strong>ä»»åŠ¡æ·»åŠ </strong></li>
</ul>
<p>NioEventLoop å†…éƒ¨æœ‰ä¸¤ä¸ªéå¸¸é‡è¦çš„å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œåˆ†åˆ«ä¸ºæ™®é€šä»»åŠ¡é˜Ÿåˆ—å’Œå®šæ—¶ä»»åŠ¡é˜Ÿåˆ—ã€‚NioEventLoop æä¾›äº† execute() å’Œ schedule() æ–¹æ³•ç”¨äºå‘ä¸åŒçš„é˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡ï¼Œexecute() ç”¨äºæ·»åŠ æ™®é€šä»»åŠ¡ï¼Œschedule() æ–¹æ³•ç”¨äºæ·»åŠ å®šæ—¶ä»»åŠ¡ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬çœ‹ä¸‹å¦‚ä½•æ·»åŠ æ™®é€šä»»åŠ¡ã€‚NioEventLoop ç»§æ‰¿è‡ª SingleThreadEventExecutorï¼ŒSingleThreadEventExecutor æä¾›äº† execute() ç”¨äºæ·»åŠ æ™®é€šä»»åŠ¡ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>public void execute(Runnable task) {

    if (task == null) {

        throw new NullPointerException(&quot;task&quot;);

    }

    boolean inEventLoop = inEventLoop();

    addTask(task);

    if (!inEventLoop) {

        startThread();

        if (isShutdown()) {

            boolean reject = false;

            try {

                if (removeTask(task)) {

                    reject = true;

                }

            } catch (UnsupportedOperationException e) {

            }

            if (reject) {

                reject();

            }

        }

    }

    if (!addTaskWakesUp &amp;&amp; wakesUpForTask(task)) {

        wakeup(inEventLoop);

    }

}

protected void addTask(Runnable task) {

    if (task == null) {

        throw new NullPointerException(&quot;task&quot;);

    }

    if (!offerTask(task)) {

        reject(task);

    }

}

final boolean offerTask(Runnable task) {

    if (isShutdown()) {

        reject();

    }

    return taskQueue.offer(task);

}
</code></pre><p>æˆ‘ä»¬ä¸€æ­¥æ­¥è·Ÿè¿› addTask(task)ï¼Œå‘ç°æœ€åæ˜¯å°†ä»»åŠ¡æ·»åŠ åˆ°äº† taskQueueï¼ŒSingleThreadEventExecutor ä¸­ taskQueue å°±æ˜¯æ™®é€šä»»åŠ¡é˜Ÿåˆ—ã€‚taskQueue é»˜è®¤ä½¿ç”¨çš„æ˜¯ Mpsc Queueï¼Œå¯ä»¥ç†è§£ä¸ºå¤šç”Ÿäº§è€…å•æ¶ˆè´¹è€…é˜Ÿåˆ—ï¼Œå…³äº Mpsc Queue æˆ‘ä»¬ä¼šæœ‰ä¸€èŠ‚è¯¾ç¨‹å•ç‹¬ä»‹ç»ï¼Œåœ¨è¿™é‡Œä¸è¯¦ç»†å±•å¼€ã€‚æ­¤å¤–ï¼Œåœ¨ä»»åŠ¡å¤„ç†çš„åœºæ™¯ä¸‹ï¼ŒinEventLoop() å§‹ç»ˆæ˜¯è¿”å› trueï¼Œå§‹ç»ˆéƒ½æ˜¯åœ¨ Reactor çº¿ç¨‹å†…æ‰§è¡Œï¼Œæ—¢ç„¶åœ¨ Reactor çº¿ç¨‹å†…éƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œï¼Œå¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜éœ€è¦ Mpsc Queue å‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ã€‚</p>
<p>è¿™é‡Œä¸¾ä¸€ç§å¾ˆå¸¸è§çš„åœºæ™¯ï¼Œæ¯”å¦‚åœ¨ RPC ä¸šåŠ¡çº¿ç¨‹æ± é‡Œå¤„ç†å®Œä¸šåŠ¡è¯·æ±‚åï¼Œå¯ä»¥æ ¹æ®ç”¨æˆ·è¯·æ±‚æ‹¿åˆ°å…³è”çš„ Channelï¼Œå°†æ•°æ®å†™å›å®¢æˆ·ç«¯ã€‚é‚£ä¹ˆå¯¹äºå¤–éƒ¨çº¿ç¨‹è°ƒç”¨ Channel çš„ç›¸å…³æ–¹æ³• Netty æ˜¯å¦‚ä½•æ“ä½œçš„å‘¢ï¼Ÿæˆ‘ä»¬ä¸€ç›´è·Ÿè¿›ä¸‹ channel.write() çš„æºç ï¼š</p>
<pre tabindex="0"><code>// #AbstractChannel#write

public ChannelFuture write(Object msg) {

    return pipeline.write(msg);

}

// AbstractChannelHandlerContext#write

private void write(Object msg, boolean flush, ChannelPromise promise) {

    // çœç•¥å…¶ä»–ä»£ç 

    final AbstractChannelHandlerContext next = findContextOutbound(flush ?

            (MASK_WRITE | MASK_FLUSH) : MASK_WRITE);

    final Object m = pipeline.touch(msg, next);

    EventExecutor executor = next.executor();

    if (executor.inEventLoop()) { // Reactor çº¿ç¨‹å†…éƒ¨è°ƒç”¨

        if (flush) {

            next.invokeWriteAndFlush(m, promise);

        } else {

            next.invokeWrite(m, promise);

        }

    } else { // å¤–éƒ¨çº¿ç¨‹è°ƒç”¨ä¼šèµ°åˆ°è¯¥åˆ†æ”¯

        final AbstractWriteTask task;

        if (flush) {

            task = WriteAndFlushTask.newInstance(next, m, promise);

        }  else {

            task = WriteTask.newInstance(next, m, promise);

        }

        if (!safeExecute(executor, task, promise, m)) {

            task.cancel();

        }

    }

}

// AbstractChannelHandlerContext#safeExecute

private static boolean safeExecute(EventExecutor executor, Runnable runnable, ChannelPromise promise, Object msg) {

    try {

        executor.execute(runnable);

        return true;

    } catch (Throwable cause) {

        try {

            promise.setFailure(cause);

        } finally {

            if (msg != null) {

                ReferenceCountUtil.release(msg);

            }

        }

        return false;

    }

}
</code></pre><p>å¦‚æœæ˜¯ Reactor çº¿ç¨‹å‘èµ·è°ƒç”¨ channel.write() æ–¹æ³•ï¼ŒinEventLoop() è¿”å› trueï¼Œæ­¤æ—¶ç›´æ¥åœ¨ Reactor çº¿ç¨‹å†…éƒ¨ç›´æ¥äº¤ç”± Pipeline è¿›è¡Œäº‹ä»¶å¤„ç†ã€‚å¦‚æœæ˜¯å¤–éƒ¨çº¿ç¨‹è°ƒç”¨ï¼Œé‚£ä¹ˆä¼šèµ°åˆ° else åˆ†æ”¯ï¼Œæ­¤æ—¶ä¼šå°†å†™æ“ä½œå°è£…æˆä¸€ä¸ª WriteTaskï¼Œç„¶åé€šè¿‡ safeExecute() æ‰§è¡Œï¼Œå¯ä»¥å‘ç° safeExecute() å°±æ˜¯è°ƒç”¨çš„ SingleThreadEventExecutor#execute() æ–¹æ³•ï¼Œæœ€ç»ˆä¼šå°†ä»»åŠ¡æ·»åŠ åˆ° taskQueue ä¸­ã€‚å› ä¸ºå¤šä¸ªå¤–éƒ¨çº¿ç¨‹å¯èƒ½ä¼šå¹¶å‘æ“ä½œåŒä¸€ä¸ª Channelï¼Œè¿™æ—¶å€™ Mpsc Queue å°±å¯ä»¥ä¿è¯çº¿ç¨‹çš„å®‰å…¨æ€§ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å†åˆ†æå®šæ—¶ä»»åŠ¡çš„æ·»åŠ è¿‡ç¨‹ã€‚ä¸æ™®é€šä»»åŠ¡ç±»ä¼¼ï¼Œå®šæ—¶ä»»åŠ¡ä¹Ÿä¼šæœ‰ Reactor çº¿ç¨‹å†…å’Œå¤–éƒ¨çº¿ç¨‹ä¸¤ç§åœºæ™¯ï¼Œæˆ‘ä»¬ç›´æ¥è·Ÿè¿›åˆ° AbstractScheduledEventExecutor#schedule() æºç çš„æ·±å±‚ï¼Œå‘ç°å¦‚ä¸‹æ ¸å¿ƒä»£ç ï¼š</p>
<pre tabindex="0"><code>private &lt;V&gt; ScheduledFuture&lt;V&gt; schedule(final ScheduledFutureTask&lt;V&gt; task) {

    if (inEventLoop()) { // Reactor çº¿ç¨‹å†…éƒ¨

        scheduledTaskQueue().add(task.setId(nextTaskId++));

    } else { // å¤–éƒ¨çº¿ç¨‹

        executeScheduledRunnable(new Runnable() {

            @Override

            public void run() {

                scheduledTaskQueue().add(task.setId(nextTaskId++));

            }

        }, true, task.deadlineNanos());

    }

    return task;

}

PriorityQueue&lt;ScheduledFutureTask&lt;?&gt;&gt; scheduledTaskQueue() {

    if (scheduledTaskQueue == null) {

        scheduledTaskQueue = new DefaultPriorityQueue&lt;ScheduledFutureTask&lt;?&gt;&gt;(

                SCHEDULED_FUTURE_TASK_COMPARATOR,

                11);

    }

    return scheduledTaskQueue;

}

void executeScheduledRunnable(Runnable runnable,

                                        @SuppressWarnings(&quot;unused&quot;) boolean isAddition,

                                        @SuppressWarnings(&quot;unused&quot;) long deadlineNanos) {

    execute(runnable);

}
</code></pre><p>AbstractScheduledEventExecutor ä¸­ scheduledTaskQueue å°±æ˜¯å®šæ—¶ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¯ä»¥çœ‹åˆ° scheduledTaskQueue çš„é»˜è®¤å®ç°æ˜¯ä¼˜å…ˆçº§é˜Ÿåˆ— DefaultPriorityQueueï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æŒ‰ç…§æ—¶é—´è¿›è¡Œæ’åºã€‚ä½†æ˜¯ DefaultPriorityQueue æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œå¦‚æœæ˜¯ Reactor çº¿ç¨‹å†…éƒ¨è°ƒç”¨ï¼Œå› ä¸ºæ˜¯ä¸²è¡Œæ‰§è¡Œï¼Œæ‰€ä»¥ä¸ä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚å¦‚æœæ˜¯å¤–éƒ¨çº¿ç¨‹æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼Œæˆ‘ä»¬å‘ç° Netty æŠŠæ·»åŠ å®šæ—¶ä»»åŠ¡çš„æ“ä½œåˆå†æ¬¡å°è£…æˆä¸€ä¸ªä»»åŠ¡äº¤ç”± executeScheduledRunnable() å¤„ç†ï¼Œè€Œ executeScheduledRunnable() ä¸­åˆå†æ¬¡è°ƒç”¨äº†æ™®é€šä»»åŠ¡çš„ execute() çš„æ–¹æ³•ï¼Œå·§å¦™åœ°å€ŸåŠ©æ™®é€šä»»åŠ¡åœºæ™¯ä¸­ Mpsc Queue è§£å†³äº†å¤–éƒ¨çº¿ç¨‹æ·»åŠ å®šæ—¶ä»»åŠ¡çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p>
<ul>
<li><strong>ä»»åŠ¡æ‰§è¡Œ</strong></li>
</ul>
<p>ä»‹ç»å®Œ Netty ä¸­ä¸åŒä»»åŠ¡çš„æ·»åŠ è¿‡ç¨‹ï¼Œå›è¿‡å¤´æˆ‘ä»¬å†æ¥åˆ†æ Reactor çº¿ç¨‹æ˜¯å¦‚ä½•æ‰§è¡Œè¿™äº›ä»»åŠ¡çš„å‘¢ï¼Ÿé€šè¿‡ Reactor çº¿ç¨‹ä¸»æµç¨‹çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“å¤„ç†å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—æœ‰ runAllTasks() å’Œ runAllTasks(long timeoutNanos) ä¸¤ç§å®ç°ï¼Œç¬¬ä¸€ç§ä¼šå¤„ç†æ‰€æœ‰ä»»åŠ¡ï¼Œç¬¬äºŒç§æ˜¯å¸¦æœ‰è¶…æ—¶æ—¶é—´æ¥å¤„ç†ä»»åŠ¡ã€‚ä¹‹æ‰€ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´æ˜¯ä¸ºäº†é˜²æ­¢ Reactor çº¿ç¨‹å¤„ç†ä»»åŠ¡æ—¶é—´è¿‡é•¿è€Œå¯¼è‡´ I/O äº‹ä»¶é˜»å¡ï¼Œæˆ‘ä»¬ç€é‡åˆ†æä¸‹ runAllTasks(long timeoutNanos) çš„æºç ï¼š</p>
<pre tabindex="0"><code>protected boolean runAllTasks(long timeoutNanos) {

    fetchFromScheduledTaskQueue(); // 1. åˆå¹¶å®šæ—¶ä»»åŠ¡åˆ°æ™®é€šä»»åŠ¡é˜Ÿåˆ—

    // 2. ä»æ™®é€šä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡å¹¶å¤„ç†

    Runnable task = pollTask();

    if (task == null) {

        afterRunningAllTasks();

        return false;

    }

    // è®¡ç®—ä»»åŠ¡å¤„ç†çš„è¶…æ—¶æ—¶é—´

    final long deadline = ScheduledFutureTask.nanoTime() + timeoutNanos;

    long runTasks = 0;

    long lastExecutionTime;

    for (;;) {

        safeExecute(task); // æ‰§è¡Œä»»åŠ¡

        runTasks ++;

        // æ¯æ‰§è¡Œ 64 ä¸ªä»»åŠ¡æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦è¶…æ—¶

        if ((runTasks &amp; 0x3F) == 0) {

            lastExecutionTime = ScheduledFutureTask.nanoTime();

            if (lastExecutionTime &gt;= deadline) {

                break;

            }

        }

        task = pollTask(); // ç»§ç»­å–å‡ºä¸‹ä¸€ä¸ªä»»åŠ¡

        if (task == null) {

            lastExecutionTime = ScheduledFutureTask.nanoTime();

            break;

        }

    }

    // 3. æ”¶å°¾å·¥ä½œ

    afterRunningAllTasks();

    this.lastExecutionTime = lastExecutionTime;

    return true;

}
</code></pre><p>å¼‚æ­¥ä»»åŠ¡å¤„ç† runAllTasks çš„è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸‰æ­¥ï¼šåˆå¹¶å®šæ—¶ä»»åŠ¡åˆ°æ™®é€šä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åä»æ™®é€šä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡å¹¶å¤„ç†ï¼Œæœ€åè¿›è¡Œæ”¶å°¾å·¥ä½œã€‚æˆ‘ä»¬åˆ†åˆ«çœ‹çœ‹ä¸‰ä¸ªæ­¥éª¤éƒ½æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<p>ç¬¬ä¸€æ­¥ï¼Œåˆå¹¶å®šæ—¶ä»»åŠ¡åˆ°æ™®é€šä»»åŠ¡é˜Ÿåˆ—ï¼Œå¯¹åº”çš„å®ç°æ˜¯ fetchFromScheduledTaskQueue() æ–¹æ³•ã€‚</p>
<pre tabindex="0"><code>private boolean fetchFromScheduledTaskQueue() {

    if (scheduledTaskQueue == null || scheduledTaskQueue.isEmpty()) {

        return true;

    }

    long nanoTime = AbstractScheduledEventExecutor.nanoTime();

    for (;;) {

        Runnable scheduledTask = pollScheduledTask(nanoTime); // ä»å®šæ—¶ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºæˆªæ­¢æ—¶é—´å°äºç­‰äºå½“å‰æ—¶é—´çš„å®šæ—¶ä»»åŠ¡

        if (scheduledTask == null) {

            return true;

        }

        if (!taskQueue.offer(scheduledTask)) {

            // å¦‚æœæ™®é€šä»»åŠ¡é˜Ÿåˆ—å·²æ»¡ï¼ŒæŠŠå®šæ—¶ä»»åŠ¡æ”¾å›

            scheduledTaskQueue.add((ScheduledFutureTask&lt;?&gt;) scheduledTask);

            return false;

        }

    }

}

protected final Runnable pollScheduledTask(long nanoTime) {

    assert inEventLoop();

    Queue&lt;ScheduledFutureTask&lt;?&gt;&gt; scheduledTaskQueue = this.scheduledTaskQueue;

    ScheduledFutureTask&lt;?&gt; scheduledTask = scheduledTaskQueue == null ? null : scheduledTaskQueue.peek();

    // å¦‚æœå®šæ—¶ä»»åŠ¡çš„ deadlineNanos å°äºå½“å‰æ—¶é—´å°±å–å‡º

    if (scheduledTask == null || scheduledTask.deadlineNanos() - nanoTime &gt; 0) {

        return null;

    }

    scheduledTaskQueue.remove();

    return scheduledTask;

}
</code></pre><p>å®šæ—¶ä»»åŠ¡åªæœ‰æ»¡è¶³æˆªæ­¢æ—¶é—´ deadlineNanos å°äºå½“å‰æ—¶é—´ï¼Œæ‰å¯ä»¥å–å‡ºåˆå¹¶åˆ°æ™®é€šä»»åŠ¡ã€‚ç”±äºå®šæ—¶ä»»åŠ¡æ˜¯æŒ‰ç…§æˆªæ­¢æ—¶é—´ deadlineNanos ä»å°åˆ°å¤§æ’åˆ—çš„ï¼Œæ‰€ä»¥å–å‡ºçš„å®šæ—¶ä»»åŠ¡ä¸æ»¡è¶³åˆå¹¶æ¡ä»¶ï¼Œé‚£ä¹ˆå®šæ—¶ä»»åŠ¡é˜Ÿåˆ—ä¸­å‰©ä¸‹çš„æ‰€æœ‰ä»»åŠ¡éƒ½ä¸ä¼šæ»¡è¶³æ¡ä»¶ï¼Œåˆå¹¶æ“ä½œå®Œæˆå¹¶é€€å‡ºã€‚</p>
<p>ç¬¬äºŒæ­¥ï¼Œä»æ™®é€šä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡å¹¶å¤„ç†ï¼Œå¯ä»¥å›è¿‡å¤´å†çœ‹ runAllTasks(long timeoutNanos) ç¬¬äºŒéƒ¨åˆ†çš„æºç ï¼Œæˆ‘å·²ç»ç”¨æ³¨é‡Šæ ‡æ˜ã€‚çœŸæ­£å¤„ç†ä»»åŠ¡çš„ safeExecute() éå¸¸ç®€å•ï¼Œå°±æ˜¯ç›´æ¥è°ƒç”¨çš„ Runnable çš„ run() æ–¹æ³•ã€‚å› ä¸ºå¼‚æ­¥ä»»åŠ¡å¤„ç†æ˜¯æœ‰è¶…æ—¶æ—¶é—´çš„ï¼Œæ‰€ä»¥ Netty é‡‡å–äº†å®šæ—¶æ£€æµ‹çš„ç­–ç•¥ï¼Œæ¯æ‰§è¡Œ 64 ä¸ªä»»åŠ¡çš„æ—¶å€™å°±ä¼šæ£€æŸ¥ä¸€ä¸‹æ˜¯å¦è¶…æ—¶ï¼Œè¿™ä¹Ÿæ˜¯å‡ºäºå¯¹æ€§èƒ½çš„æŠ˜ä¸­è€ƒè™‘ï¼Œå¦‚æœå¼‚æ­¥é˜Ÿåˆ—ä¸­æœ‰å¤§é‡çš„çŸ­æ—¶é—´ä»»åŠ¡ï¼Œæ¯ä¸€æ¬¡æ‰§è¡Œå®Œéƒ½æ£€æµ‹ä¸€æ¬¡è¶…æ—¶æ€§èƒ½ä¼šæœ‰æ‰€é™ä½ã€‚</p>
<p>ç¬¬ä¸‰æ­¥ï¼Œæ”¶å°¾å·¥ä½œï¼Œå¯¹åº”çš„æ˜¯ afterRunningAllTasks() æ–¹æ³•å®ç°ã€‚</p>
<pre tabindex="0"><code>protected void afterRunningAllTasks() {

    runAllTasksFrom(tailTasks);

}

protected final boolean runAllTasksFrom(Queue&lt;Runnable&gt; taskQueue) {

    Runnable task = pollTaskFrom(taskQueue);

    if (task == null) {

        return false;

    }

    for (;;) {

        safeExecute(task);

        task = pollTaskFrom(taskQueue);

        if (task == null) {

            return true;

        }

    }

}
</code></pre><p>è¿™é‡Œçš„å°¾éƒ¨é˜Ÿåˆ— tailTasks ç›¸æ¯”äºæ™®é€šä»»åŠ¡é˜Ÿåˆ—ä¼˜å…ˆçº§è¾ƒä½ï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯æ”¶å°¾ä»»åŠ¡ï¼Œåœ¨æ¯æ¬¡æ‰§è¡Œå®Œ taskQueue ä¸­ä»»åŠ¡åä¼šå»è·å–å°¾éƒ¨é˜Ÿåˆ—ä¸­ä»»åŠ¡æ‰§è¡Œã€‚å¯ä»¥çœ‹å‡º afterRunningAllTasks() å°±æ˜¯æŠŠå°¾éƒ¨é˜Ÿåˆ— tailTasks é‡Œçš„ä»»åŠ¡ä»¥æ­¤å–å‡ºæ‰§è¡Œä¸€éã€‚å°¾éƒ¨é˜Ÿåˆ—å¹¶ä¸å¸¸ç”¨ï¼Œä¸€èˆ¬ç”¨äºä»€ä¹ˆåœºæ™¯å‘¢ï¼Ÿä¾‹å¦‚ä½ æƒ³å¯¹ Netty çš„è¿è¡ŒçŠ¶æ€åšä¸€äº›ç»Ÿè®¡æ•°æ®ï¼Œä¾‹å¦‚ä»»åŠ¡å¾ªç¯çš„è€—æ—¶ã€å ç”¨ç‰©ç†å†…å­˜çš„å¤§å°ç­‰ç­‰ï¼Œéƒ½å¯ä»¥å‘å°¾éƒ¨é˜Ÿåˆ—æ·»åŠ ä¸€ä¸ªæ”¶å°¾ä»»åŠ¡å®Œæˆç»Ÿè®¡æ•°æ®çš„å®æ—¶æ›´æ–°ã€‚</p>
<p>åˆ°è¿™é‡Œï¼ŒNetty å¤„ç†å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—çš„æµç¨‹å°±è®²å®Œäº†ï¼Œå†åšä¸€ä¸ªç®€å•çš„æ€»ç»“ã€‚å¼‚æ­¥ä»»åŠ¡ä¸»è¦åˆ†ä¸ºæ™®é€šä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡ä¸¤ç§ï¼Œåœ¨ä»»åŠ¡æ·»åŠ å’Œä»»åŠ¡æ‰§è¡Œæ—¶ï¼Œéƒ½éœ€è¦è€ƒè™‘ Reactor çº¿ç¨‹å†…å’Œå¤–éƒ¨çº¿ç¨‹ä¸¤ç§æƒ…å†µã€‚å¤–éƒ¨çº¿ç¨‹æ·»åŠ å®šæ—¶ä»»åŠ¡æ—¶ï¼ŒNetty å·§å¦™åœ°å€ŸåŠ©æ™®é€šä»»åŠ¡çš„ Mpsc Queue è§£å†³å¤šçº¿ç¨‹å¹¶å‘æ“ä½œæ—¶çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚Netty æ‰§è¡Œä»»åŠ¡ä¹‹å‰ä¼šå°†æ»¡è¶³æ¡ä»¶çš„å®šæ—¶ä»»åŠ¡åˆå¹¶åˆ°æ™®é€šä»»åŠ¡é˜Ÿåˆ—ï¼Œç”±æ™®é€šä»»åŠ¡é˜Ÿåˆ—ç»Ÿä¸€è´Ÿè´£æ‰§è¡Œï¼Œå¹¶ä¸”æ¯æ‰§è¡Œ 64 ä¸ªä»»åŠ¡çš„æ—¶å€™å°±ä¼šæ£€æŸ¥ä¸€ä¸‹æ˜¯å¦è¶…æ—¶ã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>Reactor çº¿ç¨‹æ¨¡å‹æ˜¯ Netty æœ€æ ¸å¿ƒçš„å†…å®¹ï¼Œæœ¬èŠ‚è¯¾æˆ‘ä¹ŸèŠ±äº†å¤§é‡çš„ç¯‡å¹…å¯¹å…¶è¿›è¡Œè®²è§£ã€‚NioEventLoop ä½œä¸º Netty Reactor çº¿ç¨‹çš„å®ç°ï¼Œå®ƒçš„è®¾è®¡åŸç†æ˜¯éå¸¸ç²¾å¦™çš„ï¼Œå€¼å¾—æˆ‘ä»¬åå¤é˜…è¯»å’Œæ€è€ƒã€‚æˆ‘ä»¬å§‹ç»ˆéœ€è¦è®°ä½ NioEventLoop çš„æ— é™å¾ªç¯ä¸­æ‰€åšçš„ä¸‰ä»¶äº‹ï¼šè½®è¯¢ I/O äº‹ä»¶ï¼Œå¤„ç† I/O äº‹ä»¶ï¼Œå¤„ç†å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ã€‚</p>
<p>å…³äº Netty Reactor çº¿ç¨‹æ¨¡å‹ç»å¸¸ä¼šé‡åˆ°å‡ ä¸ªé«˜é¢‘çš„é¢è¯•é—®é¢˜ï¼Œè¯»å®Œæœ¬èŠ‚è¯¾ä¹‹åä½ æ˜¯å¦éƒ½å·²ç»æ¸…æ¥šäº†å‘¢ï¼Ÿ</p>
<ul>
<li>Netty çš„ NioEventLoop æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿå®ƒä¸ºä»€ä¹ˆèƒ½å¤Ÿä¿è¯ Channel çš„æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Ÿ</li>
<li>Netty å¦‚ä½•è§£å†³ JDK epoll ç©ºè½®è¯¢ Bugï¼Ÿ</li>
<li>NioEventLoop æ˜¯å¦‚ä½•å®ç°æ— é”åŒ–çš„ï¼Ÿ</li>
</ul>
<p>æ¬¢è¿ä½ åœ¨è¯„è®ºåŒºç•™è¨€ï¼ŒæœŸå¾…çœ‹åˆ°ä½ åˆ†äº«å…³äº Reactor çº¿ç¨‹æ¨¡å‹æ›´å¤šçš„è®¤è¯†å’Œæ€è€ƒã€‚</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/17-%E6%BA%90%E7%A0%81%E7%AF%87%E4%BB%8E-linux-%E5%87%BA%E5%8F%91%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"><span>17 æºç ç¯‡ï¼šä» Linux å‡ºå‘æ·±å…¥å‰–ææœåŠ¡ç«¯å¯åŠ¨æµç¨‹</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/19-%E6%BA%90%E7%A0%81%E7%AF%87%E4%B8%80%E4%B8%AA%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E5%9C%A8-netty-%E4%B8%AD%E7%9A%84%E6%97%85%E7%A8%8B/"><span>19 æºç ç¯‡ï¼šä¸€ä¸ªç½‘ç»œè¯·æ±‚åœ¨ Netty ä¸­çš„æ—…ç¨‹</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 28280 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>