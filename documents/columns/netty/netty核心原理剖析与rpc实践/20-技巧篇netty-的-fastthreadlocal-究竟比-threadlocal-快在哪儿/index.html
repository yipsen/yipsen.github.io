<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>20 æŠ€å·§ç¯‡ï¼šNetty çš„ FastThreadLocal ç©¶ç«Ÿæ¯” ThreadLocal å¿«åœ¨å“ªå„¿ï¼Ÿ | Yipsen Ye</title>
<meta name="description" content="åœ¨å‰é¢å‡ ç¯‡æºç è§£æçš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬éƒ½æœ‰åœ¨æºç ä¸­å‘ç° FastThreadLocal çš„èº«å½±ã€‚é¡¾åæ€ä¹‰ï¼ŒNetty ä½œä¸ºé«˜æ€§èƒ½çš„ç½‘ç»œé€šä¿¡æ¡†æ¶ï¼ŒFastThreadLocal æ˜¯æ¯” JDK è‡ªèº«çš„ ThreadLocal æ€§èƒ½æ›´é«˜çš„é€šä¿¡æ¡†æ¶ã€‚FastThreadLocal åˆ°åº•æ¯” ThreadLocal å¿«åœ¨å“ªé‡Œå‘¢ï¼Ÿè¿™èŠ‚è¯¾æˆ‘ä»¬å°±ä¸€èµ·æ¥æ¢ç´¢ FastThreadLocal é«˜æ€§èƒ½çš„å¥¥ç§˜ã€‚
 è¯´æ˜ï¼šæœ¬æ–‡å‚è€ƒçš„ Netty æºç ç‰ˆæœ¬ä¸º 4.1.42.Finalã€‚
 JDK ThreadLocal åŸºæœ¬åŸç† JDK ThreadLocal ä¸ä»…æ˜¯é«˜é¢‘çš„é¢è¯•çŸ¥è¯†ç‚¹ï¼Œè€Œä¸”åœ¨æ—¥å¸¸å·¥ä½œä¸­ä¹Ÿæ˜¯å¸¸ç”¨ä¸€ç§å·¥å…·ï¼Œæ‰€ä»¥é¦–å…ˆæˆ‘ä»¬å…ˆå­¦ä¹ ä¸‹ Java åŸç”Ÿçš„ ThreadLocal çš„å®ç°åŸç†ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°å¯¹æ¯”å’Œç†è§£ Netty çš„ FastThreadLocalã€‚
å¦‚æœä½ éœ€è¦å˜é‡åœ¨å¤šçº¿ç¨‹ä¹‹é—´éš”ç¦»ï¼Œæˆ–è€…åœ¨åŒçº¿ç¨‹å†…çš„ç±»å’Œæ–¹æ³•ä¸­å…±äº«ï¼Œé‚£ä¹ˆ ThreadLocal å¤§æ˜¾èº«æ‰‹çš„æ—¶å€™å°±åˆ°äº†ã€‚ThreadLocal å¯ä»¥ç†è§£ä¸ºçº¿ç¨‹æœ¬åœ°å˜é‡ï¼Œå®ƒæ˜¯ Java å¹¶å‘ç¼–ç¨‹ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªç±»ã€‚ThreadLocal ä¸ºå˜é‡åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­éƒ½åˆ›å»ºäº†ä¸€ä¸ªå‰¯æœ¬ï¼Œè¯¥å‰¯æœ¬åªèƒ½è¢«å½“å‰çº¿ç¨‹è®¿é—®ï¼Œå¤šçº¿ç¨‹ä¹‹é—´æ˜¯éš”ç¦»çš„ï¼Œå˜é‡ä¸èƒ½åœ¨å¤šçº¿ç¨‹ä¹‹é—´å…±äº«ã€‚è¿™æ ·æ¯ä¸ªçº¿ç¨‹ä¿®æ”¹å˜é‡å‰¯æœ¬æ—¶ï¼Œä¸ä¼šå¯¹å…¶ä»–çº¿ç¨‹äº§ç”Ÿå½±å“ã€‚
æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­çœ‹ä¸‹ ThreadLocal å¦‚ä½•ä½¿ç”¨ï¼š
public class ThreadLocalTest {private static final ThreadLocal&amp;lt;String&amp;gt; THREAD_NAME_LOCAL = ThreadLocal.withInitial(() -&amp;gt; Thread.currentThread().getName());private static final ThreadLocal&amp;lt;TradeOrder&amp;gt; TRADE_THREAD_LOCAL = new ThreadLocal&amp;lt;&amp;gt;();public static void main(String[] args) {for (int i = 0; i &amp;lt; 2; i&#43;&#43;) {int tradeId = i;new Thread(() -&amp;gt; {TradeOrder tradeOrder = new TradeOrder(tradeId, tradeId % 2 == 0 ?">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/netty%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e5%89%96%e6%9e%90%e4%b8%8erpc%e5%ae%9e%e8%b7%b5/">Nettyæ ¸å¿ƒåŸç†å‰–æä¸RPCå®è·µ</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/00-%E5%AD%A6%E5%A5%BD-netty%E6%98%AF%E4%BD%A0%E4%BF%AE%E7%82%BC-java-%E5%86%85%E5%8A%9F%E7%9A%84%E5%BF%85%E7%BB%8F%E4%B9%8B%E8%B7%AF/">00 å­¦å¥½ Nettyï¼Œæ˜¯ä½ ä¿®ç‚¼ Java å†…åŠŸçš„å¿…ç»ä¹‹è·¯</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/01-%E5%88%9D%E8%AF%86-netty%E4%B8%BA%E4%BB%80%E4%B9%88-netty-%E8%BF%99%E4%B9%88%E6%B5%81%E8%A1%8C/">01 åˆè¯† Nettyï¼šä¸ºä»€ä¹ˆ Netty è¿™ä¹ˆæµè¡Œï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/02-%E7%BA%B5%E8%A7%88%E5%85%A8%E5%B1%80%E6%8A%8A%E6%8F%A1-netty-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E8%84%89%E7%BB%9C/">02 çºµè§ˆå…¨å±€ï¼šæŠŠæ¡ Netty æ•´ä½“æ¶æ„è„‰ç»œ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/03-%E5%BC%95%E5%AF%BC%E5%99%A8%E4%BD%9C%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E9%83%BD%E8%A6%81%E5%81%9A%E4%BA%9B%E4%BB%80%E4%B9%88/">03 å¼•å¯¼å™¨ä½œç”¨ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¯åŠ¨éƒ½è¦åšäº›ä»€ä¹ˆï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/04-%E4%BA%8B%E4%BB%B6%E8%B0%83%E5%BA%A6%E5%B1%82%E4%B8%BA%E4%BB%80%E4%B9%88-eventloop-%E6%98%AF-netty-%E7%9A%84%E7%B2%BE%E9%AB%93/">04 äº‹ä»¶è°ƒåº¦å±‚ï¼šä¸ºä»€ä¹ˆ EventLoop æ˜¯ Netty çš„ç²¾é«“ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/05-%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92%E5%B1%82pipeline-%E5%A6%82%E4%BD%95%E5%8D%8F%E8%B0%83%E5%90%84%E7%B1%BB-handler-/">05 æœåŠ¡ç¼–æ’å±‚ï¼šPipeline å¦‚ä½•åè°ƒå„ç±» Handler ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/06-%E7%B2%98%E5%8C%85%E6%8B%86%E5%8C%85%E9%97%AE%E9%A2%98%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%95%B4%E7%9A%84%E7%BD%91%E7%BB%9C%E5%8C%85/">06 ç²˜åŒ…æ‹†åŒ…é—®é¢˜ï¼šå¦‚ä½•è·å–ä¸€ä¸ªå®Œæ•´çš„ç½‘ç»œåŒ…ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/07-%E6%8E%A5%E5%A4%B4%E6%9A%97%E8%AF%AD%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8-netty-%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E9%80%9A%E4%BF%A1/">07 æ¥å¤´æš—è¯­ï¼šå¦‚ä½•åˆ©ç”¨ Netty å®ç°è‡ªå®šä¹‰åè®®é€šä¿¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/08-%E5%BC%80%E7%AE%B1%E5%8D%B3%E7%94%A8netty-%E6%94%AF%E6%8C%81%E5%93%AA%E4%BA%9B%E5%B8%B8%E7%94%A8%E7%9A%84%E8%A7%A3%E7%A0%81%E5%99%A8/">08 å¼€ç®±å³ç”¨ï¼šNetty æ”¯æŒå“ªäº›å¸¸ç”¨çš„è§£ç å™¨ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/09-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93writeandflush-%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E5%89%96%E6%9E%90/">09 æ•°æ®ä¼ è¾“ï¼šwriteAndFlush å¤„ç†æµç¨‹å‰–æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/10-%E5%8F%8C%E5%88%83%E5%89%91%E5%90%88%E7%90%86%E7%AE%A1%E7%90%86-netty-%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98/">10 åŒåˆƒå‰‘ï¼šåˆç†ç®¡ç† Netty å †å¤–å†…å­˜</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/11-%E5%8F%A6%E8%B5%B7%E7%82%89%E7%81%B6netty-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E8%BD%BD%E4%BD%93-bytebuf-%E8%AF%A6%E8%A7%A3/">11 å¦èµ·ç‚‰ç¶ï¼šNetty æ•°æ®ä¼ è¾“è½½ä½“ ByteBuf è¯¦è§£</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/12-%E4%BB%96%E5%B1%B1%E4%B9%8B%E7%9F%B3%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%99%A8-jemalloc-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/">12 ä»–å±±ä¹‹çŸ³ï¼šé«˜æ€§èƒ½å†…å­˜åˆ†é…å™¨ jemalloc åŸºæœ¬åŸç†</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/13-%E4%B8%BE%E4%B8%80%E5%8F%8D%E4%B8%89netty-%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E8%AE%BE%E8%AE%A1%E4%B8%8A/">13 ä¸¾ä¸€åä¸‰ï¼šNetty é«˜æ€§èƒ½å†…å­˜ç®¡ç†è®¾è®¡ï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/14-%E4%B8%BE%E4%B8%80%E5%8F%8D%E4%B8%89netty-%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E8%AE%BE%E8%AE%A1%E4%B8%8B/">14 ä¸¾ä¸€åä¸‰ï¼šNetty é«˜æ€§èƒ½å†…å­˜ç®¡ç†è®¾è®¡ï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/15-%E8%BD%BB%E9%87%8F%E7%BA%A7%E5%AF%B9%E8%B1%A1%E5%9B%9E%E6%94%B6%E7%AB%99recycler-%E5%AF%B9%E8%B1%A1%E6%B1%A0%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90/">15 è½»é‡çº§å¯¹è±¡å›æ”¶ç«™ï¼šRecycler å¯¹è±¡æ± æŠ€æœ¯è§£æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/16-io-%E5%8A%A0%E9%80%9F%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%E7%9A%84-netty-%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF/">16 IO åŠ é€Ÿï¼šä¸ä¼—ä¸åŒçš„ Netty é›¶æ‹·è´æŠ€æœ¯</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/17-%E6%BA%90%E7%A0%81%E7%AF%87%E4%BB%8E-linux-%E5%87%BA%E5%8F%91%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">17 æºç ç¯‡ï¼šä» Linux å‡ºå‘æ·±å…¥å‰–ææœåŠ¡ç«¯å¯åŠ¨æµç¨‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/18-%E6%BA%90%E7%A0%81%E7%AF%87%E8%A7%A3%E5%AF%86-netty-reactor-%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/">18 æºç ç¯‡ï¼šè§£å¯† Netty Reactor çº¿ç¨‹æ¨¡å‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/19-%E6%BA%90%E7%A0%81%E7%AF%87%E4%B8%80%E4%B8%AA%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E5%9C%A8-netty-%E4%B8%AD%E7%9A%84%E6%97%85%E7%A8%8B/">19 æºç ç¯‡ï¼šä¸€ä¸ªç½‘ç»œè¯·æ±‚åœ¨ Netty ä¸­çš„æ—…ç¨‹</a></li>
                
                
                
                    <li>20 æŠ€å·§ç¯‡ï¼šNetty çš„ FastThreadLocal ç©¶ç«Ÿæ¯” ThreadLocal å¿«åœ¨å“ªå„¿ï¼Ÿ</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/21-%E6%8A%80%E5%B7%A7%E7%AF%87%E5%BB%B6%E8%BF%9F%E4%BB%BB%E5%8A%A1%E5%A4%84%E7%90%86%E7%A5%9E%E5%99%A8%E4%B9%8B%E6%97%B6%E9%97%B4%E8%BD%AE-hashedwheeltimer/">21 æŠ€å·§ç¯‡ï¼šå»¶è¿Ÿä»»åŠ¡å¤„ç†ç¥å™¨ä¹‹æ—¶é—´è½® HashedWheelTimer</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/22-%E6%8A%80%E5%B7%A7%E7%AF%87%E9%AB%98%E6%80%A7%E8%83%BD%E6%97%A0%E9%94%81%E9%98%9F%E5%88%97-mpsc-queue/">22 æŠ€å·§ç¯‡ï¼šé«˜æ€§èƒ½æ— é”é˜Ÿåˆ— Mpsc Queue</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/23-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E9%AB%98%E6%80%A7%E8%83%BD%E5%88%86%E5%B8%83%E5%BC%8F-rpc-%E6%A1%86%E6%9E%B6/">23 æ¶æ„è®¾è®¡ï¼šå¦‚ä½•å®ç°ä¸€ä¸ªé«˜æ€§èƒ½åˆ†å¸ƒå¼ RPC æ¡†æ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/24-%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E4%B8%8E%E8%AE%A2%E9%98%85%E6%90%AD%E5%BB%BA%E7%94%9F%E4%BA%A7%E8%80%85%E5%92%8C%E6%B6%88%E8%B4%B9%E8%80%85%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A1%86%E6%9E%B6/">24 æœåŠ¡å‘å¸ƒä¸è®¢é˜…ï¼šæ­å»ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åŸºç¡€æ¡†æ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/25-%E8%BF%9C%E7%A8%8B%E9%80%9A%E4%BF%A1%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE%E8%AE%BE%E8%AE%A1%E4%BB%A5%E5%8F%8A%E7%BC%96%E8%A7%A3%E7%A0%81%E7%9A%84%E5%AE%9E%E7%8E%B0/">25 è¿œç¨‹é€šä¿¡ï¼šé€šä¿¡åè®®è®¾è®¡ä»¥åŠç¼–è§£ç çš„å®ç°</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/26-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%9C%BA%E5%88%B6%E7%9A%84%E5%AE%9E%E7%8E%B0/">26 æœåŠ¡æ²»ç†ï¼šæœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡æœºåˆ¶çš„å®ç°</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/27-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%BA%E7%94%A8%E6%88%B7%E5%B1%8F%E8%94%BD-rpc-%E8%B0%83%E7%94%A8%E7%9A%84%E5%BA%95%E5%B1%82%E7%BB%86%E8%8A%82/">27 åŠ¨æ€ä»£ç†ï¼šä¸ºç”¨æˆ·å±è”½ RPC è°ƒç”¨çš„åº•å±‚ç»†èŠ‚</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/28-%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93rpc-%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93%E4%B8%8E%E8%BF%9B%E9%98%B6%E5%BB%B6%E4%BC%B8/">28 å®æˆ˜æ€»ç»“ï¼šRPC å®æˆ˜æ€»ç»“ä¸è¿›é˜¶å»¶ä¼¸</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/29-%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3netty-%E4%B8%AD%E5%BA%94%E7%94%A8%E4%BA%86%E5%93%AA%E4%BA%9B%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">29 ç¼–ç¨‹æ€æƒ³ï¼šNetty ä¸­åº”ç”¨äº†å“ªäº›è®¾è®¡æ¨¡å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/30-%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93netty-%E5%9C%A8%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">30 å®è·µæ€»ç»“ï¼šNetty åœ¨é¡¹ç›®å¼€å‘ä¸­çš„ä¸€äº›æœ€ä½³å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/31-%E7%BB%93%E6%9D%9F%E8%AF%AD-%E6%8A%80%E6%9C%AF%E6%88%90%E9%95%BF%E4%B9%8B%E8%B7%AF%E5%A6%82%E4%BD%95%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB/">31 ç»“æŸè¯­ æŠ€æœ¯æˆé•¿ä¹‹è·¯ï¼šå¦‚ä½•æ‰“é€ è‡ªå·±çš„æŠ€æœ¯ä½“ç³»</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">20 æŠ€å·§ç¯‡ï¼šNetty çš„ FastThreadLocal ç©¶ç«Ÿæ¯” ThreadLocal å¿«åœ¨å“ªå„¿ï¼Ÿ</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2021-12-22 01:54:42</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/netty/">netty</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/">Nettyæ ¸å¿ƒåŸç†å‰–æä¸RPCå®è·µ</a>
                
            </div></div>
        <div class="post-content">
            <p>åœ¨å‰é¢å‡ ç¯‡æºç è§£æçš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬éƒ½æœ‰åœ¨æºç ä¸­å‘ç° FastThreadLocal çš„èº«å½±ã€‚é¡¾åæ€ä¹‰ï¼ŒNetty ä½œä¸ºé«˜æ€§èƒ½çš„ç½‘ç»œé€šä¿¡æ¡†æ¶ï¼ŒFastThreadLocal æ˜¯æ¯” JDK è‡ªèº«çš„ ThreadLocal æ€§èƒ½æ›´é«˜çš„é€šä¿¡æ¡†æ¶ã€‚FastThreadLocal åˆ°åº•æ¯” ThreadLocal å¿«åœ¨å“ªé‡Œå‘¢ï¼Ÿè¿™èŠ‚è¯¾æˆ‘ä»¬å°±ä¸€èµ·æ¥æ¢ç´¢ FastThreadLocal é«˜æ€§èƒ½çš„å¥¥ç§˜ã€‚</p>
<blockquote>
<p>è¯´æ˜ï¼šæœ¬æ–‡å‚è€ƒçš„ Netty æºç ç‰ˆæœ¬ä¸º 4.1.42.Finalã€‚</p>
</blockquote>
<h3 id="jdk-threadlocal-åŸºæœ¬åŸç†">JDK ThreadLocal åŸºæœ¬åŸç†</h3>
<p>JDK ThreadLocal ä¸ä»…æ˜¯é«˜é¢‘çš„é¢è¯•çŸ¥è¯†ç‚¹ï¼Œè€Œä¸”åœ¨æ—¥å¸¸å·¥ä½œä¸­ä¹Ÿæ˜¯å¸¸ç”¨ä¸€ç§å·¥å…·ï¼Œæ‰€ä»¥é¦–å…ˆæˆ‘ä»¬å…ˆå­¦ä¹ ä¸‹ Java åŸç”Ÿçš„ ThreadLocal çš„å®ç°åŸç†ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°å¯¹æ¯”å’Œç†è§£ Netty çš„ FastThreadLocalã€‚</p>
<p>å¦‚æœä½ éœ€è¦å˜é‡åœ¨å¤šçº¿ç¨‹ä¹‹é—´éš”ç¦»ï¼Œæˆ–è€…åœ¨åŒçº¿ç¨‹å†…çš„ç±»å’Œæ–¹æ³•ä¸­å…±äº«ï¼Œé‚£ä¹ˆ ThreadLocal å¤§æ˜¾èº«æ‰‹çš„æ—¶å€™å°±åˆ°äº†ã€‚ThreadLocal å¯ä»¥ç†è§£ä¸ºçº¿ç¨‹æœ¬åœ°å˜é‡ï¼Œå®ƒæ˜¯ Java å¹¶å‘ç¼–ç¨‹ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªç±»ã€‚ThreadLocal ä¸ºå˜é‡åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­éƒ½åˆ›å»ºäº†ä¸€ä¸ªå‰¯æœ¬ï¼Œè¯¥å‰¯æœ¬åªèƒ½è¢«å½“å‰çº¿ç¨‹è®¿é—®ï¼Œå¤šçº¿ç¨‹ä¹‹é—´æ˜¯éš”ç¦»çš„ï¼Œå˜é‡ä¸èƒ½åœ¨å¤šçº¿ç¨‹ä¹‹é—´å…±äº«ã€‚è¿™æ ·æ¯ä¸ªçº¿ç¨‹ä¿®æ”¹å˜é‡å‰¯æœ¬æ—¶ï¼Œä¸ä¼šå¯¹å…¶ä»–çº¿ç¨‹äº§ç”Ÿå½±å“ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­çœ‹ä¸‹ ThreadLocal å¦‚ä½•ä½¿ç”¨ï¼š</p>
<pre tabindex="0"><code>public class ThreadLocalTest {

    private static final ThreadLocal&lt;String&gt; THREAD_NAME_LOCAL = ThreadLocal.withInitial(() -&gt; Thread.currentThread().getName());

    private static final ThreadLocal&lt;TradeOrder&gt; TRADE_THREAD_LOCAL = new ThreadLocal&lt;&gt;();

    public static void main(String[] args) {

        for (int i = 0; i &lt; 2; i++) {

            int tradeId = i;

            new Thread(() -&gt; {

                TradeOrder tradeOrder = new TradeOrder(tradeId, tradeId % 2 == 0 ? &quot;å·²æ”¯ä»˜&quot; : &quot;æœªæ”¯ä»˜&quot;);

                TRADE_THREAD_LOCAL.set(tradeOrder);

                System.out.println(&quot;threadName: &quot; + THREAD_NAME_LOCAL.get());

                System.out.println(&quot;tradeOrder infoï¼š&quot; + TRADE_THREAD_LOCAL.get());

            }, &quot;thread-&quot; + i).start();

        }

    }

    static class TradeOrder {

        long id;

        String status;

        public TradeOrder(int id, String status) {

            this.id = id;

            this.status = status;

        }

        @Override

        public String toString() {

            return &quot;id=&quot; + id + &quot;, status=&quot; + status;

        }

    }

}
</code></pre><p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæ„é€ äº† THREAD_NAME_LOCAL å’Œ TRADE_THREAD_LOCAL ä¸¤ä¸ª ThreadLocal å˜é‡ï¼Œåˆ†åˆ«ç”¨äºè®°å½•å½“å‰çº¿ç¨‹åç§°å’Œè®¢å•äº¤æ˜“ä¿¡æ¯ã€‚ThreadLocal æ˜¯å¯ä»¥æ”¯æŒæ³›å‹çš„ï¼ŒTHREAD_NAME_LOCAL å’Œ TRADE_THREAD_LOCAL å­˜æ”¾ String ç±»å‹å’Œ TradeOrder å¯¹è±¡ç±»å‹çš„æ•°æ®ï¼Œä½ å¯ä»¥é€šè¿‡ set()/get() æ–¹æ³•è®¾ç½®å’Œè¯»å– ThreadLocal å®ä¾‹ã€‚ä¸€èµ·çœ‹ä¸‹ç¤ºä¾‹ä»£ç çš„è¿è¡Œç»“æœï¼š</p>
<pre tabindex="0"><code>threadName: thread-0

threadName: thread-1

tradeOrder infoï¼šid=1, status=æœªæ”¯ä»˜

tradeOrder infoï¼šid=0, status=å·²æ”¯ä»˜
</code></pre><p>å¯ä»¥çœ‹å‡º thread-1 å’Œ thread-2 è™½ç„¶æ“ä½œçš„æ˜¯åŒä¸€ä¸ª ThreadLocal å¯¹è±¡ï¼Œä½†æ˜¯å®ƒä»¬å–åˆ°äº†ä¸åŒçš„çº¿ç¨‹åç§°å’Œè®¢å•äº¤æ˜“ä¿¡æ¯ã€‚é‚£ä¹ˆä¸€ä¸ªçº¿ç¨‹å†…å¦‚ä½•å­˜åœ¨å¤šä¸ª ThreadLocal å¯¹è±¡ï¼Œæ¯ä¸ª ThreadLocal å¯¹è±¡æ˜¯å¦‚ä½•å­˜å‚¨å’Œæ£€ç´¢çš„å‘¢ï¼Ÿ</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ ThreadLocal çš„å®ç°åŸç†ã€‚æ—¢ç„¶å¤šçº¿ç¨‹è®¿é—® ThreadLocal å˜é‡æ—¶éƒ½ä¼šæœ‰è‡ªå·±ç‹¬ç«‹çš„å®ä¾‹å‰¯æœ¬ï¼Œé‚£ä¹ˆå¾ˆå®¹æ˜“æƒ³åˆ°çš„æ–¹æ¡ˆå°±æ˜¯åœ¨ ThreadLocal ä¸­ç»´æŠ¤ä¸€ä¸ª Mapï¼Œè®°å½•çº¿ç¨‹ä¸å®ä¾‹ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚å½“æ–°å¢çº¿ç¨‹å’Œé”€æ¯çº¿ç¨‹æ—¶éƒ½éœ€è¦æ›´æ–° Map ä¸­çš„æ˜ å°„å…³ç³»ï¼Œå› ä¸ºä¼šå­˜åœ¨å¤šçº¿ç¨‹å¹¶å‘ä¿®æ”¹ï¼Œæ‰€ä»¥éœ€è¦ä¿è¯ Map æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚é‚£ä¹ˆ JDK çš„ ThreadLocal æ˜¯è¿™ä¹ˆå®ç°çš„å—ï¼Ÿç­”æ¡ˆæ˜¯ NOã€‚å› ä¸ºåœ¨é«˜å¹¶å‘çš„åœºæ™¯å¹¶å‘ä¿®æ”¹ Map éœ€è¦åŠ é”ï¼ŒåŠ¿å¿…ä¼šé™ä½æ€§èƒ½ã€‚JDK ä¸ºäº†é¿å…åŠ é”ï¼Œé‡‡ç”¨äº†ç›¸åçš„è®¾è®¡æ€è·¯ã€‚ä»¥ Thread å…¥æ‰‹ï¼Œåœ¨ Thread ä¸­ç»´æŠ¤ä¸€ä¸ª Mapï¼Œè®°å½• ThreadLocal ä¸å®ä¾‹ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œè¿™æ ·åœ¨åŒä¸€ä¸ªçº¿ç¨‹å†…ï¼ŒMap å°±ä¸éœ€è¦åŠ é”äº†ã€‚ç¤ºä¾‹ä»£ç ä¸­çº¿ç¨‹ Thread å’Œ ThreadLocal çš„å…³ç³»å¯ä»¥ç”¨ä»¥ä¸‹è¿™å¹…å›¾è¡¨ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/CgpVE1_qwuqAN-08AAkfe67UOIA904.png" alt="Drawing 0.png"></p>
<p>é‚£ä¹ˆåœ¨ Thread å†…éƒ¨ï¼Œç»´æŠ¤æ˜ å°„å…³ç³»çš„ Map æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿä»æºç ä¸­å¯ä»¥å‘ç° Thread ä½¿ç”¨çš„æ˜¯ ThreadLocal çš„å†…éƒ¨ç±» ThreadLocalMapï¼Œæ‰€ä»¥ Threadã€ThreadLocal å’Œ ThreadLocalMap ä¹‹é—´çš„å…³ç³»å¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F_qwvCAauqfAAI07PytbZY507.png" alt="Drawing 1.png"></p>
<p>ä¸ºäº†æ›´åŠ æ·±å…¥ç†è§£ ThreadLocalï¼Œäº†è§£ ThreadLocalMap çš„å†…éƒ¨å®ç°æ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚ThreadLocalMap å…¶å®ä¸ HashMap çš„æ•°æ®ç»“æ„ç±»ä¼¼ï¼Œä½†æ˜¯ ThreadLocalMap ä¸å…·å¤‡é€šç”¨æ€§ï¼Œå®ƒæ˜¯ä¸º ThreadLocal é‡èº«å®šåˆ¶çš„ã€‚</p>
<p>ThreadLocalMap æ˜¯ä¸€ç§ä½¿ç”¨çº¿æ€§æ¢æµ‹æ³•å®ç°çš„å“ˆå¸Œè¡¨ï¼Œåº•å±‚é‡‡ç”¨æ•°ç»„å­˜å‚¨æ•°æ®ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒThreadLocalMap ä¼šåˆå§‹åŒ–ä¸€ä¸ªé•¿åº¦ä¸º 16 çš„ Entry æ•°ç»„ï¼Œæ¯ä¸ª Entry å¯¹è±¡ç”¨äºä¿å­˜ key-value é”®å€¼å¯¹ã€‚ä¸ HashMap ä¸åŒçš„æ˜¯ï¼ŒEntry çš„ key å°±æ˜¯ ThreadLocal å¯¹è±¡æœ¬èº«ï¼Œvalue å°±æ˜¯ç”¨æˆ·å…·ä½“éœ€è¦å­˜å‚¨çš„å€¼ã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F_qwveAHxDEAASdhRTxzyk624.png" alt="Drawing 2.png"></p>
<p>å½“è°ƒç”¨ ThreadLocal.set() æ·»åŠ  Entry å¯¹è±¡æ—¶ï¼Œæ˜¯å¦‚ä½•è§£å†³ Hash å†²çªçš„å‘¢ï¼Ÿè¿™å°±éœ€è¦æˆ‘ä»¬äº†è§£çº¿æ€§æ¢æµ‹æ³•çš„å®ç°åŸç†ã€‚æ¯ä¸ª ThreadLocal åœ¨åˆå§‹åŒ–æ—¶éƒ½ä¼šæœ‰ä¸€ä¸ª Hash å€¼ä¸º threadLocalHashCodeï¼Œæ¯å¢åŠ ä¸€ä¸ª ThreadLocalï¼Œ Hash å€¼å°±ä¼šå›ºå®šå¢åŠ ä¸€ä¸ªé­”æœ¯ HASH_INCREMENT = 0x61c88647ã€‚ä¸ºä»€ä¹ˆå– 0x61c88647 è¿™ä¸ªé­”æ•°å‘¢ï¼Ÿå®éªŒè¯æ˜ï¼Œé€šè¿‡ 0x61c88647 ç´¯åŠ ç”Ÿæˆçš„ threadLocalHashCode ä¸ 2 çš„å¹‚å–æ¨¡ï¼Œå¾—åˆ°çš„ç»“æœå¯ä»¥è¾ƒä¸ºå‡åŒ€åœ°åˆ†å¸ƒåœ¨é•¿åº¦ä¸º 2 çš„å¹‚å¤§å°çš„æ•°ç»„ä¸­ã€‚æœ‰äº† threadLocalHashCode çš„åŸºç¡€ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„è¡¨æ ¼æ¥å…·ä½“è®²è§£çº¿æ€§æ¢æµ‹æ³•æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/CgqCHl_qyZGABbMMAACKf1C8HLE741.png" alt="å›¾ç‰‡2.png"></p>
<p>ä¸ºäº†ä¾¿äºç†è§£ï¼Œæˆ‘ä»¬é‡‡ç”¨ä¸€ç»„ç®€å•çš„æ•°æ®æ¨¡æ‹Ÿ ThreadLocal.set() çš„è¿‡ç¨‹æ˜¯å¦‚ä½•è§£å†³ Hash å†²çªçš„ã€‚</p>
<ol>
<li>threadLocalHashCode = 4ï¼ŒthreadLocalHashCode &amp; 15 = 4ï¼›æ­¤æ—¶æ•°æ®åº”è¯¥æ”¾åœ¨æ•°ç»„ä¸‹æ ‡ä¸º 4 çš„ä½ç½®ã€‚ä¸‹æ ‡ 4 çš„ä½ç½®æ­£å¥½æ²¡æœ‰æ•°æ®ï¼Œå¯ä»¥å­˜æ”¾ã€‚</li>
<li>threadLocalHashCode = 19ï¼ŒthreadLocalHashCode &amp; 15 = 4ï¼›ä½†æ˜¯ä¸‹æ ‡ 4 çš„ä½ç½®å·²ç»æœ‰æ•°æ®äº†ï¼Œå¦‚æœå½“å‰éœ€è¦æ·»åŠ çš„ Entry ä¸ä¸‹æ ‡ 4 ä½ç½®å·²å­˜åœ¨çš„ Entry ä¸¤è€…çš„ key ç›¸åŒï¼Œé‚£ä¹ˆè¯¥ä½ç½® Entry çš„ value å°†è¢«è¦†ç›–ä¸ºæ–°çš„å€¼ã€‚æˆ‘ä»¬å‡è®¾ key éƒ½æ˜¯ä¸ç›¸åŒçš„ï¼Œæ‰€ä»¥æ­¤æ—¶éœ€è¦å‘åç§»åŠ¨ä¸€ä½ï¼Œä¸‹æ ‡ 5 çš„ä½ç½®æ²¡æœ‰å†²çªï¼Œå¯ä»¥å­˜æ”¾ã€‚</li>
<li>threadLocalHashCode = 33ï¼ŒthreadLocalHashCode &amp; 15 = 3ï¼›ä¸‹æ ‡ 3 çš„ä½ç½®å·²ç»æœ‰æ•°æ®ï¼Œå‘åç§»ä¸€ä½ï¼Œä¸‹æ ‡ 4 ä½ç½®è¿˜æ˜¯æœ‰æ•°æ®ï¼Œç»§ç»­å‘åæŸ¥æ‰¾ï¼Œå‘ç°ä¸‹æ ‡ 6 æ²¡æœ‰æ•°æ®ï¼Œå¯ä»¥å­˜æ”¾ã€‚</li>
</ol>
<p>ThreadLocal.get() çš„è¿‡ç¨‹ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œä¹Ÿæ˜¯æ ¹æ® threadLocalHashCode çš„å€¼å®šä½åˆ°æ•°ç»„ä¸‹æ ‡ï¼Œç„¶ååˆ¤æ–­å½“å‰ä½ç½® Entry å¯¹è±¡ä¸å¾…æŸ¥è¯¢ Entry å¯¹è±¡çš„ key æ˜¯å¦ç›¸åŒï¼Œå¦‚æœä¸åŒï¼Œç»§ç»­å‘ä¸‹æŸ¥æ‰¾ã€‚ç”±æ­¤å¯è§ï¼ŒThreadLocal.set()/get() æ–¹æ³•åœ¨æ•°æ®å¯†é›†æ—¶å¾ˆå®¹æ˜“å‡ºç° Hash å†²çªï¼Œéœ€è¦ O(n) æ—¶é—´å¤æ‚åº¦è§£å†³å†²çªé—®é¢˜ï¼Œæ•ˆç‡è¾ƒä½ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬å†èŠèŠ ThreadLocalMap ä¸­ Entry çš„è®¾è®¡åŸç†ã€‚Entry ç»§æ‰¿è‡ªå¼±å¼•ç”¨ç±» WeakReferenceï¼ŒEntry çš„ key æ˜¯å¼±å¼•ç”¨ï¼Œvalue æ˜¯å¼ºå¼•ç”¨ã€‚åœ¨ JVM åƒåœ¾å›æ”¶æ—¶ï¼Œåªè¦å‘ç°äº†å¼±å¼•ç”¨çš„å¯¹è±¡ï¼Œä¸ç®¡å†…å­˜æ˜¯å¦å……è¶³ï¼Œéƒ½ä¼šè¢«å›æ”¶ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆ Entry çš„ key è¦è®¾è®¡æˆå¼±å¼•ç”¨å‘¢ï¼Ÿæˆ‘ä»¬è¯•æƒ³ä¸‹ï¼Œå¦‚æœ key éƒ½æ˜¯å¼ºå¼•ç”¨ï¼Œå½“ ThreadLocal ä¸å†ä½¿ç”¨æ—¶ï¼Œç„¶è€Œ ThreadLocalMap ä¸­è¿˜æ˜¯å­˜åœ¨å¯¹ ThreadLocal çš„å¼ºå¼•ç”¨ï¼Œé‚£ä¹ˆ GC æ˜¯æ— æ³•å›æ”¶çš„ï¼Œä»è€Œé€ æˆå†…å­˜æ³„æ¼ã€‚</p>
<p>è™½ç„¶ Entry çš„ key è®¾è®¡æˆäº†å¼±å¼•ç”¨ï¼Œä½†æ˜¯å½“ ThreadLocal ä¸å†ä½¿ç”¨è¢« GC å›æ”¶åï¼ŒThreadLocalMap ä¸­å¯èƒ½å‡ºç° Entry çš„ key ä¸º NULLï¼Œé‚£ä¹ˆ Entry çš„ value ä¸€ç›´ä¼šå¼ºå¼•ç”¨æ•°æ®è€Œå¾—ä¸åˆ°é‡Šæ”¾ï¼Œåªèƒ½ç­‰å¾…çº¿ç¨‹é”€æ¯ã€‚é‚£ä¹ˆåº”è¯¥å¦‚ä½•é¿å… ThreadLocalMap å†…å­˜æ³„æ¼å‘¢ï¼ŸThreadLocal å·²ç»å¸®åŠ©æˆ‘ä»¬åšäº†ä¸€å®šçš„ä¿æŠ¤æªæ–½ï¼Œåœ¨æ‰§è¡Œ ThreadLocal.set()/get() æ–¹æ³•æ—¶ï¼ŒThreadLocal ä¼šæ¸…é™¤ ThreadLocalMap ä¸­ key ä¸º NULL çš„ Entry å¯¹è±¡ï¼Œè®©å®ƒè¿˜èƒ½å¤Ÿè¢« GC å›æ”¶ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå½“çº¿ç¨‹ä¸­æŸä¸ª ThreadLocal å¯¹è±¡ä¸å†ä½¿ç”¨æ—¶ï¼Œç«‹å³è°ƒç”¨ remove() æ–¹æ³•åˆ é™¤ Entry å¯¹è±¡ã€‚å¦‚æœæ˜¯åœ¨å¼‚å¸¸çš„åœºæ™¯ä¸­ï¼Œè®°å¾—åœ¨ finally ä»£ç å—ä¸­è¿›è¡Œæ¸…ç†ï¼Œä¿æŒè‰¯å¥½çš„ç¼–ç æ„è¯†ã€‚</p>
<p>å…³äº JDK çš„ ThreadLocal çš„åŸºæœ¬åŸç†æˆ‘ä»¬å·²ç»ä»‹ç»å®Œäº†ï¼Œæ—¢ç„¶ ThreadLocal å·²ç»éå¸¸æˆç†Ÿï¼Œè€Œä¸”åœ¨æ—¥å¸¸å¼€å‘ä¸­ä¹Ÿè¢«å¹¿æ³›ä½¿ç”¨ï¼ŒNetty ä¸ºä»€ä¹ˆè¿˜è¦è‡ªå·±å®ç°ä¸€ä¸ª FastThreadLocal å‘¢ï¼Ÿæ€§èƒ½çœŸçš„æ¯” ThreadLocal é«˜å¾ˆå¤šå—ï¼Ÿæˆ‘ä»¬æ¥ä¸‹æ¥ä¸€èµ·ä¸€æ¢ç©¶ç«Ÿã€‚</p>
<h3 id="fastthreadlocal-ä¸ºä»€ä¹ˆå¿«">FastThreadLocal ä¸ºä»€ä¹ˆå¿«</h3>
<p>FastThreadLocal çš„å®ç°ä¸ ThreadLocal éå¸¸ç±»ä¼¼ï¼ŒNetty ä¸º FastThreadLocal é‡èº«æ‰“é€ äº† FastThreadLocalThread å’Œ InternalThreadLocalMap ä¸¤ä¸ªé‡è¦çš„ç±»ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹è¿™ä¸¤ä¸ªç±»æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<p>FastThreadLocalThread æ˜¯å¯¹ Thread ç±»çš„ä¸€å±‚åŒ…è£…ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ª InternalThreadLocalMap å®ä¾‹ã€‚åªæœ‰ FastThreadLocal å’Œ FastThreadLocalThread ç»„åˆä½¿ç”¨æ—¶ï¼Œæ‰èƒ½å‘æŒ¥ FastThreadLocal çš„æ€§èƒ½ä¼˜åŠ¿ã€‚é¦–å…ˆçœ‹ä¸‹ FastThreadLocalThread çš„æºç å®šä¹‰ï¼š</p>
<pre tabindex="0"><code>public class FastThreadLocalThread extends Thread {

    private InternalThreadLocalMap threadLocalMap;

    // çœç•¥å…¶ä»–ä»£ç 

}
</code></pre><p>å¯ä»¥çœ‹å‡º FastThreadLocalThread ä¸»è¦æ‰©å±•äº† InternalThreadLocalMap å­—æ®µï¼Œæˆ‘ä»¬å¯ä»¥çŒœæµ‹åˆ° FastThreadLocalThread ä¸»è¦ä½¿ç”¨ InternalThreadLocalMap å­˜å‚¨æ•°æ®ï¼Œè€Œä¸å†æ˜¯ä½¿ç”¨ Thread ä¸­çš„ ThreadLocalMapã€‚æ‰€ä»¥æƒ³çŸ¥é“ FastThreadLocalThread é«˜æ€§èƒ½çš„å¥¥ç§˜ï¼Œå¿…é¡»è¦äº†è§£ InternalThreadLocalMap çš„è®¾è®¡åŸç†ã€‚</p>
<p>ä¸Šæ–‡ä¸­æˆ‘ä»¬è®²åˆ°äº† ThreadLocal çš„ä¸€ä¸ªé‡è¦ç¼ºç‚¹ï¼Œå°±æ˜¯ ThreadLocalMap é‡‡ç”¨çº¿æ€§æ¢æµ‹æ³•è§£å†³ Hash å†²çªæ€§èƒ½è¾ƒæ…¢ï¼Œé‚£ä¹ˆ InternalThreadLocalMap åˆæ˜¯å¦‚ä½•ä¼˜åŒ–çš„å‘¢ï¼Ÿé¦–å…ˆä¸€èµ·çœ‹ä¸‹ InternalThreadLocalMap çš„å†…éƒ¨æ„é€ ã€‚</p>
<pre tabindex="0"><code>public final class InternalThreadLocalMap extends UnpaddedInternalThreadLocalMap {

    private static final int DEFAULT_ARRAY_LIST_INITIAL_CAPACITY = 8;

    private static final int STRING_BUILDER_INITIAL_SIZE;

    private static final int STRING_BUILDER_MAX_SIZE;

    public static final Object UNSET = new Object();

    private BitSet cleanerFlags;
    private InternalThreadLocalMap() {

        super(newIndexedVariableTable());

    }

    private static Object[] newIndexedVariableTable() {

        Object[] array = new Object[32];

        Arrays.fill(array, UNSET);

        return array;

    }
    public static int nextVariableIndex() {

        int index = nextIndex.getAndIncrement();

        if (index &lt; 0) {

            nextIndex.decrementAndGet();

            throw new IllegalStateException(&quot;too many thread-local indexed variables&quot;);

        }

        return index;

    }

    // çœç•¥å…¶ä»–ä»£ç 

}

class UnpaddedInternalThreadLocalMap {

    static final ThreadLocal&lt;InternalThreadLocalMap&gt; slowThreadLocalMap = new ThreadLocal&lt;InternalThreadLocalMap&gt;();

    static final AtomicInteger nextIndex = new AtomicInteger();
    Object[] indexedVariables;

    UnpaddedInternalThreadLocalMap(Object[] indexedVariables) {

        this.indexedVariables = indexedVariables;

    }

    // çœç•¥å…¶ä»–ä»£ç 

}
</code></pre><p>ä» InternalThreadLocalMap å†…éƒ¨å®ç°æ¥çœ‹ï¼Œä¸ ThreadLocalMap ä¸€æ ·éƒ½æ˜¯é‡‡ç”¨æ•°ç»„çš„å­˜å‚¨æ–¹å¼ã€‚ä½†æ˜¯ InternalThreadLocalMap å¹¶æ²¡æœ‰ä½¿ç”¨çº¿æ€§æ¢æµ‹æ³•æ¥è§£å†³ Hash å†²çªï¼Œè€Œæ˜¯åœ¨ FastThreadLocal åˆå§‹åŒ–çš„æ—¶å€™åˆ†é…ä¸€ä¸ªæ•°ç»„ç´¢å¼• indexï¼Œindex çš„å€¼é‡‡ç”¨åŸå­ç±» AtomicInteger ä¿è¯é¡ºåºé€’å¢ï¼Œé€šè¿‡è°ƒç”¨ InternalThreadLocalMap.nextVariableIndex() æ–¹æ³•è·å¾—ã€‚ç„¶ååœ¨è¯»å†™æ•°æ®çš„æ—¶å€™é€šè¿‡æ•°ç»„ä¸‹æ ‡ index ç›´æ¥å®šä½åˆ° FastThreadLocal çš„ä½ç½®ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚å¦‚æœæ•°ç»„ä¸‹æ ‡é€’å¢åˆ°éå¸¸å¤§ï¼Œé‚£ä¹ˆæ•°ç»„ä¹Ÿä¼šæ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥ FastThreadLocal æ˜¯é€šè¿‡ç©ºé—´æ¢æ—¶é—´çš„æ€æƒ³æå‡è¯»å†™æ€§èƒ½ã€‚ä¸‹é¢é€šè¿‡ä¸€å¹…å›¾æè¿° InternalThreadLocalMapã€index å’Œ FastThreadLocal ä¹‹é—´çš„å…³ç³»ã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F_qw1KAUXO0AAMZJ_Hk4dQ099.png" alt="Drawing 3.png"></p>
<p>é€šè¿‡ä¸Šé¢ FastThreadLocal çš„å†…éƒ¨ç»“æ„å›¾ï¼Œæˆ‘ä»¬å¯¹æ¯”ä¸‹ä¸ ThreadLocal æœ‰å“ªäº›åŒºåˆ«å‘¢ï¼ŸFastThreadLocal ä½¿ç”¨ Object æ•°ç»„æ›¿ä»£äº† Entry æ•°ç»„ï¼ŒObject[0] å­˜å‚¨çš„æ˜¯ä¸€ä¸ªSet&lt;FastThreadLocal&lt;?&raquo; é›†åˆï¼Œä»æ•°ç»„ä¸‹æ ‡ 1 å¼€å§‹éƒ½æ˜¯ç›´æ¥å­˜å‚¨çš„ value æ•°æ®ï¼Œä¸å†é‡‡ç”¨ ThreadLocal çš„é”®å€¼å¯¹å½¢å¼è¿›è¡Œå­˜å‚¨ã€‚</p>
<p>å‡è®¾ç°åœ¨æˆ‘ä»¬æœ‰ä¸€æ‰¹æ•°æ®éœ€è¦æ·»åŠ åˆ°æ•°ç»„ä¸­ï¼Œåˆ†åˆ«ä¸º value1ã€value2ã€value3ã€value4ï¼Œå¯¹åº”çš„ FastThreadLocal åœ¨åˆå§‹åŒ–çš„æ—¶å€™ç”Ÿæˆçš„æ•°ç»„ç´¢å¼•åˆ†åˆ«ä¸º 1ã€2ã€3ã€4ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F_qw1qAYzsdAAEbsTk70Is389.png" alt="Drawing 4.png"></p>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å¯¹ FastThreadLocal æœ‰äº†ä¸€ä¸ªåŸºæœ¬çš„è®¤è¯†ï¼Œä¸‹é¢æˆ‘ä»¬ç»“åˆå…·ä½“çš„æºç åˆ†æ FastThreadLocal çš„å®ç°åŸç†ã€‚</p>
<h3 id="fastthreadlocal-æºç åˆ†æ">FastThreadLocal æºç åˆ†æ</h3>
<p>åœ¨è®²è§£æºç ä¹‹å‰ï¼Œæˆ‘ä»¬å›è¿‡å¤´çœ‹ä¸‹ä¸Šæ–‡ä¸­çš„ ThreadLocal ç¤ºä¾‹ï¼Œå¦‚æœæŠŠç¤ºä¾‹ä¸­ ThreadLocal æ›¿æ¢æˆ FastThreadï¼Œåº”å½“å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿ</p>
<pre tabindex="0"><code>public class FastThreadLocalTest {

    private static final FastThreadLocal&lt;String&gt; THREAD_NAME_LOCAL = new FastThreadLocal&lt;&gt;();

    private static final FastThreadLocal&lt;TradeOrder&gt; TRADE_THREAD_LOCAL = new FastThreadLocal&lt;&gt;();

    public static void main(String[] args) {

        for (int i = 0; i &lt; 2; i++) {

            int tradeId = i;

            String threadName = &quot;thread-&quot; + i;

            new FastThreadLocalThread(() -&gt; {

                THREAD_NAME_LOCAL.set(threadName);

                TradeOrder tradeOrder = new TradeOrder(tradeId, tradeId % 2 == 0 ? &quot;å·²æ”¯ä»˜&quot; : &quot;æœªæ”¯ä»˜&quot;);

                TRADE_THREAD_LOCAL.set(tradeOrder);

                System.out.println(&quot;threadName: &quot; + THREAD_NAME_LOCAL.get());

                System.out.println(&quot;tradeOrder infoï¼š&quot; + TRADE_THREAD_LOCAL.get());

            }, threadName).start();

        }

    }

}
</code></pre><p>å¯ä»¥çœ‹å‡ºï¼ŒFastThreadLocal çš„ä½¿ç”¨æ–¹æ³•å‡ ä¹å’Œ ThreadLocal ä¿æŒä¸€è‡´ï¼Œåªéœ€è¦æŠŠä»£ç ä¸­ Threadã€ThreadLocal æ›¿æ¢ä¸º FastThreadLocalThread å’Œ FastThreadLocal å³å¯ï¼ŒNetty åœ¨æ˜“ç”¨æ€§æ–¹é¢åšå¾—ç›¸å½“æ£’ã€‚ä¸‹é¢æˆ‘ä»¬é‡ç‚¹å¯¹ç¤ºä¾‹ä¸­ç”¨å¾—åˆ° FastThreadLocal.set()/get() æ–¹æ³•åšæ·±å…¥åˆ†æã€‚</p>
<p>é¦–å…ˆçœ‹ä¸‹ FastThreadLocal.set() çš„æºç ï¼š</p>
<pre tabindex="0"><code>public final void set(V value) {

    if (value != InternalThreadLocalMap.UNSET) { // 1. value æ˜¯å¦ä¸ºç¼ºçœå€¼

        InternalThreadLocalMap threadLocalMap = InternalThreadLocalMap.get(); // 2. è·å–å½“å‰çº¿ç¨‹çš„ InternalThreadLocalMap

        setKnownNotUnset(threadLocalMap, value); // 3. å°† InternalThreadLocalMap ä¸­æ•°æ®æ›¿æ¢ä¸ºæ–°çš„ value

    } else {

        remove();

    }

}
</code></pre><p>FastThreadLocal.set() æ–¹æ³•è™½ç„¶å…¥å£åªæœ‰å‡ è¡Œä»£ç ï¼Œä½†æ˜¯å†…éƒ¨é€»è¾‘æ˜¯ç›¸å½“å¤æ‚çš„ã€‚æˆ‘ä»¬é¦–å…ˆè¿˜æ˜¯æŠ“ä½ä»£ç ä¸»å¹²ï¼Œä¸€æ­¥æ­¥è¿›è¡Œæ‹†è§£åˆ†æã€‚set() çš„è¿‡ç¨‹ä¸»è¦åˆ†ä¸ºä¸‰æ­¥ï¼š</p>
<ol>
<li>åˆ¤æ–­ value æ˜¯å¦ä¸ºç¼ºçœå€¼ï¼Œå¦‚æœç­‰äºç¼ºçœå€¼ï¼Œé‚£ä¹ˆç›´æ¥è°ƒç”¨ remove() æ–¹æ³•ã€‚è¿™é‡Œæˆ‘ä»¬è¿˜ä¸çŸ¥é“ç¼ºçœå€¼å’Œ remove() ä¹‹é—´çš„è”ç³»æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬æš‚ä¸”æŠŠ remove() æ”¾åœ¨æœ€ååˆ†æã€‚</li>
<li>å¦‚æœ value ä¸ç­‰äºç¼ºçœå€¼ï¼Œæ¥ä¸‹æ¥ä¼šè·å–å½“å‰çº¿ç¨‹çš„ InternalThreadLocalMapã€‚</li>
<li>ç„¶åå°† InternalThreadLocalMap ä¸­å¯¹åº”æ•°æ®æ›¿æ¢ä¸ºæ–°çš„ valueã€‚</li>
</ol>
<p>é¦–å…ˆæˆ‘ä»¬çœ‹ä¸‹ InternalThreadLocalMap.get() æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>public static InternalThreadLocalMap get() {

    Thread thread = Thread.currentThread();

    if (thread instanceof FastThreadLocalThread) { // å½“å‰çº¿ç¨‹æ˜¯å¦ä¸º FastThreadLocalThread ç±»å‹

        return fastGet((FastThreadLocalThread) thread);

    } else {

        return slowGet();

    }

}

private static InternalThreadLocalMap fastGet(FastThreadLocalThread thread) {

    InternalThreadLocalMap threadLocalMap = thread.threadLocalMap(); // è·å– FastThreadLocalThread çš„ threadLocalMap å±æ€§

    if (threadLocalMap == null) {

        thread.setThreadLocalMap(threadLocalMap = new InternalThreadLocalMap());

    }

    return threadLocalMap;

}

private static InternalThreadLocalMap slowGet() {

    ThreadLocal&lt;InternalThreadLocalMap&gt; slowThreadLocalMap = UnpaddedInternalThreadLocalMap.slowThreadLocalMap; 

    InternalThreadLocalMap ret = slowThreadLocalMap.get(); // ä» JDK åŸç”Ÿ ThreadLocal ä¸­è·å– InternalThreadLocalMap

    if (ret == null) {

        ret = new InternalThreadLocalMap();

        slowThreadLocalMap.set(ret);

    }

    return ret;

}
</code></pre><p>InternalThreadLocalMap.get() é€»è¾‘å¾ˆç®€å•ï¼Œä¸ºäº†å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£ï¼Œä¸‹é¢ä½¿ç”¨ä¸€å¹…å›¾æè¿° InternalThreadLocalMap çš„è·å–æ–¹å¼ã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F_qw2WAV1UtAAWTkglpnjs396.png" alt="Drawing 5.png"></p>
<p>å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ FastThreadLocalThread ç±»å‹ï¼Œé‚£ä¹ˆç›´æ¥é€šè¿‡ fastGet() æ–¹æ³•è·å– FastThreadLocalThread çš„ threadLocalMap å±æ€§å³å¯ã€‚å¦‚æœæ­¤æ—¶ InternalThreadLocalMap ä¸å­˜åœ¨ï¼Œç›´æ¥åˆ›å»ºä¸€ä¸ªè¿”å›ã€‚å…³äº InternalThreadLocalMap çš„åˆå§‹åŒ–åœ¨ä¸Šæ–‡ä¸­å·²ç»ä»‹ç»è¿‡ï¼Œå®ƒä¼šåˆå§‹åŒ–ä¸€ä¸ªé•¿åº¦ä¸º 32 çš„ Object æ•°ç»„ï¼Œæ•°ç»„ä¸­å¡«å……ç€ 32 ä¸ªç¼ºçœå¯¹è±¡ UNSET çš„å¼•ç”¨ã€‚</p>
<p>é‚£ä¹ˆ slowGet() åˆæ˜¯ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿä»ä»£ç åˆ†æ”¯æ¥çœ‹ï¼ŒslowGet() æ˜¯é’ˆå¯¹é FastThreadLocalThread ç±»å‹çš„çº¿ç¨‹å‘èµ·è°ƒç”¨æ—¶çš„ä¸€ç§å…œåº•æ–¹æ¡ˆã€‚å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯ FastThreadLocalThreadï¼Œå†…éƒ¨æ˜¯æ²¡æœ‰ InternalThreadLocalMap å±æ€§çš„ï¼ŒNetty åœ¨ UnpaddedInternalThreadLocalMap ä¸­ä¿å­˜äº†ä¸€ä¸ª JDK åŸç”Ÿçš„ ThreadLocalï¼ŒThreadLocal ä¸­å­˜æ”¾ç€ InternalThreadLocalMapï¼Œæ­¤æ—¶è·å– InternalThreadLocalMap å°±é€€åŒ–æˆ JDK åŸç”Ÿçš„ ThreadLocal è·å–ã€‚</p>
<p>è·å– InternalThreadLocalMap çš„è¿‡ç¨‹å·²ç»è®²å®Œäº†ï¼Œä¸‹é¢çœ‹ä¸‹ setKnownNotUnset() å¦‚ä½•å°†æ•°æ®æ·»åŠ åˆ° InternalThreadLocalMap çš„ã€‚</p>
<pre tabindex="0"><code>private void setKnownNotUnset(InternalThreadLocalMap threadLocalMap, V value) {

    if (threadLocalMap.setIndexedVariable(index, value)) { // 1. æ‰¾åˆ°æ•°ç»„ä¸‹æ ‡ index ä½ç½®ï¼Œè®¾ç½®æ–°çš„ value

        addToVariablesToRemove(threadLocalMap, this); // 2. å°† FastThreadLocal å¯¹è±¡ä¿å­˜åˆ°å¾…æ¸…ç†çš„ Set ä¸­

    }

}
</code></pre><p>setKnownNotUnset() ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š</p>
<ol>
<li>æ‰¾åˆ°æ•°ç»„ä¸‹æ ‡ index ä½ç½®ï¼Œè®¾ç½®æ–°çš„ valueã€‚</li>
<li>å°† FastThreadLocal å¯¹è±¡ä¿å­˜åˆ°å¾…æ¸…ç†çš„ Set ä¸­ã€‚</li>
</ol>
<p>é¦–å…ˆæˆ‘ä»¬çœ‹ä¸‹ç¬¬ä¸€æ­¥ threadLocalMap.setIndexedVariable() çš„æºç å®ç°ï¼š</p>
<pre tabindex="0"><code>public boolean setIndexedVariable(int index, Object value) {

    Object[] lookup = indexedVariables;

    if (index &lt; lookup.length) {

        Object oldValue = lookup[index]; 

        lookup[index] = value; // ç›´æ¥å°†æ•°ç»„ index ä½ç½®è®¾ç½®ä¸º valueï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)

        return oldValue == UNSET;

    } else {

        expandIndexedVariableTableAndSet(index, value); // å®¹é‡ä¸å¤Ÿï¼Œå…ˆæ‰©å®¹å†è®¾ç½®å€¼

        return true;

    }

}
</code></pre><p>indexedVariables å°±æ˜¯ InternalThreadLocalMap ä¸­ç”¨äºå­˜æ”¾æ•°æ®çš„æ•°ç»„ï¼Œå¦‚æœæ•°ç»„å®¹é‡å¤§äº FastThreadLocal çš„ index ç´¢å¼•ï¼Œé‚£ä¹ˆç›´æ¥æ‰¾åˆ°æ•°ç»„ä¸‹æ ‡ index ä½ç½®å°†æ–° value è®¾ç½®è¿›å»ï¼Œäº‹ä»¶å¤æ‚åº¦ä¸º O(1)ã€‚åœ¨è®¾ç½®æ–°çš„ value ä¹‹å‰ï¼Œä¼šå°†ä¹‹å‰ index ä½ç½®çš„å…ƒç´ å–å‡ºï¼Œå¦‚æœæ—§çš„å…ƒç´ è¿˜æ˜¯ UNSET ç¼ºçœå¯¹è±¡ï¼Œé‚£ä¹ˆè¿”å›æˆåŠŸã€‚</p>
<p>å¦‚æœæ•°ç»„å®¹é‡ä¸å¤Ÿäº†æ€ä¹ˆåŠå‘¢ï¼ŸInternalThreadLocalMap ä¼šè‡ªåŠ¨æ‰©å®¹ï¼Œç„¶åå†è®¾ç½® valueã€‚æ¥ä¸‹æ¥çœ‹çœ‹ expandIndexedVariableTableAndSet() çš„æ‰©å®¹é€»è¾‘ï¼š</p>
<pre tabindex="0"><code>private void expandIndexedVariableTableAndSet(int index, Object value) {

    Object[] oldArray = indexedVariables;

    final int oldCapacity = oldArray.length;

    int newCapacity = index;

    newCapacity |= newCapacity &gt;&gt;&gt;  1;

    newCapacity |= newCapacity &gt;&gt;&gt;  2;

    newCapacity |= newCapacity &gt;&gt;&gt;  4;

    newCapacity |= newCapacity &gt;&gt;&gt;  8;

    newCapacity |= newCapacity &gt;&gt;&gt; 16;

    newCapacity ++;

    Object[] newArray = Arrays.copyOf(oldArray, newCapacity);

    Arrays.fill(newArray, oldCapacity, newArray.length, UNSET);

    newArray[index] = value;

    indexedVariables = newArray;

}
</code></pre><p>ä¸Šè¿°ä»£ç çš„ä½ç§»æ“ä½œæ˜¯ä¸æ˜¯ä¼¼æ›¾ç›¸è¯†ï¼Ÿæˆ‘ä»¬å»ç¿»é˜…ä¸‹ JDK HashMap ä¸­æ‰©å®¹çš„æºç ï¼Œå…¶ä¸­æœ‰è¿™ä¹ˆä¸€æ®µä»£ç ï¼š</p>
<pre tabindex="0"><code>static final int tableSizeFor(int cap) {

    int n = cap - 1;

    n |= n &gt;&gt;&gt; 1;

    n |= n &gt;&gt;&gt; 2;

    n |= n &gt;&gt;&gt; 4;

    n |= n &gt;&gt;&gt; 8;

    n |= n &gt;&gt;&gt; 16;

    return (n &lt; 0) ? 1 : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;

}
</code></pre><p>å¯ä»¥çœ‹å‡º InternalThreadLocalMap å®ç°æ•°ç»„æ‰©å®¹å‡ ä¹å’Œ HashMap å®Œå…¨æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œæ‰€ä»¥å¤šè¯»æºç è¿˜æ˜¯å¯ä»¥ç»™æˆ‘ä»¬å¾ˆå¤šå¯å‘çš„ã€‚InternalThreadLocalMap ä»¥ index ä¸ºåŸºå‡†è¿›è¡Œæ‰©å®¹ï¼Œå°†æ•°ç»„æ‰©å®¹åçš„å®¹é‡å‘ä¸Šå–æ•´ä¸º 2 çš„æ¬¡å¹‚ã€‚ç„¶åå°†åŸæ•°ç»„å†…å®¹æ‹·è´åˆ°æ–°çš„æ•°ç»„ä¸­ï¼Œç©ºä½™éƒ¨åˆ†å¡«å……ç¼ºçœå¯¹è±¡ UNSETï¼Œæœ€ç»ˆæŠŠæ–°æ•°ç»„èµ‹å€¼ç»™ indexedVariablesã€‚</p>
<p>ä¸ºä»€ä¹ˆ InternalThreadLocalMap ä»¥ index ä¸ºåŸºå‡†è¿›è¡Œæ‰©å®¹ï¼Œè€Œä¸æ˜¯åŸæ•°ç»„é•¿åº¦å‘¢ï¼Ÿå‡è®¾ç°åœ¨åˆå§‹åŒ–äº† 70 ä¸ª FastThreadLocalï¼Œä½†æ˜¯è¿™äº› FastThreadLocal ä»æ¥æ²¡æœ‰è°ƒç”¨è¿‡ set() æ–¹æ³•ï¼Œæ­¤æ—¶æ•°ç»„è¿˜æ˜¯é»˜è®¤é•¿åº¦ 32ã€‚å½“ç¬¬ index = 70 çš„ FastThreadLocal è°ƒç”¨ set() æ–¹æ³•æ—¶ï¼Œå¦‚æœæŒ‰åŸæ•°ç»„å®¹é‡ 32 è¿›è¡Œæ‰©å®¹ 2 å€åï¼Œè¿˜æ˜¯æ— æ³•å¡«å…… index = 70 çš„æ•°æ®ã€‚æ‰€ä»¥ä½¿ç”¨ index ä¸ºåŸºå‡†è¿›è¡Œæ‰©å®¹å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯å¦‚æœ FastThreadLocal ç‰¹åˆ«å¤šï¼Œæ•°ç»„çš„é•¿åº¦ä¹Ÿæ˜¯éå¸¸å¤§çš„ã€‚</p>
<p>å›åˆ° setKnownNotUnset() çš„ä¸»æµç¨‹ï¼Œå‘ InternalThreadLocalMap æ·»åŠ å®Œæ•°æ®ä¹‹åï¼Œæ¥ä¸‹å°±æ˜¯å°† FastThreadLocal å¯¹è±¡ä¿å­˜åˆ°å¾…æ¸…ç†çš„ Set ä¸­ã€‚æˆ‘ä»¬ç»§ç»­çœ‹ä¸‹ addToVariablesToRemove() æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<pre tabindex="0"><code>private static void addToVariablesToRemove(InternalThreadLocalMap threadLocalMap, FastThreadLocal&lt;?&gt; variable) {

    Object v = threadLocalMap.indexedVariable(variablesToRemoveIndex); // è·å–æ•°ç»„ä¸‹æ ‡ä¸º 0 çš„å…ƒç´ 

    Set&lt;FastThreadLocal&lt;?&gt;&gt; variablesToRemove;

    if (v == InternalThreadLocalMap.UNSET || v == null) {

        variablesToRemove = Collections.newSetFromMap(new IdentityHashMap&lt;FastThreadLocal&lt;?&gt;, Boolean&gt;()); // åˆ›å»º FastThreadLocal ç±»å‹çš„ Set é›†åˆ

        threadLocalMap.setIndexedVariable(variablesToRemoveIndex, variablesToRemove); // å°† Set é›†åˆå¡«å……åˆ°æ•°ç»„ä¸‹æ ‡ 0 çš„ä½ç½®

    } else {

        variablesToRemove = (Set&lt;FastThreadLocal&lt;?&gt;&gt;) v; // å¦‚æœä¸æ˜¯ UNSETï¼ŒSet é›†åˆå·²å­˜åœ¨ï¼Œç›´æ¥å¼ºè½¬è·å¾— Set é›†åˆ

    }

    variablesToRemove.add(variable); // å°† FastThreadLocal æ·»åŠ åˆ° Set é›†åˆä¸­

}
</code></pre><p>variablesToRemoveIndex æ˜¯é‡‡ç”¨ static final ä¿®é¥°çš„å˜é‡ï¼Œåœ¨ FastThreadLocal åˆå§‹åŒ–æ—¶ variablesToRemoveIndex è¢«èµ‹å€¼ä¸º 0ã€‚InternalThreadLocalMap é¦–å…ˆä¼šæ‰¾åˆ°æ•°ç»„ä¸‹æ ‡ä¸º 0 çš„å…ƒç´ ï¼Œå¦‚æœè¯¥å…ƒç´ æ˜¯ç¼ºçœå¯¹è±¡ UNSET æˆ–è€…ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆä¼šåˆ›å»ºä¸€ä¸ª FastThreadLocal ç±»å‹çš„ Set é›†åˆï¼Œç„¶åæŠŠ Set é›†åˆå¡«å……åˆ°æ•°ç»„ä¸‹æ ‡ 0 çš„ä½ç½®ã€‚å¦‚æœæ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸æ˜¯ç¼ºçœå¯¹è±¡ UNSETï¼Œè¯´æ˜ Set é›†åˆå·²ç»è¢«å¡«å……ï¼Œç›´æ¥å¼ºè½¬è·å¾— Set é›†åˆå³å¯ã€‚è¿™å°±è§£é‡Šäº† InternalThreadLocalMap çš„ value æ•°æ®ä¸ºä»€ä¹ˆæ˜¯ä»ä¸‹æ ‡ä¸º 1 çš„ä½ç½®å¼€å§‹å­˜å‚¨äº†ï¼Œå› ä¸º 0 çš„ä½ç½®å·²ç»è¢« Set é›†åˆå ç”¨äº†ã€‚</p>
<p>ä¸ºä»€ä¹ˆ InternalThreadLocalMap è¦åœ¨æ•°ç»„ä¸‹æ ‡ä¸º 0 çš„ä½ç½®å­˜æ”¾ä¸€ä¸ª FastThreadLocal ç±»å‹çš„ Set é›†åˆå‘¢ï¼Ÿè¿™æ—¶å€™æˆ‘ä»¬å›è¿‡å¤´çœ‹ä¸‹ remove() æ–¹æ³•ã€‚</p>
<pre tabindex="0"><code>public final void remove() {

    remove(InternalThreadLocalMap.getIfSet());

}

public static InternalThreadLocalMap getIfSet() {

    Thread thread = Thread.currentThread();

    if (thread instanceof FastThreadLocalThread) {

        return ((FastThreadLocalThread) thread).threadLocalMap();

    }

    return slowThreadLocalMap.get();

}

public final void remove(InternalThreadLocalMap threadLocalMap) {

    if (threadLocalMap == null) {

        return;

    }

    Object v = threadLocalMap.removeIndexedVariable(index); // åˆ é™¤æ•°ç»„ä¸‹æ ‡ index ä½ç½®å¯¹åº”çš„ value

    removeFromVariablesToRemove(threadLocalMap, this); // ä»æ•°ç»„ä¸‹æ ‡ 0 çš„ä½ç½®å–å‡º Set é›†åˆï¼Œå¹¶åˆ é™¤å½“å‰ FastThreadLocal

    if (v != InternalThreadLocalMap.UNSET) {

        try {

            onRemoval((V) v); // ç©ºæ–¹æ³•ï¼Œç”¨æˆ·å¯ä»¥ç»§æ‰¿å®ç°

        } catch (Exception e) {

            PlatformDependent.throwException(e);

        }

    }

}
</code></pre><p>åœ¨æ‰§è¡Œ remove æ“ä½œä¹‹å‰ï¼Œä¼šè°ƒç”¨ InternalThreadLocalMap.getIfSet() è·å–å½“å‰ InternalThreadLocalMapã€‚æœ‰äº†ä¹‹å‰çš„åŸºç¡€ï¼Œç†è§£ getIfSet() æ–¹æ³•å°±éå¸¸ç®€å•äº†ï¼Œå¦‚æœæ˜¯ FastThreadLocalThread ç±»å‹ï¼Œç›´æ¥å– FastThreadLocalThread ä¸­ threadLocalMap å±æ€§ã€‚å¦‚æœæ˜¯æ™®é€šçº¿ç¨‹ Threadï¼Œä» ThreadLocal ç±»å‹çš„ slowThreadLocalMap ä¸­è·å–ã€‚ æ‰¾åˆ° InternalThreadLocalMap ä¹‹åï¼ŒInternalThreadLocalMap ä¼šä»æ•°ç»„ä¸­å®šä½åˆ°ä¸‹æ ‡ index ä½ç½®çš„å…ƒç´ ï¼Œå¹¶å°† index ä½ç½®çš„å…ƒç´ è¦†ç›–ä¸ºç¼ºçœå¯¹è±¡ UNSETã€‚æ¥ä¸‹æ¥å°±éœ€è¦æ¸…ç†å½“å‰çš„ FastThreadLocal å¯¹è±¡ï¼Œæ­¤æ—¶ Set é›†åˆå°±æ´¾ä¸Šäº†ç”¨åœºï¼ŒInternalThreadLocalMap ä¼šå–å‡ºæ•°ç»„ä¸‹æ ‡ 0 ä½ç½®çš„ Set é›†åˆï¼Œç„¶ååˆ é™¤å½“å‰ FastThreadLocalã€‚æœ€å onRemoval() æ–¹æ³•èµ·åˆ°ä»€ä¹ˆä½œç”¨å‘¢ï¼ŸNetty åªæ˜¯ç•™äº†ä¸€å¤„æ‰©å±•ï¼Œå¹¶æ²¡æœ‰å®ç°ï¼Œç”¨æˆ·éœ€è¦åœ¨åˆ é™¤çš„æ—¶å€™åšä¸€äº›åç½®æ“ä½œï¼Œå¯ä»¥ç»§æ‰¿ FastThreadLocal å®ç°è¯¥æ–¹æ³•ã€‚</p>
<p>è‡³æ­¤ï¼ŒFastThreadLocal.set() çš„å®Œæˆè¿‡ç¨‹å·²ç»è®²å®Œäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­ FastThreadLocal.get() æ–¹æ³•çš„å®ç°å°±æ˜“å¦‚åæŒæ‹‰ã€‚FastThreadLocal.get() çš„æºç å®ç°å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>public final V get() {

    InternalThreadLocalMap threadLocalMap = InternalThreadLocalMap.get();

    Object v = threadLocalMap.indexedVariable(index); // ä»æ•°ç»„ä¸­å–å‡º index ä½ç½®çš„å…ƒç´ 

    if (v != InternalThreadLocalMap.UNSET) {

        return (V) v;

    }

    return initialize(threadLocalMap); // å¦‚æœè·å–åˆ°çš„æ•°ç»„å…ƒç´ æ˜¯ç¼ºçœå¯¹è±¡ï¼Œæ‰§è¡Œåˆå§‹åŒ–æ“ä½œ

}

public Object indexedVariable(int index) {

    Object[] lookup = indexedVariables;

    return index &lt; lookup.length? lookup[index] : UNSET;

}

private V initialize(InternalThreadLocalMap threadLocalMap) {

    V v = null;

    try {

        v = initialValue();

    } catch (Exception e) {

        PlatformDependent.throwException(e);

    }

    threadLocalMap.setIndexedVariable(index, v);

    addToVariablesToRemove(threadLocalMap, this);

    return v;

}
</code></pre><p>é¦–å…ˆæ ¹æ®å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ FastThreadLocalThread ç±»å‹æ‰¾åˆ° InternalThreadLocalMapï¼Œç„¶åå–å‡ºä»æ•°ç»„ä¸‹æ ‡ index çš„å…ƒç´ ï¼Œå¦‚æœ index ä½ç½®çš„å…ƒç´ ä¸æ˜¯ç¼ºçœå¯¹è±¡ UNSETï¼Œè¯´æ˜è¯¥ä½ç½®å·²ç»å¡«å……è¿‡æ•°æ®ï¼Œç›´æ¥å–å‡ºè¿”å›å³å¯ã€‚å¦‚æœ index ä½ç½®çš„å…ƒç´ æ˜¯ç¼ºçœå¯¹è±¡ UNSETï¼Œé‚£ä¹ˆéœ€è¦æ‰§è¡Œåˆå§‹åŒ–æ“ä½œã€‚å¯ä»¥çœ‹åˆ°ï¼Œinitialize() æ–¹æ³•ä¼šè°ƒç”¨ç”¨æˆ·é‡å†™çš„ initialValue æ–¹æ³•æ„é€ éœ€è¦å­˜å‚¨çš„å¯¹è±¡æ•°æ®ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<pre tabindex="0"><code>private final FastThreadLocal&lt;String&gt; threadLocal = new FastThreadLocal&lt;String&gt;() {

    @Override

    protected String initialValue() {

        return &quot;hello world&quot;;

    }

};
</code></pre><p>æ„é€ å®Œç”¨æˆ·å¯¹è±¡æ•°æ®ä¹‹åï¼Œæ¥ä¸‹æ¥å°±ä¼šå°†å®ƒå¡«å……åˆ°æ•°ç»„ index çš„ä½ç½®ï¼Œç„¶åå†æŠŠå½“å‰ FastThreadLocal å¯¹è±¡ä¿å­˜åˆ°å¾…æ¸…ç†çš„ Set ä¸­ã€‚æ•´ä¸ªè¿‡ç¨‹æˆ‘ä»¬åœ¨åˆ†æ FastThreadLocal.set() æ—¶éƒ½å·²ç»ä»‹ç»è¿‡ï¼Œå°±ä¸å†èµ˜è¿°äº†ã€‚</p>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼ŒFastThreadLocal æœ€æ ¸å¿ƒçš„ä¸¤ä¸ªæ–¹æ³• set()/get() æˆ‘ä»¬å·²ç»åˆ†æå®Œäº†ã€‚ä¸‹é¢æœ‰ä¸¤ä¸ªé—®é¢˜æˆ‘ä»¬å†æ·±å…¥æ€è€ƒä¸‹ã€‚</p>
<ol>
<li>FastThreadLocal çœŸçš„ä¸€å®šæ¯” ThreadLocal å¿«å—ï¼Ÿç­”æ¡ˆæ˜¯ä¸ä¸€å®šçš„ï¼Œåªæœ‰ä½¿ç”¨FastThreadLocalThread ç±»å‹çš„çº¿ç¨‹æ‰ä¼šæ›´å¿«ï¼Œå¦‚æœæ˜¯æ™®é€šçº¿ç¨‹åè€Œä¼šæ›´æ…¢ã€‚</li>
<li>FastThreadLocal ä¼šæµªè´¹å¾ˆå¤§çš„ç©ºé—´å—ï¼Ÿè™½ç„¶ FastThreadLocal é‡‡ç”¨çš„ç©ºé—´æ¢æ—¶é—´çš„æ€è·¯ï¼Œä½†æ˜¯åœ¨ FastThreadLocal è®¾è®¡ä¹‹åˆå°±è®¤ä¸ºä¸ä¼šå­˜åœ¨ç‰¹åˆ«å¤šçš„ FastThreadLocal å¯¹è±¡ï¼Œè€Œä¸”åœ¨æ•°æ®ä¸­æ²¡æœ‰ä½¿ç”¨çš„å…ƒç´ åªæ˜¯å­˜æ”¾äº†åŒä¸€ä¸ªç¼ºçœå¯¹è±¡çš„å¼•ç”¨ï¼Œå¹¶ä¸ä¼šå ç”¨å¤ªå¤šå†…å­˜ç©ºé—´ã€‚</li>
</ol>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>æœ¬èŠ‚è¯¾æˆ‘ä»¬å¯¹æ¯”ä»‹ç»äº† ThreadLocal å’Œ FastThreadLocalï¼Œç®€å•æ€»ç»“ä¸‹ FastThreadLocal çš„ä¼˜åŠ¿ã€‚</p>
<ul>
<li><strong>é«˜æ•ˆæŸ¥æ‰¾</strong>ã€‚FastThreadLocal åœ¨å®šä½æ•°æ®çš„æ—¶å€™å¯ä»¥ç›´æ¥æ ¹æ®æ•°ç»„ä¸‹æ ‡ index è·å–ï¼Œæ—¶é—´å¤æ‚åº¦ O(1)ã€‚è€Œ JDK åŸç”Ÿçš„ ThreadLocal åœ¨æ•°æ®è¾ƒå¤šæ—¶å“ˆå¸Œè¡¨å¾ˆå®¹æ˜“å‘ç”Ÿ Hash å†²çªï¼Œçº¿æ€§æ¢æµ‹æ³•åœ¨è§£å†³ Hash å†²çªæ—¶éœ€è¦ä¸åœåœ°å‘ä¸‹å¯»æ‰¾ï¼Œæ•ˆç‡è¾ƒä½ã€‚æ­¤å¤–ï¼ŒFastThreadLocal ç›¸æ¯” ThreadLocal æ•°æ®æ‰©å®¹æ›´åŠ ç®€å•é«˜æ•ˆï¼ŒFastThreadLocal ä»¥ index ä¸ºåŸºå‡†å‘ä¸Šå–æ•´åˆ° 2 çš„æ¬¡å¹‚ä½œä¸ºæ‰©å®¹åå®¹é‡ï¼Œç„¶åæŠŠåŸæ•°æ®æ‹·è´åˆ°æ–°æ•°ç»„ã€‚è€Œ ThreadLocal ç”±äºé‡‡ç”¨çš„å“ˆå¸Œè¡¨ï¼Œæ‰€ä»¥åœ¨æ‰©å®¹åéœ€è¦å†åšä¸€è½® rehashã€‚</li>
<li><strong>å®‰å…¨æ€§æ›´é«˜</strong>ã€‚JDK åŸç”Ÿçš„ ThreadLocal ä½¿ç”¨ä¸å½“å¯èƒ½é€ æˆå†…å­˜æ³„æ¼ï¼Œåªèƒ½ç­‰å¾…çº¿ç¨‹é”€æ¯ã€‚åœ¨ä½¿ç”¨çº¿ç¨‹æ± çš„åœºæ™¯ä¸‹ï¼ŒThreadLocal åªèƒ½é€šè¿‡ä¸»åŠ¨æ£€æµ‹çš„æ–¹å¼é˜²æ­¢å†…å­˜æ³„æ¼ï¼Œä»è€Œé€ æˆäº†ä¸€å®šçš„å¼€é”€ã€‚ç„¶è€Œ FastThreadLocal ä¸ä»…æä¾›äº† remove() ä¸»åŠ¨æ¸…é™¤å¯¹è±¡çš„æ–¹æ³•ï¼Œè€Œä¸”åœ¨çº¿ç¨‹æ± åœºæ™¯ä¸­ Netty è¿˜å°è£…äº† FastThreadLocalRunnableï¼ŒFastThreadLocalRunnable æœ€åä¼šæ‰§è¡Œ FastThreadLocal.removeAll() å°† Set é›†åˆä¸­æ‰€æœ‰ FastThreadLocal å¯¹è±¡éƒ½æ¸…ç†æ‰ï¼Œ</li>
</ul>
<p>FastThreadLocal ä½“ç°äº† Netty åœ¨é«˜æ€§èƒ½æ–¹é¢ç²¾ç›Šæ±‚ç²¾çš„è®¾è®¡ç²¾ç¥ï¼ŒFastThreadLocal ä»…ä»…æ˜¯å…¶ä¸­çš„å†°å±±ä¸€è§’ï¼Œä¸‹èŠ‚è¯¾æˆ‘ä»¬ç»§ç»­æ¢ç´¢ Netty ä¸­å…¶ä»–é«˜æ•ˆçš„æ•°æ®ç»“æ„æŠ€å·§ã€‚</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/19-%E6%BA%90%E7%A0%81%E7%AF%87%E4%B8%80%E4%B8%AA%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E5%9C%A8-netty-%E4%B8%AD%E7%9A%84%E6%97%85%E7%A8%8B/"><span>19 æºç ç¯‡ï¼šä¸€ä¸ªç½‘ç»œè¯·æ±‚åœ¨ Netty ä¸­çš„æ—…ç¨‹</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/21-%E6%8A%80%E5%B7%A7%E7%AF%87%E5%BB%B6%E8%BF%9F%E4%BB%BB%E5%8A%A1%E5%A4%84%E7%90%86%E7%A5%9E%E5%99%A8%E4%B9%8B%E6%97%B6%E9%97%B4%E8%BD%AE-hashedwheeltimer/"><span>21 æŠ€å·§ç¯‡ï¼šå»¶è¿Ÿä»»åŠ¡å¤„ç†ç¥å™¨ä¹‹æ—¶é—´è½® HashedWheelTimer</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 27270 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>