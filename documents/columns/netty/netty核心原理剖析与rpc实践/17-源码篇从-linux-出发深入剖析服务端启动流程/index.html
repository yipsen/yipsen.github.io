<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>17 æºç ç¯‡ï¼šä» Linux å‡ºå‘æ·±å…¥å‰–ææœåŠ¡ç«¯å¯åŠ¨æµç¨‹ | Yipsen Ye</title>
<meta name="description" content="é€šè¿‡å‰å‡ ç« è¯¾ç¨‹çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å·²ç»å¯¹ Netty çš„æŠ€æœ¯æ€æƒ³å’ŒåŸºæœ¬åŸç†æœ‰äº†åˆæ­¥çš„è®¤è¯†ï¼Œä»ä»Šå¤©è¿™èŠ‚è¯¾å¼€å§‹æˆ‘ä»¬å°†æ­£å¼è¿›å…¥ Netty æ ¸å¿ƒæºç å­¦ä¹ çš„è¯¾ç¨‹ã€‚å¸Œæœ›èƒ½å¤Ÿé€šè¿‡æºç è§£æçš„æ–¹å¼è®©ä½ æ›´åŠ æ·±å…¥ç†è§£ Netty çš„ç²¾é«“ï¼Œå¦‚ Netty çš„è®¾è®¡æ€æƒ³ã€å·¥ç¨‹æŠ€å·§ç­‰ï¼Œä¸ºä¹‹åç»§ç»­æ·±å…¥ç ”ç©¶ Netty æ‰“ä¸‹åšå®çš„åŸºç¡€ã€‚
åœ¨è¯¾ç¨‹å¼€å§‹ä¹‹å‰ï¼Œæˆ‘æƒ³åˆ†äº«ä¸€ä¸‹å…³äºæºç å­¦ä¹ çš„å‡ ç‚¹ç»éªŒå’Œå»ºè®®ã€‚ç¬¬ä¸€ï¼Œå¾ˆå¤šåŒå­¦åœ¨å¼€å§‹å­¦ä¹ æºç æ—¶é¢ä¸´çš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯ä¸çŸ¥é“ä»ä½•ä¸‹æ‰‹ï¼Œè¿™ä¸ªæ—¶å€™ä¸€å®šä¸èƒ½å¯¹ç€æºç æ¯«æ— æ„ä¹‰åœ°å››å¤„ç¿»çœ‹ã€‚å»ºè®®ä½ å¯ä»¥é€šè¿‡ Hello World æˆ–è€… TestCase ä½œä¸ºæºç å­¦ä¹ çš„å…¥å£ï¼Œç„¶åå†é€šè¿‡ Debug æ–­ç‚¹çš„æ–¹å¼è°ƒè¯•å¹¶è·‘é€šæºç ã€‚ç¬¬äºŒï¼Œé˜…è¯»æºç ä¸€å®šè¦æœ‰å…¨å±€è§‚ã€‚é¦–å…ˆè¦æŠŠæ¡æºç çš„ä¸»æµç¨‹ï¼Œé¿å…åˆšå¼€å§‹é™·å…¥ä»£ç ç»†èŠ‚çš„æ­»èƒ¡åŒã€‚ç¬¬ä¸‰ï¼Œæºç ä¸€å®šè¦åå¤é˜…è¯»ï¼Œè®©è‡ªå·±æ¯ä¸€æ¬¡è¯»éƒ½æœ‰ä¸åŒçš„æ”¶è·ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ç”»å›¾ã€æ³¨é‡Šçš„æ–¹å¼å¸®åŠ©è‡ªå·±æ›´å®¹æ˜“ç†è§£æºç çš„æ ¸å¿ƒæµç¨‹ï¼Œæ–¹ä¾¿åç»­çš„å¤ä¹ å’Œå›é¡¾ã€‚
ä½œä¸ºæºç è§£æçš„ç¬¬ä¸€èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°†æ·±å…¥åˆ†æ Netty æœåŠ¡ç«¯çš„å¯åŠ¨æµç¨‹ã€‚å¯åŠ¨æœåŠ¡çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥äº†è§£åˆ° Netty å„å¤§æ ¸å¿ƒç»„ä»¶çš„å…³ç³»ï¼Œè¿™å°†æ˜¯å­¦ä¹  Netty æºç ä¸€ä¸ªéå¸¸å¥½çš„åˆ‡å…¥ç‚¹ï¼Œè®©æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹ Netty çš„æ¯ä¸ªé›¶ä»¶æ˜¯å¦‚ä½•è¿è½¬èµ·æ¥çš„å§ã€‚
 è¯´æ˜ï¼šæœ¬æ–‡å‚è€ƒçš„ Netty æºç ç‰ˆæœ¬ä¸º 4.1.42.Finalã€‚
 ä» Echo æœåŠ¡å™¨ç¤ºä¾‹å…¥æ‰‹ åœ¨ã€Šå¼•å¯¼å™¨ä½œç”¨ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¯åŠ¨éƒ½è¦åšäº›ä»€ä¹ˆï¼Ÿã€‹çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨å¼•å¯¼å™¨æ­å»ºæœåŠ¡ç«¯çš„åŸºæœ¬æ¡†æ¶ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªæœ€ç®€å•çš„ Echo æœåŠ¡å™¨ï¼Œç”¨äºè°ƒè¯• Netty æœåŠ¡ç«¯å¯åŠ¨çš„æºç ã€‚
public class EchoServer {public void startEchoServer(int port) throws Exception {EventLoopGroup bossGroup = new NioEventLoopGroup();EventLoopGroup workerGroup = new NioEventLoopGroup();try {ServerBootstrap b = new ServerBootstrap();b.">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/netty%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e5%89%96%e6%9e%90%e4%b8%8erpc%e5%ae%9e%e8%b7%b5/">Nettyæ ¸å¿ƒåŸç†å‰–æä¸RPCå®è·µ</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/00-%E5%AD%A6%E5%A5%BD-netty%E6%98%AF%E4%BD%A0%E4%BF%AE%E7%82%BC-java-%E5%86%85%E5%8A%9F%E7%9A%84%E5%BF%85%E7%BB%8F%E4%B9%8B%E8%B7%AF/">00 å­¦å¥½ Nettyï¼Œæ˜¯ä½ ä¿®ç‚¼ Java å†…åŠŸçš„å¿…ç»ä¹‹è·¯</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/01-%E5%88%9D%E8%AF%86-netty%E4%B8%BA%E4%BB%80%E4%B9%88-netty-%E8%BF%99%E4%B9%88%E6%B5%81%E8%A1%8C/">01 åˆè¯† Nettyï¼šä¸ºä»€ä¹ˆ Netty è¿™ä¹ˆæµè¡Œï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/02-%E7%BA%B5%E8%A7%88%E5%85%A8%E5%B1%80%E6%8A%8A%E6%8F%A1-netty-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E8%84%89%E7%BB%9C/">02 çºµè§ˆå…¨å±€ï¼šæŠŠæ¡ Netty æ•´ä½“æ¶æ„è„‰ç»œ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/03-%E5%BC%95%E5%AF%BC%E5%99%A8%E4%BD%9C%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E9%83%BD%E8%A6%81%E5%81%9A%E4%BA%9B%E4%BB%80%E4%B9%88/">03 å¼•å¯¼å™¨ä½œç”¨ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¯åŠ¨éƒ½è¦åšäº›ä»€ä¹ˆï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/04-%E4%BA%8B%E4%BB%B6%E8%B0%83%E5%BA%A6%E5%B1%82%E4%B8%BA%E4%BB%80%E4%B9%88-eventloop-%E6%98%AF-netty-%E7%9A%84%E7%B2%BE%E9%AB%93/">04 äº‹ä»¶è°ƒåº¦å±‚ï¼šä¸ºä»€ä¹ˆ EventLoop æ˜¯ Netty çš„ç²¾é«“ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/05-%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92%E5%B1%82pipeline-%E5%A6%82%E4%BD%95%E5%8D%8F%E8%B0%83%E5%90%84%E7%B1%BB-handler-/">05 æœåŠ¡ç¼–æ’å±‚ï¼šPipeline å¦‚ä½•åè°ƒå„ç±» Handler ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/06-%E7%B2%98%E5%8C%85%E6%8B%86%E5%8C%85%E9%97%AE%E9%A2%98%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%95%B4%E7%9A%84%E7%BD%91%E7%BB%9C%E5%8C%85/">06 ç²˜åŒ…æ‹†åŒ…é—®é¢˜ï¼šå¦‚ä½•è·å–ä¸€ä¸ªå®Œæ•´çš„ç½‘ç»œåŒ…ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/07-%E6%8E%A5%E5%A4%B4%E6%9A%97%E8%AF%AD%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8-netty-%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E9%80%9A%E4%BF%A1/">07 æ¥å¤´æš—è¯­ï¼šå¦‚ä½•åˆ©ç”¨ Netty å®ç°è‡ªå®šä¹‰åè®®é€šä¿¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/08-%E5%BC%80%E7%AE%B1%E5%8D%B3%E7%94%A8netty-%E6%94%AF%E6%8C%81%E5%93%AA%E4%BA%9B%E5%B8%B8%E7%94%A8%E7%9A%84%E8%A7%A3%E7%A0%81%E5%99%A8/">08 å¼€ç®±å³ç”¨ï¼šNetty æ”¯æŒå“ªäº›å¸¸ç”¨çš„è§£ç å™¨ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/09-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93writeandflush-%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E5%89%96%E6%9E%90/">09 æ•°æ®ä¼ è¾“ï¼šwriteAndFlush å¤„ç†æµç¨‹å‰–æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/10-%E5%8F%8C%E5%88%83%E5%89%91%E5%90%88%E7%90%86%E7%AE%A1%E7%90%86-netty-%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98/">10 åŒåˆƒå‰‘ï¼šåˆç†ç®¡ç† Netty å †å¤–å†…å­˜</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/11-%E5%8F%A6%E8%B5%B7%E7%82%89%E7%81%B6netty-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E8%BD%BD%E4%BD%93-bytebuf-%E8%AF%A6%E8%A7%A3/">11 å¦èµ·ç‚‰ç¶ï¼šNetty æ•°æ®ä¼ è¾“è½½ä½“ ByteBuf è¯¦è§£</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/12-%E4%BB%96%E5%B1%B1%E4%B9%8B%E7%9F%B3%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%99%A8-jemalloc-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/">12 ä»–å±±ä¹‹çŸ³ï¼šé«˜æ€§èƒ½å†…å­˜åˆ†é…å™¨ jemalloc åŸºæœ¬åŸç†</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/13-%E4%B8%BE%E4%B8%80%E5%8F%8D%E4%B8%89netty-%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E8%AE%BE%E8%AE%A1%E4%B8%8A/">13 ä¸¾ä¸€åä¸‰ï¼šNetty é«˜æ€§èƒ½å†…å­˜ç®¡ç†è®¾è®¡ï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/14-%E4%B8%BE%E4%B8%80%E5%8F%8D%E4%B8%89netty-%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E8%AE%BE%E8%AE%A1%E4%B8%8B/">14 ä¸¾ä¸€åä¸‰ï¼šNetty é«˜æ€§èƒ½å†…å­˜ç®¡ç†è®¾è®¡ï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/15-%E8%BD%BB%E9%87%8F%E7%BA%A7%E5%AF%B9%E8%B1%A1%E5%9B%9E%E6%94%B6%E7%AB%99recycler-%E5%AF%B9%E8%B1%A1%E6%B1%A0%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90/">15 è½»é‡çº§å¯¹è±¡å›æ”¶ç«™ï¼šRecycler å¯¹è±¡æ± æŠ€æœ¯è§£æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/16-io-%E5%8A%A0%E9%80%9F%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%E7%9A%84-netty-%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF/">16 IO åŠ é€Ÿï¼šä¸ä¼—ä¸åŒçš„ Netty é›¶æ‹·è´æŠ€æœ¯</a></li>
                
                
                
                    <li>17 æºç ç¯‡ï¼šä» Linux å‡ºå‘æ·±å…¥å‰–ææœåŠ¡ç«¯å¯åŠ¨æµç¨‹</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/18-%E6%BA%90%E7%A0%81%E7%AF%87%E8%A7%A3%E5%AF%86-netty-reactor-%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/">18 æºç ç¯‡ï¼šè§£å¯† Netty Reactor çº¿ç¨‹æ¨¡å‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/19-%E6%BA%90%E7%A0%81%E7%AF%87%E4%B8%80%E4%B8%AA%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E5%9C%A8-netty-%E4%B8%AD%E7%9A%84%E6%97%85%E7%A8%8B/">19 æºç ç¯‡ï¼šä¸€ä¸ªç½‘ç»œè¯·æ±‚åœ¨ Netty ä¸­çš„æ—…ç¨‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/20-%E6%8A%80%E5%B7%A7%E7%AF%87netty-%E7%9A%84-fastthreadlocal-%E7%A9%B6%E7%AB%9F%E6%AF%94-threadlocal-%E5%BF%AB%E5%9C%A8%E5%93%AA%E5%84%BF/">20 æŠ€å·§ç¯‡ï¼šNetty çš„ FastThreadLocal ç©¶ç«Ÿæ¯” ThreadLocal å¿«åœ¨å“ªå„¿ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/21-%E6%8A%80%E5%B7%A7%E7%AF%87%E5%BB%B6%E8%BF%9F%E4%BB%BB%E5%8A%A1%E5%A4%84%E7%90%86%E7%A5%9E%E5%99%A8%E4%B9%8B%E6%97%B6%E9%97%B4%E8%BD%AE-hashedwheeltimer/">21 æŠ€å·§ç¯‡ï¼šå»¶è¿Ÿä»»åŠ¡å¤„ç†ç¥å™¨ä¹‹æ—¶é—´è½® HashedWheelTimer</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/22-%E6%8A%80%E5%B7%A7%E7%AF%87%E9%AB%98%E6%80%A7%E8%83%BD%E6%97%A0%E9%94%81%E9%98%9F%E5%88%97-mpsc-queue/">22 æŠ€å·§ç¯‡ï¼šé«˜æ€§èƒ½æ— é”é˜Ÿåˆ— Mpsc Queue</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/23-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E9%AB%98%E6%80%A7%E8%83%BD%E5%88%86%E5%B8%83%E5%BC%8F-rpc-%E6%A1%86%E6%9E%B6/">23 æ¶æ„è®¾è®¡ï¼šå¦‚ä½•å®ç°ä¸€ä¸ªé«˜æ€§èƒ½åˆ†å¸ƒå¼ RPC æ¡†æ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/24-%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E4%B8%8E%E8%AE%A2%E9%98%85%E6%90%AD%E5%BB%BA%E7%94%9F%E4%BA%A7%E8%80%85%E5%92%8C%E6%B6%88%E8%B4%B9%E8%80%85%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A1%86%E6%9E%B6/">24 æœåŠ¡å‘å¸ƒä¸è®¢é˜…ï¼šæ­å»ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åŸºç¡€æ¡†æ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/25-%E8%BF%9C%E7%A8%8B%E9%80%9A%E4%BF%A1%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE%E8%AE%BE%E8%AE%A1%E4%BB%A5%E5%8F%8A%E7%BC%96%E8%A7%A3%E7%A0%81%E7%9A%84%E5%AE%9E%E7%8E%B0/">25 è¿œç¨‹é€šä¿¡ï¼šé€šä¿¡åè®®è®¾è®¡ä»¥åŠç¼–è§£ç çš„å®ç°</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/26-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%9C%BA%E5%88%B6%E7%9A%84%E5%AE%9E%E7%8E%B0/">26 æœåŠ¡æ²»ç†ï¼šæœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡æœºåˆ¶çš„å®ç°</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/27-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%BA%E7%94%A8%E6%88%B7%E5%B1%8F%E8%94%BD-rpc-%E8%B0%83%E7%94%A8%E7%9A%84%E5%BA%95%E5%B1%82%E7%BB%86%E8%8A%82/">27 åŠ¨æ€ä»£ç†ï¼šä¸ºç”¨æˆ·å±è”½ RPC è°ƒç”¨çš„åº•å±‚ç»†èŠ‚</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/28-%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93rpc-%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93%E4%B8%8E%E8%BF%9B%E9%98%B6%E5%BB%B6%E4%BC%B8/">28 å®æˆ˜æ€»ç»“ï¼šRPC å®æˆ˜æ€»ç»“ä¸è¿›é˜¶å»¶ä¼¸</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/29-%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3netty-%E4%B8%AD%E5%BA%94%E7%94%A8%E4%BA%86%E5%93%AA%E4%BA%9B%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">29 ç¼–ç¨‹æ€æƒ³ï¼šNetty ä¸­åº”ç”¨äº†å“ªäº›è®¾è®¡æ¨¡å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/30-%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93netty-%E5%9C%A8%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">30 å®è·µæ€»ç»“ï¼šNetty åœ¨é¡¹ç›®å¼€å‘ä¸­çš„ä¸€äº›æœ€ä½³å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/31-%E7%BB%93%E6%9D%9F%E8%AF%AD-%E6%8A%80%E6%9C%AF%E6%88%90%E9%95%BF%E4%B9%8B%E8%B7%AF%E5%A6%82%E4%BD%95%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB/">31 ç»“æŸè¯­ æŠ€æœ¯æˆé•¿ä¹‹è·¯ï¼šå¦‚ä½•æ‰“é€ è‡ªå·±çš„æŠ€æœ¯ä½“ç³»</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">17 æºç ç¯‡ï¼šä» Linux å‡ºå‘æ·±å…¥å‰–ææœåŠ¡ç«¯å¯åŠ¨æµç¨‹</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2021-12-22 01:54:39</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/netty/">netty</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/">Nettyæ ¸å¿ƒåŸç†å‰–æä¸RPCå®è·µ</a>
                
            </div></div>
        <div class="post-content">
            <p>é€šè¿‡å‰å‡ ç« è¯¾ç¨‹çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å·²ç»å¯¹ Netty çš„æŠ€æœ¯æ€æƒ³å’ŒåŸºæœ¬åŸç†æœ‰äº†åˆæ­¥çš„è®¤è¯†ï¼Œä»ä»Šå¤©è¿™èŠ‚è¯¾å¼€å§‹æˆ‘ä»¬å°†æ­£å¼è¿›å…¥ Netty æ ¸å¿ƒæºç å­¦ä¹ çš„è¯¾ç¨‹ã€‚å¸Œæœ›èƒ½å¤Ÿé€šè¿‡æºç è§£æçš„æ–¹å¼è®©ä½ æ›´åŠ æ·±å…¥ç†è§£ Netty çš„ç²¾é«“ï¼Œå¦‚ Netty çš„è®¾è®¡æ€æƒ³ã€å·¥ç¨‹æŠ€å·§ç­‰ï¼Œä¸ºä¹‹åç»§ç»­æ·±å…¥ç ”ç©¶ Netty æ‰“ä¸‹åšå®çš„åŸºç¡€ã€‚</p>
<p>åœ¨è¯¾ç¨‹å¼€å§‹ä¹‹å‰ï¼Œæˆ‘æƒ³åˆ†äº«ä¸€ä¸‹å…³äºæºç å­¦ä¹ çš„å‡ ç‚¹ç»éªŒå’Œå»ºè®®ã€‚ç¬¬ä¸€ï¼Œå¾ˆå¤šåŒå­¦åœ¨å¼€å§‹å­¦ä¹ æºç æ—¶é¢ä¸´çš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯ä¸çŸ¥é“ä»ä½•ä¸‹æ‰‹ï¼Œè¿™ä¸ªæ—¶å€™ä¸€å®šä¸èƒ½å¯¹ç€æºç æ¯«æ— æ„ä¹‰åœ°å››å¤„ç¿»çœ‹ã€‚å»ºè®®ä½ å¯ä»¥é€šè¿‡ Hello World æˆ–è€… TestCase ä½œä¸ºæºç å­¦ä¹ çš„å…¥å£ï¼Œç„¶åå†é€šè¿‡ Debug æ–­ç‚¹çš„æ–¹å¼è°ƒè¯•å¹¶è·‘é€šæºç ã€‚ç¬¬äºŒï¼Œé˜…è¯»æºç ä¸€å®šè¦æœ‰å…¨å±€è§‚ã€‚é¦–å…ˆè¦æŠŠæ¡æºç çš„ä¸»æµç¨‹ï¼Œé¿å…åˆšå¼€å§‹é™·å…¥ä»£ç ç»†èŠ‚çš„æ­»èƒ¡åŒã€‚ç¬¬ä¸‰ï¼Œæºç ä¸€å®šè¦åå¤é˜…è¯»ï¼Œè®©è‡ªå·±æ¯ä¸€æ¬¡è¯»éƒ½æœ‰ä¸åŒçš„æ”¶è·ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ç”»å›¾ã€æ³¨é‡Šçš„æ–¹å¼å¸®åŠ©è‡ªå·±æ›´å®¹æ˜“ç†è§£æºç çš„æ ¸å¿ƒæµç¨‹ï¼Œæ–¹ä¾¿åç»­çš„å¤ä¹ å’Œå›é¡¾ã€‚</p>
<p>ä½œä¸ºæºç è§£æçš„ç¬¬ä¸€èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°†æ·±å…¥åˆ†æ Netty æœåŠ¡ç«¯çš„å¯åŠ¨æµç¨‹ã€‚å¯åŠ¨æœåŠ¡çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥äº†è§£åˆ° Netty å„å¤§æ ¸å¿ƒç»„ä»¶çš„å…³ç³»ï¼Œè¿™å°†æ˜¯å­¦ä¹  Netty æºç ä¸€ä¸ªéå¸¸å¥½çš„åˆ‡å…¥ç‚¹ï¼Œè®©æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹ Netty çš„æ¯ä¸ªé›¶ä»¶æ˜¯å¦‚ä½•è¿è½¬èµ·æ¥çš„å§ã€‚</p>
<blockquote>
<p>è¯´æ˜ï¼šæœ¬æ–‡å‚è€ƒçš„ Netty æºç ç‰ˆæœ¬ä¸º 4.1.42.Finalã€‚</p>
</blockquote>
<h3 id="ä»-echo-æœåŠ¡å™¨ç¤ºä¾‹å…¥æ‰‹">ä» Echo æœåŠ¡å™¨ç¤ºä¾‹å…¥æ‰‹</h3>
<p>åœ¨ã€Šå¼•å¯¼å™¨ä½œç”¨ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¯åŠ¨éƒ½è¦åšäº›ä»€ä¹ˆï¼Ÿã€‹çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨å¼•å¯¼å™¨æ­å»ºæœåŠ¡ç«¯çš„åŸºæœ¬æ¡†æ¶ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªæœ€ç®€å•çš„ Echo æœåŠ¡å™¨ï¼Œç”¨äºè°ƒè¯• Netty æœåŠ¡ç«¯å¯åŠ¨çš„æºç ã€‚</p>
<pre tabindex="0"><code>public class EchoServer {

    public void startEchoServer(int port) throws Exception {

        EventLoopGroup bossGroup = new NioEventLoopGroup();

        EventLoopGroup workerGroup = new NioEventLoopGroup();

        try {

            ServerBootstrap b = new ServerBootstrap();

            b.group(bossGroup, workerGroup)

                    .channel(NioServerSocketChannel.class)

                    .handler(new LoggingHandler(LogLevel.INFO)) // è®¾ç½®ServerSocketChannel å¯¹åº”çš„ Handler

                    .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() { // è®¾ç½® SocketChannel å¯¹åº”çš„ Handler

                        @Override

                        public void initChannel(SocketChannel ch) {

                            ch.pipeline().addLast(new FixedLengthFrameDecoder(10));

                            ch.pipeline().addLast(new ResponseSampleEncoder());

                            ch.pipeline().addLast(new RequestSampleHandler());

                        }

                    });

            ChannelFuture f = b.bind(port).sync();

            f.channel().closeFuture().sync();

        } finally {

            bossGroup.shutdownGracefully();

            workerGroup.shutdownGracefully();

        }

    }

}
</code></pre><p>æˆ‘ä»¬ä»¥å¼•å¯¼å™¨ ServerBootstrap ä¸ºåˆ‡å…¥ç‚¹ï¼Œå¼€å§‹æ·±å…¥åˆ†æ Netty æœåŠ¡ç«¯çš„å¯åŠ¨æµç¨‹ã€‚åœ¨æœåŠ¡ç«¯å¯åŠ¨ä¹‹å‰ï¼Œéœ€è¦é…ç½® ServerBootstrap çš„ç›¸å…³å‚æ•°ï¼Œè¿™ä¸€æ­¥å¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>é…ç½® EventLoopGroup çº¿ç¨‹ç»„ï¼›</li>
<li>é…ç½® Channel çš„ç±»å‹ï¼›</li>
<li>è®¾ç½® ServerSocketChannel å¯¹åº”çš„ Handlerï¼›</li>
<li>è®¾ç½®ç½‘ç»œç›‘å¬çš„ç«¯å£ï¼›</li>
<li>è®¾ç½® SocketChannel å¯¹åº”çš„ Handlerï¼›</li>
<li>é…ç½® Channel å‚æ•°ã€‚</li>
</ul>
<p>é…ç½® ServerBootstrap å‚æ•°çš„è¿‡ç¨‹éå¸¸ç®€å•ï¼ŒæŠŠå‚æ•°å€¼ä¿å­˜åœ¨ ServerBootstrap å®šä¹‰çš„æˆå‘˜å˜é‡é‡Œå°±å¯ä»¥äº†ã€‚æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹ ServerBootstrap çš„æˆå‘˜å˜é‡å®šä¹‰ï¼ŒåŸºæœ¬ä¸ ServerBootstrap æš´éœ²å‡ºæ¥çš„é…ç½®æ–¹æ³•æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘ä»¥æ³¨é‡Šçš„å½¢å¼è¯´æ˜æ¯ä¸ªæˆå‘˜å˜é‡å¯¹åº”çš„è°ƒç”¨æ–¹æ³•ã€‚</p>
<pre tabindex="0"><code>volatile EventLoopGroup group; // group()

volatile EventLoopGroup childGroup; // group()

volatile ChannelFactory&lt;? extends C&gt; channelFactory; // channel()

volatile SocketAddress localAddress; // localAddress

Map&lt;ChannelOption&lt;?&gt;, Object&gt; childOptions = new ConcurrentHashMap&lt;ChannelOption&lt;?&gt;, Object&gt;(); // childOption()

volatile ChannelHandler childHandler; // childHandler()

ServerBootstrapConfig config = new ServerBootstrapConfig(this);
</code></pre><p>å…³äº ServerBootstrap å¦‚ä½•ä¸ºæ¯ä¸ªæˆå‘˜å˜é‡ä¿å­˜å‚æ•°çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å°±ä¸ä¸€ä¸€å±•å¼€äº†ï¼Œä½ å¯ä»¥ç†è§£ä¸ºè¿™éƒ¨åˆ†å·¥ä½œåªæ˜¯ä¸€ä¸ªå‰ç½®å‡†å¤‡ï¼Œè¯¾åä½ å¯ä»¥è‡ªå·±è·Ÿè¿›ä¸‹æ¯ä¸ªæ–¹æ³•çš„æºç ã€‚ä»Šå¤©æˆ‘ä»¬æ ¸å¿ƒèšç„¦åœ¨ b.bind().sync() è¿™è¡Œä»£ç ï¼Œbind() æ‰æ˜¯çœŸæ­£è¿›è¡ŒæœåŠ¡å™¨ç«¯å£ç»‘å®šå’Œå¯åŠ¨çš„å…¥å£ï¼Œsync() è¡¨ç¤ºé˜»å¡ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨å®Œæˆã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å¯¹ bind() æ–¹æ³•è¿›è¡Œå±•å¼€åˆ†æã€‚</p>
<p>åœ¨å¼€å§‹æºç åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬å¸¦ç€ä»¥ä¸‹å‡ ä¸ªé—®é¢˜è¾¹çœ‹è¾¹æ€è€ƒï¼š</p>
<ul>
<li>Netty è‡ªå·±å®ç°çš„ Channel ä¸ JDK åº•å±‚çš„ Channel æ˜¯å¦‚ä½•äº§ç”Ÿè”ç³»çš„ï¼Ÿ</li>
<li>ChannelInitializer è¿™ä¸ªç‰¹æ®Šçš„ Handler å¤„ç†å™¨çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</li>
<li>Pipeline åˆå§‹åŒ–çš„è¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</li>
</ul>
<h3 id="æœåŠ¡ç«¯å¯åŠ¨å…¨è¿‡ç¨‹">æœåŠ¡ç«¯å¯åŠ¨å…¨è¿‡ç¨‹</h3>
<p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸‹ ServerBootstrap ä¸­ bind() æ–¹æ³•çš„æºç å®ç°ï¼š</p>
<pre tabindex="0"><code>public ChannelFuture bind() {

    validate();

    SocketAddress localAddress = this.localAddress;

    if (localAddress == null) {

        throw new IllegalStateException(&quot;localAddress not set&quot;);

    }

    return doBind(localAddress);

}

private ChannelFuture doBind(final SocketAddress localAddress) {

    final ChannelFuture regFuture = initAndRegister();

    final Channel channel = regFuture.channel();

    if (regFuture.cause() != null) {

        return regFuture;

    }

    if (regFuture.isDone()) {

        ChannelPromise promise = channel.newPromise();

        doBind0(regFuture, channel, localAddress, promise);

        return promise;

    } else {

        final PendingRegistrationPromise promise = new PendingRegistrationPromise(channel);

        regFuture.addListener(new ChannelFutureListener() {

            @Override

            public void operationComplete(ChannelFuture future) throws Exception {

                Throwable cause = future.cause();

                if (cause != null) {

                    promise.setFailure(cause);

                } else {

                    promise.registered();

                    doBind0(regFuture, channel, localAddress, promise);

                }

            }

        });

        return promise;

    }

}
</code></pre><p>ç”±æ­¤å¯è§ï¼ŒdoBind() æ–¹æ³•æ˜¯æˆ‘ä»¬éœ€è¦åˆ†æçš„é‡ç‚¹ã€‚æˆ‘ä»¬å†ä¸€èµ·çœ‹ä¸‹ doBind() å…·ä½“åšäº†å“ªäº›äº‹æƒ…ï¼š</p>
<ol>
<li>è°ƒç”¨ initAndRegister() åˆå§‹åŒ–å¹¶æ³¨å†Œ Channelï¼ŒåŒæ—¶è¿”å›ä¸€ä¸ª ChannelFuture å®ä¾‹ regFutureï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥çŒœæµ‹å‡º initAndRegister() æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„è¿‡ç¨‹ã€‚</li>
<li>æ¥ä¸‹æ¥é€šè¿‡ regFuture.cause() æ–¹æ³•åˆ¤æ–­ initAndRegister() çš„è¿‡ç¨‹æ˜¯å¦å‘ç”Ÿå¼‚å¸¸ï¼Œå¦‚æœå‘ç”Ÿå¼‚å¸¸åˆ™ç›´æ¥è¿”å›ã€‚</li>
<li>regFuture.isDone() è¡¨ç¤º initAndRegister() æ˜¯å¦æ‰§è¡Œå®Œæ¯•ï¼Œå¦‚æœæ‰§è¡Œå®Œæ¯•åˆ™è°ƒç”¨ doBind0() è¿›è¡Œ Socket ç»‘å®šã€‚å¦‚æœ initAndRegister() è¿˜æ²¡æœ‰æ‰§è¡Œç»“æŸï¼ŒregFuture ä¼šæ·»åŠ ä¸€ä¸ª ChannelFutureListener å›è°ƒç›‘å¬ï¼Œå½“ initAndRegister() æ‰§è¡Œç»“æŸåä¼šè°ƒç”¨ operationComplete()ï¼ŒåŒæ ·é€šè¿‡ doBind0() è¿›è¡Œç«¯å£ç»‘å®šã€‚</li>
</ol>
<p>doBind() æ•´ä¸ªå®ç°ç»“æ„éå¸¸æ¸…æ™°ï¼Œå…¶ä¸­ initAndRegister() è´Ÿè´£ Channel åˆå§‹åŒ–å’Œæ³¨å†Œï¼ŒdoBind0() ç”¨äºç«¯å£ç»‘å®šã€‚è¿™ä¸¤ä¸ªè¿‡ç¨‹æœ€ä¸ºé‡è¦ï¼Œä¸‹é¢æˆ‘ä»¬åˆ†åˆ«è¿›è¡Œè¯¦ç»†çš„ä»‹ç»ã€‚</p>
<h3 id="æœåŠ¡ç«¯-channel-åˆå§‹åŒ–åŠæ³¨å†Œ">æœåŠ¡ç«¯ Channel åˆå§‹åŒ–åŠæ³¨å†Œ</h3>
<p>initAndRegister() æ–¹æ³•é¡¾åæ€ä¹‰ï¼Œä¸»è¦è´Ÿè´£åˆå§‹åŒ–å’Œæ³¨å†Œçš„ç›¸å…³å·¥ä½œï¼Œæˆ‘ä»¬å…·ä½“çœ‹ä¸‹å®ƒçš„æºç å®ç°ï¼š</p>
<pre tabindex="0"><code>final ChannelFuture initAndRegister() {

    Channel channel = null;

    try {

        channel = channelFactory.newChannel(); // åˆ›å»º Channel

        init(channel); // åˆå§‹åŒ– Channel

    } catch (Throwable t) {

        if (channel != null) {

            channel.unsafe().closeForcibly();

            return new DefaultChannelPromise(channel, GlobalEventExecutor.INSTANCE).setFailure(t);

        }

        return new DefaultChannelPromise(new FailedChannel(), GlobalEventExecutor.INSTANCE).setFailure(t);

    }

    ChannelFuture regFuture = config().group().register(channel); // æ³¨å†Œ Channel

    if (regFuture.cause() != null) {

        if (channel.isRegistered()) {

            channel.close();

        } else {

            channel.unsafe().closeForcibly();

        }

    }

    return regFuture;

}
</code></pre><p>initAndRegister() å¯ä»¥åˆ†ä¸ºä¸‰æ­¥ï¼šåˆ›å»º Channelã€åˆå§‹åŒ– Channel å’Œæ³¨å†Œ Channelï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¸€æ­¥æ­¥è¿›è¡Œæ‹†è§£åˆ†æã€‚</p>
<h4 id="åˆ›å»ºæœåŠ¡ç«¯-channel">åˆ›å»ºæœåŠ¡ç«¯ Channel</h4>
<p>é¦–å…ˆçœ‹ä¸‹åˆ›å»º Channel çš„è¿‡ç¨‹ï¼Œç›´æ¥è·Ÿè¿› channelFactory.newChannel() çš„æºç ã€‚</p>
<pre tabindex="0"><code>public class ReflectiveChannelFactory&lt;T extends Channel&gt; implements ChannelFactory&lt;T&gt; {

    private final Constructor&lt;? extends T&gt; constructor;

    public ReflectiveChannelFactory(Class&lt;? extends T&gt; clazz) {

        ObjectUtil.checkNotNull(clazz, &quot;clazz&quot;);

        try {

            this.constructor = clazz.getConstructor();

        } catch (NoSuchMethodException e) {

            throw new IllegalArgumentException(&quot;Class &quot; + StringUtil.simpleClassName(clazz) +

                    &quot; does not have a public non-arg constructor&quot;, e);

        }

    }

    @Override

    public T newChannel() {

        try {

            return constructor.newInstance(); // åå°„åˆ›å»ºå¯¹è±¡

        } catch (Throwable t) {

            throw new ChannelException(&quot;Unable to create Channel from class &quot; + constructor.getDeclaringClass(), t);

        }

    }

    // çœç•¥å…¶ä»–ä»£ç 

}
</code></pre><p>åœ¨å‰é¢ Echo æœåŠ¡å™¨çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ channel(NioServerSocketChannel.class) é…ç½® Channel çš„ç±»å‹ï¼Œå·¥å‚ç±» ReflectiveChannelFactory æ˜¯åœ¨è¯¥è¿‡ç¨‹ä¸­è¢«åˆ›å»ºçš„ã€‚ä» constructor.newInstance() æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒReflectiveChannelFactory é€šè¿‡åå°„åˆ›å»ºå‡º NioServerSocketChannel å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡ç‚¹éœ€è¦å…³æ³¨ NioServerSocketChannel çš„æ„é€ å‡½æ•°ã€‚</p>
<pre tabindex="0"><code>public NioServerSocketChannel() {

    this(newSocket(DEFAULT_SELECTOR_PROVIDER)); 

}

public NioServerSocketChannel(ServerSocketChannel channel) {

    super(null, channel, SelectionKey.OP_ACCEPT); // è°ƒç”¨çˆ¶ç±»æ–¹æ³•

    config = new NioServerSocketChannelConfig(this, javaChannel().socket());

}

private static ServerSocketChannel newSocket(SelectorProvider provider) {

    try {

        return provider.openServerSocketChannel(); // åˆ›å»º JDK åº•å±‚çš„ ServerSocketChannel

    } catch (IOException e) {

        throw new ChannelException(

                &quot;Failed to open a server socket.&quot;, e);

    }

}
</code></pre><p>SelectorProvider æ˜¯ JDK NIO ä¸­çš„æŠ½è±¡ç±»å®ç°ï¼Œé€šè¿‡ openServerSocketChannel() æ–¹æ³•å¯ä»¥ç”¨äºåˆ›å»ºæœåŠ¡ç«¯çš„ ServerSocketChannelã€‚è€Œä¸” SelectorProvider ä¼šæ ¹æ®æ“ä½œç³»ç»Ÿç±»å‹å’Œç‰ˆæœ¬çš„ä¸åŒï¼Œè¿”å›ä¸åŒçš„å®ç°ç±»ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ DefaultSelectorProvider çš„æºç å®ç°ï¼š</p>
<pre tabindex="0"><code>public static SelectorProvider create() {

    String osname = AccessController

        .doPrivileged(new GetPropertyAction(&quot;os.name&quot;));

    if (osname.equals(&quot;SunOS&quot;))

        return createProvider(&quot;sun.nio.ch.DevPollSelectorProvider&quot;);

    if (osname.equals(&quot;Linux&quot;))

        return createProvider(&quot;sun.nio.ch.EPollSelectorProvider&quot;);

    return new sun.nio.ch.PollSelectorProvider();

}
</code></pre><p>åœ¨è¿™é‡Œæˆ‘ä»¬åªè®¨è®º Linux æ“ä½œç³»ç»Ÿçš„åœºæ™¯ï¼Œåœ¨ Linux å†…æ ¸ 2.6ç‰ˆæœ¬åŠä»¥ä¸Šéƒ½ä¼šé»˜è®¤é‡‡ç”¨ EPollSelectorProviderã€‚å¦‚æœæ˜¯æ—§ç‰ˆæœ¬åˆ™ä½¿ç”¨ PollSelectorProviderã€‚å¯¹äºç›®å‰çš„ä¸»æµ Linux å¹³å°è€Œè¨€ï¼Œéƒ½æ˜¯é‡‡ç”¨ Epoll æœºåˆ¶å®ç°çš„ã€‚</p>
<p>åˆ›å»ºå®Œ ServerSocketChannelï¼Œæˆ‘ä»¬å›åˆ° NioServerSocketChannel çš„æ„é€ å‡½æ•°ï¼Œæ¥ç€å®ƒä¼šé€šè¿‡ super() ä¾æ¬¡è°ƒç”¨åˆ°çˆ¶ç±»çš„æ„é€ è¿›è¡Œåˆå§‹åŒ–å·¥ä½œï¼Œæœ€ç»ˆæˆ‘ä»¬å¯ä»¥å®šä½åˆ° AbstractNioChannel å’Œ AbstractChannel çš„æ„é€ å‡½æ•°ï¼š</p>
<pre tabindex="0"><code>protected AbstractNioChannel(Channel parent, SelectableChannel ch, int readInterestOp) {

    super(parent);

    // çœç•¥å…¶ä»–ä»£ç 

    try {

        ch.configureBlocking(false);

    } catch (IOException e) {

        // çœç•¥å…¶ä»–ä»£ç 

    }

}

protected AbstractChannel(Channel parent) {

    this.parent = parent;

    id = newId(); // Channel å…¨å±€å”¯ä¸€ id 

    unsafe = newUnsafe(); // unsafe æ“ä½œåº•å±‚è¯»å†™

    pipeline = newChannelPipeline(); // pipeline è´Ÿè´£ä¸šåŠ¡å¤„ç†å™¨ç¼–æ’

}
</code></pre><p>é¦–å…ˆè°ƒç”¨ AbstractChannel çš„æ„é€ å‡½æ•°åˆ›å»ºäº†ä¸‰ä¸ªé‡è¦çš„æˆå‘˜å˜é‡ï¼Œåˆ†åˆ«ä¸º idã€unsafeã€pipelineã€‚id è¡¨ç¤ºå…¨å±€å”¯ä¸€çš„ Channelï¼Œunsafe ç”¨äºæ“ä½œåº•å±‚æ•°æ®çš„è¯»å†™æ“ä½œï¼Œpipeline è´Ÿè´£ä¸šåŠ¡å¤„ç†å™¨çš„ç¼–æ’ã€‚åˆå§‹åŒ–çŠ¶æ€ï¼Œpipeline çš„å†…éƒ¨ç»“æ„åªåŒ…å«å¤´å°¾ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ä¸‰ä¸ªæ ¸å¿ƒæˆå‘˜å˜é‡åˆ›å»ºå¥½ä¹‹åï¼Œä¼šå›åˆ° AbstractNioChannel çš„æ„é€ å‡½æ•°ï¼Œé€šè¿‡ ch.configureBlocking(false) è®¾ç½® Channel æ˜¯éé˜»å¡æ¨¡å¼ã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F_V_rKAO2pAAANaFwMrmS4362.png" alt="netty17å›¾.png"></p>
<p>åˆ›å»ºæœåŠ¡ç«¯ Channel çš„è¿‡ç¨‹æˆ‘ä»¬å·²ç»è®²å®Œäº†ï¼Œç®€å•æ€»ç»“ä¸‹å…¶ä¸­å‡ ä¸ªé‡è¦çš„æ­¥éª¤ï¼š</p>
<ol>
<li>ReflectiveChannelFactory é€šè¿‡åå°„åˆ›å»º NioServerSocketChannel å®ä¾‹ï¼›</li>
<li>åˆ›å»º JDK åº•å±‚çš„ ServerSocketChannelï¼›</li>
<li>ä¸º Channel åˆ›å»º idã€unsafeã€pipeline ä¸‰ä¸ªé‡è¦çš„æˆå‘˜å˜é‡ï¼›</li>
<li>è®¾ç½® Channel ä¸ºéé˜»å¡æ¨¡å¼ã€‚</li>
</ol>
<h4 id="åˆå§‹åŒ–æœåŠ¡ç«¯-channel">åˆå§‹åŒ–æœåŠ¡ç«¯ Channel</h4>
<p>å›åˆ° ServerBootstrap çš„ initAndRegister() æ–¹æ³•ï¼Œç»§ç»­è·Ÿè¿›ç”¨äºåˆå§‹åŒ–æœåŠ¡ç«¯ Channel çš„ init() æ–¹æ³•æºç ï¼š</p>
<pre tabindex="0"><code>void init(Channel channel) {

    setChannelOptions(channel, options0().entrySet().toArray(newOptionArray(0)), logger); // è®¾ç½® Socket å‚æ•°

    setAttributes(channel, attrs0().entrySet().toArray(newAttrArray(0))); // ä¿å­˜ç”¨æˆ·è‡ªå®šä¹‰å±æ€§

    ChannelPipeline p = channel.pipeline();

    // è·å– ServerBootstrapAcceptor çš„æ„é€ å‚æ•°

    final EventLoopGroup currentChildGroup = childGroup;

    final ChannelHandler currentChildHandler = childHandler;

    final Entry&lt;ChannelOption&lt;?&gt;, Object&gt;[] currentChildOptions =

            childOptions.entrySet().toArray(newOptionArray(0));

    final Entry&lt;AttributeKey&lt;?&gt;, Object&gt;[] currentChildAttrs = childAttrs.entrySet().toArray(newAttrArray(0));

    // æ·»åŠ ç‰¹æ®Šçš„ Handler å¤„ç†å™¨

    p.addLast(new ChannelInitializer&lt;Channel&gt;() {

        @Override

        public void initChannel(final Channel ch) {

            final ChannelPipeline pipeline = ch.pipeline();

            ChannelHandler handler = config.handler();

            if (handler != null) {

                pipeline.addLast(handler);

            }

            ch.eventLoop().execute(new Runnable() {

                @Override

                public void run() {

                    pipeline.addLast(new ServerBootstrapAcceptor(

                            ch, currentChildGroup, currentChildHandler, currentChildOptions, currentChildAttrs));

                }

            });

        }

    });

}
</code></pre><p>init() æ–¹æ³•çš„æºç æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬ä¾ç„¶æ‹†è§£æˆä¸¤ä¸ªéƒ¨åˆ†æ¥çœ‹ï¼š</p>
<p>ç¬¬ä¸€æ­¥ï¼Œè®¾ç½® Socket å‚æ•°ä»¥åŠç”¨æˆ·è‡ªå®šä¹‰å±æ€§ã€‚åœ¨åˆ›å»ºæœåŠ¡ç«¯ Channel æ—¶ï¼ŒChannel çš„é…ç½®å‚æ•°ä¿å­˜åœ¨ NioServerSocketChannelConfig ä¸­ï¼Œåœ¨åˆå§‹åŒ– Channel çš„è¿‡ç¨‹ä¸­ï¼ŒNetty ä¼šå°†è¿™äº›å‚æ•°è®¾ç½®åˆ° JDK åº•å±‚çš„ Socket ä¸Šï¼Œå¹¶æŠŠç”¨æˆ·è‡ªå®šä¹‰çš„å±æ€§ç»‘å®šåœ¨ Channel ä¸Šã€‚</p>
<p>ç¬¬äºŒæ­¥ï¼Œæ·»åŠ ç‰¹æ®Šçš„ Handler å¤„ç†å™¨ã€‚é¦–å…ˆ ServerBootstrap ä¸º Pipeline æ·»åŠ äº†ä¸€ä¸ª ChannelInitializerï¼ŒChannelInitializer æ˜¯å®ç°äº† ChannelHandler æ¥å£çš„åŒ¿åç±»ï¼Œå…¶ä¸­ ChannelInitializer å®ç°çš„ initChannel() æ–¹æ³•ç”¨äºæ·»åŠ  ServerSocketChannel å¯¹åº”çš„ Handlerã€‚ç„¶å Netty é€šè¿‡å¼‚æ­¥ task çš„æ–¹å¼åˆå‘ Pipeline ä¸€ä¸ªå¤„ç†å™¨ ServerBootstrapAcceptorï¼Œä» ServerBootstrapAcceptor çš„å‘½åå¯ä»¥çœ‹å‡ºï¼Œè¿™æ˜¯ä¸€ä¸ªè¿æ¥æ¥å…¥å™¨ï¼Œä¸“é—¨ç”¨äºæ¥æ”¶æ–°çš„è¿æ¥ï¼Œç„¶åæŠŠäº‹ä»¶åˆ†å‘ç»™ EventLoop æ‰§è¡Œï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å…ˆä¸åšå±•å¼€ã€‚æ­¤æ—¶æœåŠ¡ç«¯çš„ pipeline å†…éƒ¨ç»“æ„åˆå‘ç”Ÿäº†å˜åŒ–ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F_V_y-Adn6LAAKfSPwUO3g505.png" alt="å›¾ç‰‡1.png"></p>
<p>æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆéœ€è¦ ChannelInitializer å¤„ç†å™¨å‘¢ï¼ŸServerBootstrapAcceptor çš„æ³¨å†Œè¿‡ç¨‹ä¸ºä»€ä¹ˆåˆéœ€è¦å°è£…æˆå¼‚æ­¥ task å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬åœ¨åˆå§‹åŒ–æ—¶ï¼Œè¿˜æ²¡æœ‰å°† Channel æ³¨å†Œåˆ° Selector å¯¹è±¡ä¸Šï¼Œæ‰€ä»¥è¿˜æ— æ³•æ³¨å†Œ Accept äº‹ä»¶åˆ° Selector ä¸Šï¼Œæ‰€ä»¥äº‹å…ˆæ·»åŠ äº† ChannelInitializer å¤„ç†å™¨ï¼Œç­‰å¾… Channel æ³¨å†Œå®Œæˆåï¼Œå†å‘ Pipeline ä¸­æ·»åŠ  ServerBootstrapAcceptor å¤„ç†å™¨ã€‚</p>
<p>æœåŠ¡ç«¯ Channel åˆå§‹åŒ–çš„è¿‡ç¨‹å·²ç»ç»“æŸäº†ã€‚æ•´ä½“æµç¨‹æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯è®¾ç½® Socket å‚æ•°ä»¥åŠç”¨æˆ·è‡ªå®šä¹‰å±æ€§ï¼Œå¹¶å‘ Pipeline ä¸­æ·»åŠ äº†ä¸¤ä¸ªç‰¹æ®Šçš„å¤„ç†å™¨ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­åˆ†æï¼Œå¦‚ä½•å°†åˆå§‹åŒ–å¥½çš„ Channel æ³¨å†Œåˆ° Selector å¯¹è±¡ä¸Šï¼Ÿ</p>
<h4 id="æ³¨å†ŒæœåŠ¡ç«¯-channel">æ³¨å†ŒæœåŠ¡ç«¯ Channel</h4>
<p>å›åˆ° initAndRegister() çš„ä¸»æµç¨‹ï¼Œåˆ›å»ºå®ŒæœåŠ¡ç«¯ Channel ä¹‹åï¼Œç»§ç»­ä¸€å±‚å±‚è·Ÿè¿› register() æ–¹æ³•çš„æºç ï¼š</p>
<pre tabindex="0"><code>// MultithreadEventLoopGroup#register

public ChannelFuture register(Channel channel) {

    return next().register(channel); // é€‰æ‹©ä¸€ä¸ª eventLoop æ³¨å†Œ

}

// AbstractChannel#register

public final void register(EventLoop eventLoop, final ChannelPromise promise) {

    // çœç•¥å…¶ä»–ä»£ç 

    AbstractChannel.this.eventLoop = eventLoop;

    if (eventLoop.inEventLoop()) { // Reactor çº¿ç¨‹å†…éƒ¨è°ƒç”¨

        register0(promise);

    } else { // å¤–éƒ¨çº¿ç¨‹è°ƒç”¨

        try {

            eventLoop.execute(new Runnable() {

                @Override

                public void run() {

                    register0(promise);

                }

            });

        } catch (Throwable t) {

            // çœç•¥å…¶ä»–ä»£ç 

        }

    }

}
</code></pre><p>Netty ä¼šåœ¨çº¿ç¨‹æ±  EventLoopGroup ä¸­é€‰æ‹©ä¸€ä¸ª EventLoop ä¸å½“å‰ Channel è¿›è¡Œç»‘å®šï¼Œä¹‹å Channel ç”Ÿå‘½å‘¨æœŸå†…çš„æ‰€æœ‰ I/O äº‹ä»¶éƒ½ç”±è¿™ä¸ª EventLoop è´Ÿè´£å¤„ç†ï¼Œå¦‚ acceptã€connectã€readã€write ç­‰ I/O äº‹ä»¶ã€‚å¯ä»¥çœ‹å‡ºï¼Œä¸ç®¡æ˜¯ EventLoop çº¿ç¨‹æœ¬èº«è°ƒç”¨ï¼Œè¿˜æ˜¯å¤–éƒ¨çº¿ç¨‹ç”¨ï¼Œæœ€ç»ˆéƒ½ä¼šé€šè¿‡ register0() æ–¹æ³•è¿›è¡Œæ³¨å†Œï¼š</p>
<pre tabindex="0"><code>private void register0(ChannelPromise promise) {

    try {

        if (!promise.setUncancellable() || !ensureOpen(promise)) {

            return;

        }

        boolean firstRegistration = neverRegistered;

        doRegister(); // è°ƒç”¨ JDK åº•å±‚çš„ register() è¿›è¡Œæ³¨å†Œ

        neverRegistered = false;

        registered = true;

        pipeline.invokeHandlerAddedIfNeeded(); // è§¦å‘ handlerAdded äº‹ä»¶

        safeSetSuccess(promise);

        pipeline.fireChannelRegistered(); // è§¦å‘ channelRegistered äº‹ä»¶

        // æ­¤æ—¶ Channel è¿˜æœªæ³¨å†Œç»‘å®šåœ°å€ï¼Œæ‰€ä»¥å¤„äºéæ´»è·ƒçŠ¶æ€

        if (isActive()) {

            if (firstRegistration) {

                pipeline.fireChannelActive(); // Channel å½“å‰çŠ¶æ€ä¸ºæ´»è·ƒæ—¶ï¼Œè§¦å‘ channelActive äº‹ä»¶

            } else if (config().isAutoRead()) {

                beginRead();

            }

        }

    } catch (Throwable t) {

        // çœç•¥å…¶ä»–ä»£ç 

    }

}
</code></pre><p>register0() ä¸»è¦åšäº†å››ä»¶äº‹ï¼šè°ƒç”¨ JDK åº•å±‚è¿›è¡Œ Channel æ³¨å†Œã€è§¦å‘ handlerAdded äº‹ä»¶ã€è§¦å‘ channelRegistered äº‹ä»¶ã€Channel å½“å‰çŠ¶æ€ä¸ºæ´»è·ƒæ—¶ï¼Œè§¦å‘ channelActive äº‹ä»¶ã€‚æˆ‘ä»¬å¯¹å®ƒä»¬é€ä¸€è¿›è¡Œåˆ†æã€‚</p>
<p>é¦–å…ˆçœ‹ä¸‹ JDK åº•å±‚æ³¨å†Œ Channel çš„è¿‡ç¨‹ï¼Œå¯¹åº” doRegister() æ–¹æ³•çš„å®ç°é€»è¾‘ã€‚</p>
<pre tabindex="0"><code>protected void doRegister() throws Exception {

    boolean selected = false;

    for (;;) {

        try {

            selectionKey = javaChannel().register(eventLoop().unwrappedSelector(), 0, this); // è°ƒç”¨ JDK åº•å±‚çš„ register() è¿›è¡Œæ³¨å†Œ

            return;

        } catch (CancelledKeyException e) {

            // çœç•¥å…¶ä»–ä»£ç 

        }

    }

}

public final SelectionKey register(Selector sel, int ops,

                                   Object att)

    throws ClosedChannelException

{

    synchronized (regLock) {

        // çœç•¥å…¶ä»–ä»£ç 

        SelectionKey k = findKey(sel);

        if (k != null) {

            k.interestOps(ops);

            k.attach(att);

        }

        if (k == null) {

            synchronized (keyLock) {

                if (!isOpen())

                    throw new ClosedChannelException();

                k = ((AbstractSelector)sel).register(this, ops, att);

                addKey(k);

            }

        }

        return k;

    }

}
</code></pre><p>javaChannel().register() è´Ÿè´£è°ƒç”¨ JDK åº•å±‚ï¼Œå°† Channel æ³¨å†Œåˆ° Selector ä¸Šï¼Œregister() çš„ç¬¬ä¸‰ä¸ªå…¥å‚ä¼ å…¥çš„æ˜¯ Netty è‡ªå·±å®ç°çš„ Channel å¯¹è±¡ï¼Œè°ƒç”¨ register() æ–¹æ³•ä¼šå°†å®ƒç»‘å®šåœ¨ JDK åº•å±‚ Channel çš„ attachment ä¸Šã€‚è¿™æ ·åœ¨æ¯æ¬¡ Selector å¯¹è±¡è¿›è¡Œäº‹ä»¶å¾ªç¯æ—¶ï¼ŒNetty éƒ½å¯ä»¥ä»è¿”å›çš„ JDK åº•å±‚ Channel ä¸­è·å¾—è‡ªå·±çš„ Channel å¯¹è±¡ã€‚</p>
<p>å®Œæˆ Channel å‘ Selector æ³¨å†Œåï¼Œæ¥ä¸‹æ¥å°±ä¼šè§¦å‘ Pipeline ä¸€ç³»åˆ—çš„äº‹ä»¶ä¼ æ’­ã€‚åœ¨äº‹ä»¶ä¼ æ’­ä¹‹å‰ï¼Œç”¨æˆ·è‡ªå®šä¹‰çš„ä¸šåŠ¡å¤„ç†å™¨æ˜¯å¦‚ä½•è¢«æ·»åŠ åˆ° Pipeline ä¸­çš„å‘¢ï¼Ÿç­”æ¡ˆå°±åœ¨pipeline.invokeHandlerAddedIfNeeded() å½“ä¸­ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸‹ handlerAdded äº‹ä»¶çš„å¤„ç†è¿‡ç¨‹ã€‚invokeHandlerAddedIfNeeded() æ–¹æ³•çš„è°ƒç”¨å±‚æ¬¡æ¯”è¾ƒæ·±ï¼Œæ¨èä½ ç»“åˆä¸Šè¿° Echo æœåŠ¡ç«¯ç¤ºä¾‹ï¼Œä½¿ç”¨ IDE Debug çš„æ–¹å¼è·Ÿè¸ªè°ƒç”¨æ ˆï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F_V_2-AGYmLAAu7ct-oDd4075.png" alt="å›¾ç‰‡2.png"></p>
<p>æˆ‘ä»¬é¦–å…ˆæŠ“ä½ ChannelInitializer ä¸­çš„æ ¸å¿ƒæºç ï¼Œé€å±‚è¿›è¡Œåˆ†æã€‚</p>
<pre tabindex="0"><code>// ChannelInitializer

public void handlerAdded(ChannelHandlerContext ctx) throws Exception {

    if (ctx.channel().isRegistered()) {

        if (initChannel(ctx)) {

            removeState(ctx);

        }

    }

}

private boolean initChannel(ChannelHandlerContext ctx) throws Exception {

    if (initMap.add(ctx)) {

        try {

            initChannel((C) ctx.channel()); // è°ƒç”¨ ChannelInitializer å®ç°çš„ initChannel() æ–¹æ³•

        } catch (Throwable cause) {

            exceptionCaught(ctx, cause);

        } finally {

            ChannelPipeline pipeline = ctx.pipeline();

            if (pipeline.context(this) != null) {

                pipeline.remove(this); // å°† ChannelInitializer è‡ªèº«ä» Pipeline ä¸­ç§»å‡º

            }

        }

        return true;

    }

    return false;

}
</code></pre><p>å¯ä»¥çœ‹å‡º ChannelInitializer é¦–å…ˆä¼šè°ƒç”¨ initChannel() æŠ½è±¡æ–¹æ³•ï¼Œç„¶å Netty ä¼šæŠŠ ChannelInitializer è‡ªèº«ä» Pipeline ç§»å‡ºã€‚å…¶ä¸­ initChannel() æŠ½è±¡æ–¹æ³•æ˜¯åœ¨å“ªé‡Œå®ç°çš„å‘¢ï¼Ÿè¿™å°±è¦è·Ÿè¸ªåˆ° ServerBootstrap ä¹‹å‰çš„ init() æ–¹æ³•ï¼Œå…¶ä¸­æœ‰è¿™ä¹ˆä¸€æ®µä»£ç ï¼š</p>
<pre tabindex="0"><code>p.addLast(new ChannelInitializer&lt;Channel&gt;() {

    @Override

    public void initChannel(final Channel ch) {

        final ChannelPipeline pipeline = ch.pipeline();

        ChannelHandler handler = config.handler();

        if (handler != null) {

            pipeline.addLast(handler);

        }

        ch.eventLoop().execute(new Runnable() {

            @Override

            public void run() {

                pipeline.addLast(new ServerBootstrapAcceptor(

                        ch, currentChildGroup, currentChildHandler, currentChildOptions, currentChildAttrs));

            }

        });

    }

});
</code></pre><p>åœ¨å‰é¢æˆ‘ä»¬å·²ç»åˆ†æäº† initChannel() æ–¹æ³•çš„å®ç°é€»è¾‘ï¼Œé¦–å…ˆå‘ Pipeline ä¸­æ·»åŠ  ServerSocketChannel å¯¹åº”çš„ Handlerï¼Œç„¶åé€šè¿‡å¼‚æ­¥ task çš„æ–¹å¼å‘ Pipeline æ·»åŠ  ServerBootstrapAcceptor å¤„ç†å™¨ã€‚å…¶ä¸­æœ‰ä¸€ä¸ªç‚¹ä¸è¦æ··æ·†ï¼Œhandler() æ–¹æ³•æ˜¯æ·»åŠ åˆ°æœåŠ¡ç«¯çš„Pipeline ä¸Šï¼Œè€Œ childHandler() æ–¹æ³•æ˜¯æ·»åŠ åˆ°å®¢æˆ·ç«¯çš„ Pipeline ä¸Šã€‚æ‰€ä»¥å¯¹åº” Echo æœåŠ¡å™¨ç¤ºä¾‹ä¸­ï¼Œæ­¤æ—¶è¢«æ·»åŠ çš„æ˜¯ LoggingHandler å¤„ç†å™¨ã€‚</p>
<p>å› ä¸ºæ·»åŠ  ServerBootstrapAcceptor æ˜¯ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹ï¼Œéœ€è¦ EventLoop çº¿ç¨‹è´Ÿè´£æ‰§è¡Œã€‚è€Œå½“å‰ EventLoop çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ register0() çš„æ³¨å†Œæµç¨‹ï¼Œæ‰€ä»¥ç­‰åˆ° register0() æ‰§è¡Œå®Œä¹‹åæ‰èƒ½è¢«æ·»åŠ åˆ° Pipeline å½“ä¸­ã€‚å®Œæˆ initChannel() è¿™ä¸€æ­¥ä¹‹åï¼ŒServerBootstrapAcceptor å¹¶æ²¡æœ‰è¢«æ·»åŠ åˆ° Pipeline ä¸­ï¼Œæ­¤æ—¶ Pipeline çš„å†…éƒ¨ç»“æ„å˜åŒ–å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F_V_5eAUGuoAAJsI9pISJU272.png" alt="å›¾ç‰‡3.png"></p>
<p>æˆ‘ä»¬å›åˆ° register0() çš„ä¸»æµç¨‹ï¼Œæ¥ç€å‘ä¸‹åˆ†æã€‚channelRegistered äº‹ä»¶æ˜¯ç”± fireChannelRegistered() æ–¹æ³•è§¦å‘ï¼Œæ²¿ç€ Pipeline çš„ Head èŠ‚ç‚¹ä¼ æ’­åˆ° Tail èŠ‚ç‚¹ï¼Œå¹¶ä¾æ¬¡è°ƒç”¨æ¯ä¸ª ChannelHandler çš„ channelRegistered() æ–¹æ³•ã€‚ç„¶è€Œæ­¤æ—¶ Channel è¿˜æœªæ³¨å†Œç»‘å®šåœ°å€ï¼Œæ‰€ä»¥å¤„äºéæ´»è·ƒçŠ¶æ€ï¼Œæ‰€ä»¥å¹¶ä¸ä¼šè§¦å‘ channelActive äº‹ä»¶ã€‚</p>
<p>æ‰§è¡Œå®Œæ•´ä¸ª register0() çš„æ³¨å†Œæµç¨‹ä¹‹åï¼ŒEventLoop çº¿ç¨‹ä¼šå°† ServerBootstrapAcceptor æ·»åŠ åˆ° Pipeline å½“ä¸­ï¼Œæ­¤æ—¶ Pipeline çš„å†…éƒ¨ç»“æ„åˆå‘ç”Ÿäº†å˜åŒ–ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F_V_7SAUkiOAAI_yPZd0NI396.png" alt="å›¾ç‰‡4.png"></p>
<p>æ•´ä¸ªæœåŠ¡ç«¯ Channel æ³¨å†Œçš„æµç¨‹æˆ‘ä»¬å·²ç»è®²å®Œï¼Œæ³¨å†Œè¿‡ç¨‹ä¸­ Pipeline ç»“æ„çš„å˜åŒ–å€¼å¾—ä½ å†åå¤æ¢³ç†ï¼Œä»è€ŒåŠ æ·±ç†è§£ã€‚ç›®å‰æœåŠ¡ç«¯è¿˜æ˜¯ä¸èƒ½å·¥ä½œçš„ï¼Œè¿˜å·®æœ€åä¸€æ­¥å°±æ˜¯è¿›è¡Œç«¯å£ç»‘å®šï¼Œæˆ‘ä»¬ç»§ç»­å‘ä¸‹åˆ†æã€‚</p>
<h4 id="ç«¯å£ç»‘å®š">ç«¯å£ç»‘å®š</h4>
<p>å›åˆ° ServerBootstrap çš„ bind() æ–¹æ³•ï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿè¿›ç«¯å£ç»‘å®š doBind0() çš„æºç ã€‚</p>
<pre tabindex="0"><code>public final void bind(final SocketAddress localAddress, final ChannelPromise promise) {

    assertEventLoop();

    // çœç•¥å…¶ä»–ä»£ç 

    boolean wasActive = isActive();

    try {

        doBind(localAddress); // è°ƒç”¨ JDK åº•å±‚è¿›è¡Œç«¯å£ç»‘å®š

    } catch (Throwable t) {

        safeSetFailure(promise, t);

        closeIfClosed();

        return;

    }

    if (!wasActive &amp;&amp; isActive()) {

        invokeLater(new Runnable() {

            @Override

            public void run() {

                pipeline.fireChannelActive(); // è§¦å‘ channelActive äº‹ä»¶

            }

        });

    }

    safeSetSuccess(promise);

}
</code></pre><p>bind() æ–¹æ³•ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼Œåˆ†åˆ«ä¸ºè°ƒç”¨ JDK åº•å±‚è¿›è¡Œç«¯å£ç»‘å®šï¼›ç»‘å®šæˆåŠŸåå¹¶è§¦å‘ channelActive äº‹ä»¶ã€‚ä¸‹é¢æˆ‘ä»¬é€ä¸€è¿›è¡Œåˆ†æã€‚</p>
<p>é¦–å…ˆçœ‹ä¸‹è°ƒç”¨ JDK åº•å±‚è¿›è¡Œç«¯å£ç»‘å®šçš„ doBind() æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>protected void doBind(SocketAddress localAddress) throws Exception {

    if (PlatformDependent.javaVersion() &gt;= 7) {

        javaChannel().bind(localAddress, config.getBacklog());

    } else {

        javaChannel().socket().bind(localAddress, config.getBacklog());

    }

}
</code></pre><p>Netty ä¼šæ ¹æ® JDK ç‰ˆæœ¬çš„ä¸åŒï¼Œåˆ†åˆ«è°ƒç”¨ JDK åº•å±‚ä¸åŒçš„ bind() æ–¹æ³•ã€‚æˆ‘ä½¿ç”¨çš„æ˜¯ JDK8ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨ JDK åŸç”Ÿ Channel çš„ bind() æ–¹æ³•ã€‚æ‰§è¡Œå®Œ doBind() ä¹‹åï¼ŒæœåŠ¡ç«¯ JDK åŸç”Ÿçš„ Channel çœŸæ­£å·²ç»å®Œæˆç«¯å£ç»‘å®šäº†ã€‚</p>
<p>å®Œæˆç«¯å£ç»‘å®šä¹‹åï¼ŒChannel å¤„äºæ´»è·ƒ Active çŠ¶æ€ï¼Œç„¶åä¼šè°ƒç”¨ pipeline.fireChannelActive() æ–¹æ³•è§¦å‘ channelActive äº‹ä»¶ã€‚æˆ‘ä»¬å¯ä»¥ä¸€å±‚å±‚è·Ÿè¿› fireChannelActive() æ–¹æ³•ï¼Œå‘ç°å…¶ä¸­æ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†ï¼š</p>
<pre tabindex="0"><code>// DefaultChannelPipeline#channelActive

public void channelActive(ChannelHandlerContext ctx) {

    ctx.fireChannelActive();

    readIfIsAutoRead();

}

// AbstractNioChannel#doBeginRead

protected void doBeginRead() throws Exception {

    // Channel.read() or ChannelHandlerContext.read() was called

    final SelectionKey selectionKey = this.selectionKey;

    if (!selectionKey.isValid()) {

        return;

    }

    readPending = true;

    final int interestOps = selectionKey.interestOps();

    if ((interestOps &amp; readInterestOp) == 0) {

        selectionKey.interestOps(interestOps | readInterestOp); // æ³¨å†Œ OP_ACCEPT äº‹ä»¶åˆ°æœåŠ¡ç«¯ Channel çš„äº‹ä»¶é›†åˆ

    }

}
</code></pre><p>å¯ä»¥çœ‹å‡ºï¼Œåœ¨æ‰§è¡Œå®Œ channelActive äº‹ä»¶ä¼ æ’­ä¹‹åï¼Œä¼šè°ƒç”¨ readIfIsAutoRead() æ–¹æ³•è§¦å‘ Channel çš„ read äº‹ä»¶ï¼Œè€Œå®ƒæœ€ç»ˆè°ƒç”¨åˆ° AbstractNioChannel ä¸­çš„ doBeginRead() æ–¹æ³•ï¼Œå…¶ä¸­ readInterestOp å‚æ•°å°±æ˜¯åœ¨å‰é¢åˆå§‹åŒ– Channel æ‰€ä¼ å…¥çš„ SelectionKey.OP_ACCEPT äº‹ä»¶ï¼Œæ‰€ä»¥ OP_ACCEPT äº‹ä»¶ä¼šè¢«æ³¨å†Œåˆ° Channel çš„äº‹ä»¶é›†åˆä¸­ã€‚</p>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæ•´ä¸ªæœåŠ¡ç«¯å·²ç»çœŸæ­£å¯åŠ¨å®Œæ¯•ã€‚æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹æœåŠ¡ç«¯å¯åŠ¨çš„å…¨æµç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/CgqCHl_V_8-AFYYMAAHvZ2ePhWo232.png" alt="å›¾ç‰‡5.png"></p>
<ul>
<li><strong>åˆ›å»ºæœåŠ¡ç«¯ Channel</strong>ï¼šæœ¬è´¨æ˜¯åˆ›å»º JDK åº•å±‚åŸç”Ÿçš„ Channelï¼Œå¹¶åˆå§‹åŒ–å‡ ä¸ªé‡è¦çš„å±æ€§ï¼ŒåŒ…æ‹¬ idã€unsafeã€pipeline ç­‰ã€‚</li>
<li><strong>åˆå§‹åŒ–æœåŠ¡ç«¯ Channel</strong>ï¼šè®¾ç½® Socket å‚æ•°ä»¥åŠç”¨æˆ·è‡ªå®šä¹‰å±æ€§ï¼Œå¹¶æ·»åŠ ä¸¤ä¸ªç‰¹æ®Šçš„å¤„ç†å™¨ ChannelInitializer å’Œ ServerBootstrapAcceptorã€‚</li>
<li><strong>æ³¨å†ŒæœåŠ¡ç«¯ Channel</strong>ï¼šè°ƒç”¨ JDK åº•å±‚å°† Channel æ³¨å†Œåˆ° Selector ä¸Šã€‚</li>
<li><strong>ç«¯å£ç»‘å®š</strong>ï¼šè°ƒç”¨ JDK åº•å±‚è¿›è¡Œç«¯å£ç»‘å®šï¼Œå¹¶è§¦å‘ channelActive äº‹ä»¶ï¼ŒæŠŠ OP_ACCEPT äº‹ä»¶æ³¨å†Œåˆ° Channel çš„äº‹ä»¶é›†åˆä¸­ã€‚</li>
</ul>
<h3 id="åŠ é¤æœåŠ¡ç«¯å¦‚ä½•å¤„ç†å®¢æˆ·ç«¯æ–°å»ºè¿æ¥">åŠ é¤ï¼šæœåŠ¡ç«¯å¦‚ä½•å¤„ç†å®¢æˆ·ç«¯æ–°å»ºè¿æ¥</h3>
<p>Netty æœåŠ¡ç«¯å®Œå…¨å¯åŠ¨åï¼Œå°±å¯ä»¥å¯¹å¤–å·¥ä½œäº†ã€‚æ¥ä¸‹æ¥ Netty æœåŠ¡ç«¯æ˜¯å¦‚ä½•å¤„ç†å®¢æˆ·ç«¯æ–°å»ºè¿æ¥çš„å‘¢ï¼Ÿä¸»è¦åˆ†ä¸ºå››æ­¥ï¼š</p>
<ol>
<li>Boss NioEventLoop çº¿ç¨‹è½®è¯¢å®¢æˆ·ç«¯æ–°è¿æ¥ OP_ACCEPT äº‹ä»¶ï¼›</li>
<li>æ„é€  Netty å®¢æˆ·ç«¯ NioSocketChannelï¼›</li>
<li>æ³¨å†Œ Netty å®¢æˆ·ç«¯ NioSocketChannel åˆ° Worker å·¥ä½œçº¿ç¨‹ä¸­ï¼›</li>
<li>æ³¨å†Œ OP_READ äº‹ä»¶åˆ° NioSocketChannel çš„äº‹ä»¶é›†åˆã€‚</li>
</ol>
<p>ä¸‹é¢æˆ‘ä»¬å¯¹æ¯ä¸ªæ­¥éª¤é€ä¸€è¿›è¡Œç®€å•çš„ä»‹ç»ã€‚</p>
<p>Netty ä¸­ Boss NioEventLoop ä¸“é—¨è´Ÿè´£æ¥æ”¶æ–°çš„è¿æ¥ï¼Œå…³äº NioEventLoop çš„æ ¸å¿ƒæºç æˆ‘ä»¬ä¸‹èŠ‚è¯¾ä¼šç€é‡ä»‹ç»ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬åªå…ˆäº†è§£åŸºæœ¬çš„å¤„ç†æµç¨‹ã€‚å½“å®¢æˆ·ç«¯æœ‰æ–°è¿æ¥æ¥å…¥æœåŠ¡ç«¯æ—¶ï¼ŒBoss NioEventLoop ä¼šç›‘å¬åˆ° OP_ACCEPT äº‹ä»¶ï¼Œæºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>// NioEventLoop#processSelectedKey

if ((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) != 0 || readyOps == 0) {

    unsafe.read();

}
</code></pre><p>NioServerSocketChannel æ‰€æŒæœ‰çš„ unsafe æ˜¯ NioMessageUnsafe ç±»å‹ï¼Œæˆ‘ä»¬çœ‹ä¸‹ NioMessageUnsafe.read() æ–¹æ³•ä¸­åšäº†ä»€ä¹ˆäº‹ã€‚</p>
<pre tabindex="0"><code>public void read() {

    assert eventLoop().inEventLoop();

    final ChannelConfig config = config();

    final ChannelPipeline pipeline = pipeline();

    final RecvByteBufAllocator.Handle allocHandle = unsafe().recvBufAllocHandle(); 

    allocHandle.reset(config);

    boolean closed = false;

    Throwable exception = null;

    try {

        try {
            do {

                int localRead = doReadMessages(readBuf);  // while å¾ªç¯ä¸æ–­è¯»å– Buffer ä¸­çš„æ•°æ®

                if (localRead == 0) {

                    break;

                }

                if (localRead &lt; 0) {

                    closed = true;

                    break;

                }

                allocHandle.incMessagesRead(localRead);

            } while (allocHandle.continueReading());

        } catch (Throwable t) {

            exception = t;

        }

        int size = readBuf.size();

        for (int i = 0; i &lt; size; i ++) {

            readPending = false;

            pipeline.fireChannelRead(readBuf.get(i)); // ä¼ æ’­è¯»å–äº‹ä»¶

        }

        readBuf.clear();

        allocHandle.readComplete();

        pipeline.fireChannelReadComplete(); // ä¼ æ’­è¯»å–å®Œæ¯•äº‹ä»¶

        // çœç•¥å…¶ä»–ä»£ç 

    } finally {

        if (!readPending &amp;&amp; !config.isAutoRead()) {

            removeReadOp();

        }

    }

}
</code></pre><p>å¯ä»¥çœ‹å‡º read() æ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘å°±æ˜¯é€šè¿‡ while å¾ªç¯ä¸æ–­è¯»å–æ•°æ®ï¼Œç„¶åæ”¾å…¥ List ä¸­ï¼Œè¿™é‡Œçš„æ•°æ®å…¶å®å°±æ˜¯æ–°è¿æ¥ã€‚éœ€è¦é‡ç‚¹è·Ÿè¿›ä¸€ä¸‹ NioServerSocketChannel çš„ doReadMessages() æ–¹æ³•ã€‚</p>
<pre tabindex="0"><code>protected int doReadMessages(List&lt;Object&gt; buf) throws Exception {

    SocketChannel ch = SocketUtils.accept(javaChannel());

    try {

        if (ch != null) {

            buf.add(new NioSocketChannel(this, ch));

            return 1;

        }

    } catch (Throwable t) {

        logger.warn(&quot;Failed to create a new channel from an accepted socket.&quot;, t);

        try {

            ch.close();

        } catch (Throwable t2) {

            logger.warn(&quot;Failed to close a socket.&quot;, t2);

        }

    }

    return 0;

}
</code></pre><p>è¿™æ—¶å°±å¼€å§‹æ‰§è¡Œç¬¬äºŒä¸ªæ­¥éª¤ï¼šæ„é€  Netty å®¢æˆ·ç«¯ NioSocketChannelã€‚Netty å…ˆé€šè¿‡ JDK åº•å±‚çš„ accept() è·å– JDK åŸç”Ÿçš„ SocketChannelï¼Œç„¶åå°†å®ƒå°è£…æˆ Netty è‡ªå·±çš„ NioSocketChannelã€‚æ–°å»º Netty çš„å®¢æˆ·ç«¯ Channel çš„å®ç°åŸç†ä¸ä¸Šæ–‡ä¸­æˆ‘ä»¬è®²åˆ°çš„åˆ›å»ºæœåŠ¡ç«¯ Channel çš„è¿‡ç¨‹æ˜¯ç±»ä¼¼çš„ï¼Œåªæ˜¯æœåŠ¡ç«¯ Channel çš„ç±»å‹æ˜¯ NioServerSocketChannelï¼Œè€Œå®¢æˆ·ç«¯ Channel çš„ç±»å‹æ˜¯ NioSocketChannelã€‚NioSocketChannel çš„åˆ›å»ºåŒæ ·ä¼šå®Œæˆå‡ ä»¶äº‹ï¼šåˆ›å»ºæ ¸å¿ƒæˆå‘˜å˜é‡ idã€unsafeã€pipelineï¼›æ³¨å†Œ SelectionKey.OP_READ äº‹ä»¶ï¼›è®¾ç½® Channel çš„ä¸ºéé˜»å¡æ¨¡å¼ï¼›æ–°å»ºå®¢æˆ·ç«¯ Channel çš„é…ç½®ã€‚</p>
<p>æˆåŠŸæ„é€ å®¢æˆ·ç«¯ NioSocketChannel åï¼Œæ¥ä¸‹æ¥ä¼šé€šè¿‡ pipeline.fireChannelRead() è§¦å‘ channelRead äº‹ä»¶ä¼ æ’­ã€‚å¯¹äºæœåŠ¡ç«¯æ¥è¯´ï¼Œæ­¤æ—¶ Pipeline çš„å†…éƒ¨ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/CgqCHl_V__eAOXbQAALQ0Dt6N64798.png" alt="å›¾ç‰‡6.png"></p>
<p>ä¸Šæ–‡ä¸­æˆ‘ä»¬æåˆ°äº†ä¸€ç§ç‰¹æ®Šçš„å¤„ç†å™¨ ServerBootstrapAcceptorï¼Œåœ¨è¿™é‡Œå®ƒå°±å‘æŒ¥äº†é‡è¦çš„ä½œç”¨ã€‚channelRead äº‹ä»¶ä¼šä¼ æ’­åˆ° ServerBootstrapAcceptor.channelRead() æ–¹æ³•ï¼ŒchannelRead() ä¼šå°†å®¢æˆ·ç«¯ Channel åˆ†é…åˆ°å·¥ä½œçº¿ç¨‹ç»„ä¸­å»æ‰§è¡Œã€‚å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>public void channelRead(ChannelHandlerContext ctx, Object msg) {

    final Channel child = (Channel) msg;

    // åœ¨å®¢æˆ·ç«¯ Channel ä¸­æ·»åŠ  childHandlerï¼ŒchildHandler æ˜¯ç”¨æˆ·åœ¨å¯åŠ¨ç±»ä¸­é€šè¿‡ childHandler() æ–¹æ³•æŒ‡å®šçš„

    child.pipeline().addLast(childHandler);

    setChannelOptions(child, childOptions, logger);

    setAttributes(child, childAttrs);

    try {

        // æ³¨å†Œå®¢æˆ·ç«¯ Channel

        childGroup.register(child).addListener(new ChannelFutureListener() {

            @Override

            public void operationComplete(ChannelFuture future) throws Exception {

                if (!future.isSuccess()) {

                    forceClose(child, future.cause());

                }

            }

        });

    } catch (Throwable t) {

        forceClose(child, t);

    }

}
</code></pre><p>ServerBootstrapAcceptor å¼€å§‹å°±æŠŠ msg å¼ºåˆ¶è½¬æ¢ä¸º Channelã€‚éš¾é“ä¸ä¼šæœ‰å…¶ä»–ç±»å‹çš„æ•°æ®å—ï¼Ÿå› ä¸º ServerBootstrapAcceptor æ˜¯æœåŠ¡ç«¯ Channel ä¸­ä¸€ä¸ªç‰¹æ®Šçš„å¤„ç†å™¨ï¼Œè€ŒæœåŠ¡ç«¯ Channel çš„ channelRead äº‹ä»¶åªä¼šåœ¨æ–°è¿æ¥æ¥å…¥æ—¶è§¦å‘ï¼Œæ‰€ä»¥è¿™é‡Œæ‹¿åˆ°çš„æ•°æ®éƒ½æ˜¯å®¢æˆ·ç«¯æ–°è¿æ¥ã€‚</p>
<p>ServerBootstrapAcceptor é€šè¿‡ childGroup.register() æ–¹æ³•ä¼šå®Œæˆç¬¬ä¸‰å’Œç¬¬å››ä¸¤ä¸ªæ­¥éª¤ï¼Œå°† NioSocketChannel æ³¨å†Œåˆ° Worker å·¥ä½œçº¿ç¨‹ä¸­ï¼Œå¹¶æ³¨å†Œ OP_READ äº‹ä»¶åˆ° NioSocketChannel çš„äº‹ä»¶é›†åˆã€‚åœ¨æ³¨å†Œè¿‡ç¨‹ä¸­æ¯”è¾ƒæœ‰æ„æ€çš„ä¸€ç‚¹æ˜¯ï¼Œå®ƒä¼šè°ƒç”¨ pipeline.fireChannelRegistered() æ–¹æ³•ä¼ æ’­ channelRegistered äº‹ä»¶ï¼Œç„¶åå†è°ƒç”¨ pipeline.fireChannelActive() æ–¹æ³•ä¼ æ’­ channelActive äº‹ä»¶ã€‚å…œäº†ä¸€åœˆï¼Œè¿™åˆä¼šå›åˆ°ä¹‹å‰æˆ‘ä»¬ä»‹ç»çš„ readIfIsAutoRead() æ–¹æ³•ï¼Œæ­¤æ—¶å®ƒä¼šå°† SelectionKey.OP_READ äº‹ä»¶æ³¨å†Œåˆ° Channel çš„äº‹ä»¶é›†åˆã€‚</p>
<p>å…³äºæœåŠ¡ç«¯å¦‚ä½•å¤„ç†å®¢æˆ·ç«¯æ–°å»ºè¿æ¥çš„å…·ä½“æºç ï¼Œæˆ‘åœ¨æ­¤å°±ä¸ç»§ç»­å±•å¼€äº†ã€‚è¿™é‡Œç•™ä¸€ä¸ªå°ä»»åŠ¡ï¼Œå»ºè®®ä½ äº²è‡ªåŠ¨æ‰‹åˆ†æä¸‹ childGroup.register() çš„ç›¸å…³æºç ï¼Œä»è€ŒåŠ æ·±å¯¹æœåŠ¡ç«¯å¯åŠ¨ä»¥åŠæ–°è¿æ¥å¤„ç†æµç¨‹çš„ç†è§£ã€‚æœ‰äº†æœåŠ¡ç«¯å¯åŠ¨æºç åˆ†æçš„åŸºç¡€ï¼Œå†å»ç†è§£å®¢æˆ·ç«¯æ–°å»ºè¿æ¥çš„è¿‡ç¨‹ä¼šç›¸å¯¹å®¹æ˜“å¾ˆå¤šã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>æœ¬èŠ‚è¯¾æˆ‘ä»¬æ·±å…¥åˆ†æäº† Netty æœåŠ¡ç«¯å¯åŠ¨çš„å…¨æµç¨‹ï¼Œå¯¹å…¶ä¸­æ¶‰åŠçš„æ ¸å¿ƒç»„ä»¶æœ‰äº†åŸºæœ¬çš„è®¤è¯†ã€‚Netty æœåŠ¡ç«¯å¯åŠ¨çš„ç›¸å…³æºç å±‚æ¬¡æ¯”è¾ƒæ·±ï¼Œæ¨èå¤§å®¶åœ¨è¯»æºç çš„æ—¶å€™ï¼Œå¯ä»¥å…ˆæŠŠä¸»ä½“æµç¨‹æ¢³ç†æ¸…æ¥šï¼Œå¼€å§‹æ—¶å…ˆä¸ç”¨çº ç»“å…·ä½“çš„æ–¹æ³•æ˜¯ç”¨æ¥åšä»€ä¹ˆï¼Œè‡ªé¡¶è€Œä¸‹å…ˆç”»å‡ºå®Œæ•´çš„è°ƒç”¨é“¾è·¯å›¾ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼Œç„¶åå†é€ä¸€å‡»ç ´ã€‚ <img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/CgqCHl_WABCAJA9VAAIG0Ncq3hs061.png" alt="å›¾ç‰‡7.png"></p>
<p>ä¸‹èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°†å­¦ä¹  Netty æœ€æ ¸å¿ƒçš„ Reactor çº¿ç¨‹æ¨¡å‹çš„æºç ï¼Œæ¨èä½ æŠŠä¸¤èŠ‚è¯¾æ”¾åœ¨ä¸€èµ·å†è¿›è¡Œå¤ä¹ ï¼Œå¯ä»¥è§£ç­”ä½ ç›®å‰ä¸å°‘çš„ç–‘é—®ï¼Œå¦‚å¼‚æ­¥ task æ˜¯å¦‚ä½•å°è£…å¹¶æ‰§è¡Œçš„ï¼Ÿäº‹ä»¶æ³¨å†Œä¹‹åæ˜¯å¦‚ä½•è¢«å¤„ç†çš„ï¼Ÿ</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/16-io-%E5%8A%A0%E9%80%9F%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%E7%9A%84-netty-%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF/"><span>16 IO åŠ é€Ÿï¼šä¸ä¼—ä¸åŒçš„ Netty é›¶æ‹·è´æŠ€æœ¯</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/18-%E6%BA%90%E7%A0%81%E7%AF%87%E8%A7%A3%E5%AF%86-netty-reactor-%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/"><span>18 æºç ç¯‡ï¼šè§£å¯† Netty Reactor çº¿ç¨‹æ¨¡å‹</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 28280 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>