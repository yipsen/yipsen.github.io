<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>09 æ•°æ®ä¼ è¾“ï¼šwriteAndFlush å¤„ç†æµç¨‹å‰–æ | Yipsen Ye</title>
<meta name="description" content="åœ¨å‰é¢å‡ èŠ‚è¯¾æˆ‘ä»¬ä»‹ç»äº† Netty ç¼–è§£ç çš„åŸºç¡€çŸ¥è¯†ï¼Œæƒ³å¿…ä½ å·²ç»æŒæ¡äº† Netty å®ç°ç¼–è§£ç é€»è¾‘çš„æŠ€å·§ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å¦‚ä½•å°†ç¼–è§£ç åçš„ç»“æœå‘é€å‡ºå»å‘¢ï¼Ÿåœ¨ Netty ä¸­å®ç°æ•°æ®å‘é€éå¸¸ç®€å•ï¼Œåªéœ€è¦è°ƒç”¨ writeAndFlush æ–¹æ³•å³å¯ï¼Œè¿™ä¹ˆç®€å•çš„ä¸€è¡Œä»£ç ç©¶ç«Ÿ Netty å¸®æˆ‘ä»¬å®Œæˆäº†å“ªäº›äº‹æƒ…å‘¢ï¼Ÿä¸€èµ·è¿›å…¥æˆ‘ä»¬ä»Šå¤©è¿™èŠ‚è¯¾è¦æ¢è®¨çš„ä¸»é¢˜å§ï¼
Pipeline äº‹ä»¶ä¼ æ’­å›é¡¾ åœ¨ä»‹ç» writeAndFlush çš„å·¥ä½œåŸç†ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆå›é¡¾ä¸‹ Pipeline çš„äº‹ä»¶ä¼ æ’­æœºåˆ¶ï¼Œå› ä¸ºä»–ä»¬æ˜¯æ¯æ¯ç›¸å…³çš„ã€‚æ ¹æ®ç½‘ç»œæ•°æ®çš„æµå‘ï¼ŒChannelPipeline åˆ†ä¸ºå…¥ç«™ ChannelInboundHandler å’Œå‡ºç«™ ChannelOutboundHandler ä¸¤ç§å¤„ç†å™¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚
å½“æˆ‘ä»¬ä»å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚ï¼Œæˆ–è€…æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å“åº”è¯·æ±‚ç»“æœéƒ½å±äºå‡ºç«™å¤„ç†å™¨ ChannelOutboundHandler çš„è¡Œä¸ºï¼Œæ‰€ä»¥å½“æˆ‘ä»¬è°ƒç”¨ writeAndFlush æ—¶ï¼Œæ•°æ®ä¸€å®šä¼šåœ¨ Pipeline ä¸­è¿›è¡Œä¼ æ’­ã€‚
åœ¨è¿™é‡Œæˆ‘é¦–å…ˆæŠ›å‡ºå‡ ä¸ªé—®é¢˜ï¼Œå­¦å®Œæœ¬èŠ‚è¯¾åå¯ä»¥ç”¨äºæ£€éªŒä¸‹è‡ªå·±æ˜¯å¦çœŸçš„ç†è§£äº† writeAndFlush çš„åŸç†ã€‚
 writeAndFlush æ˜¯å¦‚ä½•è§¦å‘äº‹ä»¶ä¼ æ’­çš„ï¼Ÿæ•°æ®æ˜¯æ€æ ·å†™åˆ° Socket åº•å±‚çš„ï¼Ÿ ä¸ºä»€ä¹ˆä¼šæœ‰ write å’Œ flush ä¸¤ä¸ªåŠ¨ä½œï¼Ÿæ‰§è¡Œ flush ä¹‹å‰æ•°æ®æ˜¯å¦‚ä½•å­˜å‚¨çš„ï¼Ÿ writeAndFlush æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Ÿå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿ  writeAndFlush äº‹ä»¶ä¼ æ’­åˆ†æ ä¸ºäº†ä¾¿äºæˆ‘ä»¬åˆ†æ writeAndFlush çš„äº‹ä»¶ä¼ æ’­æµç¨‹ï¼Œé¦–å…ˆæˆ‘ä»¬é€šè¿‡ä»£ç æ¨¡æ‹Ÿä¸€ä¸ªæœ€ç®€å•çš„æ•°æ®å‡ºç«™åœºæ™¯ï¼ŒæœåŠ¡ç«¯åœ¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚åï¼Œå°†å“åº”ç»“æœç¼–ç åå†™å›å®¢æˆ·ç«¯ã€‚
ä»¥ä¸‹æ˜¯æœåŠ¡ç«¯çš„å¯åŠ¨ç±»ï¼Œåˆ†åˆ«æ³¨å†Œäº†ä¸‰ä¸ª ChannelHandlerï¼šå›ºå®šé•¿åº¦è§£ç å™¨ FixedLengthFrameDecoderã€å“åº”ç»“æœç¼–ç å™¨ ResponseSampleEncoderã€ä¸šåŠ¡é€»è¾‘å¤„ç†å™¨ RequestSampleHandlerã€‚
public class EchoServer {public void startEchoServer(int port) throws Exception {EventLoopGroup bossGroup = new NioEventLoopGroup();EventLoopGroup workerGroup = new NioEventLoopGroup();try {ServerBootstrap b = new ServerBootstrap();b.">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="nav-logo">
    <a href="http://yipsen.github.io/">
        
        <span class="nav-title">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æ–‡ç« </a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/netty%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e5%89%96%e6%9e%90%e4%b8%8erpc%e5%ae%9e%e8%b7%b5/">Nettyæ ¸å¿ƒåŸç†å‰–æä¸RPCå®è·µ</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/00-%E5%AD%A6%E5%A5%BD-netty%E6%98%AF%E4%BD%A0%E4%BF%AE%E7%82%BC-java-%E5%86%85%E5%8A%9F%E7%9A%84%E5%BF%85%E7%BB%8F%E4%B9%8B%E8%B7%AF/">00 å­¦å¥½ Nettyï¼Œæ˜¯ä½ ä¿®ç‚¼ Java å†…åŠŸçš„å¿…ç»ä¹‹è·¯</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/01-%E5%88%9D%E8%AF%86-netty%E4%B8%BA%E4%BB%80%E4%B9%88-netty-%E8%BF%99%E4%B9%88%E6%B5%81%E8%A1%8C/">01 åˆè¯† Nettyï¼šä¸ºä»€ä¹ˆ Netty è¿™ä¹ˆæµè¡Œï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/02-%E7%BA%B5%E8%A7%88%E5%85%A8%E5%B1%80%E6%8A%8A%E6%8F%A1-netty-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E8%84%89%E7%BB%9C/">02 çºµè§ˆå…¨å±€ï¼šæŠŠæ¡ Netty æ•´ä½“æ¶æ„è„‰ç»œ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/03-%E5%BC%95%E5%AF%BC%E5%99%A8%E4%BD%9C%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E9%83%BD%E8%A6%81%E5%81%9A%E4%BA%9B%E4%BB%80%E4%B9%88/">03 å¼•å¯¼å™¨ä½œç”¨ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¯åŠ¨éƒ½è¦åšäº›ä»€ä¹ˆï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/04-%E4%BA%8B%E4%BB%B6%E8%B0%83%E5%BA%A6%E5%B1%82%E4%B8%BA%E4%BB%80%E4%B9%88-eventloop-%E6%98%AF-netty-%E7%9A%84%E7%B2%BE%E9%AB%93/">04 äº‹ä»¶è°ƒåº¦å±‚ï¼šä¸ºä»€ä¹ˆ EventLoop æ˜¯ Netty çš„ç²¾é«“ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/05-%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92%E5%B1%82pipeline-%E5%A6%82%E4%BD%95%E5%8D%8F%E8%B0%83%E5%90%84%E7%B1%BB-handler-/">05 æœåŠ¡ç¼–æ’å±‚ï¼šPipeline å¦‚ä½•åè°ƒå„ç±» Handler ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/06-%E7%B2%98%E5%8C%85%E6%8B%86%E5%8C%85%E9%97%AE%E9%A2%98%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%95%B4%E7%9A%84%E7%BD%91%E7%BB%9C%E5%8C%85/">06 ç²˜åŒ…æ‹†åŒ…é—®é¢˜ï¼šå¦‚ä½•è·å–ä¸€ä¸ªå®Œæ•´çš„ç½‘ç»œåŒ…ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/07-%E6%8E%A5%E5%A4%B4%E6%9A%97%E8%AF%AD%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8-netty-%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E9%80%9A%E4%BF%A1/">07 æ¥å¤´æš—è¯­ï¼šå¦‚ä½•åˆ©ç”¨ Netty å®ç°è‡ªå®šä¹‰åè®®é€šä¿¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/08-%E5%BC%80%E7%AE%B1%E5%8D%B3%E7%94%A8netty-%E6%94%AF%E6%8C%81%E5%93%AA%E4%BA%9B%E5%B8%B8%E7%94%A8%E7%9A%84%E8%A7%A3%E7%A0%81%E5%99%A8/">08 å¼€ç®±å³ç”¨ï¼šNetty æ”¯æŒå“ªäº›å¸¸ç”¨çš„è§£ç å™¨ï¼Ÿ</a></li>
                
                
                
                    <li>09 æ•°æ®ä¼ è¾“ï¼šwriteAndFlush å¤„ç†æµç¨‹å‰–æ</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/10-%E5%8F%8C%E5%88%83%E5%89%91%E5%90%88%E7%90%86%E7%AE%A1%E7%90%86-netty-%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98/">10 åŒåˆƒå‰‘ï¼šåˆç†ç®¡ç† Netty å †å¤–å†…å­˜</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/11-%E5%8F%A6%E8%B5%B7%E7%82%89%E7%81%B6netty-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E8%BD%BD%E4%BD%93-bytebuf-%E8%AF%A6%E8%A7%A3/">11 å¦èµ·ç‚‰ç¶ï¼šNetty æ•°æ®ä¼ è¾“è½½ä½“ ByteBuf è¯¦è§£</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/12-%E4%BB%96%E5%B1%B1%E4%B9%8B%E7%9F%B3%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%99%A8-jemalloc-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/">12 ä»–å±±ä¹‹çŸ³ï¼šé«˜æ€§èƒ½å†…å­˜åˆ†é…å™¨ jemalloc åŸºæœ¬åŸç†</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/13-%E4%B8%BE%E4%B8%80%E5%8F%8D%E4%B8%89netty-%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E8%AE%BE%E8%AE%A1%E4%B8%8A/">13 ä¸¾ä¸€åä¸‰ï¼šNetty é«˜æ€§èƒ½å†…å­˜ç®¡ç†è®¾è®¡ï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/14-%E4%B8%BE%E4%B8%80%E5%8F%8D%E4%B8%89netty-%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E8%AE%BE%E8%AE%A1%E4%B8%8B/">14 ä¸¾ä¸€åä¸‰ï¼šNetty é«˜æ€§èƒ½å†…å­˜ç®¡ç†è®¾è®¡ï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/15-%E8%BD%BB%E9%87%8F%E7%BA%A7%E5%AF%B9%E8%B1%A1%E5%9B%9E%E6%94%B6%E7%AB%99recycler-%E5%AF%B9%E8%B1%A1%E6%B1%A0%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90/">15 è½»é‡çº§å¯¹è±¡å›æ”¶ç«™ï¼šRecycler å¯¹è±¡æ± æŠ€æœ¯è§£æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/16-io-%E5%8A%A0%E9%80%9F%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%E7%9A%84-netty-%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF/">16 IO åŠ é€Ÿï¼šä¸ä¼—ä¸åŒçš„ Netty é›¶æ‹·è´æŠ€æœ¯</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/17-%E6%BA%90%E7%A0%81%E7%AF%87%E4%BB%8E-linux-%E5%87%BA%E5%8F%91%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">17 æºç ç¯‡ï¼šä» Linux å‡ºå‘æ·±å…¥å‰–ææœåŠ¡ç«¯å¯åŠ¨æµç¨‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/18-%E6%BA%90%E7%A0%81%E7%AF%87%E8%A7%A3%E5%AF%86-netty-reactor-%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/">18 æºç ç¯‡ï¼šè§£å¯† Netty Reactor çº¿ç¨‹æ¨¡å‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/19-%E6%BA%90%E7%A0%81%E7%AF%87%E4%B8%80%E4%B8%AA%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E5%9C%A8-netty-%E4%B8%AD%E7%9A%84%E6%97%85%E7%A8%8B/">19 æºç ç¯‡ï¼šä¸€ä¸ªç½‘ç»œè¯·æ±‚åœ¨ Netty ä¸­çš„æ—…ç¨‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/20-%E6%8A%80%E5%B7%A7%E7%AF%87netty-%E7%9A%84-fastthreadlocal-%E7%A9%B6%E7%AB%9F%E6%AF%94-threadlocal-%E5%BF%AB%E5%9C%A8%E5%93%AA%E5%84%BF/">20 æŠ€å·§ç¯‡ï¼šNetty çš„ FastThreadLocal ç©¶ç«Ÿæ¯” ThreadLocal å¿«åœ¨å“ªå„¿ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/21-%E6%8A%80%E5%B7%A7%E7%AF%87%E5%BB%B6%E8%BF%9F%E4%BB%BB%E5%8A%A1%E5%A4%84%E7%90%86%E7%A5%9E%E5%99%A8%E4%B9%8B%E6%97%B6%E9%97%B4%E8%BD%AE-hashedwheeltimer/">21 æŠ€å·§ç¯‡ï¼šå»¶è¿Ÿä»»åŠ¡å¤„ç†ç¥å™¨ä¹‹æ—¶é—´è½® HashedWheelTimer</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/22-%E6%8A%80%E5%B7%A7%E7%AF%87%E9%AB%98%E6%80%A7%E8%83%BD%E6%97%A0%E9%94%81%E9%98%9F%E5%88%97-mpsc-queue/">22 æŠ€å·§ç¯‡ï¼šé«˜æ€§èƒ½æ— é”é˜Ÿåˆ— Mpsc Queue</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/23-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E9%AB%98%E6%80%A7%E8%83%BD%E5%88%86%E5%B8%83%E5%BC%8F-rpc-%E6%A1%86%E6%9E%B6/">23 æ¶æ„è®¾è®¡ï¼šå¦‚ä½•å®ç°ä¸€ä¸ªé«˜æ€§èƒ½åˆ†å¸ƒå¼ RPC æ¡†æ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/24-%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E4%B8%8E%E8%AE%A2%E9%98%85%E6%90%AD%E5%BB%BA%E7%94%9F%E4%BA%A7%E8%80%85%E5%92%8C%E6%B6%88%E8%B4%B9%E8%80%85%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A1%86%E6%9E%B6/">24 æœåŠ¡å‘å¸ƒä¸è®¢é˜…ï¼šæ­å»ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åŸºç¡€æ¡†æ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/25-%E8%BF%9C%E7%A8%8B%E9%80%9A%E4%BF%A1%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE%E8%AE%BE%E8%AE%A1%E4%BB%A5%E5%8F%8A%E7%BC%96%E8%A7%A3%E7%A0%81%E7%9A%84%E5%AE%9E%E7%8E%B0/">25 è¿œç¨‹é€šä¿¡ï¼šé€šä¿¡åè®®è®¾è®¡ä»¥åŠç¼–è§£ç çš„å®ç°</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/26-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%9C%BA%E5%88%B6%E7%9A%84%E5%AE%9E%E7%8E%B0/">26 æœåŠ¡æ²»ç†ï¼šæœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡æœºåˆ¶çš„å®ç°</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/27-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%BA%E7%94%A8%E6%88%B7%E5%B1%8F%E8%94%BD-rpc-%E8%B0%83%E7%94%A8%E7%9A%84%E5%BA%95%E5%B1%82%E7%BB%86%E8%8A%82/">27 åŠ¨æ€ä»£ç†ï¼šä¸ºç”¨æˆ·å±è”½ RPC è°ƒç”¨çš„åº•å±‚ç»†èŠ‚</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/28-%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93rpc-%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93%E4%B8%8E%E8%BF%9B%E9%98%B6%E5%BB%B6%E4%BC%B8/">28 å®æˆ˜æ€»ç»“ï¼šRPC å®æˆ˜æ€»ç»“ä¸è¿›é˜¶å»¶ä¼¸</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/29-%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3netty-%E4%B8%AD%E5%BA%94%E7%94%A8%E4%BA%86%E5%93%AA%E4%BA%9B%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">29 ç¼–ç¨‹æ€æƒ³ï¼šNetty ä¸­åº”ç”¨äº†å“ªäº›è®¾è®¡æ¨¡å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/30-%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93netty-%E5%9C%A8%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">30 å®è·µæ€»ç»“ï¼šNetty åœ¨é¡¹ç›®å¼€å‘ä¸­çš„ä¸€äº›æœ€ä½³å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/31-%E7%BB%93%E6%9D%9F%E8%AF%AD-%E6%8A%80%E6%9C%AF%E6%88%90%E9%95%BF%E4%B9%8B%E8%B7%AF%E5%A6%82%E4%BD%95%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB/">31 ç»“æŸè¯­ æŠ€æœ¯æˆé•¿ä¹‹è·¯ï¼šå¦‚ä½•æ‰“é€ è‡ªå·±çš„æŠ€æœ¯ä½“ç³»</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">09 æ•°æ®ä¼ è¾“ï¼šwriteAndFlush å¤„ç†æµç¨‹å‰–æ</h1>
        <div class="post-info">
            <div class="post-date"> 
                <span>2021-12-22 01:54:30</span>
            </div>
        </div>
        <div class="post-content">
            <p>åœ¨å‰é¢å‡ èŠ‚è¯¾æˆ‘ä»¬ä»‹ç»äº† Netty ç¼–è§£ç çš„åŸºç¡€çŸ¥è¯†ï¼Œæƒ³å¿…ä½ å·²ç»æŒæ¡äº† Netty å®ç°ç¼–è§£ç é€»è¾‘çš„æŠ€å·§ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å¦‚ä½•å°†ç¼–è§£ç åçš„ç»“æœå‘é€å‡ºå»å‘¢ï¼Ÿåœ¨ Netty ä¸­å®ç°æ•°æ®å‘é€éå¸¸ç®€å•ï¼Œåªéœ€è¦è°ƒç”¨ writeAndFlush æ–¹æ³•å³å¯ï¼Œè¿™ä¹ˆç®€å•çš„ä¸€è¡Œä»£ç ç©¶ç«Ÿ Netty å¸®æˆ‘ä»¬å®Œæˆäº†å“ªäº›äº‹æƒ…å‘¢ï¼Ÿä¸€èµ·è¿›å…¥æˆ‘ä»¬ä»Šå¤©è¿™èŠ‚è¯¾è¦æ¢è®¨çš„ä¸»é¢˜å§ï¼</p>
<h3 id="pipeline-äº‹ä»¶ä¼ æ’­å›é¡¾">Pipeline äº‹ä»¶ä¼ æ’­å›é¡¾</h3>
<p>åœ¨ä»‹ç» writeAndFlush çš„å·¥ä½œåŸç†ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆå›é¡¾ä¸‹ Pipeline çš„äº‹ä»¶ä¼ æ’­æœºåˆ¶ï¼Œå› ä¸ºä»–ä»¬æ˜¯æ¯æ¯ç›¸å…³çš„ã€‚æ ¹æ®ç½‘ç»œæ•°æ®çš„æµå‘ï¼ŒChannelPipeline åˆ†ä¸ºå…¥ç«™ ChannelInboundHandler å’Œå‡ºç«™ ChannelOutboundHandler ä¸¤ç§å¤„ç†å™¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F-uZy-Ae5ElAANEp703VGM268.png" alt="å›¾ç‰‡11.png"></p>
<p>å½“æˆ‘ä»¬ä»å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚ï¼Œæˆ–è€…æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å“åº”è¯·æ±‚ç»“æœéƒ½å±äºå‡ºç«™å¤„ç†å™¨ ChannelOutboundHandler çš„è¡Œä¸ºï¼Œæ‰€ä»¥å½“æˆ‘ä»¬è°ƒç”¨ writeAndFlush æ—¶ï¼Œæ•°æ®ä¸€å®šä¼šåœ¨ Pipeline ä¸­è¿›è¡Œä¼ æ’­ã€‚</p>
<p>åœ¨è¿™é‡Œæˆ‘é¦–å…ˆæŠ›å‡ºå‡ ä¸ªé—®é¢˜ï¼Œå­¦å®Œæœ¬èŠ‚è¯¾åå¯ä»¥ç”¨äºæ£€éªŒä¸‹è‡ªå·±æ˜¯å¦çœŸçš„ç†è§£äº† writeAndFlush çš„åŸç†ã€‚</p>
<ul>
<li>writeAndFlush æ˜¯å¦‚ä½•è§¦å‘äº‹ä»¶ä¼ æ’­çš„ï¼Ÿæ•°æ®æ˜¯æ€æ ·å†™åˆ° Socket åº•å±‚çš„ï¼Ÿ</li>
<li>ä¸ºä»€ä¹ˆä¼šæœ‰ write å’Œ flush ä¸¤ä¸ªåŠ¨ä½œï¼Ÿæ‰§è¡Œ flush ä¹‹å‰æ•°æ®æ˜¯å¦‚ä½•å­˜å‚¨çš„ï¼Ÿ</li>
<li>writeAndFlush æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Ÿå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿ</li>
</ul>
<h3 id="writeandflush-äº‹ä»¶ä¼ æ’­åˆ†æ">writeAndFlush äº‹ä»¶ä¼ æ’­åˆ†æ</h3>
<p>ä¸ºäº†ä¾¿äºæˆ‘ä»¬åˆ†æ writeAndFlush çš„äº‹ä»¶ä¼ æ’­æµç¨‹ï¼Œé¦–å…ˆæˆ‘ä»¬é€šè¿‡ä»£ç æ¨¡æ‹Ÿä¸€ä¸ªæœ€ç®€å•çš„æ•°æ®å‡ºç«™åœºæ™¯ï¼ŒæœåŠ¡ç«¯åœ¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚åï¼Œå°†å“åº”ç»“æœç¼–ç åå†™å›å®¢æˆ·ç«¯ã€‚</p>
<p>ä»¥ä¸‹æ˜¯æœåŠ¡ç«¯çš„å¯åŠ¨ç±»ï¼Œåˆ†åˆ«æ³¨å†Œäº†ä¸‰ä¸ª ChannelHandlerï¼š<strong>å›ºå®šé•¿åº¦è§£ç å™¨ FixedLengthFrameDecoder</strong>ã€<strong>å“åº”ç»“æœç¼–ç å™¨ ResponseSampleEncoder</strong>ã€<strong>ä¸šåŠ¡é€»è¾‘å¤„ç†å™¨ RequestSampleHandler</strong>ã€‚</p>
<pre tabindex="0"><code>public class EchoServer {

    public void startEchoServer(int port) throws Exception {

        EventLoopGroup bossGroup = new NioEventLoopGroup();

        EventLoopGroup workerGroup = new NioEventLoopGroup();

        try {

            ServerBootstrap b = new ServerBootstrap();

            b.group(bossGroup, workerGroup)

                    .channel(NioServerSocketChannel.class)

                    .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {

                        @Override

                        public void initChannel(SocketChannel ch) {

                            ch.pipeline().addLast(new FixedLengthFrameDecoder(10));

                            ch.pipeline().addLast(new ResponseSampleEncoder());

                            ch.pipeline().addLast(new RequestSampleHandler());

                        }

                    });

            ChannelFuture f = b.bind(port).sync();

            f.channel().closeFuture().sync();

        } finally {

            bossGroup.shutdownGracefully();

            workerGroup.shutdownGracefully();

        }

    }

    public static void main(String[] args) throws Exception {

        new EchoServer().startEchoServer(8088);

    }

}
</code></pre><p>å…¶ä¸­å›ºå®šé•¿åº¦è§£ç å™¨ FixedLengthFrameDecoder æ˜¯ Netty è‡ªå¸¦çš„è§£ç å™¨ï¼Œåœ¨è¿™é‡Œå°±ä¸åšèµ˜è¿°äº†ã€‚ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«çœ‹ä¸‹å¦å¤–ä¸¤ä¸ª ChannelHandler çš„å…·ä½“å®ç°ã€‚</p>
<p>å“åº”ç»“æœç¼–ç å™¨ ResponseSampleEncoder ç”¨äºå°†æœåŠ¡ç«¯çš„å¤„ç†ç»“æœè¿›è¡Œç¼–ç ï¼Œå…·ä½“çš„å®ç°é€»è¾‘å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>public class ResponseSampleEncoder extends MessageToByteEncoder&lt;ResponseSample&gt; {

    @Override

    protected void encode(ChannelHandlerContext ctx, ResponseSample msg, ByteBuf out) {

        if (msg != null) {

            out.writeBytes(msg.getCode().getBytes());

            out.writeBytes(msg.getData().getBytes());

            out.writeLong(msg.getTimestamp());

        }

    }

}
</code></pre><p>RequestSampleHandler ä¸»è¦è´Ÿè´£å®¢æˆ·ç«¯çš„æ•°æ®å¤„ç†ï¼Œå¹¶é€šè¿‡è°ƒç”¨ ctx.channel().writeAndFlush å‘å®¢æˆ·ç«¯è¿”å› ResponseSample å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«è¿”å›ç ã€å“åº”æ•°æ®ä»¥åŠæ—¶é—´æˆ³ã€‚</p>
<pre tabindex="0"><code>public class RequestSampleHandler extends ChannelInboundHandlerAdapter {

    @Override

    public void channelRead(ChannelHandlerContext ctx, Object msg) {

        String data = ((ByteBuf) msg).toString(CharsetUtil.UTF_8);

        ResponseSample response = new ResponseSample(&quot;OK&quot;, data, System.currentTimeMillis());

        ctx.channel().writeAndFlush(response);

    }

}
</code></pre><p>é€šè¿‡ä»¥ä¸Šçš„ä»£ç ç¤ºä¾‹æˆ‘ä»¬å¯ä»¥æç»˜å‡º Pipeline çš„é“¾è¡¨ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/CgqCHl-uZz2AD58hAAHvDJLyzyU332.png" alt="å›¾ç‰‡12.png"></p>
<p>é‚£ä¹ˆå½“ RequestSampleHandler è°ƒç”¨ writeAndFlush æ—¶ï¼Œæ•°æ®æ˜¯å¦‚ä½•åœ¨ Pipeline ä¸­ä¼ æ’­ã€å¤„ç†å¹¶å‘å®¢æˆ·ç«¯å‘é€çš„å‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬ç»“åˆè¯¥åœºæ™¯å¯¹ writeAndFlush çš„å¤„ç†æµç¨‹åšæ·±å…¥çš„åˆ†æã€‚</p>
<p>æ—¢ç„¶ writeAndFlush æ˜¯ç‰¹æœ‰çš„å‡ºç«™æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬çŒœæµ‹å®ƒæ˜¯ä» Pipeline çš„ Tail èŠ‚ç‚¹å¼€å§‹ä¼ æ’­çš„ï¼Œç„¶åä¸€ç›´å‘å‰ä¼ æ’­åˆ° Head èŠ‚ç‚¹ã€‚æˆ‘ä»¬è·Ÿè¿›å» ctx.channel().writeAndFlush çš„æºç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œå‘ç° DefaultChannelPipeline ç±»ä¸­æœç„¶æ˜¯è°ƒç”¨çš„ Tail èŠ‚ç‚¹ writeAndFlush æ–¹æ³•ã€‚</p>
<pre tabindex="0"><code>@Override

public final ChannelFuture writeAndFlush(Object msg) {

    return tail.writeAndFlush(msg);

}
</code></pre><p>ç»§ç»­è·Ÿè¿› tail.writeAndFlush çš„æºç ï¼Œæœ€ç»ˆä¼šå®šä½åˆ° AbstractChannelHandlerContext ä¸­çš„ write æ–¹æ³•ã€‚è¯¥æ–¹æ³•æ˜¯ writeAndFlush çš„<strong>æ ¸å¿ƒé€»è¾‘</strong>ï¼Œå…·ä½“è§ä»¥ä¸‹æºç ã€‚</p>
<pre tabindex="0"><code>private void write(Object msg, boolean flush, ChannelPromise promise) {

    // ...... çœç•¥éƒ¨åˆ†éæ ¸å¿ƒä»£ç  ......
    // æ‰¾åˆ° Pipeline é“¾è¡¨ä¸­ä¸‹ä¸€ä¸ª Outbound ç±»å‹çš„ ChannelHandler èŠ‚ç‚¹

    final AbstractChannelHandlerContext next = findContextOutbound(flush ?

            (MASK_WRITE | MASK_FLUSH) : MASK_WRITE);

    final Object m = pipeline.touch(msg, next);

    EventExecutor executor = next.executor();

    // åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ NioEventLoop ä¸­çš„çº¿ç¨‹

    if (executor.inEventLoop()) {

        if (flush) {

            // å› ä¸º flush == trueï¼Œæ‰€ä»¥æµç¨‹èµ°åˆ°è¿™é‡Œ

            next.invokeWriteAndFlush(m, promise);

        } else {

            next.invokeWrite(m, promise);

        }

    } else {

        final AbstractWriteTask task;

        if (flush) {

            task = WriteAndFlushTask.newInstance(next, m, promise);

        }  else {

            task = WriteTask.newInstance(next, m, promise);

        }

        if (!safeExecute(executor, task, promise, m)) {

            task.cancel();

        }

    }

}
</code></pre><p>é¦–å…ˆæˆ‘ä»¬ç¡®è®¤ä¸‹æ–¹æ³•çš„å…¥å‚ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦æ‰§è¡Œ flush åŠ¨ä½œï¼Œæ‰€ä»¥ flush == trueï¼›write æ–¹æ³•è¿˜éœ€è¦ ChannelPromise å‚æ•°ï¼Œå¯è§å†™æ“ä½œæ˜¯ä¸ªå¼‚æ­¥çš„è¿‡ç¨‹ã€‚AbstractChannelHandlerContext ä¼šé»˜è®¤åˆå§‹åŒ–ä¸€ä¸ª ChannelPromise å®Œæˆè¯¥å¼‚æ­¥æ“ä½œï¼ŒChannelPromise å†…éƒ¨æŒæœ‰å½“å‰çš„ Channel å’Œ EventLoopï¼Œæ­¤å¤–ä½ å¯ä»¥å‘ ChannelPromise ä¸­æ³¨å†Œå›è°ƒç›‘å¬ listener æ¥è·å¾—å¼‚æ­¥æ“ä½œçš„ç»“æœã€‚</p>
<p>write æ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªé‡è¦æ­¥éª¤ï¼Œæˆ‘å·²ç»ä»¥æ³¨é‡Šçš„å½¢å¼åœ¨æºç ä¸­æ ‡æ³¨å‡ºæ¥ã€‚ä¸‹é¢æˆ‘ä»¬å°†ç»“åˆä¸Šæ–‡ä¸­çš„ EchoServer ä»£ç ç¤ºä¾‹è¯¦ç»†åˆ†æ write æ–¹æ³•çš„æ‰§è¡Œæœºåˆ¶ã€‚</p>
<p>ç¬¬ä¸€æ­¥ï¼Œè°ƒç”¨ findContextOutbound æ–¹æ³•æ‰¾åˆ° Pipeline é“¾è¡¨ä¸­ä¸‹ä¸€ä¸ª Outbound ç±»å‹çš„ ChannelHandlerã€‚åœ¨æˆ‘ä»¬æ¨¡æ‹Ÿçš„åœºæ™¯ä¸­ä¸‹ä¸€ä¸ª Outbound èŠ‚ç‚¹æ˜¯ ResponseSampleEncoderã€‚</p>
<p>ç¬¬äºŒæ­¥ï¼Œé€šè¿‡ inEventLoop æ–¹æ³•åˆ¤æ–­å½“å‰çº¿ç¨‹çš„èº«ä»½æ ‡è¯†ï¼Œå¦‚æœå½“å‰çº¿ç¨‹å’Œ EventLoop åˆ†é…ç»™å½“å‰ Channel çš„çº¿ç¨‹æ˜¯åŒä¸€ä¸ªçº¿ç¨‹çš„è¯ï¼Œé‚£ä¹ˆæ‰€æäº¤çš„ä»»åŠ¡å°†è¢«ç«‹å³æ‰§è¡Œã€‚å¦åˆ™å½“å‰çš„æ“ä½œå°†è¢«å°è£…æˆä¸€ä¸ª Task æ”¾å…¥åˆ° EventLoop çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œç¨åæ‰§è¡Œã€‚æ‰€ä»¥ writeAndFlush æ˜¯å¦æ˜¯çº¿ç¨‹å®‰å…¨çš„å‘¢ï¼Œä½ å¿ƒé‡Œæœ‰ç­”æ¡ˆäº†å—ï¼Ÿ</p>
<p>ç¬¬ä¸‰æ­¥ï¼Œå› ä¸º flush== trueï¼Œå°†ä¼šç›´æ¥æ‰§è¡Œ next.invokeWriteAndFlush(m, promise) è¿™è¡Œä»£ç ï¼Œæˆ‘ä»¬è·Ÿè¿›å»æºç ã€‚å‘ç°æœ€ç»ˆä¼šå®ƒä¼šæ‰§è¡Œä¸‹ä¸€ä¸ª ChannelHandler èŠ‚ç‚¹çš„ write æ–¹æ³•ï¼Œé‚£ä¹ˆæµç¨‹åˆå›åˆ°äº† åˆ° AbstractChannelHandlerContext ä¸­é‡å¤æ‰§è¡Œ write æ–¹æ³•ï¼Œç»§ç»­å¯»æ‰¾ä¸‹ä¸€ä¸ª Outbound èŠ‚ç‚¹ã€‚</p>
<pre tabindex="0"><code>private void invokeWriteAndFlush(Object msg, ChannelPromise promise) {

    if (invokeHandler()) {

        invokeWrite0(msg, promise);

        invokeFlush0();

    } else {

        writeAndFlush(msg, promise);

    }

}

private void invokeWrite0(Object msg, ChannelPromise promise) {

    try {

        ((ChannelOutboundHandler) handler()).write(this, msg, promise);

    } catch (Throwable t) {

        notifyOutboundHandlerException(t, promise);

    }

}
</code></pre><p>ä¸ºä»€ä¹ˆ ResponseSampleEncoder ä¸­é‡å†™çš„æ˜¯ encode æ–¹æ³•ï¼Œè€Œä¸æ˜¯ write æ–¹æ³•ï¼Ÿencode æ–¹æ³•åˆæ˜¯ä»€ä¹ˆæ—¶æœºè¢«æ‰§è¡Œçš„å‘¢ï¼Ÿè¿™å°±å›åˆ°äº†ã€ŠNetty å¦‚ä½•å®ç°è‡ªå®šä¹‰é€šä¿¡åè®®ã€‹è¯¾ç¨‹ä¸­æ‰€ä»‹ç»çš„ MessageToByteEncoder æºç ã€‚å› ä¸ºæˆ‘ä»¬åœ¨å®ç°ç¼–ç å™¨çš„æ—¶å€™éƒ½ä¼šç»§æ‰¿ MessageToByteEncoder æŠ½è±¡ç±»ï¼ŒMessageToByteEncoder é‡å†™äº† ChanneOutboundHandler çš„ write æ–¹æ³•ï¼Œå…¶ä¸­ä¼šè°ƒç”¨å­ç±»å®ç°çš„ encode æ–¹æ³•å®Œæˆæ•°æ®ç¼–ç ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä¸å†èµ˜è¿°ã€‚</p>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒwriteAndFlush çš„äº‹ä»¶ä¼ æ’­æµç¨‹å·²ç»åˆ†æå®Œæ¯•ï¼Œå¯ä»¥çœ‹å‡º Netty çš„ Pipeline è®¾è®¡éå¸¸ç²¾å¦™ï¼Œè°ƒç”¨ writeAndFlush æ—¶æ•°æ®æ˜¯åœ¨ Outbound ç±»å‹çš„ ChannelHandler èŠ‚ç‚¹ä¹‹é—´è¿›è¡Œä¼ æ’­ï¼Œé‚£ä¹ˆæœ€ç»ˆæ•°æ®æ˜¯å¦‚ä½•å†™åˆ° Socket åº•å±‚çš„å‘¢ï¼Ÿæˆ‘ä»¬ä¸€èµ·ç»§ç»­å‘ä¸‹åˆ†æå§ã€‚</p>
<h3 id="å†™-buffer-é˜Ÿåˆ—">å†™ Buffer é˜Ÿåˆ—</h3>
<p>é€šè¿‡ä¸Šè¿°åœºæ™¯ç¤ºä¾‹åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“æ•°æ®å°†ä¼šåœ¨ Pipeline ä¸­ä¸€ç›´å¯»æ‰¾ Outbound èŠ‚ç‚¹å¹¶å‘å‰ä¼ æ’­ï¼Œç›´åˆ° Head èŠ‚ç‚¹ç»“æŸï¼Œç”± Head èŠ‚ç‚¹å®Œæˆæœ€åçš„æ•°æ®å‘é€ã€‚æ‰€ä»¥ Pipeline ä¸­çš„ Head èŠ‚ç‚¹åœ¨å®Œæˆ writeAndFlush è¿‡ç¨‹ä¸­æ‰®æ¼”ç€é‡è¦çš„è§’è‰²ã€‚æˆ‘ä»¬ç›´æ¥çœ‹ä¸‹ Head èŠ‚ç‚¹çš„ write æ–¹æ³•æºç ï¼š</p>
<pre tabindex="0"><code>// HeadContext # write

@Override

public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) {

    unsafe.write(msg, promise);

}

// AbstractChannel # AbstractUnsafe # write

@Override

public final void write(Object msg, ChannelPromise promise) {

    assertEventLoop();

    ChannelOutboundBuffer outboundBuffer = this.outboundBuffer;

    if (outboundBuffer == null) {

        safeSetFailure(promise, newClosedChannelException(initialCloseCause));

        ReferenceCountUtil.release(msg);

        return;

    }

    int size;

    try {

        msg = filterOutboundMessage(msg); // è¿‡æ»¤æ¶ˆæ¯

        size = pipeline.estimatorHandle().size(msg);

        if (size &lt; 0) {

            size = 0;

        }

    } catch (Throwable t) {

        safeSetFailure(promise, t);

        ReferenceCountUtil.release(msg);

        return;

    }

    outboundBuffer.addMessage(msg, size, promise); // å‘ Buffer ä¸­æ·»åŠ æ•°æ®

}
</code></pre><p>å¯ä»¥çœ‹å‡º Head èŠ‚ç‚¹æ˜¯é€šè¿‡è°ƒç”¨ unsafe å¯¹è±¡å®Œæˆæ•°æ®å†™å…¥çš„ï¼Œunsafe å¯¹åº”çš„æ˜¯ NioSocketChannelUnsafe å¯¹è±¡å®ä¾‹ï¼Œæœ€ç»ˆè°ƒç”¨åˆ° AbstractChannel ä¸­çš„ write æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æœ‰ä¸¤ä¸ªé‡è¦çš„ç‚¹éœ€è¦æŒ‡å‡ºï¼š</p>
<ol>
<li>filterOutboundMessage æ–¹æ³•ä¼šå¯¹å¾…å†™å…¥çš„ msg è¿›è¡Œè¿‡æ»¤ï¼Œå¦‚æœ msg ä½¿ç”¨çš„ä¸æ˜¯ DirectByteBufï¼Œé‚£ä¹ˆå®ƒä¼šå°† msg è½¬æ¢æˆ DirectByteBufã€‚</li>
<li>ChannelOutboundBuffer å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªç¼“å­˜ç»“æ„ï¼Œä»æºç æœ€åä¸€è¡Œ outboundBuffer.addMessage å¯ä»¥çœ‹å‡ºæ˜¯åœ¨å‘è¿™ä¸ªç¼“å­˜ä¸­æ·»åŠ æ•°æ®ï¼Œæ‰€ä»¥ ChannelOutboundBuffer æ‰æ˜¯ç†è§£æ•°æ®å‘é€çš„å…³é”®ã€‚</li>
</ol>
<p>writeAndFlush ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼Œwrite å’Œ flushã€‚é€šè¿‡ä¸Šé¢çš„åˆ†æå¯ä»¥çœ‹å‡ºåªè°ƒç”¨ write æ–¹æ³•ï¼Œæ•°æ®å¹¶ä¸ä¼šè¢«çœŸæ­£å‘é€å‡ºå»ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨ ChannelOutboundBuffer çš„ç¼“å­˜å†…ã€‚ä¸‹é¢æˆ‘ä»¬é‡ç‚¹åˆ†æä¸€ä¸‹ ChannelOutboundBuffer çš„å†…éƒ¨æ„é€ ï¼Œè·Ÿè¿›ä¸€ä¸‹ addMessage çš„æºç ï¼š</p>
<pre tabindex="0"><code>public void addMessage(Object msg, int size, ChannelPromise promise) {

    Entry entry = Entry.newInstance(msg, size, total(msg), promise);

    if (tailEntry == null) {

        flushedEntry = null;

    } else {

        Entry tail = tailEntry;

        tail.next = entry;

    }

    tailEntry = entry;

    if (unflushedEntry == null) {

        unflushedEntry = entry;

    }

    incrementPendingOutboundBytes(entry.pendingSize, false);

}
</code></pre><p>ChannelOutboundBuffer ç¼“å­˜æ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„ï¼Œæ¯æ¬¡ä¼ å…¥çš„æ•°æ®éƒ½ä¼šè¢«å°è£…æˆä¸€ä¸ª Entry å¯¹è±¡æ·»åŠ åˆ°é“¾è¡¨ä¸­ã€‚ChannelOutboundBuffer åŒ…å«<strong>ä¸‰ä¸ªéå¸¸é‡è¦çš„æŒ‡é’ˆ</strong>ï¼šç¬¬ä¸€ä¸ªè¢«å†™åˆ°ç¼“å†²åŒºçš„<strong>èŠ‚ç‚¹ flushedEntry</strong>ã€ç¬¬ä¸€ä¸ªæœªè¢«å†™åˆ°ç¼“å†²åŒºçš„<strong>èŠ‚ç‚¹ unflushedEntry</strong>å’Œæœ€åä¸€ä¸ª<strong>èŠ‚ç‚¹ tailEntryã€‚</strong></p>
<p>åœ¨åˆå§‹çŠ¶æ€ä¸‹è¿™ä¸‰ä¸ªæŒ‡é’ˆéƒ½æŒ‡å‘ NULLï¼Œå½“æˆ‘ä»¬æ¯æ¬¡è°ƒç”¨ write æ–¹æ³•æ˜¯ï¼Œéƒ½ä¼šè°ƒç”¨ addMessage æ–¹æ³•æ”¹å˜è¿™ä¸‰ä¸ªæŒ‡é’ˆçš„æŒ‡å‘ï¼Œå¯ä»¥å‚è€ƒä¸‹å›¾ç†è§£æŒ‡é’ˆçš„ç§»åŠ¨è¿‡ç¨‹ä¼šæ›´åŠ å½¢è±¡ã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/CgqCHl-uZ1GADbu0AAMyHCydEjU371.png" alt="å›¾ç‰‡13.png"></p>
<p>ç¬¬ä¸€æ¬¡è°ƒç”¨ writeï¼Œå› ä¸ºé“¾è¡¨é‡Œåªæœ‰ä¸€ä¸ªæ•°æ®ï¼Œæ‰€ä»¥ unflushedEntry å’Œ tailEntry æŒ‡é’ˆéƒ½æŒ‡å‘ç¬¬ä¸€ä¸ªæ·»åŠ çš„æ•°æ® msg1ã€‚flushedEntry æŒ‡é’ˆåœ¨æ²¡æœ‰è§¦å‘ flush åŠ¨ä½œæ—¶ä¼šä¸€ç›´æŒ‡å‘ NULLã€‚</p>
<p>ç¬¬äºŒæ¬¡è°ƒç”¨ writeï¼ŒtailEntry æŒ‡é’ˆä¼šæŒ‡å‘æ–°åŠ å…¥çš„ msg2ï¼ŒunflushedEntry ä¿æŒä¸å˜ã€‚</p>
<p>ç¬¬ N æ¬¡è°ƒç”¨ writeï¼ŒtailEntry æŒ‡é’ˆä¼šä¸æ–­æŒ‡å‘æ–°åŠ å…¥çš„ msgNï¼ŒunflushedEntry ä¾ç„¶ä¿æŒä¸å˜ï¼ŒunflushedEntry å’Œ tailEntry æŒ‡é’ˆä¹‹é—´çš„æ•°æ®éƒ½æ˜¯æœªå†™å…¥ Socket ç¼“å†²åŒºçš„ã€‚</p>
<p>ä»¥ä¸Šä¾¿æ˜¯å†™ Buffer é˜Ÿåˆ—å†™å…¥æ•°æ®çš„å®ç°åŸç†ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸å¯èƒ½ä¸€ç›´å‘ç¼“å­˜ä¸­å†™å…¥æ•°æ®ï¼Œæ‰€ä»¥ addMessage æ–¹æ³•ä¸­æ¯æ¬¡å†™å…¥æ•°æ®åéƒ½ä¼šè°ƒç”¨ incrementPendingOutboundBytes æ–¹æ³•åˆ¤æ–­ç¼“å­˜çš„æ°´ä½çº¿ï¼Œå…·ä½“æºç å¦‚ä¸‹ã€‚</p>
<pre tabindex="0"><code>private static final int DEFAULT_LOW_WATER_MARK = 32 * 1024;

private static final int DEFAULT_HIGH_WATER_MARK = 64 * 1024;

private void incrementPendingOutboundBytes(long size, boolean invokeLater) {

    if (size == 0) {

        return;

    }
    long newWriteBufferSize = TOTAL_PENDING_SIZE_UPDATER.addAndGet(this, size);

    // åˆ¤æ–­ç¼“å­˜å¤§å°æ˜¯å¦è¶…è¿‡é«˜æ°´ä½çº¿

    if (newWriteBufferSize &gt; channel.config().getWriteBufferHighWaterMark()) {

        setUnwritable(invokeLater);

    }

}
</code></pre><p>incrementPendingOutboundBytes çš„é€»è¾‘éå¸¸ç®€å•ï¼Œæ¯æ¬¡æ·»åŠ æ•°æ®æ—¶éƒ½ä¼šç´¯åŠ æ•°æ®çš„å­—èŠ‚æ•°ï¼Œç„¶ååˆ¤æ–­ç¼“å­˜å¤§å°æ˜¯å¦è¶…è¿‡æ‰€è®¾ç½®çš„é«˜æ°´ä½çº¿ 64KBï¼Œå¦‚æœè¶…è¿‡äº†é«˜æ°´ä½ï¼Œé‚£ä¹ˆ Channel ä¼šè¢«è®¾ç½®ä¸ºä¸å¯å†™çŠ¶æ€ã€‚ç›´åˆ°ç¼“å­˜çš„æ•°æ®å¤§å°ä½äºä½æ°´ä½çº¿ 32KB ä»¥åï¼ŒChannel æ‰æ¢å¤æˆå¯å†™çŠ¶æ€ã€‚</p>
<p>æœ‰å…³å†™æ•°æ®çš„é€»è¾‘å·²ç»åˆ†æå®Œäº†ï¼Œé‚£ä¹ˆæ‰§è¡Œ flush åŠ¨ä½œç¼“å­˜åˆä¼šæ˜¯ä»€ä¹ˆå˜åŒ–å‘¢ï¼Ÿæˆ‘ä»¬æ¥ä¸‹æ¥ä¸€èµ·çœ‹ä¸‹ flush çš„å·¥ä½œåŸç†å§ã€‚</p>
<h3 id="åˆ·æ–°-buffer-é˜Ÿåˆ—">åˆ·æ–° Buffer é˜Ÿåˆ—</h3>
<p>å½“æ‰§è¡Œå®Œ write å†™æ“ä½œä¹‹åï¼ŒinvokeFlush0 ä¼šè§¦å‘ flush åŠ¨ä½œï¼Œä¸ write æ–¹æ³•ç±»ä¼¼ï¼Œflush æ–¹æ³•åŒæ ·ä¼šä» Tail èŠ‚ç‚¹å¼€å§‹ä¼ æ’­åˆ° Head èŠ‚ç‚¹ï¼ŒåŒæ ·æˆ‘ä»¬è·Ÿè¿›ä¸‹ HeadContext çš„ flush æºç ï¼š</p>
<pre tabindex="0"><code>// HeadContext # flush

@Override

public void flush(ChannelHandlerContext ctx) {

    unsafe.flush();

}

// AbstractChannel # flush

@Override

public final void flush() {

    assertEventLoop();

    ChannelOutboundBuffer outboundBuffer = this.outboundBuffer;

    if (outboundBuffer == null) {

        return;

    }

    outboundBuffer.addFlush();

    flush0();

}
</code></pre><p>å¯ä»¥çœ‹å‡º flush çš„æ ¸å¿ƒé€»è¾‘ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼šaddFlush å’Œ flush0ï¼Œä¸‹é¢æˆ‘ä»¬é€ä¸€å¯¹å®ƒä»¬è¿›è¡Œåˆ†æã€‚</p>
<p>é¦–å…ˆçœ‹ä¸‹ addFlush æ–¹æ³•çš„æºç ï¼š</p>
<pre tabindex="0"><code>// ChannelOutboundBuffer # addFlush

public void addFlush() {

    Entry entry = unflushedEntry;

    if (entry != null) {

        if (flushedEntry == null) {

            flushedEntry = entry;

        }

        do {

            flushed ++;

            if (!entry.promise.setUncancellable()) {

                int pending = entry.cancel();

                // å‡å»å¾…å‘é€çš„æ•°æ®ï¼Œå¦‚æœæ€»å­—èŠ‚æ•°ä½äºä½æ°´ä½ï¼Œé‚£ä¹ˆ Channel å°†å˜ä¸ºå¯å†™çŠ¶æ€

                decrementPendingOutboundBytes(pending, false, true);

            }

            entry = entry.next;

        } while (entry != null);

        unflushedEntry = null;

    }

}
</code></pre><p>addFlush æ–¹æ³•åŒæ ·ä¹Ÿä¼šæ“ä½œ ChannelOutboundBuffer ç¼“å­˜æ•°æ®ã€‚åœ¨æ‰§è¡Œ addFlush æ–¹æ³•æ—¶ï¼Œç¼“å­˜ä¸­çš„æŒ‡é’ˆå˜åŒ–åˆæ˜¯å¦‚ä½•å‘¢ï¼Ÿå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬åœ¨å†™å…¥æµç¨‹çš„åŸºç¡€ä¸Šç»§ç»­è¿›è¡Œåˆ†æã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/CgqCHl-uZ2CAFvXuAAJkYjAgb8A346.png" alt="å›¾ç‰‡14.png"></p>
<p>æ­¤æ—¶ flushedEntry æŒ‡é’ˆæœ‰æ‰€æ”¹å˜ï¼Œå˜æ›´ä¸º unflushedEntry æŒ‡é’ˆæ‰€æŒ‡å‘çš„æ•°æ®ï¼Œç„¶å unflushedEntry æŒ‡é’ˆæŒ‡å‘ NULLï¼ŒflushedEntry æŒ‡é’ˆæŒ‡å‘çš„æ•°æ®æ‰ä¼šè¢«çœŸæ­£å‘é€åˆ° Socket ç¼“å†²åŒºã€‚</p>
<p>åœ¨ addFlush æºç ä¸­ decrementPendingOutboundBytes ä¸ä¹‹å‰ addMessage æºç ä¸­çš„ incrementPendingOutboundBytes æ˜¯ç›¸å¯¹åº”çš„ã€‚decrementPendingOutboundBytes ä¸»è¦ä½œç”¨æ˜¯å‡å»å¾…å‘é€çš„æ•°æ®å­—èŠ‚ï¼Œå¦‚æœç¼“å­˜çš„å¤§å°å·²ç»å°äºä½æ°´ä½ï¼Œé‚£ä¹ˆ Channel ä¼šæ¢å¤ä¸ºå¯å†™çŠ¶æ€ã€‚</p>
<p>addFlush çš„å¤§ä½“æµç¨‹æˆ‘ä»¬å·²ç»ä»‹ç»å®Œæ¯•ï¼Œæ¥ä¸‹æ¥ä¾¿æ˜¯ç¬¬äºŒæ­¥è´Ÿè´£å‘é€æ•°æ®çš„ flush0 æ–¹æ³•ã€‚åŒæ ·æˆ‘ä»¬è·Ÿè¿› flush0 çš„æºç ï¼Œå®šä½å‡º flush0 çš„æ ¸å¿ƒè°ƒç”¨é“¾è·¯ï¼š</p>
<pre tabindex="0"><code>// AbstractNioUnsafe # flush0

@Override

protected final void flush0() {

    if (!isFlushPending()) {

        super.flush0();

    }

}

// AbstractNioByteChannel # doWrite

@Override

protected void doWrite(ChannelOutboundBuffer in) throws Exception {

    int writeSpinCount = config().getWriteSpinCount();

    do {

        Object msg = in.current();

        if (msg == null) {

            clearOpWrite();

            return;

        }

        writeSpinCount -= doWriteInternal(in, msg);

    } while (writeSpinCount &gt; 0);

    incompleteWrite(writeSpinCount &lt; 0);

}
</code></pre><p>å®é™… flush0 çš„è°ƒç”¨å±‚æ¬¡å¾ˆæ·±ï¼Œä½†å…¶å®æ ¸å¿ƒçš„é€»è¾‘åœ¨äº AbstractNioByteChannel çš„ doWrite æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è´Ÿè´£å°†æ•°æ®çœŸæ­£å†™å…¥åˆ° Socket ç¼“å†²åŒºã€‚doWrite æ–¹æ³•çš„å¤„ç†æµç¨‹ä¸»è¦åˆ†ä¸ºä¸‰æ­¥ï¼š</p>
<p>ç¬¬ä¸€ï¼Œæ ¹æ®é…ç½®è·å–è‡ªæ—‹é”çš„æ¬¡æ•° writeSpinCountã€‚é‚£ä¹ˆä½ çš„ç–‘é—®å°±æ¥äº†ï¼Œè¿™ä¸ªè‡ªæ—‹é”çš„æ¬¡æ•°ä¸»è¦æ˜¯ç”¨æ¥å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿå½“æˆ‘ä»¬å‘ Socket åº•å±‚å†™æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœæ¯æ¬¡è¦å†™å…¥çš„æ•°æ®é‡å¾ˆå¤§ï¼Œæ˜¯ä¸å¯èƒ½ä¸€æ¬¡å°†æ•°æ®å†™å®Œçš„ï¼Œæ‰€ä»¥åªèƒ½åˆ†æ‰¹å†™å…¥ã€‚Netty åœ¨ä¸æ–­è°ƒç”¨æ‰§è¡Œå†™å…¥é€»è¾‘çš„æ—¶å€™ï¼ŒEventLoop çº¿ç¨‹å¯èƒ½ä¸€ç›´åœ¨ç­‰å¾…ï¼Œè¿™æ ·æœ‰å¯èƒ½ä¼šé˜»å¡å…¶ä»–äº‹ä»¶å¤„ç†ã€‚æ‰€ä»¥è¿™é‡Œè‡ªæ—‹é”çš„æ¬¡æ•°ç›¸å½“äºæ§åˆ¶ä¸€æ¬¡å†™å…¥æ•°æ®çš„æœ€å¤§çš„å¾ªç¯æ‰§è¡Œæ¬¡æ•°ï¼Œå¦‚æœè¶…è¿‡æ‰€è®¾ç½®çš„è‡ªæ—‹é”æ¬¡æ•°ï¼Œé‚£ä¹ˆå†™æ“ä½œå°†ä¼šè¢«æš‚æ—¶ä¸­æ–­ã€‚</p>
<p>ç¬¬äºŒï¼Œæ ¹æ®è‡ªæ—‹é”æ¬¡æ•°é‡å¤è°ƒç”¨ doWriteInternal æ–¹æ³•å‘é€æ•°æ®ï¼Œæ¯æˆåŠŸå‘é€ä¸€æ¬¡æ•°æ®ï¼Œè‡ªæ—‹é”çš„æ¬¡æ•° writeSpinCount å‡ 1ï¼Œå½“ writeSpinCount è€—å°½ï¼Œé‚£ä¹ˆ doWrite æ“ä½œå°†ä¼šè¢«æš‚æ—¶ä¸­æ–­ã€‚doWriteInternal çš„æºç æ¶‰åŠ JDK NIO åº•å±‚ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä¸å†æ·±å…¥å±•å¼€ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨åœ¨äºåˆ é™¤ç¼“å­˜ä¸­çš„é“¾è¡¨èŠ‚ç‚¹ä»¥åŠè°ƒç”¨åº•å±‚ API å‘é€æ•°æ®ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡Œç ”ç©¶ã€‚</p>
<p>ç¬¬ä¸‰ï¼Œè°ƒç”¨ incompleteWrite æ–¹æ³•ç¡®ä¿æ•°æ®èƒ½å¤Ÿå…¨éƒ¨å‘é€å‡ºå»ï¼Œå› ä¸ºè‡ªæ—‹é”æ¬¡æ•°çš„é™åˆ¶ï¼Œå¯èƒ½æ•°æ®å¹¶æ²¡æœ‰å†™å®Œï¼Œæ‰€ä»¥éœ€è¦ç»§ç»­ OP_WRITE äº‹ä»¶ï¼›å¦‚æœæ•°æ®å·²ç»å†™å®Œï¼Œæ¸…é™¤ OP_WRITE äº‹ä»¶å³å¯ã€‚</p>
<p>è‡³æ­¤ï¼Œæ•´ä¸ª writeAndFlush çš„å·¥ä½œåŸç†å·²ç»å…¨éƒ¨åˆ†æå®Œäº†ï¼Œæ•´ä¸ªè¿‡ç¨‹çš„è°ƒç”¨å±‚æ¬¡æ¯”è¾ƒæ·±ï¼Œæˆ‘æ•´ç†äº† writeAndFlush çš„æ—¶åºå›¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œå¸®åŠ©å¤§å®¶æ¢³ç† writeAndFlush çš„è°ƒç”¨æµç¨‹ï¼ŒåŠ æ·±å¯¹ä¸Šè¿°çŸ¥è¯†ç‚¹çš„ç†è§£ã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F-uZ4iAYZDxAAROuJN6ruk510.png" alt="å›¾ç‰‡15.png"></p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>æœ¬èŠ‚è¯¾æˆ‘ä»¬æ·±å…¥åˆ†æäº† writeAndFlush çš„å¤„ç†æµç¨‹ï¼Œå¯ä»¥æ€»ç»“ä»¥ä¸‹ä¸‰ç‚¹ï¼š</p>
<ul>
<li>writeAndFlush å±äºå‡ºç«™æ“ä½œï¼Œå®ƒæ˜¯ä» Pipeline çš„ Tail èŠ‚ç‚¹å¼€å§‹è¿›è¡Œäº‹ä»¶ä¼ æ’­ï¼Œä¸€ç›´å‘å‰ä¼ æ’­åˆ° Head èŠ‚ç‚¹ã€‚ä¸ç®¡åœ¨ write è¿˜æ˜¯ flush è¿‡ç¨‹ï¼ŒHead èŠ‚ç‚¹éƒ½ä¸­æ‰®æ¼”ç€é‡è¦çš„è§’è‰²ã€‚</li>
<li>write æ–¹æ³•å¹¶æ²¡æœ‰å°†æ•°æ®å†™å…¥ Socket ç¼“å†²åŒºï¼Œåªæ˜¯å°†æ•°æ®å†™å…¥åˆ° ChannelOutboundBuffer ç¼“å­˜ä¸­ï¼ŒChannelOutboundBuffer ç¼“å­˜å†…éƒ¨æ˜¯ç”±å•å‘é“¾è¡¨å®ç°çš„ã€‚</li>
<li>flush æ–¹æ³•æ‰æœ€ç»ˆå°†æ•°æ®å†™å…¥åˆ° Socket ç¼“å†²åŒºã€‚</li>
</ul>
<p>æœ€åï¼Œç•™ä¸€ä¸ªå°çš„æ€è€ƒé¢˜ï¼ŒChannel å’Œ ChannelHandlerContext éƒ½æœ‰ writeAndFlush æ–¹æ³•ï¼Œå®ƒä»¬ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p>

        </div>
    </article>
</div>
<div class="division-line"></div>
<div class="others">
    <div>æ ‡ç­¾ï¼šğŸ·ï¸<a class="post-tag" href="/tags/netty/">netty</a>&nbsp;</div>
    <div>åˆ†ç±»ï¼š ğŸ“’<a class="post-category" href="/categories/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/">Nettyæ ¸å¿ƒåŸç†å‰–æä¸RPCå®è·µ</a>&nbsp; </div>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/08-%E5%BC%80%E7%AE%B1%E5%8D%B3%E7%94%A8netty-%E6%94%AF%E6%8C%81%E5%93%AA%E4%BA%9B%E5%B8%B8%E7%94%A8%E7%9A%84%E8%A7%A3%E7%A0%81%E5%99%A8/"><span>08 å¼€ç®±å³ç”¨ï¼šNetty æ”¯æŒå“ªäº›å¸¸ç”¨çš„è§£ç å™¨ï¼Ÿ</span></a>
    </div>
    <div class="next">
        
        <a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/10-%E5%8F%8C%E5%88%83%E5%89%91%E5%90%88%E7%90%86%E7%AE%A1%E7%90%86-netty-%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98/"><span>10 åŒåˆƒå‰‘ï¼šåˆç†ç®¡ç† Netty å †å¤–å†…å­˜</span></a>
    </div>
</div>

        </div>
        <div id="float">
            <ul class="float-button-bar">
    <li>
        <button class="float-button top" onclick="scrollToTop(this);">UP</button>
    </li>
    <li>
        <button class="float-button toggler" onclick="changeSkin(this);">DARK</button>
    </li>
</ul>
        </div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 2020 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    const changeSkin = () => {
        document.getElementById('page').classList.toggle('night');
    }
    const scrollToTop = () => {
        window.scrollTo(0, 0);
    }
</script>
</body>

</html>