<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>19 æºç ç¯‡ï¼šä¸€ä¸ªç½‘ç»œè¯·æ±‚åœ¨ Netty ä¸­çš„æ—…ç¨‹ | Yipsen Ye</title>
<meta name="description" content="é€šè¿‡å‰é¢ä¸¤èŠ‚æºç è¯¾ç¨‹çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“ Netty åœ¨æœåŠ¡ç«¯å¯åŠ¨æ—¶ä¼šä¸ºåˆ›å»º NioServerSocketChannelï¼Œå½“å®¢æˆ·ç«¯æ–°è¿æ¥æ¥å…¥æ—¶åˆä¼šåˆ›å»º NioSocketChannelï¼Œä¸ç®¡æ˜¯æœåŠ¡ç«¯è¿˜æ˜¯å®¢æˆ·ç«¯ Channelï¼Œåœ¨åˆ›å»ºæ—¶éƒ½ä¼šåˆå§‹åŒ–è‡ªå·±çš„ ChannelPipelineã€‚å¦‚æœæŠŠ Netty æ¯”ä½œæˆä¸€ä¸ªç”Ÿäº§è½¦é—´ï¼Œé‚£ä¹ˆ Reactor çº¿ç¨‹æ— ç–‘æ˜¯è½¦é—´çš„ä¸­å¤®ç®¡æ§ç³»ç»Ÿï¼ŒChannelPipeline å¯ä»¥çœ‹ä½œæ˜¯è½¦é—´çš„æµæ°´çº¿ï¼Œå°†åŸææ–™æŒ‰é¡ºåºè¿›è¡Œä¸€æ­¥æ­¥åŠ å·¥ï¼Œç„¶åå½¢æˆä¸€ä¸ªå®Œæ•´çš„äº§å“ã€‚æœ¬èŠ‚è¯¾æˆ‘å°†å¸¦ä½ å®Œæ•´æ¢³ç†ä¸€éç½‘ç»œè¯·æ±‚åœ¨ Netty ä¸­çš„å¤„ç†æµç¨‹ï¼Œä»è€ŒåŠ æ·±å¯¹å‰ä¸¤èŠ‚è¯¾å†…å®¹çš„ç†è§£ï¼Œå¹¶ç€é‡è®²è§£ ChannelPipeline çš„å·¥ä½œåŸç†ã€‚
 è¯´æ˜ï¼šæœ¬æ–‡å‚è€ƒçš„ Netty æºç ç‰ˆæœ¬ä¸º 4.1.42.Finalã€‚
 äº‹ä»¶å¤„ç†æœºåˆ¶å›é¡¾ é¦–å…ˆæˆ‘ä»¬ä»¥æœåŠ¡ç«¯æ¥å…¥å®¢æˆ·ç«¯æ–°è¿æ¥ä¸ºä¾‹ï¼Œå¹¶ç»“åˆå‰ä¸¤èŠ‚æºç è¯¾å­¦ä¹ çš„çŸ¥è¯†ç‚¹ï¼Œä¸€èµ·å¤ä¹ ä¸‹ Netty çš„äº‹ä»¶å¤„ç†æµç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚
Netty æœåŠ¡ç«¯å¯åŠ¨åï¼ŒBossEventLoopGroup ä¼šè´Ÿè´£ç›‘å¬å®¢æˆ·ç«¯çš„ Accept äº‹ä»¶ã€‚å½“æœ‰å®¢æˆ·ç«¯æ–°è¿æ¥æ¥å…¥æ—¶ï¼ŒBossEventLoopGroup ä¸­çš„ NioEventLoop é¦–å…ˆä¼šæ–°å»ºå®¢æˆ·ç«¯ Channelï¼Œç„¶ååœ¨ NioServerSocketChannel ä¸­è§¦å‘ channelRead äº‹ä»¶ä¼ æ’­ï¼ŒNioServerSocketChannel ä¸­åŒ…å«äº†ä¸€ç§ç‰¹æ®Šçš„å¤„ç†å™¨ ServerBootstrapAcceptorï¼Œæœ€ç»ˆé€šè¿‡ ServerBootstrapAcceptor çš„ channelRead() æ–¹æ³•å°†æ–°å»ºçš„å®¢æˆ·ç«¯ Channel åˆ†é…åˆ° WorkerEventLoopGroup ä¸­ã€‚WorkerEventLoopGroup ä¸­åŒ…å«å¤šä¸ª NioEventLoopï¼Œå®ƒä¼šé€‰æ‹©å…¶ä¸­ä¸€ä¸ª NioEventLoop ä¸æ–°å»ºçš„å®¢æˆ·ç«¯ Channel ç»‘å®šã€‚
å®Œæˆå®¢æˆ·ç«¯è¿æ¥æ³¨å†Œä¹‹åï¼Œå°±å¯ä»¥æ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚æ•°æ®äº†ã€‚å½“å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€æ•°æ®æ—¶ï¼ŒNioEventLoop ä¼šç›‘å¬åˆ° OP_READ äº‹ä»¶ï¼Œç„¶ååˆ†é… ByteBuf å¹¶è¯»å–æ•°æ®ï¼Œè¯»å–å®Œæˆåå°†æ•°æ®ä¼ é€’ç»™ Pipeline è¿›è¡Œå¤„ç†ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ•°æ®ä¼šä» ChannelPipeline çš„ç¬¬ä¸€ä¸ª ChannelHandler å¼€å§‹ä¼ æ’­ï¼Œå°†åŠ å·¥å¤„ç†åçš„æ¶ˆæ¯ä¼ é€’ç»™ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œæ•´ä¸ªè¿‡ç¨‹æ˜¯ä¸²è¡ŒåŒ–æ‰§è¡Œã€‚
åœ¨å‰é¢ä¸¤èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†æœåŠ¡ç«¯å¦‚ä½•æ¥æ”¶å®¢æˆ·ç«¯æ–°è¿æ¥ï¼Œä»¥åŠ NioEventLoop çš„å·¥ä½œæµç¨‹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬é‡ç‚¹ä»‹ç» ChannelPipeline æ˜¯å¦‚ä½•å®ç° Netty äº‹ä»¶é©±åŠ¨çš„ï¼Œè¿™æ · Netty æ•´ä¸ªäº‹ä»¶å¤„ç†æµç¨‹å·²ç»å¯ä»¥ä¸²æˆä¸€æ¡ä¸»çº¿ã€‚">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/netty%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e5%89%96%e6%9e%90%e4%b8%8erpc%e5%ae%9e%e8%b7%b5/">Nettyæ ¸å¿ƒåŸç†å‰–æä¸RPCå®è·µ</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/00-%E5%AD%A6%E5%A5%BD-netty%E6%98%AF%E4%BD%A0%E4%BF%AE%E7%82%BC-java-%E5%86%85%E5%8A%9F%E7%9A%84%E5%BF%85%E7%BB%8F%E4%B9%8B%E8%B7%AF/">00 å­¦å¥½ Nettyï¼Œæ˜¯ä½ ä¿®ç‚¼ Java å†…åŠŸçš„å¿…ç»ä¹‹è·¯</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/01-%E5%88%9D%E8%AF%86-netty%E4%B8%BA%E4%BB%80%E4%B9%88-netty-%E8%BF%99%E4%B9%88%E6%B5%81%E8%A1%8C/">01 åˆè¯† Nettyï¼šä¸ºä»€ä¹ˆ Netty è¿™ä¹ˆæµè¡Œï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/02-%E7%BA%B5%E8%A7%88%E5%85%A8%E5%B1%80%E6%8A%8A%E6%8F%A1-netty-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E8%84%89%E7%BB%9C/">02 çºµè§ˆå…¨å±€ï¼šæŠŠæ¡ Netty æ•´ä½“æ¶æ„è„‰ç»œ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/03-%E5%BC%95%E5%AF%BC%E5%99%A8%E4%BD%9C%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E9%83%BD%E8%A6%81%E5%81%9A%E4%BA%9B%E4%BB%80%E4%B9%88/">03 å¼•å¯¼å™¨ä½œç”¨ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¯åŠ¨éƒ½è¦åšäº›ä»€ä¹ˆï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/04-%E4%BA%8B%E4%BB%B6%E8%B0%83%E5%BA%A6%E5%B1%82%E4%B8%BA%E4%BB%80%E4%B9%88-eventloop-%E6%98%AF-netty-%E7%9A%84%E7%B2%BE%E9%AB%93/">04 äº‹ä»¶è°ƒåº¦å±‚ï¼šä¸ºä»€ä¹ˆ EventLoop æ˜¯ Netty çš„ç²¾é«“ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/05-%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92%E5%B1%82pipeline-%E5%A6%82%E4%BD%95%E5%8D%8F%E8%B0%83%E5%90%84%E7%B1%BB-handler-/">05 æœåŠ¡ç¼–æ’å±‚ï¼šPipeline å¦‚ä½•åè°ƒå„ç±» Handler ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/06-%E7%B2%98%E5%8C%85%E6%8B%86%E5%8C%85%E9%97%AE%E9%A2%98%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%95%B4%E7%9A%84%E7%BD%91%E7%BB%9C%E5%8C%85/">06 ç²˜åŒ…æ‹†åŒ…é—®é¢˜ï¼šå¦‚ä½•è·å–ä¸€ä¸ªå®Œæ•´çš„ç½‘ç»œåŒ…ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/07-%E6%8E%A5%E5%A4%B4%E6%9A%97%E8%AF%AD%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8-netty-%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E9%80%9A%E4%BF%A1/">07 æ¥å¤´æš—è¯­ï¼šå¦‚ä½•åˆ©ç”¨ Netty å®ç°è‡ªå®šä¹‰åè®®é€šä¿¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/08-%E5%BC%80%E7%AE%B1%E5%8D%B3%E7%94%A8netty-%E6%94%AF%E6%8C%81%E5%93%AA%E4%BA%9B%E5%B8%B8%E7%94%A8%E7%9A%84%E8%A7%A3%E7%A0%81%E5%99%A8/">08 å¼€ç®±å³ç”¨ï¼šNetty æ”¯æŒå“ªäº›å¸¸ç”¨çš„è§£ç å™¨ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/09-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93writeandflush-%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E5%89%96%E6%9E%90/">09 æ•°æ®ä¼ è¾“ï¼šwriteAndFlush å¤„ç†æµç¨‹å‰–æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/10-%E5%8F%8C%E5%88%83%E5%89%91%E5%90%88%E7%90%86%E7%AE%A1%E7%90%86-netty-%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98/">10 åŒåˆƒå‰‘ï¼šåˆç†ç®¡ç† Netty å †å¤–å†…å­˜</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/11-%E5%8F%A6%E8%B5%B7%E7%82%89%E7%81%B6netty-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E8%BD%BD%E4%BD%93-bytebuf-%E8%AF%A6%E8%A7%A3/">11 å¦èµ·ç‚‰ç¶ï¼šNetty æ•°æ®ä¼ è¾“è½½ä½“ ByteBuf è¯¦è§£</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/12-%E4%BB%96%E5%B1%B1%E4%B9%8B%E7%9F%B3%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%99%A8-jemalloc-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/">12 ä»–å±±ä¹‹çŸ³ï¼šé«˜æ€§èƒ½å†…å­˜åˆ†é…å™¨ jemalloc åŸºæœ¬åŸç†</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/13-%E4%B8%BE%E4%B8%80%E5%8F%8D%E4%B8%89netty-%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E8%AE%BE%E8%AE%A1%E4%B8%8A/">13 ä¸¾ä¸€åä¸‰ï¼šNetty é«˜æ€§èƒ½å†…å­˜ç®¡ç†è®¾è®¡ï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/14-%E4%B8%BE%E4%B8%80%E5%8F%8D%E4%B8%89netty-%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E8%AE%BE%E8%AE%A1%E4%B8%8B/">14 ä¸¾ä¸€åä¸‰ï¼šNetty é«˜æ€§èƒ½å†…å­˜ç®¡ç†è®¾è®¡ï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/15-%E8%BD%BB%E9%87%8F%E7%BA%A7%E5%AF%B9%E8%B1%A1%E5%9B%9E%E6%94%B6%E7%AB%99recycler-%E5%AF%B9%E8%B1%A1%E6%B1%A0%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90/">15 è½»é‡çº§å¯¹è±¡å›æ”¶ç«™ï¼šRecycler å¯¹è±¡æ± æŠ€æœ¯è§£æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/16-io-%E5%8A%A0%E9%80%9F%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%E7%9A%84-netty-%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF/">16 IO åŠ é€Ÿï¼šä¸ä¼—ä¸åŒçš„ Netty é›¶æ‹·è´æŠ€æœ¯</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/17-%E6%BA%90%E7%A0%81%E7%AF%87%E4%BB%8E-linux-%E5%87%BA%E5%8F%91%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">17 æºç ç¯‡ï¼šä» Linux å‡ºå‘æ·±å…¥å‰–ææœåŠ¡ç«¯å¯åŠ¨æµç¨‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/18-%E6%BA%90%E7%A0%81%E7%AF%87%E8%A7%A3%E5%AF%86-netty-reactor-%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/">18 æºç ç¯‡ï¼šè§£å¯† Netty Reactor çº¿ç¨‹æ¨¡å‹</a></li>
                
                
                
                    <li>19 æºç ç¯‡ï¼šä¸€ä¸ªç½‘ç»œè¯·æ±‚åœ¨ Netty ä¸­çš„æ—…ç¨‹</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/20-%E6%8A%80%E5%B7%A7%E7%AF%87netty-%E7%9A%84-fastthreadlocal-%E7%A9%B6%E7%AB%9F%E6%AF%94-threadlocal-%E5%BF%AB%E5%9C%A8%E5%93%AA%E5%84%BF/">20 æŠ€å·§ç¯‡ï¼šNetty çš„ FastThreadLocal ç©¶ç«Ÿæ¯” ThreadLocal å¿«åœ¨å“ªå„¿ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/21-%E6%8A%80%E5%B7%A7%E7%AF%87%E5%BB%B6%E8%BF%9F%E4%BB%BB%E5%8A%A1%E5%A4%84%E7%90%86%E7%A5%9E%E5%99%A8%E4%B9%8B%E6%97%B6%E9%97%B4%E8%BD%AE-hashedwheeltimer/">21 æŠ€å·§ç¯‡ï¼šå»¶è¿Ÿä»»åŠ¡å¤„ç†ç¥å™¨ä¹‹æ—¶é—´è½® HashedWheelTimer</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/22-%E6%8A%80%E5%B7%A7%E7%AF%87%E9%AB%98%E6%80%A7%E8%83%BD%E6%97%A0%E9%94%81%E9%98%9F%E5%88%97-mpsc-queue/">22 æŠ€å·§ç¯‡ï¼šé«˜æ€§èƒ½æ— é”é˜Ÿåˆ— Mpsc Queue</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/23-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E9%AB%98%E6%80%A7%E8%83%BD%E5%88%86%E5%B8%83%E5%BC%8F-rpc-%E6%A1%86%E6%9E%B6/">23 æ¶æ„è®¾è®¡ï¼šå¦‚ä½•å®ç°ä¸€ä¸ªé«˜æ€§èƒ½åˆ†å¸ƒå¼ RPC æ¡†æ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/24-%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E4%B8%8E%E8%AE%A2%E9%98%85%E6%90%AD%E5%BB%BA%E7%94%9F%E4%BA%A7%E8%80%85%E5%92%8C%E6%B6%88%E8%B4%B9%E8%80%85%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A1%86%E6%9E%B6/">24 æœåŠ¡å‘å¸ƒä¸è®¢é˜…ï¼šæ­å»ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åŸºç¡€æ¡†æ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/25-%E8%BF%9C%E7%A8%8B%E9%80%9A%E4%BF%A1%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE%E8%AE%BE%E8%AE%A1%E4%BB%A5%E5%8F%8A%E7%BC%96%E8%A7%A3%E7%A0%81%E7%9A%84%E5%AE%9E%E7%8E%B0/">25 è¿œç¨‹é€šä¿¡ï¼šé€šä¿¡åè®®è®¾è®¡ä»¥åŠç¼–è§£ç çš„å®ç°</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/26-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%9C%BA%E5%88%B6%E7%9A%84%E5%AE%9E%E7%8E%B0/">26 æœåŠ¡æ²»ç†ï¼šæœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡æœºåˆ¶çš„å®ç°</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/27-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%BA%E7%94%A8%E6%88%B7%E5%B1%8F%E8%94%BD-rpc-%E8%B0%83%E7%94%A8%E7%9A%84%E5%BA%95%E5%B1%82%E7%BB%86%E8%8A%82/">27 åŠ¨æ€ä»£ç†ï¼šä¸ºç”¨æˆ·å±è”½ RPC è°ƒç”¨çš„åº•å±‚ç»†èŠ‚</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/28-%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93rpc-%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93%E4%B8%8E%E8%BF%9B%E9%98%B6%E5%BB%B6%E4%BC%B8/">28 å®æˆ˜æ€»ç»“ï¼šRPC å®æˆ˜æ€»ç»“ä¸è¿›é˜¶å»¶ä¼¸</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/29-%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3netty-%E4%B8%AD%E5%BA%94%E7%94%A8%E4%BA%86%E5%93%AA%E4%BA%9B%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">29 ç¼–ç¨‹æ€æƒ³ï¼šNetty ä¸­åº”ç”¨äº†å“ªäº›è®¾è®¡æ¨¡å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/30-%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93netty-%E5%9C%A8%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">30 å®è·µæ€»ç»“ï¼šNetty åœ¨é¡¹ç›®å¼€å‘ä¸­çš„ä¸€äº›æœ€ä½³å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/31-%E7%BB%93%E6%9D%9F%E8%AF%AD-%E6%8A%80%E6%9C%AF%E6%88%90%E9%95%BF%E4%B9%8B%E8%B7%AF%E5%A6%82%E4%BD%95%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB/">31 ç»“æŸè¯­ æŠ€æœ¯æˆé•¿ä¹‹è·¯ï¼šå¦‚ä½•æ‰“é€ è‡ªå·±çš„æŠ€æœ¯ä½“ç³»</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">19 æºç ç¯‡ï¼šä¸€ä¸ªç½‘ç»œè¯·æ±‚åœ¨ Netty ä¸­çš„æ—…ç¨‹</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2021-12-22 01:54:41</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/netty/">netty</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/">Nettyæ ¸å¿ƒåŸç†å‰–æä¸RPCå®è·µ</a>
                
            </div></div>
        <div class="post-content">
            <p>é€šè¿‡å‰é¢ä¸¤èŠ‚æºç è¯¾ç¨‹çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“ Netty åœ¨æœåŠ¡ç«¯å¯åŠ¨æ—¶ä¼šä¸ºåˆ›å»º NioServerSocketChannelï¼Œå½“å®¢æˆ·ç«¯æ–°è¿æ¥æ¥å…¥æ—¶åˆä¼šåˆ›å»º NioSocketChannelï¼Œä¸ç®¡æ˜¯æœåŠ¡ç«¯è¿˜æ˜¯å®¢æˆ·ç«¯ Channelï¼Œåœ¨åˆ›å»ºæ—¶éƒ½ä¼šåˆå§‹åŒ–è‡ªå·±çš„ ChannelPipelineã€‚å¦‚æœæŠŠ Netty æ¯”ä½œæˆä¸€ä¸ªç”Ÿäº§è½¦é—´ï¼Œé‚£ä¹ˆ Reactor çº¿ç¨‹æ— ç–‘æ˜¯è½¦é—´çš„ä¸­å¤®ç®¡æ§ç³»ç»Ÿï¼ŒChannelPipeline å¯ä»¥çœ‹ä½œæ˜¯è½¦é—´çš„æµæ°´çº¿ï¼Œå°†åŸææ–™æŒ‰é¡ºåºè¿›è¡Œä¸€æ­¥æ­¥åŠ å·¥ï¼Œç„¶åå½¢æˆä¸€ä¸ªå®Œæ•´çš„äº§å“ã€‚æœ¬èŠ‚è¯¾æˆ‘å°†å¸¦ä½ å®Œæ•´æ¢³ç†ä¸€éç½‘ç»œè¯·æ±‚åœ¨ Netty ä¸­çš„å¤„ç†æµç¨‹ï¼Œä»è€ŒåŠ æ·±å¯¹å‰ä¸¤èŠ‚è¯¾å†…å®¹çš„ç†è§£ï¼Œå¹¶ç€é‡è®²è§£ ChannelPipeline çš„å·¥ä½œåŸç†ã€‚</p>
<blockquote>
<p>è¯´æ˜ï¼šæœ¬æ–‡å‚è€ƒçš„ Netty æºç ç‰ˆæœ¬ä¸º 4.1.42.Finalã€‚</p>
</blockquote>
<h3 id="äº‹ä»¶å¤„ç†æœºåˆ¶å›é¡¾">äº‹ä»¶å¤„ç†æœºåˆ¶å›é¡¾</h3>
<p>é¦–å…ˆæˆ‘ä»¬ä»¥æœåŠ¡ç«¯æ¥å…¥å®¢æˆ·ç«¯æ–°è¿æ¥ä¸ºä¾‹ï¼Œå¹¶ç»“åˆå‰ä¸¤èŠ‚æºç è¯¾å­¦ä¹ çš„çŸ¥è¯†ç‚¹ï¼Œä¸€èµ·å¤ä¹ ä¸‹ Netty çš„äº‹ä»¶å¤„ç†æµç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/CgqCHl_Zyq-ALQoLAA9q2qihg8Q151.png" alt="Drawing 0.png"></p>
<p>Netty æœåŠ¡ç«¯å¯åŠ¨åï¼ŒBossEventLoopGroup ä¼šè´Ÿè´£ç›‘å¬å®¢æˆ·ç«¯çš„ Accept äº‹ä»¶ã€‚å½“æœ‰å®¢æˆ·ç«¯æ–°è¿æ¥æ¥å…¥æ—¶ï¼ŒBossEventLoopGroup ä¸­çš„ NioEventLoop é¦–å…ˆä¼šæ–°å»ºå®¢æˆ·ç«¯ Channelï¼Œç„¶ååœ¨ NioServerSocketChannel ä¸­è§¦å‘ channelRead äº‹ä»¶ä¼ æ’­ï¼ŒNioServerSocketChannel ä¸­åŒ…å«äº†ä¸€ç§ç‰¹æ®Šçš„å¤„ç†å™¨ ServerBootstrapAcceptorï¼Œæœ€ç»ˆé€šè¿‡ ServerBootstrapAcceptor çš„ channelRead() æ–¹æ³•å°†æ–°å»ºçš„å®¢æˆ·ç«¯ Channel åˆ†é…åˆ° WorkerEventLoopGroup ä¸­ã€‚WorkerEventLoopGroup ä¸­åŒ…å«å¤šä¸ª NioEventLoopï¼Œå®ƒä¼šé€‰æ‹©å…¶ä¸­ä¸€ä¸ª NioEventLoop ä¸æ–°å»ºçš„å®¢æˆ·ç«¯ Channel ç»‘å®šã€‚</p>
<p>å®Œæˆå®¢æˆ·ç«¯è¿æ¥æ³¨å†Œä¹‹åï¼Œå°±å¯ä»¥æ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚æ•°æ®äº†ã€‚å½“å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€æ•°æ®æ—¶ï¼ŒNioEventLoop ä¼šç›‘å¬åˆ° OP_READ äº‹ä»¶ï¼Œç„¶ååˆ†é… ByteBuf å¹¶è¯»å–æ•°æ®ï¼Œè¯»å–å®Œæˆåå°†æ•°æ®ä¼ é€’ç»™ Pipeline è¿›è¡Œå¤„ç†ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ•°æ®ä¼šä» ChannelPipeline çš„ç¬¬ä¸€ä¸ª ChannelHandler å¼€å§‹ä¼ æ’­ï¼Œå°†åŠ å·¥å¤„ç†åçš„æ¶ˆæ¯ä¼ é€’ç»™ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œæ•´ä¸ªè¿‡ç¨‹æ˜¯ä¸²è¡ŒåŒ–æ‰§è¡Œã€‚</p>
<p>åœ¨å‰é¢ä¸¤èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†æœåŠ¡ç«¯å¦‚ä½•æ¥æ”¶å®¢æˆ·ç«¯æ–°è¿æ¥ï¼Œä»¥åŠ NioEventLoop çš„å·¥ä½œæµç¨‹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬é‡ç‚¹ä»‹ç» ChannelPipeline æ˜¯å¦‚ä½•å®ç° Netty äº‹ä»¶é©±åŠ¨çš„ï¼Œè¿™æ · Netty æ•´ä¸ªäº‹ä»¶å¤„ç†æµç¨‹å·²ç»å¯ä»¥ä¸²æˆä¸€æ¡ä¸»çº¿ã€‚</p>
<h4 id="pipeline-çš„åˆå§‹åŒ–">Pipeline çš„åˆå§‹åŒ–</h4>
<p>æˆ‘ä»¬çŸ¥é“ ChannelPipeline æ˜¯åœ¨åˆ›å»º Channel æ—¶è¢«åˆ›å»ºçš„ï¼Œå®ƒæ˜¯ Channel ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªæˆå‘˜å˜é‡ã€‚å›åˆ° AbstractChannel çš„æ„é€ å‡½æ•°ï¼Œä»¥æ­¤ä¸ºåˆ‡å…¥ç‚¹ï¼Œæˆ‘ä»¬ä¸€èµ·çœ‹ä¸‹ ChannelPipeline æ˜¯å¦‚ä½•ä¸€æ­¥æ­¥è¢«æ„é€ å‡ºæ¥çš„ã€‚</p>
<pre tabindex="0"><code>// AbstractChannel

protected AbstractChannel(Channel parent) {

    this.parent = parent;

    id = newId();

    unsafe = newUnsafe();

    pipeline = newChannelPipeline();

}

// AbstractChannel#newChannelPipeline

protected DefaultChannelPipeline newChannelPipeline() {

    return new DefaultChannelPipeline(this);

}

// DefaultChannelPipeline

protected DefaultChannelPipeline(Channel channel) {

    this.channel = ObjectUtil.checkNotNull(channel, &quot;channel&quot;);

    succeededFuture = new SucceededChannelFuture(channel, null);

    voidPromise =  new VoidChannelPromise(channel, true);

    tail = new TailContext(this);

    head = new HeadContext(this);

    head.next = tail;

    tail.prev = head;

}
</code></pre><p>å½“ ChannelPipeline åˆå§‹åŒ–å®Œæˆåï¼Œä¼šæ„æˆä¸€ä¸ªç”± ChannelHandlerContext å¯¹è±¡ç»„æˆçš„åŒå‘é“¾è¡¨ï¼Œé»˜è®¤ ChannelPipeline åˆå§‹åŒ–çŠ¶æ€çš„æœ€å°ç»“æ„ä»…åŒ…å« HeadContext å’Œ TailContext ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F_ZyruACytKAAOEkLnjkRc999.png" alt="Drawing 1.png"></p>
<p>HeadContext å’Œ TailContext å±äº ChannelPipeline ä¸­ä¸¤ä¸ªç‰¹æ®Šçš„èŠ‚ç‚¹ï¼Œå®ƒä»¬éƒ½ç»§æ‰¿è‡ª AbstractChannelHandlerContextï¼Œæ ¹æ®æºç çœ‹ä¸‹ AbstractChannelHandlerContext æœ‰å“ªäº›å®ç°ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚é™¤äº† HeadContext å’Œ TailContextï¼Œè¿˜æœ‰ä¸€ä¸ªé»˜è®¤å®ç°ç±» DefaultChannelHandlerContextï¼Œæˆ‘ä»¬å¯ä»¥çŒœåˆ° DefaultChannelHandlerContext å°è£…çš„æ˜¯ç”¨æˆ·åœ¨ Netty å¯åŠ¨é…ç½®ç±»ä¸­æ·»åŠ çš„è‡ªå®šä¹‰ä¸šåŠ¡å¤„ç†å™¨ï¼ŒDefaultChannelHandlerContext ä¼šæ’å…¥åˆ° HeadContext å’Œ TailContext ä¹‹é—´ã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F_fiOeALI8eAAVUA-uqBu0074.png" alt="å›¾ç‰‡3.png"></p>
<p>æ¥ç€æˆ‘ä»¬æ¯”è¾ƒä¸€ä¸‹ä¸Šè¿°ä¸‰ç§ AbstractChannelHandlerContext å®ç°ç±»çš„å†…éƒ¨ç»“æ„ï¼Œå‘ç°å®ƒä»¬éƒ½åŒ…å«å½“å‰ ChannelPipeline çš„å¼•ç”¨ã€å¤„ç†å™¨ ChannelHandlerã€‚æœ‰ä¸€ç‚¹ä¸åŒçš„æ˜¯ HeadContext èŠ‚ç‚¹è¿˜åŒ…å«äº†ç”¨äºæ“ä½œåº•å±‚æ•°æ®è¯»å†™çš„ unsafe å¯¹è±¡ã€‚å¯¹äº Inbound äº‹ä»¶ï¼Œä¼šå…ˆä» HeadContext èŠ‚ç‚¹å¼€å§‹ä¼ æ’­ï¼Œæ‰€ä»¥ unsafe å¯ä»¥çœ‹ä½œæ˜¯ Inbound äº‹ä»¶çš„å‘èµ·è€…ï¼›å¯¹äº Outbound äº‹ä»¶ï¼Œæ•°æ®æœ€ååˆä¼šç»è¿‡ HeadContext èŠ‚ç‚¹è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶ unsafe å¯ä»¥çœ‹ä½œæ˜¯ Outbound äº‹ä»¶çš„å¤„ç†è€…ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­çœ‹ä¸‹ç”¨æˆ·è‡ªå®šä¹‰çš„å¤„ç†å™¨æ˜¯å¦‚ä½•åŠ å…¥ ChannelPipeline çš„åŒå‘é“¾è¡¨çš„ã€‚</p>
<h4 id="pipeline-æ·»åŠ -handler">Pipeline æ·»åŠ  Handler</h4>
<p>åœ¨ Netty å®¢æˆ·ç«¯æˆ–è€…æœåŠ¡ç«¯å¯åŠ¨æ—¶ï¼Œå°±éœ€è¦ç”¨æˆ·é…ç½®è‡ªå®šä¹‰å®ç°çš„ä¸šåŠ¡å¤„ç†å™¨ã€‚æˆ‘ä»¬å…ˆçœ‹ä¸€æ®µæœåŠ¡ç«¯å¯åŠ¨ç±»çš„ä»£ç ç‰‡æ®µï¼š</p>
<pre tabindex="0"><code>ServerBootstrap b = new ServerBootstrap();

b.group(bossGroup, workerGroup)

        .channel(NioServerSocketChannel.class)

        .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {

            @Override

            public void initChannel(SocketChannel ch) {

                ch.pipeline().addLast(new SampleInboundA());

                ch.pipeline().addLast(new SampleInboundB());

                ch.pipeline().addLast(new SampleOutboundA());

                ch.pipeline().addLast(new SampleOutboundB());

            }

        });
</code></pre><p>æˆ‘ä»¬çŸ¥é“ ChannelPipeline åˆ†ä¸ºå…¥ç«™ ChannelInboundHandler å’Œå‡ºç«™ ChannelOutboundHandler ä¸¤ç§å¤„ç†å™¨ï¼Œå®ƒä»¬éƒ½ä¼šè¢« ChannelHandlerContext å°è£…ï¼Œä¸ç®¡æ˜¯å“ªç§å¤„ç†å™¨ï¼Œæœ€ç»ˆéƒ½æ˜¯é€šè¿‡åŒå‘é“¾è¡¨è¿æ¥ï¼Œä»£ç ç¤ºä¾‹ä¸­æ„æˆçš„ ChannelPipeline çš„ç»“æ„å¦‚ä¸‹ã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/CgpVE1_fiPGASYaAAAJ5IvplmPM854.png" alt="å›¾ç‰‡4.png"></p>
<p>é‚£ä¹ˆ ChannelPipeline åœ¨æ·»åŠ  Handler æ—¶æ˜¯å¦‚ä½•åŒºåˆ† Inbound å’Œ Outbound ç±»å‹çš„å‘¢ï¼Ÿæˆ‘ä»¬ä¸€èµ·è·Ÿè¿› ch.pipeline().addLast() æ–¹æ³•æºç ï¼Œå®šä½åˆ°æ ¸å¿ƒä»£ç å¦‚ä¸‹ã€‚</p>
<pre tabindex="0"><code>public final ChannelPipeline addLast(EventExecutorGroup group, String name, ChannelHandler handler) {

    final AbstractChannelHandlerContext newCtx;

    synchronized (this) {

        // 1. æ£€æŸ¥æ˜¯å¦é‡å¤æ·»åŠ  Handler

        checkMultiplicity(handler);

        // 2. åˆ›å»ºæ–°çš„ DefaultChannelHandlerContext èŠ‚ç‚¹

        newCtx = newContext(group, filterName(name, handler), handler);

        // 3. æ·»åŠ æ–°çš„ DefaultChannelHandlerContext èŠ‚ç‚¹åˆ° ChannelPipeline

         addLast0(newCtx);

        // çœç•¥å…¶ä»–ä»£ç 

    }

    // 4. å›è°ƒç”¨æˆ·æ–¹æ³•

    callHandlerAdded0(newCtx);

    return this;

}
</code></pre><p>addLast() ä¸»è¦åšäº†ä»¥ä¸‹å››ä»¶äº‹ï¼š</p>
<ol>
<li>æ£€æŸ¥æ˜¯å¦é‡å¤æ·»åŠ  Handlerã€‚</li>
<li>åˆ›å»ºæ–°çš„ DefaultChannelHandlerContext èŠ‚ç‚¹ã€‚</li>
<li>æ·»åŠ æ–°çš„ DefaultChannelHandlerContext èŠ‚ç‚¹åˆ° ChannelPipelineã€‚</li>
<li>å›è°ƒç”¨æˆ·æ–¹æ³•ã€‚</li>
</ol>
<p>å‰ä¸‰ä¸ªæ­¥éª¤é€šè¿‡ synchronized åŠ é”å®Œæˆçš„ï¼Œä¸ºäº†é˜²æ­¢å¤šçº¿ç¨‹å¹¶å‘æ“ä½œ ChannelPipeline åº•å±‚åŒå‘é“¾è¡¨ã€‚ä¸‹é¢æˆ‘ä»¬ä¸€æ­¥æ­¥è¿›è¡Œæ‹†è§£ä»‹ç»ã€‚</p>
<p>é¦–å…ˆåœ¨æ·»åŠ  Handler æ—¶ï¼ŒChannelPipeline ä¼šæ£€æŸ¥è¯¥ Handler æœ‰æ²¡æœ‰è¢«æ·»åŠ è¿‡ã€‚å¦‚æœä¸€ä¸ªéçº¿ç¨‹å®‰å…¨çš„ Handler è¢«æ·»åŠ åˆ° ChannelPipeline ä¸­ï¼Œé‚£ä¹ˆå½“å¤šçº¿ç¨‹è®¿é—®æ—¶ä¼šé€ æˆçº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚Netty å…·ä½“æ£€æŸ¥é‡å¤æ€§çš„é€»è¾‘ç”± checkMultiplicity() æ–¹æ³•å®ç°ï¼š</p>
<pre tabindex="0"><code>private static void checkMultiplicity(ChannelHandler handler) {

    if (handler instanceof ChannelHandlerAdapter) {

        ChannelHandlerAdapter h = (ChannelHandlerAdapter) handler;

        if (!h.isSharable() &amp;&amp; h.added) {

            throw new ChannelPipelineException(

                    h.getClass().getName() +

                    &quot; is not a @Sharable handler, so can't be added or removed multiple times.&quot;);

        }

        h.added = true;

    }

}
</code></pre><p>ç”¨æˆ·è‡ªå®šä¹‰å®ç°çš„å¤„ç†ä¸€èˆ¬éƒ½ç»§æ‰¿äº ChannelHandlerAdapterï¼ŒChannelHandlerAdapter ä¸­ä½¿ç”¨ added å˜é‡æ ‡è¯†è¯¥ Handler æ˜¯å¦è¢«æ·»åŠ è¿‡ã€‚å¦‚æœå½“å‰æ·»åŠ çš„ Handler æ˜¯éå…±äº«ä¸”å·²è¢«æ·»åŠ è¿‡ï¼Œé‚£ä¹ˆå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¦åˆ™å°†å½“å‰ Handler æ ‡è®°ä¸ºå·²æ·»åŠ ã€‚</p>
<p>h.isSharable() ç”¨äºåˆ¤æ–­ Handler æ˜¯å¦æ˜¯å…±äº«çš„ï¼Œæ‰€è°“å…±äº«å°±æ˜¯è¿™ä¸ª Handler å¯ä»¥è¢«é‡å¤æ·»åŠ åˆ°ä¸åŒçš„ ChannelPipeline ä¸­ï¼Œå…±äº«çš„ Handler å¿…é¡»è¦ç¡®ä¿æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å¦‚æœæˆ‘ä»¬æƒ³å®ç°ä¸€ä¸ªå…±äº«çš„ Handlerï¼Œåªéœ€è¦åœ¨ Handler ä¸­æ·»åŠ  @Sharable æ³¨è§£å³å¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@ChannelHandler.Sharable

public class SampleInBoundHandler extends ChannelInboundHandlerAdapter {}
</code></pre><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æ addLast() çš„ç¬¬äºŒæ­¥ï¼Œåˆ›å»ºæ–°çš„ DefaultChannelHandlerContext èŠ‚ç‚¹ã€‚åœ¨æ‰§è¡Œ newContext() æ–¹æ³•ä¹‹å‰ï¼Œä¼šé€šè¿‡ filterName() ä¸º Handler åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„åç§°ï¼Œä¸€èµ·å…ˆçœ‹ä¸‹ Netty ç”Ÿæˆåç§°çš„ç­–ç•¥æ˜¯æ€æ ·çš„ã€‚</p>
<pre tabindex="0"><code>private String filterName(String name, ChannelHandler handler) {

    if (name == null) {

        return generateName(handler);

    }

    checkDuplicateName(name);

    return name;

}

private String generateName(ChannelHandler handler) {

    Map&lt;Class&lt;?&gt;, String&gt; cache = nameCaches.get();

    Class&lt;?&gt; handlerType = handler.getClass();

    String name = cache.get(handlerType);

    if (name == null) {

        name = generateName0(handlerType);

        cache.put(handlerType, name);

    }

    if (context0(name) != null) {

        String baseName = name.substring(0, name.length() - 1);

        for (int i = 1;; i ++) {

            String newName = baseName + i;

            if (context0(newName) == null) {

                name = newName;

                break;

            }

        }

    }

    return name;

}

private static String generateName0(Class&lt;?&gt; handlerType) {

    return StringUtil.simpleClassName(handlerType) + &quot;#0&quot;;

}
</code></pre><p>Netty ä¼šä½¿ç”¨ FastThreadLocal ç¼“å­˜ Handler å’Œåç§°çš„æ˜ å°„å…³ç³»ï¼Œåœ¨ä¸º Handler ç”Ÿæˆé»˜è®¤åç§°çš„ä¹‹å‰ï¼Œä¼šå…ˆä»ç¼“å­˜ä¸­æŸ¥æ‰¾æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œä¼šè°ƒç”¨ generateName0() æ–¹æ³•ç”Ÿæˆé»˜è®¤åç§°åï¼Œå¹¶åŠ å…¥ç¼“å­˜ã€‚å¯ä»¥çœ‹å‡º Netty ç”Ÿæˆåç§°çš„é»˜è®¤è§„åˆ™æ˜¯ â€œç®€å•ç±»å#0â€ï¼Œä¾‹å¦‚ HeadContext çš„é»˜è®¤åç§°ä¸º â€œDefaultChannelPipeline$HeadContext#0â€ã€‚</p>
<p>ä¸º Handler ç”Ÿæˆå®Œé»˜è®¤åç§°ä¹‹åï¼Œè¿˜ä¼šé€šè¿‡ context0() æ–¹æ³•æ£€æŸ¥ç”Ÿæˆçš„åç§°æ˜¯å¦å’Œ ChannelPipeline å·²æœ‰çš„åç§°å‡ºç°å†²çªï¼ŒæŸ¥é‡çš„è¿‡ç¨‹å¾ˆç®€å•ï¼Œå°±æ˜¯å¯¹åŒå‘é“¾è¡¨è¿›è¡Œçº¿æ€§æœç´¢ã€‚å¦‚æœå­˜åœ¨å†²çªç°è±¡ï¼ŒNetty ä¼šå°†åç§°æœ€åçš„åºåˆ—å·æˆªå–å‡ºæ¥ï¼Œä¸€ç›´é€’å¢ç›´è‡³ç”Ÿæˆä¸å†²çªçš„åç§°ä¸ºæ­¢ï¼Œä¾‹å¦‚ â€œç®€å•ç±»å#1â€ â€œç®€å•ç±»å#2â€ â€œç®€å•ç±»å#3â€ ç­‰ç­‰ã€‚</p>
<p>æ¥ä¸‹æ¥å›åˆ° newContext() åˆ›å»ºèŠ‚ç‚¹çš„æµç¨‹ï¼Œå¯ä»¥å®šä½åˆ° AbstractChannelHandlerContext çš„æ„é€ å‡½æ•°ï¼š</p>
<pre tabindex="0"><code>AbstractChannelHandlerContext(DefaultChannelPipeline pipeline, EventExecutor executor,

                              String name, Class&lt;? extends ChannelHandler&gt; handlerClass) {

    this.name = ObjectUtil.checkNotNull(name, &quot;name&quot;);

    this.pipeline = pipeline;

    this.executor = executor;

    this.executionMask = mask(handlerClass);

    ordered = executor == null || executor instanceof OrderedEventExecutor;

}
</code></pre><p>AbstractChannelHandlerContext ä¸­æœ‰ä¸€ä¸ª executionMask å±æ€§å¹¶ä¸æ˜¯å¾ˆå¥½ç†è§£ï¼Œå®ƒå…¶å®æ˜¯ä¸€ç§å¸¸ç”¨çš„æ©ç è¿ç®—æ“ä½œï¼Œçœ‹ä¸‹ mask() æ–¹æ³•æ˜¯å¦‚ä½•ç”Ÿæˆæ©ç çš„å‘¢ï¼Ÿ</p>
<pre tabindex="0"><code>private static int mask0(Class&lt;? extends ChannelHandler&gt; handlerType) {

    int mask = MASK_EXCEPTION_CAUGHT;

    try {

        if (ChannelInboundHandler.class.isAssignableFrom(handlerType)) {

            // å¦‚æœæ˜¯ ChannelInboundHandler å®ä¾‹ï¼Œæ‰€æœ‰ Inbound äº‹ä»¶ç½®ä¸º 1

            mask |= MASK_ALL_INBOUND;

            // æ’é™¤ Handler ä¸æ„Ÿå…´è¶£çš„ Inbound äº‹ä»¶

            if (isSkippable(handlerType, &quot;channelRegistered&quot;, ChannelHandlerContext.class)) {

                mask &amp;= ~MASK_CHANNEL_REGISTERED;

            }

            if (isSkippable(handlerType, &quot;channelUnregistered&quot;, ChannelHandlerContext.class)) {

                mask &amp;= ~MASK_CHANNEL_UNREGISTERED;

            }

            if (isSkippable(handlerType, &quot;channelActive&quot;, ChannelHandlerContext.class)) {

                mask &amp;= ~MASK_CHANNEL_ACTIVE;

            }

            if (isSkippable(handlerType, &quot;channelInactive&quot;, ChannelHandlerContext.class)) {

                mask &amp;= ~MASK_CHANNEL_INACTIVE;

            }

            if (isSkippable(handlerType, &quot;channelRead&quot;, ChannelHandlerContext.class, Object.class)) {

                mask &amp;= ~MASK_CHANNEL_READ;

            }

            if (isSkippable(handlerType, &quot;channelReadComplete&quot;, ChannelHandlerContext.class)) {

                mask &amp;= ~MASK_CHANNEL_READ_COMPLETE;

            }

            if (isSkippable(handlerType, &quot;channelWritabilityChanged&quot;, ChannelHandlerContext.class)) {

                mask &amp;= ~MASK_CHANNEL_WRITABILITY_CHANGED;

            }

            if (isSkippable(handlerType, &quot;userEventTriggered&quot;, ChannelHandlerContext.class, Object.class)) {

                mask &amp;= ~MASK_USER_EVENT_TRIGGERED;

            }

        }

        if (ChannelOutboundHandler.class.isAssignableFrom(handlerType)) {

            // å¦‚æœæ˜¯ ChannelOutboundHandler å®ä¾‹ï¼Œæ‰€æœ‰ Outbound äº‹ä»¶ç½®ä¸º 1

            mask |= MASK_ALL_OUTBOUND;

            // æ’é™¤ Handler ä¸æ„Ÿå…´è¶£çš„ Outbound äº‹ä»¶

            if (isSkippable(handlerType, &quot;bind&quot;, ChannelHandlerContext.class,

                    SocketAddress.class, ChannelPromise.class)) {

                mask &amp;= ~MASK_BIND;

            }

            if (isSkippable(handlerType, &quot;connect&quot;, ChannelHandlerContext.class, SocketAddress.class,

                    SocketAddress.class, ChannelPromise.class)) {

                mask &amp;= ~MASK_CONNECT;

            }

            if (isSkippable(handlerType, &quot;disconnect&quot;, ChannelHandlerContext.class, ChannelPromise.class)) {

                mask &amp;= ~MASK_DISCONNECT;

            }

            if (isSkippable(handlerType, &quot;close&quot;, ChannelHandlerContext.class, ChannelPromise.class)) {

                mask &amp;= ~MASK_CLOSE;

            }

            if (isSkippable(handlerType, &quot;deregister&quot;, ChannelHandlerContext.class, ChannelPromise.class)) {

                mask &amp;= ~MASK_DEREGISTER;

            }

            if (isSkippable(handlerType, &quot;read&quot;, ChannelHandlerContext.class)) {

                mask &amp;= ~MASK_READ;

            }

            if (isSkippable(handlerType, &quot;write&quot;, ChannelHandlerContext.class,

                    Object.class, ChannelPromise.class)) {

                mask &amp;= ~MASK_WRITE;

            }

            if (isSkippable(handlerType, &quot;flush&quot;, ChannelHandlerContext.class)) {

                mask &amp;= ~MASK_FLUSH;

            }

        }

        if (isSkippable(handlerType, &quot;exceptionCaught&quot;, ChannelHandlerContext.class, Throwable.class)) {

            mask &amp;= ~MASK_EXCEPTION_CAUGHT;

        }

    } catch (Exception e) {

        PlatformDependent.throwException(e);

    }

    return mask;

}
</code></pre><p>Netty ä¸­åˆ†åˆ«æœ‰å¤šç§ Inbound äº‹ä»¶å’Œ Outbound äº‹ä»¶ï¼Œå¦‚ Inbound äº‹ä»¶æœ‰ channelRegisteredã€channelActiveã€channelRead ç­‰ç­‰ã€‚Netty ä¼šåˆ¤æ–­ Handler çš„ç±»å‹æ˜¯å¦æ˜¯ ChannelInboundHandler çš„å®ä¾‹ï¼Œå¦‚æœæ˜¯ä¼šæŠŠæ‰€æœ‰ Inbound äº‹ä»¶å…ˆç½®ä¸º 1ï¼Œç„¶åæ’é™¤ Handler ä¸æ„Ÿå…´è¶£çš„æ–¹æ³•ã€‚åŒç†ï¼ŒHandler ç±»å‹å¦‚æœæ˜¯ ChannelOutboundHandlerï¼Œä¹Ÿæ˜¯è¿™ä¹ˆå®ç°çš„ã€‚</p>
<p>é‚£ä¹ˆå¦‚ä½•æ’é™¤ Handler ä¸æ„Ÿå…´è¶£çš„äº‹ä»¶å‘¢ï¼ŸHandler å¯¹åº”äº‹ä»¶çš„æ–¹æ³•ä¸Šå¦‚æœæœ‰ @Skip æ³¨è§£ï¼ŒNetty è®¤ä¸ºè¯¥äº‹ä»¶æ˜¯éœ€è¦æ’é™¤çš„ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œç”¨æˆ·è‡ªå®šä¹‰å®ç°çš„ Handler åªéœ€è¦å…³å¿ƒä¸ªåˆ«äº‹ä»¶ï¼Œé‚£ä¹ˆå‰©ä½™ä¸å…³å¿ƒçš„æ–¹æ³•éƒ½éœ€è¦åŠ ä¸Š @Skip æ³¨è§£å—ï¼ŸNetty å…¶å®å·²ç»åœ¨ ChannelHandlerAdapter ä¸­é»˜è®¤éƒ½æ·»åŠ å¥½äº†ï¼Œæ‰€ä»¥ç”¨æˆ·å¦‚æœç»§æ‰¿äº† ChannelHandlerAdapterï¼Œé»˜è®¤æ²¡æœ‰é‡å†™çš„æ–¹æ³•éƒ½æ˜¯åŠ ä¸Š @Skip çš„ï¼Œåªæœ‰ç”¨æˆ·é‡å†™çš„æ–¹æ³•æ‰æ˜¯ Handler å…³å¿ƒçš„äº‹ä»¶ã€‚</p>
<p>å›åˆ° addLast() çš„ä¸»æµç¨‹ï¼Œæ¥ç€éœ€è¦å°†æ–°åˆ›å»ºçš„ DefaultChannelHandlerContext èŠ‚ç‚¹æ·»åŠ åˆ° ChannelPipeline ä¸­ï¼Œè·Ÿè¿› addLast0() æ–¹æ³•çš„æºç ã€‚</p>
<pre tabindex="0"><code>private void addLast0(AbstractChannelHandlerContext newCtx) {

    AbstractChannelHandlerContext prev = tail.prev;

    newCtx.prev = prev;

    newCtx.next = tail;

    prev.next = newCtx;

    tail.prev = newCtx;

}
</code></pre><p>addLast0() éå¸¸ç®€å•ï¼Œå°±æ˜¯å‘ ChannelPipeline ä¸­åŒå‘é“¾è¡¨çš„å°¾éƒ¨æ’å…¥æ–°çš„èŠ‚ç‚¹ï¼Œå…¶ä¸­ HeadContext å’Œ TailContext ä¸€ç›´æ˜¯é“¾è¡¨çš„å¤´å’Œå°¾ï¼Œæ–°çš„èŠ‚ç‚¹è¢«æ’å…¥åˆ° HeadContext å’Œ TailContext ä¹‹é—´ã€‚ä¾‹å¦‚ä»£ç ç¤ºä¾‹ä¸­ SampleOutboundA è¢«æ·»åŠ æ—¶ï¼ŒåŒå‘é“¾è¡¨çš„ç»“æ„å˜åŒ–å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F_ZywCAHl6DAAeLykJFOKE463.png" alt="Drawing 4.png"></p>
<p>æœ€åï¼Œæ·»åŠ å®ŒèŠ‚ç‚¹åï¼Œå°±åˆ°äº†å›è°ƒç”¨æˆ·æ–¹æ³•ï¼Œå®šä½åˆ° callHandlerAdded() çš„æ ¸å¿ƒæºç ï¼š</p>
<pre tabindex="0"><code>final void callHandlerAdded() throws Exception {

    if (setAddComplete()) {

        handler().handlerAdded(this);

    }

}

final boolean setAddComplete() {

    for (;;) {

        int oldState = handlerState;

        if (oldState == REMOVE_COMPLETE) {

            return false;

        }
        if (HANDLER_STATE_UPDATER.compareAndSet(this, oldState, ADD_COMPLETE)) {

            return true;

        }

    }

}
</code></pre><p>Netty ä¼šé€šè¿‡ CAS ä¿®æ”¹èŠ‚ç‚¹çš„çŠ¶æ€ç›´è‡³ REMOVE_COMPLETE æˆ–è€… ADD_COMPLETEï¼Œå¦‚æœä¿®æ”¹èŠ‚ç‚¹ä¸º ADD_COMPLETE çŠ¶æ€ï¼Œè¡¨ç¤ºèŠ‚ç‚¹å·²ç»æ·»åŠ æˆåŠŸï¼Œç„¶åä¼šå›è°ƒç”¨æˆ· Handler ä¸­å®ç°çš„ handlerAdded() æ–¹æ³•ã€‚</p>
<p>è‡³æ­¤ï¼ŒPipeline æ·»åŠ  Handler çš„å®ç°åŸç†æˆ‘ä»¬å·²ç»è®²å®Œäº†ï¼Œä¸‹é¢æ¥ç€çœ‹ä¸‹ Pipeline åˆ é™¤ Handler çš„åœºæ™¯ã€‚</p>
<h4 id="pipeline-åˆ é™¤-handler">Pipeline åˆ é™¤ Handler</h4>
<p>åœ¨ã€Šæºç ç¯‡ï¼šä» Linux å‡ºå‘æ·±å…¥å‰–ææœåŠ¡ç«¯å¯åŠ¨æµç¨‹ã€‹çš„è¯¾ç¨‹ä¸­æˆ‘ä»¬ä»‹ç»äº†ä¸€ç§ç‰¹æ®Šçš„å¤„ç†å™¨ ChannelInitializerï¼ŒChannelInitializer åœ¨æœåŠ¡ç«¯ Channel æ³¨å†Œå®Œæˆä¹‹åä¼šä» Pipeline çš„åŒå‘é“¾è¡¨ä¸­ç§»é™¤ï¼Œæˆ‘ä»¬ä¸€èµ·å›é¡¾ä¸‹è¿™æ®µä»£ç ï¼š</p>
<pre tabindex="0"><code>private boolean initChannel(ChannelHandlerContext ctx) throws Exception {

    if (initMap.add(ctx)) {

        try {

            initChannel((C) ctx.channel()); // è°ƒç”¨ ChannelInitializer å®ç°çš„ initChannel() æ–¹æ³•

        } catch (Throwable cause) {

            exceptionCaught(ctx, cause);

        } finally {

            ChannelPipeline pipeline = ctx.pipeline();

            if (pipeline.context(this) != null) {

                pipeline.remove(this); // å°† ChannelInitializer è‡ªèº«ä» Pipeline ä¸­ç§»å‡º

            }

        }

        return true;

    }

    return false;

}
</code></pre><p>ç»§ç»­è·Ÿè¿› pipeline.remove() çš„æºç ã€‚</p>
<pre tabindex="0"><code>@Override

public final ChannelPipeline remove(ChannelHandler handler) {

    // 1. getContextOrDie ç”¨äºæŸ¥æ‰¾éœ€è¦åˆ é™¤çš„èŠ‚ç‚¹

    remove(getContextOrDie(handler));

    return this;

}

private AbstractChannelHandlerContext remove(final AbstractChannelHandlerContext ctx) {

    assert ctx != head &amp;&amp; ctx != tail;

    synchronized (this) {

        // åˆ é™¤åŒå‘é“¾è¡¨ä¸­çš„ Handler èŠ‚ç‚¹

        atomicRemoveFromHandlerList(ctx);

        if (!registered) {

            callHandlerCallbackLater(ctx, false);

            return ctx;

        }

        EventExecutor executor = ctx.executor();

        if (!executor.inEventLoop()) {

            executor.execute(new Runnable() {

                @Override

                public void run() {

                    callHandlerRemoved0(ctx);

                }

            });

            return ctx;

        }

    }

    // 3. å›è°ƒç”¨æˆ·å‡½æ•°

    callHandlerRemoved0(ctx);

    return ctx;

}
</code></pre><p>æ•´ä¸ªåˆ é™¤ Handler çš„è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸‰æ­¥ï¼Œåˆ†åˆ«ä¸ºï¼š</p>
<ol>
<li>æŸ¥æ‰¾éœ€è¦åˆ é™¤çš„ Handler èŠ‚ç‚¹ï¼›</li>
<li>ç„¶ååˆ é™¤åŒå‘é“¾è¡¨ä¸­çš„ Handler èŠ‚ç‚¹ï¼›</li>
<li>æœ€åå›è°ƒç”¨æˆ·å‡½æ•°ã€‚</li>
</ol>
<p>æˆ‘ä»¬å¯¹æ¯ä¸€æ­¥é€ä¸€è¿›è¡Œæ‹†è§£ã€‚</p>
<p>ç¬¬ä¸€æ­¥æŸ¥æ‰¾éœ€è¦åˆ é™¤çš„ Handler èŠ‚ç‚¹ï¼Œæˆ‘ä»¬è‡ªç„¶å¯ä»¥æƒ³åˆ°é€šè¿‡éå†åŒå‘é“¾è¡¨å®ç°ã€‚ä¸€èµ·çœ‹ä¸‹ getContextOrDie() æ–¹æ³•çš„æºç ï¼š</p>
<pre tabindex="0"><code>private AbstractChannelHandlerContext getContextOrDie(ChannelHandler handler) {

    AbstractChannelHandlerContext ctx = (AbstractChannelHandlerContext) context(handler);

    if (ctx == null) {

        throw new NoSuchElementException(handler.getClass().getName());

    } else {

        return ctx;

    }

}

public final ChannelHandlerContext context(ChannelHandler handler) {

    if (handler == null) {

        throw new NullPointerException(&quot;handler&quot;);

    }

    // éå†åŒå‘é“¾è¡¨æŸ¥æ‰¾

    AbstractChannelHandlerContext ctx = head.next;

    for (;;) {

        if (ctx == null) {

            return null;

        }

        // å¦‚æœ Handler ç›¸åŒï¼Œè¿”å›å½“å‰çš„ Context èŠ‚ç‚¹

        if (ctx.handler() == handler) { 

            return ctx;

        }

        ctx = ctx.next;

    }

}
</code></pre><p>Netty ç¡®å®æ˜¯ä»åŒå‘é“¾è¡¨çš„å¤´ç»“ç‚¹å¼€å§‹ä¾æ¬¡éå†ï¼Œå¦‚æœå½“å‰ Context èŠ‚ç‚¹çš„ Handler è¦è¢«åˆ é™¤çš„ Handler ç›¸åŒï¼Œé‚£ä¹ˆä¾¿æ‰¾åˆ°äº†è¦åˆ é™¤çš„ Handlerï¼Œç„¶åè¿”å›å½“å‰ Context èŠ‚ç‚¹ã€‚</p>
<p>æ‰¾åˆ°éœ€è¦åˆ é™¤çš„ Handler èŠ‚ç‚¹ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯å°†èŠ‚ç‚¹ä»åŒå‘é“¾è¡¨ä¸­åˆ é™¤ï¼Œå†è·Ÿè¿›atomicRemoveFromHandlerList() æ–¹æ³•çš„æºç ï¼š</p>
<pre tabindex="0"><code>private synchronized void atomicRemoveFromHandlerList(AbstractChannelHandlerContext ctx) {

    AbstractChannelHandlerContext prev = ctx.prev;

    AbstractChannelHandlerContext next = ctx.next;

    prev.next = next;

    next.prev = prev;

}
</code></pre><p>åˆ é™¤èŠ‚ç‚¹å’Œæ·»åŠ èŠ‚ç‚¹ç±»ä¼¼ï¼Œéƒ½æ˜¯åŸºæœ¬çš„é“¾è¡¨æ“ä½œï¼Œé€šè¿‡è°ƒæ•´åŒå‘é“¾è¡¨çš„æŒ‡é’ˆå³å¯å®ç°ã€‚å‡è®¾ç°åœ¨éœ€è¦åˆ é™¤ SampleOutboundA èŠ‚ç‚¹ï¼Œæˆ‘ä»¬ä»¥ä¸€å¹…å›¾æ¥è¡¨ç¤ºåˆ é™¤æ—¶æŒ‡é’ˆçš„å˜åŒ–è¿‡ç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/CgqCHl_fiRyAI2KKAAH7-GYFUt4327.png" alt="å›¾ç‰‡6.png"></p>
<p>åˆ é™¤å®ŒèŠ‚ç‚¹ä¹‹åï¼Œæœ€å Netty ä¼šå›è°ƒç”¨æˆ·è‡ªå®šä¹‰å®ç°çš„ handlerRemoved() æ–¹æ³•ï¼Œå›è°ƒçš„å®ç°è¿‡ç¨‹ä¸æ·»åŠ èŠ‚ç‚¹æ—¶æ˜¯ç±»ä¼¼çš„ï¼Œåœ¨è¿™é‡Œæˆ‘å°±ä¸èµ˜è¿°äº†ã€‚</p>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¼šäº† ChannelPipeline å†…éƒ¨ç»“æ„çš„åŸºæœ¬æ“ä½œï¼Œåªéœ€è¦åŸºæœ¬çš„é“¾è¡¨æ“ä½œå°±å¯ä»¥å®ç° Handler èŠ‚ç‚¹çš„æ·»åŠ å’Œåˆ é™¤ï¼Œæ·»åŠ æ—¶é€šè¿‡æ©ç è¿ç®—çš„æ–¹å¼æ’å‡º Handler ä¸å…³å¿ƒçš„äº‹ä»¶ã€‚ ChannelPipeline æ˜¯å¦‚ä½•è°ƒåº¦ Handler çš„å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­å­¦ä¹ ã€‚</p>
<h3 id="æ•°æ®åœ¨-pipeline-ä¸­çš„è¿è½¬">æ•°æ®åœ¨ Pipeline ä¸­çš„è¿è½¬</h3>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œæ ¹æ®æ•°æ®çš„æµå‘ï¼ŒChannelPipeline åˆ†ä¸ºå…¥ç«™ ChannelInboundHandler å’Œå‡ºç«™ ChannelOutboundHandler ä¸¤ç§å¤„ç†å™¨ã€‚Inbound äº‹ä»¶å’Œ Outbound äº‹ä»¶çš„ä¼ æ’­æ–¹å‘ç›¸åï¼ŒInbound äº‹ä»¶çš„ä¼ æ’­æ–¹å‘ä¸º Head -&gt; Tailï¼Œè€Œ Outbound äº‹ä»¶ä¼ æ’­æ–¹å‘æ˜¯ Tail -&gt; Headã€‚ä»Šå¤©æˆ‘ä»¬å°±ä»¥å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è¯·æ±‚-å“åº”çš„åœºæ™¯ï¼Œæ·±å…¥ç ”ç©¶ ChannelPipeline çš„äº‹ä»¶ä¼ æ’­æœºåˆ¶ã€‚</p>
<h4 id="inbound-äº‹ä»¶ä¼ æ’­">Inbound äº‹ä»¶ä¼ æ’­</h4>
<p>å½“å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€æ•°æ®æ—¶ï¼ŒæœåŠ¡ç«¯æ˜¯å¦‚ä½•æ¥æ”¶çš„å‘¢ï¼Ÿå›é¡¾ä¸‹ä¹‹å‰æˆ‘ä»¬æ‰€å­¦ä¹ çš„ Netty Reactor çº¿ç¨‹æ¨¡å‹ï¼Œé¦–å…ˆ NioEventLoop ä¼šä¸æ–­è½®è¯¢ OP_ACCEPT å’Œ OP_READ äº‹ä»¶ï¼Œå½“äº‹ä»¶å°±ç»ªæ—¶ï¼ŒNioEventLoop ä¼šåŠæ—¶å“åº”ã€‚é¦–å…ˆå®šä½åˆ° NioEventLoop ä¸­æºç çš„å…¥å£ï¼š</p>
<pre tabindex="0"><code>// NioEventLoop#processSelectedKey

if ((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) != 0 || readyOps == 0) {

    unsafe.read();

}
</code></pre><p>å¯ä»¥çœ‹å‡º unsafe.read() ä¼šè§¦å‘åç»­äº‹ä»¶çš„å¤„ç†ï¼Œæœ‰ä¸€ç‚¹éœ€è¦é¿å…æ··æ·†ï¼Œåœ¨æœåŠ¡ç«¯ Channel å’Œå®¢æˆ·ç«¯ Channel ä¸­ç»‘å®šçš„ unsafe å¯¹è±¡æ˜¯ä¸ä¸€æ ·çš„ï¼Œå› ä¸ºæœåŠ¡ç«¯ Channel åªå…³å¿ƒå¦‚ä½•æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼Œè€Œå®¢æˆ·ç«¯ Channel éœ€è¦å…³å¿ƒæ•°æ®çš„è¯»å†™ã€‚è¿™é‡Œæˆ‘ä»¬é‡ç‚¹åˆ†æä¸€ä¸‹å®¢æˆ·ç«¯ Channel è¯»å–æ•°æ®çš„è¿‡ç¨‹ï¼Œè·Ÿè¿› unsafe.read() çš„æºç ï¼š</p>
<pre tabindex="0"><code>public final void read() {

    final ChannelConfig config = config();

    // çœç•¥å…¶ä»–ä»£ç 

    final ChannelPipeline pipeline = pipeline();

    final ByteBufAllocator allocator = config.getAllocator();

    final RecvByteBufAllocator.Handle allocHandle = recvBufAllocHandle();

    allocHandle.reset(config);

    ByteBuf byteBuf = null;

    boolean close = false;

    try {

        do {

            byteBuf = allocHandle.allocate(allocator); // åˆ†é… ByteBuf

            allocHandle.lastBytesRead(doReadBytes(byteBuf)); // å°† Channel ä¸­çš„æ•°æ®è¯»åˆ° ByteBuf ä¸­

            if (allocHandle.lastBytesRead() &lt;= 0) {

                byteBuf.release();

                byteBuf = null;

                close = allocHandle.lastBytesRead() &lt; 0;

                if (close) {

                    readPending = false;

                }

                break;

            }

            allocHandle.incMessagesRead(1);

            readPending = false;

            pipeline.fireChannelRead(byteBuf); // ä¼ æ’­ ChannelRead äº‹ä»¶

            byteBuf = null;

        } while (allocHandle.continueReading());

        allocHandle.readComplete();

        pipeline.fireChannelReadComplete(); // ä¼ æ’­ readComplete äº‹ä»¶

        if (close) {

            closeOnRead(pipeline);

        }

    } catch (Throwable t) {

        handleReadException(pipeline, byteBuf, t, close, allocHandle);

    } finally {

        if (!readPending &amp;&amp; !config.isAutoRead()) {

            removeReadOp();

        }

    }

}
</code></pre><p>Netty ä¼šä¸æ–­ä» Channel ä¸­è¯»å–æ•°æ®åˆ°åˆ†é…çš„ ByteBuf ä¸­ï¼Œç„¶åé€šè¿‡ pipeline.fireChannelRead() æ–¹æ³•è§¦å‘ ChannelRead äº‹ä»¶çš„ä¼ æ’­ï¼ŒfireChannelRead() æ˜¯æˆ‘ä»¬éœ€è¦é‡ç‚¹åˆ†æçš„å¯¹è±¡ã€‚</p>
<pre tabindex="0"><code>// DefaultChannelPipeline

public final ChannelPipeline fireChannelRead(Object msg) {

    AbstractChannelHandlerContext.invokeChannelRead(head, msg);

    return this;

}

// AbstractChannelHandlerContext

static void invokeChannelRead(final AbstractChannelHandlerContext next, Object msg) {

    final Object m = next.pipeline.touch(ObjectUtil.checkNotNull(msg, &quot;msg&quot;), next);

    EventExecutor executor = next.executor();

    if (executor.inEventLoop()) { // å½“å‰åœ¨ Reactor çº¿ç¨‹å†…éƒ¨ï¼Œç›´æ¥æ‰§è¡Œ

        next.invokeChannelRead(m);

    } else {

        executor.execute(new Runnable() { // å¦‚æœæ˜¯å¤–éƒ¨çº¿ç¨‹ï¼Œåˆ™æäº¤ç»™å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—

            @Override

            public void run() {

                next.invokeChannelRead(m);

            }

        });

    }

}
</code></pre><p>Netty é¦–å…ˆä¼šä»¥ Head èŠ‚ç‚¹ä¸ºå…¥å‚ï¼Œç›´æ¥è°ƒç”¨ä¸€ä¸ªé™æ€æ–¹æ³• invokeChannelRead()ã€‚å¦‚æœå½“å‰æ˜¯åœ¨ Reactor çº¿ç¨‹å†…éƒ¨ï¼Œä¼šç›´æ¥æ‰§è¡Œ next.invokeChannelRead() æ–¹æ³•ã€‚å¦‚æœæ˜¯å¤–éƒ¨çº¿ç¨‹å‘èµ·çš„è°ƒç”¨ï¼ŒNetty ä¼šæŠŠ next.invokeChannelRead() è°ƒç”¨å°è£…æˆå¼‚æ­¥ä»»åŠ¡æäº¤åˆ°ä»»åŠ¡é˜Ÿåˆ—ã€‚é€šè¿‡ä¹‹å‰å¯¹ NioEventLoop æºç çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“è¿™æ ·å¯ä»¥ä¿è¯æ‰§è¡Œæµç¨‹å…¨éƒ¨æ§åˆ¶åœ¨å½“å‰ NioEventLoop çº¿ç¨‹å†…éƒ¨ä¸²è¡ŒåŒ–æ‰§è¡Œï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨æ€§ã€‚æˆ‘ä»¬æŠ“ä½æ ¸å¿ƒé€»è¾‘ next.invokeChannelRead() ç»§ç»­è·Ÿè¿›ã€‚</p>
<pre tabindex="0"><code>// AbstractChannelHandlerContext

private void invokeChannelRead(Object msg) {

    if (invokeHandler()) {

        try {

            ((ChannelInboundHandler) handler()).channelRead(this, msg);

        } catch (Throwable t) {

            notifyHandlerException(t);

        }

    } else {

        fireChannelRead(msg);

    }

}
</code></pre><p>å¯ä»¥çœ‹å‡ºï¼Œå½“å‰ ChannelHandlerContext èŠ‚ç‚¹ä¼šå–å‡ºè‡ªèº«å¯¹åº”çš„ Handlerï¼Œæ‰§è¡Œ Handler çš„ channelRead æ–¹æ³•ã€‚æ­¤æ—¶å½“å‰èŠ‚ç‚¹æ˜¯ HeadContextï¼Œæ‰€ä»¥ Inbound äº‹ä»¶æ˜¯ä» HeadContext èŠ‚ç‚¹å¼€å§‹è¿›è¡Œä¼ æ’­çš„ï¼Œçœ‹ä¸‹ HeadContext.channelRead() æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<pre tabindex="0"><code>// HeadContext

public void channelRead(ChannelHandlerContext ctx, Object msg) {

    ctx.fireChannelRead(msg);

}

// AbstractChannelHandlerContext

public ChannelHandlerContext fireChannelRead(final Object msg) {

    // æ‰¾åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ‰§è¡Œ invokeChannelRead

    invokeChannelRead(findContextInbound(MASK_CHANNEL_READ), msg);

    return this;

}
</code></pre><p>æˆ‘ä»¬å‘ç° HeadContext.channelRead() å¹¶æ²¡æœ‰åšä»€ä¹ˆç‰¹æ®Šæ“ä½œï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡ fireChannelRead() æ–¹æ³•ç»§ç»­å°†è¯»äº‹ä»¶ç»§ç»­ä¼ æ’­ä¸‹å»ã€‚æ¥ä¸‹æ¥ Netty ä¼šé€šè¿‡ findContextInbound(MASK_CHANNEL_READ), msg) æ‰¾åˆ° HeadContext çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç„¶åç»§ç»­æ‰§è¡Œæˆ‘ä»¬ä¹‹å‰ä»‹ç»çš„é™æ€æ–¹æ³• invokeChannelRead()ï¼Œä»è€Œè¿›å…¥ä¸€ä¸ªé€’å½’è°ƒç”¨çš„è¿‡ç¨‹ï¼Œç›´è‡³æŸä¸ªæ¡ä»¶ç»“æŸã€‚ä»¥ä¸Š channelRead çš„æ‰§è¡Œè¿‡ç¨‹æˆ‘ä»¬å¯ä»¥æ¢³ç†æˆä¸€å¹…æµç¨‹å›¾ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F_Zyz-AR9gUAAYhisGwxMo407.png" alt="Drawing 6.png"></p>
<p>Netty æ˜¯å¦‚ä½•åˆ¤æ–­ InboundHandler æ˜¯å¦å…³å¿ƒ channelRead äº‹ä»¶å‘¢ï¼Ÿè¿™å°±æ¶‰åŠfindContextInbound(MASK_CHANNEL_READ), msg) ä¸­çš„ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œå’Œä¸Šæ–‡ä¸­æˆ‘ä»¬ä»‹ç»çš„ executionMask æ©ç è¿ç®—æ˜¯æ¯æ¯ç›¸å…³çš„ã€‚é¦–å…ˆçœ‹ä¸‹ findContextInbound() çš„æºç ï¼š</p>
<pre tabindex="0"><code>private AbstractChannelHandlerContext findContextInbound(int mask) {

    AbstractChannelHandlerContext ctx = this;

    do {

        ctx = ctx.next;

    } while ((ctx.executionMask &amp; mask) == 0);

    return ctx;

}
</code></pre><p>MASK_CHANNEL_READ çš„å€¼ä¸º 1 &laquo; 5ï¼Œè¡¨ç¤º channelRead äº‹ä»¶æ‰€åœ¨çš„äºŒè¿›åˆ¶ä½å·²è¢«ç½®ä¸º 1ã€‚åœ¨ä»£ç ç¤ºä¾‹ä¸­ï¼ŒSampleInboundA æ˜¯æˆ‘ä»¬æ·»åŠ çš„ Inbound ç±»å‹çš„è‡ªå®šä¹‰å¤„ç†å™¨ï¼Œå®ƒæ‰€å¯¹åº”çš„ executionMask æ©ç å’Œ MASK_CHANNEL_READ è¿›è¡Œä¸è¿ç®—çš„ç»“æœå¦‚æœä¸ä¸º 0ï¼Œè¡¨ç¤º SampleInboundA å¯¹ channelRead äº‹ä»¶æ„Ÿå…´è¶£ï¼Œéœ€è¦è§¦å‘æ‰§è¡Œ SampleInboundA çš„ channelRead() æ–¹æ³•ã€‚</p>
<p>Inbound äº‹ä»¶åœ¨ä¸Šè¿°é€’å½’è°ƒç”¨çš„æµç¨‹ä¸­ä»€ä¹ˆæ—¶å€™èƒ½å¤Ÿç»“æŸå‘¢ï¼Ÿæœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š</p>
<ol>
<li>ç”¨æˆ·è‡ªå®šä¹‰çš„ Handler æ²¡æœ‰æ‰§è¡Œ fireChannelRead() æ“ä½œï¼Œåˆ™åœ¨å½“å‰ Handler ç»ˆæ­¢ Inbound äº‹ä»¶ä¼ æ’­ã€‚</li>
<li>å¦‚æœç”¨æˆ·è‡ªå®šä¹‰çš„ Handler éƒ½æ‰§è¡Œäº† fireChannelRead() æ“ä½œï¼ŒInbound äº‹ä»¶ä¼ æ’­æœ€ç»ˆä¼šåœ¨ TailContext èŠ‚ç‚¹ç»ˆæ­¢ã€‚</li>
</ol>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç€é‡çœ‹ä¸‹ TailContext èŠ‚ç‚¹åšäº†å“ªäº›å·¥ä½œã€‚</p>
<pre tabindex="0"><code>public void channelRead(ChannelHandlerContext ctx, Object msg) {

    onUnhandledInboundMessage(ctx, msg);

}

protected void onUnhandledInboundMessage(Object msg) {

    try {

        logger.debug(

                &quot;Discarded inbound message {} that reached at the tail of the pipeline. &quot; +

                        &quot;Please check your pipeline configuration.&quot;, msg);

    } finally {

        ReferenceCountUtil.release(msg);

    }

}
</code></pre><p>å¯ä»¥çœ‹å‡º TailContext åªæ˜¯æ—¥å¿—è®°å½•äº†ä¸¢å¼ƒçš„ Inbound æ¶ˆæ¯ï¼Œå¹¶é‡Šæ”¾ ByteBuf åšä¸€ä¸ªå…œåº•ä¿æŠ¤ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚</p>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼ŒInbound äº‹ä»¶çš„ä¼ æ’­æµç¨‹å·²ç»ä»‹ç»å®Œäº†ï¼ŒInbound äº‹ä»¶åœ¨ ChannelPipeline ä¸­çš„ä¼ æ’­æ–¹å‘æ˜¯ Head -&gt; Tailã€‚Netty ä¼šä» ChannelPipeline ä¸­æ‰¾åˆ°å¯¹ä¼ æ’­äº‹ä»¶æ„Ÿå…´è¶£çš„ Inbound å¤„ç†å™¨ï¼Œæ‰§è¡Œäº‹ä»¶å›è°ƒæ–¹æ³•ï¼Œç„¶åç»§ç»­å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¼ æ’­ï¼Œæ•´ä¸ªäº‹ä»¶ä¼ æ’­æµç¨‹æ˜¯ä¸€ä¸ªé€’å½’è°ƒç”¨çš„è¿‡ç¨‹ã€‚</p>
<h4 id="outbound-äº‹ä»¶ä¼ æ’­">Outbound äº‹ä»¶ä¼ æ’­</h4>
<p>åˆ†æå®Œ Inbound äº‹ä»¶çš„ä¼ æ’­æµç¨‹ä¹‹åï¼Œå†å­¦ä¹  Outbound äº‹ä»¶ä¼ æ’­å°±ä¼šç®€å•å¾ˆå¤šã€‚Outbound äº‹ä»¶ä¼ æ’­çš„æ–¹å‘æ˜¯ä» Tail -&gt; Headï¼Œä¸ Inbound äº‹ä»¶çš„ä¼ æ’­æ–¹å‘æ°æ°æ˜¯ç›¸åçš„ã€‚Outbound äº‹ä»¶æœ€å¸¸è§çš„å°±æ˜¯å†™äº‹ä»¶ï¼Œæ‰§è¡Œ writeAndFlush() æ–¹æ³•æ—¶å°±ä¼šè§¦å‘ Outbound äº‹ä»¶ä¼ æ’­ã€‚æˆ‘ä»¬ç›´æ¥ä» TailContext è·Ÿè¿› writeAndFlush() æºç ï¼š</p>
<pre tabindex="0"><code>@Override

public final ChannelFuture writeAndFlush(Object msg) {

    return tail.writeAndFlush(msg);

}
</code></pre><p>ç»§ç»­è·Ÿè¿› tail.writeAndFlush() çš„æºç ï¼Œæœ€ç»ˆä¼šå®šä½åˆ° AbstractChannelHandlerContext ä¸­çš„ write æ–¹æ³•ã€‚è¯¥æ–¹æ³•æ˜¯ writeAndFlush çš„æ ¸å¿ƒé€»è¾‘ï¼Œå…·ä½“æºç å¦‚ä¸‹ã€‚</p>
<pre tabindex="0"><code>private void write(Object msg, boolean flush, ChannelPromise promise) {

    // ...... çœç•¥éƒ¨åˆ†éæ ¸å¿ƒä»£ç  ......
    // æ‰¾åˆ° Pipeline é“¾è¡¨ä¸­ä¸‹ä¸€ä¸ª Outbound ç±»å‹çš„ ChannelHandler èŠ‚ç‚¹

    final AbstractChannelHandlerContext next = findContextOutbound(flush ?

            (MASK_WRITE | MASK_FLUSH) : MASK_WRITE);

    final Object m = pipeline.touch(msg, next);

    EventExecutor executor = next.executor();

    // åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ NioEventLoop ä¸­çš„çº¿ç¨‹

    if (executor.inEventLoop()) {

        if (flush) {

            // å› ä¸º flush == trueï¼Œæ‰€ä»¥æµç¨‹èµ°åˆ°è¿™é‡Œ

            next.invokeWriteAndFlush(m, promise);

        } else {

            next.invokeWrite(m, promise);

        }

    } else {

        final AbstractWriteTask task;

        if (flush) {

            task = WriteAndFlushTask.newInstance(next, m, promise);

        }  else {

            task = WriteTask.newInstance(next, m, promise);

        }

        if (!safeExecute(executor, task, promise, m)) {

            task.cancel();

        }

    }

}
</code></pre><p>åœ¨ã€Šæ•°æ®ä¼ è¾“ï¼šwriteAndFlush å¤„ç†æµç¨‹å‰–æã€‹çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»å¯¹ write() æ–¹æ³•åšäº†æ·±å…¥åˆ†æï¼Œè¿™é‡ŒæŠ›å¼€å…¶ä»–æŠ€æœ¯ç»†èŠ‚ï¼Œæˆ‘ä»¬åªåˆ†æ Outbound äº‹ä»¶ä¼ æ’­çš„è¿‡ç¨‹ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬åœ¨ä»£ç ç¤ºä¾‹ä¸­ SampleOutboundB è°ƒç”¨äº† writeAndFlush() æ–¹æ³•ï¼Œé‚£ä¹ˆ Netty ä¼šè°ƒç”¨ findContextOutbound() æ–¹æ³•æ‰¾åˆ° Pipeline é“¾è¡¨ä¸­ä¸‹ä¸€ä¸ª Outbound ç±»å‹çš„ ChannelHandlerï¼Œå¯¹åº”ä¸Šè¿°ä»£ç ç¤ºä¾‹ä¸­ä¸‹ä¸€ä¸ª Outbound èŠ‚ç‚¹æ˜¯ SampleOutboundAï¼Œç„¶åè°ƒç”¨ next.invokeWriteAndFlush(m, promise)ï¼Œæˆ‘ä»¬è·Ÿè¿›å»ï¼š</p>
<pre tabindex="0"><code>private void invokeWriteAndFlush(Object msg, ChannelPromise promise) {

    if (invokeHandler()) {

        invokeWrite0(msg, promise);

        invokeFlush0();

    } else {

        writeAndFlush(msg, promise);

    }

}

private void invokeWrite0(Object msg, ChannelPromise promise) {

    try {

        ((ChannelOutboundHandler) handler()).write(this, msg, promise);

    } catch (Throwable t) {

        notifyOutboundHandlerException(t, promise);

    }

}
</code></pre><p>æˆ‘ä»¬å‘ç°ï¼ŒinvokeWriteAndFlush() æ–¹æ³•æœ€ç»ˆä¼šå®ƒä¼šæ‰§è¡Œä¸‹ä¸€ä¸ª ChannelHandler èŠ‚ç‚¹çš„ write æ–¹æ³•ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç”¨æˆ·åœ¨å®ç° outBound ç±»å‹çš„ ChannelHandler æ—¶éƒ½ä¼šç»§æ‰¿ ChannelOutboundHandlerAdapterï¼Œä¸€èµ·çœ‹ä¸‹å®ƒçš„ write() æ–¹æ³•æ˜¯å¦‚ä½•å¤„ç† outBound äº‹ä»¶çš„ã€‚</p>
<pre tabindex="0"><code>public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception {

    ctx.write(msg, promise);

}
</code></pre><p>ChannelOutboundHandlerAdapter.write() åªæ˜¯è°ƒç”¨äº† AbstractChannelHandlerContext çš„ write() æ–¹æ³•ï¼Œæ˜¯ä¸æ˜¯ä¼¼æ›¾ç›¸è¯†ï¼Ÿä¸ä¹‹å‰ä»‹ç»çš„ Inbound äº‹ä»¶å¤„ç†æµç¨‹ç±»ä¼¼ï¼Œæ­¤æ—¶æµç¨‹åˆå›åˆ°äº† AbstractChannelHandlerContext ä¸­é‡å¤æ‰§è¡Œ write æ–¹æ³•ï¼Œç»§ç»­å¯»æ‰¾ä¸‹ä¸€ä¸ª Outbound èŠ‚ç‚¹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªé€’å½’è°ƒç”¨çš„è¿‡ç¨‹ã€‚</p>
<p>ç¼–ç å™¨æ˜¯ç”¨æˆ·ç»å¸¸éœ€è¦è‡ªå®šä¹‰å®ç°çš„å¤„ç†å™¨ï¼Œç„¶è€Œä¸ºä»€ä¹ˆç”¨æˆ·çš„ç¼–ç å™¨é‡Œå¹¶æ²¡æœ‰é‡å†™ write()ï¼Œåªæ˜¯é‡å†™ä¸€ä¸ª encode() æ–¹æ³•å‘¢ï¼Ÿåœ¨ã€ŠNetty å¦‚ä½•å®ç°è‡ªå®šä¹‰é€šä¿¡åè®®ã€‹è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ‰€ä»‹ç»çš„ MessageToByteEncoder æºç ï¼Œç”¨æˆ·è‡ªå®šä¹‰çš„ç¼–ç å™¨åŸºæœ¬éƒ½ä¼šç»§æ‰¿ MessageToByteEncoderï¼ŒMessageToByteEncoder é‡å†™äº† ChanneOutboundHandler çš„ write() æ–¹æ³•ï¼Œå…¶ä¸­ä¼šè°ƒç”¨å­ç±»å®ç°çš„ encode æ–¹æ³•å®Œæˆæ•°æ®ç¼–ç ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸å†èµ˜è¿°äº†ã€‚</p>
<p>é‚£ä¹ˆ OutBound äº‹ä»¶ä»€ä¹ˆæ—¶å€™ä¼ æ’­ç»“æŸå‘¢ï¼Ÿä¹Ÿè®¸ä½ å·²ç»çŒœåˆ°äº†ï¼ŒOutBound äº‹ä»¶æœ€ç»ˆä¼šä¼ æ’­åˆ° HeadContext èŠ‚ç‚¹ã€‚æ‰€ä»¥ HeadContext èŠ‚ç‚¹æ—¢æ˜¯ Inbound å¤„ç†å™¨ï¼Œåˆæ˜¯ OutBound å¤„ç†å™¨ï¼Œç»§ç»­çœ‹ä¸‹ HeadContext æ˜¯å¦‚ä½•æ‹¦æˆªå’Œå¤„ç† write äº‹ä»¶çš„ã€‚</p>
<pre tabindex="0"><code>public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) {

    unsafe.write(msg, promise);

}
</code></pre><p>HeadContext æœ€ç»ˆè°ƒç”¨äº†åº•å±‚çš„ unsafe å†™å…¥æ•°æ®ï¼Œæ•°æ®åœ¨æ‰§è¡Œ write() æ–¹æ³•æ—¶ï¼Œåªä¼šå†™å…¥åˆ°ä¸€ä¸ªåº•å±‚çš„ç¼“å†²æ•°æ®ç»“æ„ï¼Œç„¶åç­‰å¾… flush æ“ä½œå°†æ•°æ®å†²åˆ·åˆ° Channel ä¸­ã€‚å…³äº write å’Œ flush æ˜¯å¦‚ä½•æ“ä½œç¼“å­˜æ•°æ®ç»“æ„çš„ï¼Œå¿«å»å¤ä¹ ä¸€éã€Šæ•°æ®ä¼ è¾“ï¼šwriteAndFlush å¤„ç†æµç¨‹å‰–æã€‹å§ï¼Œå°†çŸ¥è¯†ç‚¹å½¢æˆä¸€ä¸ªå®Œæ•´çš„ä½“ç³»ã€‚</p>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œoutbound äº‹ä»¶ä¼ æ’­ä¹Ÿä»‹ç»å®Œäº†ï¼Œå®ƒçš„ä¼ æ’­æ–¹å‘æ˜¯ Tail -&gt; Headï¼Œä¸ Inbound äº‹ä»¶çš„ä¼ æ’­æ˜¯ç›¸åçš„ã€‚MessageToByteEncoder æ˜¯ç”¨æˆ·åœ¨å®ç°ç¼–ç æ—¶ç»å¸¸ç”¨åˆ°çš„ä¸€ä¸ªæŠ½è±¡ç±»ï¼ŒMessageToByteEncoder ä¸­å·²ç»é‡å†™äº† ChanneOutboundHandler çš„ write() æ–¹æ³•ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ç”¨æˆ·åªéœ€è¦é‡å†™ encode() å³å¯ã€‚</p>
<h4 id="å¼‚å¸¸äº‹ä»¶ä¼ æ’­">å¼‚å¸¸äº‹ä»¶ä¼ æ’­</h4>
<p>åœ¨ã€ŠæœåŠ¡ç¼–æ’å±‚ï¼šPipeline å¦‚ä½•åè°ƒå„ç±» Handlerã€‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»åˆæ­¥ä»‹ç»äº† Netty å®ç°ç»Ÿä¸€å¼‚å¸¸æ‹¦æˆªå’Œå¤„ç†çš„æœ€ä½³å®è·µï¼Œé¦–å…ˆå›é¡¾ä¸‹å¼‚å¸¸æ‹¦æˆªå™¨çš„ç®€å•å®ç°ã€‚</p>
<pre tabindex="0"><code>public class ExceptionHandler extends ChannelDuplexHandler {

    @Override

    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) {

        if (cause instanceof RuntimeException) {

            System.out.println(&quot;Handle Business Exception Success.&quot;);

        }

    }

}
</code></pre><p>å¼‚å¸¸å¤„ç†å™¨ ExceptionHandler ä¸€èˆ¬ä¼šç»§æ‰¿ ChannelDuplexHandlerï¼ŒChannelDuplexHandler æ—¢æ˜¯ä¸€ä¸ª Inbound å¤„ç†å™¨ï¼Œåˆæ˜¯ä¸€ä¸ª Outbound å¤„ç†å™¨ã€‚ExceptionHandler åº”è¯¥è¢«æ·»åŠ åœ¨è‡ªå®šä¹‰å¤„ç†å™¨çš„å°¾éƒ¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/CgpVE1_fiTOATVOAAAJopxQR7mU966.png" alt="å›¾ç‰‡8.png"></p>
<p>é‚£ä¹ˆå¼‚å¸¸å¤„ç†å™¨ ExceptionHandler ä»€ä¹ˆæ—¶å€™è¢«æ‰§è¡Œå‘¢ï¼Ÿæˆ‘ä»¬åˆ†åˆ«ä» Inbound å¼‚å¸¸äº‹ä»¶ä¼ æ’­å’Œ Outbound å¼‚å¸¸äº‹ä»¶ä¼ æ’­ä¸¤ç§åœºæ™¯è¿›è¡Œåˆ†æã€‚</p>
<p>é¦–å…ˆçœ‹ä¸‹ Inbound å¼‚å¸¸äº‹ä»¶çš„ä¼ æ’­ã€‚è¿˜æ˜¯ä»æ•°æ®è¯»å–çš„åœºæ™¯å…¥æ‰‹ï¼Œå‘ç° Inbound äº‹ä»¶ä¼ æ’­çš„æ—¶å€™æœ‰å¼‚å¸¸å¤„ç†çš„ç›¸å…³é€»è¾‘ï¼Œæˆ‘ä»¬å†ä¸€èµ·é‡æ–°åˆ†æä¸‹æ•°æ®è¯»å–ç¯èŠ‚çš„æºç ã€‚</p>
<pre tabindex="0"><code>// AbstractChannelHandlerContext

private void invokeChannelRead(Object msg) {

    if (invokeHandler()) {

        try {

            ((ChannelInboundHandler) handler()).channelRead(this, msg);

        } catch (Throwable t) {

            notifyHandlerException(t);

        }

    } else {

        fireChannelRead(msg);

    }

}

// AbstractChannelHandlerContext

private void notifyHandlerException(Throwable cause) {

    // çœç•¥å…¶ä»–ä»£ç 

    invokeExceptionCaught(cause);

}

// AbstractChannelHandlerContext

private void invokeExceptionCaught(final Throwable cause) {

    if (invokeHandler()) {

        try {

            handler().exceptionCaught(this, cause); // è°ƒç”¨ Handler å®ç°çš„ exceptionCaught æ–¹æ³•

        } catch (Throwable error) {

            // çœç•¥å…¶ä»–ä»£ç 

        }

    } else {

        fireExceptionCaught(cause);

    }

}
</code></pre><p>å¦‚æœ SampleInboundA åœ¨è¯»å–æ•°æ®æ—¶å‘ç”Ÿäº†å¼‚å¸¸ï¼ŒinvokeChannelRead ä¼šæ•è·å¼‚å¸¸ï¼Œå¹¶æ‰§è¡Œ notifyHandlerException() æ–¹æ³•è¿›è¡Œå¼‚å¸¸å¤„ç†ã€‚æˆ‘ä»¬ä¸€æ­¥æ­¥è·Ÿè¿›ï¼Œå‘ç°æœ€ç»ˆä¼šè°ƒç”¨ Handler çš„ exceptionCaught() æ–¹æ³•ï¼Œæ‰€ä»¥ç”¨æˆ·å¯ä»¥é€šè¿‡é‡å†™ exceptionCaught() å®ç°è‡ªå®šä¹‰çš„å¼‚å¸¸å¤„ç†ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œç»Ÿä¸€å¼‚å¸¸å¤„ç†å™¨ ExceptionHandler æ˜¯åœ¨ ChannelPipeline çš„æœ«ç«¯ï¼ŒSampleInboundA å¹¶æ²¡æœ‰é‡å†™ exceptionCaught() æ–¹æ³•ï¼Œé‚£ä¹ˆ SampleInboundA äº§ç”Ÿçš„å¼‚å¸¸æ˜¯å¦‚ä½•ä¼ æ’­åˆ° ExceptionHandler ä¸­å‘¢ï¼Ÿç”¨æˆ·å®ç°çš„ Inbound å¤„ç†å™¨ä¸€èˆ¬éƒ½ä¼šç»§æ‰¿ ChannelInboundHandlerAdapter æŠ½è±¡ç±»ï¼Œæœç„¶æˆ‘ä»¬åœ¨ ChannelInboundHandlerAdapter ä¸­å‘ç°äº† exceptionCaught() çš„å®ç°ï¼š</p>
<pre tabindex="0"><code>// ChannelInboundHandlerAdapter

public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause)

        throws Exception {

    ctx.fireExceptionCaught(cause);

}

// AbstractChannelHandlerContext

public ChannelHandlerContext fireExceptionCaught(final Throwable cause) {

    invokeExceptionCaught(findContextInbound(MASK_EXCEPTION_CAUGHT), cause);

    return this;

}
</code></pre><p>ChannelInboundHandlerAdapter é»˜è®¤è°ƒç”¨ fireExceptionCaught() æ–¹æ³•ä¼ æ’­å¼‚å¸¸äº‹ä»¶ï¼Œè€Œ fireExceptionCaught() æ‰§è¡Œæ—¶ä¼šå…ˆè°ƒç”¨ findContextInbound() æ–¹æ³•æ‰¾åˆ°ä¸‹ä¸€ä¸ªå¯¹å¼‚å¸¸äº‹ä»¶å…³æ³¨çš„ Inbound å¤„ç†å™¨ï¼Œç„¶åç»§ç»­å‘ä¸‹ä¼ æ’­å¼‚å¸¸ã€‚æ‰€ä»¥è¿™é‡Œåº”è¯¥æ˜ç™½ä¸ºä»€ä¹ˆç»Ÿä¸€å¼‚å¸¸å¤„ç†å™¨ ExceptionHandler ä¸ºä»€ä¹ˆéœ€è¦æ·»åŠ åœ¨ ChannelPipeline çš„æœ«ç«¯äº†å§ï¼Ÿè¿™æ · ExceptionHandler å¯ä»¥æ¥æ”¶æ‰€æœ‰ Inbound å¤„ç†å™¨å‘ç”Ÿçš„å¼‚å¸¸ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ†æ Outbound å¼‚å¸¸äº‹ä»¶ä¼ æ’­ã€‚ä½ å¯èƒ½æ­¤æ—¶å°±ä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼ŒOutbound äº‹ä»¶çš„ä¼ æ’­æ–¹å‘ä¸ Inbound äº‹ä»¶æ˜¯ç›¸åçš„ï¼Œä¸ºä»€ä¹ˆç»Ÿä¸€å¼‚å¸¸å¤„ç†å™¨ ExceptionHandler æ²¡æœ‰æ·»åŠ åœ¨ ChannelPipeline çš„å¤´éƒ¨å‘¢ï¼Ÿæˆ‘ä»¬é€šè¿‡ writeAndFlush() çš„è°ƒç”¨è¿‡ç¨‹å†æ¥ä¸€æ¢ç©¶ç«Ÿã€‚</p>
<pre tabindex="0"><code>// AbstractChannelHandlerContext

private void invokeFlush0() {

    try {

        ((ChannelOutboundHandler) handler()).flush(this);

    } catch (Throwable t) {

        notifyHandlerException(t);

    }

}
</code></pre><p>æˆ‘ä»¬å‘ç°ï¼Œflush å‘é€æ•°æ®æ—¶å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¹ˆå¼‚å¸¸ä¹Ÿä¼šè¢«æ•è·å¹¶äº¤ç”±åŒæ ·çš„ notifyHandlerException() æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚å› ä¸º notifyHandlerException() æ–¹æ³•ä¸­ä¼šå‘ä¸‹å¯»æ‰¾ Inbound å¤„ç†å™¨ï¼Œæ­¤æ—¶åˆä¼šå›åˆ° Inbound å¼‚å¸¸äº‹ä»¶çš„ä¼ æ’­æµç¨‹ã€‚æ‰€ä»¥è¯´ï¼Œå¼‚å¸¸äº‹ä»¶çš„ä¼ æ’­æ–¹å‘ä¸ Inbound äº‹ä»¶å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œæœ€åä¸€å®šä¼šä¼ æ’­åˆ°ç»Ÿä¸€å¼‚å¸¸å¤„ç†å™¨ ExceptionHandlerã€‚</p>
<p>åˆ°è¿™é‡Œï¼Œæ•´ä¸ªå¼‚å¸¸äº‹ä»¶çš„ä¼ æ’­è¿‡ç¨‹å·²ç»åˆ†æå®Œäº†ã€‚ä½ éœ€è¦è®°ä½çš„æ˜¯ï¼Œå¼‚å¸¸äº‹ä»¶çš„ä¼ æ’­é¡ºåºä¸ ChannelHandler çš„æ·»åŠ é¡ºåºç›¸åŒï¼Œä¼šä¾æ¬¡å‘åä¼ æ’­ï¼Œä¸ Inbound äº‹ä»¶å’Œ Outbound äº‹ä»¶æ— å…³ã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>è¿™èŠ‚ç‚¹æˆ‘ä»¬å­¦ä¹ äº†æ•°æ®åœ¨ Netty ä¸­çš„å®Œæ•´å¤„ç†æµç¨‹ï¼Œå…¶ä¸­é‡ç‚¹åˆ†æäº†æ•°æ®æ˜¯å¦‚ä½•åœ¨ ChannelPipeline ä¸­æµè½¬çš„ã€‚æˆ‘ä»¬åšä¸€ä¸ªçŸ¥è¯†ç‚¹æ€»ç»“ï¼š</p>
<ul>
<li>ChannelPipeline æ˜¯åŒå‘é“¾è¡¨ç»“æ„ï¼ŒåŒ…å« ChannelInboundHandler å’Œ ChannelOutboundHandler ä¸¤ç§å¤„ç†å™¨ã€‚</li>
<li>Inbound äº‹ä»¶å’Œ Outbound äº‹ä»¶çš„ä¼ æ’­æ–¹å‘ç›¸åï¼ŒInbound äº‹ä»¶çš„ä¼ æ’­æ–¹å‘ä¸º Head -&gt; Tailï¼Œè€Œ Outbound äº‹ä»¶ä¼ æ’­æ–¹å‘æ˜¯ Tail -&gt; Headã€‚</li>
<li>å¼‚å¸¸äº‹ä»¶çš„å¤„ç†é¡ºåºä¸ ChannelHandler çš„æ·»åŠ é¡ºåºç›¸åŒï¼Œä¼šä¾æ¬¡å‘åä¼ æ’­ï¼Œä¸ Inbound äº‹ä»¶å’Œ Outbound äº‹ä»¶æ— å…³ã€‚</li>
</ul>
<p>å†æ•´ä½“å›é¡¾ä¸‹ ChannelPipeline ä¸­äº‹ä»¶ä¼ æ’­çš„å®ç°åŸç†ï¼š</p>
<ul>
<li>Inbound äº‹ä»¶ä¼ æ’­ä» HeadContext èŠ‚ç‚¹å¼€å§‹ï¼ŒOutbound äº‹ä»¶ä¼ æ’­ä» TailContext èŠ‚ç‚¹å¼€å§‹ã€‚</li>
<li>AbstractChannelHandlerContext æŠ½è±¡ç±»ä¸­å®ç°äº†ä¸€ç³»åˆ— fire å’Œ invoke æ–¹æ³•ï¼Œå¦‚æœæƒ³è®©äº‹ä»¶æƒ³ä¸‹ä¼ æ’­ï¼Œåªéœ€è¦è°ƒç”¨ fire ç³»åˆ—çš„æ–¹æ³•å³å¯ã€‚fire å’Œ invoke çš„ç³»åˆ—æ–¹æ³•ç»“åˆ findContextInbound() å’Œ findContextOutbound() å¯ä»¥æ§åˆ¶ Inbound å’Œ Outbound äº‹ä»¶çš„ä¼ æ’­æ–¹å‘ï¼Œæ•´ä¸ªè¿‡ç¨‹æ˜¯ä¸€ä¸ªé€’å½’è°ƒç”¨ã€‚</li>
</ul>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/18-%E6%BA%90%E7%A0%81%E7%AF%87%E8%A7%A3%E5%AF%86-netty-reactor-%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/"><span>18 æºç ç¯‡ï¼šè§£å¯† Netty Reactor çº¿ç¨‹æ¨¡å‹</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/20-%E6%8A%80%E5%B7%A7%E7%AF%87netty-%E7%9A%84-fastthreadlocal-%E7%A9%B6%E7%AB%9F%E6%AF%94-threadlocal-%E5%BF%AB%E5%9C%A8%E5%93%AA%E5%84%BF/"><span>20 æŠ€å·§ç¯‡ï¼šNetty çš„ FastThreadLocal ç©¶ç«Ÿæ¯” ThreadLocal å¿«åœ¨å“ªå„¿ï¼Ÿ</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 27270 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>