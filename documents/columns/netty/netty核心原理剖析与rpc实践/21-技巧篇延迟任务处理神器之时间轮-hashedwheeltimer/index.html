<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>21 æŠ€å·§ç¯‡ï¼šå»¶è¿Ÿä»»åŠ¡å¤„ç†ç¥å™¨ä¹‹æ—¶é—´è½® HashedWheelTimer | Yipsen Ye</title>
<meta name="description" content="Netty ä¸­æœ‰å¾ˆå¤šåœºæ™¯ä¾èµ–å®šæ—¶ä»»åŠ¡å®ç°ï¼Œæ¯”è¾ƒå…¸å‹çš„æœ‰å®¢æˆ·ç«¯è¿æ¥çš„è¶…æ—¶æ§åˆ¶ã€é€šä¿¡åŒæ–¹è¿æ¥çš„å¿ƒè·³æ£€æµ‹ç­‰åœºæ™¯ã€‚åœ¨å­¦ä¹  Netty Reactor çº¿ç¨‹æ¨¡å‹æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“ NioEventLoop ä¸ä»…è´Ÿè´£å¤„ç† I/O äº‹ä»¶ï¼Œè€Œä¸”å…¼é¡¾æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œå…¶ä¸­å°±åŒ…æ‹¬å®šæ—¶ä»»åŠ¡ã€‚ä¸ºäº†å®ç°é«˜æ€§èƒ½çš„å®šæ—¶ä»»åŠ¡è°ƒåº¦ï¼ŒNetty å¼•å…¥äº†æ—¶é—´è½®ç®—æ³•é©±åŠ¨å®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œã€‚æ—¶é—´è½®åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸ºä»€ä¹ˆ Netty ä¸€å®šè¦ç”¨æ—¶é—´è½®æ¥å¤„ç†å®šæ—¶ä»»åŠ¡å‘¢ï¼ŸJDK åŸç”Ÿçš„å®ç°æ–¹æ¡ˆä¸èƒ½æ»¡è¶³è¦æ±‚å—ï¼Ÿæœ¬èŠ‚è¯¾æˆ‘å°†ä¸€æ­¥æ­¥ä¸ºä½ æ·±å…¥å‰–ææ—¶é—´è½®çš„åŸç†ä»¥åŠ Netty ä¸­æ˜¯å¦‚ä½•å®ç°æ—¶é—´è½®ç®—æ³•çš„ã€‚
 è¯´æ˜ï¼šæœ¬æ–‡å‚è€ƒçš„ Netty æºç ç‰ˆæœ¬ä¸º 4.1.42.Finalã€‚
 å®šæ—¶ä»»åŠ¡çš„åŸºç¡€çŸ¥è¯† é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸‹ä»€ä¹ˆæ˜¯å®šæ—¶ä»»åŠ¡ï¼Ÿå®šæ—¶å™¨æœ‰éå¸¸å¤šçš„ä½¿ç”¨åœºæ™¯ï¼Œå¤§å®¶åœ¨å¹³æ—¶å·¥ä½œä¸­åº”è¯¥ç»å¸¸é‡åˆ°ï¼Œä¾‹å¦‚ç”Ÿæˆæœˆç»Ÿè®¡æŠ¥è¡¨ã€è´¢åŠ¡å¯¹è´¦ã€ä¼šå‘˜ç§¯åˆ†ç»“ç®—ã€é‚®ä»¶æ¨é€ç­‰ï¼Œéƒ½æ˜¯å®šæ—¶å™¨çš„ä½¿ç”¨åœºæ™¯ã€‚å®šæ—¶å™¨ä¸€èˆ¬æœ‰ä¸‰ç§è¡¨ç°å½¢å¼ï¼šæŒ‰å›ºå®šå‘¨æœŸå®šæ—¶æ‰§è¡Œã€å»¶è¿Ÿä¸€å®šæ—¶é—´åæ‰§è¡Œã€æŒ‡å®šæŸä¸ªæ—¶åˆ»æ‰§è¡Œã€‚
å®šæ—¶å™¨çš„æœ¬è´¨æ˜¯è®¾è®¡ä¸€ç§æ•°æ®ç»“æ„ï¼Œèƒ½å¤Ÿå­˜å‚¨å’Œè°ƒåº¦ä»»åŠ¡é›†åˆï¼Œè€Œä¸” deadline è¶Šè¿‘çš„ä»»åŠ¡æ‹¥æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚é‚£ä¹ˆå®šæ—¶å™¨å¦‚ä½•çŸ¥é“ä¸€ä¸ªä»»åŠ¡æ˜¯å¦åˆ°æœŸäº†å‘¢ï¼Ÿå®šæ—¶å™¨éœ€è¦é€šè¿‡è½®è¯¢çš„æ–¹å¼æ¥å®ç°ï¼Œæ¯éš”ä¸€ä¸ªæ—¶é—´ç‰‡å»æ£€æŸ¥ä»»åŠ¡æ˜¯å¦åˆ°æœŸã€‚
æ‰€ä»¥å®šæ—¶å™¨çš„å†…éƒ¨ç»“æ„ä¸€èˆ¬éœ€è¦ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—å’Œä¸€ä¸ªå¼‚æ­¥è½®è¯¢çº¿ç¨‹ï¼Œå¹¶ä¸”èƒ½å¤Ÿæä¾›ä¸‰ç§åŸºæœ¬æ“ä½œï¼š
 Schedule æ–°å¢ä»»åŠ¡è‡³ä»»åŠ¡é›†åˆï¼› Cancel å–æ¶ˆæŸä¸ªä»»åŠ¡ï¼› Run æ‰§è¡Œåˆ°æœŸçš„ä»»åŠ¡ã€‚  JDK åŸç”Ÿæä¾›äº†ä¸‰ç§å¸¸ç”¨çš„å®šæ—¶å™¨å®ç°æ–¹å¼ï¼Œåˆ†åˆ«ä¸º Timerã€DelayedQueue å’Œ ScheduledThreadPoolExecutorã€‚ä¸‹é¢æˆ‘ä»¬é€ä¸€å¯¹å®ƒä»¬è¿›è¡Œä»‹ç»ã€‚
Timer Timer å±äº JDK æ¯”è¾ƒæ—©æœŸç‰ˆæœ¬çš„å®ç°ï¼Œå®ƒå¯ä»¥å®ç°å›ºå®šå‘¨æœŸçš„ä»»åŠ¡ï¼Œä»¥åŠå»¶è¿Ÿä»»åŠ¡ã€‚Timer ä¼šèµ·åŠ¨ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹å»æ‰§è¡Œåˆ°æœŸçš„ä»»åŠ¡ï¼Œä»»åŠ¡å¯ä»¥åªè¢«è°ƒåº¦æ‰§è¡Œä¸€æ¬¡ï¼Œä¹Ÿå¯ä»¥å‘¨æœŸæ€§åå¤æ‰§è¡Œå¤šæ¬¡ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ Timer æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚
Timer timer = new Timer();timer.scheduleAtFixedRate(new TimerTask() {@Overridepublic void run() {// do something}}, 10000, 1000); // 10s åè°ƒåº¦ä¸€ä¸ªå‘¨æœŸä¸º 1s çš„å®šæ—¶ä»»åŠ¡å¯ä»¥çœ‹å‡ºï¼Œä»»åŠ¡æ˜¯ç”± TimerTask ç±»å®ç°ï¼ŒTimerTask æ˜¯å®ç°äº† Runnable æ¥å£çš„æŠ½è±¡ç±»ï¼ŒTimer è´Ÿè´£è°ƒåº¦å’Œæ‰§è¡Œ TimerTaskã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹ Timer çš„å†…éƒ¨æ„é€ ã€‚">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/netty%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e5%89%96%e6%9e%90%e4%b8%8erpc%e5%ae%9e%e8%b7%b5/">Nettyæ ¸å¿ƒåŸç†å‰–æä¸RPCå®è·µ</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/00-%E5%AD%A6%E5%A5%BD-netty%E6%98%AF%E4%BD%A0%E4%BF%AE%E7%82%BC-java-%E5%86%85%E5%8A%9F%E7%9A%84%E5%BF%85%E7%BB%8F%E4%B9%8B%E8%B7%AF/">00 å­¦å¥½ Nettyï¼Œæ˜¯ä½ ä¿®ç‚¼ Java å†…åŠŸçš„å¿…ç»ä¹‹è·¯</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/01-%E5%88%9D%E8%AF%86-netty%E4%B8%BA%E4%BB%80%E4%B9%88-netty-%E8%BF%99%E4%B9%88%E6%B5%81%E8%A1%8C/">01 åˆè¯† Nettyï¼šä¸ºä»€ä¹ˆ Netty è¿™ä¹ˆæµè¡Œï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/02-%E7%BA%B5%E8%A7%88%E5%85%A8%E5%B1%80%E6%8A%8A%E6%8F%A1-netty-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E8%84%89%E7%BB%9C/">02 çºµè§ˆå…¨å±€ï¼šæŠŠæ¡ Netty æ•´ä½“æ¶æ„è„‰ç»œ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/03-%E5%BC%95%E5%AF%BC%E5%99%A8%E4%BD%9C%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E9%83%BD%E8%A6%81%E5%81%9A%E4%BA%9B%E4%BB%80%E4%B9%88/">03 å¼•å¯¼å™¨ä½œç”¨ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¯åŠ¨éƒ½è¦åšäº›ä»€ä¹ˆï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/04-%E4%BA%8B%E4%BB%B6%E8%B0%83%E5%BA%A6%E5%B1%82%E4%B8%BA%E4%BB%80%E4%B9%88-eventloop-%E6%98%AF-netty-%E7%9A%84%E7%B2%BE%E9%AB%93/">04 äº‹ä»¶è°ƒåº¦å±‚ï¼šä¸ºä»€ä¹ˆ EventLoop æ˜¯ Netty çš„ç²¾é«“ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/05-%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92%E5%B1%82pipeline-%E5%A6%82%E4%BD%95%E5%8D%8F%E8%B0%83%E5%90%84%E7%B1%BB-handler-/">05 æœåŠ¡ç¼–æ’å±‚ï¼šPipeline å¦‚ä½•åè°ƒå„ç±» Handler ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/06-%E7%B2%98%E5%8C%85%E6%8B%86%E5%8C%85%E9%97%AE%E9%A2%98%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%95%B4%E7%9A%84%E7%BD%91%E7%BB%9C%E5%8C%85/">06 ç²˜åŒ…æ‹†åŒ…é—®é¢˜ï¼šå¦‚ä½•è·å–ä¸€ä¸ªå®Œæ•´çš„ç½‘ç»œåŒ…ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/07-%E6%8E%A5%E5%A4%B4%E6%9A%97%E8%AF%AD%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8-netty-%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E9%80%9A%E4%BF%A1/">07 æ¥å¤´æš—è¯­ï¼šå¦‚ä½•åˆ©ç”¨ Netty å®ç°è‡ªå®šä¹‰åè®®é€šä¿¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/08-%E5%BC%80%E7%AE%B1%E5%8D%B3%E7%94%A8netty-%E6%94%AF%E6%8C%81%E5%93%AA%E4%BA%9B%E5%B8%B8%E7%94%A8%E7%9A%84%E8%A7%A3%E7%A0%81%E5%99%A8/">08 å¼€ç®±å³ç”¨ï¼šNetty æ”¯æŒå“ªäº›å¸¸ç”¨çš„è§£ç å™¨ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/09-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93writeandflush-%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E5%89%96%E6%9E%90/">09 æ•°æ®ä¼ è¾“ï¼šwriteAndFlush å¤„ç†æµç¨‹å‰–æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/10-%E5%8F%8C%E5%88%83%E5%89%91%E5%90%88%E7%90%86%E7%AE%A1%E7%90%86-netty-%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98/">10 åŒåˆƒå‰‘ï¼šåˆç†ç®¡ç† Netty å †å¤–å†…å­˜</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/11-%E5%8F%A6%E8%B5%B7%E7%82%89%E7%81%B6netty-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E8%BD%BD%E4%BD%93-bytebuf-%E8%AF%A6%E8%A7%A3/">11 å¦èµ·ç‚‰ç¶ï¼šNetty æ•°æ®ä¼ è¾“è½½ä½“ ByteBuf è¯¦è§£</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/12-%E4%BB%96%E5%B1%B1%E4%B9%8B%E7%9F%B3%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%99%A8-jemalloc-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/">12 ä»–å±±ä¹‹çŸ³ï¼šé«˜æ€§èƒ½å†…å­˜åˆ†é…å™¨ jemalloc åŸºæœ¬åŸç†</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/13-%E4%B8%BE%E4%B8%80%E5%8F%8D%E4%B8%89netty-%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E8%AE%BE%E8%AE%A1%E4%B8%8A/">13 ä¸¾ä¸€åä¸‰ï¼šNetty é«˜æ€§èƒ½å†…å­˜ç®¡ç†è®¾è®¡ï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/14-%E4%B8%BE%E4%B8%80%E5%8F%8D%E4%B8%89netty-%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E8%AE%BE%E8%AE%A1%E4%B8%8B/">14 ä¸¾ä¸€åä¸‰ï¼šNetty é«˜æ€§èƒ½å†…å­˜ç®¡ç†è®¾è®¡ï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/15-%E8%BD%BB%E9%87%8F%E7%BA%A7%E5%AF%B9%E8%B1%A1%E5%9B%9E%E6%94%B6%E7%AB%99recycler-%E5%AF%B9%E8%B1%A1%E6%B1%A0%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90/">15 è½»é‡çº§å¯¹è±¡å›æ”¶ç«™ï¼šRecycler å¯¹è±¡æ± æŠ€æœ¯è§£æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/16-io-%E5%8A%A0%E9%80%9F%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%E7%9A%84-netty-%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF/">16 IO åŠ é€Ÿï¼šä¸ä¼—ä¸åŒçš„ Netty é›¶æ‹·è´æŠ€æœ¯</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/17-%E6%BA%90%E7%A0%81%E7%AF%87%E4%BB%8E-linux-%E5%87%BA%E5%8F%91%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">17 æºç ç¯‡ï¼šä» Linux å‡ºå‘æ·±å…¥å‰–ææœåŠ¡ç«¯å¯åŠ¨æµç¨‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/18-%E6%BA%90%E7%A0%81%E7%AF%87%E8%A7%A3%E5%AF%86-netty-reactor-%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/">18 æºç ç¯‡ï¼šè§£å¯† Netty Reactor çº¿ç¨‹æ¨¡å‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/19-%E6%BA%90%E7%A0%81%E7%AF%87%E4%B8%80%E4%B8%AA%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E5%9C%A8-netty-%E4%B8%AD%E7%9A%84%E6%97%85%E7%A8%8B/">19 æºç ç¯‡ï¼šä¸€ä¸ªç½‘ç»œè¯·æ±‚åœ¨ Netty ä¸­çš„æ—…ç¨‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/20-%E6%8A%80%E5%B7%A7%E7%AF%87netty-%E7%9A%84-fastthreadlocal-%E7%A9%B6%E7%AB%9F%E6%AF%94-threadlocal-%E5%BF%AB%E5%9C%A8%E5%93%AA%E5%84%BF/">20 æŠ€å·§ç¯‡ï¼šNetty çš„ FastThreadLocal ç©¶ç«Ÿæ¯” ThreadLocal å¿«åœ¨å“ªå„¿ï¼Ÿ</a></li>
                
                
                
                    <li>21 æŠ€å·§ç¯‡ï¼šå»¶è¿Ÿä»»åŠ¡å¤„ç†ç¥å™¨ä¹‹æ—¶é—´è½® HashedWheelTimer</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/22-%E6%8A%80%E5%B7%A7%E7%AF%87%E9%AB%98%E6%80%A7%E8%83%BD%E6%97%A0%E9%94%81%E9%98%9F%E5%88%97-mpsc-queue/">22 æŠ€å·§ç¯‡ï¼šé«˜æ€§èƒ½æ— é”é˜Ÿåˆ— Mpsc Queue</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/23-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E9%AB%98%E6%80%A7%E8%83%BD%E5%88%86%E5%B8%83%E5%BC%8F-rpc-%E6%A1%86%E6%9E%B6/">23 æ¶æ„è®¾è®¡ï¼šå¦‚ä½•å®ç°ä¸€ä¸ªé«˜æ€§èƒ½åˆ†å¸ƒå¼ RPC æ¡†æ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/24-%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E4%B8%8E%E8%AE%A2%E9%98%85%E6%90%AD%E5%BB%BA%E7%94%9F%E4%BA%A7%E8%80%85%E5%92%8C%E6%B6%88%E8%B4%B9%E8%80%85%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A1%86%E6%9E%B6/">24 æœåŠ¡å‘å¸ƒä¸è®¢é˜…ï¼šæ­å»ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åŸºç¡€æ¡†æ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/25-%E8%BF%9C%E7%A8%8B%E9%80%9A%E4%BF%A1%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE%E8%AE%BE%E8%AE%A1%E4%BB%A5%E5%8F%8A%E7%BC%96%E8%A7%A3%E7%A0%81%E7%9A%84%E5%AE%9E%E7%8E%B0/">25 è¿œç¨‹é€šä¿¡ï¼šé€šä¿¡åè®®è®¾è®¡ä»¥åŠç¼–è§£ç çš„å®ç°</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/26-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%9C%BA%E5%88%B6%E7%9A%84%E5%AE%9E%E7%8E%B0/">26 æœåŠ¡æ²»ç†ï¼šæœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡æœºåˆ¶çš„å®ç°</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/27-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%BA%E7%94%A8%E6%88%B7%E5%B1%8F%E8%94%BD-rpc-%E8%B0%83%E7%94%A8%E7%9A%84%E5%BA%95%E5%B1%82%E7%BB%86%E8%8A%82/">27 åŠ¨æ€ä»£ç†ï¼šä¸ºç”¨æˆ·å±è”½ RPC è°ƒç”¨çš„åº•å±‚ç»†èŠ‚</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/28-%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93rpc-%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93%E4%B8%8E%E8%BF%9B%E9%98%B6%E5%BB%B6%E4%BC%B8/">28 å®æˆ˜æ€»ç»“ï¼šRPC å®æˆ˜æ€»ç»“ä¸è¿›é˜¶å»¶ä¼¸</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/29-%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3netty-%E4%B8%AD%E5%BA%94%E7%94%A8%E4%BA%86%E5%93%AA%E4%BA%9B%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">29 ç¼–ç¨‹æ€æƒ³ï¼šNetty ä¸­åº”ç”¨äº†å“ªäº›è®¾è®¡æ¨¡å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/30-%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93netty-%E5%9C%A8%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">30 å®è·µæ€»ç»“ï¼šNetty åœ¨é¡¹ç›®å¼€å‘ä¸­çš„ä¸€äº›æœ€ä½³å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/31-%E7%BB%93%E6%9D%9F%E8%AF%AD-%E6%8A%80%E6%9C%AF%E6%88%90%E9%95%BF%E4%B9%8B%E8%B7%AF%E5%A6%82%E4%BD%95%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB/">31 ç»“æŸè¯­ æŠ€æœ¯æˆé•¿ä¹‹è·¯ï¼šå¦‚ä½•æ‰“é€ è‡ªå·±çš„æŠ€æœ¯ä½“ç³»</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">21 æŠ€å·§ç¯‡ï¼šå»¶è¿Ÿä»»åŠ¡å¤„ç†ç¥å™¨ä¹‹æ—¶é—´è½® HashedWheelTimer</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2021-12-22 01:54:43</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/netty/">netty</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/">Nettyæ ¸å¿ƒåŸç†å‰–æä¸RPCå®è·µ</a>
                
            </div></div>
        <div class="post-content">
            <p>Netty ä¸­æœ‰å¾ˆå¤šåœºæ™¯ä¾èµ–å®šæ—¶ä»»åŠ¡å®ç°ï¼Œæ¯”è¾ƒå…¸å‹çš„æœ‰å®¢æˆ·ç«¯è¿æ¥çš„è¶…æ—¶æ§åˆ¶ã€é€šä¿¡åŒæ–¹è¿æ¥çš„å¿ƒè·³æ£€æµ‹ç­‰åœºæ™¯ã€‚åœ¨å­¦ä¹  Netty Reactor çº¿ç¨‹æ¨¡å‹æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“ NioEventLoop ä¸ä»…è´Ÿè´£å¤„ç† I/O äº‹ä»¶ï¼Œè€Œä¸”å…¼é¡¾æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œå…¶ä¸­å°±åŒ…æ‹¬å®šæ—¶ä»»åŠ¡ã€‚ä¸ºäº†å®ç°é«˜æ€§èƒ½çš„å®šæ—¶ä»»åŠ¡è°ƒåº¦ï¼ŒNetty å¼•å…¥äº†æ—¶é—´è½®ç®—æ³•é©±åŠ¨å®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œã€‚æ—¶é—´è½®åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸ºä»€ä¹ˆ Netty ä¸€å®šè¦ç”¨æ—¶é—´è½®æ¥å¤„ç†å®šæ—¶ä»»åŠ¡å‘¢ï¼ŸJDK åŸç”Ÿçš„å®ç°æ–¹æ¡ˆä¸èƒ½æ»¡è¶³è¦æ±‚å—ï¼Ÿæœ¬èŠ‚è¯¾æˆ‘å°†ä¸€æ­¥æ­¥ä¸ºä½ æ·±å…¥å‰–ææ—¶é—´è½®çš„åŸç†ä»¥åŠ Netty ä¸­æ˜¯å¦‚ä½•å®ç°æ—¶é—´è½®ç®—æ³•çš„ã€‚</p>
<blockquote>
<p>è¯´æ˜ï¼šæœ¬æ–‡å‚è€ƒçš„ Netty æºç ç‰ˆæœ¬ä¸º 4.1.42.Finalã€‚</p>
</blockquote>
<h3 id="å®šæ—¶ä»»åŠ¡çš„åŸºç¡€çŸ¥è¯†">å®šæ—¶ä»»åŠ¡çš„åŸºç¡€çŸ¥è¯†</h3>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸‹ä»€ä¹ˆæ˜¯å®šæ—¶ä»»åŠ¡ï¼Ÿå®šæ—¶å™¨æœ‰éå¸¸å¤šçš„ä½¿ç”¨åœºæ™¯ï¼Œå¤§å®¶åœ¨å¹³æ—¶å·¥ä½œä¸­åº”è¯¥ç»å¸¸é‡åˆ°ï¼Œä¾‹å¦‚ç”Ÿæˆæœˆç»Ÿè®¡æŠ¥è¡¨ã€è´¢åŠ¡å¯¹è´¦ã€ä¼šå‘˜ç§¯åˆ†ç»“ç®—ã€é‚®ä»¶æ¨é€ç­‰ï¼Œéƒ½æ˜¯å®šæ—¶å™¨çš„ä½¿ç”¨åœºæ™¯ã€‚å®šæ—¶å™¨ä¸€èˆ¬æœ‰ä¸‰ç§è¡¨ç°å½¢å¼ï¼šæŒ‰å›ºå®šå‘¨æœŸå®šæ—¶æ‰§è¡Œã€å»¶è¿Ÿä¸€å®šæ—¶é—´åæ‰§è¡Œã€æŒ‡å®šæŸä¸ªæ—¶åˆ»æ‰§è¡Œã€‚</p>
<p>å®šæ—¶å™¨çš„æœ¬è´¨æ˜¯è®¾è®¡ä¸€ç§æ•°æ®ç»“æ„ï¼Œèƒ½å¤Ÿå­˜å‚¨å’Œè°ƒåº¦ä»»åŠ¡é›†åˆï¼Œè€Œä¸” deadline è¶Šè¿‘çš„ä»»åŠ¡æ‹¥æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚é‚£ä¹ˆå®šæ—¶å™¨å¦‚ä½•çŸ¥é“ä¸€ä¸ªä»»åŠ¡æ˜¯å¦åˆ°æœŸäº†å‘¢ï¼Ÿå®šæ—¶å™¨éœ€è¦é€šè¿‡è½®è¯¢çš„æ–¹å¼æ¥å®ç°ï¼Œæ¯éš”ä¸€ä¸ªæ—¶é—´ç‰‡å»æ£€æŸ¥ä»»åŠ¡æ˜¯å¦åˆ°æœŸã€‚</p>
<p>æ‰€ä»¥å®šæ—¶å™¨çš„å†…éƒ¨ç»“æ„ä¸€èˆ¬éœ€è¦ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—å’Œä¸€ä¸ªå¼‚æ­¥è½®è¯¢çº¿ç¨‹ï¼Œå¹¶ä¸”èƒ½å¤Ÿæä¾›ä¸‰ç§åŸºæœ¬æ“ä½œï¼š</p>
<ul>
<li>Schedule æ–°å¢ä»»åŠ¡è‡³ä»»åŠ¡é›†åˆï¼›</li>
<li>Cancel å–æ¶ˆæŸä¸ªä»»åŠ¡ï¼›</li>
<li>Run æ‰§è¡Œåˆ°æœŸçš„ä»»åŠ¡ã€‚</li>
</ul>
<p>JDK åŸç”Ÿæä¾›äº†ä¸‰ç§å¸¸ç”¨çš„å®šæ—¶å™¨å®ç°æ–¹å¼ï¼Œåˆ†åˆ«ä¸º Timerã€DelayedQueue å’Œ ScheduledThreadPoolExecutorã€‚ä¸‹é¢æˆ‘ä»¬é€ä¸€å¯¹å®ƒä»¬è¿›è¡Œä»‹ç»ã€‚</p>
<h4 id="timer">Timer</h4>
<p>Timer å±äº JDK æ¯”è¾ƒæ—©æœŸç‰ˆæœ¬çš„å®ç°ï¼Œå®ƒå¯ä»¥å®ç°å›ºå®šå‘¨æœŸçš„ä»»åŠ¡ï¼Œä»¥åŠå»¶è¿Ÿä»»åŠ¡ã€‚Timer ä¼šèµ·åŠ¨ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹å»æ‰§è¡Œåˆ°æœŸçš„ä»»åŠ¡ï¼Œä»»åŠ¡å¯ä»¥åªè¢«è°ƒåº¦æ‰§è¡Œä¸€æ¬¡ï¼Œä¹Ÿå¯ä»¥å‘¨æœŸæ€§åå¤æ‰§è¡Œå¤šæ¬¡ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ Timer æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚</p>
<pre tabindex="0"><code>Timer timer = new Timer();

timer.scheduleAtFixedRate(new TimerTask() {

    @Override

    public void run() {

        // do something

    }

}, 10000, 1000);  // 10s åè°ƒåº¦ä¸€ä¸ªå‘¨æœŸä¸º 1s çš„å®šæ—¶ä»»åŠ¡
</code></pre><p>å¯ä»¥çœ‹å‡ºï¼Œä»»åŠ¡æ˜¯ç”± TimerTask ç±»å®ç°ï¼ŒTimerTask æ˜¯å®ç°äº† Runnable æ¥å£çš„æŠ½è±¡ç±»ï¼ŒTimer è´Ÿè´£è°ƒåº¦å’Œæ‰§è¡Œ TimerTaskã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹ Timer çš„å†…éƒ¨æ„é€ ã€‚</p>
<pre tabindex="0"><code>public class Timer {

    private final TaskQueue queue = new TaskQueue();

    private final TimerThread thread = new TimerThread(queue);
    public Timer(String name) {

        thread.setName(name);

        thread.start();

    }

}
</code></pre><p>TaskQueue æ˜¯ç”±æ•°ç»„ç»“æ„å®ç°çš„å°æ ¹å †ï¼Œdeadline æœ€è¿‘çš„ä»»åŠ¡ä½äºå †é¡¶ç«¯ï¼Œqueue[1] å§‹ç»ˆæ˜¯æœ€ä¼˜å…ˆè¢«æ‰§è¡Œçš„ä»»åŠ¡ã€‚æ‰€ä»¥ä½¿ç”¨å°æ ¹å †çš„æ•°æ®ç»“æ„ï¼ŒRun æ“ä½œæ—¶é—´å¤æ‚åº¦ O(1)ï¼Œæ–°å¢ Schedule å’Œå–æ¶ˆ Cancel æ“ä½œçš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(logn)ã€‚</p>
<p>Timer å†…éƒ¨å¯åŠ¨äº†ä¸€ä¸ª TimerThread å¼‚æ­¥çº¿ç¨‹ï¼Œä¸è®ºæœ‰å¤šå°‘ä»»åŠ¡è¢«åŠ å…¥æ•°ç»„ï¼Œå§‹ç»ˆéƒ½æ˜¯ç”± TimerThread è´Ÿè´£å¤„ç†ã€‚TimerThread ä¼šå®šæ—¶è½®è¯¢ TaskQueue ä¸­çš„ä»»åŠ¡ï¼Œå¦‚æœå †é¡¶çš„ä»»åŠ¡çš„ deadline å·²åˆ°ï¼Œé‚£ä¹ˆæ‰§è¡Œä»»åŠ¡ï¼›å¦‚æœæ˜¯å‘¨æœŸæ€§ä»»åŠ¡ï¼Œæ‰§è¡Œå®Œæˆåé‡æ–°è®¡ç®—ä¸‹ä¸€æ¬¡ä»»åŠ¡çš„ deadlineï¼Œå¹¶å†æ¬¡æ”¾å…¥å°æ ¹å †ï¼›å¦‚æœæ˜¯å•æ¬¡æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ‰§è¡Œç»“æŸåä¼šä» TaskQueue ä¸­åˆ é™¤ã€‚</p>
<h4 id="delayedqueue">DelayedQueue</h4>
<p>DelayedQueue æ˜¯ JDK ä¸­ä¸€ç§å¯ä»¥å»¶è¿Ÿè·å–å¯¹è±¡çš„é˜»å¡é˜Ÿåˆ—ï¼Œå…¶å†…éƒ¨æ˜¯é‡‡ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ— PriorityQueue å­˜å‚¨å¯¹è±¡ã€‚DelayQueue ä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½å¿…é¡»å®ç° Delayed æ¥å£ï¼Œå¹¶é‡å†™ compareTo å’Œ getDelay æ–¹æ³•ã€‚DelayedQueue çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>public class DelayQueueTest {

    public static void main(String[] args) throws Exception {

        BlockingQueue&lt;SampleTask&gt; delayQueue = new DelayQueue&lt;&gt;();

        long now = System.currentTimeMillis();

        delayQueue.put(new SampleTask(now + 1000));

        delayQueue.put(new SampleTask(now + 2000));

        delayQueue.put(new SampleTask(now + 3000));

        for (int i = 0; i &lt; 3; i++) {

            System.out.println(new Date(delayQueue.take().getTime()));

        }

    }

    static class SampleTask implements Delayed {

        long time;

        public SampleTask(long time) {

            this.time = time;

        }

        public long getTime() {

            return time;

        }

        @Override

        public int compareTo(Delayed o) {

            return Long.compare(this.getDelay(TimeUnit.MILLISECONDS), o.getDelay(TimeUnit.MILLISECONDS));

        }

        @Override

        public long getDelay(TimeUnit unit) {

            return unit.convert(time - System.currentTimeMillis(), TimeUnit.MILLISECONDS);

        }

    }

}
</code></pre><p>DelayQueue æä¾›äº† put() å’Œ take() çš„é˜»å¡æ–¹æ³•ï¼Œå¯ä»¥å‘é˜Ÿåˆ—ä¸­æ·»åŠ å¯¹è±¡å’Œå–å‡ºå¯¹è±¡ã€‚å¯¹è±¡è¢«æ·»åŠ åˆ° DelayQueue åï¼Œä¼šæ ¹æ® compareTo() æ–¹æ³•è¿›è¡Œä¼˜å…ˆçº§æ’åºã€‚getDelay() æ–¹æ³•ç”¨äºè®¡ç®—æ¶ˆæ¯å»¶è¿Ÿçš„å‰©ä½™æ—¶é—´ï¼Œåªæœ‰ getDelay &lt;=0 æ—¶ï¼Œè¯¥å¯¹è±¡æ‰èƒ½ä» DelayQueue ä¸­å–å‡ºã€‚</p>
<p>DelayQueue åœ¨æ—¥å¸¸å¼€å‘ä¸­æœ€å¸¸ç”¨çš„åœºæ™¯å°±æ˜¯å®ç°é‡è¯•æœºåˆ¶ã€‚ä¾‹å¦‚ï¼Œæ¥å£è°ƒç”¨å¤±è´¥æˆ–è€…è¯·æ±‚è¶…æ—¶åï¼Œå¯ä»¥å°†å½“å‰è¯·æ±‚å¯¹è±¡æ”¾å…¥ DelayQueueï¼Œé€šè¿‡ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹ take() å–å‡ºå¯¹è±¡ç„¶åç»§ç»­è¿›è¡Œé‡è¯•ã€‚å¦‚æœè¿˜æ˜¯è¯·æ±‚å¤±è´¥ï¼Œç»§ç»­æ”¾å› DelayQueueã€‚ä¸ºäº†é™åˆ¶é‡è¯•çš„é¢‘ç‡ï¼Œå¯ä»¥è®¾ç½®é‡è¯•çš„æœ€å¤§æ¬¡æ•°ä»¥åŠé‡‡ç”¨æŒ‡æ•°é€€é¿ç®—æ³•è®¾ç½®å¯¹è±¡çš„ deadlineï¼Œå¦‚ 2sã€4sã€8sã€16s â€¦â€¦ä»¥æ­¤ç±»æ¨ã€‚</p>
<p>ç›¸æ¯”äº Timerï¼ŒDelayQueue åªå®ç°äº†ä»»åŠ¡ç®¡ç†çš„åŠŸèƒ½ï¼Œéœ€è¦ä¸å¼‚æ­¥çº¿ç¨‹é…åˆä½¿ç”¨ã€‚DelayQueue ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°ä»»åŠ¡çš„ä¼˜å…ˆçº§æ’åºï¼Œæ–°å¢ Schedule å’Œå–æ¶ˆ Cancel æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¹Ÿæ˜¯ O(logn)ã€‚</p>
<h4 id="scheduledthreadpoolexecutor">ScheduledThreadPoolExecutor</h4>
<p>ä¸Šæ–‡ä¸­ä»‹ç»çš„ Timer å…¶å®ç›®å‰å¹¶ä¸æ¨èç”¨æˆ·ä½¿ç”¨ï¼Œå®ƒæ˜¯å­˜åœ¨ä¸å°‘è®¾è®¡ç¼ºé™·çš„ã€‚</p>
<ul>
<li>Timer æ˜¯å•çº¿ç¨‹æ¨¡å¼ã€‚å¦‚æœæŸä¸ª TimerTask æ‰§è¡Œæ—¶é—´å¾ˆä¹…ï¼Œä¼šå½±å“å…¶ä»–ä»»åŠ¡çš„è°ƒåº¦ã€‚</li>
<li>Timer çš„ä»»åŠ¡è°ƒåº¦æ˜¯åŸºäºç³»ç»Ÿç»å¯¹æ—¶é—´çš„ï¼Œå¦‚æœç³»ç»Ÿæ—¶é—´ä¸æ­£ç¡®ï¼Œå¯èƒ½ä¼šå‡ºç°é—®é¢˜ã€‚</li>
<li>TimerTask å¦‚æœæ‰§è¡Œå‡ºç°å¼‚å¸¸ï¼ŒTimer å¹¶ä¸ä¼šæ•è·ï¼Œä¼šå¯¼è‡´çº¿ç¨‹ç»ˆæ­¢ï¼Œå…¶ä»–ä»»åŠ¡æ°¸è¿œä¸ä¼šæ‰§è¡Œã€‚</li>
</ul>
<p>ä¸ºäº†è§£å†³ Timer çš„è®¾è®¡ç¼ºé™·ï¼ŒJDK æä¾›äº†åŠŸèƒ½æ›´åŠ ä¸°å¯Œçš„ ScheduledThreadPoolExecutorã€‚ScheduledThreadPoolExecutor æä¾›äº†å‘¨æœŸæ‰§è¡Œä»»åŠ¡å’Œå»¶è¿Ÿæ‰§è¡Œä»»åŠ¡çš„ç‰¹æ€§ï¼Œä¸‹é¢é€šè¿‡ä¸€ä¸ªä¾‹å­å…ˆçœ‹ä¸‹ ScheduledThreadPoolExecutor å¦‚ä½•ä½¿ç”¨ã€‚</p>
<pre tabindex="0"><code>public class ScheduledExecutorServiceTest {

    public static void main(String[] args) {

        ScheduledExecutorService executor = Executors.newScheduledThreadPool(5);

        executor.scheduleAtFixedRate(() -&gt; System.out.println(&quot;Hello World&quot;), 1000, 2000, TimeUnit.MILLISECONDS); // 1s å»¶è¿Ÿåå¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼Œæ¯ 2s é‡å¤æ‰§è¡Œä¸€æ¬¡

    }

}
</code></pre><p>ScheduledThreadPoolExecutor ç»§æ‰¿äº ThreadPoolExecutorï¼Œå› æ­¤å®ƒå…·å¤‡çº¿ç¨‹æ± å¼‚æ­¥å¤„ç†ä»»åŠ¡çš„èƒ½åŠ›ã€‚çº¿ç¨‹æ± ä¸»è¦è´Ÿè´£ç®¡ç†åˆ›å»ºå’Œç®¡ç†çº¿ç¨‹ï¼Œå¹¶ä»è‡ªèº«çš„é˜»å¡é˜Ÿåˆ—ä¸­ä¸æ–­è·å–ä»»åŠ¡æ‰§è¡Œã€‚çº¿ç¨‹æ± æœ‰ä¸¤ä¸ªé‡è¦çš„è§’è‰²ï¼Œåˆ†åˆ«æ˜¯ä»»åŠ¡å’Œé˜»å¡é˜Ÿåˆ—ã€‚ScheduledThreadPoolExecutor åœ¨ ThreadPoolExecutor çš„åŸºç¡€ä¸Šï¼Œé‡æ–°è®¾è®¡äº†ä»»åŠ¡ ScheduledFutureTask å’Œé˜»å¡é˜Ÿåˆ— DelayedWorkQueueã€‚ScheduledFutureTask ç»§æ‰¿äº FutureTaskï¼Œå¹¶é‡å†™äº† run() æ–¹æ³•ï¼Œä½¿å…¶å…·å¤‡å‘¨æœŸæ‰§è¡Œä»»åŠ¡çš„èƒ½åŠ›ã€‚DelayedWorkQueue å†…éƒ¨æ˜¯ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œdeadline æœ€è¿‘çš„ä»»åŠ¡åœ¨é˜Ÿåˆ—å¤´éƒ¨ã€‚å¯¹äºå‘¨æœŸæ‰§è¡Œçš„ä»»åŠ¡ï¼Œåœ¨æ‰§è¡Œå®Œä¼šé‡æ–°è®¾ç½®æ—¶é—´ï¼Œå¹¶å†æ¬¡æ”¾å…¥é˜Ÿåˆ—ä¸­ã€‚ScheduledThreadPoolExecutor çš„å®ç°åŸç†å¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/CgpVE1_okGKAVhdBAAKC36HWpJQ727.png" alt="å›¾ç‰‡11.png"> ä»¥ä¸Šæˆ‘ä»¬ç®€å•ä»‹ç»äº† JDK ä¸‰ç§å®ç°å®šæ—¶å™¨çš„æ–¹å¼ã€‚å¯ä»¥è¯´å®ƒä»¬çš„å®ç°æ€è·¯éå¸¸ç±»ä¼¼ï¼Œéƒ½ç¦»ä¸å¼€<strong>ä»»åŠ¡</strong>ã€<strong>ä»»åŠ¡ç®¡ç†</strong>ã€<strong>ä»»åŠ¡è°ƒåº¦</strong>ä¸‰ä¸ªè§’è‰²ã€‚ä¸‰ç§å®šæ—¶å™¨æ–°å¢å’Œå–æ¶ˆä»»åŠ¡çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(logn)ï¼Œé¢å¯¹æµ·é‡ä»»åŠ¡æ’å…¥å’Œåˆ é™¤çš„åœºæ™¯ï¼Œè¿™ä¸‰ç§å®šæ—¶å™¨éƒ½ä¼šé‡åˆ°æ¯”è¾ƒä¸¥é‡çš„æ€§èƒ½ç“¶é¢ˆã€‚å› æ­¤ï¼Œå¯¹äºæ€§èƒ½è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šé‡‡ç”¨æ—¶é—´è½®ç®—æ³•ã€‚é‚£ä¹ˆæ—¶é—´è½®åˆæ˜¯å¦‚ä½•è§£å†³æµ·é‡ä»»åŠ¡æ’å…¥å’Œåˆ é™¤çš„å‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­å‘ä¸‹åˆ†æã€‚</p>
<h3 id="æ—¶é—´è½®åŸç†åˆ†æ">æ—¶é—´è½®åŸç†åˆ†æ</h3>
<p>æŠ€æœ¯æœ‰æ—¶å°±æºäºç”Ÿæ´»ï¼Œä¾‹å¦‚æ’é˜Ÿä¹°ç¥¨å¯ä»¥æƒ³åˆ°é˜Ÿåˆ—ï¼Œå…¬å¸çš„ç»„ç»‡å…³ç³»å¯ä»¥ç†è§£ä¸ºæ ‘ç­‰ï¼Œè€Œæ—¶é—´è½®ç®—æ³•çš„è®¾è®¡æ€æƒ³å°±æ¥æºäºé’Ÿè¡¨ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ—¶é—´è½®å¯ä»¥ç†è§£ä¸ºä¸€ç§ç¯å½¢ç»“æ„ï¼Œåƒé’Ÿè¡¨ä¸€æ ·è¢«åˆ†ä¸ºå¤šä¸ª slot æ§½ä½ã€‚æ¯ä¸ª slot ä»£è¡¨ä¸€ä¸ªæ—¶é—´æ®µï¼Œæ¯ä¸ª slot ä¸­å¯ä»¥å­˜æ”¾å¤šä¸ªä»»åŠ¡ï¼Œä½¿ç”¨çš„æ˜¯é“¾è¡¨ç»“æ„ä¿å­˜è¯¥æ—¶é—´æ®µåˆ°æœŸçš„æ‰€æœ‰ä»»åŠ¡ã€‚æ—¶é—´è½®é€šè¿‡ä¸€ä¸ªæ—¶é’ˆéšç€æ—¶é—´ä¸€ä¸ªä¸ª slot è½¬åŠ¨ï¼Œå¹¶æ‰§è¡Œ slot ä¸­çš„æ‰€æœ‰åˆ°æœŸä»»åŠ¡ã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/CgpVE1_okKiAGl0gAAMLshtTq-M933.png" alt="å›¾ç‰‡22.png"></p>
<p>ä»»åŠ¡æ˜¯å¦‚ä½•æ·»åŠ åˆ°æ—¶é—´è½®å½“ä¸­çš„å‘¢ï¼Ÿå¯ä»¥æ ¹æ®ä»»åŠ¡çš„åˆ°æœŸæ—¶é—´è¿›è¡Œå–æ¨¡ï¼Œç„¶åå°†ä»»åŠ¡åˆ†å¸ƒåˆ°ä¸åŒçš„ slot ä¸­ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ—¶é—´è½®è¢«åˆ’åˆ†ä¸º 8 ä¸ª slotï¼Œæ¯ä¸ª slot ä»£è¡¨ 1sï¼Œå½“å‰æ—¶é’ˆæŒ‡å‘ 2ã€‚å‡å¦‚ç°åœ¨éœ€è¦è°ƒåº¦ä¸€ä¸ª 3s åæ‰§è¡Œçš„ä»»åŠ¡ï¼Œåº”è¯¥åŠ å…¥ 2+3=5 çš„ slot ä¸­ï¼›å¦‚æœéœ€è¦è°ƒåº¦ä¸€ä¸ª 12s ä»¥åçš„ä»»åŠ¡ï¼Œéœ€è¦ç­‰å¾…æ—¶é’ˆå®Œæ•´èµ°å®Œä¸€åœˆ round é›¶ 4 ä¸ª slotï¼Œéœ€è¦æ”¾å…¥ç¬¬ (2+12)%8=6 ä¸ª slotã€‚</p>
<p>é‚£ä¹ˆå½“æ—¶é’ˆèµ°åˆ°ç¬¬ 6 ä¸ª slot æ—¶ï¼Œæ€ä¹ˆåŒºåˆ†æ¯ä¸ªä»»åŠ¡æ˜¯å¦éœ€è¦ç«‹å³æ‰§è¡Œï¼Œè¿˜æ˜¯éœ€è¦ç­‰å¾…ä¸‹ä¸€åœˆ roundï¼Œç”šè‡³æ›´ä¹…æ—¶é—´ä¹‹åæ‰§è¡Œå‘¢ï¼Ÿæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠ round ä¿¡æ¯ä¿å­˜åœ¨ä»»åŠ¡ä¸­ã€‚ä¾‹å¦‚å›¾ä¸­ç¬¬ 6 ä¸ª slot çš„é“¾è¡¨ä¸­åŒ…å« 3 ä¸ªä»»åŠ¡ï¼Œç¬¬ä¸€ä¸ªä»»åŠ¡ round=0ï¼Œéœ€è¦ç«‹å³æ‰§è¡Œï¼›ç¬¬äºŒä¸ªä»»åŠ¡ round=1ï¼Œéœ€è¦ç­‰å¾… 1_8=8s åæ‰§è¡Œï¼›ç¬¬ä¸‰ä¸ªä»»åŠ¡ round=2ï¼Œéœ€è¦ç­‰å¾… 2_8=8s åæ‰§è¡Œã€‚æ‰€ä»¥å½“æ—¶é’ˆè½¬åŠ¨åˆ°å¯¹åº” slot æ—¶ï¼Œåªæ‰§è¡Œ round=0 çš„ä»»åŠ¡ï¼Œslot ä¸­å…¶ä½™ä»»åŠ¡çš„ round åº”å½“å‡ 1ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ª round ä¹‹åæ‰§è¡Œã€‚</p>
<p>ä¸Šé¢ä»‹ç»äº†æ—¶é—´è½®ç®—æ³•çš„åŸºæœ¬ç†è®ºï¼Œå¯ä»¥çœ‹å‡ºæ—¶é—´è½®æœ‰ç‚¹ç±»ä¼¼ HashMapï¼Œå¦‚æœå¤šä¸ªä»»åŠ¡å¦‚æœå¯¹åº”åŒä¸€ä¸ª slotï¼Œå¤„ç†å†²çªçš„æ–¹æ³•é‡‡ç”¨çš„æ˜¯æ‹‰é“¾æ³•ã€‚åœ¨ä»»åŠ¡æ•°é‡æ¯”è¾ƒå¤šçš„åœºæ™¯ä¸‹ï¼Œé€‚å½“å¢åŠ æ—¶é—´è½®çš„ slot æ•°é‡ï¼Œå¯ä»¥å‡å°‘æ—¶é’ˆè½¬åŠ¨æ—¶éå†çš„ä»»åŠ¡ä¸ªæ•°ã€‚</p>
<p>æ—¶é—´è½®å®šæ—¶å™¨æœ€å¤§çš„ä¼˜åŠ¿å°±æ˜¯ï¼Œä»»åŠ¡çš„æ–°å¢å’Œå–æ¶ˆéƒ½æ˜¯ O(1) æ—¶é—´å¤æ‚åº¦ï¼Œè€Œä¸”åªéœ€è¦ä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥é©±åŠ¨æ—¶é—´è½®è¿›è¡Œå·¥ä½œã€‚HashedWheelTimer æ˜¯ Netty ä¸­æ—¶é—´è½®ç®—æ³•çš„å®ç°ç±»ï¼Œä¸‹é¢æˆ‘å°±ç»“åˆ HashedWheelTimer çš„æºç è¯¦ç»†åˆ†ææ—¶é—´è½®ç®—æ³•çš„å®ç°åŸç†ã€‚</p>
<h3 id="netty-hashedwheeltimer-æºç è§£æ">Netty HashedWheelTimer æºç è§£æ</h3>
<p>åœ¨å¼€å§‹å­¦ä¹  HashedWheelTimer çš„æºç ä¹‹å‰ï¼Œéœ€è¦äº†è§£ HashedWheelTimer æ¥å£å®šä¹‰ä»¥åŠç›¸å…³ç»„ä»¶ï¼Œæ‰èƒ½æ›´å¥½åœ°ä½¿ç”¨ HashedWheelTimerã€‚</p>
<h4 id="æ¥å£å®šä¹‰">æ¥å£å®šä¹‰</h4>
<p>HashedWheelTimer å®ç°äº†æ¥å£ io.netty.util.Timerï¼ŒTimer æ¥å£æ˜¯æˆ‘ä»¬ç ”ç©¶ HashedWheelTimer ä¸€ä¸ªå¾ˆå¥½çš„åˆ‡å…¥å£ã€‚ä¸€èµ·çœ‹ä¸‹ Timer æ¥å£çš„å®šä¹‰ï¼š</p>
<pre tabindex="0"><code>public interface Timer {

    Timeout newTimeout(TimerTask task, long delay, TimeUnit unit);

    Set&lt;Timeout&gt; stop();

}
</code></pre><p>Timer æ¥å£æä¾›äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯åˆ›å»ºä»»åŠ¡ newTimeout() å’Œåœæ­¢æ‰€æœ‰æœªæ‰§è¡Œä»»åŠ¡ stop()ã€‚ä»æ–¹æ³•çš„å®šä¹‰å¯ä»¥çœ‹å‡ºï¼ŒTimer å¯ä»¥è®¤ä¸ºæ˜¯ä¸Šå±‚çš„æ—¶é—´è½®è°ƒåº¦å™¨ï¼Œé€šè¿‡ newTimeout() æ–¹æ³•å¯ä»¥æäº¤ä¸€ä¸ªä»»åŠ¡ TimerTaskï¼Œå¹¶è¿”å›ä¸€ä¸ª Timeoutã€‚TimerTask å’Œ Timeout æ˜¯ä¸¤ä¸ªæ¥å£ç±»ï¼Œå®ƒä»¬æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿæˆ‘ä»¬åˆ†åˆ«çœ‹ä¸‹ TimerTask å’Œ Timeout çš„æ¥å£å®šä¹‰ï¼š</p>
<pre tabindex="0"><code>public interface TimerTask {

    void run(Timeout timeout) throws Exception;

}

public interface Timeout {

    Timer timer();

    TimerTask task();

    boolean isExpired();

    boolean isCancelled();

    boolean cancel();

}
</code></pre><p>Timeout æŒæœ‰ Timer å’Œ TimerTask çš„å¼•ç”¨ï¼Œè€Œä¸”é€šè¿‡ Timeout æ¥å£å¯ä»¥æ‰§è¡Œå–æ¶ˆä»»åŠ¡çš„æ“ä½œã€‚Timerã€Timeout å’Œ TimerTask ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/CgpVE1_okNGAJA8SAAJSJkBDij0471.png" alt="å›¾ç‰‡1.png"> æ¸…æ¥š HashedWheelTimer çš„æ¥å£å®šä¹‰ä»¥åŠç›¸å…³ç»„ä»¶çš„æ¦‚å¿µä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹ä½¿ç”¨å®ƒäº†ã€‚</p>
<h4 id="å¿«é€Ÿä¸Šæ‰‹">å¿«é€Ÿä¸Šæ‰‹</h4>
<p>é€šè¿‡ä¸‹é¢è¿™ä¸ªç®€å•çš„ä¾‹å­ï¼Œæˆ‘ä»¬çœ‹ä¸‹ HashedWheelTimer æ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚</p>
<pre tabindex="0"><code>public class HashedWheelTimerTest {

    public static void main(String[] args) {

        Timer timer = new HashedWheelTimer();

        Timeout timeout1 = timer.newTimeout(new TimerTask() {

            @Override

            public void run(Timeout timeout) {

                System.out.println(&quot;timeout1: &quot; + new Date());

            }

        }, 10, TimeUnit.SECONDS);

        if (!timeout1.isExpired()) {

            timeout1.cancel();

        }

        timer.newTimeout(new TimerTask() {

            @Override

            public void run(Timeout timeout) throws InterruptedException {

                System.out.println(&quot;timeout2: &quot; + new Date());

                Thread.sleep(5000);

            }

        }, 1, TimeUnit.SECONDS);

        timer.newTimeout(new TimerTask() {

            @Override

            public void run(Timeout timeout) {

                System.out.println(&quot;timeout3: &quot; + new Date());

            }

        }, 3, TimeUnit.SECONDS);

    }

}
</code></pre><p>ä»£ç è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>timeout2: Mon Nov 09 19:57:04 CST 2020

timeout3: Mon Nov 09 19:57:09 CST 2020
</code></pre><p>ç®€å•çš„å‡ è¡Œä»£ç ï¼ŒåŸºæœ¬å±•ç¤ºäº† HashedWheelTimer çš„å¤§éƒ¨åˆ†ç”¨æ³•ã€‚ç¤ºä¾‹ä¸­æˆ‘ä»¬é€šè¿‡ newTimeout() å¯åŠ¨äº†ä¸‰ä¸ª TimerTaskï¼Œtimeout1 ç”±äºè¢«å–æ¶ˆäº†ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰æ‰§è¡Œã€‚timeout2 å’Œ timeout3 åˆ†åˆ«åº”è¯¥åœ¨ 1s å’Œ 3s åæ‰§è¡Œã€‚ç„¶è€Œä»ç»“æœè¾“å‡ºçœ‹å¹¶ä¸æ˜¯ï¼Œtimeout2 å’Œ timeout3 çš„æ‰“å°æ—¶é—´ç›¸å·®äº† 5sï¼Œè¿™æ˜¯ç”±äº timeout2 é˜»å¡äº† 5s é€ æˆçš„ã€‚ç”±æ­¤å¯ä»¥çœ‹å‡ºï¼Œæ—¶é—´è½®ä¸­çš„ä»»åŠ¡æ‰§è¡Œæ˜¯<strong>ä¸²è¡Œ</strong>çš„ï¼Œå½“ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´è¿‡é•¿ï¼Œä¼šå½±å“åç»­ä»»åŠ¡çš„è°ƒåº¦å’Œæ‰§è¡Œï¼Œå¾ˆå¯èƒ½äº§ç”Ÿä»»åŠ¡å †ç§¯çš„æƒ…å†µã€‚</p>
<p>è‡³æ­¤ï¼Œå¯¹ HashedWheelTimer çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•å·²ç»æœ‰äº†åˆæ­¥äº†è§£ï¼Œä¸‹é¢æˆ‘ä»¬å¼€å§‹æ·±å…¥ç ”ç©¶ HashedWheelTimer çš„å®ç°åŸç†ã€‚</p>
<h4 id="å†…éƒ¨ç»“æ„">å†…éƒ¨ç»“æ„</h4>
<p>æˆ‘ä»¬å…ˆä» HashedWheelTimer çš„æ„é€ å‡½æ•°çœ‹èµ·ï¼Œç»“åˆä¸Šæ–‡ä¸­ä»‹ç»çš„æ—¶é—´è½®ç®—æ³•ï¼Œä¸€èµ·æ¢³ç†å‡º HashedWheelTimer çš„å†…éƒ¨å®ç°ç»“æ„ã€‚</p>
<pre tabindex="0"><code>public HashedWheelTimer(

        ThreadFactory threadFactory,

        long tickDuration, 

        TimeUnit unit, 

        int ticksPerWheel, 

        boolean leakDetection,

        long maxPendingTimeouts) {

    // çœç•¥å…¶ä»–ä»£ç 
    wheel = createWheel(ticksPerWheel); // åˆ›å»ºæ—¶é—´è½®çš„ç¯å½¢æ•°ç»„ç»“æ„

    mask = wheel.length - 1; // ç”¨äºå¿«é€Ÿå–æ¨¡çš„æ©ç 

    long duration = unit.toNanos(tickDuration); // è½¬æ¢æˆçº³ç§’å¤„ç†

    // çœç•¥å…¶ä»–ä»£ç 

    workerThread = threadFactory.newThread(worker); // åˆ›å»ºå·¥ä½œçº¿ç¨‹

    leak = leakDetection || !workerThread.isDaemon() ? leakDetector.track(this) : null; // æ˜¯å¦å¼€å¯å†…å­˜æ³„æ¼æ£€æµ‹

    this.maxPendingTimeouts = maxPendingTimeouts; // æœ€å¤§å…è®¸ç­‰å¾…ä»»åŠ¡æ•°ï¼ŒHashedWheelTimer ä¸­ä»»åŠ¡è¶…å‡ºè¯¥é˜ˆå€¼æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸

    // å¦‚æœ HashedWheelTimer çš„å®ä¾‹æ•°è¶…è¿‡ 64ï¼Œä¼šæ‰“å°é”™è¯¯æ—¥å¿—

    if (INSTANCE_COUNTER.incrementAndGet() &gt; INSTANCE_COUNT_LIMIT &amp;&amp;

        WARNED_TOO_MANY_INSTANCES.compareAndSet(false, true)) {

        reportTooManyInstances();

    }

}
</code></pre><p>HashedWheelTimer çš„æ„é€ å‡½æ•°æ¸…æ™°åœ°åˆ—ä¸¾å‡ºäº†å‡ ä¸ªæ ¸å¿ƒå±æ€§ï¼š</p>
<ul>
<li><strong>threadFactory</strong>ï¼Œçº¿ç¨‹æ± ï¼Œä½†æ˜¯åªåˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ï¼›</li>
<li><strong>tickDuration</strong>ï¼Œæ—¶é’ˆæ¯æ¬¡ tick çš„æ—¶é—´ï¼Œç›¸å½“äºæ—¶é’ˆé—´éš”å¤šä¹…èµ°åˆ°ä¸‹ä¸€ä¸ª slotï¼›</li>
<li><strong>unit</strong>ï¼Œè¡¨ç¤º tickDuration çš„æ—¶é—´å•ä½ï¼›</li>
<li><strong>ticksPerWheel</strong>ï¼Œæ—¶é—´è½®ä¸Šä¸€å…±æœ‰å¤šå°‘ä¸ª slotï¼Œé»˜è®¤ 512 ä¸ªã€‚åˆ†é…çš„ slot è¶Šå¤šï¼Œå ç”¨çš„å†…å­˜ç©ºé—´å°±è¶Šå¤§ï¼›</li>
<li><strong>leakDetection</strong>ï¼Œæ˜¯å¦å¼€å¯å†…å­˜æ³„æ¼æ£€æµ‹ï¼›</li>
<li><strong>maxPendingTimeouts</strong>ï¼Œæœ€å¤§å…è®¸ç­‰å¾…ä»»åŠ¡æ•°ã€‚</li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹ HashedWheelTimer æ˜¯å¦‚ä½•åˆ›å»ºå‡ºæ¥çš„ï¼Œæˆ‘ä»¬ç›´æ¥è·Ÿè¿› createWheel() æ–¹æ³•çš„æºç ï¼š</p>
<pre tabindex="0"><code>private static HashedWheelBucket[] createWheel(int ticksPerWheel) {

    // çœç•¥å…¶ä»–ä»£ç 

    ticksPerWheel = normalizeTicksPerWheel(ticksPerWheel);

    HashedWheelBucket[] wheel = new HashedWheelBucket[ticksPerWheel];

    for (int i = 0; i &lt; wheel.length; i ++) {

        wheel[i] = new HashedWheelBucket();

    }

    return wheel;

}

private static int normalizeTicksPerWheel(int ticksPerWheel) {

    int normalizedTicksPerWheel = 1;

    while (normalizedTicksPerWheel &lt; ticksPerWheel) {

        normalizedTicksPerWheel &lt;&lt;= 1;

    }

    return normalizedTicksPerWheel;

}

private static final class HashedWheelBucket {

    private HashedWheelTimeout head;

    private HashedWheelTimeout tail;

    // çœç•¥å…¶ä»–ä»£ç 

}
</code></pre><p>æ—¶é—´è½®çš„åˆ›å»ºå°±æ˜¯ä¸ºäº†åˆ›å»º HashedWheelBucket æ•°ç»„ï¼Œæ¯ä¸ª HashedWheelBucket è¡¨ç¤ºæ—¶é—´è½®ä¸­ä¸€ä¸ª slotã€‚ä» HashedWheelBucket çš„ç»“æ„å®šä¹‰å¯ä»¥çœ‹å‡ºï¼ŒHashedWheelBucket å†…éƒ¨æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ç»“æ„ï¼ŒåŒå‘é“¾è¡¨çš„æ¯ä¸ªèŠ‚ç‚¹æŒæœ‰ä¸€ä¸ª HashedWheelTimeout å¯¹è±¡ï¼ŒHashedWheelTimeout ä»£è¡¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ã€‚æ¯ä¸ª HashedWheelBucket éƒ½åŒ…å«åŒå‘é“¾è¡¨ head å’Œ tail ä¸¤ä¸ª HashedWheelTimeout èŠ‚ç‚¹ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°ä¸åŒæ–¹å‘è¿›è¡Œé“¾è¡¨éå†ã€‚å…³äº HashedWheelBucket å’Œ HashedWheelTimeout çš„å…·ä½“åŠŸèƒ½ä¸‹æ–‡å†ç»§ç»­ä»‹ç»ã€‚</p>
<p>å› ä¸ºæ—¶é—´è½®éœ€è¦ä½¿ç”¨ &amp; åšå–æ¨¡è¿ç®—ï¼Œæ‰€ä»¥æ•°ç»„çš„é•¿åº¦éœ€è¦æ˜¯ 2 çš„æ¬¡å¹‚ã€‚normalizeTicksPerWheel() æ–¹æ³•çš„ä½œç”¨å°±æ˜¯æ‰¾åˆ°ä¸å°äº ticksPerWheel çš„æœ€å° 2 æ¬¡å¹‚ï¼Œè¿™ä¸ªæ–¹æ³•å®ç°çš„å¹¶ä¸å¥½ï¼Œå¯ä»¥å‚è€ƒ JDK HashMap æ‰©å®¹ tableSizeFor çš„å®ç°è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚å½“ç„¶ normalizeTicksPerWheel() åªæ˜¯åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä½¿ç”¨ï¼Œæ‰€ä»¥å¹¶æ— å½±å“ã€‚</p>
<pre tabindex="0"><code>static final int MAXIMUM_CAPACITY = 1 &lt;&lt; 30;

private static int normalizeTicksPerWheel(int ticksPerWheel) {

    int n = ticksPerWheel - 1;

    n |= n &gt;&gt;&gt; 1;

    n |= n &gt;&gt;&gt; 2;

    n |= n &gt;&gt;&gt; 4;

    n |= n &gt;&gt;&gt; 8;

    n |= n &gt;&gt;&gt; 16;

    return (n &lt; 0) ? 1 : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;

}
</code></pre><p>HashedWheelTimer åˆå§‹åŒ–çš„ä¸»è¦å·¥ä½œæˆ‘ä»¬å·²ç»ä»‹ç»å®Œäº†ï¼Œå…¶å†…éƒ¨ç»“æ„ä¸ä¸Šæ–‡ä¸­ä»‹ç»çš„æ—¶é—´è½®ç®—æ³•ç±»ä¼¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/CgqCHl_okUGATnXpAAPdCRAt-n0348.png" alt="å›¾ç‰‡2.png"></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å›´ç»•å®šæ—¶å™¨çš„ä¸‰ç§åŸºæœ¬æ“ä½œï¼Œåˆ†æä¸‹ HashedWheelTimer æ˜¯å¦‚ä½•å®ç°æ·»åŠ ä»»åŠ¡ã€æ‰§è¡Œä»»åŠ¡å’Œå–æ¶ˆä»»åŠ¡çš„ã€‚</p>
<h4 id="æ·»åŠ ä»»åŠ¡">æ·»åŠ ä»»åŠ¡</h4>
<p>HashedWheelTimer åˆå§‹åŒ–å®Œæˆåï¼Œå¦‚ä½•å‘ HashedWheelTimer æ·»åŠ ä»»åŠ¡å‘¢ï¼Ÿæˆ‘ä»¬è‡ªç„¶æƒ³åˆ° HashedWheelTimer æä¾›çš„ newTimeout() æ–¹æ³•ã€‚</p>
<pre tabindex="0"><code>public Timeout newTimeout(TimerTask task, long delay, TimeUnit unit) {

    // çœç•¥å…¶ä»–ä»£ç 

    long pendingTimeoutsCount = pendingTimeouts.incrementAndGet();

    if (maxPendingTimeouts &gt; 0 &amp;&amp; pendingTimeoutsCount &gt; maxPendingTimeouts) {

        pendingTimeouts.decrementAndGet();

        throw new RejectedExecutionException(&quot;Number of pending timeouts (&quot;

            + pendingTimeoutsCount + &quot;) is greater than or equal to maximum allowed pending &quot;

            + &quot;timeouts (&quot; + maxPendingTimeouts + &quot;)&quot;);

    }

    start(); // 1. å¦‚æœ worker çº¿ç¨‹æ²¡æœ‰å¯åŠ¨ï¼Œéœ€è¦å¯åŠ¨

    long deadline = System.nanoTime() + unit.toNanos(delay) - startTime; // è®¡ç®—ä»»åŠ¡çš„ deadline

    if (delay &gt; 0 &amp;&amp; deadline &lt; 0) {

        deadline = Long.MAX_VALUE;

    }

    HashedWheelTimeout timeout = new HashedWheelTimeout(this, task, deadline); //  2. åˆ›å»ºå®šæ—¶ä»»åŠ¡

    timeouts.add(timeout); // 3. æ·»åŠ ä»»åŠ¡åˆ° Mpsc Queue

    return timeout;

}

private final Queue&lt;HashedWheelTimeout&gt; timeouts = PlatformDependent.newMpscQueue();
</code></pre><p>newTimeout() æ–¹æ³•ä¸»è¦åšäº†ä¸‰ä»¶äº‹ï¼Œåˆ†åˆ«ä¸ºå¯åŠ¨å·¥ä½œçº¿ç¨‹ï¼Œåˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼Œå¹¶æŠŠä»»åŠ¡æ·»åŠ åˆ° Mpsc Queueã€‚HashedWheelTimer çš„å·¥ä½œçº¿ç¨‹é‡‡ç”¨äº†æ‡’å¯åŠ¨çš„æ–¹å¼ï¼Œä¸éœ€è¦ç”¨æˆ·æ˜¾ç¤ºè°ƒç”¨ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯åœ¨æ—¶é—´è½®ä¸­æ²¡æœ‰ä»»åŠ¡æ—¶ï¼Œå¯ä»¥é¿å…å·¥ä½œçº¿ç¨‹ç©ºè½¬è€Œé€ æˆæ€§èƒ½æŸè€—ã€‚å…ˆçœ‹ä¸‹å¯åŠ¨å·¥ä½œçº¿ç¨‹ start() çš„æºç ï¼š</p>
<pre tabindex="0"><code>public void start() {

    switch (WORKER_STATE_UPDATER.get(this)) {

        case WORKER_STATE_INIT:

            if (WORKER_STATE_UPDATER.compareAndSet(this, WORKER_STATE_INIT, WORKER_STATE_STARTED)) {

                workerThread.start();

            }

            break;

        case WORKER_STATE_STARTED:

            break;

        case WORKER_STATE_SHUTDOWN:

            throw new IllegalStateException(&quot;cannot be started once stopped&quot;);

        default:

            throw new Error(&quot;Invalid WorkerState&quot;);

    }

    while (startTime == 0) {

        try {

            startTimeInitialized.await();

        } catch (InterruptedException ignore) {

        }

    }

}
</code></pre><p>å·¥ä½œçº¿ç¨‹çš„å¯åŠ¨ä¹‹å‰ï¼Œä¼šé€šè¿‡ CAS æ“ä½œè·å–å·¥ä½œçº¿ç¨‹çš„çŠ¶æ€ï¼Œå¦‚æœå·²ç»å¯åŠ¨ï¼Œåˆ™ç›´æ¥è·³è¿‡ã€‚å¦‚æœæ²¡æœ‰å¯åŠ¨ï¼Œå†æ¬¡é€šè¿‡ CAS æ“ä½œæ›´æ”¹å·¥ä½œçº¿ç¨‹çŠ¶æ€ï¼Œç„¶åå¯åŠ¨å·¥ä½œçº¿ç¨‹ã€‚å¯åŠ¨çš„è¿‡ç¨‹æ˜¯ç›´æ¥è°ƒç”¨çš„ Thread#start() æ–¹æ³•ï¼Œæˆ‘ä»¬æš‚ä¸”å…ˆä¸å…³æ³¨å·¥ä½œçº¿ç¨‹å…·ä½“åšäº†ä»€ä¹ˆï¼Œä¸‹æ–‡å†ç»§ç»­åˆ†æã€‚</p>
<p>å›åˆ° newTimeout() çš„ä¸»æµç¨‹ï¼Œæ¥ä¸‹æ¥çš„é€»è¾‘å°±éå¸¸ç®€å•äº†ã€‚æ ¹æ®ç”¨æˆ·ä¼ å…¥çš„ä»»åŠ¡å»¶è¿Ÿæ—¶é—´ï¼Œå¯ä»¥è®¡ç®—å‡ºä»»åŠ¡çš„ deadlineï¼Œç„¶ååˆ›å»ºå®šæ—¶ä»»åŠ¡ HashedWheelTimeout å¯¹è±¡ï¼Œæœ€ç»ˆæŠŠ HashedWheelTimeout æ·»åŠ åˆ° Mpsc Queue ä¸­ã€‚çœ‹åˆ°è¿™é‡Œï¼Œä½ ä¼šä¸ä¼šæœ‰ä¸ªç–‘é—®ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯å°† HashedWheelTimeout ç›´æ¥æ·»åŠ åˆ°æ—¶é—´è½®ä¸­å‘¢ï¼Ÿè€Œæ˜¯å…ˆæ·»åŠ åˆ° Mpsc Queueï¼ŸMpsc Queue å¯ä»¥ç†è§£ä¸ºå¤šç”Ÿäº§è€…å•æ¶ˆè´¹è€…çš„çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ï¼Œä¸‹èŠ‚è¯¾æˆ‘ä»¬ä¼šå¯¹ Mpsc Queue è¯¦ç»†åˆ†æï¼Œåœ¨è¿™é‡Œå°±ä¸åšå±•å¼€äº†ã€‚å¯ä»¥çŒœåˆ° HashedWheelTimer æ˜¯æƒ³å€ŸåŠ© Mpsc Queue ä¿è¯å¤šçº¿ç¨‹å‘æ—¶é—´è½®æ·»åŠ ä»»åŠ¡çš„çº¿ç¨‹å®‰å…¨æ€§ã€‚</p>
<p>é‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä»»åŠ¡æ‰ä¼šè¢«åŠ å…¥æ—¶é—´è½®å¹¶æ‰§è¡Œå‘¢ï¼Ÿæ­¤æ—¶è¿˜æ²¡æœ‰å¤ªå¤šä¿¡æ¯ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åªèƒ½å·¥ä½œçº¿ç¨‹ Worker é‡Œå¯»æ‰¾é—®é¢˜çš„ç­”æ¡ˆã€‚</p>
<h4 id="å·¥ä½œçº¿ç¨‹-worker">å·¥ä½œçº¿ç¨‹ Worker</h4>
<p>å·¥ä½œçº¿ç¨‹ Worker æ˜¯æ—¶é—´è½®çš„æ ¸å¿ƒå¼•æ“ï¼Œéšç€æ—¶é’ˆçš„è½¬åŠ¨ï¼Œåˆ°æœŸä»»åŠ¡çš„å¤„ç†éƒ½ç”± Worker å¤„ç†å®Œæˆã€‚ä¸‹é¢æˆ‘ä»¬å®šä½åˆ° Worker çš„ run() æ–¹æ³•ä¸€æ¢ç©¶ç«Ÿã€‚</p>
<pre tabindex="0"><code>private final class Worker implements Runnable {

    private final Set&lt;Timeout&gt; unprocessedTimeouts = new HashSet&lt;Timeout&gt;(); // æœªå¤„ç†ä»»åŠ¡åˆ—è¡¨

    private long tick;

    @Override

    public void run() {

        startTime = System.nanoTime();

        if (startTime == 0) {

            startTime = 1;

        }

        startTimeInitialized.countDown();

        do {

            final long deadline = waitForNextTick(); // 1. è®¡ç®—ä¸‹æ¬¡ tick çš„æ—¶é—´, ç„¶åsleep åˆ°ä¸‹æ¬¡ tick

            if (deadline &gt; 0) { // å¯èƒ½å› ä¸ºæº¢å‡ºæˆ–è€…çº¿ç¨‹ä¸­æ–­ï¼Œé€ æˆ deadline &lt;= 0

                int idx = (int) (tick &amp; mask); // 2. è·å–å½“å‰ tick åœ¨ HashedWheelBucket æ•°ç»„ä¸­å¯¹åº”çš„ä¸‹æ ‡

                processCancelledTasks(); // 3. ç§»é™¤è¢«å–æ¶ˆçš„ä»»åŠ¡

                HashedWheelBucket bucket =

                        wheel[idx];

                transferTimeoutsToBuckets(); // 4. ä» Mpsc Queue ä¸­å–å‡ºä»»åŠ¡åŠ å…¥å¯¹åº”çš„ slot ä¸­

                bucket.expireTimeouts(deadline); // 5. æ‰§è¡Œåˆ°æœŸçš„ä»»åŠ¡

                tick++;

            }

        } while (WORKER_STATE_UPDATER.get(HashedWheelTimer.this) == WORKER_STATE_STARTED);

        // æ—¶é—´è½®é€€å‡ºåï¼Œå–å‡º slot ä¸­æœªæ‰§è¡Œä¸”æœªè¢«å–æ¶ˆçš„ä»»åŠ¡ï¼Œå¹¶åŠ å…¥æœªå¤„ç†ä»»åŠ¡åˆ—è¡¨ï¼Œä»¥ä¾¿ stop() æ–¹æ³•è¿”å›

        for (HashedWheelBucket bucket: wheel) {

            bucket.clearTimeouts(unprocessedTimeouts);

        }

        // å°†è¿˜æ²¡æ¥å¾—åŠæ·»åŠ åˆ° slot ä¸­çš„ä»»åŠ¡å–å‡ºï¼Œå¦‚æœä»»åŠ¡æœªå–æ¶ˆåˆ™åŠ å…¥æœªå¤„ç†ä»»åŠ¡åˆ—è¡¨ï¼Œä»¥ä¾¿ stop() æ–¹æ³•è¿”å›

        for (;;) {

            HashedWheelTimeout timeout = timeouts.poll();

            if (timeout == null) {

                break;

            }

            if (!timeout.isCancelled()) {

                unprocessedTimeouts.add(timeout);

            }

        }

        processCancelledTasks();

    }

}
</code></pre><p>å·¥ä½œçº¿ç¨‹ Worker çš„æ ¸å¿ƒæ‰§è¡Œæµç¨‹æ˜¯ä»£ç ä¸­çš„ do-while å¾ªç¯ï¼Œåªè¦ Worker å¤„äº STARTED çŠ¶æ€ï¼Œå°±ä¼šæ‰§è¡Œ do-while å¾ªç¯ï¼Œæˆ‘ä»¬æŠŠè¯¥è¿‡ç¨‹æ‹†åˆ†æˆä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼Œé€ä¸€åˆ†æã€‚</p>
<ul>
<li>é€šè¿‡ waitForNextTick() æ–¹æ³•è®¡ç®—å‡ºæ—¶é’ˆåˆ°ä¸‹ä¸€æ¬¡ tick çš„æ—¶é—´é—´éš”ï¼Œç„¶å sleep åˆ°ä¸‹ä¸€æ¬¡ tickã€‚</li>
<li>é€šè¿‡ä½è¿ç®—è·å–å½“å‰ tick åœ¨ HashedWheelBucket æ•°ç»„ä¸­å¯¹åº”çš„ä¸‹æ ‡</li>
<li>ç§»é™¤è¢«å–æ¶ˆçš„ä»»åŠ¡ã€‚</li>
<li>ä» Mpsc Queue ä¸­å–å‡ºä»»åŠ¡åŠ å…¥å¯¹åº”çš„ HashedWheelBucket ä¸­ã€‚</li>
<li>æ‰§è¡Œå½“å‰ HashedWheelBucket ä¸­çš„åˆ°æœŸä»»åŠ¡ã€‚</li>
</ul>
<p>é¦–å…ˆçœ‹ä¸‹ waitForNextTick() æ–¹æ³•æ˜¯å¦‚ä½•è®¡ç®—ç­‰å¾…æ—¶é—´çš„ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>private long waitForNextTick() {

    long deadline = tickDuration * (tick + 1);

    for (;;) {

        final long currentTime = System.nanoTime() - startTime;

        long sleepTimeMs = (deadline - currentTime + 999999) / 1000000;

        if (sleepTimeMs &lt;= 0) {

            if (currentTime == Long.MIN_VALUE) {

                return -Long.MAX_VALUE;

            } else {

                return currentTime;

            }

        }

        if (PlatformDependent.isWindows()) {

            sleepTimeMs = sleepTimeMs / 10 * 10;

        }

        try {

            Thread.sleep(sleepTimeMs);

        } catch (InterruptedException ignored) {

            if (WORKER_STATE_UPDATER.get(HashedWheelTimer.this) == WORKER_STATE_SHUTDOWN) {

                return Long.MIN_VALUE;

            }

        }

    }

}
</code></pre><p>æ ¹æ® tickDuration å¯ä»¥æ¨ç®—å‡ºä¸‹ä¸€æ¬¡ tick çš„ deadlineï¼Œdeadline å‡å»å½“å‰æ—¶é—´å°±å¯ä»¥å¾—åˆ°éœ€è¦ sleep çš„ç­‰å¾…æ—¶é—´ã€‚æ‰€ä»¥ tickDuration çš„å€¼è¶Šå°ï¼Œæ—¶é—´çš„ç²¾å‡†åº¦ä¹Ÿå°±è¶Šé«˜ï¼ŒåŒæ—¶ Worker çš„ç¹å¿™ç¨‹åº¦è¶Šé«˜ã€‚å¦‚æœ tickDuration è®¾ç½®è¿‡å°ï¼Œä¸ºäº†é˜²æ­¢ç³»ç»Ÿä¼šé¢‘ç¹åœ° sleep å†å”¤é†’ï¼Œä¼šä¿è¯ Worker è‡³å°‘ sleep çš„æ—¶é—´ä¸º 1ms ä»¥ä¸Šã€‚</p>
<p>Worker ä» sleep çŠ¶æ€å”¤é†’åï¼Œæ¥ä¸‹æ¥ä¼šæ‰§è¡Œç¬¬äºŒæ­¥æµç¨‹ï¼Œé€šè¿‡æŒ‰ä½ä¸çš„æ“ä½œè®¡ç®—å‡ºå½“å‰ tick åœ¨ HashedWheelBucket æ•°ç»„ä¸­å¯¹åº”çš„ä¸‹æ ‡ã€‚æŒ‰ä½ä¸æ¯”æ™®é€šçš„å–æ¨¡è¿ç®—æ•ˆç‡è¦å¿«å¾ˆå¤šï¼Œå‰ææ˜¯æ—¶é—´è½®ä¸­çš„æ•°ç»„é•¿åº¦æ˜¯ 2 çš„æ¬¡å¹‚ï¼Œæ©ç  mask ä¸º 2 çš„æ¬¡å¹‚å‡ 1ï¼Œè¿™æ ·æ‰èƒ½è¾¾åˆ°ä¸å–æ¨¡ä¸€æ ·çš„æ•ˆæœã€‚</p>
<p>æ¥ä¸‹æ¥ Worker ä¼šè°ƒç”¨ processCancelledTasks() æ–¹æ³•å¤„ç†è¢«å–æ¶ˆçš„ä»»åŠ¡ï¼Œæ‰€æœ‰å–æ¶ˆçš„ä»»åŠ¡éƒ½ä¼šåŠ å…¥ cancelledTimeouts é˜Ÿåˆ—ä¸­ï¼ŒWorker ä¼šä»é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡ï¼Œç„¶åå°†å…¶ä»å¯¹åº”çš„ HashedWheelBucket ä¸­åˆ é™¤ï¼Œåˆ é™¤æ“ä½œä¸ºåŸºæœ¬çš„é“¾è¡¨æ“ä½œã€‚processCancelledTasks() çš„æºç æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬åœ¨æ­¤å°±ä¸å±•å¼€äº†ã€‚</p>
<p>ä¹‹å‰æˆ‘ä»¬è¿˜ç•™äº†ä¸€ä¸ªç–‘é—®ï¼ŒMpsc Queue ä¸­çš„ä»»åŠ¡ä»€ä¹ˆæ—¶å€™åŠ å…¥æ—¶é—´è½®çš„å‘¢ï¼Ÿç­”æ¡ˆå°±åœ¨ transferTimeoutsToBuckets() æ–¹æ³•ä¸­ã€‚</p>
<pre tabindex="0"><code>private void transferTimeoutsToBuckets() {

    // æ¯æ¬¡æ—¶é’ˆ tick æœ€å¤šåªå¤„ç† 100000 ä¸ªä»»åŠ¡ï¼Œä»¥é˜²é˜»å¡ Worker çº¿ç¨‹

    for (int i = 0; i &lt; 100000; i++) {

        HashedWheelTimeout timeout = timeouts.poll();

        if (timeout == null) {

            break;

        }

        if (timeout.state() == HashedWheelTimeout.ST_CANCELLED) {

            continue;

        }

        long calculated = timeout.deadline / tickDuration; // è®¡ç®—ä»»åŠ¡éœ€è¦ç»è¿‡å¤šå°‘ä¸ª tick

        timeout.remainingRounds = (calculated - tick) / wheel.length; // è®¡ç®—ä»»åŠ¡éœ€è¦åœ¨æ—¶é—´è½®ä¸­ç»å†çš„åœˆæ•° remainingRounds

        final long ticks = Math.max(calculated, tick); // å¦‚æœä»»åŠ¡åœ¨ timeouts é˜Ÿåˆ—é‡Œå·²ç»è¿‡äº†æ‰§è¡Œæ—¶é—´, é‚£ä¹ˆä¼šåŠ å…¥å½“å‰ HashedWheelBucket ä¸­

        int stopIndex = (int) (ticks &amp; mask);

        HashedWheelBucket bucket = wheel[stopIndex];

        bucket.addTimeout(timeout);

    }

}
</code></pre><p>transferTimeoutsToBuckets() çš„ä¸»è¦å·¥ä½œå°±æ˜¯ä» Mpsc Queue ä¸­å–å‡ºä»»åŠ¡ï¼Œç„¶åæ·»åŠ åˆ°æ—¶é—´è½®å¯¹åº”çš„ HashedWheelBucket ä¸­ã€‚æ¯æ¬¡æ—¶é’ˆ tick æœ€å¤šåªå¤„ç† 100000 ä¸ªä»»åŠ¡ï¼Œä¸€æ–¹é¢é¿å…å–ä»»åŠ¡çš„æ“ä½œè€—æ—¶è¿‡é•¿ï¼Œå¦ä¸€æ–¹é¢ä¸ºäº†é˜²æ­¢æ‰§è¡Œå¤ªå¤šä»»åŠ¡é€ æˆ Worker çº¿ç¨‹é˜»å¡ã€‚</p>
<p>æ ¹æ®ç”¨æˆ·è®¾ç½®çš„ä»»åŠ¡ deadlineï¼Œå¯ä»¥è®¡ç®—å‡ºä»»åŠ¡éœ€è¦ç»è¿‡å¤šå°‘æ¬¡ tick æ‰èƒ½å¼€å§‹æ‰§è¡Œä»¥åŠéœ€è¦åœ¨æ—¶é—´è½®ä¸­è½¬åŠ¨åœˆæ•° remainingRoundsï¼ŒremainingRounds ä¼šè®°å½•åœ¨ HashedWheelTimeout ä¸­ï¼Œåœ¨æ‰§è¡Œä»»åŠ¡çš„æ—¶å€™ remainingRounds ä¼šè¢«ä½¿ç”¨åˆ°ã€‚å› ä¸ºæ—¶é—´è½®ä¸­çš„ä»»åŠ¡å¹¶ä¸èƒ½å¤Ÿä¿è¯åŠæ—¶æ‰§è¡Œï¼Œå‡å¦‚æœ‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´ç‰¹åˆ«é•¿ï¼Œé‚£ä¹ˆä»»åŠ¡åœ¨ timeouts é˜Ÿåˆ—é‡Œå·²ç»è¿‡äº†æ‰§è¡Œæ—¶é—´ï¼Œä¹Ÿæ²¡æœ‰å…³ç³»ï¼ŒWorker ä¼šå°†è¿™äº›ä»»åŠ¡ç›´æ¥åŠ å…¥å½“å‰HashedWheelBucket ä¸­ï¼Œæ‰€ä»¥è¿‡æœŸçš„ä»»åŠ¡å¹¶ä¸ä¼šè¢«é—æ¼ã€‚</p>
<p>ä»»åŠ¡è¢«æ·»åŠ åˆ°æ—¶é—´è½®ä¹‹åï¼Œé‡æ–°å†å›åˆ° Worker#run() çš„ä¸»æµç¨‹ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ‰§è¡Œå½“å‰ HashedWheelBucket ä¸­çš„åˆ°æœŸä»»åŠ¡ï¼Œè·Ÿè¿› HashedWheelBucket#expireTimeouts() æ–¹æ³•çš„æºç ï¼š</p>
<pre tabindex="0"><code>public void expireTimeouts(long deadline) {

    HashedWheelTimeout timeout = head;

    while (timeout != null) {

        HashedWheelTimeout next = timeout.next;

        if (timeout.remainingRounds &lt;= 0) {

            next = remove(timeout);

            if (timeout.deadline &lt;= deadline) {

                timeout.expire(); // æ‰§è¡Œä»»åŠ¡

            } else {

                throw new IllegalStateException(String.format(

                        &quot;timeout.deadline (%d) &gt; deadline (%d)&quot;, timeout.deadline, deadline));

            }

        } else if (timeout.isCancelled()) {

            next = remove(timeout);

        } else {

            timeout.remainingRounds --; // æœªåˆ°æ‰§è¡Œæ—¶é—´ï¼ŒremainingRounds å‡ 1

        }

        timeout = next;

    }

}
</code></pre><p>æ‰§è¡Œä»»åŠ¡çš„æ“ä½œæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ä»å¤´å¼€å§‹éå† HashedWheelBucket ä¸­çš„åŒå‘é“¾è¡¨ã€‚å¦‚æœ remainingRounds &lt;=0ï¼Œåˆ™è°ƒç”¨ expire() æ–¹æ³•æ‰§è¡Œä»»åŠ¡ï¼Œtimeout.expire() å†…éƒ¨å°±æ˜¯è°ƒç”¨äº† TimerTask çš„ run() æ–¹æ³•ã€‚å¦‚æœä»»åŠ¡å·²ç»è¢«å–æ¶ˆï¼Œç›´æ¥ä»é“¾è¡¨ä¸­ç§»é™¤ã€‚å¦åˆ™è¡¨ç¤ºä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´è¿˜æ²¡åˆ°ï¼ŒremainingRounds å‡ 1ï¼Œç­‰å¾…ä¸‹ä¸€åœˆå³å¯ã€‚</p>
<p>è‡³æ­¤ï¼Œå·¥ä½œçº¿ç¨‹ Worker çš„æ ¸å¿ƒé€»è¾‘ do-while å¾ªç¯æˆ‘ä»¬å·²ç»è®²å®Œäº†ã€‚å½“æ—¶é—´è½®é€€å‡ºåï¼ŒWorker è¿˜ä¼šæ‰§è¡Œä¸€äº›åç½®çš„æ”¶å°¾å·¥ä½œã€‚Worker ä¼šä»æ¯ä¸ª HashedWheelBucket å–å‡ºæœªæ‰§è¡Œä¸”æœªå–æ¶ˆçš„ä»»åŠ¡ï¼Œä»¥åŠè¿˜æ¥å¾—åŠæ·»åŠ åˆ° HashedWheelBucket ä¸­çš„ä»»åŠ¡ï¼Œç„¶ååŠ å…¥æœªå¤„ç†ä»»åŠ¡åˆ—è¡¨ï¼Œä»¥ä¾¿ stop() æ–¹æ³•ç»Ÿä¸€å¤„ç†ã€‚</p>
<h4 id="åœæ­¢æ—¶é—´è½®">åœæ­¢æ—¶é—´è½®</h4>
<p>å›åˆ° Timer æ¥å£ä¸¤ä¸ªæ–¹æ³•ï¼ŒnewTimeout() ä¸Šæ–‡å·²ç»åˆ†æå®Œäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±ä»¥ stop() æ–¹æ³•ä¸ºå…¥å£ï¼Œçœ‹ä¸‹æ—¶é—´è½®åœæ­¢éƒ½åšäº†å“ªäº›å·¥ä½œã€‚</p>
<pre tabindex="0"><code>@Override

public Set&lt;Timeout&gt; stop() {

    // Worker çº¿ç¨‹æ— æ³•åœæ­¢æ—¶é—´è½®

    if (Thread.currentThread() == workerThread) {

        throw new IllegalStateException(

                HashedWheelTimer.class.getSimpleName() +

                        &quot;.stop() cannot be called from &quot; +

                        TimerTask.class.getSimpleName());

    }

    // å°è¯•é€šè¿‡ CAS æ“ä½œå°†å·¥ä½œçº¿ç¨‹çš„çŠ¶æ€æ›´æ–°ä¸º SHUTDOWN çŠ¶æ€

    if (!WORKER_STATE_UPDATER.compareAndSet(this, WORKER_STATE_STARTED, WORKER_STATE_SHUTDOWN)) {

        if (WORKER_STATE_UPDATER.getAndSet(this, WORKER_STATE_SHUTDOWN) != WORKER_STATE_SHUTDOWN) {

            INSTANCE_COUNTER.decrementAndGet();

            if (leak != null) {

                boolean closed = leak.close(this);

                assert closed;

            }

            return Collections.emptySet();

    }

    try {

        boolean interrupted = false;

        while (workerThread.isAlive()) {

            workerThread.interrupt(); // ä¸­æ–­ Worker çº¿ç¨‹

            try {

                workerThread.join(100);

            } catch (InterruptedException ignored) {

                interrupted = true;

            }

        }

        if (interrupted) {

            Thread.currentThread().interrupt();

        }

    } finally {

        INSTANCE_COUNTER.decrementAndGet();

        if (leak != null) {

            boolean closed = leak.close(this);

            assert closed;

        }

    }

    return worker.unprocessedTimeouts(); // è¿”å›æœªå¤„ç†ä»»åŠ¡çš„åˆ—è¡¨

}
</code></pre><p>å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ Worker çº¿ç¨‹ï¼Œå®ƒæ˜¯ä¸èƒ½å‘èµ·åœæ­¢æ—¶é—´è½®çš„æ“ä½œçš„ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢æœ‰å®šæ—¶ä»»åŠ¡å‘èµ·åœæ­¢æ—¶é—´è½®çš„æ¶æ„æ“ä½œã€‚åœæ­¢æ—¶é—´è½®ä¸»è¦åšäº†ä¸‰ä»¶äº‹ï¼Œé¦–å…ˆå°è¯•é€šè¿‡ CAS æ“ä½œå°†å·¥ä½œçº¿ç¨‹çš„çŠ¶æ€æ›´æ–°ä¸º SHUTDOWN çŠ¶æ€ï¼Œç„¶åä¸­æ–­å·¥ä½œçº¿ç¨‹ Workerï¼Œæœ€åå°†æœªå¤„ç†çš„ä»»åŠ¡åˆ—è¡¨è¿”å›ç»™ä¸Šå±‚ã€‚</p>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼ŒHashedWheelTimer çš„å®ç°åŸç†æˆ‘ä»¬å·²ç»åˆ†æå®Œäº†ã€‚å†æ¥å›é¡¾ä¸€ä¸‹ HashedWheelTimer çš„å‡ ä¸ªæ ¸å¿ƒæˆå‘˜ã€‚</p>
<ul>
<li><strong>HashedWheelTimeout</strong>ï¼Œä»»åŠ¡çš„å°è£…ç±»ï¼ŒåŒ…å«ä»»åŠ¡çš„åˆ°æœŸæ—¶é—´ deadlineã€éœ€è¦ç»å†çš„åœˆæ•° remainingRounds ç­‰å±æ€§ã€‚</li>
<li><strong>HashedWheelBucket</strong>ï¼Œç›¸å½“äºæ—¶é—´è½®çš„æ¯ä¸ª slotï¼Œå†…éƒ¨é‡‡ç”¨åŒå‘é“¾è¡¨ä¿å­˜äº†å½“å‰éœ€è¦æ‰§è¡Œçš„ HashedWheelTimeout åˆ—è¡¨ã€‚</li>
<li><strong>Worker</strong>ï¼ŒHashedWheelTimer çš„æ ¸å¿ƒå·¥ä½œå¼•æ“ï¼Œè´Ÿè´£å¤„ç†å®šæ—¶ä»»åŠ¡ã€‚</li>
</ul>
<h3 id="æ—¶é—´è½®è¿›é˜¶åº”ç”¨">æ—¶é—´è½®è¿›é˜¶åº”ç”¨</h3>
<p>Netty ä¸­çš„æ—¶é—´è½®æ˜¯é€šè¿‡å›ºå®šçš„æ—¶é—´é—´éš” tickDuration è¿›è¡Œæ¨åŠ¨çš„ï¼Œå¦‚æœé•¿æ—¶é—´æ²¡æœ‰åˆ°æœŸä»»åŠ¡ï¼Œé‚£ä¹ˆä¼šå­˜åœ¨æ—¶é—´è½®ç©ºæ¨è¿›çš„ç°è±¡ï¼Œä»è€Œé€ æˆä¸€å®šçš„æ€§èƒ½æŸè€—ã€‚æ­¤å¤–ï¼Œå¦‚æœä»»åŠ¡çš„åˆ°æœŸæ—¶é—´è·¨åº¦å¾ˆå¤§ï¼Œä¾‹å¦‚ A ä»»åŠ¡ 1s åæ‰§è¡Œï¼ŒB ä»»åŠ¡ 6 å°æ—¶ä¹‹åæ‰§è¡Œï¼Œä¹Ÿä¼šé€ æˆç©ºæ¨è¿›çš„é—®é¢˜ã€‚</p>
<p>é‚£ä¹ˆä¸Šè¿°é—®é¢˜æœ‰æ²¡æœ‰ä»€ä¹ˆè§£å†³æ–¹æ¡ˆå‘¢ï¼Ÿåœ¨ç ”ç©¶ Kafka çš„æ—¶å€™ï¼ŒKafka ä¹Ÿæœ‰æ—¶é—´è½®çš„åº”ç”¨ï¼Œå®ƒçš„å®ç°æ€è·¯ä¸ Netty æ˜¯å­˜åœ¨åŒºåˆ«çš„ã€‚å› ä¸º Kafka é¢å¯¹çš„åº”ç”¨åœºæ™¯æ˜¯æ›´åŠ ä¸¥è‹›çš„ï¼Œå¯èƒ½ä¼šå­˜åœ¨å„ç§æ—¶é—´ç²’åº¦çš„å®šæ—¶ä»»åŠ¡ï¼Œé‚£ä¹ˆ Kafka æ˜¯å¦æœ‰è§£å†³æ—¶é—´è·¨åº¦é—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬æ¥ä¸‹æ¥å°±ç®€å•ä»‹ç»ä¸‹ Kafka çš„ä¼˜åŒ–æ€è·¯ã€‚</p>
<p>Kafka æ—¶é—´è½®çš„å†…éƒ¨ç»“æ„ä¸ Netty ç±»ä¼¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚Kafka çš„æ—¶é—´è½®ä¹Ÿæ˜¯é‡‡ç”¨ç¯å½¢æ•°ç»„å­˜å‚¨å®šæ—¶ä»»åŠ¡ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ª slot ä»£è¡¨ä¸€ä¸ª Bucketï¼Œæ¯ä¸ª Bucket ä¿å­˜äº†å®šæ—¶ä»»åŠ¡åˆ—è¡¨ TimerTaskListï¼ŒTimerTaskList åŒæ ·é‡‡ç”¨åŒå‘é“¾è¡¨çš„ç»“æ„å®ç°ï¼Œé“¾è¡¨çš„æ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨çœŸæ­£çš„å®šæ—¶ä»»åŠ¡ TimerTaskEntryã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/CgpVE1_okZyASBNiAANiUk0T6tc832.png" alt="å›¾ç‰‡3.png"></p>
<p>ä¸ºäº†è§£å†³ç©ºæ¨è¿›çš„é—®é¢˜ï¼ŒKafka å€ŸåŠ© JDK çš„ DelayQueue æ¥è´Ÿè´£æ¨è¿›æ—¶é—´è½®ã€‚DelayQueue ä¿å­˜äº†æ—¶é—´è½®ä¸­çš„æ¯ä¸ª Bucketï¼Œå¹¶ä¸”æ ¹æ® Bucket çš„åˆ°æœŸæ—¶é—´è¿›è¡Œæ’åºï¼Œæœ€è¿‘çš„åˆ°æœŸæ—¶é—´è¢«æ”¾åœ¨ DelayQueue çš„é˜Ÿå¤´ã€‚Kafka ä¸­ä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹æ¥è¯»å– DelayQueue ä¸­çš„ä»»åŠ¡åˆ—è¡¨ï¼Œå¦‚æœæ—¶é—´æ²¡æœ‰åˆ°ï¼Œé‚£ä¹ˆ DelayQueue ä¼šä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼Œä»è€Œè§£å†³ç©ºæ¨èçš„é—®é¢˜ã€‚è¿™æ—¶å€™ä½ å¯èƒ½ä¼šé—®ï¼ŒDelayQueue æ’å…¥å’Œåˆ é™¤çš„æ€§èƒ½ä¸æ˜¯å¹¶ä¸å¥½å—ï¼Ÿå…¶å® Kafka é‡‡ç”¨çš„æ˜¯ä¸€ç§æƒè¡¡çš„ç­–ç•¥ï¼ŒæŠŠ DelayQueue ç”¨åœ¨äº†åˆé€‚çš„åœ°æ–¹ã€‚DelayQueue åªå­˜æ”¾äº† Bucketï¼ŒBucket çš„æ•°é‡å¹¶ä¸å¤šï¼Œç›¸æ¯”ç©ºæ¨è¿›å¸¦æ¥çš„å½±å“æ˜¯åˆ©å¤§äºå¼Šçš„ã€‚</p>
<p>ä¸ºäº†è§£å†³ä»»åŠ¡æ—¶é—´è·¨åº¦å¾ˆå¤§çš„é—®é¢˜ï¼ŒKafka å¼•å…¥äº†å±‚çº§æ—¶é—´è½®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚å½“ä»»åŠ¡çš„ deadline è¶…å‡ºå½“å‰æ‰€åœ¨å±‚çš„æ—¶é—´è½®è¡¨ç¤ºèŒƒå›´æ—¶ï¼Œå°±ä¼šå°è¯•å°†ä»»åŠ¡æ·»åŠ åˆ°ä¸Šä¸€å±‚æ—¶é—´è½®ä¸­ï¼Œè·Ÿé’Ÿè¡¨çš„æ—¶é’ˆã€åˆ†é’ˆã€ç§’é’ˆçš„è½¬åŠ¨è§„åˆ™æ˜¯åŒä¸€ä¸ªé“ç†ã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F_okdOAION1AALmn-njKt8140.png" alt="å›¾ç‰‡4.png"></p>
<p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œç¬¬ä¸€å±‚æ—¶é—´è½®æ¯ä¸ªæ—¶é—´æ ¼ä¸º 1msï¼Œæ•´ä¸ªæ—¶é—´è½®çš„è·¨åº¦ä¸º 20msï¼›ç¬¬äºŒå±‚æ—¶é—´è½®æ¯ä¸ªæ—¶é—´æ ¼ä¸º 20msï¼Œæ•´ä¸ªæ—¶é—´è½®è·¨åº¦ä¸º 400msï¼›ç¬¬ä¸‰å±‚æ—¶é—´è½®æ¯ä¸ªæ—¶é—´æ ¼ä¸º 400msï¼Œæ•´ä¸ªæ—¶é—´è½®è·¨åº¦ä¸º 8000msã€‚æ¯ä¸€å±‚æ—¶é—´è½®éƒ½æœ‰è‡ªå·±çš„æŒ‡é’ˆï¼Œæ¯å±‚æ—¶é—´è½®èµ°å®Œä¸€åœˆåï¼Œä¸Šå±‚æ—¶é—´è½®ä¹Ÿä¼šç›¸åº”æ¨è¿›ä¸€æ ¼ã€‚</p>
<p>å‡è®¾ç°åœ¨æœ‰ä¸€ä¸ªä»»åŠ¡åˆ°æœŸæ—¶é—´æ˜¯ 450ms ä¹‹åï¼Œåº”è¯¥æ”¾åœ¨ç¬¬ä¸‰å±‚æ—¶é—´è½®çš„ç¬¬ä¸€æ ¼ã€‚éšç€æ—¶é—´çš„æµé€ï¼Œå½“æŒ‡é’ˆæŒ‡å‘è¯¥æ—¶é—´æ ¼æ—¶ï¼Œå‘ç°ä»»åŠ¡åˆ°æœŸæ—¶é—´è¿˜æœ‰ 50msï¼Œè¿™é‡Œå°±æ¶‰åŠæ—¶é—´è½®é™çº§çš„æ“ä½œï¼Œå®ƒä¼šå°†ä»»åŠ¡é‡æ–°æäº¤åˆ°æ—¶é—´è½®ä¸­ã€‚æ­¤æ—¶å‘ç°ç¬¬ä¸€å±‚æ—¶é—´è½®æ•´ä½“è·¨åº¦ä¸å¤Ÿï¼Œéœ€è¦æ”¾åœ¨ç¬¬äºŒå±‚æ—¶é—´è½®ä¸­ç¬¬ä¸‰æ ¼ã€‚å½“æ—¶é—´å†ç»å† 40ms ä¹‹åï¼Œè¯¥ä»»åŠ¡åˆä¼šè§¦å‘ä¸€æ¬¡é™çº§æ“ä½œï¼Œæ”¾å…¥åˆ°ç¬¬ä¸€å±‚æ—¶é—´è½®ï¼Œæœ€åç­‰åˆ° 10ms åæ‰§è¡Œä»»åŠ¡ã€‚</p>
<p>ç”±æ­¤å¯è§ï¼ŒKafka çš„å±‚çº§æ—¶é—´è½®çš„æ—¶é—´ç²’åº¦æ›´å¥½æ§åˆ¶ï¼Œå¯ä»¥åº”å¯¹æ›´åŠ å¤æ‚çš„å®šæ—¶ä»»åŠ¡å¤„ç†åœºæ™¯ï¼Œé€‚ç”¨çš„èŒƒå›´æ›´å¹¿ã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>HashedWheelTimer çš„æºç é€šä¿—æ˜“æ‡‚ï¼Œå…¶è®¾è®¡æ€æƒ³å€¼å¾—æˆ‘ä»¬å€Ÿé‰´ã€‚åœ¨å¹³æ—¶å¼€å‘ä¸­å¦‚æœæœ‰ç±»ä¼¼çš„ä»»åŠ¡å¤„ç†æœºåˆ¶ï¼Œä½ å¯ä»¥å°è¯•å¥—ç”¨ HashedWheelTimer çš„å·¥ä½œæ¨¡å¼ã€‚</p>
<p>HashedWheelTimer å¹¶ä¸æ˜¯åå…¨åç¾çš„ï¼Œä½¿ç”¨çš„æ—¶å€™éœ€è¦æ¸…æ¥šå®ƒå­˜åœ¨çš„é—®é¢˜ï¼š</p>
<ul>
<li>å¦‚æœé•¿æ—¶é—´æ²¡æœ‰åˆ°æœŸä»»åŠ¡ï¼Œé‚£ä¹ˆä¼šå­˜åœ¨æ—¶é—´è½®ç©ºæ¨è¿›çš„ç°è±¡ã€‚</li>
<li>åªé€‚ç”¨äºå¤„ç†è€—æ—¶è¾ƒçŸ­çš„ä»»åŠ¡ï¼Œç”±äº Worker æ˜¯å•çº¿ç¨‹çš„ï¼Œå¦‚æœä¸€ä¸ªä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´è¿‡é•¿ï¼Œä¼šé€ æˆ Worker çº¿ç¨‹é˜»å¡ã€‚</li>
<li>ç›¸æ¯”ä¼ ç»Ÿå®šæ—¶å™¨çš„å®ç°æ–¹å¼ï¼Œå†…å­˜å ç”¨è¾ƒå¤§ã€‚</li>
</ul>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/20-%E6%8A%80%E5%B7%A7%E7%AF%87netty-%E7%9A%84-fastthreadlocal-%E7%A9%B6%E7%AB%9F%E6%AF%94-threadlocal-%E5%BF%AB%E5%9C%A8%E5%93%AA%E5%84%BF/"><span>20 æŠ€å·§ç¯‡ï¼šNetty çš„ FastThreadLocal ç©¶ç«Ÿæ¯” ThreadLocal å¿«åœ¨å“ªå„¿ï¼Ÿ</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/22-%E6%8A%80%E5%B7%A7%E7%AF%87%E9%AB%98%E6%80%A7%E8%83%BD%E6%97%A0%E9%94%81%E9%98%9F%E5%88%97-mpsc-queue/"><span>22 æŠ€å·§ç¯‡ï¼šé«˜æ€§èƒ½æ— é”é˜Ÿåˆ— Mpsc Queue</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 28280 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>