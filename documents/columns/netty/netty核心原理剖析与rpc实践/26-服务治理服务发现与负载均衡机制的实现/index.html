<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>26 æœåŠ¡æ²»ç†ï¼šæœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡æœºåˆ¶çš„å®ç° | Yipsen Ye</title>
<meta name="description" content="åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼ŒæœåŠ¡æ¶ˆè´¹è€…å’ŒæœåŠ¡æä¾›è€…éƒ½å­˜åœ¨å¤šä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœæœåŠ¡æä¾›è€…å‡ºç°éƒ¨åˆ†æœºå™¨èŠ‚ç‚¹è´Ÿè½½è¿‡é«˜ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå¯¼è‡´è¯¥èŠ‚ç‚¹ä¸Šæ¥æ”¶çš„è¯·æ±‚å¤„ç†è¶…æ—¶ï¼Œä»è€Œå¯¼è‡´æœåŠ¡æä¾›è€…æ•´ä½“å¯ç”¨ç‡ä¸‹é™ã€‚æ‰€ä»¥ RPC æ¡†æ¶éœ€è¦å®ç°åˆç†çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œé‚£ä¹ˆå¦‚ä½•æ§åˆ¶æµé‡èƒ½å¤Ÿå‡åŒ€åœ°åˆ†æ‘Šåˆ°æ¯ä¸ªæœåŠ¡æä¾›è€…å‘¢ï¼Ÿä»Šå¤©è¿™èŠ‚è¯¾æˆ‘ä»¬ä¾¿è®¨è®º RPC æ¡†æ¶è´Ÿè½½å‡è¡¡æœºåˆ¶çš„ç›¸å…³å®ç°ã€‚
 æºç å‚è€ƒåœ°å€ï¼šmini-rpc
 æ³¨å†Œä¸­å¿ƒé€‰å‹ æœåŠ¡æ¶ˆè´¹è€…åœ¨å‘èµ· RPC è°ƒç”¨ä¹‹å‰ï¼Œéœ€è¦çŸ¥é“æœåŠ¡æä¾›è€…æœ‰å“ªäº›èŠ‚ç‚¹æ˜¯å¯ç”¨çš„ï¼Œè€Œä¸”æœåŠ¡æä¾›è€…èŠ‚ç‚¹ä¼šå­˜åœ¨ä¸Šçº¿å’Œä¸‹çº¿çš„æƒ…å†µã€‚æ‰€ä»¥æœåŠ¡æ¶ˆè´¹è€…éœ€è¦æ„ŸçŸ¥æœåŠ¡æä¾›è€…çš„èŠ‚ç‚¹åˆ—è¡¨çš„åŠ¨æ€å˜åŒ–ï¼Œåœ¨ RPC æ¡†æ¶ä¸­ä¸€èˆ¬é‡‡ç”¨æ³¨å†Œä¸­å¿ƒæ¥å®ç°æœåŠ¡çš„æ³¨å†Œå’Œå‘ç°ã€‚
ç›®å‰ä¸»æµçš„æ³¨å†Œä¸­å¿ƒæœ‰ ZooKeeperã€Eurekaã€Etcdã€Consulã€Nacos ç­‰ï¼Œé€‰æ‹©ä¸€ä¸ªé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„æ³¨å†Œä¸­å¿ƒå¯¹ RPC æ¡†æ¶è‡³å…³é‡è¦ã€‚è¯´åˆ°é«˜å¯ç”¨è‡ªç„¶ç¦»ä¸å¼€ CAP ç†è®ºï¼Œä¸€è‡´æ€§ Consistencyã€å¯ç”¨æ€§ Availability å’Œåˆ†åŒºå®¹å¿æ€§ Partition tolerance æ˜¯æ— æ³•åŒæ—¶æ»¡è¶³çš„ï¼Œæ³¨å†Œä¸­å¿ƒä¸€èˆ¬åˆ†ä¸º CP ç±»å‹æ³¨å†Œä¸­å¿ƒå’Œ AP ç±»å‹æ³¨å†Œä¸­å¿ƒã€‚ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„ Zookeeper å°±æ˜¯ CP ç±»å‹çš„æ³¨å†Œä¸­å¿ƒï¼Œé›†ç¾¤ä¸­ä¼šæœ‰ä¸€ä¸ªèŠ‚ç‚¹ä½œä¸º Leaderï¼Œå¦‚æœ Leader èŠ‚ç‚¹æŒ‚äº†ï¼Œä¼šé‡æ–°è¿›è¡Œ Leader é€‰ä¸¾ï¼ŒZooKeeper ä¿è¯äº†æ‰€æœ‰èŠ‚ç‚¹çš„å¼ºä¸€è‡´æ€§ï¼Œä½†æ˜¯åœ¨ Leader é€‰ä¸¾çš„è¿‡ç¨‹ä¸­æ˜¯æ— æ³•å¯¹å¤–æä¾›æœåŠ¡çš„ï¼Œç‰ºç‰²äº†éƒ¨åˆ†å¯ç”¨æ€§ã€‚Eureka æ˜¯å…¸å‹çš„ AP ç±»å‹æ³¨å†Œä¸­å¿ƒï¼Œåœ¨å®ç°æœåŠ¡å‘ç°çš„åœºæ™¯ä¸‹æœ‰å¾ˆå¤§çš„ä¼˜åŠ¿ï¼Œæ•´ä¸ªé›†ç¾¤æ˜¯ä¸å­˜åœ¨ Leaderã€Flower æ¦‚å¿µçš„ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œè¯·æ±‚ä¼šç«‹åˆ»è½¬ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šã€‚å¯èƒ½ä¼šå­˜åœ¨çš„é—®é¢˜æ˜¯å¦‚æœä¸åŒåˆ†åŒºæ— æ³•è¿›è¡ŒèŠ‚ç‚¹é€šä¿¡ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šé€ æˆèŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®æ˜¯æœ‰å·®å¼‚çš„ï¼Œæ‰€ä»¥ AP ç±»å‹çš„æ³¨å†Œä¸­å¿ƒé€šè¿‡ç‰ºç‰²å¼ºä¸€è‡´æ€§æ¥ä¿è¯é«˜å¯ç”¨æ€§ ã€‚
å¯¹äº RPC æ¡†æ¶è€Œè¨€ï¼Œå³ä½¿æ³¨å†Œä¸­å¿ƒå‡ºç°é—®é¢˜ï¼Œä¹Ÿä¸åº”è¯¥å½±å“æœåŠ¡çš„æ­£å¸¸è°ƒç”¨ï¼Œæ‰€ä»¥ AP ç±»å‹çš„æ³¨å†Œä¸­å¿ƒåœ¨è¯¥åœºæ™¯ä¸‹ç›¸æ¯”äº CP ç±»å‹çš„æ³¨å†Œä¸­å¿ƒæ›´æœ‰ä¼˜åŠ¿ã€‚å¯¹äºæˆç†Ÿçš„ RPC æ¡†æ¶è€Œè¨€ï¼Œä¼šæä¾›å¤šç§æ³¨å†Œä¸­å¿ƒçš„é€‰æ‹©ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¾¿è®¾è®¡ä¸€ä¸ªé€šç”¨çš„æ³¨å†Œä¸­å¿ƒæ¥å£ï¼Œç„¶åæ¯ç§æ³¨å†Œä¸­å¿ƒçš„å®ç°éƒ½æŒ‰è¯¥æ¥å£è§„èŒƒè¡Œæ‰©å±•ã€‚
æ³¨å†Œä¸­å¿ƒæ¥å£è®¾è®¡ æ³¨å†Œä¸­å¿ƒä¸»è¦ç”¨äºå­˜å‚¨æœåŠ¡çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å°†æœåŠ¡å…ƒæ•°æ®ä¿¡æ¯å°è£…æˆä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…æ‹¬æœåŠ¡åç§°ã€æœåŠ¡ç‰ˆæœ¬ã€æœåŠ¡åœ°å€å’ŒæœåŠ¡ç«¯å£å·ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
@Datapublic class ServiceMeta {private String serviceName;private String serviceVersion;private String serviceAddr;private int servicePort;}æ¥ä¸‹æ¥æˆ‘ä»¬æä¾›ä¸€ä¸ªé€šç”¨çš„æ³¨å†Œä¸­å¿ƒæ¥å£ï¼Œè¯¥æ¥å£ä¸»è¦çš„æ“ä½œå¯¹è±¡æ˜¯ ServiceMetaï¼Œä¸åº”è¯¥ä¸å…¶ä»–ä»»ä½•ç¬¬ä¸‰æ–¹çš„æ³¨å†Œä¸­å¿ƒå·¥å…·åº“æœ‰ä»»ä½•è”ç³»ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/netty%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e5%89%96%e6%9e%90%e4%b8%8erpc%e5%ae%9e%e8%b7%b5/">Nettyæ ¸å¿ƒåŸç†å‰–æä¸RPCå®è·µ</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/00-%E5%AD%A6%E5%A5%BD-netty%E6%98%AF%E4%BD%A0%E4%BF%AE%E7%82%BC-java-%E5%86%85%E5%8A%9F%E7%9A%84%E5%BF%85%E7%BB%8F%E4%B9%8B%E8%B7%AF/">00 å­¦å¥½ Nettyï¼Œæ˜¯ä½ ä¿®ç‚¼ Java å†…åŠŸçš„å¿…ç»ä¹‹è·¯</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/01-%E5%88%9D%E8%AF%86-netty%E4%B8%BA%E4%BB%80%E4%B9%88-netty-%E8%BF%99%E4%B9%88%E6%B5%81%E8%A1%8C/">01 åˆè¯† Nettyï¼šä¸ºä»€ä¹ˆ Netty è¿™ä¹ˆæµè¡Œï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/02-%E7%BA%B5%E8%A7%88%E5%85%A8%E5%B1%80%E6%8A%8A%E6%8F%A1-netty-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E8%84%89%E7%BB%9C/">02 çºµè§ˆå…¨å±€ï¼šæŠŠæ¡ Netty æ•´ä½“æ¶æ„è„‰ç»œ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/03-%E5%BC%95%E5%AF%BC%E5%99%A8%E4%BD%9C%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E9%83%BD%E8%A6%81%E5%81%9A%E4%BA%9B%E4%BB%80%E4%B9%88/">03 å¼•å¯¼å™¨ä½œç”¨ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¯åŠ¨éƒ½è¦åšäº›ä»€ä¹ˆï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/04-%E4%BA%8B%E4%BB%B6%E8%B0%83%E5%BA%A6%E5%B1%82%E4%B8%BA%E4%BB%80%E4%B9%88-eventloop-%E6%98%AF-netty-%E7%9A%84%E7%B2%BE%E9%AB%93/">04 äº‹ä»¶è°ƒåº¦å±‚ï¼šä¸ºä»€ä¹ˆ EventLoop æ˜¯ Netty çš„ç²¾é«“ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/05-%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92%E5%B1%82pipeline-%E5%A6%82%E4%BD%95%E5%8D%8F%E8%B0%83%E5%90%84%E7%B1%BB-handler-/">05 æœåŠ¡ç¼–æ’å±‚ï¼šPipeline å¦‚ä½•åè°ƒå„ç±» Handler ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/06-%E7%B2%98%E5%8C%85%E6%8B%86%E5%8C%85%E9%97%AE%E9%A2%98%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%95%B4%E7%9A%84%E7%BD%91%E7%BB%9C%E5%8C%85/">06 ç²˜åŒ…æ‹†åŒ…é—®é¢˜ï¼šå¦‚ä½•è·å–ä¸€ä¸ªå®Œæ•´çš„ç½‘ç»œåŒ…ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/07-%E6%8E%A5%E5%A4%B4%E6%9A%97%E8%AF%AD%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8-netty-%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E9%80%9A%E4%BF%A1/">07 æ¥å¤´æš—è¯­ï¼šå¦‚ä½•åˆ©ç”¨ Netty å®ç°è‡ªå®šä¹‰åè®®é€šä¿¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/08-%E5%BC%80%E7%AE%B1%E5%8D%B3%E7%94%A8netty-%E6%94%AF%E6%8C%81%E5%93%AA%E4%BA%9B%E5%B8%B8%E7%94%A8%E7%9A%84%E8%A7%A3%E7%A0%81%E5%99%A8/">08 å¼€ç®±å³ç”¨ï¼šNetty æ”¯æŒå“ªäº›å¸¸ç”¨çš„è§£ç å™¨ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/09-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93writeandflush-%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E5%89%96%E6%9E%90/">09 æ•°æ®ä¼ è¾“ï¼šwriteAndFlush å¤„ç†æµç¨‹å‰–æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/10-%E5%8F%8C%E5%88%83%E5%89%91%E5%90%88%E7%90%86%E7%AE%A1%E7%90%86-netty-%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98/">10 åŒåˆƒå‰‘ï¼šåˆç†ç®¡ç† Netty å †å¤–å†…å­˜</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/11-%E5%8F%A6%E8%B5%B7%E7%82%89%E7%81%B6netty-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E8%BD%BD%E4%BD%93-bytebuf-%E8%AF%A6%E8%A7%A3/">11 å¦èµ·ç‚‰ç¶ï¼šNetty æ•°æ®ä¼ è¾“è½½ä½“ ByteBuf è¯¦è§£</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/12-%E4%BB%96%E5%B1%B1%E4%B9%8B%E7%9F%B3%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%99%A8-jemalloc-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/">12 ä»–å±±ä¹‹çŸ³ï¼šé«˜æ€§èƒ½å†…å­˜åˆ†é…å™¨ jemalloc åŸºæœ¬åŸç†</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/13-%E4%B8%BE%E4%B8%80%E5%8F%8D%E4%B8%89netty-%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E8%AE%BE%E8%AE%A1%E4%B8%8A/">13 ä¸¾ä¸€åä¸‰ï¼šNetty é«˜æ€§èƒ½å†…å­˜ç®¡ç†è®¾è®¡ï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/14-%E4%B8%BE%E4%B8%80%E5%8F%8D%E4%B8%89netty-%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E8%AE%BE%E8%AE%A1%E4%B8%8B/">14 ä¸¾ä¸€åä¸‰ï¼šNetty é«˜æ€§èƒ½å†…å­˜ç®¡ç†è®¾è®¡ï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/15-%E8%BD%BB%E9%87%8F%E7%BA%A7%E5%AF%B9%E8%B1%A1%E5%9B%9E%E6%94%B6%E7%AB%99recycler-%E5%AF%B9%E8%B1%A1%E6%B1%A0%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90/">15 è½»é‡çº§å¯¹è±¡å›æ”¶ç«™ï¼šRecycler å¯¹è±¡æ± æŠ€æœ¯è§£æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/16-io-%E5%8A%A0%E9%80%9F%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%E7%9A%84-netty-%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF/">16 IO åŠ é€Ÿï¼šä¸ä¼—ä¸åŒçš„ Netty é›¶æ‹·è´æŠ€æœ¯</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/17-%E6%BA%90%E7%A0%81%E7%AF%87%E4%BB%8E-linux-%E5%87%BA%E5%8F%91%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">17 æºç ç¯‡ï¼šä» Linux å‡ºå‘æ·±å…¥å‰–ææœåŠ¡ç«¯å¯åŠ¨æµç¨‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/18-%E6%BA%90%E7%A0%81%E7%AF%87%E8%A7%A3%E5%AF%86-netty-reactor-%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/">18 æºç ç¯‡ï¼šè§£å¯† Netty Reactor çº¿ç¨‹æ¨¡å‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/19-%E6%BA%90%E7%A0%81%E7%AF%87%E4%B8%80%E4%B8%AA%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E5%9C%A8-netty-%E4%B8%AD%E7%9A%84%E6%97%85%E7%A8%8B/">19 æºç ç¯‡ï¼šä¸€ä¸ªç½‘ç»œè¯·æ±‚åœ¨ Netty ä¸­çš„æ—…ç¨‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/20-%E6%8A%80%E5%B7%A7%E7%AF%87netty-%E7%9A%84-fastthreadlocal-%E7%A9%B6%E7%AB%9F%E6%AF%94-threadlocal-%E5%BF%AB%E5%9C%A8%E5%93%AA%E5%84%BF/">20 æŠ€å·§ç¯‡ï¼šNetty çš„ FastThreadLocal ç©¶ç«Ÿæ¯” ThreadLocal å¿«åœ¨å“ªå„¿ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/21-%E6%8A%80%E5%B7%A7%E7%AF%87%E5%BB%B6%E8%BF%9F%E4%BB%BB%E5%8A%A1%E5%A4%84%E7%90%86%E7%A5%9E%E5%99%A8%E4%B9%8B%E6%97%B6%E9%97%B4%E8%BD%AE-hashedwheeltimer/">21 æŠ€å·§ç¯‡ï¼šå»¶è¿Ÿä»»åŠ¡å¤„ç†ç¥å™¨ä¹‹æ—¶é—´è½® HashedWheelTimer</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/22-%E6%8A%80%E5%B7%A7%E7%AF%87%E9%AB%98%E6%80%A7%E8%83%BD%E6%97%A0%E9%94%81%E9%98%9F%E5%88%97-mpsc-queue/">22 æŠ€å·§ç¯‡ï¼šé«˜æ€§èƒ½æ— é”é˜Ÿåˆ— Mpsc Queue</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/23-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E9%AB%98%E6%80%A7%E8%83%BD%E5%88%86%E5%B8%83%E5%BC%8F-rpc-%E6%A1%86%E6%9E%B6/">23 æ¶æ„è®¾è®¡ï¼šå¦‚ä½•å®ç°ä¸€ä¸ªé«˜æ€§èƒ½åˆ†å¸ƒå¼ RPC æ¡†æ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/24-%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E4%B8%8E%E8%AE%A2%E9%98%85%E6%90%AD%E5%BB%BA%E7%94%9F%E4%BA%A7%E8%80%85%E5%92%8C%E6%B6%88%E8%B4%B9%E8%80%85%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A1%86%E6%9E%B6/">24 æœåŠ¡å‘å¸ƒä¸è®¢é˜…ï¼šæ­å»ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åŸºç¡€æ¡†æ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/25-%E8%BF%9C%E7%A8%8B%E9%80%9A%E4%BF%A1%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE%E8%AE%BE%E8%AE%A1%E4%BB%A5%E5%8F%8A%E7%BC%96%E8%A7%A3%E7%A0%81%E7%9A%84%E5%AE%9E%E7%8E%B0/">25 è¿œç¨‹é€šä¿¡ï¼šé€šä¿¡åè®®è®¾è®¡ä»¥åŠç¼–è§£ç çš„å®ç°</a></li>
                
                
                
                    <li>26 æœåŠ¡æ²»ç†ï¼šæœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡æœºåˆ¶çš„å®ç°</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/27-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%BA%E7%94%A8%E6%88%B7%E5%B1%8F%E8%94%BD-rpc-%E8%B0%83%E7%94%A8%E7%9A%84%E5%BA%95%E5%B1%82%E7%BB%86%E8%8A%82/">27 åŠ¨æ€ä»£ç†ï¼šä¸ºç”¨æˆ·å±è”½ RPC è°ƒç”¨çš„åº•å±‚ç»†èŠ‚</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/28-%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93rpc-%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93%E4%B8%8E%E8%BF%9B%E9%98%B6%E5%BB%B6%E4%BC%B8/">28 å®æˆ˜æ€»ç»“ï¼šRPC å®æˆ˜æ€»ç»“ä¸è¿›é˜¶å»¶ä¼¸</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/29-%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3netty-%E4%B8%AD%E5%BA%94%E7%94%A8%E4%BA%86%E5%93%AA%E4%BA%9B%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">29 ç¼–ç¨‹æ€æƒ³ï¼šNetty ä¸­åº”ç”¨äº†å“ªäº›è®¾è®¡æ¨¡å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/30-%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93netty-%E5%9C%A8%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">30 å®è·µæ€»ç»“ï¼šNetty åœ¨é¡¹ç›®å¼€å‘ä¸­çš„ä¸€äº›æœ€ä½³å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/31-%E7%BB%93%E6%9D%9F%E8%AF%AD-%E6%8A%80%E6%9C%AF%E6%88%90%E9%95%BF%E4%B9%8B%E8%B7%AF%E5%A6%82%E4%BD%95%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB/">31 ç»“æŸè¯­ æŠ€æœ¯æˆé•¿ä¹‹è·¯ï¼šå¦‚ä½•æ‰“é€ è‡ªå·±çš„æŠ€æœ¯ä½“ç³»</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">26 æœåŠ¡æ²»ç†ï¼šæœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡æœºåˆ¶çš„å®ç°</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2021-12-22 01:54:48</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/netty/">netty</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/">Nettyæ ¸å¿ƒåŸç†å‰–æä¸RPCå®è·µ</a>
                
            </div></div>
        <div class="post-content">
            <p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼ŒæœåŠ¡æ¶ˆè´¹è€…å’ŒæœåŠ¡æä¾›è€…éƒ½å­˜åœ¨å¤šä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœæœåŠ¡æä¾›è€…å‡ºç°éƒ¨åˆ†æœºå™¨èŠ‚ç‚¹è´Ÿè½½è¿‡é«˜ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå¯¼è‡´è¯¥èŠ‚ç‚¹ä¸Šæ¥æ”¶çš„è¯·æ±‚å¤„ç†è¶…æ—¶ï¼Œä»è€Œå¯¼è‡´æœåŠ¡æä¾›è€…æ•´ä½“å¯ç”¨ç‡ä¸‹é™ã€‚æ‰€ä»¥ RPC æ¡†æ¶éœ€è¦å®ç°åˆç†çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œé‚£ä¹ˆå¦‚ä½•æ§åˆ¶æµé‡èƒ½å¤Ÿå‡åŒ€åœ°åˆ†æ‘Šåˆ°æ¯ä¸ªæœåŠ¡æä¾›è€…å‘¢ï¼Ÿä»Šå¤©è¿™èŠ‚è¯¾æˆ‘ä»¬ä¾¿è®¨è®º RPC æ¡†æ¶è´Ÿè½½å‡è¡¡æœºåˆ¶çš„ç›¸å…³å®ç°ã€‚</p>
<blockquote>
<p>æºç å‚è€ƒåœ°å€ï¼š<a href="https://github.com/wangyapu/mini-rpc">mini-rpc</a></p>
</blockquote>
<h3 id="æ³¨å†Œä¸­å¿ƒé€‰å‹">æ³¨å†Œä¸­å¿ƒé€‰å‹</h3>
<p>æœåŠ¡æ¶ˆè´¹è€…åœ¨å‘èµ· RPC è°ƒç”¨ä¹‹å‰ï¼Œéœ€è¦çŸ¥é“æœåŠ¡æä¾›è€…æœ‰å“ªäº›èŠ‚ç‚¹æ˜¯å¯ç”¨çš„ï¼Œè€Œä¸”æœåŠ¡æä¾›è€…èŠ‚ç‚¹ä¼šå­˜åœ¨ä¸Šçº¿å’Œä¸‹çº¿çš„æƒ…å†µã€‚æ‰€ä»¥æœåŠ¡æ¶ˆè´¹è€…éœ€è¦æ„ŸçŸ¥æœåŠ¡æä¾›è€…çš„èŠ‚ç‚¹åˆ—è¡¨çš„åŠ¨æ€å˜åŒ–ï¼Œåœ¨ RPC æ¡†æ¶ä¸­ä¸€èˆ¬é‡‡ç”¨æ³¨å†Œä¸­å¿ƒæ¥å®ç°æœåŠ¡çš„æ³¨å†Œå’Œå‘ç°ã€‚</p>
<p>ç›®å‰ä¸»æµçš„æ³¨å†Œä¸­å¿ƒæœ‰ ZooKeeperã€Eurekaã€Etcdã€Consulã€Nacos ç­‰ï¼Œé€‰æ‹©ä¸€ä¸ªé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„æ³¨å†Œä¸­å¿ƒå¯¹ RPC æ¡†æ¶è‡³å…³é‡è¦ã€‚è¯´åˆ°é«˜å¯ç”¨è‡ªç„¶ç¦»ä¸å¼€ CAP ç†è®ºï¼Œä¸€è‡´æ€§ Consistencyã€å¯ç”¨æ€§ Availability å’Œåˆ†åŒºå®¹å¿æ€§ Partition tolerance æ˜¯æ— æ³•åŒæ—¶æ»¡è¶³çš„ï¼Œæ³¨å†Œä¸­å¿ƒä¸€èˆ¬åˆ†ä¸º CP ç±»å‹æ³¨å†Œä¸­å¿ƒå’Œ AP ç±»å‹æ³¨å†Œä¸­å¿ƒã€‚ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„ Zookeeper å°±æ˜¯ CP ç±»å‹çš„æ³¨å†Œä¸­å¿ƒï¼Œé›†ç¾¤ä¸­ä¼šæœ‰ä¸€ä¸ªèŠ‚ç‚¹ä½œä¸º Leaderï¼Œå¦‚æœ Leader èŠ‚ç‚¹æŒ‚äº†ï¼Œä¼šé‡æ–°è¿›è¡Œ Leader é€‰ä¸¾ï¼ŒZooKeeper ä¿è¯äº†æ‰€æœ‰èŠ‚ç‚¹çš„å¼ºä¸€è‡´æ€§ï¼Œä½†æ˜¯åœ¨ Leader é€‰ä¸¾çš„è¿‡ç¨‹ä¸­æ˜¯æ— æ³•å¯¹å¤–æä¾›æœåŠ¡çš„ï¼Œç‰ºç‰²äº†éƒ¨åˆ†å¯ç”¨æ€§ã€‚Eureka æ˜¯å…¸å‹çš„ AP ç±»å‹æ³¨å†Œä¸­å¿ƒï¼Œåœ¨å®ç°æœåŠ¡å‘ç°çš„åœºæ™¯ä¸‹æœ‰å¾ˆå¤§çš„ä¼˜åŠ¿ï¼Œæ•´ä¸ªé›†ç¾¤æ˜¯ä¸å­˜åœ¨ Leaderã€Flower æ¦‚å¿µçš„ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œè¯·æ±‚ä¼šç«‹åˆ»è½¬ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šã€‚å¯èƒ½ä¼šå­˜åœ¨çš„é—®é¢˜æ˜¯å¦‚æœä¸åŒåˆ†åŒºæ— æ³•è¿›è¡ŒèŠ‚ç‚¹é€šä¿¡ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šé€ æˆèŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®æ˜¯æœ‰å·®å¼‚çš„ï¼Œæ‰€ä»¥ AP ç±»å‹çš„æ³¨å†Œä¸­å¿ƒé€šè¿‡ç‰ºç‰²å¼ºä¸€è‡´æ€§æ¥ä¿è¯é«˜å¯ç”¨æ€§ ã€‚</p>
<p>å¯¹äº RPC æ¡†æ¶è€Œè¨€ï¼Œå³ä½¿æ³¨å†Œä¸­å¿ƒå‡ºç°é—®é¢˜ï¼Œä¹Ÿä¸åº”è¯¥å½±å“æœåŠ¡çš„æ­£å¸¸è°ƒç”¨ï¼Œæ‰€ä»¥ AP ç±»å‹çš„æ³¨å†Œä¸­å¿ƒåœ¨è¯¥åœºæ™¯ä¸‹ç›¸æ¯”äº CP ç±»å‹çš„æ³¨å†Œä¸­å¿ƒæ›´æœ‰ä¼˜åŠ¿ã€‚å¯¹äºæˆç†Ÿçš„ RPC æ¡†æ¶è€Œè¨€ï¼Œä¼šæä¾›å¤šç§æ³¨å†Œä¸­å¿ƒçš„é€‰æ‹©ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¾¿è®¾è®¡ä¸€ä¸ªé€šç”¨çš„æ³¨å†Œä¸­å¿ƒæ¥å£ï¼Œç„¶åæ¯ç§æ³¨å†Œä¸­å¿ƒçš„å®ç°éƒ½æŒ‰è¯¥æ¥å£è§„èŒƒè¡Œæ‰©å±•ã€‚</p>
<h3 id="æ³¨å†Œä¸­å¿ƒæ¥å£è®¾è®¡">æ³¨å†Œä¸­å¿ƒæ¥å£è®¾è®¡</h3>
<p>æ³¨å†Œä¸­å¿ƒä¸»è¦ç”¨äºå­˜å‚¨æœåŠ¡çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å°†æœåŠ¡å…ƒæ•°æ®ä¿¡æ¯å°è£…æˆä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…æ‹¬æœåŠ¡åç§°ã€æœåŠ¡ç‰ˆæœ¬ã€æœåŠ¡åœ°å€å’ŒæœåŠ¡ç«¯å£å·ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@Data

public class ServiceMeta {

    private String serviceName;

    private String serviceVersion;

    private String serviceAddr;

    private int servicePort;

}
</code></pre><p>æ¥ä¸‹æ¥æˆ‘ä»¬æä¾›ä¸€ä¸ªé€šç”¨çš„æ³¨å†Œä¸­å¿ƒæ¥å£ï¼Œè¯¥æ¥å£ä¸»è¦çš„æ“ä½œå¯¹è±¡æ˜¯ ServiceMetaï¼Œä¸åº”è¯¥ä¸å…¶ä»–ä»»ä½•ç¬¬ä¸‰æ–¹çš„æ³¨å†Œä¸­å¿ƒå·¥å…·åº“æœ‰ä»»ä½•è”ç³»ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<pre tabindex="0"><code>public interface RegistryService {

    void register(ServiceMeta serviceMeta) throws Exception;

    void unRegister(ServiceMeta serviceMeta) throws Exception;

    ServiceMeta discovery(String serviceName, int invokerHashCode) throws Exception;

    void destroy() throws IOException;

}
</code></pre><p>RegistryService æ¥å£åŒ…å«æ³¨å†Œä¸­å¿ƒå››ä¸ªåŸºæœ¬æ“ä½œï¼š<strong>æœåŠ¡æ³¨å†Œ register</strong>ã€<strong>æœåŠ¡æ³¨é”€ unRegister</strong>ã€<strong>æœåŠ¡å‘ç° discovery</strong>ã€<strong>æ³¨å†Œä¸­å¿ƒé”€æ¯ destroy</strong>ã€‚ä¸‹é¢æˆ‘ä»¬ä»¥ ZooKeeper æ³¨å†Œä¸­å¿ƒå®ç°ä¸ºä¾‹ï¼Œé€ä¸€å®ç°ä¸Šé¢å››ä¸ªæ¥å£ã€‚</p>
<h3 id="æ³¨å†Œä¸­å¿ƒåˆå§‹åŒ–å’Œé”€æ¯">æ³¨å†Œä¸­å¿ƒåˆå§‹åŒ–å’Œé”€æ¯</h3>
<p>Zookeeper å¸¸ç”¨çš„å¼€æºå®¢æˆ·ç«¯å·¥å…·åŒ…æœ‰ ZkClient å’Œ Apache Curatorï¼Œç›®å‰éƒ½æ¨èä½¿ç”¨ Apache Curator å®¢æˆ·ç«¯ã€‚Apache Curator ç›¸æ¯”äº ZkClientï¼Œä¸ä»…æä¾›çš„åŠŸèƒ½æ›´åŠ ä¸°å¯Œï¼Œè€Œä¸”å®ƒçš„æŠ½è±¡å±‚æ¬¡æ›´é«˜ï¼Œæä¾›äº†æ›´åŠ æ˜“ç”¨çš„ API æ¥å£ä»¥åŠ Fluent æµå¼ç¼–ç¨‹é£æ ¼ã€‚åœ¨ä½¿ç”¨ Apache Curator ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ pom.xml ä¸­å¼•å…¥ Maven ä¾èµ–ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>&lt;dependency&gt;

    &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;

    &lt;artifactId&gt;curator-framework&lt;/artifactId&gt;

    &lt;version&gt;2.12.0&lt;/version&gt;

    &lt;exclusions&gt;

        &lt;exclusion&gt;

            &lt;groupId&gt;log4j&lt;/groupId&gt;

            &lt;artifactId&gt;log4j&lt;/artifactId&gt;

        &lt;/exclusion&gt;

    &lt;/exclusions&gt;

&lt;/dependency&gt;

&lt;dependency&gt;

    &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;

    &lt;artifactId&gt;curator-recipes&lt;/artifactId&gt;

    &lt;version&gt;2.12.0&lt;/version&gt;

&lt;/dependency&gt;

&lt;dependency&gt;

    &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;

    &lt;artifactId&gt;curator-x-discovery&lt;/artifactId&gt;

    &lt;version&gt;2.12.0&lt;/version&gt;

&lt;/dependency&gt;
</code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒApache Curator éœ€è¦å’Œ Zookeeeper ç‰ˆæœ¬æ­é…ä½¿ç”¨ï¼Œæœ¬é¡¹ç›®ä½¿ç”¨çš„æ˜¯ Zookeeeper 3.4.14ï¼Œå…³äºç‰ˆæœ¬å…¼å®¹æ€§ä½ éœ€è¦æ›´å¤šå…³æ³¨ Curator å®˜ç½‘ï¼ˆ<a href="https://curator.apache.org/">https://curator.apache.org</a>ï¼‰çš„ç‰ˆæœ¬æ›´æ–°è¯´æ˜ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦æ„å»º Zookeeeper çš„å®¢æˆ·ç«¯ï¼Œä½¿ç”¨ Apache Curator åˆå§‹åŒ– Zookeeeper å®¢æˆ·ç«¯çš„åŸºäºç”¨æ³•å¤§å¤šéƒ½ä¸å¦‚ä¸‹ä»£ç ç±»ä¼¼ï¼š</p>
<pre tabindex="0"><code>public class ZookeeperRegistryService implements RegistryService {

    public static final int BASE_SLEEP_TIME_MS = 1000;

    public static final int MAX_RETRIES = 3;

    public static final String ZK_BASE_PATH = &quot;/mini_rpc&quot;;

    private final ServiceDiscovery&lt;ServiceMeta&gt; serviceDiscovery;

    public ZookeeperRegistryService(String registryAddr) throws Exception {

        CuratorFramework client = CuratorFrameworkFactory.newClient(registryAddr, new ExponentialBackoffRetry(BASE_SLEEP_TIME_MS, MAX_RETRIES));

        client.start();

        JsonInstanceSerializer&lt;ServiceMeta&gt; serializer = new JsonInstanceSerializer&lt;&gt;(ServiceMeta.class);

        this.serviceDiscovery = ServiceDiscoveryBuilder.builder(ServiceMeta.class)

                .client(client)

                .serializer(serializer)

                .basePath(ZK_BASE_PATH)

                .build();

        this.serviceDiscovery.start();

    }

}
</code></pre><p>é€šè¿‡ CuratorFrameworkFactory é‡‡ç”¨å·¥å‚æ¨¡å¼åˆ›å»º CuratorFramework å®ä¾‹ï¼Œæ„é€ å®¢æˆ·ç«¯å”¯ä¸€éœ€ä½ æŒ‡å®šçš„æ˜¯é‡è¯•ç­–ç•¥ï¼Œåˆ›å»ºå®Œ CuratorFramework å®ä¾‹ä¹‹åéœ€è¦è°ƒç”¨ start() è¿›è¡Œå¯åŠ¨ã€‚ç„¶åæˆ‘ä»¬éœ€è¦åˆ›å»º ServiceDiscovery å¯¹è±¡ï¼Œç”± ServiceDiscovery å®ŒæˆæœåŠ¡çš„æ³¨å†Œå’Œå‘ç°ï¼Œåœ¨ç³»ç»Ÿé€€å‡ºçš„æ—¶å€™éœ€è¦å°†åˆå§‹åŒ–çš„å®ä¾‹è¿›è¡Œå…³é—­ï¼Œdestroy() æ–¹æ³•å®ç°éå¸¸ç®€å•ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@Override

public void destroy() throws IOException {

    serviceDiscovery.close();

}
</code></pre><h3 id="æœåŠ¡æ³¨å†Œå®ç°">æœåŠ¡æ³¨å†Œå®ç°</h3>
<p>åˆå§‹åŒ–å¾—åˆ° ServiceDiscovery å®ä¾‹ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†æœåŠ¡å…ƒæ•°æ®ä¿¡æ¯ ServiceMeta å‘å¸ƒåˆ°æ³¨å†Œä¸­å¿ƒï¼Œregister() æ–¹æ³•çš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@Override

public void register(ServiceMeta serviceMeta) throws Exception {

    ServiceInstance&lt;ServiceMeta&gt; serviceInstance = ServiceInstance

            .&lt;ServiceMeta&gt;builder()

            .name(RpcServiceHelper.buildServiceKey(serviceMeta.getServiceName(), serviceMeta.getServiceVersion()))

            .address(serviceMeta.getServiceAddr())

            .port(serviceMeta.getServicePort())

            .payload(serviceMeta)

            .build();

    serviceDiscovery.registerService(serviceInstance);

}
</code></pre><p>ServiceInstance å¯¹è±¡ä»£è¡¨ä¸€ä¸ªæœåŠ¡å®ä¾‹ï¼Œå®ƒåŒ…å«åç§° nameã€å”¯ä¸€æ ‡è¯† idã€åœ°å€ addressã€ç«¯å£ port ä»¥åŠç”¨æˆ·è‡ªå®šä¹‰çš„å¯é€‰å±æ€§ payloadï¼Œæˆ‘ä»¬æœ‰å¿…è¦äº†è§£ ServiceInstance åœ¨ Zookeeper æœåŠ¡å™¨ä¸­çš„å­˜å‚¨å½¢å¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/CgpVE1_-X2qAZ0QwAALfB-0Ouy4852.png" alt="Drawing 0.png"></p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬ä¼šå°†ç›¸åŒç‰ˆæœ¬çš„ RPC æœåŠ¡å½’ç±»åœ¨ä¸€èµ·ï¼Œæ‰€ä»¥å¯ä»¥å°† ServiceInstance çš„åç§° name æ ¹æ®æœåŠ¡åç§°å’ŒæœåŠ¡ç‰ˆæœ¬è¿›è¡Œèµ‹å€¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<pre tabindex="0"><code>public class RpcServiceHelper {

    public static String buildServiceKey(String serviceName, String serviceVersion) {

        return String.join(&quot;#&quot;, serviceName, serviceVersion);

    }

}
</code></pre><p>åœ¨ã€ŠæœåŠ¡å‘å¸ƒä¸è®¢é˜…ï¼šæ­å»ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åŸºç¡€æ¡†æ¶ã€‹è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬è®²è§£äº† RpcProvider åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­æ˜¯å¦‚ä½•æ ¹æ® @RpcService æ³¨è§£è¯†åˆ«éœ€è¦å‘å¸ƒçš„æœåŠ¡ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ RegistryService æ¥å£çš„ register() æ–¹æ³•å°†è¯†åˆ«å‡ºçš„æœåŠ¡è¿›è¡Œå‘å¸ƒäº†ï¼Œå®Œå–„åçš„ RpcProvider#postProcessAfterInitialization() æ–¹æ³•å®ç°å¦‚ä¸‹ã€‚</p>
<pre tabindex="0"><code>@Override

public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {

    RpcService rpcService = bean.getClass().getAnnotation(RpcService.class);

    if (rpcService != null) {

        String serviceName = rpcService.serviceInterface().getName();

        String serviceVersion = rpcService.serviceVersion();

        try {

            ServiceMeta serviceMeta = new ServiceMeta();

            serviceMeta.setServiceAddr(serverAddress);

            serviceMeta.setServicePort(serverPort);

            serviceMeta.setServiceName(serviceName);

            serviceMeta.setServiceVersion(serviceVersion);

            serviceRegistry.register(serviceMeta); // æ³¨å†ŒæœåŠ¡

            rpcServiceMap.put(RpcServiceHelper.buildServiceKey(serviceMeta.getServiceName(), serviceMeta.getServiceVersion()), bean);

        } catch (Exception e) {

            log.error(&quot;failed to register service {}#{}&quot;, serviceName, serviceVersion, e);

        }

    }

    return bean;

}
</code></pre><p>è‡³æ­¤ï¼ŒæœåŠ¡æä¾›è€…åœ¨å¯åŠ¨åå°±å¯ä»¥å°† @RpcService æ³¨è§£ä¿®é¥°çš„æœåŠ¡å‘å¸ƒåˆ°æ³¨å†Œä¸­å¿ƒäº†ï¼Œä¸‹é¢æˆ‘ä»¬ç»§ç»­çœ‹çœ‹æœåŠ¡æ¶ˆè´¹è€…åº”å½“å¦‚ä½•é€šè¿‡åˆç†çš„è´Ÿè½½å‡è¡¡ç®—æ³•å¾—åˆ°åˆé€‚çš„æœåŠ¡èŠ‚ç‚¹å‘¢ï¼Ÿåœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹è´Ÿè½½å‡è¡¡ç®—æ³•çš„åŸºç¡€çŸ¥è¯†ã€‚</p>
<h3 id="è´Ÿè½½å‡è¡¡ç®—æ³•åŸºç¡€">è´Ÿè½½å‡è¡¡ç®—æ³•åŸºç¡€</h3>
<p>æœåŠ¡æ¶ˆè´¹è€…åœ¨å‘èµ· RPC è°ƒç”¨ä¹‹å‰ï¼Œéœ€è¦æ„ŸçŸ¥æœ‰å¤šå°‘æœåŠ¡ç«¯èŠ‚ç‚¹å¯ç”¨ï¼Œç„¶åä»ä¸­é€‰å–ä¸€ä¸ªè¿›è¡Œè°ƒç”¨ã€‚ä¹‹å‰æˆ‘ä»¬æåˆ°äº†å‡ ç§å¸¸ç”¨çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼šRound-Robin è½®è¯¢ã€Weighted Round-Robin æƒé‡è½®è¯¢ã€Least Connections æœ€å°‘è¿æ¥æ•°ã€Consistent Hash ä¸€è‡´æ€§ Hash ç­‰ã€‚æœ¬èŠ‚è¯¾æˆ‘ä»¬è®¨è®ºçš„ä¸»è§’æ˜¯åŸºäºä¸€è‡´æ€§ Hash çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œä¸€è‡´æ€§ Hash ç®—æ³•å¯ä»¥ä¿è¯æ¯ä¸ªæœåŠ¡èŠ‚ç‚¹åˆ†æ‘Šçš„æµé‡å°½å¯èƒ½å‡åŒ€ï¼Œè€Œä¸”èƒ½å¤ŸæŠŠæœåŠ¡èŠ‚ç‚¹æ‰©ç¼©å®¹å¸¦æ¥çš„å½±å“é™åˆ°æœ€ä½ã€‚ä¸‹é¢æˆ‘ä»¬ä¸€èµ·çœ‹ä¸‹ä¸€è‡´æ€§ Hash ç®—æ³•çš„è®¾è®¡æ€è·¯ã€‚</p>
<p>åœ¨æœåŠ¡ç«¯èŠ‚ç‚¹æ‰©ç¼©å®¹æ—¶ï¼Œä¸€è‡´æ€§ Hash ç®—æ³•ä¼šå°½å¯èƒ½ä¿è¯å®¢æˆ·ç«¯å‘èµ·çš„ RPC è°ƒç”¨è¿˜æ˜¯å›ºå®šåˆ†é…åˆ°ç›¸åŒçš„æœåŠ¡èŠ‚ç‚¹ä¸Šã€‚ä¸€è‡´æ€§ Hash ç®—æ³•æ˜¯é‡‡ç”¨å“ˆå¸Œç¯æ¥å®ç°çš„ï¼Œé€šè¿‡ Hash å‡½æ•°å°†å¯¹è±¡å’ŒæœåŠ¡å™¨èŠ‚ç‚¹æ”¾ç½®åœ¨å“ˆå¸Œç¯ä¸Šï¼Œä¸€èˆ¬æ¥è¯´æœåŠ¡å™¨å¯ä»¥é€‰æ‹© IP + Port è¿›è¡Œ Hashï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Cip5yF_-X3eAC2U7AAVmjGbnvBo221.png" alt="Drawing 1.png"></p>
<p>å›¾ä¸­ C1ã€C2ã€C3ã€C4 æ˜¯å®¢æˆ·ç«¯å¯¹è±¡ï¼ŒN1ã€N2ã€N3 ä¸ºæœåŠ¡èŠ‚ç‚¹ï¼Œç„¶ååœ¨å“ˆå¸Œç¯ä¸­é¡ºæ—¶é’ˆæŸ¥æ‰¾è·ç¦»å®¢æˆ·ç«¯å¯¹è±¡ Hash å€¼æœ€è¿‘çš„æœåŠ¡èŠ‚ç‚¹ï¼Œå³ä¸ºå®¢æˆ·ç«¯å¯¹åº”è¦è°ƒç”¨çš„æœåŠ¡èŠ‚ç‚¹ã€‚å‡è®¾ç°åœ¨æœåŠ¡èŠ‚ç‚¹æ‰©å®¹äº†ä¸€å° N4ï¼Œç»è¿‡ Hash å‡½æ•°è®¡ç®—å°†å…¶æ”¾å…¥åˆ°å“ˆå¸Œç¯ä¸­ï¼Œå“ˆå¸Œç¯å˜åŒ–å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F_-X32AB67NAAWtkSEKYRo724.png" alt="Drawing 2.png"></p>
<p>æ­¤æ—¶ N2 å’Œ N4 ä¹‹é—´çš„å®¢æˆ·ç«¯å¯¹è±¡éœ€è¦é‡æ–°è¿›è¡Œåˆ†é…ï¼Œå¯ä»¥çœ‹å‡ºåªæœ‰ C3 ä¼šè¢«åˆ†é…åˆ°æ–°çš„èŠ‚ç‚¹ N4 ä¸Šï¼Œå…¶ä»–çš„éƒ½ä¿æŒä¸å˜ã€‚æœåŠ¡èŠ‚ç‚¹ä¸‹çº¿ä¸ä¸Šçº¿çš„å¤„ç†è¿‡ç¨‹æ˜¯ç±»ä¼¼çš„ï¼Œä½ å¯ä»¥è‡ªè¡Œåˆ†æä¸‹æœåŠ¡èŠ‚ç‚¹ä¸‹çº¿æ—¶å“ˆå¸Œç¯æ˜¯å¦‚ä½•å˜åŒ–çš„ã€‚</p>
<p>å¦‚æœæœåŠ¡èŠ‚ç‚¹çš„æ•°é‡å¾ˆå°‘ï¼Œä¸ç®¡ Hash ç®—æ³•å¦‚ä½•ï¼Œå¾ˆå¤§å¯èƒ½å­˜åœ¨æœåŠ¡èŠ‚ç‚¹è´Ÿè½½ä¸å‡çš„ç°è±¡ã€‚è€Œä¸”ä¸Šå›¾ä¸­åœ¨æ–°å¢æœåŠ¡èŠ‚ç‚¹ N4 æ—¶ï¼Œä»…ä»…åˆ†æ‹…äº† N1 èŠ‚ç‚¹çš„æµé‡ï¼Œå…¶ä»–èŠ‚ç‚¹å¹¶æ²¡æœ‰æµé‡å˜åŒ–ã€‚ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œä¸€è‡´æ€§ Hash ç®—æ³•ä¸€èˆ¬ä¼šå¼•å…¥è™šæ‹ŸèŠ‚ç‚¹çš„æ¦‚å¿µã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/CgqCHl_-X4WAKf5LAAgqURGXbLE488.png" alt="Drawing 3.png"></p>
<p>å›¾ä¸­ç›¸åŒé¢œè‰²è¡¨ç¤ºåŒä¸€ç»„è™šæ‹ŸæœåŠ¡å™¨ï¼Œå®ƒä»¬ç»è¿‡ Hash å‡½æ•°è®¡ç®—åè¢«å‡åŒ€æ”¾ç½®åœ¨å“ˆå¸Œç¯ä¸­ã€‚å¦‚æœçœŸå®çš„æœåŠ¡èŠ‚ç‚¹è¶Šå¤šï¼Œé‚£ä¹ˆæ‰€éœ€çš„è™šæ‹ŸèŠ‚ç‚¹å°±è¶Šå°‘ã€‚åœ¨ä¸ºå®¢æˆ·ç«¯å¯¹è±¡åˆ†é…èŠ‚ç‚¹çš„æ—¶å€™ï¼Œéœ€è¦é¡ºæ—¶é’ˆä»å“ˆå¸Œç¯ä¸­æ‰¾åˆ°è·ç¦»æœ€è¿‘çš„è™šæ‹ŸèŠ‚ç‚¹ï¼Œç„¶åå³å¯ç¡®å®šçœŸå®çš„æœåŠ¡èŠ‚ç‚¹ã€‚</p>
<p>æœ‰äº†ä¸Šè¿°ä¸€è‡´æ€§ Hash ç®—æ³•çš„åŸºç¡€çŸ¥è¯†ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹çœ‹ä¸€è‡´æ€§ Hash ç®—æ³•æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<h3 id="è´Ÿè½½å‡è¡¡ç®—æ³•å®ç°">è´Ÿè½½å‡è¡¡ç®—æ³•å®ç°</h3>
<p>ä¸æ³¨å†Œä¸­å¿ƒç±»ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿé¦–å…ˆå®šä¹‰ä¸€ä¸ªé€šç”¨çš„è´Ÿè½½å‡è¡¡æ¥å£ï¼ŒRound-Robin è½®è¯¢ã€ä¸€è‡´æ€§ Hash ç­‰è´Ÿè½½å‡è¡¡ç®—æ³•éƒ½éœ€è¦å®ç°è¯¥æ¥å£ï¼Œæ¥å£çš„å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public interface ServiceLoadBalancer&lt;T&gt; {

    T select(List&lt;T&gt; servers, int hashCode);

}
</code></pre><p>select() æ–¹æ³•çš„ä¼ å…¥å‚æ•°æ˜¯ä¸€æ‰¹æœåŠ¡èŠ‚ç‚¹ä»¥åŠå®¢æˆ·ç«¯å¯¹è±¡çš„ hashCodeï¼Œé’ˆå¯¹ Zookeeper çš„åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªæ¯”è¾ƒé€šç”¨çš„ä¸€è‡´æ€§ Hash ç®—æ³•ã€‚</p>
<pre tabindex="0"><code>public class ZKConsistentHashLoadBalancer implements ServiceLoadBalancer&lt;ServiceInstance&lt;ServiceMeta&gt;&gt; {

    private final static int VIRTUAL_NODE_SIZE = 10;

    private final static String VIRTUAL_NODE_SPLIT = &quot;#&quot;;

    @Override

    public ServiceInstance&lt;ServiceMeta&gt; select(List&lt;ServiceInstance&lt;ServiceMeta&gt;&gt; servers, int hashCode) {

        TreeMap&lt;Integer, ServiceInstance&lt;ServiceMeta&gt;&gt; ring = makeConsistentHashRing(servers); // æ„é€ å“ˆå¸Œç¯

        return allocateNode(ring, hashCode); // æ ¹æ® hashCode åˆ†é…èŠ‚ç‚¹

    }

    private ServiceInstance&lt;ServiceMeta&gt; allocateNode(TreeMap&lt;Integer, ServiceInstance&lt;ServiceMeta&gt;&gt; ring, int hashCode) {

        Map.Entry&lt;Integer, ServiceInstance&lt;ServiceMeta&gt;&gt; entry = ring.ceilingEntry(hashCode); // é¡ºæ—¶é’ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹

        if (entry == null) {

            entry = ring.firstEntry(); // å¦‚æœæ²¡æœ‰å¤§äº hashCode çš„èŠ‚ç‚¹ï¼Œç›´æ¥å–ç¬¬ä¸€ä¸ª

        }

        return entry.getValue();

    }

    private TreeMap&lt;Integer, ServiceInstance&lt;ServiceMeta&gt;&gt; makeConsistentHashRing(List&lt;ServiceInstance&lt;ServiceMeta&gt;&gt; servers) {

        TreeMap&lt;Integer, ServiceInstance&lt;ServiceMeta&gt;&gt; ring = new TreeMap&lt;&gt;();

        for (ServiceInstance&lt;ServiceMeta&gt; instance : servers) {

            for (int i = 0; i &lt; VIRTUAL_NODE_SIZE; i++) {

                ring.put((buildServiceInstanceKey(instance) + VIRTUAL_NODE_SPLIT + i).hashCode(), instance);

            }

        }

        return ring;

    }

    private String buildServiceInstanceKey(ServiceInstance&lt;ServiceMeta&gt; instance) {

        ServiceMeta payload = instance.getPayload();

        return String.join(&quot;:&quot;, payload.getServiceAddr(), String.valueOf(payload.getServicePort()));

    }

}
</code></pre><p>JDK æä¾›äº† TreeMap æ•°æ®ç»“æ„ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿åœ°æ„é€ å“ˆå¸Œç¯ã€‚é€šè¿‡è®¡ç®—å‡ºæ¯ä¸ªæœåŠ¡å®ä¾‹ ServiceInstance çš„åœ°å€å’Œç«¯å£å¯¹åº”çš„ hashCodeï¼Œç„¶åç›´æ¥æ”¾å…¥ TreeMap ä¸­ï¼ŒTreeMap ä¼šå¯¹ hashCode é»˜è®¤ä»å°åˆ°å¤§è¿›è¡Œæ’åºã€‚åœ¨ä¸ºå®¢æˆ·ç«¯å¯¹è±¡åˆ†é…èŠ‚ç‚¹æ—¶ï¼Œé€šè¿‡ TreeMap çš„ ceilingEntry() æ–¹æ³•æ‰¾å‡ºå¤§äºæˆ–ç­‰äºå®¢æˆ·ç«¯ hashCode çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå³ä¸ºå®¢æˆ·ç«¯å¯¹åº”è¦è°ƒç”¨çš„æœåŠ¡èŠ‚ç‚¹ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¤§äºæˆ–ç­‰äºå®¢æˆ·ç«¯ hashCode çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆç›´æ¥å» TreeMap ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å³å¯ã€‚</p>
<p>è‡³æ­¤ï¼Œä¸€ä¸ªåŸºæœ¬çš„ä¸€è‡´æ€§ Hash ç®—æ³•å·²ç»å®ç°å®Œäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥æŠŠæ³¨å†Œä¸­å¿ƒçš„æœåŠ¡å‘ç° discovery() æ–¹æ³•è¡¥å……å®Œæ•´äº†ã€‚</p>
<h3 id="æœåŠ¡å‘ç°å®ç°">æœåŠ¡å‘ç°å®ç°</h3>
<p>æœåŠ¡å‘ç°çš„å®ç°æ€è·¯æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆæ‰¾å‡ºè¢«è°ƒç”¨æœåŠ¡æ‰€æœ‰çš„èŠ‚ç‚¹åˆ—è¡¨ï¼Œç„¶åé€šè¿‡ ZKConsistentHashLoadBalancer æä¾›çš„ä¸€è‡´æ€§ Hash ç®—æ³•æ‰¾å‡ºç›¸åº”çš„æœåŠ¡èŠ‚ç‚¹ã€‚å…·ä½“ä»£ç å®ç°å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>@Override

public ServiceMeta discovery(String serviceName, int invokerHashCode) throws Exception {

    Collection&lt;ServiceInstance&lt;ServiceMeta&gt;&gt; serviceInstances = serviceDiscovery.queryForInstances(serviceName);

    ServiceInstance&lt;ServiceMeta&gt; instance = new ZKConsistentHashLoadBalancer().select((List&lt;ServiceInstance&lt;ServiceMeta&gt;&gt;) serviceInstances, invokerHashCode);

    if (instance != null) {

        return instance.getPayload();

    }

    return null;

}
</code></pre><p>æœåŠ¡æ¶ˆè´¹è€…é€šè¿‡åŠ¨æ€ä»£ç†å‘èµ· RPC è°ƒç”¨ä¹‹å‰ï¼Œéœ€è¦é€šè¿‡æœåŠ¡å‘ç°æ¥å£è·å–åˆ°å¯è°ƒç”¨çš„èŠ‚ç‚¹ï¼Œåœ¨ä¸‹èŠ‚è¯¾ã€ŠåŠ¨æ€ä»£ç†ï¼šä¸ºç”¨æˆ·å±è”½ RPC è°ƒç”¨çš„åº•å±‚ç»†èŠ‚ã€‹ä¼šæœ‰ç›¸åº”çš„ä»£ç å®ç°ï¼Œæœ¬èŠ‚è¯¾å…ˆä¸åšå±•å¼€ã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>æœåŠ¡æ³¨å†Œå’Œå‘ç°æ˜¯ RPC æ¡†æ¶ä¸­éå¸¸é‡è¦çš„ä¸€ç¯ï¼Œæœ¬èŠ‚è¯¾æˆ‘ä»¬è®¾è®¡äº†é€šç”¨çš„æ³¨å†Œä¸­å¿ƒæ¥å£ï¼Œå¹¶ç»™å‡ºäº† Zookeeper åœºæ™¯ä¸‹çš„é»˜è®¤å®ç°ã€‚åœ¨æœåŠ¡å‘ç°ä¸­éœ€è¦ä½¿ç”¨åˆ°è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œå…¶ä¸­ä¸€è‡´æ€§ Hash ç®—æ³•åœ¨å¾ˆå¤šåœºæ™¯ä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼Œå®ƒå¯ä»¥ä¿è¯æ¯ä¸ªæœåŠ¡èŠ‚ç‚¹åˆ†æ‘Šçš„æµé‡å°½å¯èƒ½å‡åŒ€ï¼Œè€Œä¸”èƒ½å¤ŸæŠŠæœåŠ¡èŠ‚ç‚¹æ‰©ç¼©å®¹å¸¦æ¥çš„å½±å“é™åˆ°æœ€ä½ã€‚å…³äºä¸€è‡´æ€§ Hash ç®—æ³•çš„å®ç°åŸç†åŠ¡å¿…æŒæ¡ï¼Œè¿™ä¹Ÿæ˜¯é¢è¯•ä¸­çš„é«˜é¢‘é—®é¢˜ã€‚</p>
<p>æœ€åç•™ä¸¤ä¸ªè¯¾åä»»åŠ¡ï¼š</p>
<ol>
<li>å¦‚æœä½ å¯¹ Eureka æˆ–è€…å…¶ä»–ç±»å‹çš„æ³¨å†Œä¸­å¿ƒæ¯”è¾ƒç†Ÿæ‚‰ï¼Œä½ å¯ä»¥å°è¯•æ‰©å±• RegistryService æ¥å£å¹¶å®ç°å®ƒã€‚</li>
<li>åœ¨ä¸€è‡´æ€§ Hash ç®—æ³•çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯ç®€å•ä½¿ç”¨äº†æœåŠ¡å®ä¾‹çš„ hashCode ä½œä¸ºå“ˆå¸Œç¯çš„æ„å»ºä¾æ®ï¼Œæ›´å¥½çš„ Hash å‡½æ•°å¯ä»¥å‚è€ƒæ›´åŠ é«˜æ€§èƒ½çš„ MurmurHashï¼ŒGuava å·¥å…·åº“ä¸­å°±æœ‰é»˜è®¤å®ç°ï¼Œä½ å¯ä»¥å¼•å…¥ MurmurHash å¯¹ä¸Šæ–‡ä¸­çš„ä¸€è‡´æ€§ Hash ç®—æ³•å®ç°è¿›è¡Œä¼˜åŒ–ã€‚</li>
</ol>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/25-%E8%BF%9C%E7%A8%8B%E9%80%9A%E4%BF%A1%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE%E8%AE%BE%E8%AE%A1%E4%BB%A5%E5%8F%8A%E7%BC%96%E8%A7%A3%E7%A0%81%E7%9A%84%E5%AE%9E%E7%8E%B0/"><span>25 è¿œç¨‹é€šä¿¡ï¼šé€šä¿¡åè®®è®¾è®¡ä»¥åŠç¼–è§£ç çš„å®ç°</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/netty/netty%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8Erpc%E5%AE%9E%E8%B7%B5/27-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%BA%E7%94%A8%E6%88%B7%E5%B1%8F%E8%94%BD-rpc-%E8%B0%83%E7%94%A8%E7%9A%84%E5%BA%95%E5%B1%82%E7%BB%86%E8%8A%82/"><span>27 åŠ¨æ€ä»£ç†ï¼šä¸ºç”¨æˆ·å±è”½ RPC è°ƒç”¨çš„åº•å±‚ç»†èŠ‚</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 28280 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>