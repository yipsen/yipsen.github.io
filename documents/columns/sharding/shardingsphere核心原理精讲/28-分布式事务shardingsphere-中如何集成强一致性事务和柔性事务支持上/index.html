<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>28 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸Šï¼‰ | Yipsen Ye</title>
<meta name="description" content="ä»Šå¤©æˆ‘ä»¬å°†åœ¨ä¸Šä¸€è¯¾æ—¶çš„åŸºç¡€ä¸Šï¼Œè¯¦ç»†å±•å¼€ ShardingSphere ä¸­åˆ†å¸ƒå¼äº‹åŠ¡çš„å…·ä½“å®ç°è¿‡ç¨‹ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†ä»‹ç»æ”¯æŒå¼ºä¸€è‡´æ€§äº‹åŠ¡çš„ XAShardingTransactionManagerã€‚
XAShardingTransactionManager è®©æˆ‘ä»¬å›åˆ° ShardingSphereï¼Œæ¥åˆ° sharding-transaction-xa-core å·¥ç¨‹çš„ XAShardingTransactionManager ç±»ï¼Œè¯¥ç±»æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡çš„ XA å®ç°ç±»ã€‚
æˆ‘ä»¬å…ˆæ¥çœ‹ XAShardingTransactionManager ç±»çš„å®šä¹‰å’Œæ‰€åŒ…å«çš„å˜é‡ï¼š
public final class XAShardingTransactionManager implements ShardingTransactionManager {private final Map&amp;lt;String, XATransactionDataSource&amp;gt; cachedDataSources = new HashMap&amp;lt;&amp;gt;();private final XATransactionManager xaTransactionManager = XATransactionManagerLoader.getInstance().getTransactionManager();}å¯ä»¥çœ‹åˆ° XAShardingTransactionManager å®ç°äº†ä¸Šä¸€è¯¾æ—¶ä¸­ä»‹ç»çš„ ShardingTransactionManager æ¥å£ï¼Œå¹¶ä¿å­˜ç€ä¸€ç»„ XATransactionDataSourceã€‚åŒæ—¶ï¼ŒXATransactionManager å®ä¾‹çš„åŠ è½½ä»ç„¶æ˜¯é‡‡ç”¨äº† JDK ä¸­çš„ ServiceLoader ç±»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
private XATransactionManager load() {Iterator&amp;lt;XATransactionManager&amp;gt; xaTransactionManagers = ServiceLoader.load(XATransactionManager.class).iterator();if (!xaTransactionManagers.hasNext()) {return new AtomikosTransactionManager();}XATransactionManager result = xaTransactionManagers.next();if (xaTransactionManagers.hasNext()) {log.">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/shardingsphere%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e7%b2%be%e8%ae%b2/">ShardingSphereæ ¸å¿ƒåŸç†ç²¾è®²</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/00-%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E5%AD%A6%E4%B9%A0%E4%B8%80%E6%AC%BE%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/">00 å¦‚ä½•æ­£ç¡®å­¦ä¹ ä¸€æ¬¾åˆ†åº“åˆ†è¡¨å¼€æºæ¡†æ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/01-%E4%BB%8E%E7%90%86%E8%AE%BA%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%A6%82%E4%BD%95%E8%AE%A9%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%9C%9F%E6%AD%A3%E8%90%BD%E5%9C%B0/">01 ä»ç†è®ºåˆ°å®è·µï¼šå¦‚ä½•è®©åˆ†åº“åˆ†è¡¨çœŸæ­£è½åœ°ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/02-%E9%A1%B6%E7%BA%A7%E9%A1%B9%E7%9B%AEshardingsphere-%E6%98%AF%E4%B8%80%E6%AC%BE%E4%BB%80%E4%B9%88%E6%A0%B7%E7%9A%84-apache-%E5%BC%80%E6%BA%90%E8%BD%AF%E4%BB%B6/">02 é¡¶çº§é¡¹ç›®ï¼šShardingSphere æ˜¯ä¸€æ¬¾ä»€ä¹ˆæ ·çš„ Apache å¼€æºè½¯ä»¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/03-%E8%A7%84%E8%8C%83%E5%85%BC%E5%AE%B9jdbc-%E8%A7%84%E8%8C%83%E4%B8%8E-shardingsphere-%E6%98%AF%E4%BB%80%E4%B9%88%E5%85%B3%E7%B3%BB/">03 è§„èŒƒå…¼å®¹ï¼šJDBC è§„èŒƒä¸ ShardingSphere æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/04-%E5%BA%94%E7%94%A8%E9%9B%86%E6%88%90%E5%9C%A8%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F%E4%B8%AD%E4%BD%BF%E7%94%A8-shardingsphere-%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9C%89%E5%93%AA%E4%BA%9B/">04 åº”ç”¨é›†æˆï¼šåœ¨ä¸šåŠ¡ç³»ç»Ÿä¸­ä½¿ç”¨ ShardingSphere çš„æ–¹å¼æœ‰å“ªäº›ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/05-%E9%85%8D%E7%BD%AE%E9%A9%B1%E5%8A%A8shardingsphere-%E4%B8%AD%E7%9A%84%E9%85%8D%E7%BD%AE%E4%BD%93%E7%B3%BB%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E7%9A%84/">05 é…ç½®é©±åŠ¨ï¼šShardingSphere ä¸­çš„é…ç½®ä½“ç³»æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/09-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E4%B8%8E%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1/">09 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¦‚ä½•ä½¿ç”¨å¼ºä¸€è‡´æ€§äº‹åŠ¡ä¸æŸ”æ€§äº‹åŠ¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/10-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E5%A6%82%E4%BD%95%E7%A1%AE%E4%BF%9D%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AE%89%E5%85%A8%E8%AE%BF%E9%97%AE/">10 æ•°æ®è„±æ•ï¼šå¦‚ä½•ç¡®ä¿æ•æ„Ÿæ•°æ®çš„å®‰å…¨è®¿é—®ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/11-%E7%BC%96%E6%8E%92%E6%B2%BB%E7%90%86%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/">11 ç¼–æ’æ²»ç†ï¼šå¦‚ä½•å®ç°åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„åŠ¨æ€é…ç½®ç®¡ç†ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/12-%E4%BB%8E%E5%BA%94%E7%94%A8%E5%88%B0%E5%8E%9F%E7%90%86%E5%A6%82%E4%BD%95%E9%AB%98%E6%95%88%E9%98%85%E8%AF%BB-shardingsphere-%E6%BA%90%E7%A0%81/">12 ä»åº”ç”¨åˆ°åŸç†ï¼šå¦‚ä½•é«˜æ•ˆé˜…è¯» ShardingSphere æºç ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/13-%E5%BE%AE%E5%86%85%E6%A0%B8%E6%9E%B6%E6%9E%84shardingsphere-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%89%A9%E5%B1%95%E6%80%A7/">13 å¾®å†…æ ¸æ¶æ„ï¼šShardingSphere å¦‚ä½•å®ç°ç³»ç»Ÿçš„æ‰©å±•æ€§ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/14-%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AEshardingsphere-%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AE%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F/">14 åˆ†å¸ƒå¼ä¸»é”®ï¼šShardingSphere ä¸­æœ‰å“ªäº›åˆ†å¸ƒå¼ä¸»é”®å®ç°æ–¹å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/15-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8A/">15 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/16-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8B/">16 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/17-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E5%88%86%E7%89%87%E8%B7%AF%E7%94%B1%E6%A0%B8%E5%BF%83%E7%B1%BB-shardingrouter-%E7%9A%84%E8%BF%90%E4%BD%9C%E6%9C%BA%E5%88%B6/">17 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•ç†è§£åˆ†ç‰‡è·¯ç”±æ ¸å¿ƒç±» ShardingRouter çš„è¿ä½œæœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/18-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E7%9A%84%E5%88%86%E7%89%87%E8%B7%AF%E7%94%B1%E5%92%8C%E5%B9%BF%E6%92%AD%E8%B7%AF%E7%94%B1/">18 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•å®ç°æ•°æ®è®¿é—®çš„åˆ†ç‰‡è·¯ç”±å’Œå¹¿æ’­è·¯ç”±ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/19-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%9C%A8%E8%B7%AF%E7%94%B1%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%9B%86%E6%88%90%E5%A4%9A%E7%A7%8D%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E5%92%8C%E8%B7%AF%E7%94%B1%E7%AE%97%E6%B3%95/">19 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•åœ¨è·¯ç”±è¿‡ç¨‹ä¸­é›†æˆå¤šç§è·¯ç”±ç­–ç•¥å’Œè·¯ç”±ç®—æ³•ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/20-%E6%94%B9%E5%86%99%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84-sql-%E6%94%B9%E5%86%99%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6/">20 æ”¹å†™å¼•æ“ï¼šå¦‚ä½•ç†è§£è£…é¥°å™¨æ¨¡å¼ä¸‹çš„ SQL æ”¹å†™å®ç°æœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/21-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%88%86%E7%89%87%E7%8E%AF%E5%A2%83%E4%B8%8B-sql-%E6%89%A7%E8%A1%8C%E7%9A%84%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E6%8A%BD%E8%B1%A1/">21 æ‰§è¡Œå¼•æ“ï¼šåˆ†ç‰‡ç¯å¢ƒä¸‹ SQL æ‰§è¡Œçš„æ•´ä½“æµç¨‹åº”è¯¥å¦‚ä½•è¿›è¡ŒæŠ½è±¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/22-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E6%8A%8A%E6%8F%A1-shardingsphere-%E4%B8%AD%E7%9A%84-executor-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8A/">22 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/23-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E6%8A%8A%E6%8F%A1-shardingsphere-%E4%B8%AD%E7%9A%84-executor-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8B/">23 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/24-%E5%BD%92%E5%B9%B6%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E6%95%B0%E6%8D%AE%E5%BD%92%E5%B9%B6%E7%9A%84%E7%B1%BB%E5%9E%8B%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%BD%92%E5%B9%B6%E7%AD%96%E7%95%A5%E7%9A%84%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B/">24 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æ•°æ®å½’å¹¶çš„ç±»å‹ä»¥åŠç®€å•å½’å¹¶ç­–ç•¥çš„å®ç°è¿‡ç¨‹ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/25-%E5%BD%92%E5%B9%B6%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E6%B5%81%E5%BC%8F%E5%BD%92%E5%B9%B6%E5%92%8C%E5%86%85%E5%AD%98%E5%BD%92%E5%B9%B6%E5%9C%A8%E5%A4%8D%E6%9D%82%E5%BD%92%E5%B9%B6%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84%E5%BA%94%E7%94%A8%E6%96%B9%E5%BC%8F/">25 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æµå¼å½’å¹¶å’Œå†…å­˜å½’å¹¶åœ¨å¤æ‚å½’å¹¶åœºæ™¯ä¸‹çš„åº”ç”¨æ–¹å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/26-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%99%AE%E9%80%9A%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%92%8C%E5%88%86%E7%89%87%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%88%86%E5%88%AB%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84/">26 è¯»å†™åˆ†ç¦»ï¼šæ™®é€šä¸»ä»æ¶æ„å’Œåˆ†ç‰‡ä¸»ä»æ¶æ„åˆ†åˆ«æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/27-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3-shardingsphere-%E4%B8%AD%E5%AF%B9%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%8A%BD%E8%B1%A1%E8%BF%87%E7%A8%8B/">27 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¦‚ä½•ç†è§£ ShardingSphere ä¸­å¯¹åˆ†å¸ƒå¼äº‹åŠ¡çš„æŠ½è±¡è¿‡ç¨‹ï¼Ÿ</a></li>
                
                
                
                    <li>28 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸Šï¼‰</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/29-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1shardingsphere-%E4%B8%AD%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%E4%B8%8B/">29 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/30-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E6%94%B9%E5%86%99%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%E4%BD%8E%E4%BE%B5%E5%85%A5%E6%80%A7%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E6%96%B9%E6%A1%88/">30 æ•°æ®è„±æ•ï¼šå¦‚ä½•åŸºäºæ”¹å†™å¼•æ“å®ç°ä½ä¾µå…¥æ€§æ•°æ®è„±æ•æ–¹æ¡ˆï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/31-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E7%9A%84%E5%8A%A8%E6%80%81%E5%8C%96%E7%AE%A1%E7%90%86/">31 é…ç½®ä¸­å¿ƒï¼šå¦‚ä½•åŸºäºé…ç½®ä¸­å¿ƒå®ç°é…ç½®ä¿¡æ¯çš„åŠ¨æ€åŒ–ç®¡ç†ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/32-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BF%E9%97%AE%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6/">32 æ³¨å†Œä¸­å¿ƒï¼šå¦‚ä½•åŸºäºæ³¨å†Œä¸­å¿ƒå®ç°æ•°æ®åº“è®¿é—®ç†”æ–­æœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/33-%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E-hook-%E6%9C%BA%E5%88%B6%E4%BB%A5%E5%8F%8A-opentracing-%E5%8D%8F%E8%AE%AE%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA/">33 é“¾è·¯è·Ÿè¸ªï¼šå¦‚ä½•åŸºäº Hook æœºåˆ¶ä»¥åŠ OpenTracing åè®®å®ç°æ•°æ®è®¿é—®é“¾è·¯è·Ÿè¸ªï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/35-%E7%BB%93%E8%AF%ADshardingsphere-%E6%80%BB%E7%BB%93%E5%8F%8A%E5%B1%95%E6%9C%9B/">35 ç»“è¯­ï¼šShardingSphere æ€»ç»“åŠå±•æœ›</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">28 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸Šï¼‰</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2021-12-22 01:56:08</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/sharding/">sharding</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/">ShardingSphereæ ¸å¿ƒåŸç†ç²¾è®²</a>
                
            </div></div>
        <div class="post-content">
            <p>ä»Šå¤©æˆ‘ä»¬å°†åœ¨ä¸Šä¸€è¯¾æ—¶çš„åŸºç¡€ä¸Šï¼Œè¯¦ç»†å±•å¼€ ShardingSphere ä¸­åˆ†å¸ƒå¼äº‹åŠ¡çš„å…·ä½“å®ç°è¿‡ç¨‹ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†ä»‹ç»æ”¯æŒå¼ºä¸€è‡´æ€§äº‹åŠ¡çš„ XAShardingTransactionManagerã€‚</p>
<h3 id="xashardingtransactionmanager">XAShardingTransactionManager</h3>
<p>è®©æˆ‘ä»¬å›åˆ° ShardingSphereï¼Œæ¥åˆ° sharding-transaction-xa-core å·¥ç¨‹çš„ XAShardingTransactionManager ç±»ï¼Œè¯¥ç±»æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡çš„ XA å®ç°ç±»ã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ XAShardingTransactionManager ç±»çš„å®šä¹‰å’Œæ‰€åŒ…å«çš„å˜é‡ï¼š</p>
<pre tabindex="0"><code>public final class XAShardingTransactionManager implements ShardingTransactionManager {

    private final Map&lt;String, XATransactionDataSource&gt; cachedDataSources = new HashMap&lt;&gt;();

private final XATransactionManager xaTransactionManager = XATransactionManagerLoader.getInstance().getTransactionManager();
 
}
</code></pre><p>å¯ä»¥çœ‹åˆ° XAShardingTransactionManager å®ç°äº†ä¸Šä¸€è¯¾æ—¶ä¸­ä»‹ç»çš„ ShardingTransactionManager æ¥å£ï¼Œå¹¶ä¿å­˜ç€ä¸€ç»„ XATransactionDataSourceã€‚åŒæ—¶ï¼ŒXATransactionManager å®ä¾‹çš„åŠ è½½ä»ç„¶æ˜¯é‡‡ç”¨äº† JDK ä¸­çš„ ServiceLoader ç±»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private XATransactionManager load() {
        Iterator&lt;XATransactionManager&gt; xaTransactionManagers = ServiceLoader.load(XATransactionManager.class).iterator();
        if (!xaTransactionManagers.hasNext()) {
            return new AtomikosTransactionManager();
        }
        XATransactionManager result = xaTransactionManagers.next();
        if (xaTransactionManagers.hasNext()) {
            log.warn(&quot;There are more than one transaction mangers existing, chosen first one by default.&quot;);
        }
        return result;
}
</code></pre><p>XATransactionManager å°±æ˜¯å¯¹å„ç§ç¬¬ä¸‰æ–¹ XA äº‹åŠ¡ç®¡ç†å™¨çš„ä¸€ç§æŠ½è±¡ï¼Œé€šè¿‡ä¸Šè¿°ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°åœ¨æ‰¾ä¸åˆ°åˆé€‚çš„ XATransactionManager çš„æƒ…å†µä¸‹ï¼Œç³»ç»Ÿé»˜è®¤ä¼šåˆ›å»ºä¸€ä¸ª AtomikosTransactionManagerã€‚è€Œè¿™ä¸ª XATransactionManager çš„å®šä¹‰å®é™…ä¸Šæ˜¯ä½äºå•ç‹¬çš„ä¸€ä¸ªä»£ç å·¥ç¨‹ä¸­ï¼Œå³ sharding-transaction-xa-spi å·¥ç¨‹ï¼Œè¯¥æ¥å£å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public interface XATransactionManager extends AutoCloseable {

    //åˆå§‹åŒ– XA äº‹åŠ¡ç®¡ç†å™¨
    void init();

    //æ³¨å†Œäº‹åŠ¡æ¢å¤èµ„æº
    void registerRecoveryResource(String dataSourceName, XADataSource xaDataSource);

    //ç§»é™¤äº‹åŠ¡æ¢å¤èµ„æº
    void removeRecoveryResource(String dataSourceName, XADataSource xaDataSource);

    //åµŒå…¥ä¸€ä¸ª SingleXAResource èµ„æº
    void enlistResource(SingleXAResource singleXAResource);

    //è¿”å› TransactionManager
    TransactionManager getTransactionManager();
}
</code></pre><p>è¿™äº›æ¥å£æ–¹æ³•ä»å‘½åä¸ŠåŸºæœ¬å¯ä»¥ç†è§£å…¶å«ä¹‰ï¼Œä½†è¯¦ç»†çš„ç”¨æ³•æˆ‘ä»¬è¿˜æ˜¯è¦ç»“åˆå…·ä½“çš„ XATransactionManager å®ç°ç±»è¿›è¡Œç†è§£ã€‚è¿™é‡Œæˆ‘ä»¬è¿˜å‘ç°äº†ä¸€ä¸ª SingleXAResourceï¼Œè¿™ä¸ªç±»åŒæ ·ä½äº sharding-transaction-xa-spi å·¥ç¨‹ä¸­ï¼Œä»åç§°ä¸Šçœ‹ï¼Œåº”è¯¥æ˜¯å¯¹ JTA ä¸­ XAResource æ¥å£çš„ä¸€ç§å®ç°ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼š</p>
<pre tabindex="0"><code>public final class SingleXAResource implements XAResource {

    private final String resourceName;

    private final XAResource delegate;

    @Override
    public void start(final Xid xid, final int i) throws XAException {
        delegate.start(xid, i);
    } 
    @Override
    public void commit(final Xid xid, final boolean b) throws XAException {
        delegate.commit(xid, b);
    }

@Override
    public void rollback(final Xid xid) throws XAException {
        delegate.rollback(xid);
    } 
    @Override
    public boolean isSameRM(final XAResource xaResource) {
        SingleXAResource singleXAResource = (SingleXAResource) xaResource;
        return resourceName.equals(singleXAResource.getResourceName());
}
â€¦
}
</code></pre><p>å¯ä»¥çœ‹åˆ° SingleXAResource è™½ç„¶å®ç°äº† JTA çš„ XAResource æ¥å£ï¼Œä½†æ›´åƒæ˜¯ä¸€ä¸ªä»£ç†ç±»ï¼Œå…·ä½“çš„æ“ä½œæ–¹æ³•è¿˜æ˜¯å§”æ‰˜ç»™äº†å†…éƒ¨çš„ XAResource è¿›è¡Œå®ç°ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å›´ç»• XA åˆ†å¸ƒå¼äº‹åŠ¡ä¸­çš„å‡ ä¸ªæ ¸å¿ƒç±»å±•å¼€è®¨è®ºã€‚</p>
<h4 id="1xadatasource">1.XADataSource</h4>
<p>XADataSource å±äº JDBC è§„èŒƒä¸­çš„å†…å®¹ï¼Œæˆ‘ä»¬åœ¨â€œ03 | è§„èŒƒå…¼å®¹ï¼šJDBC è§„èŒƒä¸ ShardingSphere æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿâ€ä¸­å·²ç»æåˆ°è¿‡è¿™ä¸ªæ¥å£ï¼Œè¯¥æ¥å£çš„ä½œç”¨å°±æ˜¯è·å– XAConnectionã€‚</p>
<p>é‚£ä¹ˆ XADataSource æ˜¯å¦‚ä½•æ„å»ºå‡ºæ¥çš„å‘¢ï¼Ÿæˆ‘ä»¬é¦–å…ˆæ‰¾åˆ°äº†ä¸€ä¸ª XADataSourceFactory å·¥å‚ç±»ï¼Œæ˜¾ç„¶è¯¥ç±»è´Ÿè´£ç”Ÿæˆå…·ä½“çš„ XADataSourceï¼Œå¦‚ä¸‹æ‰€ç¤ºçš„å°±æ˜¯å®Œæˆè¿™ä¸€å·¥ä½œçš„ build æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>public static XADataSource build(final DatabaseType databaseType, final DataSource dataSource) {
        XADataSourceDefinition xaDataSourceDefinition = XADataSourceDefinitionFactory.getXADataSourceDefinition(databaseType);
        XADataSource result = createXADataSource(xaDataSourceDefinition);
        Properties xaProperties = xaDataSourceDefinition.getXAProperties(SWAPPER.swap(dataSource));
        PropertyUtils.setProperties(result, xaProperties);
        return result;
}
</code></pre><p>è¿™é‡Œé¦–å…ˆç”¨åˆ°äº†ä¸€ä¸ª XADataSourceDefinition æ¥å£ï¼Œä»å‘½åä¸Šçœ‹åº”è¯¥æ˜¯å…³äº XADataSource çš„ä¸€ç§å®šä¹‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public interface XADataSourceDefinition extends DatabaseTypeAwareSPI {

    //è·å– XA é©±åŠ¨ç±»å
    Collection&lt;String&gt; getXADriverClassName();

    //è·å– XA å±æ€§
    Properties getXAProperties(DatabaseAccessConfiguration databaseAccessConfiguration);
}
</code></pre><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ¥å£ç»§æ‰¿äº† DatabaseTypeAwareSPIï¼Œä»å‘½åä¸Šçœ‹è¿™ä¹Ÿæ˜¯ä¸€ä¸ª SPI æ¥å£ï¼Œå…¶å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public interface DatabaseTypeAwareSPI { 
    //è·å–æ•°æ®åº“ç±»å‹
    String getDatabaseType();
}
</code></pre><p>åœ¨ ShardingSphere ä¸­ï¼Œç»§æ‰¿ DatabaseTypeAwareSPI æ¥å£çš„å°±åªæœ‰ XADataSourceDefinition æ¥å£ï¼Œè€Œåè€…å­˜åœ¨ä¸€æ‰¹å®ç°ç±»ï¼Œæ•´ä½“çš„ç±»å±‚ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/Ciqc1F9jCmiAI4cLAAE2ATnYWp4900.png" alt="Drawing 0.png"></p>
<p>XADataSourceDefinition çš„å®ç°ç±»</p>
<p>è¿™é‡Œä»¥ MySQLXADataSourceDefinition ä¸ºä¾‹å±•å¼€è®¨è®ºï¼Œè¯¥ç±»åˆ†åˆ«å®ç°äº† DatabaseTypeAwareSPI å’Œ XADataSourceDefinition è¿™ä¸¤ä¸ªæ¥å£ä¸­æ‰€å®šä¹‰çš„ä¸‰ä¸ªæ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>public final class MySQLXADataSourceDefinition implements XADataSourceDefinition {

    @Override
    public String getDatabaseType() {
        return &quot;MySQL&quot;;
    }

    @Override
    public Collection&lt;String&gt; getXADriverClassName() {
        return Arrays.asList(&quot;com.mysql.jdbc.jdbc2.optional.MysqlXADataSource&quot;, &quot;com.mysql.cj.jdbc.MysqlXADataSource&quot;);
    }

    @Override
    public Properties getXAProperties(final DatabaseAccessConfiguration databaseAccessConfiguration) {
        Properties result = new Properties();
        result.setProperty(&quot;user&quot;, databaseAccessConfiguration.getUsername());
        result.setProperty(&quot;password&quot;, Optional.fromNullable(databaseAccessConfiguration.getPassword()).or(&quot;&quot;));
        result.setProperty(&quot;URL&quot;, databaseAccessConfiguration.getUrl());
        â€¦ 
        return result;
    }
}
</code></pre><p>æˆ‘ä»¬ä»è¿™é‡Œå¾—çŸ¥ï¼Œä½œä¸ºæ•°æ®åº“ä¾›åº”å•†ï¼ŒMySQL æä¾›äº†ä¸¤ä¸ª XADataSource çš„é©±åŠ¨ç¨‹åºã€‚è€Œåœ¨ getXAProperties ä¸­ï¼Œæˆ‘ä»¬å‘ç° URLã€Username å’Œ Password ç­‰ä¿¡æ¯æ˜¯é€šè¿‡ DatabaseAccessConfiguration å¯¹è±¡è¿›è¡Œè·å–çš„ï¼Œè¯¥å¯¹è±¡åœ¨æœ¬æ–‡åé¢ä¼šä»‹ç»åˆ°ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œå› ä¸º DatabaseTypeAwareSPI æ¥å£å‘½åä¸­å¸¦æœ‰ SPIï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éš¾æƒ³è±¡å„ç§ XADataSourceDefinition å®é™…ä¸Šä¹Ÿæ˜¯åŸºäº SPI æœºåˆ¶è¿›è¡ŒåŠ è½½çš„ï¼Œè¿™åœ¨ç”¨äºè·å– XADataSourceDefinition çš„å·¥å‚ç±» XADataSourceDefinitionFactory ä¸­å¯ä»¥å¾—åˆ°ç¡®è®¤ï¼š</p>
<pre tabindex="0"><code>public final class XADataSourceDefinitionFactory {

    private static final Map&lt;DatabaseType, XADataSourceDefinition&gt; XA_DATA_SOURCE_DEFINITIONS = new HashMap&lt;&gt;();

static {
       //é€šè¿‡ ServiceLoader åŠ è½½ XADataSourceDefinition
        for (XADataSourceDefinition each : ServiceLoader.load(XADataSourceDefinition.class)) {
            XA_DATA_SOURCE_DEFINITIONS.put(DatabaseTypes.getActualDatabaseType(each.getDatabaseType()), each);
        }
    }

    public static XADataSourceDefinition getXADataSourceDefinition(final DatabaseType databaseType) {
        return XA_DATA_SOURCE_DEFINITIONS.get(databaseType);
    }
}
</code></pre><p>åŒæ ·ï¼Œåœ¨ sharding-transaction-xa-core å·¥ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå‘ç°äº†å¦‚ä¸‹æ‰€ç¤ºçš„ SPI é…ç½®ä¿¡æ¯ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/Ciqc1F9jCoWAOFRpAACUXKjEF6o633.png" alt="Drawing 1.png"></p>
<p>sharding-transaction-xa-core å·¥ç¨‹ä¸­çš„ SPI é…ç½®</p>
<p>å½“æ ¹æ®æ•°æ®åº“ç±»å‹è·å–äº†å¯¹åº”çš„ XADataSourceDefinition ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ ¹æ® XADriverClassName æ¥åˆ›å»ºå…·ä½“çš„ XADataSourceï¼š</p>
<pre tabindex="0"><code>private static XADataSource loadXADataSource(final String xaDataSourceClassName) {
        Class xaDataSourceClass;
        try {
           //åŠ è½½ XADataSource å®ç°ç±»
            xaDataSourceClass = Thread.currentThread().getContextClassLoader().loadClass(xaDataSourceClassName);
        } catch (final ClassNotFoundException ignored) {
            try {
                xaDataSourceClass = Class.forName(xaDataSourceClassName);
            } catch (final ClassNotFoundException ex) {
                throw new ShardingException(&quot;Failed to load [%s]&quot;, xaDataSourceClassName);
            }
        }
        try {
            return (XADataSource) xaDataSourceClass.newInstance();
        } catch (final InstantiationException | IllegalAccessException ex) {
            throw new ShardingException(&quot;Failed to instance [%s]&quot;, xaDataSourceClassName);
        }
}
</code></pre><p>è¿™é‡Œä¼šå…ˆä»å½“å‰çº¿ç¨‹çš„ ContextClassLoader ä¸­åŠ è½½ç›®æ ‡é©±åŠ¨çš„å®ç°ç±»ï¼Œå¦‚æœåŠ è½½ä¸åˆ°ï¼Œå°±ç›´æ¥é€šè¿‡åå°„è¿›è¡Œåˆ›å»ºï¼Œæœ€åè¿”å› XADataSource çš„å®ä¾‹å¯¹è±¡ã€‚</p>
<p>å½“è·å–äº† XADataSource çš„å®ä¾‹å¯¹è±¡ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®å®ƒçš„å±æ€§ï¼Œè¿™éƒ¨åˆ†å·¥ä½œæ˜¯ç”± DataSourceSwapper ç±»æ¥å®Œæˆçš„ã€‚åœ¨è¿™é‡Œï¼ŒShardingSphere é’ˆå¯¹ä¸åŒç±»å‹çš„æ•°æ®åº“è¿æ¥æ± å·¥å…·è¿˜ä¸“é—¨åšäº†ä¸€å±‚å°è£…ï¼Œæå–äº† DataSourcePropertyProvider æ¥å£ç”¨äºå¯¹ DataSourceçš„URL ã€Username å’Œ Password ç­‰åŸºç¡€ä¿¡æ¯è¿›è¡ŒæŠ½è±¡ã€‚</p>
<p>DataSourcePropertyProvider æ¥å£çš„å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public interface DataSourcePropertyProvider {
    String getDataSourceClassName();
    String getURLPropertyName();
    String getUsernamePropertyName();
    String getPasswordPropertyName();
}
</code></pre><p>DataSourcePropertyProvider çš„å®ç°ç±»æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ DefaultDataSourcePropertyProviderï¼Œå¦ä¸€ä¸ªæ˜¯ HikariCPPropertyProviderã€‚ShardingSphere é»˜è®¤ä½¿ç”¨çš„æ˜¯ HikariCPPropertyProviderï¼Œè¿™ç‚¹å¯ä»¥ä»å¦‚ä¸‹æ‰€ç¤ºçš„ SPI é…ç½®æ–‡ä»¶ä¸­å¾—åˆ°ç¡®è®¤ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/Ciqc1F9jCpSAGChUAAB8-cv8fCU688.png" alt="Drawing 2.png"></p>
<p>DataSourcePropertyProvider çš„ SPI é…ç½®</p>
<p>HikariCPPropertyProvider å®ç°äº† DataSourcePropertyProvider æ¥å£ï¼Œå¹¶åŒ…å«äº†å¯¹è¿™äº›åŸºç¡€ä¿¡æ¯çš„å®šä¹‰ï¼š</p>
<pre tabindex="0"><code>public final class HikariCPPropertyProvider implements DataSourcePropertyProvider {

    @Override
    public String getDataSourceClassName() {
        return &quot;com.zaxxer.hikari.HikariDataSource&quot;;
    }

    @Override
    public String getURLPropertyName() {
        return &quot;jdbcUrl&quot;;
    }

    @Override
    public String getUsernamePropertyName() {
        return &quot;username&quot;;
    }

    @Override
    public String getPasswordPropertyName() {
        return &quot;password&quot;;
    }
}
</code></pre><p>ç„¶ååœ¨ DataSourceSwapper çš„ swap æ–¹æ³•ä¸­ï¼Œå®é™…ä¸Šå°±æ˜¯é€šè¿‡åå°„æ¥æ„å»º findGetterMethod å·¥å…·æ–¹æ³•ï¼Œå¹¶ä»¥æ­¤è·å– URLã€Username å’Œ Password ç­‰åŸºç¡€ä¿¡æ¯ï¼Œå¹¶è¿”å›ä¸€ä¸ª DatabaseAccessConfiguration å¯¹è±¡ä¾›å…·ä½“çš„ XADataSourceDefinition è¿›è¡Œä½¿ç”¨ã€‚</p>
<p>swap æ–¹æ³•çš„å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public DatabaseAccessConfiguration swap(final DataSource dataSource) {
        DataSourcePropertyProvider provider = DataSourcePropertyProviderLoader.getProvider(dataSource);
        try {
            String url = (String) findGetterMethod(dataSource, provider.getURLPropertyName()).invoke(dataSource);
            String username = (String) findGetterMethod(dataSource, provider.getUsernamePropertyName()).invoke(dataSource);
            String password = (String) findGetterMethod(dataSource, provider.getPasswordPropertyName()).invoke(dataSource);
            return new DatabaseAccessConfiguration(url, username, password);
        } catch (final ReflectiveOperationException ex) {
            throw new ShardingException(&quot;Cannot swap data source type: `%s`, please provide an implementation from SPI `%s`&quot;, 
                    dataSource.getClass().getName(), DataSourcePropertyProvider.class.getName());
        }
}
</code></pre><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å¯¹ XADataSource çš„æ„å»ºè¿‡ç¨‹æè¿°å®Œæ¯•ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸ç®—å¤æ‚ï¼Œä½†æ¶‰åŠçš„ç±»æ¯”è¾ƒå¤šï¼Œå€¼å¾—æˆ‘ä»¬ä»¥ XADataSourceFactory ä¸ºä¸­å¿ƒç”»ä¸€å¼ ç±»å›¾ä½œä¸ºæ€»ç»“ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/Ciqc1F9jCqGAYmlZAACYlVXsQ44048.png" alt="image.png"></p>
<h4 id="2xaconnection">2.XAConnection</h4>
<p>è®²å®Œ XADataSourceï¼Œæˆ‘ä»¬æ¥ç€æ¥è®² XAConnectionï¼ŒXAConnection åŒæ ·æ˜¯ JDBC è§„èŒƒä¸­çš„æ¥å£ã€‚</p>
<p>è´Ÿè´£åˆ›å»º XAConnection çš„å·¥å‚ç±» XAConnectionFactory å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class XAConnectionFactory { 
    //åŸºäºæ™®é€š Connection åˆ›å»º XAConnection 
    public static XAConnection createXAConnection(final DatabaseType databaseType, final XADataSource xaDataSource, final Connection connection) {
        switch (databaseType.getName()) {
            case &quot;MySQL&quot;:
                return new MySQLXAConnectionWrapper().wrap(xaDataSource, connection);
            case &quot;MariaDB&quot;:
                return new MariaDBXAConnectionWrapper().wrap(xaDataSource, connection);
            case &quot;PostgreSQL&quot;:
                return new PostgreSQLXAConnectionWrapper().wrap(xaDataSource, connection);
            case &quot;H2&quot;:
                return new H2XAConnectionWrapper().wrap(xaDataSource, connection);
            default:
                throw new UnsupportedOperationException(String.format(&quot;Cannot support database type: `%s`&quot;, databaseType));
        }
    }
}
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œç›¸è¾ƒ XADataSourceï¼Œåˆ›å»º XAConnection çš„è¿‡ç¨‹å°±æ˜¾å¾—ç›´æ¥æ˜äº†ã€‚è¿™é‡Œé€šè¿‡ä¸€ä¸ª switch è¯­å¥æ ¹æ®æ•°æ®åº“ç±»å‹åˆ†åˆ«æ„å»ºäº†å¯¹åº”çš„ ConnectionWrapperï¼Œç„¶åå†è°ƒç”¨ wrap æ–¹æ³•è¿”å› XAConnectionã€‚</p>
<p>æˆ‘ä»¬è¿˜æ˜¯ä»¥ MySQLXAConnectionWrapper ä¸ºä¾‹æ¥åˆ†æå…·ä½“çš„å®ç°è¿‡ç¨‹ã€‚</p>
<p>MySQLXAConnectionWrapper å®ç°äº† XAConnectionWrapper æ¥å£ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥çœ‹ XAConnectionWrapper æ¥å£çš„å®šä¹‰ï¼š</p>
<pre tabindex="0"><code>public interface XAConnectionWrapper { 
    //åŸºäº XADataSource æŠŠ Connection åŒ…è£…æˆ XAConnection
    XAConnection wrap(XADataSource xaDataSource, Connection connection);
}
</code></pre><p>XAConnectionWrapper æ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œå³æ ¹æ®ä¼ å…¥çš„ XADataSource å’Œä¸€ä¸ªæ™®é€š Connection å¯¹è±¡åˆ›å»ºå‡ºä¸€ä¸ªæ–°çš„ XAConnection å¯¹è±¡ã€‚XAConnectionWrapper æ¥å£çš„ç±»å±‚ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/Ciqc1F9jCrCAXTkWAAD4zJLBg8I622.png" alt="Drawing 4.png"></p>
<p>XAConnectionWrapper æ¥å£çš„å®ç°ç±»</p>
<p>MySQLXAConnectionWrapper ä¸­çš„ warp æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@Override
public XAConnection wrap(final XADataSource xaDataSource, final Connection connection) {
        //è·å–çœŸå® Connection å¯¹è±¡
        Connection physicalConnection = unwrapPhysicalConnection(xaDataSource.getClass().getName(), connection);
        Method method = xaDataSource.getClass().getDeclaredMethod(&quot;wrapConnection&quot;, Connection.class);
        method.setAccessible(true);
       //é€šè¿‡åå°„åŒ…è£… Connection å¯¹è±¡
        return (XAConnection) method.invoke(xaDataSource, physicalConnection);
}
</code></pre><p>ä¸Šè¿°æ–¹æ³•çš„æµç¨‹ä¸ºå…ˆé€šè¿‡ unwrapPhysicalConnection å°†ä¼ å…¥çš„ Connection è½¬å˜ä¸ºä¸€ä¸ªçœŸå®çš„è¿æ¥å¯¹è±¡ï¼Œç„¶åå†åŸºäº XADataSource çš„ wrapConnection æ–¹æ³•é€šè¿‡åå°„å¯¹è¿™ä¸ªç‰©ç†è¿æ¥è¿›è¡ŒåŒ…è£…ï¼Œä»è€Œå½¢æˆä¸€ä¸ª XAConnection å¯¹è±¡ã€‚</p>
<p>å¯¹äº Mysql è€Œè¨€ï¼Œæˆ‘ä»¬åœ¨å‰é¢çš„å†…å®¹ä¸­å·²ç»çŸ¥é“å®ƒæœ‰ä¸¤ç§ XADataSource é©±åŠ¨ç±»ã€‚è€Œåœ¨ MySQLXAConnectionWrapper æˆ‘ä»¬åŒæ ·æ‰¾åˆ°äº†å¦‚ä¸‹æ‰€ç¤ºçš„è¿™ä¸¤ç§é©±åŠ¨ç±»çš„ç±»åå®šä¹‰ï¼š</p>
<pre tabindex="0"><code>private static final String MYSQL_XA_DATASOURCE_5 = &quot;com.mysql.jdbc.jdbc2.optional.MysqlXADataSource&quot;;

private static final String MYSQL_XA_DATASOURCE_8 = &quot;com.mysql.cj.jdbc.MysqlXADataSource&quot;;
</code></pre><p>æ˜¾ç„¶ï¼Œæ ¹æ®æ•°æ®åº“ç‰ˆæœ¬çš„ä¸åŒï¼Œè¿™ä¸¤ä¸ªé©±åŠ¨ç±»çš„è¡Œä¸ºä¹Ÿæœ‰æ‰€ä¸åŒã€‚å› æ­¤ï¼ŒunwrapPhysicalConnection çš„å¤„ç†è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private Connection unwrapPhysicalConnection(final String xaDataSourceClassName, final Connection connection) {
        switch (xaDataSourceClassName) {
            case MYSQL_XA_DATASOURCE_5:
                return (Connection) connection.unwrap(Class.forName(&quot;com.mysql.jdbc.Connection&quot;));
            case MYSQL_XA_DATASOURCE_8:
                return (Connection) connection.unwrap(Class.forName(&quot;com.mysql.cj.jdbc.JdbcConnection&quot;));
            default:
                throw new UnsupportedOperationException(String.format(&quot;Cannot support xa datasource: `%s`&quot;, xaDataSourceClassName));
        }
}
</code></pre><p>ä½œä¸ºå¯¹æ¯”ï¼Œæˆ‘ä»¬å†æ¥çœ‹ PostgreSQLXAConnectionWrapperï¼Œå®ƒçš„ wrap æ–¹æ³•åˆ™æ¯”è¾ƒç®€å•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚æ˜¾ç„¶ï¼Œè¿™éƒ¨åˆ†å†…å®¹çš„ç†è§£éœ€è¦å¯¹ä¸åŒçš„æ•°æ®åº“é©±åŠ¨æœ‰ä¸€å®šçš„äº†è§£ã€‚</p>
<pre tabindex="0"><code>public XAConnection wrap(final XADataSource xaDataSource, final Connection connection) {
        BaseConnection physicalConnection = (BaseConnection) connection.unwrap(Class.forName(&quot;org.postgresql.core.BaseConnection&quot;));
        return new PGXAConnection(physicalConnection);
}
</code></pre><h4 id="3xatransactiondatasource">3.XATransactionDataSource</h4>
<p>ä»‹ç»å®Œäº† XADataSource å’Œ XAConnection çš„åˆ›å»ºè¿‡ç¨‹ä¹‹åï¼Œè®©æˆ‘ä»¬å›åˆ° XAShardingTransactionManagerï¼Œæˆ‘ä»¬å‘ç°è¿™é‡Œç”¨åˆ°çš„ DataSource å¹¶ä¸æ˜¯ JDBC ä¸­åŸç”Ÿçš„ XADataSourceï¼Œè€Œæ˜¯ä¸€ç§ XATransactionDataSourceã€‚</p>
<p>æˆ‘ä»¬æ¥åˆ°è¿™ä¸ª XATransactionDataSource ç±»ï¼Œè¯¥ç±»çš„å˜é‡å’Œæ„é€ å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private final DatabaseType databaseType;
private final String resourceName;
private final DataSource dataSource;
private XADataSource xaDataSource;
private XATransactionManager xaTransactionManager; 
 
public XATransactionDataSource(final DatabaseType databaseType, final String resourceName, final DataSource dataSource, final XATransactionManager xaTransactionManager) {
        this.databaseType = databaseType;
        this.resourceName = resourceName;
        this.dataSource = dataSource;
        if (!CONTAINER_DATASOURCE_NAMES.contains(dataSource.getClass().getSimpleName())) {
            this.xaDataSource = XADataSourceFactory.build(databaseType, dataSource);
            this.xaTransactionManager = xaTransactionManager;
            xaTransactionManager.registerRecoveryResource(resourceName, xaDataSource);
        }
}
</code></pre><p>ä¸Šè¿°å˜é‡æˆ‘ä»¬éƒ½è®¤è¯†ï¼Œè€Œåœ¨æ„é€ å‡½æ•°ä¸­ï¼Œè°ƒç”¨äº† XATransactionManager ç±»ä¸­çš„ registerRecoveryResource æ–¹æ³•å°†æ„å»ºçš„ XADataSource ä½œä¸ºä¸€ç§èµ„æºè¿›è¡Œæ³¨å†Œã€‚</p>
<p>ç„¶åï¼Œæˆ‘ä»¬æ¥çœ‹ XATransactionDataSource ä¸­çš„æ ¸å¿ƒæ–¹æ³• getConnectionï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public Connection getConnection() throws SQLException, SystemException, RollbackException {
        if (CONTAINER_DATASOURCE_NAMES.contains(dataSource.getClass().getSimpleName())) {
            return dataSource.getConnection();
        }
        //ä»DataSourceä¸­ æ„å»ºä¸€ä¸ª Connection
        Connection result = dataSource.getConnection();
        //é€šè¿‡ XAConnectionFactory åˆ›å»ºä¸€ä¸ª XAConnection
        XAConnection xaConnection = XAConnectionFactory.createXAConnection(databaseType, xaDataSource, result);
        //ä» XATransactionManager ä¸­è·å– Transaction å¯¹è±¡
        final Transaction transaction = xaTransactionManager.getTransactionManager().getTransaction();
        //åˆ¤å½“å‰çº¿ç¨‹ä¸­æ˜¯å¦å­˜åœ¨è¿™ä¸ª Transaction
        if (!enlistedTransactions.get().contains(transaction)) {
         //å°† XAConnection ä¸­çš„ XAResource ä¸ç›®æ ‡ Transaction å¯¹è±¡å…³è”èµ·æ¥
            transaction.enlistResource(new SingleXAResource(resourceName, xaConnection.getXAResource()));
            //Transaction ä¸­æ³¨å†Œä¸€ä¸ª Synchronization æ¥å£
            transaction.registerSynchronization(new Synchronization() {
                @Override
                public void beforeCompletion() {
                    enlistedTransactions.get().remove(transaction);
                }

                @Override
                public void afterCompletion(final int status) {
                    enlistedTransactions.get().clear();
                }
            });
            //å°†è¯¥ Transaction å¯¹è±¡æ”¾å…¥åˆ°å½“å‰çº¿ç¨‹ä¸­
            enlistedTransactions.get().add(transaction);
        }
        return result;
}
</code></pre><p>è¿™é‡Œå…ˆä» DataSource ä¸­æ„å»ºä¸€ä¸ª Connectionï¼Œç„¶åä¼ å…¥åˆ° XAConnectionFactory ä¸­åˆ›å»ºä¸€ä¸ª XAConnectionï¼Œæ¥ç€ä» XATransactionManager ä¸­è·å– Transaction å¯¹è±¡ã€‚è¯·æ³¨æ„åœ¨ XATransactionDataSource ä¸­å­˜åœ¨ä¸€ä¸ª ThreadLocal å˜é‡ enlistedTransactionsï¼Œç”¨äºä¿å­˜å½“å‰çº¿ç¨‹æ‰€æ¶‰åŠçš„ Transaction å¯¹è±¡åˆ—è¡¨ï¼š</p>
<pre tabindex="0"><code>private final ThreadLocal&lt;Set&lt;Transaction&gt;&gt; enlistedTransactions = new ThreadLocal&lt;Set&lt;Transaction&gt;&gt;() {
        @Override
        public Set&lt;Transaction&gt; initialValue() {
            return new HashSet&lt;&gt;();
        }
};
</code></pre><p>åœ¨ä¸Šè¿°æ–¹æ³•ä¸­ï¼Œå½“ä» XATransactionManager ä¸­è·å– Transaction å¯¹è±¡ä¹‹åï¼Œä¼šå…ˆåˆ¤æ–­ enlistedTransactionsä¸­ æ˜¯å¦å­˜åœ¨è¯¥ Transaction å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™å°† XAConnection ä¸­çš„ XAResource ä¸ç›®æ ‡ Transaction å¯¹è±¡å…³è”èµ·æ¥ã€‚</p>
<p>ç„¶åæˆ‘ä»¬å†æ¥çœ‹ Transaction å¯¹è±¡çš„ registerSynchronization æ–¹æ³•çš„ä½¿ç”¨æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ³¨å†Œäº†ä¸€ä¸ª Synchronization æ¥å£ï¼Œè¯¥æ¥å£åŒ…å«äº† beforeCompletion å’Œ afterCompletion è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚</p>
<p>åœ¨äºŒé˜¶æ®µæäº¤ä¹‹å‰ï¼ŒTransctionManager ä¼šè°ƒç”¨ Synchronization æ¥å£çš„ beforeCompletion æ–¹æ³•ï¼›è€Œå½“äº‹åŠ¡ç»“æŸæ—¶ï¼ŒTransctionManager ä¼šè°ƒç”¨ Synchronization æ¥å£çš„ afterCompletionæ–¹æ³•ã€‚æˆ‘ä»¬åœ¨ getConnection æ–¹æ³•ä¸­çœ‹åˆ°è¿™ä¸¤ä¸ªæ–¹æ³•çš„åº”ç”¨ã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬æŠŠè¯¥ Transaction å¯¹è±¡æ”¾å…¥åˆ°çº¿ç¨‹å®‰å…¨çš„ enlistedTransactions ä¸­ã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ XATransactionDataSource çš„ close æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@Override
public void close() {
        if (!CONTAINER_DATASOURCE_NAMES.contains(dataSource.getClass().getSimpleName())) {
            xaTransactionManager.removeRecoveryResource(resourceName, xaDataSource);
        } else {
            close(dataSource);
        }
}
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œè°ƒç”¨äº† XATransactionManager çš„ removeRecoveryResource æ–¹æ³•å°†èµ„æºè¿›è¡Œç§»å‡ºã€‚</p>
<p>è‡³æ­¤ï¼ŒåŸºäº XATransactionDataSource è·å– Connection çš„è¿‡ç¨‹ä¹Ÿä»‹ç»å®Œæ¯•ã€‚å…³äº XATransactionManagerçš„ å…·ä½“å†…å®¹æˆ‘ä»¬æ”¾åœ¨ä¸‹ä¸€è¯¾æ—¶ä¸­ç»§ç»­è¿›è¡Œæ¢è®¨ã€‚</p>
<h3 id="ä»æºç è§£æåˆ°æ—¥å¸¸å¼€å‘">ä»æºç è§£æåˆ°æ—¥å¸¸å¼€å‘</h3>
<p>ShardingSphere ä½œä¸ºä¸€æ¬¾å®Œå…¨å…¼å®¹ JDBC è§„èŒƒçš„åˆ†å¸ƒå¼æ•°æ®åº“ä¸­é—´ä»¶ï¼ŒåŒæ ·å®Œæˆäº†é’ˆå¯¹åˆ†å¸ƒå¼äº‹åŠ¡ä¸­çš„ç›¸å…³å¯¹è±¡çš„å…¼å®¹ã€‚ä»Šå¤©çš„è¯¾ç¨‹ä¸­ï¼Œè¿›ä¸€æ­¥å¼ºåŒ–äº†æˆ‘ä»¬å¯¹ JDBC è§„èŒƒçš„ç†è§£å’Œå¦‚ä½•æ‰©å±•JDBC è§„èŒƒä¸­æ ¸å¿ƒæ¥å£çš„æ–¹æ³•ã€‚åŒæ—¶ï¼Œåœ¨ MySQLXAConnectionWrapper è¿™ä¸ª Wrapper ç±»ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå†æ¬¡çœ‹åˆ°ä½¿ç”¨åå°„æŠ€æœ¯åˆ›å»º XAConnection å¯¹è±¡çš„å®ç°æ–¹æ³•ã€‚è¿™äº›å¼€å‘æŠ€å·§éƒ½å€¼å¾—æˆ‘ä»¬è¿›è¡Œå­¦ä¹ å’Œåº”ç”¨ã€‚</p>
<h3 id="å°ç»“ä¸é¢„å‘Š">å°ç»“ä¸é¢„å‘Š</h3>
<p>åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯ä¸€ä¸ªç›¸å¯¹å¤æ‚çš„æ¦‚å¿µï¼ŒShardingSphere ä¸­æä¾›äº†å¼ºä¸€è‡´æ€§å’Œæœ€ç»ˆä¸€è‡´æ€§ä¸¤ç§å®ç°æ–¹æ¡ˆã€‚ä»Šå¤©çš„å†…å®¹æˆ‘ä»¬å›´ç»•åŸºäº XA åè®®çš„åˆ†ç‰‡äº‹åŠ¡ç®¡ç†å™¨ XAShardingTransactionManager å±•å¼€äº†è®¨è®ºï¼Œåœ¨ç†è§£ XAShardingTransactionManager ä¸­ XADataSourceã€XAConnection ç­‰æ ¸å¿ƒå¯¹è±¡æ—¶ï¼Œé‡ç‚¹è¿˜æ˜¯éœ€è¦ç«™åœ¨ JDBC è§„èŒƒçš„åŸºç¡€ä¸Šï¼ŒæŒæ¡ä¸åˆ†å¸ƒå¼äº‹åŠ¡é›†æˆå’Œå…¼å®¹çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œæœ¬è¯¾æ—¶å¯¹è¿™ä¸€è¿‡ç¨‹è¿›è¡Œäº†è¯¦ç»†çš„ä»‹ç»ã€‚</p>
<p>è¿™é‡Œç»™ä½ ç•™ä¸€é“æ€è€ƒé¢˜ï¼šShardingSphere ä¸­å¯¹åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„å¼ºä¸€è‡´æ€§äº‹åŠ¡åšäº†å“ªäº›ç»´åº¦çš„æŠ½è±¡ï¼Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸å¤§å®¶è®¨è®ºï¼Œæˆ‘å°†é€ä¸€ç‚¹è¯„è§£ç­”ã€‚</p>
<p>XAShardingTransactionManager çš„å†…å®¹å¾ˆå¤šï¼Œä¸‹ä¸€è¯¾æ—¶ï¼Œæˆ‘ä»¬å°†åœ¨ä»Šå¤©è¯¾æ—¶çš„åŸºç¡€ä¸Šï¼Œç»§ç»­æ¢è®¨ XAShardingTransactionManager çš„å‰©ä½™éƒ¨åˆ†å†…å®¹ï¼Œä»¥åŠ ShardingSphere ä¸­å¦ä¸€ä¸ªåˆ†ç‰‡äº‹åŠ¡ç®¡ç†å™¨ SeataATShardingTransactionManagerã€‚</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/27-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3-shardingsphere-%E4%B8%AD%E5%AF%B9%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%8A%BD%E8%B1%A1%E8%BF%87%E7%A8%8B/"><span>27 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¦‚ä½•ç†è§£ ShardingSphere ä¸­å¯¹åˆ†å¸ƒå¼äº‹åŠ¡çš„æŠ½è±¡è¿‡ç¨‹ï¼Ÿ</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/29-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1shardingsphere-%E4%B8%AD%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%E4%B8%8B/"><span>29 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸‹ï¼‰</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 28280 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>