<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>14 åˆ†å¸ƒå¼ä¸»é”®ï¼šShardingSphere ä¸­æœ‰å“ªäº›åˆ†å¸ƒå¼ä¸»é”®å®ç°æ–¹å¼ï¼Ÿ | Yipsen Ye</title>
<meta name="description" content="æœ¬è¯¾æ—¶æˆ‘å°†ä¸ºä½ è®²è§£ ShardingSphere ä¸­çš„åˆ†å¸ƒå¼ä¸»é”®å®ç°æ–¹å¼ã€‚
åœ¨ä¼ ç»Ÿæ•°æ®åº“è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸»é”®è‡ªåŠ¨ç”ŸæˆæŠ€æœ¯æ˜¯åŸºæœ¬éœ€æ±‚ã€‚å„ä¸ªæ•°æ®åº“å¯¹è¯¥éœ€æ±‚ä¹Ÿæä¾›äº†ç›¸åº”çš„æ”¯æŒï¼Œæ¯”å¦‚ MySQL çš„è‡ªå¢é”®ï¼ŒOracle çš„è‡ªå¢åºåˆ—ç­‰ã€‚è€Œåœ¨åˆ†ç‰‡åœºæ™¯ä¸‹ï¼Œé—®é¢˜å°±å˜å¾—æœ‰ç‚¹å¤æ‚ï¼Œæˆ‘ä»¬ä¸èƒ½ä¾é å•ä¸ªå®ä¾‹ä¸Šçš„è‡ªå¢é”®æ¥å®ç°ä¸åŒæ•°æ®èŠ‚ç‚¹ä¹‹é—´çš„å…¨å±€å”¯ä¸€ä¸»é”®ï¼Œè¿™æ—¶åˆ†å¸ƒå¼ä¸»é”®çš„éœ€æ±‚å°±åº”è¿è€Œç”Ÿã€‚ShardingSphere ä½œä¸ºä¸€æ¬¾ä¼˜ç§€çš„åˆ†åº“åˆ†è¡¨å¼€æºè½¯ä»¶ï¼ŒåŒæ ·æä¾›äº†åˆ†å¸ƒå¼ä¸»é”®çš„å®ç°æœºåˆ¶ï¼Œä»Šå¤©ï¼Œæˆ‘ä»¬å°±å¯¹è¿™ä¸€æœºåˆ¶çš„åŸºæœ¬åŸç†å’Œå®ç°æ–¹å¼å±•å¼€è®¨è®ºã€‚
ShardingSphere ä¸­çš„è‡ªåŠ¨ç”Ÿæˆé”®æ–¹æ¡ˆ åœ¨ä»‹ç» ShardingSphere æä¾›çš„å…·ä½“åˆ†å¸ƒå¼ä¸»é”®å®ç°æ–¹å¼ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å…ˆå¯¹æ¡†æ¶ä¸­æŠ½è±¡çš„è‡ªåŠ¨ç”Ÿæˆé”® GeneratedKey æ–¹æ¡ˆè¿›è¡Œè®¨è®ºï¼Œä»è€Œå¸®åŠ©ä½ æ˜ç¡®åˆ†å¸ƒå¼ä¸»é”®çš„å…·ä½“ä½¿ç”¨åœºæ™¯å’Œä½¿ç”¨æ–¹æ³•ã€‚
ShardingSphere ä¸­çš„ GeneratedKey GeneratedKey å¹¶ä¸æ˜¯ ShardingSphere æ‰€åˆ›é€ çš„æ¦‚å¿µã€‚å¦‚æœä½ ç†Ÿæ‚‰ Mybatis è¿™ç§ ORM æ¡†æ¶ï¼Œå¯¹å®ƒå°±ä¸ä¼šé™Œç”Ÿã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬åœ¨ã€Šæ•°æ®åˆ†ç‰‡ï¼šå¦‚ä½•å®ç°åˆ†åº“ã€åˆ†è¡¨ã€åˆ†åº“&#43;åˆ†è¡¨ä»¥åŠå¼ºåˆ¶è·¯ç”±ï¼ˆä¸Šï¼‰ï¼Ÿã€‹ä¸­å·²ç»ä»‹ç»äº†åœ¨ Mybatis ä¸­åµŒå…¥ GeneratedKey çš„å®ç°æ–¹æ³•ã€‚é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šåœ¨ Mybatis çš„ Mapper æ–‡ä»¶ä¸­è®¾ç½® useGeneratedKeys å’Œ keyProperty å±æ€§ï¼š
 &amp;lt;insert id=&amp;quot;addEntity&amp;quot; useGeneratedKeys=&amp;quot;true&amp;quot; keyProperty=&amp;quot;recordId&amp;quot; &amp;gt; INSERT INTO health_record (user_id, level_id, remark) VALUES (#{userId,jdbcType=INTEGER}, #{levelId,jdbcType=INTEGER}, #{remark,jdbcType=VARCHAR}) &amp;lt;/insert&amp;gt; åœ¨æ‰§è¡Œè¿™ä¸ª insert è¯­å¥æ—¶ï¼Œè¿”å›çš„å¯¹è±¡ä¸­è‡ªåŠ¨åŒ…å«äº†ç”Ÿæˆçš„ä¸»é”®å€¼ã€‚å½“ç„¶ï¼Œè¿™ç§æ–¹å¼èƒ½å¤Ÿç”Ÿæ•ˆçš„å‰ææ˜¯å¯¹åº”çš„æ•°æ®åº“æœ¬èº«æ”¯æŒè‡ªå¢é•¿çš„ä¸»é”®ã€‚
å½“æˆ‘ä»¬ä½¿ç”¨ ShardingSphere æä¾›çš„è‡ªåŠ¨ç”Ÿæˆé”®æ–¹æ¡ˆæ—¶ï¼Œå¼€å‘è¿‡ç¨‹ä»¥åŠæ•ˆæœå’Œä¸Šé¢æè¿°çš„å®Œå…¨ä¸€è‡´ã€‚åœ¨ ShardingSphere ä¸­ï¼ŒåŒæ ·å®ç°äº†ä¸€ä¸ª GeneratedKey ç±»ã€‚è¯·æ³¨æ„ï¼Œè¯¥ç±»ä½äº sharding-core-route å·¥ç¨‹ä¸‹ã€‚æˆ‘ä»¬å…ˆçœ‹è¯¥ç±»æä¾›çš„ getGenerateKey æ–¹æ³•ï¼š
 public static Optional&amp;lt;GeneratedKey&amp;gt; getGenerateKey(final ShardingRule shardingRule, final TableMetas tableMetas, final List&amp;lt;Object&amp;gt; parameters, final InsertStatement insertStatement) { //æ‰¾åˆ°è‡ªå¢é•¿åˆ— Optional&amp;lt;String&amp;gt; generateKeyColumnName = shardingRule.">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/shardingsphere%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e7%b2%be%e8%ae%b2/">ShardingSphereæ ¸å¿ƒåŸç†ç²¾è®²</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/00-%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E5%AD%A6%E4%B9%A0%E4%B8%80%E6%AC%BE%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/">00 å¦‚ä½•æ­£ç¡®å­¦ä¹ ä¸€æ¬¾åˆ†åº“åˆ†è¡¨å¼€æºæ¡†æ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/01-%E4%BB%8E%E7%90%86%E8%AE%BA%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%A6%82%E4%BD%95%E8%AE%A9%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%9C%9F%E6%AD%A3%E8%90%BD%E5%9C%B0/">01 ä»ç†è®ºåˆ°å®è·µï¼šå¦‚ä½•è®©åˆ†åº“åˆ†è¡¨çœŸæ­£è½åœ°ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/02-%E9%A1%B6%E7%BA%A7%E9%A1%B9%E7%9B%AEshardingsphere-%E6%98%AF%E4%B8%80%E6%AC%BE%E4%BB%80%E4%B9%88%E6%A0%B7%E7%9A%84-apache-%E5%BC%80%E6%BA%90%E8%BD%AF%E4%BB%B6/">02 é¡¶çº§é¡¹ç›®ï¼šShardingSphere æ˜¯ä¸€æ¬¾ä»€ä¹ˆæ ·çš„ Apache å¼€æºè½¯ä»¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/03-%E8%A7%84%E8%8C%83%E5%85%BC%E5%AE%B9jdbc-%E8%A7%84%E8%8C%83%E4%B8%8E-shardingsphere-%E6%98%AF%E4%BB%80%E4%B9%88%E5%85%B3%E7%B3%BB/">03 è§„èŒƒå…¼å®¹ï¼šJDBC è§„èŒƒä¸ ShardingSphere æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/04-%E5%BA%94%E7%94%A8%E9%9B%86%E6%88%90%E5%9C%A8%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F%E4%B8%AD%E4%BD%BF%E7%94%A8-shardingsphere-%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9C%89%E5%93%AA%E4%BA%9B/">04 åº”ç”¨é›†æˆï¼šåœ¨ä¸šåŠ¡ç³»ç»Ÿä¸­ä½¿ç”¨ ShardingSphere çš„æ–¹å¼æœ‰å“ªäº›ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/05-%E9%85%8D%E7%BD%AE%E9%A9%B1%E5%8A%A8shardingsphere-%E4%B8%AD%E7%9A%84%E9%85%8D%E7%BD%AE%E4%BD%93%E7%B3%BB%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E7%9A%84/">05 é…ç½®é©±åŠ¨ï¼šShardingSphere ä¸­çš„é…ç½®ä½“ç³»æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/09-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E4%B8%8E%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1/">09 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¦‚ä½•ä½¿ç”¨å¼ºä¸€è‡´æ€§äº‹åŠ¡ä¸æŸ”æ€§äº‹åŠ¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/10-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E5%A6%82%E4%BD%95%E7%A1%AE%E4%BF%9D%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AE%89%E5%85%A8%E8%AE%BF%E9%97%AE/">10 æ•°æ®è„±æ•ï¼šå¦‚ä½•ç¡®ä¿æ•æ„Ÿæ•°æ®çš„å®‰å…¨è®¿é—®ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/11-%E7%BC%96%E6%8E%92%E6%B2%BB%E7%90%86%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/">11 ç¼–æ’æ²»ç†ï¼šå¦‚ä½•å®ç°åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„åŠ¨æ€é…ç½®ç®¡ç†ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/12-%E4%BB%8E%E5%BA%94%E7%94%A8%E5%88%B0%E5%8E%9F%E7%90%86%E5%A6%82%E4%BD%95%E9%AB%98%E6%95%88%E9%98%85%E8%AF%BB-shardingsphere-%E6%BA%90%E7%A0%81/">12 ä»åº”ç”¨åˆ°åŸç†ï¼šå¦‚ä½•é«˜æ•ˆé˜…è¯» ShardingSphere æºç ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/13-%E5%BE%AE%E5%86%85%E6%A0%B8%E6%9E%B6%E6%9E%84shardingsphere-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%89%A9%E5%B1%95%E6%80%A7/">13 å¾®å†…æ ¸æ¶æ„ï¼šShardingSphere å¦‚ä½•å®ç°ç³»ç»Ÿçš„æ‰©å±•æ€§ï¼Ÿ</a></li>
                
                
                
                    <li>14 åˆ†å¸ƒå¼ä¸»é”®ï¼šShardingSphere ä¸­æœ‰å“ªäº›åˆ†å¸ƒå¼ä¸»é”®å®ç°æ–¹å¼ï¼Ÿ</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/15-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8A/">15 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/16-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8B/">16 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/17-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E5%88%86%E7%89%87%E8%B7%AF%E7%94%B1%E6%A0%B8%E5%BF%83%E7%B1%BB-shardingrouter-%E7%9A%84%E8%BF%90%E4%BD%9C%E6%9C%BA%E5%88%B6/">17 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•ç†è§£åˆ†ç‰‡è·¯ç”±æ ¸å¿ƒç±» ShardingRouter çš„è¿ä½œæœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/18-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E7%9A%84%E5%88%86%E7%89%87%E8%B7%AF%E7%94%B1%E5%92%8C%E5%B9%BF%E6%92%AD%E8%B7%AF%E7%94%B1/">18 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•å®ç°æ•°æ®è®¿é—®çš„åˆ†ç‰‡è·¯ç”±å’Œå¹¿æ’­è·¯ç”±ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/19-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%9C%A8%E8%B7%AF%E7%94%B1%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%9B%86%E6%88%90%E5%A4%9A%E7%A7%8D%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E5%92%8C%E8%B7%AF%E7%94%B1%E7%AE%97%E6%B3%95/">19 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•åœ¨è·¯ç”±è¿‡ç¨‹ä¸­é›†æˆå¤šç§è·¯ç”±ç­–ç•¥å’Œè·¯ç”±ç®—æ³•ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/20-%E6%94%B9%E5%86%99%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84-sql-%E6%94%B9%E5%86%99%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6/">20 æ”¹å†™å¼•æ“ï¼šå¦‚ä½•ç†è§£è£…é¥°å™¨æ¨¡å¼ä¸‹çš„ SQL æ”¹å†™å®ç°æœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/21-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%88%86%E7%89%87%E7%8E%AF%E5%A2%83%E4%B8%8B-sql-%E6%89%A7%E8%A1%8C%E7%9A%84%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E6%8A%BD%E8%B1%A1/">21 æ‰§è¡Œå¼•æ“ï¼šåˆ†ç‰‡ç¯å¢ƒä¸‹ SQL æ‰§è¡Œçš„æ•´ä½“æµç¨‹åº”è¯¥å¦‚ä½•è¿›è¡ŒæŠ½è±¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/22-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E6%8A%8A%E6%8F%A1-shardingsphere-%E4%B8%AD%E7%9A%84-executor-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8A/">22 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/23-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E6%8A%8A%E6%8F%A1-shardingsphere-%E4%B8%AD%E7%9A%84-executor-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8B/">23 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/24-%E5%BD%92%E5%B9%B6%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E6%95%B0%E6%8D%AE%E5%BD%92%E5%B9%B6%E7%9A%84%E7%B1%BB%E5%9E%8B%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%BD%92%E5%B9%B6%E7%AD%96%E7%95%A5%E7%9A%84%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B/">24 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æ•°æ®å½’å¹¶çš„ç±»å‹ä»¥åŠç®€å•å½’å¹¶ç­–ç•¥çš„å®ç°è¿‡ç¨‹ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/25-%E5%BD%92%E5%B9%B6%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E6%B5%81%E5%BC%8F%E5%BD%92%E5%B9%B6%E5%92%8C%E5%86%85%E5%AD%98%E5%BD%92%E5%B9%B6%E5%9C%A8%E5%A4%8D%E6%9D%82%E5%BD%92%E5%B9%B6%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84%E5%BA%94%E7%94%A8%E6%96%B9%E5%BC%8F/">25 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æµå¼å½’å¹¶å’Œå†…å­˜å½’å¹¶åœ¨å¤æ‚å½’å¹¶åœºæ™¯ä¸‹çš„åº”ç”¨æ–¹å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/26-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%99%AE%E9%80%9A%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%92%8C%E5%88%86%E7%89%87%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%88%86%E5%88%AB%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84/">26 è¯»å†™åˆ†ç¦»ï¼šæ™®é€šä¸»ä»æ¶æ„å’Œåˆ†ç‰‡ä¸»ä»æ¶æ„åˆ†åˆ«æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/27-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3-shardingsphere-%E4%B8%AD%E5%AF%B9%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%8A%BD%E8%B1%A1%E8%BF%87%E7%A8%8B/">27 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¦‚ä½•ç†è§£ ShardingSphere ä¸­å¯¹åˆ†å¸ƒå¼äº‹åŠ¡çš„æŠ½è±¡è¿‡ç¨‹ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/28-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1shardingsphere-%E4%B8%AD%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%E4%B8%8A/">28 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/29-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1shardingsphere-%E4%B8%AD%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%E4%B8%8B/">29 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/30-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E6%94%B9%E5%86%99%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%E4%BD%8E%E4%BE%B5%E5%85%A5%E6%80%A7%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E6%96%B9%E6%A1%88/">30 æ•°æ®è„±æ•ï¼šå¦‚ä½•åŸºäºæ”¹å†™å¼•æ“å®ç°ä½ä¾µå…¥æ€§æ•°æ®è„±æ•æ–¹æ¡ˆï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/31-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E7%9A%84%E5%8A%A8%E6%80%81%E5%8C%96%E7%AE%A1%E7%90%86/">31 é…ç½®ä¸­å¿ƒï¼šå¦‚ä½•åŸºäºé…ç½®ä¸­å¿ƒå®ç°é…ç½®ä¿¡æ¯çš„åŠ¨æ€åŒ–ç®¡ç†ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/32-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BF%E9%97%AE%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6/">32 æ³¨å†Œä¸­å¿ƒï¼šå¦‚ä½•åŸºäºæ³¨å†Œä¸­å¿ƒå®ç°æ•°æ®åº“è®¿é—®ç†”æ–­æœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/33-%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E-hook-%E6%9C%BA%E5%88%B6%E4%BB%A5%E5%8F%8A-opentracing-%E5%8D%8F%E8%AE%AE%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA/">33 é“¾è·¯è·Ÿè¸ªï¼šå¦‚ä½•åŸºäº Hook æœºåˆ¶ä»¥åŠ OpenTracing åè®®å®ç°æ•°æ®è®¿é—®é“¾è·¯è·Ÿè¸ªï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/35-%E7%BB%93%E8%AF%ADshardingsphere-%E6%80%BB%E7%BB%93%E5%8F%8A%E5%B1%95%E6%9C%9B/">35 ç»“è¯­ï¼šShardingSphere æ€»ç»“åŠå±•æœ›</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">14 åˆ†å¸ƒå¼ä¸»é”®ï¼šShardingSphere ä¸­æœ‰å“ªäº›åˆ†å¸ƒå¼ä¸»é”®å®ç°æ–¹å¼ï¼Ÿ</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2021-12-22 01:55:53</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/sharding/">sharding</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/">ShardingSphereæ ¸å¿ƒåŸç†ç²¾è®²</a>
                
            </div></div>
        <div class="post-content">
            <p>æœ¬è¯¾æ—¶æˆ‘å°†ä¸ºä½ è®²è§£ ShardingSphere ä¸­çš„åˆ†å¸ƒå¼ä¸»é”®å®ç°æ–¹å¼ã€‚</p>
<p>åœ¨ä¼ ç»Ÿæ•°æ®åº“è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸»é”®è‡ªåŠ¨ç”ŸæˆæŠ€æœ¯æ˜¯åŸºæœ¬éœ€æ±‚ã€‚å„ä¸ªæ•°æ®åº“å¯¹è¯¥éœ€æ±‚ä¹Ÿæä¾›äº†ç›¸åº”çš„æ”¯æŒï¼Œæ¯”å¦‚ MySQL çš„è‡ªå¢é”®ï¼ŒOracle çš„è‡ªå¢åºåˆ—ç­‰ã€‚è€Œåœ¨åˆ†ç‰‡åœºæ™¯ä¸‹ï¼Œé—®é¢˜å°±å˜å¾—æœ‰ç‚¹å¤æ‚ï¼Œæˆ‘ä»¬ä¸èƒ½ä¾é å•ä¸ªå®ä¾‹ä¸Šçš„è‡ªå¢é”®æ¥å®ç°ä¸åŒæ•°æ®èŠ‚ç‚¹ä¹‹é—´çš„å…¨å±€å”¯ä¸€ä¸»é”®ï¼Œè¿™æ—¶åˆ†å¸ƒå¼ä¸»é”®çš„éœ€æ±‚å°±åº”è¿è€Œç”Ÿã€‚ShardingSphere ä½œä¸ºä¸€æ¬¾ä¼˜ç§€çš„åˆ†åº“åˆ†è¡¨å¼€æºè½¯ä»¶ï¼ŒåŒæ ·æä¾›äº†åˆ†å¸ƒå¼ä¸»é”®çš„å®ç°æœºåˆ¶ï¼Œä»Šå¤©ï¼Œæˆ‘ä»¬å°±å¯¹è¿™ä¸€æœºåˆ¶çš„åŸºæœ¬åŸç†å’Œå®ç°æ–¹å¼å±•å¼€è®¨è®ºã€‚</p>
<h3 id="shardingsphere-ä¸­çš„è‡ªåŠ¨ç”Ÿæˆé”®æ–¹æ¡ˆ">ShardingSphere ä¸­çš„è‡ªåŠ¨ç”Ÿæˆé”®æ–¹æ¡ˆ</h3>
<p>åœ¨ä»‹ç» ShardingSphere æä¾›çš„å…·ä½“åˆ†å¸ƒå¼ä¸»é”®å®ç°æ–¹å¼ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å…ˆå¯¹æ¡†æ¶ä¸­æŠ½è±¡çš„è‡ªåŠ¨ç”Ÿæˆé”® GeneratedKey æ–¹æ¡ˆè¿›è¡Œè®¨è®ºï¼Œä»è€Œå¸®åŠ©ä½ æ˜ç¡®åˆ†å¸ƒå¼ä¸»é”®çš„å…·ä½“ä½¿ç”¨åœºæ™¯å’Œä½¿ç”¨æ–¹æ³•ã€‚</p>
<h4 id="shardingsphere-ä¸­çš„-generatedkey">ShardingSphere ä¸­çš„ GeneratedKey</h4>
<p>GeneratedKey å¹¶ä¸æ˜¯ ShardingSphere æ‰€åˆ›é€ çš„æ¦‚å¿µã€‚å¦‚æœä½ ç†Ÿæ‚‰ Mybatis è¿™ç§ ORM æ¡†æ¶ï¼Œå¯¹å®ƒå°±ä¸ä¼šé™Œç”Ÿã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬åœ¨ã€Šæ•°æ®åˆ†ç‰‡ï¼šå¦‚ä½•å®ç°åˆ†åº“ã€åˆ†è¡¨ã€åˆ†åº“+åˆ†è¡¨ä»¥åŠå¼ºåˆ¶è·¯ç”±ï¼ˆä¸Šï¼‰ï¼Ÿã€‹ä¸­å·²ç»ä»‹ç»äº†åœ¨ Mybatis ä¸­åµŒå…¥ GeneratedKey çš„å®ç°æ–¹æ³•ã€‚é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šåœ¨ Mybatis çš„ Mapper æ–‡ä»¶ä¸­è®¾ç½® useGeneratedKeys å’Œ keyProperty å±æ€§ï¼š</p>
<pre tabindex="0"><code>    &lt;insert id=&quot;addEntity&quot; useGeneratedKeys=&quot;true&quot; keyProperty=&quot;recordId&quot; &gt; 
        INSERT INTO health_record (user_id, level_id, remark)  
        VALUES (#{userId,jdbcType=INTEGER}, #{levelId,jdbcType=INTEGER},  
             #{remark,jdbcType=VARCHAR}) 
    &lt;/insert&gt; 
</code></pre><p>åœ¨æ‰§è¡Œè¿™ä¸ª insert è¯­å¥æ—¶ï¼Œè¿”å›çš„å¯¹è±¡ä¸­è‡ªåŠ¨åŒ…å«äº†ç”Ÿæˆçš„ä¸»é”®å€¼ã€‚å½“ç„¶ï¼Œè¿™ç§æ–¹å¼èƒ½å¤Ÿç”Ÿæ•ˆçš„å‰ææ˜¯å¯¹åº”çš„æ•°æ®åº“æœ¬èº«æ”¯æŒè‡ªå¢é•¿çš„ä¸»é”®ã€‚</p>
<p>å½“æˆ‘ä»¬ä½¿ç”¨ ShardingSphere æä¾›çš„è‡ªåŠ¨ç”Ÿæˆé”®æ–¹æ¡ˆæ—¶ï¼Œå¼€å‘è¿‡ç¨‹ä»¥åŠæ•ˆæœå’Œä¸Šé¢æè¿°çš„å®Œå…¨ä¸€è‡´ã€‚åœ¨ ShardingSphere ä¸­ï¼ŒåŒæ ·å®ç°äº†ä¸€ä¸ª GeneratedKey ç±»ã€‚<strong>è¯·æ³¨æ„ï¼Œè¯¥ç±»ä½äº sharding-core-route å·¥ç¨‹ä¸‹</strong>ã€‚æˆ‘ä»¬å…ˆçœ‹è¯¥ç±»æä¾›çš„ getGenerateKey æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>    public static Optional&lt;GeneratedKey&gt; getGenerateKey(final ShardingRule shardingRule, final TableMetas tableMetas, final List&lt;Object&gt; parameters, final InsertStatement insertStatement) { 
        //æ‰¾åˆ°è‡ªå¢é•¿åˆ— 
     Optional&lt;String&gt; generateKeyColumnName = shardingRule.findGenerateKeyColumnName(insertStatement.getTable().getTableName()); 
        if (!generateKeyColumnName.isPresent()) { 
            return Optional.absent(); 
        } 
         
        //åˆ¤æ–­è‡ªå¢é•¿ç±»æ˜¯å¦å·²ç”Ÿæˆä¸»é”®å€¼ 
        return Optional.of(containsGenerateKey(tableMetas, insertStatement, generateKeyColumnName.get()) 
                ? findGeneratedKey(tableMetas, parameters, insertStatement, generateKeyColumnName.get()) : createGeneratedKey(shardingRule, insertStatement, generateKeyColumnName.get())); 
} 
</code></pre><p>è¿™æ®µä»£ç çš„é€»è¾‘åœ¨äºå…ˆä» ShardingRule ä¸­æ‰¾åˆ°ä¸»é”®å¯¹åº”çš„ Columnï¼Œç„¶ååˆ¤æ–­æ˜¯å¦å·²ç»åŒ…å«ä¸»é”®ï¼šå¦‚æœæ˜¯åˆ™æ‰¾åˆ°è¯¥ä¸»é”®ï¼Œå¦‚æœä¸æ˜¯åˆ™ç”Ÿæˆæ–°çš„ä¸»é”®ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬çš„é‡ç‚¹æ˜¯åˆ†å¸ƒå¼ä¸»é”®çš„ç”Ÿæˆï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥æ¥åˆ° createGeneratedKey æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>private static GeneratedKey createGeneratedKey(final ShardingRule shardingRule, final InsertStatement insertStatement, final String generateKeyColumnName) { 
        GeneratedKey result = new GeneratedKey(generateKeyColumnName, true); 
        for (int i = 0; i &lt; insertStatement.getValueListCount(); i++) { 
            result.getGeneratedValues().add(shardingRule.generateKey(insertStatement.getTable().getTableName())); 
        } 
        return result; 
} 
</code></pre><p>åœ¨ GeneratedKey ä¸­å­˜åœ¨ä¸€ä¸ªç±»å‹ä¸º LinkedList çš„ generatedValues å˜é‡ï¼Œç”¨äºä¿å­˜ç”Ÿæˆçš„ä¸»é”®ï¼Œä½†å®é™…ä¸Šï¼Œç”Ÿæˆä¸»é”®çš„å·¥ä½œè½¬ç§»åˆ°äº† ShardingRule çš„ generateKey æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬è·³è½¬åˆ° ShardingRule ç±»å¹¶æ‰¾åˆ°è¿™ä¸ª generateKey æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>    public Comparable&lt;?&gt; generateKey(final String logicTableName) { 
        Optional&lt;TableRule&gt; tableRule = findTableRule(logicTableName); 
        if (!tableRule.isPresent()) { 
            throw new ShardingConfigurationException(&quot;Cannot find strategy for generate keys.&quot;); 
        } 
         
        //ä»TableRuleä¸­è·å–ShardingKeyGeneratorå¹¶ç”Ÿæˆåˆ†å¸ƒå¼ä¸»é”® 
        ShardingKeyGenerator shardingKeyGenerator = null == tableRule.get().getShardingKeyGenerator() ? defaultShardingKeyGenerator : tableRule.get().getShardingKeyGenerator(); 
        return shardingKeyGenerator.generateKey(); 
} 
</code></pre><p>é¦–å…ˆï¼Œæ ¹æ®ä¼ å…¥çš„ logicTableName æ‰¾åˆ°å¯¹åº”çš„ TableRuleï¼ŒåŸºäº TableRule æ‰¾åˆ°å…¶åŒ…å«çš„ ShardingKeyGeneratorï¼Œç„¶åé€šè¿‡ ShardingKeyGenerator çš„ generateKey æ¥ç”Ÿæˆä¸»é”®ã€‚ä»è®¾è®¡æ¨¡å¼ä¸Šè®²ï¼ŒShardingRule ä¹Ÿåªæ˜¯ä¸€ä¸ªå¤–è§‚ç±»ï¼ŒçœŸæ­£åˆ›å»º ShardingKeyGenerator çš„è¿‡ç¨‹åº”è¯¥æ˜¯åœ¨ TableRule ä¸­ã€‚è€Œè¿™é‡Œçš„ ShardingKeyGenerator æ˜¾ç„¶å°±æ˜¯çœŸæ­£ç”Ÿæˆåˆ†å¸ƒå¼ä¸»é”®å…¥å£ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ã€‚</p>
<h4 id="shardingkeygenerator">ShardingKeyGenerator</h4>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æ ShardingKeyGenerator æ¥å£ï¼Œä»å®šä¹‰ä¸Šçœ‹ï¼Œè¯¥æ¥å£ç»§æ‰¿äº† TypeBasedSPI æ¥å£ï¼š</p>
<pre tabindex="0"><code>public interface ShardingKeyGenerator extends TypeBasedSPI {     
    Comparable&lt;?&gt; generateKey(); 
} 
</code></pre><p>æ¥åˆ° TableRule ä¸­ï¼Œåœ¨å®ƒçš„ä¸€ä¸ªæ„é€ å‡½æ•°ä¸­æ‰¾åˆ°äº† ShardingKeyGenerator çš„åˆ›å»ºè¿‡ç¨‹ï¼š</p>
<pre tabindex="0"><code>shardingKeyGenerator = containsKeyGeneratorConfiguration(tableRuleConfig) 
                ? new ShardingKeyGeneratorServiceLoader().newService(tableRuleConfig.getKeyGeneratorConfig().getType(), tableRuleConfig.getKeyGeneratorConfig().getProperties()) : null; 
</code></pre><p>è¿™é‡Œæœ‰ä¸€ä¸ª ShardingKeyGeneratorServiceLoader ç±»ï¼Œè¯¥ç±»å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>public final class ShardingKeyGeneratorServiceLoader extends TypeBasedSPIServiceLoader&lt;ShardingKeyGenerator&gt; { 
     
    static { 
        NewInstanceServiceLoader.register(ShardingKeyGenerator.class); 
    } 
     
    public ShardingKeyGeneratorServiceLoader() { 
        super(ShardingKeyGenerator.class); 
    } 
} 
</code></pre><p>å›é¡¾ä¸Šä¸€è¯¾æ—¶çš„å†…å®¹ï¼Œæˆ‘ä»¬ä¸éš¾ç†è§£ ShardingKeyGeneratorServiceLoader ç±»çš„ä½œç”¨ã€‚ShardingKeyGeneratorServiceLoader ç»§æ‰¿äº† TypeBasedSPIServiceLoader ç±»ï¼Œå¹¶åœ¨é™æ€æ–¹æ³•ä¸­é€šè¿‡ NewInstanceServiceLoader æ³¨å†Œäº†ç±»è·¯å¾„ä¸­æ‰€æœ‰çš„ ShardingKeyGeneratorã€‚ç„¶åï¼ŒShardingKeyGeneratorServiceLoader çš„ newService æ–¹æ³•åŸºäºç±»å‹å‚æ•°é€šè¿‡ SPI åˆ›å»ºå®ä¾‹ï¼Œå¹¶èµ‹å€¼ Properties å±æ€§ã€‚</p>
<p>é€šè¿‡ç»§æ‰¿ TypeBasedSPIServiceLoader ç±»æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ ServiceLoader ç±»ï¼Œç„¶ååœ¨å…¶é™æ€æ–¹æ³•ä¸­æ³¨å†Œç›¸åº”çš„ SPI å®ç°ï¼Œè¿™æ˜¯ ShardingSphere ä¸­åº”ç”¨å¾®å†…æ ¸æ¨¡å¼çš„å¸¸è§åšæ³•ï¼Œå¾ˆå¤šåœ°æ–¹éƒ½èƒ½çœ‹åˆ°ç±»ä¼¼çš„å¤„ç†æ–¹æ³•ã€‚</p>
<p>æˆ‘ä»¬åœ¨ sharding-core-common å·¥ç¨‹çš„ META-INF/services ç›®å½•ä¸­çœ‹åˆ°äº†å…·ä½“çš„ SPI å®šä¹‰ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/Ciqc1F8iliiAVywgAAByh__z6Bw582.png" alt="1.png"></p>
<p>åˆ†å¸ƒå¼ä¸»é”® SPI é…ç½®</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ª ShardingKeyGeneratorï¼Œåˆ†åˆ«æ˜¯ SnowflakeShardingKeyGenerator å’Œ UUIDShardingKeyGeneratorï¼Œå®ƒä»¬éƒ½ä½äºorg.apache.shardingsphere.core.strategy.keygen åŒ…ä¸‹ã€‚</p>
<h3 id="shardingsphere-ä¸­çš„åˆ†å¸ƒå¼ä¸»é”®å®ç°æ–¹æ¡ˆ">ShardingSphere ä¸­çš„åˆ†å¸ƒå¼ä¸»é”®å®ç°æ–¹æ¡ˆ</h3>
<p>åœ¨ ShardingSphere ä¸­ï¼ŒShardingKeyGenerator æ¥å£å­˜åœ¨ä¸€æ‰¹å®ç°ç±»ã€‚é™¤äº†å‰é¢æåˆ°çš„ SnowflakeShardingKeyGenerator å’ŒUUIDShardingKeyGeneratorï¼Œè¿˜å®ç°äº† LeafSegmentKeyGenerator å’Œ LeafSnowflakeKeyGenerator ç±»ï¼Œä½†è¿™ä¸¤ä¸ªç±»çš„å®ç°è¿‡ç¨‹æœ‰äº›ç‰¹æ®Šï¼Œæˆ‘ä»¬ä¸€ä¼šå†å…·ä½“å±•å¼€ã€‚</p>
<h4 id="uuidshardingkeygenerator">UUIDShardingKeyGenerator</h4>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹æœ€ç®€å•çš„ ShardingKeyGeneratorï¼Œå³ UUIDShardingKeyGeneratorã€‚UUIDShardingKeyGenerator çš„å®ç°éå¸¸å®¹æ˜“ç†è§£ï¼Œç›´æ¥é‡‡ç”¨ UUID.randomUUID() çš„æ–¹å¼äº§ç”Ÿåˆ†å¸ƒå¼ä¸»é”®ï¼š</p>
<pre tabindex="0"><code>public final class UUIDShardingKeyGenerator implements ShardingKeyGenerator { 
     
    private Properties properties = new Properties(); 
     
    @Override 
    public String getType() { 
        return &quot;UUID&quot;; 
    } 
     
    @Override 
    public synchronized Comparable&lt;?&gt; generateKey() { 
        return UUID.randomUUID().toString().replaceAll(&quot;-&quot;, &quot;&quot;); 
    } 
} 
</code></pre><h4 id="snowflakeshardingkeygenerator">SnowflakeShardingKeyGenerator</h4>
<p>å†æ¥çœ‹ SnowFlakeï¼ˆé›ªèŠ±ï¼‰ç®—æ³•ï¼ŒSnowFlake æ˜¯ ShardingSphere é»˜è®¤çš„åˆ†å¸ƒå¼ä¸»é”®ç”Ÿæˆç­–ç•¥ã€‚å®ƒæ˜¯ Twitter å¼€æºçš„åˆ†å¸ƒå¼ ID ç”Ÿæˆç®—æ³•ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯ä½¿ç”¨ä¸€ä¸ª 64bit çš„ long å‹æ•°å­—ä½œä¸ºå…¨å±€å”¯ä¸€ IDï¼Œä¸” ID å¼•å…¥äº†æ—¶é—´æˆ³ï¼ŒåŸºæœ¬ä¸Šèƒ½å¤Ÿä¿æŒè‡ªå¢ã€‚SnowFlake ç®—æ³•åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„åº”ç”¨ååˆ†å¹¿æ³›ï¼ŒSnowFlake ç®—æ³•ä¸­ 64bit çš„è¯¦ç»†ç»“æ„å­˜åœ¨ä¸€å®šçš„è§„èŒƒï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/CgqCHl8ilkuAHxUeAAHYgqa5Z0Q435.png" alt="2.png"></p>
<p>64bit çš„ ID ç»“æ„å›¾</p>
<p>åœ¨ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬æŠŠ 64bit åˆ†æˆäº†å››ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>ç¬¦å·ä½</li>
</ul>
<p>ç¬¬ä¸€ä¸ªéƒ¨åˆ†å³ç¬¬ä¸€ä¸ª bitï¼Œå€¼ä¸º 0ï¼Œæ²¡æœ‰å®é™…æ„ä¹‰ã€‚</p>
<ul>
<li>æ—¶é—´æˆ³ä½</li>
</ul>
<p>ç¬¬äºŒä¸ªéƒ¨åˆ†æ˜¯ 41 ä¸ª bitï¼Œè¡¨ç¤ºçš„æ˜¯æ—¶é—´æˆ³ã€‚41 ä½çš„æ—¶é—´æˆ³å¯ä»¥å®¹çº³çš„æ¯«ç§’æ•°æ˜¯ 2 çš„ 41 æ¬¡å¹‚ï¼Œä¸€å¹´æ‰€ä½¿ç”¨çš„æ¯«ç§’æ•°æ˜¯365 * 24 * 60 * 60 * 1000ï¼Œå³ 69.73 å¹´ã€‚ <strong>ä¹Ÿå°±æ˜¯è¯´ï¼ŒShardingSphere çš„ SnowFlake ç®—æ³•çš„æ—¶é—´çºªå…ƒä» 2016 å¹´ 11 æœˆ 1 æ—¥é›¶ç‚¹å¼€å§‹ï¼Œå¯ä»¥ä½¿ç”¨åˆ° 2086 å¹´</strong> ï¼Œç›¸ä¿¡èƒ½æ»¡è¶³ç»å¤§éƒ¨åˆ†ç³»ç»Ÿçš„è¦æ±‚ã€‚</p>
<ul>
<li>å·¥ä½œè¿›ç¨‹ä½</li>
</ul>
<p>ç¬¬ä¸‰ä¸ªéƒ¨åˆ†æ˜¯ 10 ä¸ª bitï¼Œè¡¨ç¤ºå·¥ä½œè¿›ç¨‹ä½ï¼Œå…¶ä¸­å‰ 5 ä¸ª bit ä»£è¡¨æœºæˆ¿ idï¼Œå 5 ä¸ª bit ä»£è¡¨æœºå™¨idã€‚</p>
<ul>
<li>åºåˆ—å·ä½</li>
</ul>
<p>ç¬¬å››ä¸ªéƒ¨åˆ†æ˜¯ 12 ä¸ª bitï¼Œè¡¨ç¤ºåºå·ï¼Œä¹Ÿå°±æ˜¯æŸä¸ªæœºæˆ¿æŸå°æœºå™¨ä¸Šåœ¨ä¸€æ¯«ç§’å†…åŒæ—¶ç”Ÿæˆçš„ ID åºå·ã€‚å¦‚æœåœ¨è¿™ä¸ªæ¯«ç§’å†…ç”Ÿæˆçš„æ•°é‡è¶…è¿‡ 4096ï¼ˆå³ 2 çš„ 12 æ¬¡å¹‚ï¼‰ï¼Œé‚£ä¹ˆç”Ÿæˆå™¨ä¼šç­‰å¾…ä¸‹ä¸ªæ¯«ç§’ç»§ç»­ç”Ÿæˆã€‚</p>
<p>å› ä¸º SnowFlake ç®—æ³•ä¾èµ–äºæ—¶é—´æˆ³ï¼Œæ‰€ä»¥è¿˜éœ€è¦è€ƒè™‘æ—¶é’Ÿå›æ‹¨è¿™ç§åœºæ™¯ã€‚<strong>æ‰€è°“æ—¶é’Ÿå›æ‹¨ï¼Œæ˜¯æŒ‡æœåŠ¡å™¨å› ä¸ºæ—¶é—´åŒæ­¥ï¼Œå¯¼è‡´æŸä¸€éƒ¨åˆ†æœºå™¨çš„æ—¶é’Ÿå›åˆ°äº†è¿‡å»çš„æ—¶é—´ç‚¹</strong>ã€‚æ˜¾ç„¶ï¼Œæ—¶é—´æˆ³çš„å›æ»šä¼šå¯¼è‡´ç”Ÿæˆä¸€ä¸ªå·²ç»ä½¿ç”¨è¿‡çš„ IDï¼Œå› æ­¤é»˜è®¤åˆ†å¸ƒå¼ä¸»é”®ç”Ÿæˆå™¨æä¾›äº†ä¸€ä¸ªæœ€å¤§å®¹å¿çš„æ—¶é’Ÿå›æ‹¨æ¯«ç§’æ•°ã€‚å¦‚æœæ—¶é’Ÿå›æ‹¨çš„æ—¶é—´è¶…è¿‡æœ€å¤§å®¹å¿çš„æ¯«ç§’æ•°é˜ˆå€¼ï¼Œåˆ™ç¨‹åºæŠ¥é”™ï¼›å¦‚æœåœ¨å¯å®¹å¿çš„èŒƒå›´å†…ï¼Œé»˜è®¤åˆ†å¸ƒå¼ä¸»é”®ç”Ÿæˆå™¨ä¼šç­‰å¾…æ—¶é’ŸåŒæ­¥åˆ°æœ€åä¸€æ¬¡ä¸»é”®ç”Ÿæˆçš„æ—¶é—´åå†ç»§ç»­å·¥ä½œã€‚ShardingSphere ä¸­æœ€å¤§å®¹å¿çš„æ—¶é’Ÿå›æ‹¨æ¯«ç§’æ•°çš„é»˜è®¤å€¼ä¸º 0ï¼Œå¯é€šè¿‡å±æ€§è®¾ç½®ã€‚</p>
<p>äº†è§£äº† SnowFlake ç®—æ³•çš„åŸºæœ¬æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹ SnowflakeShardingKeyGenerator ç±»çš„å…·ä½“å®ç°ã€‚é¦–å…ˆåœ¨ SnowflakeShardingKeyGenerator ç±»ä¸­å­˜åœ¨ä¸€æ‰¹å¸¸é‡çš„å®šä¹‰ï¼Œç”¨äºç»´æŠ¤ SnowFlake ç®—æ³•ä¸­å„ä¸ª bit ä¹‹é—´çš„å…³ç³»ï¼ŒåŒæ—¶è¿˜å­˜åœ¨ä¸€ä¸ª TimeService ç”¨äºè·å–å½“å‰çš„æ—¶é—´æˆ³ã€‚è€Œ SnowflakeShardingKeyGenerator çš„æ ¸å¿ƒæ–¹æ³• generateKey è´Ÿè´£ç”Ÿæˆå…·ä½“çš„ IDï¼Œæˆ‘ä»¬è¿™é‡Œç»™å‡ºè¯¦ç»†çš„ä»£ç ï¼Œå¹¶ä¸ºæ¯è¡Œä»£ç éƒ½æ·»åŠ æ³¨é‡Šï¼š</p>
<pre tabindex="0"><code>    @Override 
    public synchronized Comparable&lt;?&gt; generateKey() { 
         //è·å–å½“å‰æ—¶é—´æˆ³ 
        long currentMilliseconds = timeService.getCurrentMillis(); 
         
        //å¦‚æœå‡ºç°äº†æ—¶é’Ÿå›æ‹¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸æˆ–è¿›è¡Œæ—¶é’Ÿç­‰å¾… 
        if (waitTolerateTimeDifferenceIfNeed(currentMilliseconds)) { 
            currentMilliseconds = timeService.getCurrentMillis(); 
        } 
         
        //å¦‚æœä¸Šæ¬¡çš„ç”Ÿæˆæ—¶é—´ä¸æœ¬æ¬¡çš„æ˜¯åŒä¸€æ¯«ç§’ 
        if (lastMilliseconds == currentMilliseconds) { 
         //è¿™ä¸ªä½è¿ç®—ä¿è¯å§‹ç»ˆå°±æ˜¯åœ¨4096è¿™ä¸ªèŒƒå›´å†…ï¼Œé¿å…ä½ è‡ªå·±ä¼ é€’çš„sequenceè¶…è¿‡äº†4096è¿™ä¸ªèŒƒå›´ 
            if (0L == (sequence = (sequence + 1) &amp; SEQUENCE_MASK)) { 
              //å¦‚æœä½è¿ç®—ç»“æœä¸º0ï¼Œåˆ™éœ€è¦ç­‰å¾…ä¸‹ä¸€ä¸ªæ¯«ç§’ç»§ç»­ç”Ÿæˆ 
                currentMilliseconds = waitUntilNextTime(currentMilliseconds); 
            } 
        } else {//å¦‚æœä¸æ˜¯ï¼Œåˆ™ç”Ÿæˆæ–°çš„sequence 
            vibrateSequenceOffset(); 
            sequence = sequenceOffset; 
        } 
        lastMilliseconds = currentMilliseconds; 
         
        //å…ˆå°†å½“å‰æ—¶é—´æˆ³å·¦ç§»æ”¾åˆ°å®Œæˆ41ä¸ªbitï¼Œç„¶åå°†å·¥ä½œè¿›ç¨‹ä¸ºå·¦ç§»åˆ°10ä¸ªbitï¼Œå†å°†åºå·ä¸ºæ”¾åˆ°æœ€åçš„12ä¸ªbit 
        //æœ€åæ‹¼æ¥èµ·æ¥æˆä¸€ä¸ª64 bitçš„äºŒè¿›åˆ¶æ•°å­— 
        return ((currentMilliseconds - EPOCH) &lt;&lt; TIMESTAMP_LEFT_SHIFT_BITS) | (getWorkerId() &lt;&lt; WORKER_ID_LEFT_SHIFT_BITS) | sequence; 
} 
</code></pre><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œç»¼åˆè€ƒè™‘äº†æ—¶é’Ÿå›æ‹¨ã€åŒä¸€ä¸ªæ¯«ç§’å†…è¯·æ±‚ç­‰è®¾è®¡è¦ç´ ï¼Œä»è€Œå®Œæˆäº† SnowFlake ç®—æ³•çš„å…·ä½“å®ç°ã€‚</p>
<h4 id="leafsegmentkeygenerator-å’Œ-leafsnowflakekeygenerator">LeafSegmentKeyGenerator å’Œ LeafSnowflakeKeyGenerator</h4>
<p>äº‹å®ä¸Šï¼Œå¦‚æœå®ç°ç±»ä¼¼ SnowflakeShardingKeyGenerator è¿™æ ·çš„ ShardingKeyGenerator æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œè€Œä¸”ä¹Ÿå±äºé‡å¤é€ è½®å­ã€‚å› æ­¤ï¼Œå°½ç®¡ ShardingSphere åœ¨ 4.X ç‰ˆæœ¬ä¸­ä¹Ÿæä¾›äº† LeafSegmentKeyGenerator å’Œ LeafSnowflakeKeyGenerator è¿™ä¸¤ä¸ª ShardingKeyGenerator çš„å®Œæ•´å®ç°ç±»ã€‚ä½†åœ¨æ­£åœ¨å¼€å‘çš„ 5.X ç‰ˆæœ¬ä¸­ï¼Œè¿™ä¸¤ä¸ªå®ç°ç±»è¢«ç§»é™¤äº†ã€‚</p>
<p>ç›®å‰ï¼ŒShardingSphere ä¸“é—¨æä¾›äº† OpenSharding è¿™ä¸ªä»£ç ä»“åº“æ¥å­˜æ”¾æ–°ç‰ˆæœ¬çš„ LeafSegmentKeyGenerator å’Œ LeafSnowflakeKeyGeneratorã€‚æ–°ç‰ˆæœ¬çš„å®ç°ç±»ç›´æ¥é‡‡ç”¨äº†ç¬¬ä¸‰æ–¹ç¾å›¢æä¾›çš„ Leaf å¼€æºå®ç°ã€‚</p>
<p>Leaf æä¾›ä¸¤ç§ç”Ÿæˆ ID çš„æ–¹å¼ï¼Œä¸€ç§æ˜¯å·æ®µï¼ˆSegmentï¼‰æ¨¡å¼ï¼Œä¸€ç§æ˜¯å‰é¢ä»‹ç»çš„ Snowflake æ¨¡å¼ã€‚æ— è®ºä½¿ç”¨å“ªç§æ¨¡å¼ï¼Œæˆ‘ä»¬éƒ½éœ€è¦æä¾›ä¸€ä¸ª leaf.properties æ–‡ä»¶ï¼Œå¹¶è®¾ç½®å¯¹åº”çš„é…ç½®é¡¹ã€‚æ— è®ºæ˜¯ä½¿ç”¨å“ªç§æ–¹å¼ï¼Œåº”ç”¨ç¨‹åºéƒ½éœ€è¦è®¾ç½®ä¸€ä¸ª leaf.keyï¼š</p>
<pre tabindex="0"><code># for keyGenerator key 
leaf.key=sstest 
  
# for LeafSnowflake 
leaf.zk.list=localhost:2181 
</code></pre><p>å¦‚æœä½¿ç”¨å·æ®µæ¨¡å¼ï¼Œéœ€è¦ä¾èµ–äºä¸€å¼ æ•°æ®åº“è¡¨æ¥å­˜å‚¨è¿è¡Œæ—¶æ•°æ®ï¼Œå› æ­¤éœ€è¦åœ¨ leaf.properties æ–‡ä»¶ä¸­æ·»åŠ æ•°æ®åº“çš„ç›¸å…³é…ç½®ï¼š</p>
<pre tabindex="0"><code># for LeafSegment 
leaf.jdbc.url=jdbc:mysql://127.0.0.1:3306/test?serverTimezone=UTC&amp;useSSL=false 
leaf.jdbc.username=root 
leaf.jdbc.password=123456 
</code></pre><p>åŸºäºè¿™äº›é…ç½®ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºå¯¹åº”çš„ DataSourceï¼Œå¹¶è¿›ä¸€æ­¥åˆ›å»ºç”¨äºç”Ÿæˆåˆ†å¸ƒå¼ ID çš„ IDGen å®ç°ç±»ï¼Œè¿™é‡Œåˆ›å»ºçš„æ˜¯åŸºäºå·æ®µæ¨¡å¼çš„ SegmentIDGenImpl å®ç°ç±»ï¼š</p>
<pre tabindex="0"><code>//é€šè¿‡DruidDataSourceæ„å»ºæ•°æ®æºå¹¶è®¾ç½®å±æ€§ 
DruidDataSource dataSource = new DruidDataSource(); 
                dataSource.setUrl(properties.getProperty(LeafPropertiesConstant.LEAF_JDBC_URL)); 
                dataSource.setUsername(properties.getProperty(LeafPropertiesConstant.LEAF_JDBC_USERNAME)); 
                dataSource.setPassword(properties.getProperty(LeafPropertiesConstant.LEAF_JDBC_PASSWORD)); 
dataSource.init(); 
                 
//æ„å»ºæ•°æ®åº“è®¿é—®Daoç»„ä»¶ 
IDAllocDao dao = new IDAllocDaoImpl(dataSource); 
//åˆ›å»ºIDGenå®ç°ç±» 
this.idGen = new SegmentIDGenImpl(); 
//å°†Daoç»„ä»¶ç»‘å®šåˆ°IDGenå®ç°ç±» 
 ((SegmentIDGenImpl) this.idGen).setDao(dao); 
this.idGen.init(); 
this.dataSource = dataSource; 
</code></pre><p>ä¸€æ—¦æˆ‘ä»¬æˆåŠŸåˆ›å»ºäº† IDGen å®ç°ç±»ï¼Œå¯ä»¥é€šè¿‡è¯¥ç±»æ¥ç”Ÿæˆç›®æ ‡ IDï¼ŒLeafSegmentKeyGenerator ç±»ä¸­åŒ…å«äº†æ‰€æœ‰çš„å®ç°ç»†èŠ‚ï¼š</p>
<pre tabindex="0"><code>Result result = this.idGen.get(properties.getProperty(LeafPropertiesConstant.LEAF_KEY)); 
return result.getId(); 
</code></pre><p>ä»‹ç»å®Œ LeafSegmentKeyGenerator ä¹‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹ LeafSnowflakeKeyGeneratorã€‚LeafSnowflakeKeyGenerator çš„å®ç°ä¾èµ–äºåˆ†å¸ƒå¼åè°ƒæ¡†æ¶ Zookeeperï¼Œæ‰€ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­éœ€è¦æŒ‡å®š Zookeeper çš„ç›®æ ‡åœ°å€ï¼š</p>
<pre tabindex="0"><code># for LeafSnowflake 
leaf.zk.list=localhost:2181 
</code></pre><p>åˆ›å»ºç”¨äº LeafSnowflake çš„ IDGen å®ç°ç±» SnowflakeIDGenImpl ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨æ„é€ å‡½æ•°ä¸­è®¾ç½® Zookeeper åœ°å€å°±å¯ä»¥äº†ï¼š</p>
<pre tabindex="0"><code>IDGen idGen = new SnowflakeIDGenImpl(properties.getProperty(LeafPropertiesConstant.LEAF_ZK_LIST), 8089); 
</code></pre><p>åŒæ ·ï¼Œé€šè¿‡ IDGen è·å–æ¨¡æ¿ ID çš„æ–¹å¼æ˜¯ä¸€è‡´çš„ï¼š</p>
<hr>
<pre tabindex="0"><code>idGen.get(properties.getProperty(LeafPropertiesConstant.LEAF_KEY)).getId(); 
</code></pre><p>æ˜¾ç„¶ï¼ŒåŸºäº Leaf æ¡†æ¶å®ç°å·æ®µæ¨¡å¼å’Œ Snowflake æ¨¡å¼ä¸‹çš„åˆ†å¸ƒå¼ ID ç”Ÿæˆæ–¹å¼éå¸¸ç®€å•ï¼ŒLeaf æ¡†æ¶ä¸ºæˆ‘ä»¬å±è”½äº†å†…éƒ¨å®ç°çš„å¤æ‚æ€§ã€‚</p>
<h3 id="ä»æºç è§£æåˆ°æ—¥å¸¸å¼€å‘">ä»æºç è§£æåˆ°æ—¥å¸¸å¼€å‘</h3>
<p>ç›¸æ¯” ShardingSphere ä¸­å…¶ä»–æ¶æ„è®¾è®¡ä¸Šçš„æ€æƒ³å’Œå®ç°æ–¹æ¡ˆï¼Œåˆ†å¸ƒå¼ä¸»é”®éå¸¸ç‹¬ç«‹ï¼Œæ‰€ä»¥ä»Šå¤©ä»‹ç»çš„å„ç§åˆ†å¸ƒå¼ä¸»é”®çš„å®ç°æ–¹å¼å®Œå…¨å¯ä»¥ç›´æ¥å¥—ç”¨åˆ°æ—¥å¸¸å¼€å‘è¿‡ç¨‹ä¸­ã€‚æ— è®ºæ˜¯ ShardingSphere è‡ªèº«å®ç°çš„ SnowflakeShardingKeyGeneratorï¼Œè¿˜æ˜¯åŸºäºç¬¬ä¸‰æ–¹æ¡†æ¶å®ç°çš„ LeafSegmentKeyGenerator å’Œ LeafSnowflakeKeyGeneratorï¼Œéƒ½ä¸ºæˆ‘ä»¬ä½¿ç”¨åˆ†å¸ƒå¼ä¸»é”®æä¾›äº†ç›´æ¥çš„è§£å†³æ–¹æ¡ˆã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨è¿™äº›å®ç°æ–¹æ¡ˆçš„åŸºç¡€ä¸Šï¼Œè¿›ä¸€æ­¥æŒ–æ˜åŒç±»å‹çš„å…¶ä»–æ–¹æ¡ˆã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œåˆ†å¸ƒå¼ä¸»é”®æ˜¯ä¸€ç§åŸºç¡€éœ€æ±‚ã€‚è€Œå¯¹äºä¸æ•°æ®åº“ç›¸å…³çš„æ“ä½œè€Œè¨€ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦å°†åˆ†å¸ƒå¼ä¸»é”®ä¸æ•°æ®åº“çš„ä¸»é”®è‡ªåŠ¨ç”Ÿæˆæœºåˆ¶å…³è”èµ·æ¥ã€‚åœ¨ä»Šå¤©çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°±ä» ShardingSphere çš„è‡ªåŠ¨ç”Ÿæˆé”®æ–¹æ¡ˆè¯´èµ·ï¼Œå¼•å‡ºäº†åˆ†å¸ƒå¼ä¸»é”®çš„å„ç§å®ç°æ–¹æ¡ˆã€‚è¿™å…¶ä¸­åŒ…æ‹¬æœ€ç®€å•çš„ UUIDï¼Œä¹ŸåŒ…æ‹¬ç»å…¸çš„é›ªèŠ±ç®—æ³•ï¼Œä»¥åŠé›ªèŠ±ç®—æ³•çš„æ”¹è¿›æ–¹æ¡ˆ LeafSegment å’Œ LeafSnowflake ç®—æ³•ã€‚</p>
<p>è¿™é‡Œç»™ä½ ç•™ä¸€é“æ€è€ƒé¢˜ï¼šShardingSphere ä¸­å¦‚ä½•åˆ†åˆ«å®ç°åŸºäºå·æ®µçš„ Leaf ä»¥åŠåŸºäº Snowflake çš„ Leaf æ¥ç”Ÿæˆåˆ†å¸ƒå¼ IDï¼Ÿ</p>
<p>ä»ä¸‹ä¸€è¯¾æ—¶å¼€å§‹ï¼Œæˆ‘ä»¬å°†è¿›å…¥åˆ° ShardingSphere åˆ†ç‰‡å¼•æ“å®ç°åŸç†çš„è®²è§£è¿‡ç¨‹ä¸­ï¼Œæˆ‘å°†é¦–å…ˆä¸ºä½ ä»‹ç»è§£æå¼•æ“çš„æ‰§è¡Œæµç¨‹ï¼Œè®°å¾—æŒ‰æ—¶æ¥å¬è¯¾ã€‚</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/13-%E5%BE%AE%E5%86%85%E6%A0%B8%E6%9E%B6%E6%9E%84shardingsphere-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%89%A9%E5%B1%95%E6%80%A7/"><span>13 å¾®å†…æ ¸æ¶æ„ï¼šShardingSphere å¦‚ä½•å®ç°ç³»ç»Ÿçš„æ‰©å±•æ€§ï¼Ÿ</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/15-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8A/"><span>15 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸Šï¼‰</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 28280 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>