<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>30 æ•°æ®è„±æ•ï¼šå¦‚ä½•åŸºäºæ”¹å†™å¼•æ“å®ç°ä½ä¾µå…¥æ€§æ•°æ®è„±æ•æ–¹æ¡ˆï¼Ÿ | Yipsen Ye</title>
<meta name="description" content="ä»Šå¤©ï¼Œæˆ‘ä»¬è®¨è®º ShardingSphere ä¸­çš„æ•°æ®è„±æ•æ¨¡å—ã€‚é€šè¿‡åœ¨ â€œ10 | æ•°æ®è„±æ•ï¼šå¦‚ä½•ç¡®ä¿æ•æ„Ÿæ•°æ®çš„å®‰å…¨è®¿é—®ï¼Ÿâ€ è¯¾æ—¶ä¸­çš„ä»‹ç»ï¼Œæˆ‘ä»¬çŸ¥é“ ShardingSphere æä¾›äº†ä¸€å¥—è‡ªåŠ¨çš„æ•°æ®åŠ è§£å¯†æœºåˆ¶æ¥å®ç°é€æ˜åŒ–çš„æ•°æ®è„±æ•ã€‚
æ•°æ®è„±æ•æ¨¡å—æ•´ä½“æ¶æ„ ä¸æ™®é€šçš„ç¼–ç¨‹æ¨¡å¼ä¸€æ ·ï¼Œå¯¹äºæ•°æ®è„±æ•è€Œè¨€ï¼Œæˆ‘ä»¬åŒæ ·å…ˆè·å–ä¸€ä¸ª DataSource ä½œä¸ºæ•´ä¸ªæµç¨‹çš„å…¥å£ï¼Œå½“ç„¶è¿™é‡Œè·å–çš„ä¸æ˜¯ä¸€ä¸ªæ™®é€šçš„ DataSourceï¼Œè€Œæ˜¯ä¸€ä¸ªä¸“é—¨é’ˆå¯¹æ•°æ®è„±æ•çš„ EncryptDataSourceã€‚å¯¹äºæ•°æ®è„±æ•æ¨¡å—ï¼Œæˆ‘ä»¬çš„æ€è·¯è¿˜æ˜¯ä»ä¸Šåˆ°ä¸‹ï¼Œä» EncryptDataSource å¼€å§‹è¿›å…¥åˆ° ShardingSphere æ•°æ®è„±æ•çš„ä¸–ç•Œä¸­ã€‚
åŒæ—¶ï¼Œæˆ‘ä»¬è¿™æ¬¡è®²è§£æ•°æ®è„±æ•æ¨¡å—ä¸æ˜¯é›¶åŸºç¡€ï¼Œå› ä¸ºåœ¨å‰é¢ä»‹ç» ShardingDataSourceã€ShardingConnectionã€ShardingStatement ç­‰å†…å®¹æ—¶ï¼Œå·²ç»å¯¹æ•´ä¸ª SQL æ‰§è¡Œæµç¨‹çš„æŠ½è±¡è¿‡ç¨‹åšäº†å…¨é¢ä»‹ç»ï¼Œæ‰€æ¶‰åŠçš„å¾ˆå¤šå†…å®¹å¯¹äºæ•°æ®è„±æ•æ¨¡å—è€Œè¨€ä¹Ÿéƒ½æ˜¯é€‚ç”¨çš„ã€‚
è®©æˆ‘ä»¬ç»“åˆä¸‹å›¾æ¥åšä¸€äº›å›é¡¾ï¼š
ä¸Šå›¾ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä¸æ•°æ®è„±æ•æ¨¡å—ç›¸å…³çš„ç±»å®é™…ä¸Šéƒ½ç»§æ‰¿äº†ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œè€Œè¿™äº›æŠ½è±¡ç±»åœ¨å‰é¢çš„å†…å®¹éƒ½å·²ç»åšäº†ä»‹ç»ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯¹æ•°æ®è„±æ•æ¨¡å—å°†é‡ç‚¹å…³æ³¨äºå‡ ä¸ªæ ¸å¿ƒç±»çš„è®²è§£ï¼Œå¯¹äºå·²ç»ä»‹ç»è¿‡çš„å†…å®¹æˆ‘ä»¬ä¼šåšä¸€äº›å›é¡¾ï¼Œä½†ä¸ä¼šé¢é¢ä¿±åˆ°ã€‚
åŸºäºä¸Šå›¾ï¼Œæˆ‘ä»¬ä» EncryptDataSource å¼€å§‹å…¥æ‰‹ï¼ŒEncryptDataSource çš„åˆ›å»ºä¾èµ–äºå·¥å‚ç±» EncryptDataSourceFactoryï¼Œå…¶å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š
public final class EncryptDataSourceFactory {public static DataSource createDataSource(final DataSource dataSource, final EncryptRuleConfiguration encryptRuleConfiguration, final Properties props) throws SQLException {return new EncryptDataSource(dataSource, new EncryptRule(encryptRuleConfiguration), props);}}è¿™é‡Œç›´æ¥åˆ›å»ºäº†ä¸€ä¸ª EncryptDataSourceï¼Œä¾èµ–äº EncryptRule è§„åˆ™å¯¹è±¡ï¼Œæˆ‘ä»¬å…ˆæ¥æ¢³ç†ä¸€ä¸‹ EncryptRule ä¸­å…·ä½“åŒ…å«äº†å“ªäº›å†…å®¹ã€‚
EncryptRule EncryptRule æ˜¯æ•°æ®è„±æ•æ¨¡å—çš„ä¸€ä¸ªæ ¸å¿ƒå¯¹è±¡ï¼Œå€¼å¾—æˆ‘ä»¬ä¸“é—¨è¿›è¡Œå±•å¼€ã€‚åœ¨ EncryptRule ä¸­ï¼Œå®šä¹‰äº†å¦‚ä¸‹æ‰€ç¤ºçš„ä¸‰ä¸ªæ ¸å¿ƒå˜é‡ï¼š">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/shardingsphere%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e7%b2%be%e8%ae%b2/">ShardingSphereæ ¸å¿ƒåŸç†ç²¾è®²</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/00-%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E5%AD%A6%E4%B9%A0%E4%B8%80%E6%AC%BE%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/">00 å¦‚ä½•æ­£ç¡®å­¦ä¹ ä¸€æ¬¾åˆ†åº“åˆ†è¡¨å¼€æºæ¡†æ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/01-%E4%BB%8E%E7%90%86%E8%AE%BA%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%A6%82%E4%BD%95%E8%AE%A9%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%9C%9F%E6%AD%A3%E8%90%BD%E5%9C%B0/">01 ä»ç†è®ºåˆ°å®è·µï¼šå¦‚ä½•è®©åˆ†åº“åˆ†è¡¨çœŸæ­£è½åœ°ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/02-%E9%A1%B6%E7%BA%A7%E9%A1%B9%E7%9B%AEshardingsphere-%E6%98%AF%E4%B8%80%E6%AC%BE%E4%BB%80%E4%B9%88%E6%A0%B7%E7%9A%84-apache-%E5%BC%80%E6%BA%90%E8%BD%AF%E4%BB%B6/">02 é¡¶çº§é¡¹ç›®ï¼šShardingSphere æ˜¯ä¸€æ¬¾ä»€ä¹ˆæ ·çš„ Apache å¼€æºè½¯ä»¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/03-%E8%A7%84%E8%8C%83%E5%85%BC%E5%AE%B9jdbc-%E8%A7%84%E8%8C%83%E4%B8%8E-shardingsphere-%E6%98%AF%E4%BB%80%E4%B9%88%E5%85%B3%E7%B3%BB/">03 è§„èŒƒå…¼å®¹ï¼šJDBC è§„èŒƒä¸ ShardingSphere æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/04-%E5%BA%94%E7%94%A8%E9%9B%86%E6%88%90%E5%9C%A8%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F%E4%B8%AD%E4%BD%BF%E7%94%A8-shardingsphere-%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9C%89%E5%93%AA%E4%BA%9B/">04 åº”ç”¨é›†æˆï¼šåœ¨ä¸šåŠ¡ç³»ç»Ÿä¸­ä½¿ç”¨ ShardingSphere çš„æ–¹å¼æœ‰å“ªäº›ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/05-%E9%85%8D%E7%BD%AE%E9%A9%B1%E5%8A%A8shardingsphere-%E4%B8%AD%E7%9A%84%E9%85%8D%E7%BD%AE%E4%BD%93%E7%B3%BB%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E7%9A%84/">05 é…ç½®é©±åŠ¨ï¼šShardingSphere ä¸­çš„é…ç½®ä½“ç³»æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/09-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E4%B8%8E%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1/">09 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¦‚ä½•ä½¿ç”¨å¼ºä¸€è‡´æ€§äº‹åŠ¡ä¸æŸ”æ€§äº‹åŠ¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/10-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E5%A6%82%E4%BD%95%E7%A1%AE%E4%BF%9D%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AE%89%E5%85%A8%E8%AE%BF%E9%97%AE/">10 æ•°æ®è„±æ•ï¼šå¦‚ä½•ç¡®ä¿æ•æ„Ÿæ•°æ®çš„å®‰å…¨è®¿é—®ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/11-%E7%BC%96%E6%8E%92%E6%B2%BB%E7%90%86%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/">11 ç¼–æ’æ²»ç†ï¼šå¦‚ä½•å®ç°åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„åŠ¨æ€é…ç½®ç®¡ç†ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/12-%E4%BB%8E%E5%BA%94%E7%94%A8%E5%88%B0%E5%8E%9F%E7%90%86%E5%A6%82%E4%BD%95%E9%AB%98%E6%95%88%E9%98%85%E8%AF%BB-shardingsphere-%E6%BA%90%E7%A0%81/">12 ä»åº”ç”¨åˆ°åŸç†ï¼šå¦‚ä½•é«˜æ•ˆé˜…è¯» ShardingSphere æºç ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/13-%E5%BE%AE%E5%86%85%E6%A0%B8%E6%9E%B6%E6%9E%84shardingsphere-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%89%A9%E5%B1%95%E6%80%A7/">13 å¾®å†…æ ¸æ¶æ„ï¼šShardingSphere å¦‚ä½•å®ç°ç³»ç»Ÿçš„æ‰©å±•æ€§ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/14-%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AEshardingsphere-%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AE%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F/">14 åˆ†å¸ƒå¼ä¸»é”®ï¼šShardingSphere ä¸­æœ‰å“ªäº›åˆ†å¸ƒå¼ä¸»é”®å®ç°æ–¹å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/15-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8A/">15 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/16-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8B/">16 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/17-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E5%88%86%E7%89%87%E8%B7%AF%E7%94%B1%E6%A0%B8%E5%BF%83%E7%B1%BB-shardingrouter-%E7%9A%84%E8%BF%90%E4%BD%9C%E6%9C%BA%E5%88%B6/">17 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•ç†è§£åˆ†ç‰‡è·¯ç”±æ ¸å¿ƒç±» ShardingRouter çš„è¿ä½œæœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/18-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E7%9A%84%E5%88%86%E7%89%87%E8%B7%AF%E7%94%B1%E5%92%8C%E5%B9%BF%E6%92%AD%E8%B7%AF%E7%94%B1/">18 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•å®ç°æ•°æ®è®¿é—®çš„åˆ†ç‰‡è·¯ç”±å’Œå¹¿æ’­è·¯ç”±ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/19-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%9C%A8%E8%B7%AF%E7%94%B1%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%9B%86%E6%88%90%E5%A4%9A%E7%A7%8D%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E5%92%8C%E8%B7%AF%E7%94%B1%E7%AE%97%E6%B3%95/">19 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•åœ¨è·¯ç”±è¿‡ç¨‹ä¸­é›†æˆå¤šç§è·¯ç”±ç­–ç•¥å’Œè·¯ç”±ç®—æ³•ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/20-%E6%94%B9%E5%86%99%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84-sql-%E6%94%B9%E5%86%99%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6/">20 æ”¹å†™å¼•æ“ï¼šå¦‚ä½•ç†è§£è£…é¥°å™¨æ¨¡å¼ä¸‹çš„ SQL æ”¹å†™å®ç°æœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/21-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%88%86%E7%89%87%E7%8E%AF%E5%A2%83%E4%B8%8B-sql-%E6%89%A7%E8%A1%8C%E7%9A%84%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E6%8A%BD%E8%B1%A1/">21 æ‰§è¡Œå¼•æ“ï¼šåˆ†ç‰‡ç¯å¢ƒä¸‹ SQL æ‰§è¡Œçš„æ•´ä½“æµç¨‹åº”è¯¥å¦‚ä½•è¿›è¡ŒæŠ½è±¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/22-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E6%8A%8A%E6%8F%A1-shardingsphere-%E4%B8%AD%E7%9A%84-executor-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8A/">22 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/23-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E6%8A%8A%E6%8F%A1-shardingsphere-%E4%B8%AD%E7%9A%84-executor-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8B/">23 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/24-%E5%BD%92%E5%B9%B6%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E6%95%B0%E6%8D%AE%E5%BD%92%E5%B9%B6%E7%9A%84%E7%B1%BB%E5%9E%8B%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%BD%92%E5%B9%B6%E7%AD%96%E7%95%A5%E7%9A%84%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B/">24 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æ•°æ®å½’å¹¶çš„ç±»å‹ä»¥åŠç®€å•å½’å¹¶ç­–ç•¥çš„å®ç°è¿‡ç¨‹ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/25-%E5%BD%92%E5%B9%B6%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E6%B5%81%E5%BC%8F%E5%BD%92%E5%B9%B6%E5%92%8C%E5%86%85%E5%AD%98%E5%BD%92%E5%B9%B6%E5%9C%A8%E5%A4%8D%E6%9D%82%E5%BD%92%E5%B9%B6%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84%E5%BA%94%E7%94%A8%E6%96%B9%E5%BC%8F/">25 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æµå¼å½’å¹¶å’Œå†…å­˜å½’å¹¶åœ¨å¤æ‚å½’å¹¶åœºæ™¯ä¸‹çš„åº”ç”¨æ–¹å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/26-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%99%AE%E9%80%9A%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%92%8C%E5%88%86%E7%89%87%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%88%86%E5%88%AB%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84/">26 è¯»å†™åˆ†ç¦»ï¼šæ™®é€šä¸»ä»æ¶æ„å’Œåˆ†ç‰‡ä¸»ä»æ¶æ„åˆ†åˆ«æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/27-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3-shardingsphere-%E4%B8%AD%E5%AF%B9%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%8A%BD%E8%B1%A1%E8%BF%87%E7%A8%8B/">27 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¦‚ä½•ç†è§£ ShardingSphere ä¸­å¯¹åˆ†å¸ƒå¼äº‹åŠ¡çš„æŠ½è±¡è¿‡ç¨‹ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/28-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1shardingsphere-%E4%B8%AD%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%E4%B8%8A/">28 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/29-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1shardingsphere-%E4%B8%AD%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%E4%B8%8B/">29 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li>30 æ•°æ®è„±æ•ï¼šå¦‚ä½•åŸºäºæ”¹å†™å¼•æ“å®ç°ä½ä¾µå…¥æ€§æ•°æ®è„±æ•æ–¹æ¡ˆï¼Ÿ</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/31-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E7%9A%84%E5%8A%A8%E6%80%81%E5%8C%96%E7%AE%A1%E7%90%86/">31 é…ç½®ä¸­å¿ƒï¼šå¦‚ä½•åŸºäºé…ç½®ä¸­å¿ƒå®ç°é…ç½®ä¿¡æ¯çš„åŠ¨æ€åŒ–ç®¡ç†ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/32-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BF%E9%97%AE%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6/">32 æ³¨å†Œä¸­å¿ƒï¼šå¦‚ä½•åŸºäºæ³¨å†Œä¸­å¿ƒå®ç°æ•°æ®åº“è®¿é—®ç†”æ–­æœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/33-%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E-hook-%E6%9C%BA%E5%88%B6%E4%BB%A5%E5%8F%8A-opentracing-%E5%8D%8F%E8%AE%AE%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA/">33 é“¾è·¯è·Ÿè¸ªï¼šå¦‚ä½•åŸºäº Hook æœºåˆ¶ä»¥åŠ OpenTracing åè®®å®ç°æ•°æ®è®¿é—®é“¾è·¯è·Ÿè¸ªï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/35-%E7%BB%93%E8%AF%ADshardingsphere-%E6%80%BB%E7%BB%93%E5%8F%8A%E5%B1%95%E6%9C%9B/">35 ç»“è¯­ï¼šShardingSphere æ€»ç»“åŠå±•æœ›</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">30 æ•°æ®è„±æ•ï¼šå¦‚ä½•åŸºäºæ”¹å†™å¼•æ“å®ç°ä½ä¾µå…¥æ€§æ•°æ®è„±æ•æ–¹æ¡ˆï¼Ÿ</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2021-12-22 01:56:10</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/sharding/">sharding</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/">ShardingSphereæ ¸å¿ƒåŸç†ç²¾è®²</a>
                
            </div></div>
        <div class="post-content">
            <p>ä»Šå¤©ï¼Œæˆ‘ä»¬è®¨è®º ShardingSphere ä¸­çš„æ•°æ®è„±æ•æ¨¡å—ã€‚é€šè¿‡åœ¨ <strong>â€œ10 | æ•°æ®è„±æ•ï¼šå¦‚ä½•ç¡®ä¿æ•æ„Ÿæ•°æ®çš„å®‰å…¨è®¿é—®ï¼Ÿâ€</strong> è¯¾æ—¶ä¸­çš„ä»‹ç»ï¼Œæˆ‘ä»¬çŸ¥é“ ShardingSphere æä¾›äº†ä¸€å¥—è‡ªåŠ¨çš„æ•°æ®åŠ è§£å¯†æœºåˆ¶æ¥å®ç°é€æ˜åŒ–çš„æ•°æ®è„±æ•ã€‚</p>
<h3 id="æ•°æ®è„±æ•æ¨¡å—æ•´ä½“æ¶æ„">æ•°æ®è„±æ•æ¨¡å—æ•´ä½“æ¶æ„</h3>
<p>ä¸æ™®é€šçš„ç¼–ç¨‹æ¨¡å¼ä¸€æ ·ï¼Œå¯¹äºæ•°æ®è„±æ•è€Œè¨€ï¼Œæˆ‘ä»¬åŒæ ·å…ˆè·å–ä¸€ä¸ª DataSource ä½œä¸ºæ•´ä¸ªæµç¨‹çš„å…¥å£ï¼Œå½“ç„¶è¿™é‡Œè·å–çš„ä¸æ˜¯ä¸€ä¸ªæ™®é€šçš„ DataSourceï¼Œè€Œæ˜¯ä¸€ä¸ªä¸“é—¨é’ˆå¯¹æ•°æ®è„±æ•çš„ EncryptDataSourceã€‚å¯¹äºæ•°æ®è„±æ•æ¨¡å—ï¼Œæˆ‘ä»¬çš„æ€è·¯è¿˜æ˜¯ä»ä¸Šåˆ°ä¸‹ï¼Œä» EncryptDataSource å¼€å§‹è¿›å…¥åˆ° ShardingSphere æ•°æ®è„±æ•çš„ä¸–ç•Œä¸­ã€‚</p>
<p>åŒæ—¶ï¼Œæˆ‘ä»¬è¿™æ¬¡è®²è§£æ•°æ®è„±æ•æ¨¡å—ä¸æ˜¯é›¶åŸºç¡€ï¼Œå› ä¸ºåœ¨å‰é¢ä»‹ç» ShardingDataSourceã€ShardingConnectionã€ShardingStatement ç­‰å†…å®¹æ—¶ï¼Œå·²ç»å¯¹æ•´ä¸ª SQL æ‰§è¡Œæµç¨‹çš„æŠ½è±¡è¿‡ç¨‹åšäº†å…¨é¢ä»‹ç»ï¼Œæ‰€æ¶‰åŠçš„å¾ˆå¤šå†…å®¹å¯¹äºæ•°æ®è„±æ•æ¨¡å—è€Œè¨€ä¹Ÿéƒ½æ˜¯é€‚ç”¨çš„ã€‚</p>
<p>è®©æˆ‘ä»¬ç»“åˆä¸‹å›¾æ¥åšä¸€äº›å›é¡¾ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/CgqCHl9sS86ASFTbAAB-yuAnnt4924.png" alt="image"></p>
<p>ä¸Šå›¾ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä¸æ•°æ®è„±æ•æ¨¡å—ç›¸å…³çš„ç±»å®é™…ä¸Šéƒ½ç»§æ‰¿äº†ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œè€Œè¿™äº›æŠ½è±¡ç±»åœ¨å‰é¢çš„å†…å®¹éƒ½å·²ç»åšäº†ä»‹ç»ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯¹æ•°æ®è„±æ•æ¨¡å—å°†é‡ç‚¹å…³æ³¨äºå‡ ä¸ªæ ¸å¿ƒç±»çš„è®²è§£ï¼Œå¯¹äºå·²ç»ä»‹ç»è¿‡çš„å†…å®¹æˆ‘ä»¬ä¼šåšä¸€äº›å›é¡¾ï¼Œä½†ä¸ä¼šé¢é¢ä¿±åˆ°ã€‚</p>
<p>åŸºäºä¸Šå›¾ï¼Œæˆ‘ä»¬ä» EncryptDataSource å¼€å§‹å…¥æ‰‹ï¼ŒEncryptDataSource çš„åˆ›å»ºä¾èµ–äºå·¥å‚ç±» EncryptDataSourceFactoryï¼Œå…¶å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class EncryptDataSourceFactory {

    public static DataSource createDataSource(final DataSource dataSource, final EncryptRuleConfiguration encryptRuleConfiguration, final Properties props) throws SQLException {
        return new EncryptDataSource(dataSource, new EncryptRule(encryptRuleConfiguration), props);
    }
}
</code></pre><p>è¿™é‡Œç›´æ¥åˆ›å»ºäº†ä¸€ä¸ª EncryptDataSourceï¼Œä¾èµ–äº EncryptRule è§„åˆ™å¯¹è±¡ï¼Œæˆ‘ä»¬å…ˆæ¥æ¢³ç†ä¸€ä¸‹ EncryptRule ä¸­å…·ä½“åŒ…å«äº†å“ªäº›å†…å®¹ã€‚</p>
<h3 id="encryptrule">EncryptRule</h3>
<p>EncryptRule æ˜¯æ•°æ®è„±æ•æ¨¡å—çš„ä¸€ä¸ªæ ¸å¿ƒå¯¹è±¡ï¼Œå€¼å¾—æˆ‘ä»¬ä¸“é—¨è¿›è¡Œå±•å¼€ã€‚åœ¨ EncryptRule ä¸­ï¼Œå®šä¹‰äº†å¦‚ä¸‹æ‰€ç¤ºçš„ä¸‰ä¸ªæ ¸å¿ƒå˜é‡ï¼š</p>
<pre tabindex="0"><code>//åŠ è§£å¯†å™¨
private final Map&lt;String, ShardingEncryptor&gt; encryptors = new LinkedHashMap&lt;&gt;();
//è„±æ•æ•°æ®è¡¨
private final Map&lt;String, EncryptTable&gt; tables = new LinkedHashMap&lt;&gt;();
//è„±æ•è§„åˆ™é…ç½®
private EncryptRuleConfiguration ruleConfiguration;
</code></pre><p>æˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸‰ä¸ªå˜é‡åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­ ShardingEncryptor ç”¨äºå®ŒæˆåŠ è§£å¯†ï¼Œè€Œ EncryptTable å’Œ EncryptRuleConfiguration åˆ™æ›´å¤šçš„ä¸æ•°æ®è„±æ•çš„é…ç½®ä½“ç³»ç›¸å…³ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘å°†å¯¹è¿™ä¸¤éƒ¨åˆ†åˆ†åˆ«å±•å¼€è®²è§£ã€‚</p>
<h4 id="1shardingencryptor">1.ShardingEncryptor</h4>
<p>åœ¨ EncryptRule ä¸­ï¼ŒShardingEncryptor æ˜¯ä¸€ä¸ªæ¥å£ï¼Œä»£è¡¨å…·ä½“çš„åŠ å¯†å™¨ç±»ï¼Œè¯¥æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>public interface ShardingEncryptor extends TypeBasedSPI {
    //åˆå§‹åŒ–
    void init();
    //åŠ å¯†
    String encrypt(Object plaintext);
    //è§£å¯†
    Object decrypt(String ciphertext);
}
</code></pre><p>ShardingEncryptor æ¥å£ä¸­å­˜åœ¨ä¸€å¯¹ç”¨äºåŠ å¯†å’Œè§£å¯†çš„æ–¹æ³•ï¼ŒåŒæ—¶è¯¥æ¥å£ä¹Ÿç»§æ‰¿äº† TypeBasedSPI æ¥å£ï¼Œæ„å‘³ç€ä¼šé€šè¿‡ SPI çš„æ–¹å¼è¿›è¡ŒåŠ¨æ€ç±»åŠ è½½ã€‚</p>
<p>ShardingEncryptorServiceLoader å®Œæˆäº†è¿™ä¸ªå·¥ä½œï¼ŒåŒæ—¶åœ¨ sharding-core-common å·¥ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿæ‰¾åˆ°äº† SPI çš„é…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/CgqCHl9jFdmATyqTAAC9ufzW9Ag886.png" alt="Drawing 1.png"></p>
<p>ShardingEncryptor çš„ SPI é…ç½®æ–‡ä»¶</p>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸¤ä¸ªå®ç°ç±»ï¼Œåˆ†åˆ«æ˜¯ MD5ShardingEncryptor å’Œ AESShardingEncryptorã€‚å¯¹äº MD5 ç®—æ³•è€Œè¨€ï¼Œæˆ‘ä»¬çŸ¥é“å®ƒæ˜¯å•å‘æ•£åˆ—çš„ï¼Œæ— æ³•æ ¹æ®å¯†æ–‡åæ¨å‡ºæ˜æ–‡ï¼ŒMD5ShardingEncryptor çš„å®ç°ç±»å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class MD5ShardingEncryptor implements ShardingEncryptor {

    private Properties properties = new Properties();

    @Override
    public String getType() {
        return &quot;MD5&quot;;
    }

    @Override
    public void init() {
    }

    @Override
    public String encrypt(final Object plaintext) {
        return DigestUtils.md5Hex(String.valueOf(plaintext));
    }

    @Override
    public Object decrypt(final String ciphertext) {
        return ciphertext;
    }
}
</code></pre><p>è€Œ AES æ˜¯ä¸€ä¸ªå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œæ‰€ä»¥å¯ä»¥æ ¹æ®å¯†æ–‡åæ¨å‡ºæ˜æ–‡ï¼Œå¯¹åº”çš„ AESShardingEncryptor å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class AESShardingEncryptor implements ShardingEncryptor {

    private static final String AES_KEY = &quot;aes.key.value&quot;;

    private Properties properties = new Properties();

    @Override
    public String getType() {
        return &quot;AES&quot;;
    }

    @Override
    public void init() {
    }

    @Override
    @SneakyThrows
    public String encrypt(final Object plaintext) {
        byte[] result = getCipher(Cipher.ENCRYPT_MODE).doFinal(StringUtils.getBytesUtf8(String.valueOf(plaintext)));
       //ä½¿ç”¨ Base64 è¿›è¡ŒåŠ å¯†
        return Base64.encodeBase64String(result);
    }

    @Override
    @SneakyThrows
    public Object decrypt(final String ciphertext) {
        if (null == ciphertext) {
            return null;
        }
       //ä½¿ç”¨ Base64 è¿›è¡Œè§£å¯†
        byte[] result = getCipher(Cipher.DECRYPT_MODE).doFinal(Base64.decodeBase64(String.valueOf(ciphertext)));
        return new String(result, StandardCharsets.UTF_8);
    }

    private Cipher getCipher(final int decryptMode) throws NoSuchPaddingException, NoSuchAlgorithmException, InvalidKeyException {
        Preconditions.checkArgument(properties.containsKey(AES_KEY), &quot;No available secret key for `%s`.&quot;, AESShardingEncryptor.class.getName());
        Cipher result = Cipher.getInstance(getType());
        result.init(decryptMode, new SecretKeySpec(createSecretKey(), getType()));
        return result;
    }

    private byte[] createSecretKey() {
        Preconditions.checkArgument(null != properties.get(AES_KEY), String.format(&quot;%s can not be null.&quot;, AES_KEY));
       //åˆ›å»ºç§˜é’¥
        return Arrays.copyOf(DigestUtils.sha1(properties.get(AES_KEY).toString()), 16);
    }
}
</code></pre><p>è¿™é‡Œå°±æ˜¯å¯¹ä¸€äº›å¸¸ç”¨åŠ å¯†åº“çš„ç›´æ¥ä½¿ç”¨ï¼Œä¸åšå±•å¼€è®¨è®ºã€‚</p>
<h4 id="2encryptruleconfiguration">2.EncryptRuleConfiguration</h4>
<p>æˆ‘ä»¬æ¥ä¸‹æ¥å…³æ³¨äº EncryptRule ä¸­çš„ç¬¬äºŒç»„å˜é‡ï¼Œå³ EncryptTableï¼Œä»¥åŠä¸ä¹‹ç›¸å…³çš„é…ç½®ç±» EncryptRuleConfiguration ä¹‹é—´çš„å…³ç³»ã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ EncryptRuleConfigurationï¼Œå†…éƒ¨åŒ…å«äº†ä¸¤éƒ¨åˆ†å†…å®¹ï¼š</p>
<pre tabindex="0"><code>private final Map&lt;String, EncryptorRuleConfiguration&gt; encryptors;
private final Map&lt;String, EncryptTableRuleConfiguration&gt; tables;
</code></pre><p>è€Œåœ¨ EncryptTableRuleConfiguration å†…éƒ¨ï¼ŒåŒæ ·ä¿å­˜ç€ä¸€ä¸ª EncryptColumnRuleConfiguration åˆ—è¡¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private final Map&lt;String, EncryptColumnRuleConfiguration&gt; columns = new LinkedHashMap&lt;&gt;();
</code></pre><p>æˆ‘ä»¬å†æ¥çœ‹ EncryptColumnRuleConfiguration çš„æ•°æ®ç»“æ„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class EncryptColumnRuleConfiguration {
    //å­˜å‚¨æ˜æ–‡çš„å­—æ®µ
    private final String plainColumn;
    //å­˜å‚¨å¯†æ–‡çš„å­—æ®µ
    private final String cipherColumn;
    //è¾…åŠ©æŸ¥è¯¢å­—æ®µ
    private final String assistedQueryColumn;
    //åŠ å¯†å™¨åå­—
    private final String encryptor;
}
</code></pre><p>ç»ˆäºï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œçœ‹åˆ°äº†æŒ‡å®šå­˜æ”¾æ˜æ–‡çš„ plainColumnã€å­˜æ”¾å¯†æ–‡çš„ cipherColumnï¼Œä»¥åŠåŠ å¯†å™¨ encryptor ç­‰ä¿¡æ¯ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥å›é¡¾æ¡ˆä¾‹ä¸­çš„ç›¸å…³é…ç½®é¡¹æ¥åŠ æ·±ç†è§£ï¼š</p>
<pre tabindex="0"><code>spring.shardingsphere.encrypt.tables.encrypt_user.columns.user_name.plainColumn=user_name_plain
spring.shardingsphere.encrypt.tables.encrypt_user.columns.user_name.cipherColumn=user_name
spring.shardingsphere.encrypt.tables.encrypt_user.columns.user_name.encryptor=name_encryptor
</code></pre><p>æˆ‘ä»¬å›åˆ°æœ€ä¸Šå±‚çš„ EncryptRuleï¼Œå‘ç°å®ƒçš„æ„é€ å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public EncryptRule(final EncryptRuleConfiguration encryptRuleConfig) {
        this.ruleConfiguration = encryptRuleConfig;
        Preconditions.checkArgument(isValidRuleConfiguration(), &quot;Invalid encrypt column configurations in EncryptTableRuleConfigurations.&quot;);
        initEncryptors(encryptRuleConfig.getEncryptors());
        initTables(encryptRuleConfig.getTables());
}
</code></pre><p>ä¸Šè¿° initEncryptors æ–¹æ³•å°±æ˜¯åˆå§‹åŒ–åŠ è§£å¯†å™¨ Encryptorï¼Œè€Œ initTables æ–¹æ³•ä¼šæ ¹æ® EncryptRuleConfiguration ä¸­çš„ EncryptTableRuleConfiguration æ¥åˆå§‹åŒ– EncryptTableã€‚è¿™é‡Œçš„ EncryptTable æ›´å¤šæ˜¯ä¸€ç§ä¸­é—´é¢†åŸŸæ¨¡å‹ï¼Œç”¨äºç®€åŒ–å¯¹å„ç§é…ç½®ä¿¡æ¯çš„å¤„ç†ï¼Œå…¶å†…éƒ¨ä¿å­˜ç€ä¸€ä¸ª EncryptColumn åˆ—è¡¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private final Map&lt;String, EncryptColumn&gt; columns;
</code></pre><p>è€Œè¿™ä¸ª EncryptColumn ä¸­çš„å˜é‡åˆ™è·Ÿå‰é¢ä»‹ç»çš„ EncryptColumnRuleConfiguration ä¸€æ ·ï¼ŒåŒ…å«äº†å­˜æ”¾æ˜æ–‡çš„ plainColumnã€å­˜æ”¾å¯†æ–‡çš„ cipherColumnï¼Œä»¥åŠåŠ å¯†å™¨ encryptor ç­‰ä¿¡æ¯ã€‚</p>
<p>åœ¨äº†è§£äº† EncryptRule ä¸­æ‰€æŒæœ‰çš„æ•°æ®æ¨¡å‹ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥çœ‹ä¸€ä¸‹ EncryptDataSourceï¼Œåœ¨ EncryptDataSource çš„æ„é€ å‡½æ•°ä¸­ä½¿ç”¨åˆ°äº† EncryptRuleï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private final EncryptRuntimeContext runtimeContext;

public EncryptDataSource(final DataSource dataSource, final EncryptRule encryptRule, final Properties props) throws SQLException {
        super(dataSource);
        runtimeContext = new EncryptRuntimeContext(dataSource, encryptRule, props, getDatabaseType());
}
</code></pre><p>å¯ä»¥çœ‹åˆ°æ‰€ä¼ å…¥çš„ EncryptRule å’Œ Properties æ˜¯ç”¨æ¥æ„å»ºä¸€ä¸ª EncryptRuntimeContextï¼Œè¯¥ç±»ç»§æ‰¿è‡ª AbstractRuntimeContext ç±»ï¼Œè€Œ EncryptRuntimeContext å†…éƒ¨ä¸»è¦ä¿å­˜äº†ç”¨äºæè¿°è¡¨å…ƒæ•°æ®çš„ TableMetas æ•°æ®ç»“æ„ã€‚</p>
<h3 id="åŸºäºæ”¹å†™å¼•æ“çš„æ•°æ®è„±æ•å®ç°æ–¹æ¡ˆ">åŸºäºæ”¹å†™å¼•æ“çš„æ•°æ®è„±æ•å®ç°æ–¹æ¡ˆ</h3>
<p>æˆ‘ä»¬çŸ¥é“ EncryptDataSource ç»§æ‰¿äº†é€‚é…å™¨ç±» AbstractDataSourceAdapterï¼Œè€Œå®ƒçš„ä½œç”¨å°±æ˜¯ç”Ÿæˆ EncryptConnectionã€‚è€Œå¯¹äº EncryptConnectionï¼Œæˆ‘ä»¬åŒæ ·ä¹Ÿæ˜ç¡®å®ƒçš„èŒè´£æ˜¯åˆ›å»ºå„ç§ EncryptStatement å’Œ EncryptPreparedStatementï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@Override
public Statement createStatement() throws SQLException {
    return new EncryptStatement(this);
}
 
@Override
public PreparedStatement prepareStatement(final String sql) throws SQLException {
    return new EncryptPreparedStatement(this, sql);
}
</code></pre><p>ç„¶åï¼Œæˆ‘ä»¬å†å¿«é€Ÿæ¥åˆ° EncryptStatementï¼Œæ¥çœ‹å®ƒçš„ executeQuery æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@Override
public ResultSet executeQuery(final String sql) throws SQLException {
        if (Strings.isNullOrEmpty(sql)) {
            throw new SQLException(SQLExceptionConstant.SQL_STRING_NULL_OR_EMPTY);
        }
        //è·å–æ”¹å†™åçš„ SQL å¹¶æ‰§è¡Œ
        ResultSet resultSet = statement.executeQuery(getRewriteSQL(sql));
        this.resultSet = new EncryptResultSet(connection.getRuntimeContext(), sqlStatementContext, this, resultSet);
        return this.resultSet;
}
</code></pre><p>æ˜¾ç„¶è¿™é‡Œéœ€è¦é‡ç‚¹å…³æ³¨çš„æ˜¯ getRewriteSQL æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨äºè·å–æ”¹å†™åçš„ SQLï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private String getRewriteSQL(final String sql) { 
    //é€šè¿‡ ParseEngine å¯¹ SQL è¿›è¡Œè§£æ
     SQLStatement sqlStatement = connection.getRuntimeContext().getParseEngine().parse(sql, false);
    //è·å–å…³ç³»å…ƒæ•°æ® RelationMetas
     RelationMetas relationMetas = getRelationMetas(connection.getRuntimeContext().getTableMetas());
     //æ„å»º SQLStatementContext
     sqlStatementContext = SQLStatementContextFactory.newInstance(relationMetas, sql, Collections.emptyList(), sqlStatement);
     //æ„å»º SQLRewriteContext
     SQLRewriteContext sqlRewriteContext = new SQLRewriteContext(relationMetas, sqlStatementContext, sql, Collections.emptyList());
     //åˆ¤æ–­æ˜¯å¦æ ¹æ®æ•°æ®è„±æ•åˆ—è¿›è¡ŒæŸ¥è¯¢
     boolean isQueryWithCipherColumn = connection.getRuntimeContext().getProps().&lt;Boolean&gt;getValue(ShardingPropertiesConstant.QUERY_WITH_CIPHER_COLUMN);
     //æ„å»º EncryptSQLRewriteContextDecorator å¯¹ SQLRewriteContext è¿›è¡Œè£…é¥°
     new EncryptSQLRewriteContextDecorator(connection.getRuntimeContext().getRule(), isQueryWithCipherColumn).decorate(sqlRewriteContext);
     //ç”Ÿæˆ SQLTokens
     sqlRewriteContext.generateSQLTokens();
     //ä½¿ç”¨ DefaultSQLRewriteEngine è¿›è¡Œæ”¹å†™
    String result = new DefaultSQLRewriteEngine().rewrite(sqlRewriteContext).getSql();
    //æ‰“å°ç»“æœ
    showSQL(result);
    //è¿”å›ç»“æœ
    return result;
}
</code></pre><p>è¿™ä¸ªæ–¹æ³•çš„éƒ¨åˆ†ä»£ç æœ‰ä¸€ç§è®©äººä¼¼æ›¾ç›¸è¯†çš„æ„Ÿè§‰ï¼Œæˆ‘ä»¬å›æƒ³ä¸€ä¸‹ <strong>â€œ20 | æ”¹å†™å¼•æ“ï¼šå¦‚ä½•ç†è§£è£…é¥°å™¨æ¨¡å¼ä¸‹çš„ SQL æ”¹å†™å®ç°æœºåˆ¶ï¼Ÿâ€</strong> ä¸­ä»‹ç»çš„ BaseShardingEngineçš„rewriteAndConvert æ–¹æ³•ï¼Œä¹Ÿçœ‹åˆ°è¿‡ isQueryWithCipherColumn åˆ¤æ–­ï¼Œä»¥åŠ EncryptSQLRewriteContextDecoratorï¼Œå½“æ—¶æˆ‘ä»¬æ²¡æœ‰å…·ä½“å±•å¼€ï¼Œä»Šå¤©å°±æ¥ä¸€èµ·çœ‹ä¸€ä¸‹ã€‚</p>
<h4 id="1encryptsqlrewritecontextdecorator">1.EncryptSQLRewriteContextDecorator</h4>
<p>EncryptSQLRewriteContextDecorator å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class EncryptSQLRewriteContextDecorator implements SQLRewriteContextDecorator {

    private final EncryptRule encryptRule;

    private final boolean isQueryWithCipherColumn;

    @Override
    public void decorate(final SQLRewriteContext sqlRewriteContext) {
         //å‚æ•°æ”¹å†™
        for (ParameterRewriter each : new EncryptParameterRewriterBuilder(encryptRule, isQueryWithCipherColumn).getParameterRewriters(sqlRewriteContext.getRelationMetas())) {
            if (!sqlRewriteContext.getParameters().isEmpty() &amp;&amp; each.isNeedRewrite(sqlRewriteContext.getSqlStatementContext())) {
                each.rewrite(sqlRewriteContext.getParameterBuilder(), sqlRewriteContext.getSqlStatementContext(), sqlRewriteContext.getParameters());
            }
        }

        //SQLTokenGenerator åˆå§‹åŒ–
        sqlRewriteContext.addSQLTokenGenerators(new EncryptTokenGenerateBuilder(encryptRule, isQueryWithCipherColumn).getSQLTokenGenerators());
    }
}
</code></pre><p>æˆ‘ä»¬è¿˜æ˜¯æ¥å¯¹æ¯” ShardingSQLRewriteContextDecorator ç±»ï¼Œä¼šå‘ç°å®ƒä¸ EncryptSQLRewriteContextDecorator ç±»çš„ç»“æ„å®Œå…¨ä¸€è‡´ã€‚åŒºåˆ«åœ¨äºè¿™é‡Œåˆ›å»ºçš„ ParameterRewriterBuilder å’Œ SQLTokenGeneratorBuilder åˆ†åˆ«æ˜¯ EncryptParameterRewriterBuilder å’Œ EncryptTokenGenerateBuilderï¼Œè€Œä¸æ˜¯ShardingParameterRewriterBuilder å’Œ ShardingTokenGenerateBuilderã€‚ä½†è¿™ä¸¤ç»„ç±»çš„å†…éƒ¨ç»“æ„åŒæ ·æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚</p>
<p>åœ¨ EncryptParameterRewriterBuilder å†…éƒ¨ï¼ŒåŒæ ·ä½¿ç”¨å¦‚ä¸‹æ–¹æ³•è·å–ä¸€ç»„ ParameterRewriterï¼š</p>
<pre tabindex="0"><code>private Collection&lt;ParameterRewriter&gt; getParameterRewriters() {
        Collection&lt;ParameterRewriter&gt; result = new LinkedList&lt;&gt;();
        result.add(new EncryptAssignmentParameterRewriter());
        result.add(new EncryptPredicateParameterRewriter());
        result.add(new EncryptInsertValueParameterRewriter());
        return result;
}
</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…ˆä»¥ EncryptAssignmentParameterRewriter ä¸ºä¾‹æ¥çœ‹ç”¨äºæ•°æ®è„±æ•çš„å…·ä½“ ParameterRewriter çš„å®ç°æœºåˆ¶ã€‚</p>
<h4 id="2encryptassignmentparameterrewriter">2.EncryptAssignmentParameterRewriter</h4>
<p>EncryptAssignmentParameterRewriter ç±»å®Œæˆåœ¨æ•°æ®è„±æ•åœºæ™¯ä¸‹å¯¹å‚æ•°èµ‹å€¼è¿‡ç¨‹çš„æ”¹å†™ã€‚æˆ‘ä»¬é¦–å…ˆæ³¨æ„åˆ° EncryptAssignmentParameterRewriter ä¸­å­˜åœ¨ä¸€ä¸ª isNeedRewriteForEncrypt æ–¹æ³•ç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦æ”¹å†™ã€‚</p>
<pre tabindex="0"><code>@Override
protected boolean isNeedRewriteForEncrypt(final SQLStatementContext sqlStatementContext) {
        return sqlStatementContext.getSqlStatement() instanceof UpdateStatement
                || sqlStatementContext instanceof InsertSQLStatementContext &amp;&amp; sqlStatementContext.getSqlStatement().findSQLSegment(SetAssignmentsSegment.class).isPresent();
}
</code></pre><p>è¿™é‡Œçš„åˆ¤æ–­æ¡ä»¶æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ UpdateStatementï¼Œä¸€ä¸ªæ˜¯ InsertSQLStatementContextï¼ˆä¸”å…¶ä¸­çš„ SQLStatement ä¸­åŒ…å« SetAssignmentsSegmentï¼‰ã€‚æˆ‘ä»¬çŸ¥é“åœ¨ SQL è¯­æ³•ä¸­ï¼ŒINSERT å’Œ UPDATE è¯­å¥ä¸­éƒ½å…·æœ‰å¦‚ä¸‹æ‰€ç¤ºçš„ SET èµ‹å€¼éƒ¨åˆ†ï¼š</p>
<pre tabindex="0"><code>SET userId = 1, task_name = 'taskName'
</code></pre><p>EncryptAssignmentParameterRewriter ç±»é’ˆå¯¹çš„å°±æ˜¯è¿™ç§åœºæ™¯ã€‚æˆ‘ä»¬æ¥çœ‹å®ƒçš„ Rewrite æ ¸å¿ƒæ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@Override
public void rewrite(final ParameterBuilder parameterBuilder, final SQLStatementContext sqlStatementContext, final List&lt;Object&gt; parameters) {
        String tableName = sqlStatementContext.getTablesContext().getSingleTableName();
        //è·å– SetAssignmentsSegment å¹¶è¿›è¡Œéå†
        for (AssignmentSegment each : getSetAssignmentsSegment(sqlStatementContext.getSqlStatement()).getAssignments()) {
             //åˆ¤æ–­æ˜¯å¦å­˜åœ¨ ShardingEncryptor
            if (each.getValue() instanceof ParameterMarkerExpressionSegment &amp;&amp; getEncryptRule().findShardingEncryptor(tableName, each.getColumn().getName()).isPresent()) {
                StandardParameterBuilder standardParameterBuilder = parameterBuilder instanceof StandardParameterBuilder
                        ? (StandardParameterBuilder) parameterBuilder : ((GroupedParameterBuilder) parameterBuilder).getParameterBuilders().get(0);
                  //å¯¹å‚æ•°è¿›è¡ŒåŠ å¯†
                encryptParameters(standardParameterBuilder, tableName, each, parameters);
            }
        }
}
</code></pre><p>è¿™é‡Œé€šè¿‡ getSetAssignmentsSegment æ–¹æ³•è·å– SetAssignmentsSegmentï¼Œå®ç°è¿‡ç¨‹å°±æ˜¯æ ¹æ® SQLStatement ç±»å‹åˆ†åˆ«è·å– InsertStatement å’Œ UpdateStatement ä¸­çš„ SetAssignmentã€‚</p>
<p>ç„¶åï¼Œæˆ‘ä»¬å¾ªç¯éå†æ¯ä¸€ä¸ª SetAssignmentsSegmentï¼Œé’ˆå¯¹è¡¨ä¸­çš„æ¯ä¸€ä¸ª Column åˆ¤æ–­æ˜¯å¦å­˜åœ¨ ShardingEncryptorï¼Œå¦‚æœæœ‰çš„è¯å°±è¿”å›å¯¹åº”çš„åŠ è§£å¯†å™¨ã€‚</p>
<p>è¿™éƒ¨åˆ†åˆ¤æ–­å·¥ä½œå°±æ˜¯åœ¨å‰é¢ä»‹ç»çš„ EncryptRule ä¸­å®Œæˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public Optional&lt;ShardingEncryptor&gt; findShardingEncryptor(final String logicTable, final String logicColumn) {
        if (!tables.containsKey(logicTable)) {
            return Optional.absent();
        }
        Optional&lt;String&gt; encryptor = tables.get(logicTable).findShardingEncryptor(logicColumn);
        return encryptor.isPresent() ? Optional.of(encryptors.get(encryptor.get())) : Optional.&lt;ShardingEncryptor&gt;absent();
}
</code></pre><p>ç„¶åæˆ‘ä»¬è·å– StandardParameterBuilderï¼Œå¹¶è°ƒç”¨ encryptParameters æ–¹æ³•å®Œæˆå‚æ•°çš„æ•°æ®è„±æ•æ“ä½œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private void encryptParameters(final StandardParameterBuilder parameterBuilder, final String tableName, final AssignmentSegment assignmentSegment, final List&lt;Object&gt; parameters) {
        String columnName = assignmentSegment.getColumn().getName();
        int parameterMarkerIndex = ((ParameterMarkerExpressionSegment) assignmentSegment.getValue()).getParameterMarkerIndex();
        Object originalValue = parameters.get(parameterMarkerIndex);

        //é€šè¿‡ ShardingEncryptor è¿›è¡ŒåŠ å¯†ï¼Œå¹¶æ›¿æ¢åŸæ¥å­˜å‚¨å¯†æ–‡çš„ cipherColumn
        Object cipherValue = getEncryptRule().getEncryptValues(tableName, columnName, Collections.singletonList(originalValue)).iterator().next();
        parameterBuilder.addReplacedParameters(parameterMarkerIndex, cipherValue);
        Collection&lt;Object&gt; addedParameters = new LinkedList&lt;&gt;();

        //å¦‚æœå­˜åœ¨ assistedQueryColumnï¼Œåˆ™æ·»åŠ è¾…åŠ©æŸ¥è¯¢å­—æ®µ
        if (getEncryptRule().findAssistedQueryColumn(tableName, columnName).isPresent()) {
            Object assistedQueryValue = getEncryptRule().getEncryptAssistedQueryValues(tableName, columnName, Collections.singletonList(originalValue)).iterator().next();
            addedParameters.add(assistedQueryValue);
        }

        //å¦‚æœå­˜åœ¨ plainColumnï¼Œåˆ™æ·»åŠ æ˜æ–‡å­—æ®µ
        if (getEncryptRule().findPlainColumn(tableName, columnName).isPresent()) {
            addedParameters.add(originalValue);
        }
        if (!addedParameters.isEmpty()) {
            parameterBuilder.addAddedParameters(parameterMarkerIndex + 1, addedParameters);
        }
}
</code></pre><p>è¿™é‡Œçš„æ ¸å¿ƒé€»è¾‘å°±æ˜¯ç»§ç»­é€šè¿‡ EncryptRule çš„ getEncryptValues æ–¹æ³•è·å–å¯†æ–‡ï¼Œç„¶åé€šè¿‡è·å–å…·ä½“çš„ ShardingEncryptor å¹¶è°ƒç”¨å…¶æ–¹æ³•å®Œæˆè¿™ä¸€æ“ä½œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public List&lt;Object&gt; getEncryptValues(final String logicTable, final String logicColumn, final List&lt;Object&gt; originalValues) {
        final Optional&lt;ShardingEncryptor&gt; shardingEncryptor = findShardingEncryptor(logicTable, logicColumn);
        Preconditions.checkArgument(shardingEncryptor.isPresent(), String.format(&quot;Can not find ShardingQueryAssistedEncryptor by %s.%s.&quot;, logicTable, logicColumn));
        return Lists.transform(originalValues, new Function&lt;Object, Object&gt;() {

            @Override
            public Object apply(final Object input) {
                return null == input ? null : String.valueOf(shardingEncryptor.get().encrypt(input.toString()));
            }
        });
}
</code></pre><p>å…³äº EncryptAssignmentParameterRewriter çš„å®ç°ï¼Œè¿™é‡Œé¢æ¶‰åŠçš„ç±»ä¹Ÿæ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæ¥ç”»å¼ å›¾ä½œä¸ºåç»­è®¨è®ºçš„åŸºç¡€ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/CgqCHl9sS-OAJsx-AACWGMkVQXg279.png" alt="imag"></p>
<h4 id="3encryptassignmenttokengenerator">3.EncryptAssignmentTokenGenerator</h4>
<p>è®¨è®ºå®Œ EncryptParameterRewriterBuilder ä¹‹åï¼Œæˆ‘ä»¬å†æ¥è®¨è®º EncryptTokenGenerateBuilderã€‚è¿™é‡Œï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯ä»¥ EncryptAssignmentTokenGenerator ä¸ºä¾‹æ¥è¿›è¡Œå±•å¼€ï¼Œåœ¨è¿™ä¸ªç±»ä¸­ï¼Œæ ¸å¿ƒæ–¹æ³•æ˜¯ generateSQLTokensï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@Override
public Collection&lt;EncryptAssignmentToken&gt; generateSQLTokens(final SQLStatementContext sqlStatementContext) {
        Collection&lt;EncryptAssignmentToken&gt; result = new LinkedList&lt;&gt;();
        String tableName = sqlStatementContext.getTablesContext().getSingleTableName();
        //è·å– SetAssignmentsSegment å¹¶è¿›è¡Œéå†
        for (AssignmentSegment each : getSetAssignmentsSegment(sqlStatementContext.getSqlStatement()).getAssignments()) {
         //åˆ¤æ–­æ˜¯å¦å­˜åœ¨ ShardingEncryptor
         if (getEncryptRule().findShardingEncryptor(tableName, each.getColumn().getName()).isPresent()) {
             //ç”Ÿæˆ SQLToken
             Optional&lt;EncryptAssignmentToken&gt; sqlToken = generateSQLToken(tableName, each);
                if (sqlToken.isPresent()) {
                    result.add(sqlToken.get());
                }
            }
        }
        return result;
}
</code></pre><p>è¿™é‡ŒåŒæ ·æ ¹æ®æ˜¯å¦æ‰¾åˆ° ShardingEncryptor æ¥æ‰§è¡Œåç»­çš„ generateSQLToken æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨ç±»ä¼¼å¦‚ä¸‹æ‰€ç¤ºçš„ generateLiteralSQLToken æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>private EncryptAssignmentToken generateLiteralSQLToken(final String tableName, final AssignmentSegment assignmentSegment) {
        EncryptLiteralAssignmentToken result = new EncryptLiteralAssignmentToken(assignmentSegment.getColumn().getStartIndex(), assignmentSegment.getStopIndex());
        addCipherAssignment(tableName, assignmentSegment, result);
        addAssistedQueryAssignment(tableName, assignmentSegment, result);
        addPlainAssignment(tableName, assignmentSegment, result);
        return result;
}
</code></pre><p>ä»¥ä¸Šé¢çš„ addCipherAssignment æ–¹æ³•ä¸ºä¾‹ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³è±¡è¯¥æ–¹æ³•é€šè¿‡è°ƒç”¨ ShardingEncryptor æ¥å®Œæˆäº† CipherColumn çš„è®¾ç½®ã€‚</p>
<pre tabindex="0"><code>private void addCipherAssignment(final String tableName, final AssignmentSegment assignmentSegment, final EncryptLiteralAssignmentToken token) {
        Object originalValue = ((LiteralExpressionSegment) assignmentSegment.getValue()).getLiterals();
        Object cipherValue = getEncryptRule().getEncryptValues(tableName, assignmentSegment.getColumn().getName(), Collections.singletonList(originalValue)).iterator().next();
        token.addAssignment(getEncryptRule().getCipherColumn(tableName, assignmentSegment.getColumn().getName()), cipherValue);
}
</code></pre><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å¯¹ EncryptSQLRewriteContextDecorator çš„ä»‹ç»å°±å‘Šä¸€æ®µè½ï¼Œè¿™éƒ¨åˆ†å†…å®¹å¯ä»¥ç»“åˆ <strong>â€œ20 | æ”¹å†™å¼•æ“ï¼šå¦‚ä½•ç†è§£è£…é¥°å™¨æ¨¡å¼ä¸‹çš„ SQL æ”¹å†™å®ç°æœºåˆ¶ï¼Ÿâ€</strong> ä¸€èµ·æ¥çœ‹ï¼Œä»¥ä¾¿åŠ æ·±ç†è§£ã€‚</p>
<h3 id="æ•°æ®è„±æ•å’Œç»“æœå½’å¹¶">æ•°æ®è„±æ•å’Œç»“æœå½’å¹¶</h3>
<p>ä»‹ç»å®Œäº† EncryptSQLRewriteContextDecorator ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å›åˆ° EncryptStatement ç±»ï¼Œç»§ç»­æ¢è®¨ getRewriteSQL æ–¹æ³•çš„åç»­æµç¨‹ã€‚</p>
<p>æˆ‘ä»¬å›åˆ° EncryptStatement çš„ executeQuery æ–¹æ³•ï¼Œå›é¡¾å¦‚ä¸‹è¯­å¥ï¼š</p>
<pre tabindex="0"><code>ResultSet resultSet = statement.executeQuery(getRewriteSQL(sql));
</code></pre><p>æˆ‘ä»¬é€šè¿‡æ‰§è¡Œ executeQuery æ–¹æ³•è·å–äº† ResultSetï¼Œä½†å¹¶ä¸æ˜¯ç›´æ¥è¿”å›è¿™ä¸ª resultSet å¯¹è±¡ï¼Œè€Œæ˜¯éœ€è¦å¯¹å…¶è¿›è¡Œå°è£…ï¼Œæ„å»ºä¸€ä¸ª EncryptResultSet å¯¹è±¡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>this.resultSet = new EncryptResultSet(connection.getRuntimeContext(), sqlStatementContext, this, resultSet);
</code></pre><p>EncryptResultSet ç»§æ‰¿äº† AbstractUnsupportedOperationResultSet ç±»ï¼Œè€Œ AbstractUnsupportedOperationResultSet åˆç»§æ‰¿äº† AbstractUnsupportedUpdateOperationResultSetï¼Œè¿™ä¸ª AbstractUnsupportedUpdateOperationResultSet åˆç»§æ‰¿äº† WrapperAdapter ç±»å¹¶å®ç°äº† ResultSet æ¥å£ã€‚æ‰€ä»¥ EncryptResultSet ä¹Ÿæ˜¯ä¸€ç§é€‚é…å™¨ï¼Œè¿™ç‚¹å’Œ EncryptDataSourceã€EncryptConnection åœ¨æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ã€‚</p>
<p>å¯¹äº EncryptResultSet è€Œè¨€ï¼Œå­˜åœ¨ä¸€å¤§æ‰¹ get æ–¹æ³•ï¼Œæˆ‘ä»¬éƒ½ä¸éœ€è¦ä¸“é—¨è¿›è¡Œä»‹ç»ï¼Œå…³é”®ç‚¹åœ¨äºæ„é€ å‡½æ•°ä¸­çš„å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>mergedResult = createMergedResult(queryWithCipherColumn, resultSet);
</code></pre><p>æˆ‘ä»¬çŸ¥é“ ShardingSphere ä¸­ï¼Œæ‰§è¡Œå¼•æ“ä¹‹åå°±æ˜¯å½’å¹¶å¼•æ“ï¼Œè€Œåœ¨ EncryptResultSet ä¸­æˆ‘ä»¬å°±ç”¨åˆ°äº†å½’å¹¶å¼•æ“å¹¶ç”Ÿæˆäº† MergedResultã€‚</p>
<p>EncryptResultSet ä¼šå…ˆåˆ¤æ–­ä¼ å…¥çš„ SQLStatement æ˜¯å¦æ˜¯ä¸€ç§ DALStatementï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¼šè°ƒç”¨ DALEncryptMergeEngine å®Œæˆç»“æœå½’å¹¶ï¼›å¦‚æœä¸æ˜¯ï¼Œåˆ™ä¼šä½¿ç”¨ DQLEncryptMergeEngineï¼Œæˆ‘ä»¬åŒæ ·é‡ç‚¹å…³æ³¨ DQLEncryptMergeEngineã€‚</p>
<pre tabindex="0"><code>public final class DQLEncryptMergeEngine implements MergeEngine {
    private final EncryptorMetaData metaData;
    private final MergedResult mergedResult;
    private final boolean queryWithCipherColumn;

    @Override
    public MergedResult merge() {
        return new EncryptMergedResult(metaData, mergedResult, queryWithCipherColumn);
    }
}
</code></pre><p>DQLEncryptMergeEngine éå¸¸ç®€å•ï¼Œå…¶ merge æ–¹æ³•åªæ˜¯æ„å»ºäº†ä¸€ä¸ª EncryptMergedResult å¯¹è±¡å¹¶è¿›è¡Œè¿”å›ã€‚EncryptMergedResult ä¸­æ ¸å¿ƒæ–¹æ³• getValue å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@Override
public Object getValue(final int columnIndex, final Class&lt;?&gt; type) throws SQLException {
        Object value = mergedResult.getValue(columnIndex, type);
        if (null == value || !queryWithCipherColumn) {
            return value;
        }
        Optional&lt;ShardingEncryptor&gt; encryptor = metaData.findEncryptor(columnIndex);
        return encryptor.isPresent() ? encryptor.get().decrypt(value.toString()) : value;
}
</code></pre><p>æ˜¾ç„¶ï¼Œä»ä¸Šè¿°æµç¨‹ä¸­ä¸éš¾çœ‹å‡ºï¼Œæ•°æ®è„±æ•æ¨¡å—ä¸­çš„å½’å¹¶å®ç°å®é™…ä¸Šå°±æ˜¯è°ƒç”¨ ShardingEncryptor çš„ decrypt æ–¹æ³•å°†åŠ å¯†åˆ—çš„å¯†æ–‡è§£å¯†æˆæ˜æ–‡å³å¯ã€‚</p>
<p>è¿™æ ·æ•´ä¸ª EncryptStatement çš„ executeQuery æ–¹æ³•çš„æ•´ä½“æµç¨‹å°±ä»‹ç»å®Œæ¯•äº†ï¼Œç†è§£äº†è¿™ä¸ªæ–¹æ³•çš„å®ç°è¿‡ç¨‹ä¹‹åï¼Œå¯¹äº EncryptStatement å’Œ EncryptPreparedStatement çš„å…¶ä»–æ–¹æ³•è€Œè¨€ï¼Œç†è§£èµ·æ¥å°±æ¯”è¾ƒå®¹æ˜“äº†ã€‚</p>
<h3 id="ä»æºç è§£æåˆ°æ—¥å¸¸å¼€å‘">ä»æºç è§£æåˆ°æ—¥å¸¸å¼€å‘</h3>
<p>å¯¹äºä»Šå¤©è®¨è®ºçš„ä¸»é¢˜è€Œè¨€ï¼Œèƒ½å¤Ÿç›´æ¥åº”ç”¨åˆ°æ—¥å¸¸å¼€å‘è¿‡ç¨‹ä¸­çš„å†…å®¹å°±æ˜¯ ShardingEncryptor çš„æŠ½è±¡è¿‡ç¨‹ï¼Œä»¥åŠå†…éƒ¨çš„åŠ è§£å¯†å®ç°æœºåˆ¶ã€‚ShardingSphere ä½¿ç”¨äº† DigestUtils å·¥å…·ç±»æ¥å®Œæˆ MD5 ç®—æ³•çš„åº”ç”¨ï¼Œä»¥åŠ Base64 å·¥å…·ç±»æ¥å®ŒæˆAESç®—æ³•çš„å®ç°ã€‚</p>
<p>è¿™ä¸¤ä¸ªå·¥å…·ç±»éƒ½å¯ä»¥å®Œå…¨ç…§æ¬åˆ°æˆ‘ä»¬è‡ªå·±çš„ç³»ç»Ÿä¸­ï¼Œä»è€Œæ·»åŠ æˆç†Ÿçš„åŠ è§£å¯†ç®—æ³•å®ç°æ–¹æ¡ˆã€‚</p>
<h3 id="å°ç»“ä¸é¢„å‘Š">å°ç»“ä¸é¢„å‘Š</h3>
<p>ä»Šå¤©ï¼Œæˆ‘ä»¬è®¨è®ºäº† ShardingSphere ä¸­å®ç°æ•°æ®è„±æ•æœºåˆ¶çš„åº•å±‚åŸç†ã€‚æˆ‘ä»¬å‘ç°æ•°æ®è„±æ•æ¨¡å—åŒæ—¶ä¾èµ–äºåˆ†ç‰‡å¼•æ“ä¸­çš„æ”¹å†™å¼•æ“å’Œå½’å¹¶å¼•æ“è¿™ä¸¤å¤§å—å†…å®¹ï¼Œå°¤å…¶æ˜¯æ”¹å†™å¼•æ“åœ¨æ•°æ®è„±æ•è¿‡ç¨‹ä¸­èµ·åˆ°äº†æ ¸å¿ƒä½œç”¨ï¼Œé€šè¿‡è¡¥åˆ—çš„æ–¹å¼å®Œæˆæ˜æ–‡æ•°æ®ä¸å¯†æ–‡æ•°æ®ä¹‹é—´çš„è‡ªåŠ¨åŠ è§£å¯†ï¼Œä»¥åŠé€æ˜çš„ SQL è½¬æ¢è¿‡ç¨‹ã€‚</p>
<p>è¿™é‡Œç•™ä¸€é“æ€è€ƒé¢˜ï¼šShardingSphere ä¸­ï¼Œæ•°æ®è„±æ•æ¨¡å—ä¸æ”¹å†™å¼•æ“å’Œå½’å¹¶å¼•æ“ä¹‹é—´æ˜¯æ€ä¹ˆæ ·çš„åä½œå…³ç³»ï¼Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸å¤§å®¶è®¨è®ºï¼Œæˆ‘å°†é€ä¸€ç‚¹è¯„è§£ç­”ã€‚</p>
<p>åœ¨ä»‹ç»å®Œä»Šå¤©çš„æ•°æ®è„±æ•æœºåˆ¶ä¹‹åï¼Œæ˜å¤©å°†ä»‹ç»ä¸€ä¸ªåŒæ ·éå¸¸æœ‰ç”¨çš„ç¼–æ’å’Œæ²»ç†åŠŸèƒ½ï¼Œæˆ‘ä»¬å°†åŸºäºé…ç½®ä¸­å¿ƒè§£æå®ç°é…ç½®ä¿¡æ¯åŠ¨æ€åŒ–ç®¡ç†çš„åº•å±‚åŸç†ã€‚</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/29-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1shardingsphere-%E4%B8%AD%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%E4%B8%8B/"><span>29 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸‹ï¼‰</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/31-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E7%9A%84%E5%8A%A8%E6%80%81%E5%8C%96%E7%AE%A1%E7%90%86/"><span>31 é…ç½®ä¸­å¿ƒï¼šå¦‚ä½•åŸºäºé…ç½®ä¸­å¿ƒå®ç°é…ç½®ä¿¡æ¯çš„åŠ¨æ€åŒ–ç®¡ç†ï¼Ÿ</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 27270 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>