<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>18 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•å®ç°æ•°æ®è®¿é—®çš„åˆ†ç‰‡è·¯ç”±å’Œå¹¿æ’­è·¯ç”±ï¼Ÿ | Yipsen Ye</title>
<meta name="description" content="åœ¨ä¸Šä¸€è¯¾æ—¶ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°èµ·åˆ°æ‰¿ä¸Šå¯ä¸‹ä½œç”¨çš„ ShardingRouter ä¼šè°ƒç”¨ RoutingEngine è·å–è·¯ç”±ç»“æœï¼Œè€Œåœ¨ ShardingSphere ä¸­å­˜åœ¨å¤šç§ä¸åŒç±»å‹çš„ RoutingEngineï¼Œåˆ†åˆ«é’ˆå¯¹ä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚
æˆ‘ä»¬å¯ä»¥æŒ‰ç…§æ˜¯å¦æºå¸¦åˆ†ç‰‡é”®ä¿¡æ¯å°†è¿™äº›è·¯ç”±æ–¹å¼åˆ†æˆä¸¤å¤§ç±»ï¼Œå³åˆ†ç‰‡è·¯ç”±å’Œå¹¿æ’­è·¯ç”±ï¼Œè€Œè¿™ä¸¤ç±»è·¯ç”±ä¸­åˆå­˜åœ¨ä¸€äº›å¸¸è§çš„ RoutingEngine å®ç°ç±»å‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
æˆ‘ä»¬æ— æ„å¯¹æ‰€æœ‰è¿™äº› RoutingEngine è¿›è¡Œè¯¦ç»† çš„ å±•å¼€ï¼Œä½†åœ¨æ¥ä¸‹æ¥çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬ä¼šåˆ†åˆ«å¯¹åˆ†ç‰‡è·¯ç”±å’Œå¹¿æ’­è·¯ç”±ä¸­å…·æœ‰ä»£è¡¨æ€§çš„ RoutingEngine è¿›è¡Œè®¨è®ºã€‚
åˆ†ç‰‡è·¯ç”± å¯¹äºåˆ†ç‰‡è·¯ç”±è€Œè¨€ï¼Œæˆ‘ä»¬å°†é‡ç‚¹ä»‹ç»æ ‡å‡†è·¯ç”±ï¼Œæ ‡å‡†è·¯ç”±æ˜¯ ShardingSphere æ¨èä½¿ç”¨çš„åˆ†ç‰‡æ–¹å¼ã€‚
åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆè€ƒè™‘æ ‡å‡†è·¯ç”±çš„é€‚ç”¨èŒƒå›´ã€‚æ ‡å‡†è·¯ç”±é€‚ç”¨èŒƒå›´æœ‰ä¸¤å¤§åœºæ™¯ï¼šä¸€ç§é¢å‘ä¸åŒ…å«å…³è”æŸ¥è¯¢çš„ SQLï¼›å¦ä¸€ç§åˆ™é€‚ç”¨äºä»…åŒ…å«ç»‘å®šè¡¨å…³è”æŸ¥è¯¢çš„ SQLã€‚å‰é¢ä¸€ç§åœºæ™¯æ¯”è¾ƒå¥½ç†è§£ï¼Œè€Œé’ˆå¯¹åè€…ï¼Œæˆ‘ä»¬å°±éœ€è¦å¼•å…¥ç»‘å®šè¡¨è¿™ä¸ª ShardingSphere ä¸­çš„é‡è¦æ¦‚å¿µã€‚
å…³äºç»‘å®šè¡¨ï¼Œæˆ‘ä»¬å·²ç»åœ¨ [ã€Š06 | æ•°æ®åˆ†ç‰‡ï¼šå¦‚ä½•å®ç°åˆ†åº“ã€åˆ†è¡¨ã€åˆ†åº“&#43;åˆ†è¡¨ä»¥åŠå¼ºåˆ¶è·¯ç”±ï¼ˆä¸Šï¼‰ï¼Ÿã€‹]ä¸­è¿›è¡Œäº†è®¨è®ºï¼Œåœ¨æ˜ç¡®äº†è¿™äº›æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹æ ‡å‡†è·¯ç”±çš„å…·ä½“å®ç°è¿‡ç¨‹ã€‚
1.StandardRoutingEngine çš„åˆ›å»ºè¿‡ç¨‹ æ˜ç¡®äº†æ ‡å‡†è·¯ç”±çš„åŸºæœ¬å«ä¹‰ä¹‹åï¼Œæˆ‘ä»¬å›é¡¾ä¸€ä¸‹ä¸Šä¸€è¯¾æ—¶ä¸­ä»‹ç»çš„å·¥å‚ç±» RoutingEngineFactoryã€‚RoutingEngineFactory ç±»æ ¹æ®ä¸Šä¸‹æ–‡ä¸­çš„è·¯ç”±ä¿¡æ¯æ„å»ºå¯¹åº”çš„ RoutingEngineï¼Œä½†åœ¨å…¶ newInstance æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å‘ç°ç›´æ¥åˆ›å»ºStandardRoutingEngine çš„ä»£ç ã€‚äº‹å®ä¸Šï¼ŒStandardRoutingEngine çš„åˆ›å»ºæ˜¯åœ¨ newInstance æ–¹æ³•ä¸­çš„æœ€åä¸€ä¸ªä»£ç åˆ†æ”¯ï¼Œå³å½“æ‰€æœ‰å‰ç½®çš„åˆ¤æ–­éƒ½ä¸æˆç«‹æ—¶ä¼šè¿›å…¥åˆ°æœ€åçš„ getShardingRoutingEngine ä»£ç åˆ†æ”¯ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
private static RoutingEngine getShardingRoutingEngine(final ShardingRule shardingRule, final SQLStatementContext sqlStatementContext,final ShardingConditions shardingConditions, final Collection&amp;lt;String&amp;gt; tableNames) { //æ ¹æ®åˆ†ç‰‡è§„åˆ™è·å–åˆ†ç‰‡è¡¨ Collection&amp;lt;String&amp;gt; shardingTableNames = shardingRule.getShardingLogicTableNames(tableNames); //å¦‚æœç›®æ ‡è¡¨åªè¦ä¸€å¼ ï¼Œæˆ–è€…è¯´ç›®æ ‡è¡¨éƒ½æ˜¯ç»‘å®šè¡¨å…³ç³»ï¼Œåˆ™æ„å»ºStandardRoutingEngine if (1 == shardingTableNames.">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="nav-logo">
    <a href="http://yipsen.github.io/">
        
        <span class="nav-title">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æ–‡ç« </a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/shardingsphere%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e7%b2%be%e8%ae%b2/">ShardingSphereæ ¸å¿ƒåŸç†ç²¾è®²</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/00-%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E5%AD%A6%E4%B9%A0%E4%B8%80%E6%AC%BE%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/">00 å¦‚ä½•æ­£ç¡®å­¦ä¹ ä¸€æ¬¾åˆ†åº“åˆ†è¡¨å¼€æºæ¡†æ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/01-%E4%BB%8E%E7%90%86%E8%AE%BA%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%A6%82%E4%BD%95%E8%AE%A9%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%9C%9F%E6%AD%A3%E8%90%BD%E5%9C%B0/">01 ä»ç†è®ºåˆ°å®è·µï¼šå¦‚ä½•è®©åˆ†åº“åˆ†è¡¨çœŸæ­£è½åœ°ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/02-%E9%A1%B6%E7%BA%A7%E9%A1%B9%E7%9B%AEshardingsphere-%E6%98%AF%E4%B8%80%E6%AC%BE%E4%BB%80%E4%B9%88%E6%A0%B7%E7%9A%84-apache-%E5%BC%80%E6%BA%90%E8%BD%AF%E4%BB%B6/">02 é¡¶çº§é¡¹ç›®ï¼šShardingSphere æ˜¯ä¸€æ¬¾ä»€ä¹ˆæ ·çš„ Apache å¼€æºè½¯ä»¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/03-%E8%A7%84%E8%8C%83%E5%85%BC%E5%AE%B9jdbc-%E8%A7%84%E8%8C%83%E4%B8%8E-shardingsphere-%E6%98%AF%E4%BB%80%E4%B9%88%E5%85%B3%E7%B3%BB/">03 è§„èŒƒå…¼å®¹ï¼šJDBC è§„èŒƒä¸ ShardingSphere æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/04-%E5%BA%94%E7%94%A8%E9%9B%86%E6%88%90%E5%9C%A8%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F%E4%B8%AD%E4%BD%BF%E7%94%A8-shardingsphere-%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9C%89%E5%93%AA%E4%BA%9B/">04 åº”ç”¨é›†æˆï¼šåœ¨ä¸šåŠ¡ç³»ç»Ÿä¸­ä½¿ç”¨ ShardingSphere çš„æ–¹å¼æœ‰å“ªäº›ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/05-%E9%85%8D%E7%BD%AE%E9%A9%B1%E5%8A%A8shardingsphere-%E4%B8%AD%E7%9A%84%E9%85%8D%E7%BD%AE%E4%BD%93%E7%B3%BB%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E7%9A%84/">05 é…ç½®é©±åŠ¨ï¼šShardingSphere ä¸­çš„é…ç½®ä½“ç³»æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/09-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E4%B8%8E%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1/">09 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¦‚ä½•ä½¿ç”¨å¼ºä¸€è‡´æ€§äº‹åŠ¡ä¸æŸ”æ€§äº‹åŠ¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/10-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E5%A6%82%E4%BD%95%E7%A1%AE%E4%BF%9D%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AE%89%E5%85%A8%E8%AE%BF%E9%97%AE/">10 æ•°æ®è„±æ•ï¼šå¦‚ä½•ç¡®ä¿æ•æ„Ÿæ•°æ®çš„å®‰å…¨è®¿é—®ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/11-%E7%BC%96%E6%8E%92%E6%B2%BB%E7%90%86%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/">11 ç¼–æ’æ²»ç†ï¼šå¦‚ä½•å®ç°åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„åŠ¨æ€é…ç½®ç®¡ç†ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/12-%E4%BB%8E%E5%BA%94%E7%94%A8%E5%88%B0%E5%8E%9F%E7%90%86%E5%A6%82%E4%BD%95%E9%AB%98%E6%95%88%E9%98%85%E8%AF%BB-shardingsphere-%E6%BA%90%E7%A0%81/">12 ä»åº”ç”¨åˆ°åŸç†ï¼šå¦‚ä½•é«˜æ•ˆé˜…è¯» ShardingSphere æºç ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/13-%E5%BE%AE%E5%86%85%E6%A0%B8%E6%9E%B6%E6%9E%84shardingsphere-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%89%A9%E5%B1%95%E6%80%A7/">13 å¾®å†…æ ¸æ¶æ„ï¼šShardingSphere å¦‚ä½•å®ç°ç³»ç»Ÿçš„æ‰©å±•æ€§ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/14-%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AEshardingsphere-%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AE%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F/">14 åˆ†å¸ƒå¼ä¸»é”®ï¼šShardingSphere ä¸­æœ‰å“ªäº›åˆ†å¸ƒå¼ä¸»é”®å®ç°æ–¹å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/15-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8A/">15 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/16-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8B/">16 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/17-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E5%88%86%E7%89%87%E8%B7%AF%E7%94%B1%E6%A0%B8%E5%BF%83%E7%B1%BB-shardingrouter-%E7%9A%84%E8%BF%90%E4%BD%9C%E6%9C%BA%E5%88%B6/">17 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•ç†è§£åˆ†ç‰‡è·¯ç”±æ ¸å¿ƒç±» ShardingRouter çš„è¿ä½œæœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li>18 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•å®ç°æ•°æ®è®¿é—®çš„åˆ†ç‰‡è·¯ç”±å’Œå¹¿æ’­è·¯ç”±ï¼Ÿ</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/19-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%9C%A8%E8%B7%AF%E7%94%B1%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%9B%86%E6%88%90%E5%A4%9A%E7%A7%8D%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E5%92%8C%E8%B7%AF%E7%94%B1%E7%AE%97%E6%B3%95/">19 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•åœ¨è·¯ç”±è¿‡ç¨‹ä¸­é›†æˆå¤šç§è·¯ç”±ç­–ç•¥å’Œè·¯ç”±ç®—æ³•ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/20-%E6%94%B9%E5%86%99%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84-sql-%E6%94%B9%E5%86%99%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6/">20 æ”¹å†™å¼•æ“ï¼šå¦‚ä½•ç†è§£è£…é¥°å™¨æ¨¡å¼ä¸‹çš„ SQL æ”¹å†™å®ç°æœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/21-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%88%86%E7%89%87%E7%8E%AF%E5%A2%83%E4%B8%8B-sql-%E6%89%A7%E8%A1%8C%E7%9A%84%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E6%8A%BD%E8%B1%A1/">21 æ‰§è¡Œå¼•æ“ï¼šåˆ†ç‰‡ç¯å¢ƒä¸‹ SQL æ‰§è¡Œçš„æ•´ä½“æµç¨‹åº”è¯¥å¦‚ä½•è¿›è¡ŒæŠ½è±¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/22-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E6%8A%8A%E6%8F%A1-shardingsphere-%E4%B8%AD%E7%9A%84-executor-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8A/">22 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/23-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E6%8A%8A%E6%8F%A1-shardingsphere-%E4%B8%AD%E7%9A%84-executor-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8B/">23 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/24-%E5%BD%92%E5%B9%B6%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E6%95%B0%E6%8D%AE%E5%BD%92%E5%B9%B6%E7%9A%84%E7%B1%BB%E5%9E%8B%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%BD%92%E5%B9%B6%E7%AD%96%E7%95%A5%E7%9A%84%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B/">24 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æ•°æ®å½’å¹¶çš„ç±»å‹ä»¥åŠç®€å•å½’å¹¶ç­–ç•¥çš„å®ç°è¿‡ç¨‹ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/25-%E5%BD%92%E5%B9%B6%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E6%B5%81%E5%BC%8F%E5%BD%92%E5%B9%B6%E5%92%8C%E5%86%85%E5%AD%98%E5%BD%92%E5%B9%B6%E5%9C%A8%E5%A4%8D%E6%9D%82%E5%BD%92%E5%B9%B6%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84%E5%BA%94%E7%94%A8%E6%96%B9%E5%BC%8F/">25 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æµå¼å½’å¹¶å’Œå†…å­˜å½’å¹¶åœ¨å¤æ‚å½’å¹¶åœºæ™¯ä¸‹çš„åº”ç”¨æ–¹å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/26-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%99%AE%E9%80%9A%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%92%8C%E5%88%86%E7%89%87%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%88%86%E5%88%AB%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84/">26 è¯»å†™åˆ†ç¦»ï¼šæ™®é€šä¸»ä»æ¶æ„å’Œåˆ†ç‰‡ä¸»ä»æ¶æ„åˆ†åˆ«æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/27-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3-shardingsphere-%E4%B8%AD%E5%AF%B9%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%8A%BD%E8%B1%A1%E8%BF%87%E7%A8%8B/">27 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¦‚ä½•ç†è§£ ShardingSphere ä¸­å¯¹åˆ†å¸ƒå¼äº‹åŠ¡çš„æŠ½è±¡è¿‡ç¨‹ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/28-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1shardingsphere-%E4%B8%AD%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%E4%B8%8A/">28 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/29-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1shardingsphere-%E4%B8%AD%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%E4%B8%8B/">29 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/30-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E6%94%B9%E5%86%99%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%E4%BD%8E%E4%BE%B5%E5%85%A5%E6%80%A7%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E6%96%B9%E6%A1%88/">30 æ•°æ®è„±æ•ï¼šå¦‚ä½•åŸºäºæ”¹å†™å¼•æ“å®ç°ä½ä¾µå…¥æ€§æ•°æ®è„±æ•æ–¹æ¡ˆï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/31-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E7%9A%84%E5%8A%A8%E6%80%81%E5%8C%96%E7%AE%A1%E7%90%86/">31 é…ç½®ä¸­å¿ƒï¼šå¦‚ä½•åŸºäºé…ç½®ä¸­å¿ƒå®ç°é…ç½®ä¿¡æ¯çš„åŠ¨æ€åŒ–ç®¡ç†ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/32-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BF%E9%97%AE%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6/">32 æ³¨å†Œä¸­å¿ƒï¼šå¦‚ä½•åŸºäºæ³¨å†Œä¸­å¿ƒå®ç°æ•°æ®åº“è®¿é—®ç†”æ–­æœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/33-%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E-hook-%E6%9C%BA%E5%88%B6%E4%BB%A5%E5%8F%8A-opentracing-%E5%8D%8F%E8%AE%AE%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA/">33 é“¾è·¯è·Ÿè¸ªï¼šå¦‚ä½•åŸºäº Hook æœºåˆ¶ä»¥åŠ OpenTracing åè®®å®ç°æ•°æ®è®¿é—®é“¾è·¯è·Ÿè¸ªï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/35-%E7%BB%93%E8%AF%ADshardingsphere-%E6%80%BB%E7%BB%93%E5%8F%8A%E5%B1%95%E6%9C%9B/">35 ç»“è¯­ï¼šShardingSphere æ€»ç»“åŠå±•æœ›</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">18 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•å®ç°æ•°æ®è®¿é—®çš„åˆ†ç‰‡è·¯ç”±å’Œå¹¿æ’­è·¯ç”±ï¼Ÿ</h1>
        <div class="post-info">
            <div class="post-date"> 
                <span>2021-12-22 01:55:57</span>
            </div>
        </div>
        <div class="post-content">
            <p>åœ¨ä¸Šä¸€è¯¾æ—¶ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°èµ·åˆ°æ‰¿ä¸Šå¯ä¸‹ä½œç”¨çš„ ShardingRouter ä¼šè°ƒç”¨ RoutingEngine è·å–è·¯ç”±ç»“æœï¼Œè€Œåœ¨ ShardingSphere ä¸­å­˜åœ¨å¤šç§ä¸åŒç±»å‹çš„ RoutingEngineï¼Œåˆ†åˆ«é’ˆå¯¹ä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æŒ‰ç…§<strong>æ˜¯å¦æºå¸¦åˆ†ç‰‡é”®ä¿¡æ¯</strong>å°†è¿™äº›è·¯ç”±æ–¹å¼åˆ†æˆä¸¤å¤§ç±»ï¼Œå³åˆ†ç‰‡è·¯ç”±å’Œå¹¿æ’­è·¯ç”±ï¼Œè€Œè¿™ä¸¤ç±»è·¯ç”±ä¸­åˆå­˜åœ¨ä¸€äº›å¸¸è§çš„ RoutingEngine å®ç°ç±»å‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/Ciqc1F81FdqANHr4AACO1I-IihE703.png" alt="image"></p>
<p>æˆ‘ä»¬æ— æ„å¯¹æ‰€æœ‰è¿™äº› RoutingEngine è¿›è¡Œè¯¦ç»† çš„ å±•å¼€ï¼Œä½†åœ¨æ¥ä¸‹æ¥çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬ä¼šåˆ†åˆ«å¯¹åˆ†ç‰‡è·¯ç”±å’Œå¹¿æ’­è·¯ç”±ä¸­å…·æœ‰ä»£è¡¨æ€§çš„ RoutingEngine è¿›è¡Œè®¨è®ºã€‚</p>
<h3 id="åˆ†ç‰‡è·¯ç”±">åˆ†ç‰‡è·¯ç”±</h3>
<p>å¯¹äºåˆ†ç‰‡è·¯ç”±è€Œè¨€ï¼Œæˆ‘ä»¬å°†é‡ç‚¹ä»‹ç»<strong>æ ‡å‡†è·¯ç”±</strong>ï¼Œæ ‡å‡†è·¯ç”±æ˜¯ ShardingSphere æ¨èä½¿ç”¨çš„åˆ†ç‰‡æ–¹å¼ã€‚</p>
<p>åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆè€ƒè™‘æ ‡å‡†è·¯ç”±çš„é€‚ç”¨èŒƒå›´ã€‚æ ‡å‡†è·¯ç”±é€‚ç”¨èŒƒå›´æœ‰ä¸¤å¤§åœºæ™¯ï¼šä¸€ç§é¢å‘ä¸åŒ…å«å…³è”æŸ¥è¯¢çš„ SQLï¼›å¦ä¸€ç§åˆ™é€‚ç”¨äºä»…åŒ…å«ç»‘å®šè¡¨å…³è”æŸ¥è¯¢çš„ SQLã€‚å‰é¢ä¸€ç§åœºæ™¯æ¯”è¾ƒå¥½ç†è§£ï¼Œè€Œé’ˆå¯¹åè€…ï¼Œæˆ‘ä»¬å°±éœ€è¦å¼•å…¥ç»‘å®šè¡¨è¿™ä¸ª ShardingSphere ä¸­çš„é‡è¦æ¦‚å¿µã€‚</p>
<p>å…³äºç»‘å®šè¡¨ï¼Œæˆ‘ä»¬å·²ç»åœ¨ [ã€Š06 | æ•°æ®åˆ†ç‰‡ï¼šå¦‚ä½•å®ç°åˆ†åº“ã€åˆ†è¡¨ã€åˆ†åº“+åˆ†è¡¨ä»¥åŠå¼ºåˆ¶è·¯ç”±ï¼ˆä¸Šï¼‰ï¼Ÿã€‹]ä¸­è¿›è¡Œäº†è®¨è®ºï¼Œåœ¨æ˜ç¡®äº†è¿™äº›æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹æ ‡å‡†è·¯ç”±çš„å…·ä½“å®ç°è¿‡ç¨‹ã€‚</p>
<h4 id="1standardroutingengine-çš„åˆ›å»ºè¿‡ç¨‹">1.StandardRoutingEngine çš„åˆ›å»ºè¿‡ç¨‹</h4>
<p>æ˜ç¡®äº†æ ‡å‡†è·¯ç”±çš„åŸºæœ¬å«ä¹‰ä¹‹åï¼Œæˆ‘ä»¬å›é¡¾ä¸€ä¸‹ä¸Šä¸€è¯¾æ—¶ä¸­ä»‹ç»çš„å·¥å‚ç±» RoutingEngineFactoryã€‚RoutingEngineFactory ç±»æ ¹æ®ä¸Šä¸‹æ–‡ä¸­çš„è·¯ç”±ä¿¡æ¯æ„å»ºå¯¹åº”çš„ RoutingEngineï¼Œä½†åœ¨å…¶ newInstance æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å‘ç°ç›´æ¥åˆ›å»ºStandardRoutingEngine çš„ä»£ç ã€‚äº‹å®ä¸Šï¼ŒStandardRoutingEngine çš„åˆ›å»ºæ˜¯åœ¨ newInstance æ–¹æ³•ä¸­çš„æœ€åä¸€ä¸ªä»£ç åˆ†æ”¯ï¼Œå³å½“æ‰€æœ‰å‰ç½®çš„åˆ¤æ–­éƒ½ä¸æˆç«‹æ—¶ä¼šè¿›å…¥åˆ°æœ€åçš„ getShardingRoutingEngine ä»£ç åˆ†æ”¯ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private static RoutingEngine getShardingRoutingEngine(final ShardingRule shardingRule, final SQLStatementContext sqlStatementContext,
                                                      final ShardingConditions shardingConditions, final Collection&lt;String&gt; tableNames) { 
    //æ ¹æ®åˆ†ç‰‡è§„åˆ™è·å–åˆ†ç‰‡è¡¨ 
 Collection&lt;String&gt; shardingTableNames = shardingRule.getShardingLogicTableNames(tableNames); 
    //å¦‚æœç›®æ ‡è¡¨åªè¦ä¸€å¼ ï¼Œæˆ–è€…è¯´ç›®æ ‡è¡¨éƒ½æ˜¯ç»‘å®šè¡¨å…³ç³»ï¼Œåˆ™æ„å»ºStandardRoutingEngine 
    if (1 == shardingTableNames.size() || shardingRule.isAllBindingTables(shardingTableNames)) { 
        return new StandardRoutingEngine(shardingRule, shardingTableNames.iterator().next(), sqlStatementContext, shardingConditions); 
    } 
    //å¦åˆ™æ„å»ºComplexRoutingEngine 
    return new ComplexRoutingEngine(shardingRule, tableNames, sqlStatementContext, shardingConditions); 
}
</code></pre><p>è¿™æ®µä»£ç é¦–å…ˆæ ¹æ®è§£æå‡ºæ¥çš„é€»è¾‘è¡¨è·å–åˆ†ç‰‡è¡¨ï¼Œä»¥å¦‚ä¸‹æ‰€ç¤ºçš„ SQL è¯­å¥ä¸ºä¾‹ï¼š</p>
<pre tabindex="0"><code>SELECT record.remark_name FROM health_record record JOIN health_task task ON record.record_id=task.record_id WHERE record.record_id = 1
</code></pre><p>é‚£ä¹ˆ shardingTableNames åº”è¯¥ä¸º health_record å’Œ health_taskã€‚å¦‚æœåˆ†ç‰‡æ“ä½œåªæ¶‰åŠä¸€å¼ è¡¨ï¼Œæˆ–è€…æ¶‰åŠå¤šå¼ è¡¨ï¼Œä½†è¿™äº›è¡¨æ˜¯äº’ä¸ºç»‘å®šè¡¨çš„å…³ç³»æ—¶ï¼Œåˆ™ä½¿ç”¨ StandardRoutingEngine è¿›è¡Œè·¯ç”±ã€‚</p>
<p>åŸºäºç»‘å®šè¡¨çš„æ¦‚å¿µï¼Œå½“å¤šè¡¨äº’ä¸ºç»‘å®šè¡¨å…³ç³»æ—¶ï¼Œæ¯å¼ è¡¨çš„è·¯ç”±ç»“æœæ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥åªè¦è®¡ç®—ç¬¬ä¸€å¼ è¡¨çš„åˆ†ç‰‡å³å¯ï¼›åä¹‹ï¼Œå¦‚æœä¸æ»¡è¶³è¿™ä¸€æ¡ä»¶ï¼Œåˆ™æ„å»ºä¸€ä¸ª ComplexRoutingEngine è¿›è¡Œè·¯ç”±ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä»£ç ä¸­çš„ isAllBindingTables æ–¹æ³•å¦‚ä½•å¯¹å¤šè¡¨äº’ä¸ºç»‘å®šè¡¨å…³ç³»è¿›è¡Œåˆ¤å®šï¼Œè¯¥æ–¹æ³•ä½äº ShardingRule ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public boolean isAllBindingTables(final Collection&lt;String&gt; logicTableNames) { 
    if (logicTableNames.isEmpty()) { 
        return false; 
    } 
    //é€šè¿‡ä¼ å…¥çš„logicTableNamesæ„å»ºä¸€ä¸ªä¸“é—¨çš„BindingTableRule 
    Optional&lt;BindingTableRule&gt; bindingTableRule = findBindingTableRule(logicTableNames); 
    if (!bindingTableRule.isPresent()) { 
        return false; 
    } 
    Collection&lt;String&gt; result = new TreeSet&lt;&gt;(String.CASE_INSENSITIVE_ORDER); 
    //è·å–BindingTableRuleä¸­çš„LogicTable 
    result.addAll(bindingTableRule.get().getAllLogicTables()); 
    //åˆ¤æ–­è·å–çš„LogicTableæ˜¯å¦ä¸ä¼ å…¥çš„logicTableNamesä¸€è‡´ 
    return !result.isEmpty() &amp;&amp; result.containsAll(logicTableNames); 
}
</code></pre><p>è¿™æ®µä»£ç ä¼šé€šè¿‡ä¼ å…¥çš„ logicTableNames æ„å»ºä¸€ä¸ªä¸“é—¨çš„ BindingTableRuleï¼Œç„¶åçœ‹æœ€ç»ˆè·å–çš„ BindingTableRule ä¸­çš„ LogicTable æ˜¯å¦ä¸ä¼ å…¥çš„ logicTableNames ä¸€è‡´ã€‚è¿™é‡Œæ„å»º BindingTableRule çš„è¿‡ç¨‹å®é™…ä¸Šæ˜¯æ ¹æ®ä¼ å…¥çš„ logicTableName æ¥ä» ShardingRule ä¸­è‡ªèº«ä¿å­˜çš„ Collection<code>&lt;BindingTableRule&gt;</code> è·å–å¯¹åº”çš„ BindingTableRuleï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public Optional&lt;BindingTableRule&gt; findBindingTableRule(final String logicTableName) { 
        for (BindingTableRule each : bindingTableRules) { 
            if (each.hasLogicTable(logicTableName)) { 
                return Optional.of(each); 
            } 
        } 
        return Optional.absent(); 
}
</code></pre><p>ä¸Šè¿°ä»£ç çš„ bindingTableRules å°±æ˜¯ ShardingRule ä¸­è‡ªèº«ä¿å­˜çš„ BindingTableRule é›†åˆï¼Œæˆ‘ä»¬åœ¨ ShardingRule æ„é€ å‡½æ•°ä¸­å‘ç°äº†åˆå§‹åŒ– bindingTableRules çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>bindingTableRules = createBindingTableRules(shardingRuleConfig.getBindingTableGroups());
</code></pre><p>æ˜¾ç„¶ï¼Œè¿™ä¸ªæ„å»ºè¿‡ç¨‹ä¸è§„åˆ™é…ç½®æœºåˆ¶æœ‰å…³ã€‚å¦‚æœåŸºäº Yaml é…ç½®æ–‡ä»¶ï¼Œç»‘å®šè¡¨çš„é…ç½®ä¸€èˆ¬ä¼šé‡‡ç”¨å¦‚ä¸‹å½¢å¼ï¼š</p>
<pre tabindex="0"><code>shardingRule:
  bindingTables: 
     health_record,health_task
</code></pre><p>é’ˆå¯¹è¿™ç§é…ç½®å½¢å¼ï¼ŒShardingRule ä¼šå¯¹å…¶è¿›è¡Œè§£æå¹¶ç”Ÿæˆ BindingTableRule å¯¹è±¡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private BindingTableRule createBindingTableRule(final String bindingTableGroup) { 
    List&lt;TableRule&gt; tableRules = new LinkedList&lt;&gt;(); 
    for (String each : Splitter.on(&quot;,&quot;).trimResults().splitToList(bindingTableGroup)) { 
        tableRules.add(getTableRule(each)); 
    } 
    return new BindingTableRule(tableRules); 
}
</code></pre><p>è‡³æ­¤ï¼Œæˆ‘ä»¬ç»ˆäºæŠŠç»‘å®šè¡¨ç›¸å…³çš„æ¦‚å¿µä»¥åŠå®ç°æ–¹å¼åšäº†ä»‹ç»ï¼Œä¹Ÿå°±æ˜¯è¯´å®Œæˆäº† RoutingEngineFactory ä¸­è¿›å…¥åˆ° StandardRoutingEngine è¿™æ¡ä»£ç åˆ†æ”¯çš„ä»‹ç»ã€‚</p>
<h4 id="2standardroutingengine-çš„è¿è¡Œæœºåˆ¶">2.StandardRoutingEngine çš„è¿è¡Œæœºåˆ¶</h4>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»åˆ›å»ºäº† StandardRoutingEngineï¼Œæ¥ä¸‹æ¥å°±çœ‹å®ƒçš„è¿è¡Œæœºåˆ¶ã€‚ä½œä¸ºä¸€ç§å…·ä½“çš„è·¯ç”±å¼•æ“å®ç°æ–¹æ¡ˆï¼ŒStandardRoutingEngine å®ç°äº† RoutingEngine æ¥å£ï¼Œå®ƒçš„ route æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@Override 
public RoutingResult route() { 
    â€¦ 
        return generateRoutingResult(getDataNodes(shardingRule.getTableRule(logicTableName))); 
}
</code></pre><p>è¿™é‡Œçš„æ ¸å¿ƒæ–¹æ³•å°±æ˜¯ generateRoutingResultï¼Œåœ¨æ­¤ä¹‹å‰éœ€è¦å…ˆé€šè¿‡ getDataNodes æ–¹æ³•æ¥è·å–æ•°æ®èŠ‚ç‚¹ä¿¡æ¯ï¼Œè¯¥æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private Collection&lt;DataNode&gt; getDataNodes(final TableRule tableRule) { 
     //å¦‚åŸºäºHintè¿›è¡Œè·¯ç”± 
    if (isRoutingByHint(tableRule)) { 
        return routeByHint(tableRule); 
    } 
    //åŸºäºåˆ†ç‰‡æ¡ä»¶è¿›è¡Œè·¯ç”± 
    if (isRoutingByShardingConditions(tableRule)) { 
        return routeByShardingConditions(tableRule); 
    } 
    //æ‰§è¡Œæ··åˆè·¯ç”± 
    return routeByMixedConditions(tableRule); 
}
</code></pre><p>æˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªæ–¹æ³•çš„å…¥å‚æ˜¯ä¸€ä¸ª TableRule å¯¹è±¡ï¼Œè€Œ TableRule å±äºåˆ†ç‰‡è§„åˆ™ ShardingRule ä¸­çš„ä¸€éƒ¨åˆ†ã€‚æˆ‘ä»¬åœ¨ä¸Šä¸€è¯¾æ—¶ä¸­çŸ¥é“è¯¥å¯¹è±¡ä¸»è¦ä¿å­˜ç€ä¸åˆ†ç‰‡ç›¸å…³çš„å„ç§è§„åˆ™ä¿¡æ¯ï¼Œå…¶ä¸­å°±åŒ…æ‹¬ ShardingStrategyã€‚ä»å‘½åä¸Šçœ‹ï¼ŒShardingStrategy å±äºä¸€ç§åˆ†ç‰‡ç­–ç•¥ï¼Œç”¨äºæŒ‡å®šåˆ†ç‰‡çš„å…·ä½“ Columnï¼Œä»¥åŠæ‰§è¡Œåˆ†ç‰‡å¹¶è¿”å›ç›®æ ‡ DataSource å’Œ Tableã€‚</p>
<p>è¿™éƒ¨åˆ†å†…å®¹æˆ‘ä»¬ä¼šåœ¨ä¸‹ä¸€è¯¾æ—¶ä¸­è¿›è¡Œå±•å¼€ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å…ˆæ¢³ç†ä¸ ShardingStrategy ç›¸å…³çš„ç±»ç»“æ„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p>![image(assets/CgqCHl81FfKAYWCOAACN0o0OVu8479.png)</p>
<p>åœ¨ StandardRoutingEngine ä¸­ï¼Œæ•´ä½“ç»“æ„ä¹Ÿä¸ä¸Šå›¾ç±»ä¼¼ã€‚åœ¨ StandardRoutingEngine ä¸­ï¼Œå‰é¢æ‰€ä»‹ç»çš„ getDataNodes æ–¹æ³•çš„ç¬¬ä¸€ä¸ªåˆ¤æ–­åˆ†æ”¯ isRoutingByHint æ–¹æ³•ä¸­ä¼šåˆ¤æ–­æ˜¯å¦æ ¹æ® Hint æ¥è¿›è¡Œè·¯ç”±ï¼Œå…¶åˆ¤æ–­ä¾æ®æ˜¯å®ƒçš„ DatabaseShardingStrategy å’Œ TableShardingStrategy æ˜¯å¦éƒ½ä¸º HintShardingStrategyï¼Œè¿™ä¸ªæ–¹æ³•å°±ç”¨åˆ°äº† ShardingRule çš„è¿™ä¸¤ä¸ªShardingStrategy å¯¹è±¡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private boolean isRoutingByHint(final TableRule tableRule) { 
    return shardingRule.getDatabaseShardingStrategy(tableRule) instanceof HintShardingStrategy &amp;&amp; shardingRule.getTableShardingStrategy(tableRule) instanceof HintShardingStrategy; 
}
</code></pre><p>åœ¨ ShardingSphere ä¸­ï¼ŒHint ä»£è¡¨çš„æ˜¯ä¸€ç§å¼ºåˆ¶è·¯ç”±çš„æ–¹æ³•ï¼Œæ˜¯ä¸€æ¡æµç¨‹çš„æ”¯çº¿ã€‚ç„¶åï¼Œæˆ‘ä»¬å†çœ‹ getDataNodes æ–¹æ³•ä¸­çš„ isRoutingByShardingConditions åˆ¤æ–­ã€‚æƒ³è¦åˆ¤æ–­æ˜¯å¦æ ¹æ®åˆ†ç‰‡æ¡ä»¶è¿›è¡Œè·¯ç”±ï¼Œå…¶é€»è¾‘åœ¨äº DatabaseShardingStrategy å’Œ TableShardingStrategy éƒ½ä¸æ˜¯ HintShardingStrategy æ—¶å°±èµ°è¿™ä¸ªä»£ç åˆ†æ”¯ã€‚è€Œæœ€ç»ˆå¦‚æœ isRoutingByHint å’Œ isRoutingByShardingConditions éƒ½ä¸æ»¡è¶³ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒDatabaseShardingStrategy æˆ– TableShardingStrategy ä¸­ä»»æ„ä¸€ä¸ªæ˜¯ HintShardingStrategyï¼Œåˆ™æ‰§è¡Œ routeByMixedConditions è¿™ä¸€æ··åˆçš„è·¯ç”±æ–¹å¼ã€‚</p>
<p>ä»¥ä¸Šä¸‰æ¡ä»£ç åˆ†æ”¯è™½ç„¶å¤„ç†æ–¹å¼æœ‰æ‰€ä¸åŒï¼Œä½†<strong>æœ¬è´¨ä¸Šéƒ½æ˜¯è·å– RouteValue çš„é›†åˆ</strong>ï¼Œæˆ‘ä»¬åœ¨ä¸Šä¸€è¯¾æ—¶ä¸­ä»‹ç»è·¯ç”±æ¡ä»¶ ShardingCondition æ—¶çŸ¥é“ï¼ŒRouteValue ä¿å­˜çš„å°±æ˜¯ç”¨äºè·¯ç”±çš„è¡¨åå’Œåˆ—åã€‚åœ¨è·å–äº†æ‰€éœ€çš„ RouteValue ä¹‹åï¼Œåœ¨ StandardRoutingEngine ä¸­ï¼Œä»¥ä¸Šä¸‰ç§åœºæ™¯æœ€ç»ˆéƒ½ä¼šè°ƒç”¨ route0 åŸºç¡€æ–¹æ³•è¿›è¡Œè·¯ç”±ï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨å°±æ˜¯æ ¹æ®è¿™äº› RouteValue å¾—å‡ºç›®æ ‡ DataNode çš„é›†åˆã€‚åŒæ ·ï¼Œæˆ‘ä»¬ä¹ŸçŸ¥é“ DataNode ä¸­ä¿å­˜çš„å°±æ˜¯å…·ä½“çš„ç›®æ ‡èŠ‚ç‚¹ï¼ŒåŒ…æ‹¬ dataSourceNameå’ŒtableNameã€‚route0 æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private Collection&lt;DataNode&gt; route0(final TableRule tableRule, final List&lt;RouteValue&gt; databaseShardingValues, final List&lt;RouteValue&gt; tableShardingValues) { 
    //è·¯ç”±DataSource 
 Collection&lt;String&gt; routedDataSources = routeDataSources(tableRule, databaseShardingValues); 
    Collection&lt;DataNode&gt; result = new LinkedList&lt;&gt;(); 
    //è·¯ç”±Tableï¼Œå¹¶å®ŒæˆDataNodeé›†åˆçš„æ‹¼è£… 
    for (String each : routedDataSources) { 
        result.addAll(routeTables(tableRule, each, tableShardingValues)); 
    } 
    return result; 
}
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œè¯¥æ–¹æ³•é¦–å…ˆè·¯ç”± DataSourceï¼Œç„¶åå†æ ¹æ®æ¯ä¸ª DataSource è·¯ç”± Tableï¼Œæœ€ç»ˆå®Œæˆ DataNode é›†åˆçš„æ‹¼è£…ã€‚åœ¨ä¸Šè¿° routeDataSources å’Œ routeTables æ–¹æ³•ä¸­ï¼Œæœ€ç»ˆéƒ½ä¼šåˆ†åˆ«ä¾èµ– DatabaseShardingStrategy å’Œ TableShardingStrategy å®ŒæˆèƒŒåçš„è·¯ç”±è®¡ç®—ä»¥è·å–ç›®æ ‡ DataSource ä»¥åŠ Tableã€‚</p>
<p>å½“è·å–äº† DataNode é›†åˆä¹‹åï¼Œæˆ‘ä»¬å›åˆ° StandardRoutingEngine çš„ generateRoutingResult æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨äºç»„è£…è·¯ç”±ç»“æœå¹¶è¿”å›ä¸€ä¸ª RoutingResultï¼š</p>
<pre tabindex="0"><code>private RoutingResult generateRoutingResult(final Collection&lt;DataNode&gt; routedDataNodes) { 
    RoutingResult result = new RoutingResult(); 
    for (DataNode each : routedDataNodes) { 
     //æ ¹æ®æ¯ä¸ªDataNodeæ„å»ºä¸€ä¸ªRoutingUnitå¯¹è±¡ 
        RoutingUnit routingUnit = new RoutingUnit(each.getDataSourceName()); 
        //å¡«å……RoutingUnitä¸­çš„TableUnit 
        routingUnit.getTableUnits().add(new TableUnit(logicTableName, each.getTableName())); 
        result.getRoutingUnits().add(routingUnit); 
    } 
    return result; 
}
</code></pre><p>è¿™éƒ¨åˆ†ä»£ç çš„ä½œç”¨å°±æ˜¯æ ¹æ®æ¯ä¸ª DataNode æ„å»ºä¸€ä¸ª RoutingUnit å¯¹è±¡ï¼Œç„¶åå†å¡«å…… RoutingUnit ä¸­çš„ TableUnitã€‚å…³äº RoutingUnit å’Œ TableUnit çš„æ•°æ®ç»“æ„æˆ‘ä»¬åœ¨ä¸Šä¸€è¯¾æ—¶ä¸­å·²ç»è¿›è¡Œäº†ä»‹ç»ï¼Œè¿™é‡Œä¸å†å±•å¼€ã€‚</p>
<p>è‡³æ­¤ï¼Œå¯¹æ ‡å‡†è·¯ç”±å¼•æ“ StandardRoutingEngine çš„ä»‹ç»å°±å‘Šä¸€æ®µè½ï¼Œæ ‡å‡†è·¯ç”±æ˜¯ ShardingSphere æœ€ä¸ºæ¨èä½¿ç”¨çš„åˆ†ç‰‡æ–¹å¼ï¼Œåœ¨æ—¥å¸¸å¼€å‘ä¸­åº”ç”¨ä¹Ÿæœ€å¹¿æ³›ã€‚</p>
<h3 id="å¹¿æ’­è·¯ç”±">å¹¿æ’­è·¯ç”±</h3>
<p>å¯¹äºä¸æºå¸¦åˆ†ç‰‡é”®çš„ SQLï¼Œè·¯ç”±å¼•æ“ä¼šé‡‡å–å¹¿æ’­è·¯ç”±çš„æ–¹å¼ã€‚åœ¨ ShardingSphereï¼Œæ ¹æ®è¾“å…¥ SQL çš„ç±»å‹ï¼Œå­˜åœ¨å¾ˆå¤šç§ç”¨äºå¹¿æ’­çš„è·¯ç”±å¼•æ“ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥å›é¡¾ RoutingEngineFactory ä¸­åˆ›å»º RoutingEngineçš„ æ–¹æ³•ã€‚</p>
<p>é¦–å…ˆï¼Œå¦‚æœè¾“å…¥çš„æ˜¯ TCLStatementï¼Œå³æˆæƒã€è§’è‰²æ§åˆ¶ç­‰æ•°æ®åº“æ§åˆ¶è¯­è¨€ï¼Œé‚£ä¹ˆç›´æ¥æ‰§è¡Œ DatabaseBroadcastRoutingEngineï¼›åŒæ ·ï¼Œå¦‚æœæ‰§è¡Œçš„æ˜¯ç”¨äºæ•°æ®å®šä¹‰çš„ DDLStatementï¼Œåˆ™æ‰§è¡Œ TableBroadcastRoutingEngine ä¸­çš„è·¯ç”±æ–¹æ³•ï¼Œåˆ¤æ–­æ¡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>//å…¨åº“è·¯ç”± 
if (sqlStatement instanceof TCLStatement) { 
    return new DatabaseBroadcastRoutingEngine(shardingRule); 
} 
//å…¨åº“è¡¨è·¯ç”± 
if (sqlStatement instanceof DDLStatement) { 
    return new TableBroadcastRoutingEngine(shardingRule, metaData.getTables(), sqlStatementContext); 
}
</code></pre><p>DatabaseBroadcastRoutingEngine çš„è·¯ç”±æ–¹æ³•éå¸¸ç›´æ¥ï¼Œå³åŸºäºæ¯ä¸ª DataSourceName æ„å»ºä¸€ä¸ª RoutingUnitï¼Œç„¶åå†æ‹¼è£…æˆ RoutingResultï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class DatabaseBroadcastRoutingEngine implements RoutingEngine { 

    private final ShardingRule shardingRule; 

    @Override 
    public RoutingResult route() { 
        RoutingResult result = new RoutingResult(); 
        for (String each : shardingRule.getShardingDataSourceNames().getDataSourceNames()) { 
         //åŸºäºæ¯ä¸ªDataSourceNameæ„å»ºä¸€ä¸ªRoutingUnit 
            result.getRoutingUnits().add(new RoutingUnit(each)); 
        } 
        return result; 
    } 
}
</code></pre><p>åŒæ ·ä¹Ÿå¯ä»¥æƒ³è±¡ TableBroadcastRoutingEngine çš„å®ç°è¿‡ç¨‹ï¼Œæˆ‘ä»¬æ ¹æ® logicTableName è·å–å¯¹åº”çš„ TableRuleï¼Œç„¶åæ ¹æ® TableRule ä¸­çš„çœŸå® DataNode æ„å»º RoutingUnit å¯¹è±¡ï¼Œè¿™ä¸€è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private Collection&lt;RoutingUnit&gt; getAllRoutingUnits(final String logicTableName) { 
    Collection&lt;RoutingUnit&gt; result = new LinkedList&lt;&gt;(); 
    //æ ¹æ®logicTableNameè·å–å¯¹åº”çš„TableRule 
    TableRule tableRule = shardingRule.getTableRule(logicTableName); 
    for (DataNode each : tableRule.getActualDataNodes()) { 
        //æ ¹æ®TableRuleä¸­çš„çœŸå®DataNodeæ„å»ºRoutingUnitå¯¹è±¡ 
        RoutingUnit routingUnit = new RoutingUnit(each.getDataSourceName()); 
        //æ ¹æ®DataNodeçš„TableNameæ„å»ºTableUnit 
        routingUnit.getTableUnits().add(new TableUnit(logicTableName, each.getTableName())); 
        result.add(routingUnit); 
    } 
    return result; 
}
</code></pre><p>æ¥ç€æˆ‘ä»¬æ¥çœ‹é’ˆå¯¹ DALStatement çš„åœºæ™¯ï¼Œè¿™ä¸€åœºæ™¯ç›¸å¯¹å¤æ‚ï¼Œæ ¹æ®è¾“å…¥çš„ DALStatement çš„ä¸åŒç±»å‹ï¼Œä¼šæœ‰å‡ ä¸ªä¸åŒçš„å¤„ç†åˆ†æ”¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private static RoutingEngine getDALRoutingEngine(final ShardingRule shardingRule, final SQLStatement sqlStatement, final Collection&lt;String&gt; tableNames) { 
         //å¦‚æœæ˜¯Useè¯­å¥ï¼Œåˆ™ä»€ä¹ˆä¹Ÿä¸åš 
        if (sqlStatement instanceof UseStatement) { 
            return new IgnoreRoutingEngine(); 
        } 
         //å¦‚æœæ˜¯Setæˆ–ResetParameterè¯­å¥ï¼Œåˆ™è¿›è¡Œå…¨æ•°æ®åº“å¹¿æ’­ 
        if (sqlStatement instanceof SetStatement || sqlStatement instanceof ResetParameterStatement || sqlStatement instanceof ShowDatabasesStatement) { 
            return new DatabaseBroadcastRoutingEngine(shardingRule); 
        } 
        //å¦‚æœå­˜åœ¨é»˜è®¤æ•°æ®åº“ï¼Œåˆ™æ‰§è¡Œé»˜è®¤æ•°æ®åº“è·¯ç”± 
        if (!tableNames.isEmpty() &amp;&amp; !shardingRule.tableRuleExists(tableNames) &amp;&amp; shardingRule.hasDefaultDataSourceName()) { 
            return new DefaultDatabaseRoutingEngine(shardingRule, tableNames); 
        } 
        //å¦‚æœè¡¨åˆ—è¡¨ä¸ä¸ºç©ºï¼Œåˆ™æ‰§è¡Œå•æ’­è·¯ç”± 
        if (!tableNames.isEmpty()) { 
            return new UnicastRoutingEngine(shardingRule, tableNames); 
        } 
        // 
        return new DataSourceGroupBroadcastRoutingEngine(shardingRule); 
}
</code></pre><p>æˆ‘ä»¬åˆ†åˆ«æ¥çœ‹ä¸€ä¸‹è¿™é‡Œé¢çš„å‡ ä¸ªè·¯ç”±å¼•æ“ã€‚é¦–å…ˆæ˜¯æœ€ç®€å•çš„ IgnoreRoutingEngineï¼Œå®ƒåªè¿”å›ä¸€ä¸ªç©ºçš„ RoutingResult å¯¹è±¡ï¼Œå…¶ä»–ä»€ä¹ˆéƒ½ä¸åšï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class IgnoreRoutingEngine implements RoutingEngine { 

    @Override 
    public RoutingResult route() { 
        return new RoutingResult(); 
    } 
}
</code></pre><p>æœ¬è´¨ä¸Šï¼ŒUnicastRoutingEngine ä»£è¡¨å•æ’­è·¯ç”±ï¼Œç”¨äºè·å–æŸä¸€çœŸå®è¡¨ä¿¡æ¯çš„åœºæ™¯ï¼Œå®ƒåªéœ€è¦ä»ä»»æ„åº“ä¸­çš„ä»»æ„çœŸå®è¡¨ä¸­è·å–æ•°æ®å³å¯ã€‚ä¾‹å¦‚ DESCRIBE è¯­å¥å°±é€‚åˆä½¿ç”¨ UnicastRoutingEngineï¼Œå› ä¸ºæ¯ä¸ªçœŸå®è¡¨ä¸­çš„æ•°æ®æè¿°ç»“æ„éƒ½æ˜¯ç›¸åŒçš„ã€‚</p>
<p>UnicastRoutingEngine å®ç°è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼Œç”±äºæ–¹æ³•æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬è£å‰ªäº†ä»£ç ï¼Œç›´æ¥ä½¿ç”¨æ³¨é‡Šæ¥æ ‡æ˜æ¯ä¸ªåˆ†æ”¯çš„æ‰§è¡Œé€»è¾‘ï¼š</p>
<pre tabindex="0"><code>@Override 
public RoutingResult route() { 
    RoutingResult result = new RoutingResult(); 
    if (shardingRule.isAllBroadcastTables(logicTables)) { 
         //å¦‚æœéƒ½æ˜¯å¹¿æ’­è¡¨ï¼Œåˆ™å¯¹æ¯ä¸ªlogicTableç»„è£…TableUnitï¼Œå†æ„å»ºRoutingUnit
    } else if (logicTables.isEmpty()) { 
         //å¦‚æœè¡¨ä¸ºnullï¼Œåˆ™ç›´æ¥ç»„è£…RoutingUnitï¼Œä¸ç”¨æ„å»ºTableUnit
    } else if (1 == logicTables.size()) { 
         //å¦‚æœåªæœ‰ä¸€å¼ è¡¨ï¼Œåˆ™ç»„è£…RoutingUnitå’Œå•ä¸ªè¡¨çš„TableUnit
    } else { 
         //å¦‚æœå­˜åœ¨å¤šä¸ªå®ä½“è¡¨ï¼Œåˆ™å…ˆè·å–DataSourceï¼Œå†ç»„è£…RoutingUnitå’ŒTableUnit
    } 
    return result; 
}
</code></pre><p>DefaultDatabaseRoutingEngineï¼Œé¡¾åæ€ä¹‰æ˜¯å¯¹é»˜è®¤çš„æ•°æ®åº“æ‰§è¡Œè·¯ç”±ã€‚é‚£ä¹ˆè¿™ä¸ªé»˜è®¤æ•°æ®åº“æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä» ShardingRuleçš„ShardingDataSourceNames ç±»ä¸­çš„ getDefaultDataSourceName æ–¹æ³•ä¸­æ‰¾åˆ°ç­”æ¡ˆã€‚</p>
<p>ä¸€èˆ¬ï¼Œè¿™ç§é»˜è®¤æ•°æ®åº“å¯ä»¥é€šè¿‡é…ç½®çš„æ–¹å¼è¿›è¡Œè®¾ç½®ã€‚æ˜ç™½è¿™ä¸€ç‚¹ï¼ŒDefaultDatabaseRoutingEngine çš„è·¯ç”±è¿‡ç¨‹ä¹Ÿå°±ä¸éš¾ç†è§£äº†ï¼Œå…¶ route æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@Override 
public RoutingResult route() { 
    RoutingResult result = new RoutingResult(); 
    List&lt;TableUnit&gt; routingTables = new ArrayList&lt;&gt;(logicTables.size()); 
    for (String each : logicTables) { 
        routingTables.add(new TableUnit(each, each)); 
    } 
    //ä»ShardingRuleä¸­è·å–é»˜è®¤æ‰€é…ç½®çš„æ•°æ®åº“å 
    RoutingUnit routingUnit = new RoutingUnit(shardingRule.getShardingDataSourceNames().getDefaultDataSourceName()); 
    routingUnit.getTableUnits().addAll(routingTables); 
    result.getRoutingUnits().add(routingUnit); 
    return result; 
}
</code></pre><p>æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹é’ˆå¯¹æ•°æ®æ§åˆ¶è¯­è¨€ DCLStatement çš„å¤„ç†æµç¨‹ã€‚åœ¨ä¸»ä»ç¯å¢ƒä¸‹ï¼Œå¯¹äº DCLStatement è€Œè¨€ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ› SQL è¯­å¥åªé’ˆå¯¹ä¸»æ•°æ®åº“è¿›è¡Œæ‰§è¡Œï¼Œæ‰€ä»¥å°±æœ‰äº†å¦‚ä¸‹æ‰€ç¤ºçš„ MasterInstanceBroadcastRoutingEngineï¼š</p>
<pre tabindex="0"><code>@Override 
public RoutingResult route() { 
    RoutingResult result = new RoutingResult(); 
    for (String each : shardingRule.getShardingDataSourceNames().getDataSourceNames()) { 
        if (dataSourceMetas.getAllInstanceDataSourceNames().contains(each)) { 
          //é€šè¿‡MasterSlaveRuleè·å–ä¸»ä»æ•°æ®åº“ä¿¡æ¯ 
            Optional&lt;MasterSlaveRule&gt; masterSlaveRule = shardingRule.findMasterSlaveRule(each); 
            if (!masterSlaveRule.isPresent() || masterSlaveRule.get().getMasterDataSourceName().equals(each)) { 
                result.getRoutingUnits().add(new RoutingUnit(each)); 
            } 
        } 
    } 
    return result; 
}
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå¼•å…¥äº†ä¸€ä¸ª MasterSlaveRule è§„åˆ™ï¼Œè¯¥è§„åˆ™æä¾› getMasterDataSourceName æ–¹æ³•ä»¥è·å–ä¸» DataSourceNameï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é’ˆå¯¹è¿™ä¸ªä¸»æ•°æ®æ‰§è¡Œï¼Œå¦‚ Grant ç­‰æ•°æ®æ§åˆ¶è¯­è¨€ã€‚</p>
<h3 id="ä»æºç è§£æåˆ°æ—¥å¸¸å¼€å‘">ä»æºç è§£æåˆ°æ—¥å¸¸å¼€å‘</h3>
<p>åœ¨ ShardingSphere ä¸­ï¼Œæˆ‘ä»¬è¿˜æ˜¯æœ‰å¿…è¦å†æ¬¡å¼ºè°ƒå…¶åœ¨é…ç½®ä¿¡æ¯ç®¡ç†ä¸Šçš„ä¸€äº›è®¾è®¡å’Œå®è·µã€‚åŸºäº ShardingRule å’Œ TableRule è¿™ä¸¤ä¸ªé…ç½®ç±»ï¼ŒShardingSphere æŠŠå¤§é‡çº·ç¹å¤æ‚çš„é…ç½®ä¿¡æ¯ä»ä¸šåŠ¡æµç¨‹ä¸­è¿›è¡Œéš”ç¦»ï¼Œè€Œè¿™äº›é…ç½®ä¿¡æ¯å¾€å¾€éœ€è¦çµæ´»è¿›è¡Œè®¾ç½®ï¼Œä»¥åŠå¤šç§é»˜è®¤é…ç½®å€¼ã€‚åŸºäº ShardingRule å’Œ TableRule çš„ä¸¤å±‚é…ç½®ä½“ç³»ï¼Œç³»ç»Ÿèƒ½å¤Ÿæ›´å¥½åœ°å®Œæˆä¸šåŠ¡é€»è¾‘çš„å˜åŒ–å’Œé…ç½®ä¿¡æ¯å˜åŒ–ä¹‹é—´çš„æœ‰æ•ˆæ•´åˆï¼Œå€¼å¾—æˆ‘ä»¬åœ¨æ—¥å¸¸å¼€å‘è¿‡ç¨‹ä¸­è¿›è¡Œå°è¯•å’Œåº”ç”¨ã€‚</p>
<h3 id="å°ç»“ä¸é¢„å‘Š">å°ç»“ä¸é¢„å‘Š</h3>
<p>ä»Šå¤©æˆ‘ä»¬å…³æ³¨çš„æ˜¯ ShardingSphere ä¸­å„ç§è·¯ç”±å¼•æ“çš„å®ç°è¿‡ç¨‹ï¼ŒShardingSphere ä¸­å®ç°äº†å¤šæ¬¾ä¸åŒçš„è·¯ç”±å¼•æ“ï¼Œå¯ä»¥åˆ†ä¸ºåˆ†ç‰‡è·¯ç”±å’Œå¹¿æ’­è·¯ç”±ä¸¤å¤§ç±»ã€‚æˆ‘ä»¬é’ˆå¯¹è¿™ä¸¤ç±»è·¯ç”±å¼•æ“ä¸­çš„ä»£è¡¨æ€§å®ç°æ–¹æ¡ˆåˆ†åˆ«å±•å¼€äº†è®¨è®ºã€‚</p>
<p><strong>è¿™é‡Œç»™ä½ ç•™ä¸€é“æ€è€ƒé¢˜ï¼šShardingSphere ä¸­å¦‚ä½•åˆ¤æ–­ä¸¤å¼ è¡¨æ˜¯äº’ä¸ºç»‘å®šè¡¨å…³ç³»ï¼Ÿ</strong> æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸å¤§å®¶è®¨è®ºï¼Œæˆ‘å°†ä¸€ä¸€ç‚¹è¯„è§£ç­”ã€‚</p>
<p>ä»ä»Šå¤©çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†è·¯ç”±å¼•æ“ä¸­è·¯ç”±æœºåˆ¶çš„å®ç°éœ€è¦ä¾èµ–äºåˆ†ç‰‡ç­–ç•¥åŠå…¶èƒŒååˆ†ç‰‡ç®—æ³•çš„é›†æˆï¼Œä¸‹ä¸€è¯¾æ—¶å°†å¯¹ ShardingSphere ä¸­çš„å„ç§åˆ†ç‰‡ç­–ç•¥è¿›è¡Œå…·ä½“çš„å±•å¼€ã€‚</p>

        </div>
    </article>
</div>
<div class="division-line"></div>
<div class="others">
    <div>æ ‡ç­¾ï¼šğŸ·ï¸<a class="post-tag" href="/tags/sharding/">sharding</a>&nbsp;</div>
    <div>åˆ†ç±»ï¼š ğŸ“’<a class="post-category" href="/categories/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/">ShardingSphereæ ¸å¿ƒåŸç†ç²¾è®²</a>&nbsp; </div>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/17-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E5%88%86%E7%89%87%E8%B7%AF%E7%94%B1%E6%A0%B8%E5%BF%83%E7%B1%BB-shardingrouter-%E7%9A%84%E8%BF%90%E4%BD%9C%E6%9C%BA%E5%88%B6/"><span>17 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•ç†è§£åˆ†ç‰‡è·¯ç”±æ ¸å¿ƒç±» ShardingRouter çš„è¿ä½œæœºåˆ¶ï¼Ÿ</span></a>
    </div>
    <div class="next">
        
        <a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/19-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%9C%A8%E8%B7%AF%E7%94%B1%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%9B%86%E6%88%90%E5%A4%9A%E7%A7%8D%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E5%92%8C%E8%B7%AF%E7%94%B1%E7%AE%97%E6%B3%95/"><span>19 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•åœ¨è·¯ç”±è¿‡ç¨‹ä¸­é›†æˆå¤šç§è·¯ç”±ç­–ç•¥å’Œè·¯ç”±ç®—æ³•ï¼Ÿ</span></a>
    </div>
</div>

        </div>
        <div id="float">
            <ul class="float-button-bar">
    <li>
        <button class="float-button top" onclick="scrollToTop(this);">UP</button>
    </li>
    <li>
        <button class="float-button toggler" onclick="changeSkin(this);">DARK</button>
    </li>
</ul>
        </div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 2020 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    const changeSkin = () => {
        document.getElementById('page').classList.toggle('night');
    }
    const scrollToTop = () => {
        window.scrollTo(0, 0);
    }
</script>
</body>

</html>