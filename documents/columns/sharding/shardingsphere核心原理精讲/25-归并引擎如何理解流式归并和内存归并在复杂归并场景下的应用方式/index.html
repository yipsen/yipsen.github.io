<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>25 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æµå¼å½’å¹¶å’Œå†…å­˜å½’å¹¶åœ¨å¤æ‚å½’å¹¶åœºæ™¯ä¸‹çš„åº”ç”¨æ–¹å¼ï¼Ÿ | Yipsen Ye</title>
<meta name="description" content="æ‰¿æ¥ä¸Šä¸€è¯¾æ—¶çš„å†…å®¹ï¼Œä»Šå¤©æˆ‘ä»¬ç»§ç»­ä»‹ç» ShardingSphere ä¸­å‰©ä½™çš„å½’å¹¶ç­–ç•¥ï¼ŒåŒ…æ‹¬åˆ†ç»„å½’å¹¶ã€èšåˆå½’å¹¶å’Œåˆ†é¡µå½’å¹¶ã€‚
 å…¶ä¸­åˆ†ç»„å½’å¹¶æ˜¯æœ€å¤æ‚çš„ä¸€ç§å½’å¹¶ç±»å‹ï¼› èšåˆå½’å¹¶æ˜¯åœ¨åˆ†ç»„å½’å¹¶çš„åŸºç¡€ä¸Šè¿½åŠ çš„å½’å¹¶ï¼› åˆ†é¡µå½’å¹¶åˆ™æ˜¯å…¸å‹çš„é€šè¿‡è£…é¥°å™¨æ¨¡å¼å®ç°çš„å½’å¹¶ç±»å‹ã€‚  æœ€å¤æ‚çš„å½’å¹¶ï¼šåˆ†ç»„å½’å¹¶ åœ¨ ShardingSphere çš„æ‰€æœ‰å½’å¹¶æœºåˆ¶ä¸­ï¼Œåˆ†ç»„å½’å¹¶çš„æƒ…å†µæœ€ä¸ºå¤æ‚ï¼Œå®ƒåŒæ ·å¯ä»¥åˆ†ä¸ºæµå¼åˆ†ç»„å½’å¹¶å’Œå†…å­˜åˆ†ç»„å½’å¹¶ä¸¤ç§å®ç°æ–¹æ¡ˆã€‚
å…¶ä¸­ï¼Œæµå¼åˆ†ç»„å½’å¹¶è¦æ±‚ SQL çš„æ’åºé¡¹ä¸åˆ†ç»„é¡¹çš„å­—æ®µï¼Œä»¥åŠæ’åºç±»å‹å¿…é¡»ä¿æŒä¸€è‡´ï¼Œå¦åˆ™åªèƒ½é€šè¿‡å†…å­˜å½’å¹¶æ‰èƒ½ä¿è¯å…¶æ•°æ®çš„æ­£ç¡®æ€§ã€‚
å› ä¸ºåˆ†ç»„å½’å¹¶éå¸¸å¤æ‚ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç»§ç»­é€šè¿‡ä¸€ä¸ªç¤ºä¾‹ç„¶åç»“åˆæºç ï¼Œç»™å¤§å®¶ä»‹ç»åˆ†ç»„å½’å¹¶çš„å®ç°è¿‡ç¨‹ï¼Œå…ˆçœ‹è¿™æ ·ä¸€å¥ SQLï¼š
SELECT task_name, SUM(health_point) FROM health_task GROUP BY task_name ORDER BY task_name;æ˜¾ç„¶ï¼Œä¸Šè¿° SQL çš„åˆ†ç»„é¡¹ä¸æ’åºé¡¹å®Œå…¨ä¸€è‡´ï¼Œéƒ½æ˜¯ç”¨åˆ°äº† task_name åˆ—ï¼Œæ‰€ä»¥å–å¾—çš„æ•°æ®æ˜¯è¿ç»­çš„ã€‚è¿™æ ·ï¼Œåˆ†ç»„æ‰€éœ€çš„æ•°æ®å…¨éƒ¨å­˜åœ¨äºå„ä¸ªæ•°æ®ç»“æœé›†çš„å½“å‰æ¸¸æ ‡æ‰€æŒ‡å‘çš„æ•°æ®å€¼ï¼Œå› æ­¤å¯ä»¥é‡‡ç”¨æµå¼å½’å¹¶ã€‚
å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬åœ¨æ¯ä¸ª health_task ç»“æœé›†ä¸­ï¼Œæ ¹æ® task_name è¿›è¡Œäº†æ’åºï¼š
æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€äº›ä»£ç çš„åˆå§‹åŒ–å·¥ä½œï¼Œå›åˆ° DQLMergeEngineï¼Œæ‰¾åˆ°ç”¨äºåˆ†ç»„å½’å¹¶çš„ getGroupByMergedResult æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
private MergedResult getGroupByMergedResult(final Map&amp;lt;String, Integer&amp;gt; columnLabelIndexMap) throws SQLException {return selectSQLStatementContext.isSameGroupByAndOrderByItems()? new GroupByStreamMergedResult(columnLabelIndexMap, queryResults, selectSQLStatementContext): new GroupByMemoryMergedResult(queryResults, selectSQLStatementContext);}å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸€ä¸ª isSameGroupByAndOrderByItems åˆ¤æ–­ï¼Œè¯¥åˆ¤æ–­å°±æ˜¯ç”¨æ¥æ˜ç¡®åˆ†ç»„æ¡ä»¶å’Œæ’åºæ¡ä»¶æ˜¯å¦ç›¸åŒã€‚æ ¹æ®å‰é¢çš„åˆ†æï¼Œå¦‚æœåˆ†ç»„æ¡ä»¶å’Œæ’åºæ¡ä»¶ç›¸åŒï¼Œåˆ™æ‰§è¡Œæµå¼åˆ†ç»„å½’å¹¶æ–¹å¼ GroupByStreamMergedResultï¼Œå¦åˆ™ä½¿ç”¨å†…å­˜åˆ†ç»„å½’å¹¶ GroupByMemoryMergedResultã€‚
æˆ‘ä»¬ä»¥æµå¼å½’å¹¶ä¸ºä¾‹æ¥ä»‹ç» ShardingSphere ä¸­çš„åˆ†ç»„å½’å¹¶å®ç°æœºåˆ¶ï¼Œåœ¨å¯¹ä»£ç è¿›è¡Œè¯¦ç»†å±•å¼€ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦å…ˆä»æ„Ÿæ€§è®¤è¯†ä¸Šæ˜ç¡®æµå¼åˆ†ç»„å½’å¹¶å…·ä½“è¦æ‰§è¡Œçš„æ­¥éª¤ã€‚è¿™é‡Œä»ç„¶ä½¿ç”¨ä¸€ç³»åˆ—çš„ç¤ºæ„å›¾æ¥è¿›è¡Œè¯´æ˜ã€‚">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="nav-logo">
    <a href="http://yipsen.github.io/">
        
        <span class="nav-title">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æ–‡ç« </a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/shardingsphere%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e7%b2%be%e8%ae%b2/">ShardingSphereæ ¸å¿ƒåŸç†ç²¾è®²</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/00-%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E5%AD%A6%E4%B9%A0%E4%B8%80%E6%AC%BE%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/">00 å¦‚ä½•æ­£ç¡®å­¦ä¹ ä¸€æ¬¾åˆ†åº“åˆ†è¡¨å¼€æºæ¡†æ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/01-%E4%BB%8E%E7%90%86%E8%AE%BA%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%A6%82%E4%BD%95%E8%AE%A9%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%9C%9F%E6%AD%A3%E8%90%BD%E5%9C%B0/">01 ä»ç†è®ºåˆ°å®è·µï¼šå¦‚ä½•è®©åˆ†åº“åˆ†è¡¨çœŸæ­£è½åœ°ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/02-%E9%A1%B6%E7%BA%A7%E9%A1%B9%E7%9B%AEshardingsphere-%E6%98%AF%E4%B8%80%E6%AC%BE%E4%BB%80%E4%B9%88%E6%A0%B7%E7%9A%84-apache-%E5%BC%80%E6%BA%90%E8%BD%AF%E4%BB%B6/">02 é¡¶çº§é¡¹ç›®ï¼šShardingSphere æ˜¯ä¸€æ¬¾ä»€ä¹ˆæ ·çš„ Apache å¼€æºè½¯ä»¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/03-%E8%A7%84%E8%8C%83%E5%85%BC%E5%AE%B9jdbc-%E8%A7%84%E8%8C%83%E4%B8%8E-shardingsphere-%E6%98%AF%E4%BB%80%E4%B9%88%E5%85%B3%E7%B3%BB/">03 è§„èŒƒå…¼å®¹ï¼šJDBC è§„èŒƒä¸ ShardingSphere æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/04-%E5%BA%94%E7%94%A8%E9%9B%86%E6%88%90%E5%9C%A8%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F%E4%B8%AD%E4%BD%BF%E7%94%A8-shardingsphere-%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9C%89%E5%93%AA%E4%BA%9B/">04 åº”ç”¨é›†æˆï¼šåœ¨ä¸šåŠ¡ç³»ç»Ÿä¸­ä½¿ç”¨ ShardingSphere çš„æ–¹å¼æœ‰å“ªäº›ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/05-%E9%85%8D%E7%BD%AE%E9%A9%B1%E5%8A%A8shardingsphere-%E4%B8%AD%E7%9A%84%E9%85%8D%E7%BD%AE%E4%BD%93%E7%B3%BB%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E7%9A%84/">05 é…ç½®é©±åŠ¨ï¼šShardingSphere ä¸­çš„é…ç½®ä½“ç³»æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/09-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E4%B8%8E%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1/">09 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¦‚ä½•ä½¿ç”¨å¼ºä¸€è‡´æ€§äº‹åŠ¡ä¸æŸ”æ€§äº‹åŠ¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/10-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E5%A6%82%E4%BD%95%E7%A1%AE%E4%BF%9D%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AE%89%E5%85%A8%E8%AE%BF%E9%97%AE/">10 æ•°æ®è„±æ•ï¼šå¦‚ä½•ç¡®ä¿æ•æ„Ÿæ•°æ®çš„å®‰å…¨è®¿é—®ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/11-%E7%BC%96%E6%8E%92%E6%B2%BB%E7%90%86%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/">11 ç¼–æ’æ²»ç†ï¼šå¦‚ä½•å®ç°åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„åŠ¨æ€é…ç½®ç®¡ç†ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/12-%E4%BB%8E%E5%BA%94%E7%94%A8%E5%88%B0%E5%8E%9F%E7%90%86%E5%A6%82%E4%BD%95%E9%AB%98%E6%95%88%E9%98%85%E8%AF%BB-shardingsphere-%E6%BA%90%E7%A0%81/">12 ä»åº”ç”¨åˆ°åŸç†ï¼šå¦‚ä½•é«˜æ•ˆé˜…è¯» ShardingSphere æºç ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/13-%E5%BE%AE%E5%86%85%E6%A0%B8%E6%9E%B6%E6%9E%84shardingsphere-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%89%A9%E5%B1%95%E6%80%A7/">13 å¾®å†…æ ¸æ¶æ„ï¼šShardingSphere å¦‚ä½•å®ç°ç³»ç»Ÿçš„æ‰©å±•æ€§ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/14-%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AEshardingsphere-%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AE%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F/">14 åˆ†å¸ƒå¼ä¸»é”®ï¼šShardingSphere ä¸­æœ‰å“ªäº›åˆ†å¸ƒå¼ä¸»é”®å®ç°æ–¹å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/15-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8A/">15 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/16-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8B/">16 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/17-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E5%88%86%E7%89%87%E8%B7%AF%E7%94%B1%E6%A0%B8%E5%BF%83%E7%B1%BB-shardingrouter-%E7%9A%84%E8%BF%90%E4%BD%9C%E6%9C%BA%E5%88%B6/">17 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•ç†è§£åˆ†ç‰‡è·¯ç”±æ ¸å¿ƒç±» ShardingRouter çš„è¿ä½œæœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/18-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E7%9A%84%E5%88%86%E7%89%87%E8%B7%AF%E7%94%B1%E5%92%8C%E5%B9%BF%E6%92%AD%E8%B7%AF%E7%94%B1/">18 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•å®ç°æ•°æ®è®¿é—®çš„åˆ†ç‰‡è·¯ç”±å’Œå¹¿æ’­è·¯ç”±ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/19-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%9C%A8%E8%B7%AF%E7%94%B1%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%9B%86%E6%88%90%E5%A4%9A%E7%A7%8D%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E5%92%8C%E8%B7%AF%E7%94%B1%E7%AE%97%E6%B3%95/">19 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•åœ¨è·¯ç”±è¿‡ç¨‹ä¸­é›†æˆå¤šç§è·¯ç”±ç­–ç•¥å’Œè·¯ç”±ç®—æ³•ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/20-%E6%94%B9%E5%86%99%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84-sql-%E6%94%B9%E5%86%99%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6/">20 æ”¹å†™å¼•æ“ï¼šå¦‚ä½•ç†è§£è£…é¥°å™¨æ¨¡å¼ä¸‹çš„ SQL æ”¹å†™å®ç°æœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/21-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%88%86%E7%89%87%E7%8E%AF%E5%A2%83%E4%B8%8B-sql-%E6%89%A7%E8%A1%8C%E7%9A%84%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E6%8A%BD%E8%B1%A1/">21 æ‰§è¡Œå¼•æ“ï¼šåˆ†ç‰‡ç¯å¢ƒä¸‹ SQL æ‰§è¡Œçš„æ•´ä½“æµç¨‹åº”è¯¥å¦‚ä½•è¿›è¡ŒæŠ½è±¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/22-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E6%8A%8A%E6%8F%A1-shardingsphere-%E4%B8%AD%E7%9A%84-executor-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8A/">22 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/23-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E6%8A%8A%E6%8F%A1-shardingsphere-%E4%B8%AD%E7%9A%84-executor-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8B/">23 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/24-%E5%BD%92%E5%B9%B6%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E6%95%B0%E6%8D%AE%E5%BD%92%E5%B9%B6%E7%9A%84%E7%B1%BB%E5%9E%8B%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%BD%92%E5%B9%B6%E7%AD%96%E7%95%A5%E7%9A%84%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B/">24 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æ•°æ®å½’å¹¶çš„ç±»å‹ä»¥åŠç®€å•å½’å¹¶ç­–ç•¥çš„å®ç°è¿‡ç¨‹ï¼Ÿ</a></li>
                
                
                
                    <li>25 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æµå¼å½’å¹¶å’Œå†…å­˜å½’å¹¶åœ¨å¤æ‚å½’å¹¶åœºæ™¯ä¸‹çš„åº”ç”¨æ–¹å¼ï¼Ÿ</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/26-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%99%AE%E9%80%9A%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%92%8C%E5%88%86%E7%89%87%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%88%86%E5%88%AB%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84/">26 è¯»å†™åˆ†ç¦»ï¼šæ™®é€šä¸»ä»æ¶æ„å’Œåˆ†ç‰‡ä¸»ä»æ¶æ„åˆ†åˆ«æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/27-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3-shardingsphere-%E4%B8%AD%E5%AF%B9%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%8A%BD%E8%B1%A1%E8%BF%87%E7%A8%8B/">27 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¦‚ä½•ç†è§£ ShardingSphere ä¸­å¯¹åˆ†å¸ƒå¼äº‹åŠ¡çš„æŠ½è±¡è¿‡ç¨‹ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/28-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1shardingsphere-%E4%B8%AD%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%E4%B8%8A/">28 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/29-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1shardingsphere-%E4%B8%AD%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%E4%B8%8B/">29 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/30-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E6%94%B9%E5%86%99%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%E4%BD%8E%E4%BE%B5%E5%85%A5%E6%80%A7%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E6%96%B9%E6%A1%88/">30 æ•°æ®è„±æ•ï¼šå¦‚ä½•åŸºäºæ”¹å†™å¼•æ“å®ç°ä½ä¾µå…¥æ€§æ•°æ®è„±æ•æ–¹æ¡ˆï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/31-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E7%9A%84%E5%8A%A8%E6%80%81%E5%8C%96%E7%AE%A1%E7%90%86/">31 é…ç½®ä¸­å¿ƒï¼šå¦‚ä½•åŸºäºé…ç½®ä¸­å¿ƒå®ç°é…ç½®ä¿¡æ¯çš„åŠ¨æ€åŒ–ç®¡ç†ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/32-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BF%E9%97%AE%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6/">32 æ³¨å†Œä¸­å¿ƒï¼šå¦‚ä½•åŸºäºæ³¨å†Œä¸­å¿ƒå®ç°æ•°æ®åº“è®¿é—®ç†”æ–­æœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/33-%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E-hook-%E6%9C%BA%E5%88%B6%E4%BB%A5%E5%8F%8A-opentracing-%E5%8D%8F%E8%AE%AE%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA/">33 é“¾è·¯è·Ÿè¸ªï¼šå¦‚ä½•åŸºäº Hook æœºåˆ¶ä»¥åŠ OpenTracing åè®®å®ç°æ•°æ®è®¿é—®é“¾è·¯è·Ÿè¸ªï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/35-%E7%BB%93%E8%AF%ADshardingsphere-%E6%80%BB%E7%BB%93%E5%8F%8A%E5%B1%95%E6%9C%9B/">35 ç»“è¯­ï¼šShardingSphere æ€»ç»“åŠå±•æœ›</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">25 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æµå¼å½’å¹¶å’Œå†…å­˜å½’å¹¶åœ¨å¤æ‚å½’å¹¶åœºæ™¯ä¸‹çš„åº”ç”¨æ–¹å¼ï¼Ÿ</h1>
        <div class="post-info">
            <div class="post-date"> 
                <span>2021-12-22 01:56:04</span>
            </div>
        </div>
        <div class="post-content">
            <p>æ‰¿æ¥ä¸Šä¸€è¯¾æ—¶çš„å†…å®¹ï¼Œä»Šå¤©æˆ‘ä»¬ç»§ç»­ä»‹ç» ShardingSphere ä¸­å‰©ä½™çš„å½’å¹¶ç­–ç•¥ï¼ŒåŒ…æ‹¬åˆ†ç»„å½’å¹¶ã€èšåˆå½’å¹¶å’Œåˆ†é¡µå½’å¹¶ã€‚</p>
<ul>
<li>å…¶ä¸­<strong>åˆ†ç»„å½’å¹¶</strong>æ˜¯æœ€å¤æ‚çš„ä¸€ç§å½’å¹¶ç±»å‹ï¼›</li>
<li><strong>èšåˆå½’å¹¶</strong>æ˜¯åœ¨åˆ†ç»„å½’å¹¶çš„åŸºç¡€ä¸Šè¿½åŠ çš„å½’å¹¶ï¼›</li>
<li><strong>åˆ†é¡µå½’å¹¶</strong>åˆ™æ˜¯å…¸å‹çš„é€šè¿‡è£…é¥°å™¨æ¨¡å¼å®ç°çš„å½’å¹¶ç±»å‹ã€‚</li>
</ul>
<h3 id="æœ€å¤æ‚çš„å½’å¹¶åˆ†ç»„å½’å¹¶">æœ€å¤æ‚çš„å½’å¹¶ï¼šåˆ†ç»„å½’å¹¶</h3>
<p>åœ¨ ShardingSphere çš„æ‰€æœ‰å½’å¹¶æœºåˆ¶ä¸­ï¼Œåˆ†ç»„å½’å¹¶çš„æƒ…å†µæœ€ä¸ºå¤æ‚ï¼Œå®ƒåŒæ ·å¯ä»¥åˆ†ä¸º<strong>æµå¼åˆ†ç»„å½’å¹¶</strong>å’Œ<strong>å†…å­˜åˆ†ç»„å½’å¹¶</strong>ä¸¤ç§å®ç°æ–¹æ¡ˆã€‚</p>
<p>å…¶ä¸­ï¼Œæµå¼åˆ†ç»„å½’å¹¶è¦æ±‚ SQL çš„æ’åºé¡¹ä¸åˆ†ç»„é¡¹çš„å­—æ®µï¼Œä»¥åŠæ’åºç±»å‹å¿…é¡»ä¿æŒä¸€è‡´ï¼Œå¦åˆ™åªèƒ½é€šè¿‡å†…å­˜å½’å¹¶æ‰èƒ½ä¿è¯å…¶æ•°æ®çš„æ­£ç¡®æ€§ã€‚</p>
<p>å› ä¸ºåˆ†ç»„å½’å¹¶éå¸¸å¤æ‚ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç»§ç»­é€šè¿‡ä¸€ä¸ªç¤ºä¾‹ç„¶åç»“åˆæºç ï¼Œç»™å¤§å®¶ä»‹ç»åˆ†ç»„å½’å¹¶çš„å®ç°è¿‡ç¨‹ï¼Œå…ˆçœ‹è¿™æ ·ä¸€å¥ SQLï¼š</p>
<pre tabindex="0"><code>SELECT task_name, SUM(health_point) FROM health_task GROUP BY task_name ORDER BY task_name;
</code></pre><p>æ˜¾ç„¶ï¼Œä¸Šè¿° SQL çš„åˆ†ç»„é¡¹ä¸æ’åºé¡¹å®Œå…¨ä¸€è‡´ï¼Œéƒ½æ˜¯ç”¨åˆ°äº† task_name åˆ—ï¼Œæ‰€ä»¥å–å¾—çš„æ•°æ®æ˜¯è¿ç»­çš„ã€‚è¿™æ ·ï¼Œåˆ†ç»„æ‰€éœ€çš„æ•°æ®å…¨éƒ¨å­˜åœ¨äºå„ä¸ªæ•°æ®ç»“æœé›†çš„å½“å‰æ¸¸æ ‡æ‰€æŒ‡å‘çš„æ•°æ®å€¼ï¼Œå› æ­¤å¯ä»¥é‡‡ç”¨æµå¼å½’å¹¶ã€‚</p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬åœ¨æ¯ä¸ª health_task ç»“æœé›†ä¸­ï¼Œæ ¹æ® task_name è¿›è¡Œäº†æ’åºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/CgqCHl9V6UOALvzxAAB7G9wGDzY482.png" alt="Drawing 0.png"></p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€äº›ä»£ç çš„åˆå§‹åŒ–å·¥ä½œï¼Œå›åˆ° DQLMergeEngineï¼Œæ‰¾åˆ°ç”¨äºåˆ†ç»„å½’å¹¶çš„ getGroupByMergedResult æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private MergedResult getGroupByMergedResult(final Map&lt;String, Integer&gt; columnLabelIndexMap) throws SQLException {
          return selectSQLStatementContext.isSameGroupByAndOrderByItems()
                ? new GroupByStreamMergedResult(columnLabelIndexMap, queryResults, selectSQLStatementContext)
                : new GroupByMemoryMergedResult(queryResults, selectSQLStatementContext);
}
</code></pre><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸€ä¸ª isSameGroupByAndOrderByItems åˆ¤æ–­ï¼Œè¯¥åˆ¤æ–­å°±æ˜¯ç”¨æ¥æ˜ç¡®åˆ†ç»„æ¡ä»¶å’Œæ’åºæ¡ä»¶æ˜¯å¦ç›¸åŒã€‚æ ¹æ®å‰é¢çš„åˆ†æï¼Œå¦‚æœåˆ†ç»„æ¡ä»¶å’Œæ’åºæ¡ä»¶ç›¸åŒï¼Œåˆ™æ‰§è¡Œæµå¼åˆ†ç»„å½’å¹¶æ–¹å¼ GroupByStreamMergedResultï¼Œå¦åˆ™ä½¿ç”¨å†…å­˜åˆ†ç»„å½’å¹¶ GroupByMemoryMergedResultã€‚</p>
<p>æˆ‘ä»¬ä»¥æµå¼å½’å¹¶ä¸ºä¾‹æ¥ä»‹ç» ShardingSphere ä¸­çš„åˆ†ç»„å½’å¹¶å®ç°æœºåˆ¶ï¼Œåœ¨å¯¹ä»£ç è¿›è¡Œè¯¦ç»†å±•å¼€ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦å…ˆä»æ„Ÿæ€§è®¤è¯†ä¸Šæ˜ç¡®æµå¼åˆ†ç»„å½’å¹¶å…·ä½“è¦æ‰§è¡Œçš„æ­¥éª¤ã€‚è¿™é‡Œä»ç„¶ä½¿ç”¨ä¸€ç³»åˆ—çš„ç¤ºæ„å›¾æ¥è¿›è¡Œè¯´æ˜ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»åœ¨æ¯ä¸ª health_task ç»“æœé›†ä¸­æ ¹æ® task_name è¿›è¡Œäº†æ’åºï¼Œæ‰€ä»¥ health_task0ã€health_task1ã€health_task2 ä¸­çš„â€œtask1â€éƒ½æ’åˆ°äº†æœ€å‰é¢ï¼Œä¹Ÿå°±æ˜¯é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚</p>
<ul>
<li><strong>ç¬¬ä¸€æ¬¡ next è°ƒç”¨</strong></li>
</ul>
<p>è¿™æ ·å½“è¿›è¡Œç¬¬ä¸€æ¬¡ next è°ƒç”¨æ—¶ï¼Œæ’åœ¨é˜Ÿåˆ—é¦–ä½çš„ health_task0 å°†ä¼šè¢«å¼¹å‡ºé˜Ÿåˆ—ï¼Œå¹¶ä¸”å°†åˆ†ç»„å€¼åŒä¸ºâ€œtask1â€å…¶ä»–ç»“æœé›†ä¸­çš„æ•°æ®ä¸€åŒå¼¹å‡ºé˜Ÿåˆ—ã€‚ç„¶åï¼Œåœ¨è·å–äº†æ‰€æœ‰çš„ task_name ä¸ºâ€œtask1â€çš„ health_point ä¹‹åï¼Œæˆ‘ä»¬è¿›è¡Œäº†ç´¯åŠ æ“ä½œã€‚</p>
<p>æ‰€ä»¥åœ¨ç¬¬ä¸€æ¬¡ next è°ƒç”¨ç»“æŸåï¼Œå–å‡ºçš„ç»“æœé›†æ˜¯ <strong>â€œtask1â€</strong> çš„åˆ†æ•°æ€»å’Œï¼Œå³ 46+43+40=129ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/CgqCHl9V6V6AO3mBAAB_3I9Nrm8196.png" alt="Drawing 2.png"></p>
<ul>
<li><strong>ç¬¬äºŒæ¬¡ next è°ƒç”¨</strong></li>
</ul>
<p>ä¸æ­¤åŒæ—¶ï¼Œæ‰€æœ‰æ•°æ®ç»“æœé›†ä¸­çš„æ¸¸æ ‡éƒ½å°†ä¸‹ç§»è‡³â€œtask1â€çš„ä¸‹ä¸€ä¸ªä¸åŒçš„æ•°æ®å€¼ï¼Œå¹¶ä¸”æ ¹æ®æ•°æ®ç»“æœé›†å½“å‰æ¸¸æ ‡æŒ‡å‘çš„å€¼è¿›è¡Œé‡æ’åºã€‚åœ¨ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ç¬¬äºŒä¸ªâ€œtask2â€åŒæ—¶å­˜åœ¨äº health_task0 å’Œ health_task1 ä¸­ï¼Œè¿™æ ·åŒ…å«åå­—ä¸ºâ€œtask2â€çš„ç›¸å…³æ•°æ®ç»“æœé›†åˆ™æ’åœ¨çš„é˜Ÿåˆ—çš„å‰åˆ—ã€‚</p>
<p>å½“å†æ¬¡æ‰§è¡Œ next è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬è·å–äº† <strong>â€œtask2â€</strong> çš„åˆ†æ•°å¹¶è¿›è¡Œäº†ç´¯åŠ ï¼Œå³ 42+50=92ï¼Œå¦‚ä¸‹å›¾ä¸­æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/Ciqc1F9V8tmAFpx-AAB_pY0rk9I059.png" alt="Lark20200907-164326.png"></p>
<p>å¯¹äºæ¥ä¸‹å»çš„ next æ–¹æ³•ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯é‡‡ç”¨ç±»ä¼¼çš„å¤„ç†æœºåˆ¶ï¼Œåˆ†åˆ«æ‰¾åˆ°è¿™ä¸‰ç§ health_task è¡¨ä¸­çš„â€œtask3â€â€œtask4â€â€œtask5â€ç­‰æ•°æ®è®°å½•ï¼Œå¹¶ä¾æ¬¡ç±»æ¨ã€‚</p>
<p>æœ‰äº†å¯¹æµå¼åˆ†ç»„å½’å¹¶çš„æ„Ÿæ€§è®¤è¯†ä¹‹åï¼Œè®©æˆ‘ä»¬å›åˆ°æºä»£ç ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä»£è¡¨ç»“æœçš„ GroupByStreamMergedResultï¼Œæˆ‘ä»¬å‘ç° GroupByStreamMergedResult å®é™…ä¸Šæ˜¯ç»§æ‰¿äº†ä¸Šä¸€è¯¾æ—¶ä¸­ä»‹ç»çš„ç”¨äºæ’åºå½’å¹¶çš„ OrderByStreamMergedResultï¼Œå› æ­¤ä¹Ÿç”¨åˆ°äº†å‰é¢ä»‹ç»çš„ä¼˜å…ˆçº§é˜Ÿåˆ— PriorityQueue å’Œ OrderByValue å¯¹è±¡ã€‚</p>
<p>ä½†è€ƒè™‘åˆ°éœ€è¦ä¿å­˜ä¸€äº›ä¸­é—´å˜é‡ä»¥ç®¡ç†è¿è¡Œæ—¶çŠ¶æ€ï¼ŒGroupByStreamMergedResult ä¸­æ·»åŠ äº†å¦‚ä¸‹æ‰€ç¤ºçš„ä»£è¡¨å½“å‰ç»“æœè®°å½•çš„ currentRow å’Œä»£è¡¨å½“å‰åˆ†ç»„å€¼çš„ currentGroupByValues å˜é‡ï¼š</p>
<pre tabindex="0"><code>private final List&lt;Object&gt; currentRow;
private List&lt;?&gt; currentGroupByValues;
</code></pre><p>ç„¶åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ GroupByStreamMergedResult çš„æ„é€ å‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public GroupByStreamMergedResult(
            final Map&lt;String, Integer&gt; labelAndIndexMap, final List&lt;QueryResult&gt; queryResults, final SelectSQLStatementContext selectSQLStatementContext) throws SQLException {
        super(queryResults, selectSQLStatementContext.getOrderByContext().getItems());

        this.selectSQLStatementContext = selectSQLStatementContext;
        currentRow = new ArrayList&lt;&gt;(labelAndIndexMap.size()); 
        //å¦‚æœä¼˜å…ˆçº§é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå°±å°†é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ çš„åˆ†ç»„å€¼èµ‹å€¼ç»™ currentGroupByValues å˜é‡
        currentGroupByValues = getOrderByValuesQueue().isEmpty()
                ? Collections.emptyList() : new GroupByValue(getCurrentQueryResult(), selectSQLStatementContext.getGroupByContext().getItems()).getGroupValues();
}
</code></pre><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä½¿ç”¨åˆ°äº†ä¸€ä¸ª GroupByValue å¯¹è±¡ç”¨äºä¿å­˜åˆ†ç»„å€¼ï¼Œé¡¾åæ€ä¹‰ï¼Œè¯¥å¯¹è±¡çš„ä½œç”¨å°±æ˜¯ä»ç»“æœé›† QueryResult ä¸­è®¡ç®—æ¯ä¸ªåˆ†ç»„æ¡ä»¶çš„å€¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class GroupByValue {

    private final List&lt;?&gt; groupValues;

    public GroupByValue(final QueryResult queryResult, final Collection&lt;OrderByItem&gt; groupByItems) throws SQLException {
        groupValues = getGroupByValues(queryResult, groupByItems);
    }

    private List&lt;?&gt; getGroupByValues(final QueryResult queryResult, final Collection&lt;OrderByItem&gt; groupByItems) throws SQLException {
        List&lt;Object&gt; result = new ArrayList&lt;&gt;(groupByItems.size());
        for (OrderByItem each : groupByItems) {

             //ä»ç»“æœé›† QueryResult ä¸­è·å¾—æ¯ä¸ªåˆ†ç»„æ¡ä»¶çš„å€¼
            result.add(queryResult.getValue(each.getIndex(), Object.class));
        }
        return result;
    }
}
</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ GroupByStreamMergedResult ä¸­çš„æ ¸å¿ƒæ–¹æ³•ï¼Œå³å¦‚ä¸‹æ‰€ç¤ºçš„ next æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>Override
public boolean next() throws SQLException {
         // æ¸…é™¤å½“å‰ç»“æœè®°å½•
        currentRow.clear();

        if (getOrderByValuesQueue().isEmpty()) {
            return false;
        }
        if (isFirstNext()) {
            super.next();
        }

        //é¡ºåºåˆå¹¶ç›¸åŒåˆ†ç»„æ¡ä»¶çš„è®°å½•
        if (aggregateCurrentGroupByRowAndNext()) {
            // ç”Ÿæˆä¸‹ä¸€æ¡ç»“æœè®°å½•åˆ†ç»„å€¼
            currentGroupByValues = new GroupByValue(getCurrentQueryResult(), selectSQLStatementContext.getGroupByContext().getItems()).getGroupValues();
        }
        return true;
}
</code></pre><p>è¿™é‡Œå‡ºç°äº†ä¸€ä¸ª aggregateCurrentGroupByRowAndNext æ–¹æ³•ï¼Œä»å‘½åä¸Šå¯ä»¥çœ‹å‡ºè¯¥æ–¹æ³•åŒ…å«äº†åˆ†ç»„èšåˆå¤„ç†çš„æ ¸å¿ƒå¤„ç†é€»è¾‘ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¯¥æ–¹æ³•çš„å…·ä½“å®ç°è¿‡ç¨‹ï¼š</p>
<pre tabindex="0"><code>private boolean aggregateCurrentGroupByRowAndNext() throws SQLException {
        boolean result = false;

        //ç”Ÿæˆè®¡ç®—å•å…ƒ
        Map&lt;AggregationProjection, AggregationUnit&gt; aggregationUnitMap = Maps.toMap(
             //é€šè¿‡selectSQLStatementContextè·å–selectè¯­å¥æ‰€æœ‰èšåˆç±»å‹çš„é¡¹
                selectSQLStatementContext.getProjectionsContext().getAggregationProjections(), new Function&lt;AggregationProjection, AggregationUnit&gt;() {

                    @Override
                    //é€šè¿‡å·¥å‚æ–¹æ³•è·å–å…·ä½“çš„èšåˆå•å…ƒ
                    public AggregationUnit apply(final AggregationProjection input) {
                        return AggregationUnitFactory.create(input.getType(), input instanceof AggregationDistinctProjection);
                    }
                });

        //å¾ªç¯é¡ºåºåˆå¹¶ç›¸åŒåˆ†ç»„æ¡ä»¶çš„è®°å½•
        while (currentGroupByValues.equals(new GroupByValue(getCurrentQueryResult(), selectSQLStatementContext.getGroupByContext().getItems()).getGroupValues())) {
        //è®¡ç®—èšåˆå€¼
         aggregate(aggregationUnitMap);

            //ç¼“å­˜å½“å‰è®°å½•åˆ°ç»“æœè®°å½•
            cacheCurrentRow();

            //è·å–ä¸‹ä¸€æ¡è®°å½•ï¼Œè°ƒç”¨çˆ¶ç±»ä¸­çš„nextæ–¹æ³•ä»è€Œä½¿å¾—currentResultSetæŒ‡å‘ä¸‹ä¸€ä¸ªå…ƒç´ 
            result = super.next();

            //å¦‚æœå€¼å·²ç»éå†å®Œæ¯•ï¼Œåˆ™ç»“æŸå¾ªç¯
            if (!result) {
                break;
            }
        }

        //è®¾ç½®å½“å‰è®°å½•çš„èšåˆå­—æ®µç»“æœ
        setAggregationValueToCurrentRow(aggregationUnitMap);

        return result;
}
</code></pre><p>è¿™æ®µä»£ç ä¸æ˜¯å¾ˆé•¿ï¼Œä½†å‡ ä¹æ¯æ®µä»£ç éƒ½å¾ˆé‡è¦ã€‚é¦–å…ˆçœ‹åˆ°è¿™é‡Œé€šè¿‡ AggregationUnitFactory å·¥å‚åˆ›å»ºäº†ä¸€ä¸ªèšåˆå•å…ƒå¯¹è±¡ AggregationUnitï¼Œä»è¿™ä¸ªå·¥å‚æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ° ShardingSphere ç›®å‰æ‰€æ”¯æŒçš„æ‰€æœ‰èšåˆæ“ä½œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public static AggregationUnit create(final AggregationType type, final boolean isDistinct) {
        switch (type) {
            case MAX:
                return new ComparableAggregationUnit(false);
            case MIN:
                return new ComparableAggregationUnit(true);
            case SUM:
                return isDistinct ? new DistinctSumAggregationUnit() : new AccumulationAggregationUnit();
            case COUNT:
                return isDistinct ? new DistinctCountAggregationUnit() : new AccumulationAggregationUnit();
            case AVG:
                return isDistinct ? new DistinctAverageAggregationUnit() : new AverageAggregationUnit();
            default:
                throw new UnsupportedOperationException(type.name());
        }
}
</code></pre><p>æ˜¾ç„¶ï¼ŒShardingSphere æ‰€æ”¯æŒçš„èšåˆæ“ä½œåŒ…æ‹¬ MAXã€MINã€SUMã€COUNT ä»¥åŠ AVG äº”ç§ã€‚å…¶ä¸­çš„ MAX å’Œ MIN èšåˆæŸ¥è¯¢éœ€è¦ä½¿ç”¨ ComparableAggregationUnitï¼ŒSUM å’Œ COUNT éœ€è¦ä½¿ç”¨ AccumulationAggregationUnitï¼Œè€Œ AVG éœ€è¦ä½¿ç”¨ AverageAggregationUnitã€‚</p>
<p>è¿™äº›ç±»éƒ½å®ç°äº† AggregationUnit æ¥å£ï¼Œè¯¥æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>public interface AggregationUnit {

    //åˆå¹¶èšåˆå€¼
    void merge(List&lt;Comparable&lt;?&gt;&gt; values);

    //è¿”å›èšåˆå€¼
    Comparable&lt;?&gt; getResult();
}
</code></pre><p>AggregationUnit æä¾›äº†åˆå¹¶èšåˆå€¼å’Œè·å–èšåˆå€¼è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚é‚£ä¹ˆè¿™ä¸ª AggregationUnit æ˜¯ç”¨æ¥å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿè¿™å°±è¦æ¥çœ‹ä¸€ä¸‹å‰é¢ aggregateCurrentGroupByRowAndNext ä»£ç æµç¨‹ä¸­æ‰€åŒ…å«çš„ aggregate æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œæ³¨æ„è¿™é‡Œçš„ä»£ç åšäº†è£å‰ªï¼Œåªçªå‡ºäº† AggregationUnit çš„ä½œç”¨ã€‚</p>
<pre tabindex="0"><code>private void aggregate(final Map&lt;AggregationProjection, AggregationUnit&gt; aggregationUnitMap) throws SQLException {
        for (Entry&lt;AggregationProjection, AggregationUnit&gt; entry : aggregationUnitMap.entrySet()) {
            â€¦
           //è®¡ç®—èšåˆå€¼
            entry.getValue().merge(values);
        }
}
</code></pre><p>æ˜¾ç„¶ï¼Œä¸Šè¿° aggregate æ–¹æ³•çš„æ ¸å¿ƒå°±æ˜¯è°ƒç”¨ AggregationUnit ä¸­çš„ merge æ–¹æ³•æ¥å®Œæˆèšåˆå€¼çš„è®¡ç®—ã€‚é’ˆå¯¹ä»Šå¤©è¯¾æ—¶ä¸­çš„ç¤ºä¾‹ SQLï¼Œå…·ä½“ç”¨åˆ°çš„ AggregationUnit åº”è¯¥å°±æ˜¯ AccumulationAggregationUnitã€‚AccumulationAggregationUnit ç±»çš„å®ç°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå¯ä»¥æƒ³è±¡å®ƒçš„ merge æ–¹æ³•å°±æ˜¯å°†ä¸€ç³»åˆ—ä¼ å…¥çš„å€¼è¿›è¡Œæ±‚å’Œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class AccumulationAggregationUnit implements AggregationUnit {

    private BigDecimal result;

    @Override
    public void merge(final List&lt;Comparable&lt;?&gt;&gt; values) {
        if (null == values || null == values.get(0)) {
            return;
        }
        if (null == result) {
            result = new BigDecimal(&quot;0&quot;);
        }
        result = result.add(new BigDecimal(values.get(0).toString()));
    }

    @Override
    public Comparable&lt;?&gt; getResult() {
        return result;
    }
}
</code></pre><p>è‡³æ­¤ï¼ŒShardingSphere ä¸­ç”¨äºåˆ†ç»„æµå¼åˆå¹¶çš„ GroupByStreamMergedResult ç±»çš„ä¸»ä½“å†…å®¹å°±ä»‹ç»åˆ°è¿™é‡Œã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬ç»§ç»­æ¥çœ‹ç”±åˆ†ç»„å½’å¹¶å¼•ç”³å‡ºæ¥çš„èšåˆå½’å¹¶ã€‚</p>
<h3 id="è¿½åŠ çš„å½’å¹¶èšåˆå½’å¹¶">è¿½åŠ çš„å½’å¹¶ï¼šèšåˆå½’å¹¶</h3>
<p>äº‹å®ä¸Šï¼Œé€šè¿‡å‰é¢çš„åˆ†æï¼Œæˆ‘ä»¬å·²ç»æ¥è§¦åˆ°äº†èšåˆå½’å¹¶ç›¸å…³çš„å†…å®¹ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯ç«™åœ¨<strong>åˆ†ç»„å½’å¹¶</strong>çš„åŸºç¡€ä¸Šè®¨è®ºèšåˆå½’å¹¶ã€‚åœ¨è¿™ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®èšåˆæ“ä½œæœ¬èº«è·Ÿåˆ†ç»„å¹¶æ²¡æœ‰å…³ç³»ï¼Œå³é™¤äº†åˆ†ç»„çš„ SQL ä¹‹å¤–ï¼Œå¯¹ä¸è¿›è¡Œåˆ†ç»„çš„ SQL ä¹Ÿå¯ä»¥ä½¿ç”¨èšåˆå‡½æ•°ã€‚å¦ä¸€æ–¹é¢ï¼Œæ— è®ºé‡‡ç”¨çš„æ˜¯æµå¼åˆ†ç»„å½’å¹¶è¿˜æ˜¯å†…å­˜åˆ†ç»„å½’å¹¶ï¼Œå¯¹èšåˆå‡½æ•°çš„å¤„ç†éƒ½æ˜¯ä¸€è‡´çš„ã€‚<strong>èšåˆå½’å¹¶</strong>å¯ä»¥ç†è§£ä¸ºæ˜¯åœ¨ä¹‹å‰ä»‹ç»çš„å½’å¹¶æœºåˆ¶ä¹‹ä¸Šè¿½åŠ çš„ä¸€ç§å½’å¹¶èƒ½åŠ›ã€‚</p>
<p>MAXã€MINã€SUMã€COUNTï¼Œä»¥åŠ AVG è¿™ 5 ç§ ShardingSphere æ‰€æ”¯æŒçš„èšåˆå‡½æ•°å¯ä»¥åˆ†æˆä¸‰å¤§ç±»èšåˆçš„åœºæ™¯ï¼ŒMAX å’Œ MIN ç”¨äºæ¯”è¾ƒåœºæ™¯ï¼ŒSUM å’Œ COUNT ç”¨äºç´¯åŠ çš„åœºæ™¯ï¼Œè€Œå‰©ä¸‹çš„ AVG åˆ™ç”¨äºæ±‚å¹³å‡å€¼çš„åœºæ™¯ã€‚</p>
<p>åœ¨ sharding-core-mergeå·¥ç¨‹ä¸­ï¼ŒåŒ…å«äº†å¯¹èšåˆå¼•æ“çš„å®ç°ä»£ç ã€‚æˆ‘ä»¬å·²ç»åœ¨å‰é¢ä»‹ç»èšåˆå½’å¹¶æ—¶ç»™å‡ºäº† AggregationUnit æ¥å£ä»¥åŠç”¨äºè®¡ç®—èšåˆå€¼çš„å®ç°ç±»AccumulationAggregationUnitã€‚å¯¹äºå…¶ä»– AggregationUnit å®ç°ç±»è€Œè¨€ï¼Œæˆ‘ä»¬ä¹Ÿä¸éš¾æƒ³è±¡å…¶å†…éƒ¨çš„å®ç°æ–¹æ³•ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ AverageAggregationUnit ä¸ºä¾‹ï¼Œå®ƒçš„ merge æ–¹æ³•å’Œ getResult æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class AverageAggregationUnit implements AggregationUnit {

    private BigDecimal count;
    private BigDecimal sum;

    @Override
    public void merge(final List&lt;Comparable&lt;?&gt;&gt; values) {
        if (null == values || null == values.get(0) || null == values.get(1)) {
            return;
        }
        if (null == count) {
            count = new BigDecimal(&quot;0&quot;);
        }
        if (null == sum) {
            sum = new BigDecimal(&quot;0&quot;);
        }
        count = count.add(new BigDecimal(values.get(0).toString()));
        sum = sum.add(new BigDecimal(values.get(1).toString()));
    }

    @Override
    public Comparable&lt;?&gt; getResult() {
        if (null == count || BigDecimal.ZERO.equals(count)) {
            return count;
        } 
        return sum.divide(count, 4, BigDecimal.ROUND_HALF_UP);
    }
}
</code></pre><p>ä»¥ä¸Šä»£ç çš„å«ä¹‰éƒ½æ¯”è¾ƒæ˜ç¡®ï¼Œå…¶ä»–èšåˆç±»çš„å®ç°æ–¹å¼ä¹Ÿç±»ä¼¼ï¼Œæˆ‘ä»¬ä¸åšå…·ä½“å±•å¼€ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»§ç»­ä»‹ç»å½’å¹¶å¼•æ“ä¸­æœ€åä¸€ç§å¸¸è§çš„åº”ç”¨åœºæ™¯ï¼Œå³åˆ†é¡µå½’å¹¶ã€‚</p>
<h3 id="éœ€è¦è£…é¥°çš„å½’å¹¶åˆ†é¡µå½’å¹¶">éœ€è¦è£…é¥°çš„å½’å¹¶ï¼šåˆ†é¡µå½’å¹¶</h3>
<p>ä»å®ç°æ–¹å¼ä¸Šè®²ï¼Œåˆ†é¡µå½’å¹¶ä¸å‰é¢ä»‹ç»çš„æ’åºå½’å¹¶å’Œåˆ†ç»„å½’å¹¶æœ‰æ‰€ä¸åŒï¼Œè€Œæ˜¯é‡‡ç”¨äº†ä¸€ç§è£…é¥°å™¨æ¨¡å¼ï¼Œå³åœ¨æ’åºå’Œåˆ†ç»„éƒ½å®Œæˆäº†å½’å¹¶ä¹‹åï¼Œå†å¯¹ç»“æœè¿›è¡Œåˆ†é¡µå¤„ç†ã€‚</p>
<p>åœ¨ DQLMergeEngine ä¸­ï¼Œè£…é¥°å™¨æ–¹æ³• decorate å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>//ä½¿ç”¨è£…é¥°å™¨æ¨¡å¼å¯¹ç»“æœé›†è¿›è¡Œåˆ†é¡µå½’å¹¶
private MergedResult decorate(final MergedResult mergedResult) throws SQLException {
        PaginationContext paginationContext = selectSQLStatementContext.getPaginationContext();
        if (!paginationContext.isHasPagination() || 1 == queryResults.size()) {
            return mergedResult;
        } 
        //æ ¹æ®ä¸åŒçš„æ•°æ®åº“ç±»å‹å¯¹ç›¸åº”çš„åˆ†é¡µç»“æœé›†æ‰§è¡Œå½’å¹¶
        String trunkDatabaseName = DatabaseTypes.getTrunkDatabaseType(databaseType.getName()).getName();
        if (&quot;MySQL&quot;.equals(trunkDatabaseName) || &quot;PostgreSQL&quot;.equals(trunkDatabaseName)) {
            return new LimitDecoratorMergedResult(mergedResult, paginationContext);
        }
        if (&quot;Oracle&quot;.equals(trunkDatabaseName)) {
            return new RowNumberDecoratorMergedResult(mergedResult, paginationContext);
        }
        if (&quot;SQLServer&quot;.equals(trunkDatabaseName)) {
            return new TopAndRowNumberDecoratorMergedResult(mergedResult, paginationContext);
        }
        return mergedResult;
}
</code></pre><p>è¿™é‡Œå…ˆåˆ¤æ–­æ˜¯å¦è¦å¯¹ç»“æœè¿›è¡Œåˆ†é¡µå½’å¹¶ï¼Œå¦‚æœ PaginationContext æ²¡æœ‰åˆ†é¡µéœ€æ±‚æˆ–è€…æŸ¥è¯¢ç»“æœé›†åªæœ‰ä¸€ä¸ªï¼Œåˆ™ä¸éœ€è¦è¿›è¡Œåˆ†é¡µå½’å¹¶ã€‚å¦‚æœéœ€è¦åˆ†é¡µå½’å¹¶ï¼Œåˆ™æ ¹æ®ä¸‰å¤§ç±»ä¸åŒçš„æ•°æ®åº“ç±»å‹æ„å»ºä¸åŒçš„è£…é¥°å™¨å½’å¹¶ç»“æœå¯¹è±¡ DecoratorMergedResultã€‚</p>
<p>DecoratorMergedResult æ˜¯è¿™ä¸‰ä¸ªå…·ä½“åˆ†é¡µå½’å¹¶å®ç°ç±»çš„åŸºç±»ï¼Œåœ¨ DecoratorMergedResult ä¸­çš„å„ä¸ªæ–¹æ³•ï¼Œåªæ˜¯åŸºäºå¦ä¸€ç§ MergedResult åšäº†ä¸€å±‚ä»£ç†ï¼Œä¾‹å¦‚å¦‚ä¸‹æ‰€ç¤ºçš„ getValue æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>private final MergedResult mergedResult;

@Override
public final Object getValue(final int columnIndex, final Class&lt;?&gt; type) throws SQLException {
    return mergedResult.getValue(columnIndex, type);
}
</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹é’ˆå¯¹ MySQL æˆ– PostgreSQL çš„åˆ†é¡µå½’å¹¶ç»“æœ LimitDecoratorMergedResultï¼Œè¯¥ç±»ç»§æ‰¿è‡ª DecoratorMergedResultã€‚æˆ‘ä»¬çŸ¥é“åœ¨ MySQL ä¸­åˆ†é¡µçš„å®ç°æ–¹æ³•å°±æ˜¯æ‰¾åˆ°ç›®æ ‡èµ·å§‹è¡Œï¼Œç„¶åå†é€šè¿‡ LIMIT å…³é”®å­—è®¾ç½®æ‰€éœ€è¦è·å–çš„è¡Œæ•°ï¼Œå…¸å‹çš„åˆ†é¡µ SQL å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>SELECT * FROM user WHERE user_id &gt; 1000 LIMIT 20;
</code></pre><p>å› ä¸ºå‰é¢é€šè¿‡åˆ†ç»„å’Œæ’åºå®é™…ä¸Šå·²ç»è·å–äº†æ‰€éœ€çš„ç»“æœé›†åˆï¼Œå› æ­¤å¯¹äºåˆ†é¡µè€Œè¨€ï¼Œä¸»è¦å·¥ä½œå°±æ˜¯è·å–è¿™ä¸ªç›®å‰èµ·å§‹è¡Œï¼Œæˆ–è€…è¯´åç§»é‡ Offsetã€‚åœ¨ LimitDecoratorMergedResult ä¸­ï¼Œéœ€è¦é€šè¿‡å¦‚ä¸‹æ‰€ç¤ºçš„ skipOffset æ–¹æ³•æ¥è®¡ç®—è¿™ä¸ªåç§»é‡ï¼š</p>
<pre tabindex="0"><code>private boolean skipOffset() throws SQLException {
        for (int i = 0; i &lt; pagination.getActualOffset(); i++) {
            if (!getMergedResult().next()) {
                return true;
            }
        }
        rowNumber = 0;
        return false;
}
</code></pre><p>è¿™é‡Œæ ¹æ® PaginationContext åˆ†é¡µä¸Šä¸‹æ–‡å¯¹è±¡ä¸­çš„ getActualOffset æ–¹æ³•è·å–çœŸå®åç§»é‡ï¼Œç„¶åå¾ªç¯è°ƒç”¨çˆ¶ç±» MergedResult çš„ next æ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿè¾¾åˆ°è¿™ä¸ªç›®æ ‡åç§»é‡ï¼Œå¦‚æœèƒ½å¤Ÿåˆ™è¯´æ˜è¯¥åˆ†é¡µæ“ä½œæ˜¯å¯è¡Œçš„ã€‚</p>
<p>ç„¶åï¼Œæˆ‘ä»¬æ¥çœ‹ LimitDecoratorMergedResult çš„ next æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@Override
public boolean next() throws SQLException {
        if (skipAll) {
            return false;
        }
        if (!pagination.getActualRowCount().isPresent()) {
            return getMergedResult().next();
        }
        return ++rowNumber &lt;= pagination.getActualRowCount().get() &amp;&amp; getMergedResult().next();
}
</code></pre><p>è¿™ä¸ªæ–¹æ³•å®é™…ä¸Šå°±æ˜¯æ‰§è¡Œäº† LIMIT å…³é”®è¯çš„é€»è¾‘ï¼Œå¯¹è·å–çš„ rowNumber å¢åŠ è®¡æ•°ç„¶åä¸ç›®æ ‡è¡Œæ•°è¿›è¡Œæ¯”å¯¹ï¼Œå¹¶æµå¼è¿”å›æ•°æ®ã€‚</p>
<p>è‡³æ­¤ï¼Œå…³äº DQLMergeEngine ä¸­äº”å¤§ç±»å½’å¹¶å¼•æ“çš„ä»‹ç»å°±åˆ°æ­¤ä¸ºæ­¢ã€‚</p>
<h3 id="ä»æºç è§£æåˆ°æ—¥å¸¸å¼€å‘">ä»æºç è§£æåˆ°æ—¥å¸¸å¼€å‘</h3>
<p>åœ¨ä»Šå¤©çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬å†æ¬¡çœ‹åˆ°äº†è£…é¥°å™¨æ¨¡å¼çš„å¼ºå¤§ä½œç”¨ã€‚ç›¸æ¯”è¾ƒæ”¹å†™å¼•æ“ä¸­åŸºäº SQLRewriteContext æ‰€ä½¿ç”¨çš„è£…é¥°å™¨æ¨¡å¼ï¼ŒShardingSphere åœ¨åˆ†é¡µå½’å¹¶ä¸­ä½¿ç”¨è£…é¥°å™¨çš„æ–¹å¼æ›´åŠ ç®€å•ç›´æ¥ã€‚</p>
<p>æˆ‘ä»¬ç›´æ¥åœ¨å‰ä¸€ä¸ª MergedResult ä¸Šè°ƒç”¨ä¸€ä¸ªæ˜¾å¼çš„ decorate æ–¹æ³•æ¥å®Œæˆå¯¹ç»“æœçš„è£…é¥°ã€‚è¿™ç§è£…é¥°å™¨æ¨¡å¼çš„åº”ç”¨æ–¹æ³•çš„å…³é”®ç‚¹åœ¨äºï¼Œæˆ‘ä»¬éœ€è¦è®¾è®¡ä¸€å¥—ç±»ä¼¼ MergedResult çš„å®Œæ•´ç±»å±‚ç»“æ„ï¼Œç¡®ä¿åœ¨è£…é¥°ä¹‹å‰å’Œè£…é¥°ä¹‹åï¼Œå„ä¸ªè£…é¥°ç±»èƒ½å¤Ÿåœ¨åŒä¸€å¥—ä½“ç³»ä¸­è¿›è¡Œä¸æ–­æµè½¬ã€‚</p>
<p>è€Œæ”¹å†™å¼•æ“ä¸­è£…é¥°å™¨çš„ä½¿ç”¨è¦ç‚¹ï¼Œåˆ™æ˜¯æŠŠéœ€è¦è£…é¥°çš„ä¿¡æ¯éƒ½æ”¾åœ¨ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ä¸­ã€‚</p>
<p>åœ¨æ—¥å¸¸å¼€å‘è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸¤ç§è£…é¥°å™¨æ¨¡å¼çš„å®ç°æ–¹æ³•éƒ½å€¼å¾—æˆ‘ä»¬è¿›è¡Œå€Ÿé‰´ã€‚</p>
<h3 id="å°ç»“ä¸é¢„å‘Š">å°ç»“ä¸é¢„å‘Š</h3>
<p>ä»Šå¤©çš„å†…å®¹å›´ç»•ç€ ShardingSphere ä¸­æ¯”è¾ƒå¤æ‚çš„é›†ä¸­å½’å¹¶ç±»å‹å±•å¼€äº†è¯¦ç»†çš„è®¨è®ºã€‚</p>
<p>å…¶ä¸­<strong>åˆ†ç»„å½’å¹¶</strong>æ˜¯æœ€å¤æ‚çš„å½’å¹¶ç±»å‹ï¼Œåœ¨ä»‹ç»åˆ†ç»„å½’å¹¶æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¼•å‡ºäº†èšåˆç›¸å…³çš„æ¦‚å¿µå’Œå®ç°æ–¹æ³•ï¼Œæ‰€ä»¥<strong>èšåˆå½’å¹¶</strong>å¯ä»¥è®¤ä¸ºæ˜¯åœ¨åˆ†ç»„å½’å¹¶ä¸Šè¿½åŠ çš„ä¸€ç§å½’å¹¶ç±»å‹ï¼Œè€Œ<strong>åˆ†é¡µå½’å¹¶</strong>çš„å®ç°éœ€è¦è€ƒè™‘ä¸åŒæ•°æ®åº“ç±»å‹ï¼ŒShardingSphere åœ¨å®ç°åˆ†é¡µå½’å¹¶æ—¶åŒæ ·é‡‡ç”¨äº†è£…é¥°å™¨æ¨¡å¼é€‚é…äº†ä¸åŒæ•°æ®åº“åˆ†é¡µæœºåˆ¶ä¸Šå­˜åœ¨çš„å·®å¼‚æ€§ã€‚</p>
<p>æœ€åè¿™é‡Œç»™ä½ ç•™ä¸€é“æ€è€ƒé¢˜ï¼šShardingSphere å¦‚ä½•ä½¿ç”¨è£…é¥°å“æ¨¡å¼å®Œæˆäº†å¯¹ä¸åŒæ•°æ®åº“çš„åˆ†é¡µå½’å¹¶ç­–ç•¥ï¼Ÿ</p>
<p>åˆ°ä»Šå¤©ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å¯¹ ShardingSphere ä¸­åˆ†ç‰‡å¼•æ“çš„äº”å¤§å¼•æ“çš„å†…å®¹è¿›è¡Œäº†è¯¦ç»†çš„ä»‹ç»ã€‚åœ¨ä¸‹ä¸€è¯¾æ—¶ä¸­ï¼Œæˆ‘ä»¬å°†å…³æ³¨äºä¸»ä»æ¶æ„ä¸‹è¯»å†™åˆ†ç¦»æœºåˆ¶çš„å®ç°åŸç†ã€‚</p>

        </div>
    </article>
</div>
<div class="division-line"></div>
<div class="others">
    <div>æ ‡ç­¾ï¼šğŸ·ï¸<a class="post-tag" href="/tags/sharding/">sharding</a>&nbsp;</div>
    <div>åˆ†ç±»ï¼š ğŸ“’<a class="post-category" href="/categories/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/">ShardingSphereæ ¸å¿ƒåŸç†ç²¾è®²</a>&nbsp; </div>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/24-%E5%BD%92%E5%B9%B6%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E6%95%B0%E6%8D%AE%E5%BD%92%E5%B9%B6%E7%9A%84%E7%B1%BB%E5%9E%8B%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%BD%92%E5%B9%B6%E7%AD%96%E7%95%A5%E7%9A%84%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B/"><span>24 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æ•°æ®å½’å¹¶çš„ç±»å‹ä»¥åŠç®€å•å½’å¹¶ç­–ç•¥çš„å®ç°è¿‡ç¨‹ï¼Ÿ</span></a>
    </div>
    <div class="next">
        
        <a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/26-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%99%AE%E9%80%9A%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%92%8C%E5%88%86%E7%89%87%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%88%86%E5%88%AB%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84/"><span>26 è¯»å†™åˆ†ç¦»ï¼šæ™®é€šä¸»ä»æ¶æ„å’Œåˆ†ç‰‡ä¸»ä»æ¶æ„åˆ†åˆ«æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</span></a>
    </div>
</div>

        </div>
        <div id="float">
            <ul class="float-button-bar">
    <li>
        <button class="float-button top" onclick="scrollToTop(this);">UP</button>
    </li>
    <li>
        <button class="float-button toggler" onclick="changeSkin(this);">DARK</button>
    </li>
</ul>
        </div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 2020 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    const changeSkin = () => {
        document.getElementById('page').classList.toggle('night');
    }
    const scrollToTop = () => {
        window.scrollTo(0, 0);
    }
</script>
</body>

</html>