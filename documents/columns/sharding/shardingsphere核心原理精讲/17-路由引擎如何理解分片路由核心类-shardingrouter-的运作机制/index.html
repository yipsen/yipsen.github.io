<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>17 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•ç†è§£åˆ†ç‰‡è·¯ç”±æ ¸å¿ƒç±» ShardingRouter çš„è¿ä½œæœºåˆ¶ï¼Ÿ | Yipsen Ye</title>
<meta name="description" content="å‰é¢æˆ‘ä»¬èŠ±äº†å‡ ä¸ªè¯¾æ—¶å¯¹ ShardingSphere ä¸­çš„ SQL è§£æå¼•æ“åšäº†ä»‹ç»ï¼Œæˆ‘ä»¬æ˜ç™½ SQL è§£æçš„ä½œç”¨å°±æ˜¯æ ¹æ®è¾“å…¥çš„ SQL è¯­å¥ç”Ÿæˆä¸€ä¸ª SQLStatement å¯¹è±¡ã€‚
ä»ä»Šå¤©å¼€å§‹ï¼Œæˆ‘ä»¬å°†è¿›å…¥ ShardingSphere çš„è·¯ç”±ï¼ˆRoutingï¼‰å¼•æ“éƒ¨åˆ†çš„æºç è§£æã€‚ä»æµç¨‹ä¸Šè®²ï¼Œè·¯ç”±å¼•æ“æ˜¯æ•´ä¸ªåˆ†ç‰‡å¼•æ“æ‰§è¡Œæµç¨‹ä¸­çš„ç¬¬äºŒæ­¥ï¼Œå³åŸºäº SQL è§£æå¼•æ“æ‰€ç”Ÿæˆçš„ SQLStatementï¼Œé€šè¿‡è§£ææ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€æºå¸¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæ¥è·å–åŒ¹é…æ•°æ®åº“å’Œè¡¨çš„åˆ†ç‰‡ç­–ç•¥ï¼Œå¹¶ç”Ÿæˆè·¯ç”±ç»“æœã€‚
åˆ†å±‚ï¼šè·¯ç”±å¼•æ“æ•´ä½“æ¶æ„ ä¸ä»‹ç» SQL è§£æå¼•æ“æ—¶ä¸€æ ·ï¼Œæˆ‘ä»¬é€šè¿‡ç¿»é˜… ShardingSphere æºç ï¼Œé¦–å…ˆæ¢³ç†äº†å¦‚ä¸‹æ‰€ç¤ºçš„åŒ…ç»“æ„ï¼š
ä¸Šè¿°åŒ…å›¾æ€»ç»“äº†ä¸è·¯ç”±æœºåˆ¶ç›¸å…³çš„å„ä¸ªæ ¸å¿ƒç±»ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•´ä½“å‘ˆä¸€ç§å¯¹ç§°ç»“æ„ï¼Œå³æ ¹æ®æ˜¯ PreparedStatement è¿˜æ˜¯æ™®é€š Statement åˆ†æˆä¸¤ä¸ªåˆ†æ”¯æµç¨‹ã€‚
åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠè¿™å¼ å›¾ä¸­çš„ç±»æŒ‰ç…§å…¶æ‰€å±çš„åŒ…ç»“æ„åˆ†æˆä¸¤ä¸ªå±‚æ¬¡ï¼šä½äºåº•å±‚çš„ sharding-core-route å’Œä½äºä¸Šå±‚çš„ sharding-core-entryï¼Œè¿™ä¹Ÿæ˜¯ ShardingSphere ä¸­æ‰€æ™®éé‡‡ç”¨çš„ä¸€ç§åˆ†åŒ…åŸåˆ™ï¼Œå³æ ¹æ®ç±»çš„æ‰€å±å±‚çº§æ¥ç»„ç»‡åŒ…ç»“æ„ã€‚å…³äº ShardingSphere çš„åˆ†åŒ…åŸåˆ™æˆ‘ä»¬åœ¨ [ã€Š12 | ä»åº”ç”¨åˆ°åŸç†ï¼šå¦‚ä½•é«˜æ•ˆé˜…è¯» ShardingSphere æºç ï¼Ÿã€‹]ä¸­ä¹Ÿå·²ç»è¿›è¡Œäº†ä»‹ç»ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å…·ä½“åˆ†æè¿™ä¸€åŸåˆ™åœ¨è·¯ç”±å¼•æ“ä¸­çš„åº”ç”¨ã€‚
1.sharding-core-route å·¥ç¨‹ æˆ‘ä»¬å…ˆæ¥çœ‹å›¾ä¸­çš„ ShardingRouter ç±»ï¼Œè¯¥ç±»æ˜¯æ•´ä¸ªè·¯ç”±æµç¨‹çš„å¯åŠ¨ç‚¹ã€‚ShardingRouter ç±»ç›´æ¥ä¾èµ–äºè§£æå¼•æ“ SQLParseEngine ç±»å®Œæˆ SQL è§£æå¹¶è·å– SQLStatement å¯¹è±¡ï¼Œç„¶åä¾› PreparedStatementRoutingEngine å’Œ StatementRoutingEngine è¿›è¡Œä½¿ç”¨ã€‚æ³¨æ„åˆ°è¿™å‡ ä¸ªç±»éƒ½ä½äº sharding-core-route å·¥ç¨‹ä¸­ï¼Œå¤„äºåº•å±‚ç»„ä»¶ã€‚
2.sharding-core-entry å·¥ç¨‹ å¦ä¸€æ–¹é¢ï¼Œä¸Šå›¾ä¸­çš„ PreparedQueryShardingEngine å’Œ SimpleQueryShardingEngine åˆ™ä½äº sharding-core-entry å·¥ç¨‹ä¸­ã€‚ä»åŒ…çš„å‘½åä¸Šçœ‹ï¼Œentry ç›¸å½“äºæ˜¯è®¿é—®çš„å…¥å£ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ¤æ–­è¿™ä¸ªå·¥ç¨‹ä¸­æ‰€æä¾›çš„ç±»å±äºé¢å‘åº”ç”¨å±‚ç»„ä»¶ï¼Œå¤„äºæ›´åŠ ä¸Šå±‚çš„ä½ç½®ã€‚PreparedQueryShardingEngine å’Œ SimpleQueryShardingEngine çš„ä½¿ç”¨è€…åˆ†åˆ«æ˜¯ ShardingPreparedStatement å’Œ ShardingStatementã€‚è¿™ä¸¤ä¸ªç±»å†å¾€ä¸Šå°±æ˜¯ ShardingConnection ä»¥åŠ ShardingDataSource è¿™äº›ç›´æ¥é¢å‘åº”ç”¨å±‚çš„ç±»äº†ã€‚">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/shardingsphere%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e7%b2%be%e8%ae%b2/">ShardingSphereæ ¸å¿ƒåŸç†ç²¾è®²</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/00-%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E5%AD%A6%E4%B9%A0%E4%B8%80%E6%AC%BE%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/">00 å¦‚ä½•æ­£ç¡®å­¦ä¹ ä¸€æ¬¾åˆ†åº“åˆ†è¡¨å¼€æºæ¡†æ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/01-%E4%BB%8E%E7%90%86%E8%AE%BA%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%A6%82%E4%BD%95%E8%AE%A9%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%9C%9F%E6%AD%A3%E8%90%BD%E5%9C%B0/">01 ä»ç†è®ºåˆ°å®è·µï¼šå¦‚ä½•è®©åˆ†åº“åˆ†è¡¨çœŸæ­£è½åœ°ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/02-%E9%A1%B6%E7%BA%A7%E9%A1%B9%E7%9B%AEshardingsphere-%E6%98%AF%E4%B8%80%E6%AC%BE%E4%BB%80%E4%B9%88%E6%A0%B7%E7%9A%84-apache-%E5%BC%80%E6%BA%90%E8%BD%AF%E4%BB%B6/">02 é¡¶çº§é¡¹ç›®ï¼šShardingSphere æ˜¯ä¸€æ¬¾ä»€ä¹ˆæ ·çš„ Apache å¼€æºè½¯ä»¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/03-%E8%A7%84%E8%8C%83%E5%85%BC%E5%AE%B9jdbc-%E8%A7%84%E8%8C%83%E4%B8%8E-shardingsphere-%E6%98%AF%E4%BB%80%E4%B9%88%E5%85%B3%E7%B3%BB/">03 è§„èŒƒå…¼å®¹ï¼šJDBC è§„èŒƒä¸ ShardingSphere æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/04-%E5%BA%94%E7%94%A8%E9%9B%86%E6%88%90%E5%9C%A8%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F%E4%B8%AD%E4%BD%BF%E7%94%A8-shardingsphere-%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9C%89%E5%93%AA%E4%BA%9B/">04 åº”ç”¨é›†æˆï¼šåœ¨ä¸šåŠ¡ç³»ç»Ÿä¸­ä½¿ç”¨ ShardingSphere çš„æ–¹å¼æœ‰å“ªäº›ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/05-%E9%85%8D%E7%BD%AE%E9%A9%B1%E5%8A%A8shardingsphere-%E4%B8%AD%E7%9A%84%E9%85%8D%E7%BD%AE%E4%BD%93%E7%B3%BB%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E7%9A%84/">05 é…ç½®é©±åŠ¨ï¼šShardingSphere ä¸­çš„é…ç½®ä½“ç³»æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/09-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E4%B8%8E%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1/">09 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¦‚ä½•ä½¿ç”¨å¼ºä¸€è‡´æ€§äº‹åŠ¡ä¸æŸ”æ€§äº‹åŠ¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/10-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E5%A6%82%E4%BD%95%E7%A1%AE%E4%BF%9D%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AE%89%E5%85%A8%E8%AE%BF%E9%97%AE/">10 æ•°æ®è„±æ•ï¼šå¦‚ä½•ç¡®ä¿æ•æ„Ÿæ•°æ®çš„å®‰å…¨è®¿é—®ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/11-%E7%BC%96%E6%8E%92%E6%B2%BB%E7%90%86%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/">11 ç¼–æ’æ²»ç†ï¼šå¦‚ä½•å®ç°åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„åŠ¨æ€é…ç½®ç®¡ç†ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/12-%E4%BB%8E%E5%BA%94%E7%94%A8%E5%88%B0%E5%8E%9F%E7%90%86%E5%A6%82%E4%BD%95%E9%AB%98%E6%95%88%E9%98%85%E8%AF%BB-shardingsphere-%E6%BA%90%E7%A0%81/">12 ä»åº”ç”¨åˆ°åŸç†ï¼šå¦‚ä½•é«˜æ•ˆé˜…è¯» ShardingSphere æºç ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/13-%E5%BE%AE%E5%86%85%E6%A0%B8%E6%9E%B6%E6%9E%84shardingsphere-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%89%A9%E5%B1%95%E6%80%A7/">13 å¾®å†…æ ¸æ¶æ„ï¼šShardingSphere å¦‚ä½•å®ç°ç³»ç»Ÿçš„æ‰©å±•æ€§ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/14-%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AEshardingsphere-%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AE%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F/">14 åˆ†å¸ƒå¼ä¸»é”®ï¼šShardingSphere ä¸­æœ‰å“ªäº›åˆ†å¸ƒå¼ä¸»é”®å®ç°æ–¹å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/15-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8A/">15 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/16-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8B/">16 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li>17 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•ç†è§£åˆ†ç‰‡è·¯ç”±æ ¸å¿ƒç±» ShardingRouter çš„è¿ä½œæœºåˆ¶ï¼Ÿ</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/18-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E7%9A%84%E5%88%86%E7%89%87%E8%B7%AF%E7%94%B1%E5%92%8C%E5%B9%BF%E6%92%AD%E8%B7%AF%E7%94%B1/">18 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•å®ç°æ•°æ®è®¿é—®çš„åˆ†ç‰‡è·¯ç”±å’Œå¹¿æ’­è·¯ç”±ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/19-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%9C%A8%E8%B7%AF%E7%94%B1%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%9B%86%E6%88%90%E5%A4%9A%E7%A7%8D%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E5%92%8C%E8%B7%AF%E7%94%B1%E7%AE%97%E6%B3%95/">19 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•åœ¨è·¯ç”±è¿‡ç¨‹ä¸­é›†æˆå¤šç§è·¯ç”±ç­–ç•¥å’Œè·¯ç”±ç®—æ³•ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/20-%E6%94%B9%E5%86%99%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84-sql-%E6%94%B9%E5%86%99%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6/">20 æ”¹å†™å¼•æ“ï¼šå¦‚ä½•ç†è§£è£…é¥°å™¨æ¨¡å¼ä¸‹çš„ SQL æ”¹å†™å®ç°æœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/21-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%88%86%E7%89%87%E7%8E%AF%E5%A2%83%E4%B8%8B-sql-%E6%89%A7%E8%A1%8C%E7%9A%84%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E6%8A%BD%E8%B1%A1/">21 æ‰§è¡Œå¼•æ“ï¼šåˆ†ç‰‡ç¯å¢ƒä¸‹ SQL æ‰§è¡Œçš„æ•´ä½“æµç¨‹åº”è¯¥å¦‚ä½•è¿›è¡ŒæŠ½è±¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/22-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E6%8A%8A%E6%8F%A1-shardingsphere-%E4%B8%AD%E7%9A%84-executor-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8A/">22 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/23-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E6%8A%8A%E6%8F%A1-shardingsphere-%E4%B8%AD%E7%9A%84-executor-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8B/">23 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/24-%E5%BD%92%E5%B9%B6%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E6%95%B0%E6%8D%AE%E5%BD%92%E5%B9%B6%E7%9A%84%E7%B1%BB%E5%9E%8B%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%BD%92%E5%B9%B6%E7%AD%96%E7%95%A5%E7%9A%84%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B/">24 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æ•°æ®å½’å¹¶çš„ç±»å‹ä»¥åŠç®€å•å½’å¹¶ç­–ç•¥çš„å®ç°è¿‡ç¨‹ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/25-%E5%BD%92%E5%B9%B6%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E6%B5%81%E5%BC%8F%E5%BD%92%E5%B9%B6%E5%92%8C%E5%86%85%E5%AD%98%E5%BD%92%E5%B9%B6%E5%9C%A8%E5%A4%8D%E6%9D%82%E5%BD%92%E5%B9%B6%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84%E5%BA%94%E7%94%A8%E6%96%B9%E5%BC%8F/">25 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æµå¼å½’å¹¶å’Œå†…å­˜å½’å¹¶åœ¨å¤æ‚å½’å¹¶åœºæ™¯ä¸‹çš„åº”ç”¨æ–¹å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/26-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%99%AE%E9%80%9A%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%92%8C%E5%88%86%E7%89%87%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%88%86%E5%88%AB%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84/">26 è¯»å†™åˆ†ç¦»ï¼šæ™®é€šä¸»ä»æ¶æ„å’Œåˆ†ç‰‡ä¸»ä»æ¶æ„åˆ†åˆ«æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/27-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3-shardingsphere-%E4%B8%AD%E5%AF%B9%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%8A%BD%E8%B1%A1%E8%BF%87%E7%A8%8B/">27 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¦‚ä½•ç†è§£ ShardingSphere ä¸­å¯¹åˆ†å¸ƒå¼äº‹åŠ¡çš„æŠ½è±¡è¿‡ç¨‹ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/28-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1shardingsphere-%E4%B8%AD%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%E4%B8%8A/">28 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/29-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1shardingsphere-%E4%B8%AD%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%E4%B8%8B/">29 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/30-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E6%94%B9%E5%86%99%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%E4%BD%8E%E4%BE%B5%E5%85%A5%E6%80%A7%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E6%96%B9%E6%A1%88/">30 æ•°æ®è„±æ•ï¼šå¦‚ä½•åŸºäºæ”¹å†™å¼•æ“å®ç°ä½ä¾µå…¥æ€§æ•°æ®è„±æ•æ–¹æ¡ˆï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/31-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E7%9A%84%E5%8A%A8%E6%80%81%E5%8C%96%E7%AE%A1%E7%90%86/">31 é…ç½®ä¸­å¿ƒï¼šå¦‚ä½•åŸºäºé…ç½®ä¸­å¿ƒå®ç°é…ç½®ä¿¡æ¯çš„åŠ¨æ€åŒ–ç®¡ç†ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/32-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BF%E9%97%AE%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6/">32 æ³¨å†Œä¸­å¿ƒï¼šå¦‚ä½•åŸºäºæ³¨å†Œä¸­å¿ƒå®ç°æ•°æ®åº“è®¿é—®ç†”æ–­æœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/33-%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E-hook-%E6%9C%BA%E5%88%B6%E4%BB%A5%E5%8F%8A-opentracing-%E5%8D%8F%E8%AE%AE%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA/">33 é“¾è·¯è·Ÿè¸ªï¼šå¦‚ä½•åŸºäº Hook æœºåˆ¶ä»¥åŠ OpenTracing åè®®å®ç°æ•°æ®è®¿é—®é“¾è·¯è·Ÿè¸ªï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/35-%E7%BB%93%E8%AF%ADshardingsphere-%E6%80%BB%E7%BB%93%E5%8F%8A%E5%B1%95%E6%9C%9B/">35 ç»“è¯­ï¼šShardingSphere æ€»ç»“åŠå±•æœ›</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">17 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•ç†è§£åˆ†ç‰‡è·¯ç”±æ ¸å¿ƒç±» ShardingRouter çš„è¿ä½œæœºåˆ¶ï¼Ÿ</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2021-12-22 01:55:56</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/sharding/">sharding</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/">ShardingSphereæ ¸å¿ƒåŸç†ç²¾è®²</a>
                
            </div></div>
        <div class="post-content">
            <p>å‰é¢æˆ‘ä»¬èŠ±äº†å‡ ä¸ªè¯¾æ—¶å¯¹ ShardingSphere ä¸­çš„ SQL è§£æå¼•æ“åšäº†ä»‹ç»ï¼Œæˆ‘ä»¬æ˜ç™½ SQL è§£æçš„ä½œç”¨å°±æ˜¯æ ¹æ®è¾“å…¥çš„ SQL è¯­å¥ç”Ÿæˆä¸€ä¸ª SQLStatement å¯¹è±¡ã€‚</p>
<p>ä»ä»Šå¤©å¼€å§‹ï¼Œæˆ‘ä»¬å°†è¿›å…¥ <strong>ShardingSphere çš„è·¯ç”±ï¼ˆRoutingï¼‰å¼•æ“éƒ¨åˆ†çš„æºç è§£æ</strong>ã€‚ä»æµç¨‹ä¸Šè®²ï¼Œ<strong>è·¯ç”±å¼•æ“</strong>æ˜¯æ•´ä¸ªåˆ†ç‰‡å¼•æ“æ‰§è¡Œæµç¨‹ä¸­çš„ç¬¬äºŒæ­¥ï¼Œå³åŸºäº SQL è§£æå¼•æ“æ‰€ç”Ÿæˆçš„ SQLStatementï¼Œé€šè¿‡è§£ææ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€æºå¸¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæ¥è·å–åŒ¹é…æ•°æ®åº“å’Œè¡¨çš„åˆ†ç‰‡ç­–ç•¥ï¼Œå¹¶ç”Ÿæˆè·¯ç”±ç»“æœã€‚</p>
<h3 id="åˆ†å±‚è·¯ç”±å¼•æ“æ•´ä½“æ¶æ„">åˆ†å±‚ï¼šè·¯ç”±å¼•æ“æ•´ä½“æ¶æ„</h3>
<p>ä¸ä»‹ç» SQL è§£æå¼•æ“æ—¶ä¸€æ ·ï¼Œæˆ‘ä»¬é€šè¿‡ç¿»é˜… ShardingSphere æºç ï¼Œé¦–å…ˆæ¢³ç†äº†å¦‚ä¸‹æ‰€ç¤ºçš„åŒ…ç»“æ„ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/CgqCHl8xJpiAQ0onAACcyggRCJ4878.png" alt="Drawing 0.png"></p>
<p>ä¸Šè¿°åŒ…å›¾æ€»ç»“äº†ä¸è·¯ç”±æœºåˆ¶ç›¸å…³çš„å„ä¸ªæ ¸å¿ƒç±»ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•´ä½“å‘ˆä¸€ç§å¯¹ç§°ç»“æ„ï¼Œå³æ ¹æ®æ˜¯ <strong>PreparedStatement</strong> è¿˜æ˜¯<strong>æ™®é€š Statement</strong> åˆ†æˆä¸¤ä¸ªåˆ†æ”¯æµç¨‹ã€‚</p>
<p>åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠè¿™å¼ å›¾ä¸­çš„ç±»æŒ‰ç…§å…¶æ‰€å±çš„åŒ…ç»“æ„<strong>åˆ†æˆä¸¤ä¸ªå±‚æ¬¡</strong>ï¼šä½äºåº•å±‚çš„ sharding-core-route å’Œä½äºä¸Šå±‚çš„ sharding-core-entryï¼Œè¿™ä¹Ÿæ˜¯ ShardingSphere ä¸­æ‰€æ™®éé‡‡ç”¨çš„ä¸€ç§åˆ†åŒ…åŸåˆ™ï¼Œå³<strong>æ ¹æ®ç±»çš„æ‰€å±å±‚çº§æ¥ç»„ç»‡åŒ…ç»“æ„</strong>ã€‚å…³äº ShardingSphere çš„åˆ†åŒ…åŸåˆ™æˆ‘ä»¬åœ¨ [ã€Š12 | ä»åº”ç”¨åˆ°åŸç†ï¼šå¦‚ä½•é«˜æ•ˆé˜…è¯» ShardingSphere æºç ï¼Ÿã€‹]ä¸­ä¹Ÿå·²ç»è¿›è¡Œäº†ä»‹ç»ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å…·ä½“åˆ†æè¿™ä¸€åŸåˆ™åœ¨è·¯ç”±å¼•æ“ä¸­çš„åº”ç”¨ã€‚</p>
<h4 id="1sharding-core-route-å·¥ç¨‹">1.sharding-core-route å·¥ç¨‹</h4>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹å›¾ä¸­çš„ ShardingRouter ç±»ï¼Œè¯¥ç±»æ˜¯æ•´ä¸ªè·¯ç”±æµç¨‹çš„å¯åŠ¨ç‚¹ã€‚ShardingRouter ç±»ç›´æ¥ä¾èµ–äºè§£æå¼•æ“ SQLParseEngine ç±»å®Œæˆ SQL è§£æå¹¶è·å– SQLStatement å¯¹è±¡ï¼Œç„¶åä¾› PreparedStatementRoutingEngine å’Œ StatementRoutingEngine è¿›è¡Œä½¿ç”¨ã€‚æ³¨æ„åˆ°è¿™å‡ ä¸ªç±»éƒ½ä½äº sharding-core-route å·¥ç¨‹ä¸­ï¼Œ<strong>å¤„äºåº•å±‚ç»„ä»¶</strong>ã€‚</p>
<h4 id="2sharding-core-entry-å·¥ç¨‹">2.sharding-core-entry å·¥ç¨‹</h4>
<p>å¦ä¸€æ–¹é¢ï¼Œä¸Šå›¾ä¸­çš„ PreparedQueryShardingEngine å’Œ SimpleQueryShardingEngine åˆ™ä½äº sharding-core-entry å·¥ç¨‹ä¸­ã€‚ä»åŒ…çš„å‘½åä¸Šçœ‹ï¼Œentry ç›¸å½“äºæ˜¯è®¿é—®çš„å…¥å£ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ¤æ–­è¿™ä¸ªå·¥ç¨‹ä¸­æ‰€æä¾›çš„ç±»<strong>å±äºé¢å‘åº”ç”¨å±‚ç»„ä»¶</strong>ï¼Œå¤„äºæ›´åŠ ä¸Šå±‚çš„ä½ç½®ã€‚PreparedQueryShardingEngine å’Œ SimpleQueryShardingEngine çš„ä½¿ç”¨è€…åˆ†åˆ«æ˜¯ ShardingPreparedStatement å’Œ ShardingStatementã€‚è¿™ä¸¤ä¸ªç±»å†å¾€ä¸Šå°±æ˜¯ ShardingConnection ä»¥åŠ ShardingDataSource è¿™äº›ç›´æ¥é¢å‘åº”ç”¨å±‚çš„ç±»äº†ã€‚</p>
<h3 id="è·¯ç”±æ ¸å¿ƒç±»shardingrouter">è·¯ç”±æ ¸å¿ƒç±»ï¼šShardingRouter</h3>
<p>é€šè¿‡ä»¥ä¸Šåˆ†æï¼Œæˆ‘ä»¬å¯¹è·¯ç”±å¼•æ“çš„æ•´ä½“ç»“æ„æœ‰äº†ä¸€ä¸ªåˆæ­¥çš„è®¤è¯†ã€‚å¯¹äºé‡‡ç”¨åˆ†å±‚ç»“æ„çš„æ‰§è¡Œæµç¨‹è€Œè¨€ï¼Œæœ‰ä¸¤ç§è§£ææ€è·¯ï¼Œå³è‡ªä¸Šè€Œä¸‹æˆ–è‡ªä¸‹è€Œä¸Šã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬çš„æ€è·¯æ˜¯<strong>ä»åº•å±‚å‡ºå‘é€å±‚å¾€ä¸Š</strong>åˆ†ææµç¨‹çš„é“¾è·¯ï¼Œå…ˆæ¥çœ‹è·¯ç”±å¼•æ“ä¸­æœ€åº•å±‚çš„å¯¹è±¡ ShardingRouterï¼Œå˜é‡å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>private final ShardingRule shardingRule; 
private final ShardingSphereMetaData metaData; 
private final SQLParseEngine parseEngine;
</code></pre><p>åœ¨ ShardingRouter ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹åˆ°äº†ç†Ÿæ‚‰çš„ SQL è§£æå¼•æ“ SQLParseEngine ä»¥åŠå®ƒçš„ä½¿ç”¨æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>public SQLStatement parse(final String logicSQL, final boolean useCache) { 
        return parseEngine.parse(logicSQL, useCache); 
}
</code></pre><p>ä¸Šè¿°ä»£ç éå¸¸ç®€å•ï¼Œå³é€šè¿‡ SQLParseEngine å¯¹ä¼ å…¥çš„ SQL è¿›è¡Œè§£æè¿”å›ä¸€ä¸ª SQLStatement å¯¹è±¡ã€‚è¿™é‡Œå°† SQL å‘½åä¸º logicSQLï¼Œä»¥ä¾¿åŒºåˆ«åœ¨åˆ†ç‰‡å’Œè¯»å†™åˆ†ç¦»æƒ…å†µä¸‹çš„çœŸå® SQLã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ ShardingRuleï¼Œè¯·æ³¨æ„è¿™æ˜¯ä¸€ä¸ªåŸºç¡€ç±»ï¼Œä»£è¡¨ç€åˆ†ç‰‡çš„å„ç§è§„åˆ™ä¿¡æ¯ã€‚ShardingRule ç±»ä½äº sharding-core-common å·¥ç¨‹ä¸­ï¼Œä¸»è¦ä¿å­˜ç€ä¸åˆ†ç‰‡ç›¸å…³çš„å„ç§è§„åˆ™ä¿¡æ¯ï¼Œä»¥åŠ ShardingKeyGenerator ç­‰åˆ†å¸ƒå¼ä¸»é”®çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå„ä¸ªå˜é‡å®šä¹‰ä»¥åŠå¯¹åº”çš„æ³¨é‡Šå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>//åˆ†ç‰‡è§„åˆ™é…ç½®ç±»ï¼Œå°è£…å„ç§é…ç½®é¡¹ä¿¡æ¯ 
private final ShardingRuleConfiguration ruleConfiguration; 
//DataSource åç§°åˆ—è¡¨ 
private final ShardingDataSourceNames shardingDataSourceNames; 
//é’ˆå¯¹è¡¨çš„è§„åˆ™åˆ—è¡¨ 
private final Collection&lt;TableRule&gt; tableRules; 
//é’ˆå¯¹ç»‘å®šè¡¨çš„è§„åˆ™åˆ—è¡¨ 
private final Collection&lt;BindingTableRule&gt; bindingTableRules; 
//å¹¿æ’­è¡¨åç§°åˆ—è¡¨ 
private final Collection&lt;String&gt; broadcastTables; 
//é»˜è®¤çš„æ•°æ®åº“åˆ†ç‰‡ç­–ç•¥ 
private final ShardingStrategy defaultDatabaseShardingStrategy; 
//é»˜è®¤çš„æ•°æ®è¡¨åˆ†ç‰‡ç­–ç•¥ 
private final ShardingStrategy defaultTableShardingStrategy; 
//é»˜è®¤çš„åˆ†ç‰‡é”®ç”Ÿæˆå™¨ 
private final ShardingKeyGenerator defaultShardingKeyGenerator; 
//é’ˆå¯¹è¯»å†™åˆ†ç¦»çš„è§„åˆ™åˆ—è¡¨ 
private final Collection&lt;MasterSlaveRule&gt; masterSlaveRules; 
//åŠ å¯†è§„åˆ™ 
private final EncryptRule encryptRule;
</code></pre><p>ShardingRule çš„å†…å®¹éå¸¸ä¸°å¯Œï¼Œä½†å…¶å®šä½æ›´å¤šæ˜¯æä¾›è§„åˆ™ä¿¡æ¯ï¼Œè€Œä¸å±äºæ ¸å¿ƒæµç¨‹ï¼Œå› æ­¤æˆ‘ä»¬å…ˆä¸å¯¹å…¶åšè¯¦ç»†å±•å¼€ã€‚ä½œä¸ºåŸºç¡€è§„åˆ™ç±»ï¼ŒShardingRule ä¼šè´¯ç©¿æ•´ä¸ªåˆ†ç‰‡æµç¨‹ï¼Œåœ¨åç»­è®²è§£è¿‡ç¨‹ä¸­æˆ‘ä»¬ä¼šç©¿æ’å¯¹å®ƒçš„ä»‹ç»ï¼Œè¿™é‡Œå…ˆå¯¹ä¸Šè¿°å˜é‡çš„åç§°å’Œå«ä¹‰æœ‰ç®€å•è®¤è¯†å³å¯ã€‚</p>
<p>æˆ‘ä»¬å›åˆ° ShardingRouter ç±»ï¼Œå‘ç°å…¶æ ¸å¿ƒæ–¹æ³•åªæœ‰ä¸€ä¸ªï¼Œå³ route æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•çš„é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬æ¢³ç†å®ƒçš„æ‰§è¡Œæ­¥éª¤ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/CgqCHl8xJyqAHmcfAACVSxCxm4s053.png" alt="image"></p>
<p>ShardingRouter æ˜¯è·¯ç”±å¼•æ“çš„æ ¸å¿ƒç±»ï¼Œ<strong>åœ¨æ¥ä¸‹æ¥çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬å°†å¯¹ä¸Šå›¾ä¸­çš„ 6 ä¸ªæ­¥éª¤åˆ†åˆ«ä¸€ ä¸€ è¯¦ç»†å±•å¼€ï¼Œå¸®å¿™ä½ ç†è§£ä¸€ä¸ªè·¯ç”±å¼•æ“çš„è®¾è®¡æ€æƒ³å’Œå®ç°æœºåˆ¶ã€‚</strong></p>
<h4 id="1åˆ†ç‰‡åˆç†æ€§éªŒè¯">1.åˆ†ç‰‡åˆç†æ€§éªŒè¯</h4>
<p>æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ ShardingRouter çš„ç¬¬ä¸€ä¸ªæ­¥éª¤ï¼Œå³éªŒè¯åˆ†ç‰‡ä¿¡æ¯çš„åˆç†æ€§ï¼ŒéªŒè¯æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>//ä½¿ç”¨ShardingStatementValidatorå¯¹Statementè¿›è¡ŒéªŒè¯ 
Optional&lt;ShardingStatementValidator&gt; shardingStatementValidator = ShardingStatementValidatorFactory.newInstance(sqlStatement); 
if (shardingStatementValidator.isPresent()) { 
     shardingStatementValidator.get().validate(shardingRule, sqlStatement, parameters); 
}
</code></pre><p>è¿™æ®µä»£ç ä½¿ç”¨ ShardingStatementValidator å¯¹è¾“å…¥çš„ SQLStatement è¿›è¡ŒéªŒè¯ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œç”¨åˆ°äº†å…¸å‹çš„å·¥å‚æ¨¡å¼ï¼Œå·¥å‚ç±» ShardingStatementValidatorFactory å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class ShardingStatementValidatorFactory { 

    public static Optional&lt;ShardingStatementValidator&gt; newInstance(final SQLStatement sqlStatement) { 
        if (sqlStatement instanceof InsertStatement) { 
            return Optional.&lt;ShardingStatementValidator&gt;of(new ShardingInsertStatementValidator()); 
        } 
        if (sqlStatement instanceof UpdateStatement) { 
            return Optional.&lt;ShardingStatementValidator&gt;of(new ShardingUpdateStatementValidator()); 
        } 
        return Optional.absent(); 
    } 
}
</code></pre><p>æ³¨æ„åˆ° ShardingStatementValidator è¦éªŒè¯çš„åªæœ‰ InsertStatement å’Œ UpdateStatement è¿™ä¸¤ä¸ª SQLStatementã€‚é‚£ä¹ˆå¦‚ä½•è¿›è¡ŒéªŒè¯å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ ShardingStatementValidator çš„å®šä¹‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public interface ShardingStatementValidator&lt;T extends SQLStatement&gt; { 

    //éªŒè¯åˆ†ç‰‡æ“ä½œæ˜¯å¦æ”¯æŒ 
    void validate(ShardingRule shardingRule, T sqlStatement, List&lt;Object&gt; parameters); 
}
</code></pre><p>å¯¹äºéªŒè¯è¿‡ç¨‹è€Œè¨€ï¼Œæ ¸å¿ƒæ€æƒ³åœ¨äºæ ¹æ® SQLStatement ä¸­çš„ Segment ä¸ ShardingRule ä¸­çš„è§„åˆ™æ¥åˆ¤æ–­å®ƒä»¬ä¹‹é—´æ˜¯å¦æœ‰éœ€è¦ç‰¹æ®Šå¤„ç†çš„åˆ¤æ–­é€»è¾‘ã€‚æˆ‘ä»¬ä»¥ ShardingInsertStatementValidator ä¸ºä¾‹æ¥çœ‹éªŒè¯è¿‡ç¨‹ï¼Œå®ƒçš„ validate æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class ShardingInsertStatementValidator implements ShardingStatementValidator&lt;InsertStatement&gt; { 

    @Override 
    public void validate(final ShardingRule shardingRule, final InsertStatement sqlStatement, final List&lt;Object&gt; parameters) { 
        Optional&lt;OnDuplicateKeyColumnsSegment&gt; onDuplicateKeyColumnsSegment = sqlStatement.findSQLSegment(OnDuplicateKeyColumnsSegment.class); 

        //å¦‚æœæ˜¯&quot;ON DUPLICATE KEY UPDATE&quot;è¯­å¥ï¼Œä¸”å¦‚æœå½“å‰æ“ä½œçš„æ˜¯åˆ†ç‰‡Columnæ—¶ï¼ŒéªŒè¯ä¸é€šè¿‡ 
        if (onDuplicateKeyColumnsSegment.isPresent() &amp;&amp; isUpdateShardingKey(shardingRule, onDuplicateKeyColumnsSegment.get(), sqlStatement.getTable().getTableName())) { 
            throw new ShardingException(&quot;INSERT INTO .... ON DUPLICATE KEY UPDATE can not support update for sharding column.&quot;); 
        } 
    }
    â€¦ 
}
</code></pre><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„åˆ¤æ–­é€»è¾‘ä¸â€œON DUPLICATE KEY UPDATEâ€è¿™ä¸€ Mysql ç‰¹æœ‰çš„è¯­æ³•ç›¸å…³ï¼Œè¯¥è¯­æ³•å…è®¸æˆ‘ä»¬é€šè¿‡ Update çš„æ–¹å¼æ’å…¥æœ‰é‡å¤ä¸»é”®çš„æ•°æ®è¡Œï¼ˆå®é™…ä¸Šè¿™ä¸ªè¯­æ³•ä¹Ÿä¸æ˜¯å¸¸è§„è¯­æ³•ï¼Œæœ¬èº«ä¹Ÿä¸å¤§åº”è¯¥è¢«ä½¿ç”¨ï¼‰ã€‚</p>
<p>ShardingInsertStatementValidator å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨ OnDuplicateKeyColumnï¼Œç„¶åå†åˆ¤æ–­è¿™ä¸ª Column æ˜¯å¦æ˜¯åˆ†ç‰‡é”®ï¼Œå¦‚æœåŒæ—¶æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶ï¼Œåˆ™ç›´æ¥æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œä¸å…è®¸åœ¨åˆ†ç‰‡ Column ä¸Šæ‰§è¡Œâ€œINSERT INTO &hellip;. ON DUPLICATE KEY UPDATEâ€è¯­æ³•ã€‚</p>
<h4 id="2è·å–ä¸Šä¸‹æ–‡">2.è·å–ä¸Šä¸‹æ–‡</h4>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ ShardingRouter ç±»ä¸­ route æ–¹æ³•çš„ç¬¬äºŒæ®µä»£ç ï¼Œè¯¥æ®µä»£ç æ¯”è¾ƒç®€å•ï¼Œç”¨äºè·å–è¿è¡Œæ—¶çš„ SQLStatement ä¸Šä¸‹æ–‡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>//è·å– SQLStatementContext 
SQLStatementContext sqlStatementContext = SQLStatementContextFactory.newInstance(metaData.getRelationMetas(), logicSQL, parameters, sqlStatement);
</code></pre><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæ„å»ºäº†ä¸Šä¸‹æ–‡å¯¹è±¡ SQLStatementContextï¼ŒåŒæ ·ç”¨åˆ°äº†å·¥å‚æ¨¡å¼ï¼Œå·¥å‚ç±» SQLStatementContextFactory å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class SQLStatementContextFactory { 

    public static SQLStatementContext newInstance(final RelationMetas relationMetas, final String sql, final List&lt;Object&gt; parameters, final SQLStatement sqlStatement) { 
        if (sqlStatement instanceof SelectStatement) { 
            return new SelectSQLStatementContext(relationMetas, sql, parameters, (SelectStatement) sqlStatement); 
        } 
        if (sqlStatement instanceof InsertStatement) { 
            return new InsertSQLStatementContext(relationMetas, parameters, (InsertStatement) sqlStatement); 
        } 
        return new CommonSQLStatementContext(sqlStatement); 
    } 
}
</code></pre><p>è¯·æ³¨æ„ SQLStatementContext åªæœ‰ä¸‰ç§ï¼š</p>
<ul>
<li>SelectSQLStatementContext</li>
<li>InsertSQLStatementContext</li>
<li>CommonSQLStatementContext</li>
</ul>
<p>å®ƒä»¬éƒ½å®ç°äº† SQLStatementContext æ¥å£ï¼Œé¡¾åæ€ä¹‰ï¼Œæ‰€è°“çš„ <strong>SQLStatementContext å°±æ˜¯ä¸€ç§ä¸Šä¸‹æ–‡å¯¹è±¡</strong>ï¼Œä¿å­˜ç€ä¸ç‰¹å®š SQLStatement ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œç”¨äºä¸ºåç»­å¤„ç†æä¾›æ•°æ®å­˜å‚¨å’Œä¼ é€’çš„æ‰‹æ®µã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æƒ³è±¡åœ¨ SQLStatementContext ä¸­åŠ¿å¿…éƒ½æŒæœ‰ SQLStatement å¯¹è±¡ä»¥åŠä¸è¡¨ç»“æ„ä¿¡æ¯ç›¸å…³çš„ä¸Šä¸‹æ–‡ TablesContextã€‚</p>
<p>å¯¹äº SelectSQLStatementï¼Œé€šå¸¸ä¹Ÿéœ€è¦ä¿å­˜ä¸æŸ¥è¯¢ç›¸å…³çš„åˆ†ç»„ä¸Šä¸‹æ–‡ GroupByContextã€æ’åºä¸Šä¸‹æ–‡ OrderByContext å’Œåˆ†é¡µä¸Šä¸‹æ–‡ PaginationContextï¼›è€Œå¯¹äºInsertSQLStatementContext è€Œè¨€ï¼ŒInsertValueContext åˆ™åŒ…å«äº†æ‰€æœ‰ä¸æ’å…¥æ“ä½œç›¸å…³çš„å€¼å¯¹è±¡ã€‚</p>
<h4 id="3è‡ªåŠ¨ç”Ÿæˆä¸»é”®">3.è‡ªåŠ¨ç”Ÿæˆä¸»é”®</h4>
<p>æ¥ä¸‹æ¥çš„ç¬¬ä¸‰æ®µä»£ç ä¸æ•°æ®åº“ä¸»é”®ç›¸å…³ï¼ŒåŒæ ·åªæœ‰ä¸€å¥ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>//å¦‚æœæ˜¯ InsertStatement åˆ™è‡ªåŠ¨ç”Ÿæˆä¸»é”® 
Optional&lt;GeneratedKey&gt; generatedKey = sqlStatement instanceof InsertStatement 
            ? GeneratedKey.getGenerateKey(shardingRule, metaData.getTables(), parameters, (InsertStatement) sqlStatement) : Optional.&lt;GeneratedKey&gt;absent();
</code></pre><p>è¿™æ®µä»£ç çš„é€»è¾‘æ¯”è¾ƒæ˜ç¡®ï¼Œå³å¦‚æœè¾“å…¥çš„ SQLStatement æ˜¯ InsertStatementï¼Œåˆ™è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªä¸»é”® GeneratedKeyï¼Œåä¹‹å°±ä¸åšå¤„ç†ã€‚</p>
<p>åœ¨æ•°æ®åˆ†ç‰‡çš„åœºæ™¯ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªåˆ†å¸ƒå¼ä¸»é”®å®é™…ä¸Šå¹¶æ²¡æœ‰é‚£ä¹ˆç®€å•ï¼Œæ‰€ä»¥åœ¨è¿™æ®µä»£ç èƒŒåæœ‰å¾ˆå¤šè®¾è®¡çš„æ€æƒ³å’Œå®ç°çš„æŠ€å·§å€¼å¾—æˆ‘ä»¬è¿›è¡Œæ·±å…¥åˆ†æï¼Œå…³äºè¿™ä¸ªä¸»é¢˜ï¼Œæˆ‘ä»¬å·²ç»åœ¨ [ã€Š14 | åˆ†å¸ƒå¼ä¸»é”®ï¼šShardingSphere ä¸­æœ‰å“ªäº›åˆ†å¸ƒå¼ä¸»é”®å®ç°æ–¹å¼ï¼Ÿã€‹]ä¸­å¯¹åˆ†å¸ƒå¼ä¸»é”®ç”Ÿæˆæœºåˆ¶åšäº†ä¸“é¢˜åˆ†äº«ã€‚</p>
<h4 id="4åˆ›å»ºåˆ†ç‰‡æ¡ä»¶">4.åˆ›å»ºåˆ†ç‰‡æ¡ä»¶</h4>
<p>æˆ‘ä»¬æ¥çœ‹ ShardingRouter ä¸­ route æ–¹æ³•çš„ç¬¬å››ä¸ªæ­¥éª¤ï¼Œè¿™ä¸ªæ­¥éª¤çš„ä½œç”¨æ˜¯åˆ›å»ºåˆ†ç‰‡æ¡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>//åˆ›å»ºåˆ†ç‰‡æ¡ä»¶ 
ShardingConditions shardingConditions = getShardingConditions(parameters, sqlStatementContext, generatedKey.orNull(), metaData.getRelationMetas()); 
boolean needMergeShardingValues = isNeedMergeShardingValues(sqlStatementContext); 
if (sqlStatementContext.getSqlStatement() instanceof DMLStatement &amp;&amp; needMergeShardingValues) { 
    checkSubqueryShardingValues(sqlStatementContext, shardingConditions); 
    mergeShardingConditions(shardingConditions); 
}
</code></pre><p>åœ¨ ShardingSphere ä¸­ï¼Œåˆ†ç‰‡æ¡ä»¶å¯¹è±¡ ShardingCondition å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼ŒåŒ…å«äº†ä¸€ç»„è·¯ç”±ä¿¡æ¯å’ŒèŠ‚ç‚¹ä¿¡æ¯ï¼Œå…¶ä¸­è·¯ç”±ä¿¡æ¯åŒ…å«è¡¨åå’Œåˆ—åï¼Œè€ŒèŠ‚ç‚¹ä¿¡æ¯åŒ…å«æ•°æ®æºåå’Œè¡¨åï¼š</p>
<pre tabindex="0"><code>public class ShardingCondition { 
    //è·¯ç”±ä¿¡æ¯ 
    private final List&lt;RouteValue&gt; routeValues = new LinkedList&lt;&gt;(); 
    //èŠ‚ç‚¹ä¿¡æ¯ 
    private final Collection&lt;DataNode&gt; dataNodes = new LinkedList&lt;&gt;(); 
}
</code></pre><p>é‚£ä¹ˆå¦‚ä½•è·å–åˆ†ç‰‡æ¡ä»¶å‘¢ï¼Ÿå¦‚ä¸‹æ‰€ç¤ºçš„ getShardingConditions æ–¹æ³•ç»™å‡ºäº†å…·ä½“çš„å®ç°æ–¹å¼ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œæ ¹æ®è¾“å…¥çš„ SQL ç±»å‹ï¼Œåˆ†åˆ«é€šè¿‡ InsertClauseShardingConditionEngine å’ŒWhereClauseShardingConditionEngine åˆ›å»ºäº† ShardingConditionsï¼š</p>
<pre tabindex="0"><code>private ShardingConditions getShardingConditions(final List&lt;Object&gt; parameters, final SQLStatementContext sqlStatementContext, final GeneratedKey generatedKey, final RelationMetas relationMetas) { 
    if (sqlStatementContext.getSqlStatement() instanceof DMLStatement) { 
     //å¦‚æœæ˜¯ InsertSQLStatement ä¸Šä¸‹æ–‡ 
        if (sqlStatementContext instanceof InsertSQLStatementContext) { 
            InsertSQLStatementContext shardingInsertStatement = (InsertSQLStatementContext) sqlStatementContext; 
            //é€šè¿‡ InsertClauseShardingConditionEngine åˆ›å»ºåˆ†ç‰‡æ¡ä»¶ 
            return new ShardingConditions(new InsertClauseShardingConditionEngine(shardingRule).createShardingConditions(shardingInsertStatement, generatedKey, parameters)); 
        } 
        //å¦åˆ™ç›´æ¥é€šè¿‡ WhereClauseShardingConditionEngine åˆ›å»ºåˆ†ç‰‡æ¡ä»¶ 
        return new ShardingConditions(new WhereClauseShardingConditionEngine(shardingRule, relationMetas).createShardingConditions(sqlStatementContext.getSqlStatement(), parameters)); 
    } 
    return new ShardingConditions(Collections.&lt;ShardingCondition&gt;emptyList()); 
}
</code></pre><p>å¯¹äºè·¯ç”±å¼•æ“è€Œè¨€ï¼Œåˆ†ç‰‡æ¡ä»¶çš„ä¸»è¦ç›®çš„å°±æ˜¯æå–ç”¨äºè·¯ç”±çš„ç›®æ ‡æ•°æ®åº“ã€è¡¨å’Œåˆ—ä¹‹é—´çš„å…³ç³»ï¼ŒInsertClauseShardingConditionEngine å’Œ WhereClauseShardingConditionEngine ä¸­çš„å¤„ç†é€»è¾‘éƒ½æ˜¯ä¸ºäº†æ„å»ºåŒ…å«è¿™äº›å…³ç³»ä¿¡æ¯çš„ä¸€ç»„ ShardingCondition å¯¹è±¡ã€‚</p>
<p>å½“è·å–è¿™äº› ShardingCondition ä¹‹åï¼Œæˆ‘ä»¬è¿˜çœ‹åˆ°æœ‰ä¸€ä¸ªä¼˜åŒ–çš„æ­¥éª¤ï¼Œå³è°ƒç”¨mergeShardingConditionsï¼Œå¯¹å¯ä»¥åˆå¹¶çš„ ShardingCondition è¿›è¡Œåˆå¹¶ã€‚</p>
<h4 id="5æ‰§è¡Œè·¯ç”±">5.æ‰§è¡Œè·¯ç”±</h4>
<p>å½“æˆ‘ä»¬è·å–äº† SQLStatement ä¸Šä¸‹æ–‡ï¼Œå¹¶åˆ›å»ºäº†åˆ†ç‰‡æ¡ä»¶ï¼Œæ¥ä¸‹æ¥å°±æ˜¯çœŸæ­£æ‰§è¡Œè·¯ç”±ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>//è·å– RoutingEngine å¹¶æ‰§è¡Œè·¯ç”± 
RoutingEngine routingEngine = RoutingEngineFactory.newInstance(shardingRule, metaData, sqlStatementContext, shardingConditions); 
RoutingResult routingResult = routingEngine.route();
</code></pre><p>è¿™ä¸¤å¥ä»£ç æ˜¯ ShardingRouter ç±»çš„æ ¸å¿ƒï¼Œæˆ‘ä»¬è·å–äº†ä¸€ä¸ª RoutingEngine å®ä¾‹ï¼Œç„¶ååŸºäºè¯¥å®ä¾‹æ‰§è¡Œè·¯ç”±å¹¶è¿”å›ä¸€ä¸ª RoutingResult å¯¹è±¡ã€‚RoutingEngine å®šä¹‰å¦‚ä¸‹ï¼Œåªæœ‰ä¸€ä¸ªç®€å•çš„ route æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>public interface RoutingEngine {
    //æ‰§è¡Œè·¯ç”± 
    RoutingResult route(); 
}
</code></pre><p>åœ¨ ShardingSphere ä¸­å­˜åœ¨ä¸€æ‰¹ RoutingEngine çš„å®ç°ç±»ï¼ŒRoutingEngineFactory å·¥å‚ç±»è´Ÿè´£ç”Ÿæˆè¿™äº›å…·ä½“çš„ RoutingEngineï¼Œç”Ÿæˆé€»è¾‘å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public static RoutingEngine newInstance(final ShardingRule shardingRule, 
                                            final ShardingSphereMetaData metaData, final SQLStatementContext sqlStatementContext, final ShardingConditions shardingConditions) { 
        SQLStatement sqlStatement = sqlStatementContext.getSqlStatement(); 
        Collection&lt;String&gt; tableNames = sqlStatementContext.getTablesContext().getTableNames(); 

        //å…¨åº“è·¯ç”± 
        if (sqlStatement instanceof TCLStatement) { 
            return new DatabaseBroadcastRoutingEngine(shardingRule); 
        } 
        //å…¨åº“è¡¨è·¯ç”± 
        if (sqlStatement instanceof DDLStatement) { 
            return new TableBroadcastRoutingEngine(shardingRule, metaData.getTables(), sqlStatementContext); 
        } 
        //é˜»æ–­è·¯ç”± 
        if (sqlStatement instanceof DALStatement) { 
            return getDALRoutingEngine(shardingRule, sqlStatement, tableNames); 
        } 
        //å…¨å®ä¾‹è·¯ç”± 
        if (sqlStatement instanceof DCLStatement) { 
            return getDCLRoutingEngine(shardingRule, sqlStatementContext, metaData); 
        } 
        //é»˜è®¤åº“è·¯ç”± 
        if (shardingRule.isAllInDefaultDataSource(tableNames)) { 
            return new DefaultDatabaseRoutingEngine(shardingRule, tableNames); 
        } 
        //å…¨åº“è·¯ç”± 
        if (shardingRule.isAllBroadcastTables(tableNames)) { 
            return sqlStatement instanceof SelectStatement ? new UnicastRoutingEngine(shardingRule, tableNames) : new DatabaseBroadcastRoutingEngine(shardingRule); 
        } 
        //é»˜è®¤åº“è·¯ç”± 
        if (sqlStatementContext.getSqlStatement() instanceof DMLStatement &amp;&amp; tableNames.isEmpty() &amp;&amp; shardingRule.hasDefaultDataSourceName()) { 
            return new DefaultDatabaseRoutingEngine(shardingRule, tableNames); 
        } 
        //å•æ’­è·¯ç”± 
        if (sqlStatementContext.getSqlStatement() instanceof DMLStatement &amp;&amp; shardingConditions.isAlwaysFalse() || tableNames.isEmpty() || !shardingRule.tableRuleExists(tableNames)) { 
            return new UnicastRoutingEngine(shardingRule, tableNames); 
        } 
        //åˆ†ç‰‡è·¯ç”± 
        return getShardingRoutingEngine(shardingRule, sqlStatementContext, shardingConditions, tableNames); 
}
</code></pre><p>è¿™äº› RoutingEngine çš„å…·ä½“ä»‹ç»æˆ‘ä»¬æ”¾åœ¨ä¸‹ä¸€è¯¾æ—¶ã€Š18 | è·¯ç”±å¼•æ“ï¼šå¦‚ä½•å®ç°æ•°æ®è®¿é—®çš„åˆ†ç‰‡è·¯ç”±å’Œå¹¿æ’­è·¯ç”±ï¼Ÿã€‹ä¸­è¿›è¡Œè¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œåªéœ€è¦äº†è§£ ShardingSphere åœ¨åŒ…ç»“æ„çš„è®¾è®¡ä¸ŠæŠŠå…·ä½“çš„ RoutingEngine åˆ†æˆäº†å…­å¤§ç±»ï¼šå³å¹¿æ’­ï¼ˆbroadcastï¼‰è·¯ç”±ã€æ··åˆï¼ˆcomplexï¼‰è·¯ç”±ã€é»˜è®¤æ•°æ®åº“ï¼ˆdefaultdbï¼‰è·¯ç”±ã€æ— æ•ˆï¼ˆignoreï¼‰è·¯ç”±ã€æ ‡å‡†ï¼ˆstandardï¼‰è·¯ç”±ä»¥åŠå•æ’­ï¼ˆunicastï¼‰è·¯ç”±ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/Ciqc1F8xJvuALcqiAAA5dODyQeU720.png" alt="Drawing 3.png"></p>
<p>ä¸åŒç±»å‹çš„ RoutingEngine å®ç°ç±»</p>
<p>RoutingEngine çš„æ‰§è¡Œç»“æœæ˜¯ RoutingResultï¼Œè€Œ RoutingResult ä¸­åŒ…å«äº†ä¸€ä¸ª RoutingUnité›†åˆï¼ŒRoutingUnit ä¸­çš„å˜é‡å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªå…³äº DataSource åç§°çš„å˜é‡ä»¥åŠä¸€ä¸ª TableUnit åˆ—è¡¨ï¼š</p>
<pre tabindex="0"><code>//çœŸå®æ•°æ®æºå 
private final String dataSourceName; 
//é€»è¾‘æ•°æ®æºå 
private final String masterSlaveLogicDataSourceName; 
//è¡¨å•å…ƒåˆ—è¡¨ 
private final List&lt;TableUnit&gt; tableUnits = new LinkedList&lt;&gt;();
</code></pre><p>è€Œ TableUnit ä¿å­˜ç€é€»è¾‘è¡¨åå’Œå®é™…è¡¨åï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class TableUnit { 
    //é€»è¾‘è¡¨å 
    private final String logicTableName; 
    //çœŸå®è¡¨å 
    private final String actualTableName; 
}
</code></pre><p>æ‰€ä»¥ RoutingResult ä¸­ä¿å­˜çš„å®é™…ä¸Šå°±æ˜¯ä¸€ç»„å…³äºæ•°æ®åº“ä¸æ•°æ®è¡¨çš„å¯¹åº”å…³ç³»ï¼Œå…¶ä¸­åº“ä¸è¡¨éƒ½å­˜åœ¨é€»è¾‘å€¼å’ŒçœŸå®å€¼ã€‚</p>
<h4 id="6æ„å»ºè·¯ç”±ç»“æœ">6.æ„å»ºè·¯ç”±ç»“æœ</h4>
<p>å½“é€šè¿‡ä¸€ç³»åˆ—çš„è·¯ç”±å¼•æ“å¤„ç†ä¹‹åï¼Œæˆ‘ä»¬è·å¾—äº† RoutingResult å¯¹è±¡ï¼Œä½†å¹¶ä¸æ˜¯ç›´æ¥å°†å…¶è¿›è¡Œè¿”å›ï¼Œè€Œæ˜¯ä¼šæ„å»ºä¸€ä¸ª SQLRouteResult å¯¹è±¡ã€‚è¿™å°±æ˜¯ ShardingRouter çš„ route æ–¹æ³•æœ€åä¸€ä¸ªæ­¥éª¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>//æ„å»º SQLRouteResult 
SQLRouteResult result = new SQLRouteResult(sqlStatementContext, shardingConditions, generatedKey.orNull()); 
result.setRoutingResult(routingResult); 
//å¦‚æœæ˜¯Insertè¯­å¥ï¼Œåˆ™è®¾ç½®è‡ªåŠ¨ç”Ÿæˆçš„åˆ†ç‰‡é”® 
if (sqlStatementContext instanceof InsertSQLStatementContext) { 
    setGeneratedValues(result); 
} 
return result;
</code></pre><p>æˆ‘ä»¬æ¥åˆ° SQLRouteResult çš„å®šä¹‰ï¼Œçœ‹çœ‹å®ƒä¸ RouteResult ä¹‹é—´æœ‰ä»€ä¹ˆä¸åŒï¼ŒSQLRouteResultä¸­ çš„å˜é‡å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>//SQLStatement ä¸Šä¸‹æ–‡ 
private final SQLStatementContext sqlStatementContext; 
//åˆ†ç‰‡æ¡ä»¶ 
private final ShardingConditions shardingConditions; 
//è‡ªåŠ¨ç”Ÿæˆçš„åˆ†ç‰‡é”® 
private final GeneratedKey generatedKey; 
//ä¸€ç»„è·¯ç”±å•å…ƒ 
private final Collection&lt;RouteUnit&gt; routeUnits = new LinkedHashSet&lt;&gt;(); 
//ç”± RoutingEngine ç”Ÿæˆçš„ RoutingResult 
private RoutingResult routingResult;
</code></pre><p>å¯ä»¥çœ‹åˆ° SQLRouteResult ä¸­åŒ…å«äº† RoutingResultã€‚æˆ‘ä»¬å¯ä»¥è®¤ä¸º SQLRouteResult æ˜¯æ•´ä¸ª SQL è·¯ç”±è¿”å›çš„è·¯ç”±ç»“æœï¼Œåœ¨åç»­çš„æµç¨‹ä¸­è¿˜ä¼šè¢« PreparedStatementRoutingEngine ç­‰ä¸Šå±‚å¯¹è±¡æ‰€ä½¿ç”¨ï¼Œè€Œ RoutingResult åªæ˜¯ RoutingEngine è¿”å›çš„è·¯ç”±ç»“æœï¼Œå®ƒçš„ä½¿ç”¨è€…å°±æ˜¯ä½äºåº•å±‚çš„ ShardingRouterã€‚</p>
<p>åŒæ—¶ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°è¿™é‡Œæœ‰ä¸€ä¸ªæ–°çš„ Unit å¯¹è±¡ RouteUnitï¼ŒåŒ…å«äº†æ•°æ®æºåç§°ä»¥åŠ SQL å•å…ƒå¯¹è±¡ SQLUnitï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class RouteUnit { 
    //æ•°æ®æºå 
    private final String dataSourceName; 
    //SQL å•å…ƒ 
    private final SQLUnit sqlUnit; 
}
</code></pre><p>è¿™é‡Œçš„ SQLUnit ä¸­å°±æ˜¯æœ€ç»ˆçš„ä¸€æ¡ SQL è¯­å¥ä»¥åŠç›¸åº”å‚æ•°çš„ç»„åˆã€‚å› ä¸ºè·¯ç”±ç»“æœå¯¹è±¡ SQLRouteResult ä¼šç»§ç»­ä¼ é€’åˆ°åˆ†ç‰‡å¼•æ“çš„åç»­æµç¨‹ï¼Œä¸”å†…éƒ¨ç»“æ„æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥è¿™é‡Œé€šè¿‡å¦‚ä¸‹æ‰€ç¤ºçš„ç±»å›¾å¯¹å…¶åŒ…å«çš„å„ç§å˜é‡è¿›è¡Œæ€»ç»“ï¼Œæ–¹ä¾¿ä½ è¿›è¡Œç†è§£ã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/CgqCHl8xJ0eAMp1GAABywd2SYFQ497.png" alt="Drawing 4.png"></p>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬æŠŠ ShardingRouter ç±»çš„æ ¸å¿ƒæµç¨‹åšäº†ä»‹ç»ã€‚åœ¨ ShardingSphere çš„è·¯ç”±å¼•æ“ä¸­ï¼ŒShardingRouter å¯ä»¥è¯´æ˜¯ä¸€ä¸ªæ‰¿ä¸Šå¯ä¸‹çš„æ ¸å¿ƒç±»ï¼Œå‘ä¸‹æˆ‘ä»¬å¯ä»¥æŒ–æ˜å„ç§ RoutingEngine çš„å…·ä½“å®ç°ï¼›å‘ä¸Šæˆ‘ä»¬å¯ä»¥å»¶å±•åˆ°è¯»å†™åˆ†ç¦»ç­‰é¢å‘åº”ç”¨çš„å…·ä½“åœºæ™¯ã€‚</p>
<p>ä¸‹å›¾å±•ç¤ºäº† ShardingRouter çš„è¿™ç§å®šä½å…³ç³»ã€‚å…³äºå„ç§ RoutingEngine çš„ä»‹ç»æ˜¯æˆ‘ä»¬ä¸‹ä¸€è¯¾æ—¶çš„å†…å®¹ï¼Œä»Šå¤©æˆ‘ä»¬å…ˆå°†åŸºäº ShardingRouter è®¨è®ºå®ƒçš„ä¸Šå±‚ç»“æ„ï¼Œä»è€Œå¼•å‡ºäº† ShardingEngineã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/CgqCHl8xJ1WAbAmHAAB_-h8F66g956.png" alt="Drawing 6.png"></p>
<h3 id="ä»åº•å±‚-shardingrouter-åˆ°ä¸Šå±‚-shardingengine">ä»åº•å±‚ ShardingRouter åˆ°ä¸Šå±‚ ShardingEngine</h3>
<p>æˆ‘ä»¬çš„æ€è·¯ä»ç„¶æ˜¯ä»ä¸‹å¾€ä¸Šï¼Œå…ˆæ¥çœ‹ä¸Šå›¾ä¸­çš„ StatementRoutingEngineï¼Œå…¶å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class StatementRoutingEngine { 

    private final ShardingRouter shardingRouter; 

    private final ShardingMasterSlaveRouter masterSlaveRouter; 

    public StatementRoutingEngine(final ShardingRule shardingRule, final ShardingSphereMetaData metaData, final SQLParseEngine sqlParseEngine) { 
        shardingRouter = new ShardingRouter(shardingRule, metaData, sqlParseEngine); 
        masterSlaveRouter = new ShardingMasterSlaveRouter(shardingRule.getMasterSlaveRules()); 
    } 

    public SQLRouteResult route(final String logicSQL) { 
        SQLStatement sqlStatement = shardingRouter.parse(logicSQL, false); 
        return masterSlaveRouter.route(shardingRouter.route(logicSQL, Collections.emptyList(), sqlStatement)); 
    } 
}
</code></pre><p>å¯ä»¥çœ‹åˆ°åœ¨ StatementRoutingEngine çš„ route æ–¹æ³•ä¸­ï¼Œé€šè¿‡ ShardingMasterSlaveRouter å¯¹é€šè¿‡ ShardingRouter æ‰€ç”Ÿæˆçš„ SQLRouteResult è¿›è¡Œäº†å†ä¸€æ¬¡è·¯ç”±ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨åˆ†ç‰‡è·¯ç”±çš„åŸºç¡€ä¸Šæ·»åŠ äº†ä¸»ä»è·¯ç”±ï¼Œå…³äºè¯»å†™åˆ†ç¦»å’Œä¸»ä»è·¯ç”±æˆ‘ä»¬ä¼šåœ¨ä¹‹åçš„ã€Š26 | è¯»å†™åˆ†ç¦»ï¼šæ™®é€šä¸»ä»æ¶æ„å’Œåˆ†ç‰‡ä¸»ä»æ¶æ„åˆ†åˆ«æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿã€‹è¿›è¡Œè®¨è®ºã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬æ¥åˆ° sharding-core-entry å·¥ç¨‹ï¼Œçœ‹çœ‹æ›´ä¸Šå±‚çš„å¤„ç†æµç¨‹ã€‚æ•´ä¸ª sharding-core-entry å·¥ç¨‹åªæœ‰ä¸‰ä¸ªç±»ï¼Œå³ä½œä¸ºåŸºç±»çš„ BaseShardingEngine ä»¥åŠä¸¤ä¸ªå­ç±» PreparedQueryShardingEngine å’Œ SimpleQueryShardingEngineã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ BaseShardingEngine ç±»ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼ŒBaseShardingEngine çš„ shard æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public SQLRouteResult shard(final String sql, final List&lt;Object&gt; parameters) { 
     //è°ƒç”¨æ¨¡æ¿æ–¹æ³•å‡†å¤‡å‚æ•° 
    List&lt;Object&gt; clonedParameters = cloneParameters(parameters); 
    //æ‰§è¡Œè·¯ç”± 
    SQLRouteResult result = executeRoute(sql, clonedParameters); 
    //æ‰§è¡Œ SQL è½¬æ¢ï¼ˆConvertï¼‰å’Œæ”¹å†™ï¼ˆRewriteï¼‰ 
        result.getRouteUnits().addAll(HintManager.isDatabaseShardingOnly() ? convert(sql, clonedParameters, result) : rewriteAndConvert(sql, clonedParameters, result)); 

//çœç•¥æ—¥å¿—è®°å½• 

    return result; 
}
</code></pre><p>åœ¨è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°äº† SQL è½¬æ¢ï¼ˆConvertï¼‰å’Œæ”¹å†™ï¼ˆRewriteï¼‰çš„å…¥å£ï¼Œè¿™æ˜¯è·¯ç”±å¼•æ“ä¹‹å¤–çš„æ‰§è¡Œæµç¨‹ï¼Œæˆ‘ä»¬ä»Šå¤©ä¸åšå±•å¼€ã€‚ä¸Šè¿°ä»£ç ä¸è·¯ç”±ç›¸å…³æœ€æ ¸å¿ƒçš„å°±æ˜¯ executeRoute æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private SQLRouteResult executeRoute(final String sql, final List&lt;Object&gt; clonedParameters) {
 routingHook.start(sql); 
    try { 
         //è°ƒç”¨æ¨¡æ¿æ–¹æ³•æ‰§è¡Œè·¯ç”±å¹¶è·å–ç»“æœ 
        SQLRouteResult result = route(sql, clonedParameters); 
        routingHook.finishSuccess(result, metaData.getTables()); 
        return result; 
    } catch (final Exception ex) { 
        routingHook.finishFailure(ex); 
        throw ex; 
    } 
}
</code></pre><p>è¿™ä¸ªæ–¹æ³•çš„å¤„ç†æ–¹å¼ä¸ SQLParseEngine çš„ parse æ–¹æ³•æœ‰ç€ç±»ä¼¼çš„ä»£ç ç»“æ„ï¼ŒåŒæ ·ç”¨åˆ°äº† Hook æœºåˆ¶ã€‚</p>
<p>ä»è®¾è®¡æ¨¡å¼ä¸Šè®²ï¼ŒBaseShardingEngine é‡‡ç”¨äº†éå¸¸å…¸å‹çš„æ¨¡æ¿æ–¹æ³•ã€‚å½“æˆ‘ä»¬éœ€è¦å®Œæˆä¸€ä¸ªè¿‡ç¨‹æˆ–ä¸€ç³»åˆ—æ­¥éª¤æ—¶ï¼Œè¿™äº›è¿‡ç¨‹æˆ–æ­¥éª¤åœ¨æŸä¸€ç»†èŠ‚å±‚æ¬¡ä¿æŒä¸€è‡´ï¼Œä½†ä¸ªåˆ«æ­¥éª¤åœ¨æ›´è¯¦ç»†çš„å±‚æ¬¡ä¸Šçš„å®ç°å¯èƒ½ä¸åŒæ—¶ï¼Œå¯ä»¥è€ƒè™‘ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼æ¥å¤„ç†ã€‚å®ç°æ¨¡æ¿æ–¹æ³•çš„è¿‡ç¨‹ä¹Ÿéå¸¸ç®€å•ï¼Œå…¶å®å°±æ˜¯åˆ©ç”¨äº†ç±»çš„ç»§æ‰¿æœºåˆ¶ã€‚ä½œä¸ºä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œæˆ‘ä»¬æ³¨æ„åˆ° BaseShardingEngine æä¾›äº†ä¸¤ä¸ªæ¨¡æ¿æ–¹æ³•ä¾›å­ç±»è¿›è¡Œå®ç°ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<pre tabindex="0"><code>//æ‹·è´å‚æ•° 
protected abstract List&lt;Object&gt; cloneParameters(List&lt;Object&gt; parameters); 
//æ‰§è¡Œè·¯ç”± 
protected abstract SQLRouteResult route(String sql, List&lt;Object&gt; parameters);
</code></pre><p>æ˜¾ç„¶ï¼Œå¯¹äº SimpleQueryShardingEngine è€Œè¨€ï¼Œä¸éœ€è¦å‚æ•°ï¼Œæ‰€ä»¥ cloneParameters ç›´æ¥è¿”å›ç©ºåˆ—è¡¨ã€‚è€Œ route æ–¹æ³•åˆ™ç›´æ¥ä½¿ç”¨å‰é¢ä»‹ç»çš„ StatementRoutingEngine è¿›è¡Œè·¯ç”±ã€‚SimpleQueryShardingEngine ç±»çš„å®Œæ•´å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class SimpleQueryShardingEngine extends BaseShardingEngine { 

    private final StatementRoutingEngine routingEngine; 

    public SimpleQueryShardingEngine(final ShardingRule shardingRule, final ShardingProperties shardingProperties, final ShardingSphereMetaData metaData, final SQLParseEngine sqlParseEngine) { 
        super(shardingRule, shardingProperties, metaData); 
        routingEngine = new StatementRoutingEngine(shardingRule, metaData, sqlParseEngine); 
    } 

    @Override 
    protected List&lt;Object&gt; cloneParameters(final List&lt;Object&gt; parameters) { 
        return Collections.emptyList(); 
    } 

    @Override 
    protected SQLRouteResult route(final String sql, final List&lt;Object&gt; parameters) { 
        return routingEngine.route(sql); 
    } 
}
</code></pre><p>è‡³æ­¤ï¼Œå…³äº ShardingSphere è·¯ç”±å¼•æ“éƒ¨åˆ†çš„å†…å®¹åŸºæœ¬éƒ½ä»‹ç»å®Œæ¯•ã€‚å¯¹äºä¸Šå±‚ç»“æ„è€Œè¨€ï¼Œæˆ‘ä»¬ä»¥ SimpleQueryShardingEngine ä¸ºä¾‹è¿›è¡Œäº†å±•å¼€ï¼Œå¯¹äº PreparedQueryShardingEngine çš„å¤„ç†æ–¹å¼ä¹Ÿæ˜¯ç±»ä¼¼ã€‚ä½œä¸ºæ€»ç»“ï¼Œæˆ‘ä»¬é€šè¿‡å¦‚ä¸‹æ‰€ç¤ºçš„æ—¶åºå›¾æ¥æ¢³ç†è¿™äº›è·¯ç”±çš„ä¸»æµç¨‹ã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/CgqCHl8xJ2aAQabtAACUcSURKVc544.png" alt="Drawing 8.png"></p>
<h3 id="ä»æºç è§£æåˆ°æ—¥å¸¸å¼€å‘">ä»æºç è§£æåˆ°æ—¥å¸¸å¼€å‘</h3>
<p>åˆ†åŒ…è®¾è®¡åŸåˆ™å¯ä»¥ç”¨æ¥è®¾è®¡å’Œè§„åˆ’å¼€æºæ¡†æ¶çš„ä»£ç ç»“æ„ã€‚åœ¨ä»Šå¤©çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº† ShardingSphere ä¸­éå¸¸å…¸å‹çš„ä¸€ç§åˆ†å±‚å’Œåˆ†åŒ…å®ç°ç­–ç•¥ã€‚é€šè¿‡ sharding-core-route å’Œ sharding-core-entry è¿™ä¸¤ä¸ªå·¥ç¨‹ï¼Œæˆ‘ä»¬æŠŠè·¯ç”±å¼•æ“ä¸­ä½äºåº•å±‚çš„æ ¸å¿ƒç±» ShardingRouter å’Œä½äºä¸Šå±‚çš„ PreparedQueryShardingEngine åŠ SimpleQueryShardingEngine ç±»è¿›è¡Œäº†åˆç†çš„åˆ†å±‚ç®¡ç†ã€‚ShardingSphere å¯¹äºåˆ†å±‚å’Œåˆ†åŒ…ç­–ç•¥çš„åº”ç”¨æœ‰å¾ˆå¤šå…·ä½“çš„è¡¨ç°å½¢å¼ï¼Œéšç€è¯¾ç¨‹çš„ä¸æ–­æ¼”è¿›ï¼Œæˆ‘ä»¬è¿˜ä¼šçœ‹åˆ°æ›´å¤šçš„åº”ç”¨åœºæ™¯ã€‚</p>
<h3 id="å°ç»“ä¸é¢„å‘Š">å°ç»“ä¸é¢„å‘Š</h3>
<p>ä½œä¸º ShardingSphere åˆ†ç‰‡å¼•æ“çš„ç¬¬äºŒä¸ªæ ¸å¿ƒç»„ä»¶ï¼Œè·¯ç”±å¼•æ“çš„ç›®çš„åœ¨äºç”Ÿæˆ SQLRouteResultç›®æ ‡å¯¹è±¡ã€‚è€Œæ•´ä¸ªè·¯ç”±å¼•æ“ä¸­æœ€æ ¸å¿ƒçš„å°±æ˜¯ ShardingRouter ç±»ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å¯¹ ShardingRouter çš„æ•´ä½“æ‰§è¡Œæµç¨‹è¿›è¡Œäº†è¯¦ç»†çš„è®¨è®ºï¼ŒåŒæ—¶ä¹Ÿå¼•å‡ºäº†è·¯ç”±å¼•æ“ä¸­çš„åº•å±‚å¯¹è±¡ RoutingEngineã€‚</p>
<p><strong>è¿™é‡Œç»™ä½ ç•™ä¸€é“æ€è€ƒé¢˜ï¼šShardingSphere ä¸­ï¼Œä¸€ä¸ªå®Œæ•´çš„è·¯ç”±æ‰§è¡Œè¿‡ç¨‹éœ€è¦ç»å†å“ªäº›æ­¥éª¤ï¼Ÿ</strong> æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸å¤§å®¶è®¨è®ºï¼Œæˆ‘å°†ä¸€ä¸€ç‚¹è¯„è§£ç­”ã€‚</p>
<p>åœ¨ä»Šå¤©çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿæåˆ°äº† ShardingSphere ä¸­å­˜åœ¨å¤šç§ RoutingEngineã€‚åœ¨ä¸‹ä¸€è¯¾æ—¶çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬å°†å…³æ³¨äºè¿™äº› RoutingEngine çš„å…·ä½“å®ç°è¿‡ç¨‹ã€‚</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/16-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8B/"><span>16 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸‹ï¼‰</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/18-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E7%9A%84%E5%88%86%E7%89%87%E8%B7%AF%E7%94%B1%E5%92%8C%E5%B9%BF%E6%92%AD%E8%B7%AF%E7%94%B1/"><span>18 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•å®ç°æ•°æ®è®¿é—®çš„åˆ†ç‰‡è·¯ç”±å’Œå¹¿æ’­è·¯ç”±ï¼Ÿ</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 27270 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>