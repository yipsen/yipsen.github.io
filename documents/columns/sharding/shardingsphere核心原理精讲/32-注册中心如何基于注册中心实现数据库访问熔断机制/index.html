<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>32 æ³¨å†Œä¸­å¿ƒï¼šå¦‚ä½•åŸºäºæ³¨å†Œä¸­å¿ƒå®ç°æ•°æ®åº“è®¿é—®ç†”æ–­æœºåˆ¶ï¼Ÿ | Yipsen Ye</title>
<meta name="description" content="ä¸Šä¸€è¯¾æ—¶æˆ‘ä»¬è®¨è®ºäº† ShardingSphere ä¸­å…³äºé…ç½®ä¸­å¿ƒçš„ç›¸å…³å†…å®¹ã€‚ä»Šå¤©æˆ‘ä»¬ç»§ç»­è®¨è®ºç¼–æ’æ²»ç†æ¨¡å—çš„å¦ä¸€ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼Œå³æ³¨å†Œä¸­å¿ƒã€‚ç›¸è¾ƒé…ç½®ä¸­å¿ƒï¼Œæ³¨å†Œä¸­å¿ƒåœ¨ ShardingSphere ä¸­çš„åº”ç”¨æ›´ä¸ºå¹¿æ³›ã€‚
ShardingSphere ä¸­çš„æ³¨å†Œä¸­å¿ƒå®ç°ç±» ä¸é…ç½®ä¸­å¿ƒä¸€æ ·ï¼ŒShardingSphere ä¸­çš„æ³¨å†Œä¸­å¿ƒåœ¨ä»£ç ç»“æ„ä¸Šä¹ŸåŒ…å«ä¸‰ä¸ªç‹¬ç«‹çš„å·¥ç¨‹ï¼Œå³ä»£è¡¨æŠ½è±¡æ¥å£çš„ API å·¥ç¨‹ï¼Œä»¥åŠä¸¤ä¸ªå…·ä½“çš„å®ç° nacos å’Œ zookeeper-curator å·¥ç¨‹ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡ŒåŒæ ·ä½¿ç”¨ä¸Šä¸€è¯¾æ—¶ä¸­ä»‹ç»çš„ Zookeeper ä½œä¸ºæ³¨å†Œä¸­å¿ƒçš„ä¸€ç§å®ç°æ–¹å¼ï¼Œè€Œå¦ä¸€ç§å®ç°æ–¹å¼å°±æ˜¯åŸºäºé˜¿é‡Œå·´å·´çš„ Nacosã€‚
æˆ‘ä»¬å…ˆæ¥çœ‹ ShardingSphere ä¸­å¯¹æ³¨å†Œä¸­å¿ƒçš„æŠ½è±¡ï¼Œå³å¦‚ä¸‹æ‰€ç¤ºçš„ RegistryCenter æ¥å£ï¼š
public interface RegistryCenter extends TypeBasedSPI {//æ ¹æ®é…ç½®ä¿¡æ¯åˆå§‹åŒ–æ³¨å†Œä¸­å¿ƒvoid init(RegistryCenterConfiguration config);//è·å–æ•°æ®String get(String key);//ç›´æ¥è·å–æ•°æ®String getDirectly(String key);//æ˜¯å¦å­˜åœ¨æ•°æ®é¡¹boolean isExisted(String key);//è·å–å­æ•°æ®é¡¹åˆ—è¡¨List&amp;lt;String&amp;gt; getChildrenKeys(String key);//æŒä¹…åŒ–æ•°æ®é¡¹void persist(String key, String value);//æ›´æ–°æ•°æ®é¡¹void update(String key, String value);//æŒä¹…åŒ–ä¸´æ—¶æ•°æ®void persistEphemeral(String key, String value);//å¯¹æ•°æ®é¡¹æˆ–è·¯å¾„è¿›è¡Œç›‘å¬void watch(String key, DataChangedEventListener dataChangedEventListener);//å…³é—­æ³¨å†Œä¸­å¿ƒvoid close();//å¯¹æ•°æ®é¡¹åˆå§‹åŒ–é”void initLock(String key);//å¯¹æ•°æ®é¡¹è·å–é”boolean tryLock();//å¯¹æ•°æ®é¡¹é‡Šæ”¾é”void tryRelease();}æˆ‘ä»¬å‘ç°ï¼Œé™¤äº†æœ€åå‡ ä¸ªå…³äºé”å¤„ç†çš„æ–¹æ³•ï¼ŒRegistryCenter å®é™…ä¸Šä¸ä¸Šä¸€è¯¾æ—¶ä¸­ä»‹ç»çš„ ConfigCenter éå¸¸ç±»ä¼¼ã€‚ä»è¿™ç‚¹ä¸Šï¼Œæˆ‘ä»¬å°±ä¸éš¾æƒ³è±¡ä¸ºä»€ä¹ˆ Zookeeper æ—¢å¯ä»¥ç”¨æ¥åšé…ç½®ä¸­å¿ƒï¼Œä¹Ÿå¯ä»¥æ˜¯å®ç°æ³¨å†Œä¸­å¿ƒçš„ä¸€ç§å…¸å‹æ–¹æ¡ˆã€‚æ²¿ç€è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬å°±å…ˆæ¥çœ‹ä¸€ä¸‹ CuratorZookeeperRegistryCenter è¿™ä¸ªåŸºäº Zookeeper çš„æ³¨å†Œä¸­å¿ƒå®ç°ç±»ã€‚">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/shardingsphere%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e7%b2%be%e8%ae%b2/">ShardingSphereæ ¸å¿ƒåŸç†ç²¾è®²</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/00-%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E5%AD%A6%E4%B9%A0%E4%B8%80%E6%AC%BE%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/">00 å¦‚ä½•æ­£ç¡®å­¦ä¹ ä¸€æ¬¾åˆ†åº“åˆ†è¡¨å¼€æºæ¡†æ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/01-%E4%BB%8E%E7%90%86%E8%AE%BA%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%A6%82%E4%BD%95%E8%AE%A9%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%9C%9F%E6%AD%A3%E8%90%BD%E5%9C%B0/">01 ä»ç†è®ºåˆ°å®è·µï¼šå¦‚ä½•è®©åˆ†åº“åˆ†è¡¨çœŸæ­£è½åœ°ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/02-%E9%A1%B6%E7%BA%A7%E9%A1%B9%E7%9B%AEshardingsphere-%E6%98%AF%E4%B8%80%E6%AC%BE%E4%BB%80%E4%B9%88%E6%A0%B7%E7%9A%84-apache-%E5%BC%80%E6%BA%90%E8%BD%AF%E4%BB%B6/">02 é¡¶çº§é¡¹ç›®ï¼šShardingSphere æ˜¯ä¸€æ¬¾ä»€ä¹ˆæ ·çš„ Apache å¼€æºè½¯ä»¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/03-%E8%A7%84%E8%8C%83%E5%85%BC%E5%AE%B9jdbc-%E8%A7%84%E8%8C%83%E4%B8%8E-shardingsphere-%E6%98%AF%E4%BB%80%E4%B9%88%E5%85%B3%E7%B3%BB/">03 è§„èŒƒå…¼å®¹ï¼šJDBC è§„èŒƒä¸ ShardingSphere æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/04-%E5%BA%94%E7%94%A8%E9%9B%86%E6%88%90%E5%9C%A8%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F%E4%B8%AD%E4%BD%BF%E7%94%A8-shardingsphere-%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9C%89%E5%93%AA%E4%BA%9B/">04 åº”ç”¨é›†æˆï¼šåœ¨ä¸šåŠ¡ç³»ç»Ÿä¸­ä½¿ç”¨ ShardingSphere çš„æ–¹å¼æœ‰å“ªäº›ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/05-%E9%85%8D%E7%BD%AE%E9%A9%B1%E5%8A%A8shardingsphere-%E4%B8%AD%E7%9A%84%E9%85%8D%E7%BD%AE%E4%BD%93%E7%B3%BB%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E7%9A%84/">05 é…ç½®é©±åŠ¨ï¼šShardingSphere ä¸­çš„é…ç½®ä½“ç³»æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/09-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E4%B8%8E%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1/">09 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¦‚ä½•ä½¿ç”¨å¼ºä¸€è‡´æ€§äº‹åŠ¡ä¸æŸ”æ€§äº‹åŠ¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/10-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E5%A6%82%E4%BD%95%E7%A1%AE%E4%BF%9D%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AE%89%E5%85%A8%E8%AE%BF%E9%97%AE/">10 æ•°æ®è„±æ•ï¼šå¦‚ä½•ç¡®ä¿æ•æ„Ÿæ•°æ®çš„å®‰å…¨è®¿é—®ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/11-%E7%BC%96%E6%8E%92%E6%B2%BB%E7%90%86%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/">11 ç¼–æ’æ²»ç†ï¼šå¦‚ä½•å®ç°åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„åŠ¨æ€é…ç½®ç®¡ç†ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/12-%E4%BB%8E%E5%BA%94%E7%94%A8%E5%88%B0%E5%8E%9F%E7%90%86%E5%A6%82%E4%BD%95%E9%AB%98%E6%95%88%E9%98%85%E8%AF%BB-shardingsphere-%E6%BA%90%E7%A0%81/">12 ä»åº”ç”¨åˆ°åŸç†ï¼šå¦‚ä½•é«˜æ•ˆé˜…è¯» ShardingSphere æºç ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/13-%E5%BE%AE%E5%86%85%E6%A0%B8%E6%9E%B6%E6%9E%84shardingsphere-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%89%A9%E5%B1%95%E6%80%A7/">13 å¾®å†…æ ¸æ¶æ„ï¼šShardingSphere å¦‚ä½•å®ç°ç³»ç»Ÿçš„æ‰©å±•æ€§ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/14-%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AEshardingsphere-%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AE%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F/">14 åˆ†å¸ƒå¼ä¸»é”®ï¼šShardingSphere ä¸­æœ‰å“ªäº›åˆ†å¸ƒå¼ä¸»é”®å®ç°æ–¹å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/15-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8A/">15 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/16-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8B/">16 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/17-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E5%88%86%E7%89%87%E8%B7%AF%E7%94%B1%E6%A0%B8%E5%BF%83%E7%B1%BB-shardingrouter-%E7%9A%84%E8%BF%90%E4%BD%9C%E6%9C%BA%E5%88%B6/">17 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•ç†è§£åˆ†ç‰‡è·¯ç”±æ ¸å¿ƒç±» ShardingRouter çš„è¿ä½œæœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/18-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E7%9A%84%E5%88%86%E7%89%87%E8%B7%AF%E7%94%B1%E5%92%8C%E5%B9%BF%E6%92%AD%E8%B7%AF%E7%94%B1/">18 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•å®ç°æ•°æ®è®¿é—®çš„åˆ†ç‰‡è·¯ç”±å’Œå¹¿æ’­è·¯ç”±ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/19-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%9C%A8%E8%B7%AF%E7%94%B1%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%9B%86%E6%88%90%E5%A4%9A%E7%A7%8D%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E5%92%8C%E8%B7%AF%E7%94%B1%E7%AE%97%E6%B3%95/">19 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•åœ¨è·¯ç”±è¿‡ç¨‹ä¸­é›†æˆå¤šç§è·¯ç”±ç­–ç•¥å’Œè·¯ç”±ç®—æ³•ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/20-%E6%94%B9%E5%86%99%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84-sql-%E6%94%B9%E5%86%99%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6/">20 æ”¹å†™å¼•æ“ï¼šå¦‚ä½•ç†è§£è£…é¥°å™¨æ¨¡å¼ä¸‹çš„ SQL æ”¹å†™å®ç°æœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/21-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%88%86%E7%89%87%E7%8E%AF%E5%A2%83%E4%B8%8B-sql-%E6%89%A7%E8%A1%8C%E7%9A%84%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E6%8A%BD%E8%B1%A1/">21 æ‰§è¡Œå¼•æ“ï¼šåˆ†ç‰‡ç¯å¢ƒä¸‹ SQL æ‰§è¡Œçš„æ•´ä½“æµç¨‹åº”è¯¥å¦‚ä½•è¿›è¡ŒæŠ½è±¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/22-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E6%8A%8A%E6%8F%A1-shardingsphere-%E4%B8%AD%E7%9A%84-executor-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8A/">22 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/23-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E6%8A%8A%E6%8F%A1-shardingsphere-%E4%B8%AD%E7%9A%84-executor-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8B/">23 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/24-%E5%BD%92%E5%B9%B6%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E6%95%B0%E6%8D%AE%E5%BD%92%E5%B9%B6%E7%9A%84%E7%B1%BB%E5%9E%8B%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%BD%92%E5%B9%B6%E7%AD%96%E7%95%A5%E7%9A%84%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B/">24 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æ•°æ®å½’å¹¶çš„ç±»å‹ä»¥åŠç®€å•å½’å¹¶ç­–ç•¥çš„å®ç°è¿‡ç¨‹ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/25-%E5%BD%92%E5%B9%B6%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E6%B5%81%E5%BC%8F%E5%BD%92%E5%B9%B6%E5%92%8C%E5%86%85%E5%AD%98%E5%BD%92%E5%B9%B6%E5%9C%A8%E5%A4%8D%E6%9D%82%E5%BD%92%E5%B9%B6%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84%E5%BA%94%E7%94%A8%E6%96%B9%E5%BC%8F/">25 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æµå¼å½’å¹¶å’Œå†…å­˜å½’å¹¶åœ¨å¤æ‚å½’å¹¶åœºæ™¯ä¸‹çš„åº”ç”¨æ–¹å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/26-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%99%AE%E9%80%9A%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%92%8C%E5%88%86%E7%89%87%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%88%86%E5%88%AB%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84/">26 è¯»å†™åˆ†ç¦»ï¼šæ™®é€šä¸»ä»æ¶æ„å’Œåˆ†ç‰‡ä¸»ä»æ¶æ„åˆ†åˆ«æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/27-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3-shardingsphere-%E4%B8%AD%E5%AF%B9%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%8A%BD%E8%B1%A1%E8%BF%87%E7%A8%8B/">27 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¦‚ä½•ç†è§£ ShardingSphere ä¸­å¯¹åˆ†å¸ƒå¼äº‹åŠ¡çš„æŠ½è±¡è¿‡ç¨‹ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/28-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1shardingsphere-%E4%B8%AD%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%E4%B8%8A/">28 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/29-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1shardingsphere-%E4%B8%AD%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%E4%B8%8B/">29 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/30-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E6%94%B9%E5%86%99%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%E4%BD%8E%E4%BE%B5%E5%85%A5%E6%80%A7%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E6%96%B9%E6%A1%88/">30 æ•°æ®è„±æ•ï¼šå¦‚ä½•åŸºäºæ”¹å†™å¼•æ“å®ç°ä½ä¾µå…¥æ€§æ•°æ®è„±æ•æ–¹æ¡ˆï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/31-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E7%9A%84%E5%8A%A8%E6%80%81%E5%8C%96%E7%AE%A1%E7%90%86/">31 é…ç½®ä¸­å¿ƒï¼šå¦‚ä½•åŸºäºé…ç½®ä¸­å¿ƒå®ç°é…ç½®ä¿¡æ¯çš„åŠ¨æ€åŒ–ç®¡ç†ï¼Ÿ</a></li>
                
                
                
                    <li>32 æ³¨å†Œä¸­å¿ƒï¼šå¦‚ä½•åŸºäºæ³¨å†Œä¸­å¿ƒå®ç°æ•°æ®åº“è®¿é—®ç†”æ–­æœºåˆ¶ï¼Ÿ</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/33-%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E-hook-%E6%9C%BA%E5%88%B6%E4%BB%A5%E5%8F%8A-opentracing-%E5%8D%8F%E8%AE%AE%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA/">33 é“¾è·¯è·Ÿè¸ªï¼šå¦‚ä½•åŸºäº Hook æœºåˆ¶ä»¥åŠ OpenTracing åè®®å®ç°æ•°æ®è®¿é—®é“¾è·¯è·Ÿè¸ªï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/35-%E7%BB%93%E8%AF%ADshardingsphere-%E6%80%BB%E7%BB%93%E5%8F%8A%E5%B1%95%E6%9C%9B/">35 ç»“è¯­ï¼šShardingSphere æ€»ç»“åŠå±•æœ›</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">32 æ³¨å†Œä¸­å¿ƒï¼šå¦‚ä½•åŸºäºæ³¨å†Œä¸­å¿ƒå®ç°æ•°æ®åº“è®¿é—®ç†”æ–­æœºåˆ¶ï¼Ÿ</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2021-12-22 01:56:12</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/sharding/">sharding</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/">ShardingSphereæ ¸å¿ƒåŸç†ç²¾è®²</a>
                
            </div></div>
        <div class="post-content">
            <p>ä¸Šä¸€è¯¾æ—¶æˆ‘ä»¬è®¨è®ºäº† ShardingSphere ä¸­å…³äºé…ç½®ä¸­å¿ƒçš„ç›¸å…³å†…å®¹ã€‚ä»Šå¤©æˆ‘ä»¬ç»§ç»­è®¨è®ºç¼–æ’æ²»ç†æ¨¡å—çš„å¦ä¸€ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼Œå³æ³¨å†Œä¸­å¿ƒã€‚ç›¸è¾ƒé…ç½®ä¸­å¿ƒï¼Œæ³¨å†Œä¸­å¿ƒåœ¨ ShardingSphere ä¸­çš„åº”ç”¨æ›´ä¸ºå¹¿æ³›ã€‚</p>
<h3 id="shardingsphere-ä¸­çš„æ³¨å†Œä¸­å¿ƒå®ç°ç±»">ShardingSphere ä¸­çš„æ³¨å†Œä¸­å¿ƒå®ç°ç±»</h3>
<p>ä¸é…ç½®ä¸­å¿ƒä¸€æ ·ï¼ŒShardingSphere ä¸­çš„æ³¨å†Œä¸­å¿ƒåœ¨ä»£ç ç»“æ„ä¸Šä¹ŸåŒ…å«ä¸‰ä¸ªç‹¬ç«‹çš„å·¥ç¨‹ï¼Œå³ä»£è¡¨æŠ½è±¡æ¥å£çš„ API å·¥ç¨‹ï¼Œä»¥åŠä¸¤ä¸ªå…·ä½“çš„å®ç° nacos å’Œ zookeeper-curator å·¥ç¨‹ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡ŒåŒæ ·ä½¿ç”¨ä¸Šä¸€è¯¾æ—¶ä¸­ä»‹ç»çš„ Zookeeper ä½œä¸ºæ³¨å†Œä¸­å¿ƒçš„ä¸€ç§å®ç°æ–¹å¼ï¼Œè€Œå¦ä¸€ç§å®ç°æ–¹å¼å°±æ˜¯åŸºäºé˜¿é‡Œå·´å·´çš„ Nacosã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ ShardingSphere ä¸­å¯¹æ³¨å†Œä¸­å¿ƒçš„æŠ½è±¡ï¼Œå³å¦‚ä¸‹æ‰€ç¤ºçš„ RegistryCenter æ¥å£ï¼š</p>
<pre tabindex="0"><code>public interface RegistryCenter extends TypeBasedSPI {

    //æ ¹æ®é…ç½®ä¿¡æ¯åˆå§‹åŒ–æ³¨å†Œä¸­å¿ƒ

    void init(RegistryCenterConfiguration config);

    //è·å–æ•°æ®

    String get(String key);

    //ç›´æ¥è·å–æ•°æ®

    String getDirectly(String key);

    //æ˜¯å¦å­˜åœ¨æ•°æ®é¡¹

    boolean isExisted(String key);

    //è·å–å­æ•°æ®é¡¹åˆ—è¡¨

    List&lt;String&gt; getChildrenKeys(String key);

    //æŒä¹…åŒ–æ•°æ®é¡¹

    void persist(String key, String value);

    //æ›´æ–°æ•°æ®é¡¹

    void update(String key, String value);

    //æŒä¹…åŒ–ä¸´æ—¶æ•°æ®

    void persistEphemeral(String key, String value);

    //å¯¹æ•°æ®é¡¹æˆ–è·¯å¾„è¿›è¡Œç›‘å¬

    void watch(String key, DataChangedEventListener dataChangedEventListener);

    //å…³é—­æ³¨å†Œä¸­å¿ƒ

    void close();

    //å¯¹æ•°æ®é¡¹åˆå§‹åŒ–é”

    void initLock(String key);

    //å¯¹æ•°æ®é¡¹è·å–é”

    boolean tryLock();

    //å¯¹æ•°æ®é¡¹é‡Šæ”¾é”

    void tryRelease();

}
</code></pre><p>æˆ‘ä»¬å‘ç°ï¼Œé™¤äº†æœ€åå‡ ä¸ªå…³äºé”å¤„ç†çš„æ–¹æ³•ï¼ŒRegistryCenter å®é™…ä¸Šä¸ä¸Šä¸€è¯¾æ—¶ä¸­ä»‹ç»çš„ ConfigCenter éå¸¸ç±»ä¼¼ã€‚ä»è¿™ç‚¹ä¸Šï¼Œæˆ‘ä»¬å°±ä¸éš¾æƒ³è±¡ä¸ºä»€ä¹ˆ Zookeeper æ—¢å¯ä»¥ç”¨æ¥åšé…ç½®ä¸­å¿ƒï¼Œä¹Ÿå¯ä»¥æ˜¯å®ç°æ³¨å†Œä¸­å¿ƒçš„ä¸€ç§å…¸å‹æ–¹æ¡ˆã€‚æ²¿ç€è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬å°±å…ˆæ¥çœ‹ä¸€ä¸‹ CuratorZookeeperRegistryCenter è¿™ä¸ªåŸºäº Zookeeper çš„æ³¨å†Œä¸­å¿ƒå®ç°ç±»ã€‚</p>
<h4 id="1curatorzookeeperregistrycenter">1.CuratorZookeeperRegistryCenter</h4>
<p>æˆ‘ä»¬å¿«é€Ÿæµè§ˆæ•´ä¸ª CuratorZookeeperRegistryCenter ç±»ï¼Œå‘ç°é€šç”¨æ¥å£æ–¹æ³•çš„å®ç°è¿‡ç¨‹ä¹Ÿä¸ CuratorZookeeperConfigCenter ä¸­çš„å®Œå…¨ä¸€è‡´ã€‚è€Œå¯¹äºæ–°å¢çš„ä¸é”ç›¸å…³çš„å‡ ä¸ªæ–¹æ³•ï¼Œå®ç°æ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥ä½¿ç”¨ Curator æ‰€å°è£…çš„ InterProcessMutex å³å¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private InterProcessMutex leafLock;

 

@Override

public void initLock(final String key) {

        leafLock = new InterProcessMutex(client, key);

}

@Override

@SneakyThrows

public boolean tryLock() {

        return leafLock.acquire(5, TimeUnit.SECONDS);

}

@Override

@SneakyThrows

public void tryRelease() {

        leafLock.release();

}
</code></pre><p>å…³äº CuratorZookeeperRegistryCenter æˆ‘ä»¬å°±ä»‹ç»åˆ°è¿™é‡Œï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹æ³¨å†Œä¸­å¿ƒçš„å¦ä¸€ä¸ªå®ç°ç±» NacosRegistryCenterã€‚</p>
<h4 id="2nacosregistrycenter">2.NacosRegistryCenter</h4>
<p>Nacos æ¡†æ¶åŒæ ·æä¾›äº†ä¸€ä¸ªåä¸º ConfigService çš„å®¢æˆ·ç«¯ç»„ä»¶ï¼Œç”¨äºè·å–æ•°æ®çš„ getã€getDirectlyï¼Œä»¥åŠ isExisted æ–¹æ³•å®é™…ä¸Šéƒ½æ˜¯ä½¿ç”¨äº† ConfigService çš„ getConfig æ–¹æ³•è¿›è¡Œå®ç°ï¼Œæˆ‘ä»¬ä¹Ÿæ— é¡»å¯¹å…¶åšè¿‡å¤šçš„è®¨è®ºã€‚</p>
<p>NacosRegistryCenter çš„ persist æ–¹æ³•å®é™…ä¸Šå°±æ˜¯è°ƒç”¨äº†å®ƒçš„ update æ–¹æ³•ï¼Œè€Œåè€…åˆåŸºäº ConfigService çš„ publishConfig æ–¹æ³•å®ç°æ•°æ®çš„æ›´æ–°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@Override

public void persist(final String key, final String value) {

        update(key, value);

}

@Override

public void update(final String key, final String value) {

        try {

            String dataId = key.replace(&quot;/&quot;, &quot;.&quot;);

            String group = properties.getProperty(&quot;group&quot;, &quot;SHARDING_SPHERE_DEFAULT_GROUP&quot;);

            configService.publishConfig(dataId, group, value);

        } catch (final NacosException ex) {

            log.debug(&quot;exception for: {}&quot;, ex.toString());

        }

}
</code></pre><p>ä¸ Zookeeper ä¸åŒï¼Œå¯¹äº Nacos è€Œè¨€ï¼ŒgetChildrenKeysã€persistEphemeralã€closeã€initLockã€tryLock å’Œ tryRelease æ–¹æ³•éƒ½æ˜¯æ— æ³•å®ç°æˆ–æ— é¡»å®ç°çš„ã€‚è€Œå¯¹äº watch æ–¹æ³•ï¼ŒConfigService ä¹Ÿæä¾›äº† addListener æ–¹æ³•å®Œæˆç›‘å¬å™¨çš„ä½¿ç”¨ï¼ŒåŒæ ·ä¹Ÿæ˜¯åŸºäºä¸Šä¸€è¯¾æ—¶ä¸­ä»‹ç»çš„ DataChangedEventListener ç±»å®Œæˆäº‹ä»¶çš„å¤„ç†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@Override

public void watch(final String key, final DataChangedEventListener dataChangedEventListener) {

        try {

            String dataId = key.replace(&quot;/&quot;, &quot;.&quot;);

            String group = properties.getProperty(&quot;group&quot;, &quot;SHARDING_SPHERE_DEFAULT_GROUP&quot;);

            configService.addListener(dataId, group, new Listener() {

                @Override

                public Executor getExecutor() {

                    return null;

                }

                @Override

                public void receiveConfigInfo(final String configInfo) {

                    dataChangedEventListener.onChange(new DataChangedEvent(key, configInfo, DataChangedEvent.ChangedType.UPDATED));

                }

            });

        } catch (final NacosException ex) {

            log.debug(&quot;exception for: {}&quot;, ex.toString());

        }

}
</code></pre><p>è‡³æ­¤ï¼Œå…³äº ShardingSphere ä¸­æ³¨å†Œä¸­å¿ƒçš„ä¸¤ç§å®ç°æ–¹å¼æˆ‘ä»¬ä¹Ÿä»‹ç»å®Œæ¯•ã€‚è¯·æ³¨æ„ï¼Œæ³¨å†Œä¸­å¿ƒæœ¬èº«åªæ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå…³é”®æ˜¯çœ‹æˆ‘ä»¬å¦‚ä½•å¯¹å…¶è¿›è¡Œä½¿ç”¨ã€‚</p>
<h3 id="é€šè¿‡æ³¨å†Œä¸­å¿ƒæ„å»ºç¼–æ’æ²»ç†æœåŠ¡">é€šè¿‡æ³¨å†Œä¸­å¿ƒæ„å»ºç¼–æ’æ²»ç†æœåŠ¡</h3>
<p>è®©æˆ‘ä»¬æ¥åˆ° sharding-orchestration-core å·¥ç¨‹ï¼Œæ‰¾åˆ° RegistryCenterServiceLoaderï¼Œæ˜¾ç„¶ï¼Œè¿™ä¸ªç±»ç”¨äºåŠ è½½ RegistryCenter çš„ SPI å®ä¾‹ã€‚æˆ‘ä»¬åœ¨è¯¥ç±»çš„ load æ–¹æ³•ä¸­é€šè¿‡ SPI æœºåˆ¶åˆ›å»ºäº† RegistryCenter å®ä¾‹å¹¶è°ƒç”¨äº†å®ƒçš„ init æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public RegistryCenter load(final RegistryCenterConfiguration regCenterConfig) {

        Preconditions.checkNotNull(regCenterConfig, &quot;Registry center configuration cannot be null.&quot;);

        RegistryCenter result = newService(regCenterConfig.getType(), regCenterConfig.getProperties());

        result.init(regCenterConfig);

        return result;

}
</code></pre><p>ç„¶åæˆ‘ä»¬è·Ÿè¸ªä»£ç çš„è°ƒç”¨è¿‡ç¨‹ï¼Œå‘ç°ä½¿ç”¨ RegistryCenterServiceLoader ç±»çš„å…¥å£æ˜¯åœ¨åŒä¸€ä¸ªåŒ…ä¸­çš„ ShardingOrchestrationFacade ç±»ã€‚è¿™ä¸ªç±»ä»£ç ä¸å¤šï¼Œä½†å¼•å‡ºäº†å¾ˆå¤šæ–°çš„ç±»å’Œæ¦‚å¿µã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹å®ƒçš„å˜é‡å®šä¹‰ï¼š</p>
<pre tabindex="0"><code>//æ³¨å†Œä¸­å¿ƒ

private final RegistryCenter regCenter;

//é…ç½®æœåŠ¡

private final ConfigurationService configService;

//çŠ¶æ€æœåŠ¡

private final StateService stateService;

//ç›‘å¬ç®¡ç†å™¨

private final ShardingOrchestrationListenerManager listenerManager;
</code></pre><p>æˆ‘ä»¬å…ˆæ¥å…³æ³¨ ConfigurationService è¿™ä¸ªæ–°ç±»ï¼Œè¯¥ç±»å®é™…ä¸Šæ˜¯æ„å»ºåœ¨ RegistryCenter ä¹‹ä¸Šã€‚</p>
<h4 id="1configurationservice">1.ConfigurationService</h4>
<p>ConfigurationService ç±»å¯¹å¤–æä¾›äº†ç®¡ç†å„ç§é…ç½®ä¿¡æ¯çš„å…¥å£ã€‚åœ¨è¯¥ç±»ä¸­ï¼Œé™¤äº†ä¿å­˜ç€ RegistryCenter ä¹‹å¤–ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ª ConfigurationNode ç±»ï¼Œè¯¥ç±»å®šä¹‰äº†ä¿å­˜åœ¨æ³¨å†Œä¸­å¿ƒä¸­å„ç§æ•°æ®çš„é…ç½®é¡¹ä»¥åŠç®¡ç†è¿™äº›é…ç½®é¡¹çš„å·¥å…·æ–¹æ³•ï¼Œå…·ä½“çš„é…ç½®é¡¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private static final String ROOT = &quot;config&quot;;

private static final String SCHEMA_NODE = &quot;schema&quot;;

private static final String DATA_SOURCE_NODE = &quot;datasource&quot;;

private static final String RULE_NODE = &quot;rule&quot;;

private static final String AUTHENTICATION_NODE = &quot;authentication&quot;;

private static final String PROPS_NODE = &quot;props&quot;;

private final String name;
</code></pre><p>åŸºäº ShardingSphere ä¸­å¯¹è¿™äº›é…ç½®é¡¹çš„ç®¡ç†æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™äº›é…ç½®é¡¹ä¸å…·ä½“çš„å­˜å‚¨ç»“æ„ç›¸å¯¹åº”ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/Ciqc1F90KZeARJhmAACZRODYuiA394.png" alt="image"></p>
<p>æœ‰äº†é…ç½®é¡¹ä¹‹åï¼Œæˆ‘ä»¬å°±éœ€è¦å¯¹å…¶è¿›è¡Œä¿å­˜ï¼ŒConfigurationService çš„ persistConfiguration æ–¹æ³•å®Œæˆäº†è¿™ä¸€ç›®çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public void persistConfiguration(final String shardingSchemaName, final Map&lt;String, DataSourceConfiguration&gt; dataSourceConfigs, final RuleConfiguration ruleConfig,

                                     final Authentication authentication, final Properties props, final boolean isOverwrite) {

        persistDataSourceConfiguration(shardingSchemaName, dataSourceConfigs, isOverwrite);

        persistRuleConfiguration(shardingSchemaName, ruleConfig, isOverwrite);

        persistAuthentication(authentication, isOverwrite);

        persistProperties(props, isOverwrite);

}
</code></pre><p>è¿™é‡Œåˆ—ä¸¾äº†å››ä¸ª persist æ–¹æ³•ï¼Œåˆ†åˆ«ç”¨äºä¿å­˜ DataSourceã€Ruleã€Authentication ä»¥åŠ Propertiesã€‚æˆ‘ä»¬ä»¥ persistDataSourceConfiguration æ–¹æ³•ä¸ºä¾‹æ¥çœ‹å®ƒçš„å®ç°è¿‡ç¨‹ï¼š</p>
<pre tabindex="0"><code>private void persistDataSourceConfiguration(final String shardingSchemaName, final Map&lt;String, DataSourceConfiguration&gt; dataSourceConfigurations, final boolean isOverwrite) {

        //åˆ¤æ–­æ˜¯å¦è¦†ç›–ç°æœ‰é…ç½®

         if (isOverwrite || !hasDataSourceConfiguration(shardingSchemaName)) {

            Preconditions.checkState(null != dataSourceConfigurations &amp;&amp; !dataSourceConfigurations.isEmpty(), &quot;No available data source in `%s` for orchestration.&quot;, shardingSchemaName);

            //æ„å»º YamlDataSourceConfiguration

            Map&lt;String, YamlDataSourceConfiguration&gt; yamlDataSourceConfigurations = Maps.transformValues(dataSourceConfigurations, 

                    new Function&lt;DataSourceConfiguration, YamlDataSourceConfiguration&gt;() {

                        @Override

                        public YamlDataSourceConfiguration apply(final DataSourceConfiguration input) {

                            return new DataSourceConfigurationYamlSwapper().swap(input);

                        }

                    }

            );

            //é€šè¿‡æ³¨å†Œä¸­å¿ƒè¿›è¡ŒæŒä¹…åŒ–

            regCenter.persist(configNode.getDataSourcePath(shardingSchemaName), YamlEngine.marshal(yamlDataSourceConfigurations));

        }

}
</code></pre><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä½¿ç”¨äº† Guava æ¡†æ¶ä¸­çš„ Maps.transformValueså·¥å…·æ–¹æ³•å°†è¾“å…¥çš„ DataSourceConfiguration ç±»è½¬æ¢æˆäº† YamlDataSourceConfiguration ç±»ï¼Œè€Œè½¬æ¢çš„è¿‡ç¨‹åˆ™å€ŸåŠ©äº DataSourceConfigurationYamlSwapper ç±»ã€‚å…³äº ShardingSphere ä¸­çš„ YamlSwapper æ¥å£ä»¥åŠå„ç§å®ç°ç±»æˆ‘ä»¬å·²ç»åœ¨ã€Š05 | é…ç½®é©±åŠ¨ï¼šShardingSphere ä¸­çš„é…ç½®ä½“ç³»æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Ÿã€‹ä¸­è¿›è¡Œäº†è¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œåªéœ€è¦æ˜ç¡®ï¼Œé€šè¿‡ DataSourceConfigurationYamlSwapper èƒ½å¤ŸæŠŠ Yaml é…ç½®æ–‡ä»¶ä¸­çš„ DataSource é…ç½®è½¬åŒ–ä¸º YamlDataSourceConfiguration ç±»ã€‚</p>
<p>å½“è·å–äº†æ‰€éœ€çš„ YamlDataSourceConfiguration ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨æ³¨å†Œä¸­å¿ƒçš„ persist æ–¹æ³•å®Œæˆæ•°æ®çš„æŒä¹…åŒ–ï¼Œè¿™å°±æ˜¯ persistDataSourceConfiguration æ–¹æ³•ä¸­æœ€åä¸€å¥ä»£ç çš„ä½œç”¨ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åŒæ ·éœ€è¦æŠŠ YamlDataSourceConfiguration æ•°æ®ç»“æ„è½¬æ¢ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¿™éƒ¨åˆ†å·¥ä½œæ˜¯ç”± YamlEngine æ¥å®Œæˆã€‚å…³äº YamlEngine çš„ä»‹ç»æˆ‘ä»¬ä¹Ÿå¯ä»¥å›é¡¾ã€Š05 | é…ç½®é©±åŠ¨ï¼šShardingSphere ä¸­çš„é…ç½®ä½“ç³»æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Ÿã€‹ä¸­çš„å†…å®¹ã€‚</p>
<p>ConfigurationService ä¸­å…¶ä»–æ–¹æ³•çš„å¤„ç†è¿‡ç¨‹ä¸ persistDataSourceConfiguration æ–¹æ³•æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯æ‰€ä½¿ç”¨çš„æ•°æ®ç±»å‹å’Œç»“æ„æœ‰æ‰€ä¸åŒï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<h4 id="2stateservice">2.StateService</h4>
<p>ä»‹ç»å®Œ ConfigurationService ç±»ä¹‹åï¼Œæˆ‘ä»¬æ¥å…³æ³¨ ShardingOrchestrationFacade ç±»ä¸­çš„å¦ä¸€ä¸ªæ ¸å¿ƒå˜é‡ StateServiceã€‚</p>
<p>ä»å‘½åä¸Šè®²ï¼ŒStateService è¿™ä¸ªç±»åæœ‰ç‚¹æ¨¡ç³Šï¼Œæ›´åˆé€‚çš„å«æ³•åº”è¯¥æ˜¯ InstanceStateServiceï¼Œç”¨äºç®¡ç†æ•°æ®åº“å®ä¾‹çš„çŠ¶æ€ï¼Œå³åˆ›å»ºæ•°æ®åº“è¿è¡ŒèŠ‚ç‚¹å¹¶åŒºåˆ†ä¸åŒæ•°æ®åº“è®¿é—®å®ä¾‹ã€‚å­˜æ”¾åœ¨æ³¨å†Œä¸­å¿ƒä¸­çš„æ•°æ®ç»“æ„åŒ…æ‹¬ instances å’Œ datasources èŠ‚ç‚¹ï¼Œå­˜å‚¨ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/CgqCHl90KaaAYI5wAABQK1SKfyo990.png" alt="image"></p>
<p>StateService ä¸­ä¿å­˜ç€ StateNode å¯¹è±¡ï¼ŒStateNode ä¸­çš„å˜é‡ä¸ä¸Šé¢çš„æ•°æ®ç»“æ„ç¤ºä¾‹ç›¸å¯¹åº”ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private static final String ROOT = &quot;state&quot;;

private static final String INSTANCES_NODE_PATH = &quot;instances&quot;;

private static final String DATA_SOURCES_NODE_PATH = &quot;datasources&quot;;

private final String name;
</code></pre><p>StateService åŒæ—¶è¿˜ä¿å­˜ç€ OrchestrationInstance å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç”¨äºæ ¹æ®ä½ çš„ IP åœ°å€ã€PIDã€ä¸€ä¸² UUID ä»¥åŠåˆ†éš”ç¬¦@æ„å»º instanceIdï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>instanceId = IpUtils.getIp() + DELIMITER + ManagementFactory.getRuntimeMXBean().getName().split(DELIMITER)[0] + DELIMITER + UUID.randomUUID().toString();
</code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒStateService ä¸­å¯¹äº instanceså’Œ datasources çš„ä¿å­˜æœºåˆ¶æ˜¯ä¸ä¸€æ ·çš„ï¼š</p>
<pre tabindex="0"><code>//ä½¿ç”¨ä¸´æ—¶èŠ‚ç‚¹ä¿å­˜ Instance

public void persistInstanceOnline() {

        regCenter.persistEphemeral(stateNode.getInstancesNodeFullPath(instance.getInstanceId()), &quot;&quot;);

    }

    //ä½¿ç”¨æŒä¹…åŒ–èŠ‚ç‚¹ä¿å­˜DataSource

    public void persistDataSourcesNode() {

        regCenter.persist(stateNode.getDataSourcesNodeFullRootPath(), &quot;&quot;);

}
</code></pre><p>å¯ä»¥çœ‹åˆ°ä¿å­˜ Instance ç”¨çš„æ˜¯ RegistryCenter ä¸­åŸºäºä¸´æ—¶èŠ‚ç‚¹çš„ persistEphemeral æ–¹æ³•ï¼Œè€Œä¿å­˜ DataSources ç”¨çš„æ˜¯åŸºäºæŒä¹…åŒ–èŠ‚ç‚¹çš„ persist æ–¹æ³•ï¼Œè¿™æ ·å¤„ç†æ˜¯æœ‰åŸå› çš„ã€‚åœ¨å¯ç”¨æ€§è®¾è®¡ä¸Šï¼Œè¿è¡Œå®ä¾‹ä¸€èˆ¬å‡å¯ä»¥æ ‡è¯†ä¸ºä¸´æ—¶èŠ‚ç‚¹ï¼Œå½“å®ä¾‹ä¸Šçº¿æ—¶æ³¨å†Œï¼Œä¸‹çº¿æ—¶è‡ªåŠ¨æ¸…ç†ã€‚</p>
<h4 id="3shardingorchestrationlistenermanager">3.ShardingOrchestrationListenerManager</h4>
<p>æˆ‘ä»¬æ¥ç€æ¥çœ‹ ShardingOrchestrationFacade ä¸­çš„æœ€åä¸€ä¸ªå˜é‡ ShardingOrchestrationListenerManagerï¼Œä»å‘½åä¸Šçœ‹è¯¥ç±»ç”¨äºç®¡ç†å„ç§å¤„ç†å˜æ›´äº‹ä»¶çš„ç›‘å¬å™¨ Listenerã€‚è€Œä»å‰é¢çš„åˆ†æï¼Œæˆ‘ä»¬ä¸éš¾çœ‹å‡ºç³»ç»Ÿä¸­åº”è¯¥å­˜åœ¨ä¸¤å¤§ç±»çš„ Listenerï¼Œä¸€ç±»ç”¨äºç›‘å¬é…ç½®ä¿¡æ¯çš„å˜æ›´ï¼Œä¸€ç±»ç”¨äºç›‘å¬å®ä¾‹çŠ¶æ€çš„å˜æ›´ã€‚</p>
<p>æœç„¶ï¼Œåœ¨ ShardingOrchestrationListenerManager ä¸­ï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥æ‰¾åˆ°äº†ä¸¤ä¸ª ListenerManagerï¼Œå³ ConfigurationChangedListenerManager å’Œ StateChangedListenerManagerï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class ShardingOrchestrationListenerManager {

    //é…ç½®å˜æ›´ç›‘å¬ç®¡ç†å™¨

    private final ConfigurationChangedListenerManager configurationChangedListenerManager;

    //çŠ¶æ€å˜æ›´ç›‘å¬ç®¡ç†å™¨

    private final StateChangedListenerManager stateChangedListenerManager;

    public ShardingOrchestrationListenerManager(final String name, final RegistryCenter regCenter, final Collection&lt;String&gt; shardingSchemaNames) {

        configurationChangedListenerManager = new ConfigurationChangedListenerManager(name, regCenter, shardingSchemaNames);

        stateChangedListenerManager = new StateChangedListenerManager(name, regCenter);

    }

    public void initListeners() {

        configurationChangedListenerManager.initListeners();

        stateChangedListenerManager.initListeners();

    }

}
</code></pre><p>æˆ‘ä»¬åˆ›å»ºäº†è¿™ä¸¤ä¸ª ListenerManagerï¼Œå¹¶è°ƒç”¨å…¶ initListeners æ–¹æ³•è¿›è¡Œäº†åˆå§‹åŒ–ã€‚ä»¥ ConfigurationChangedListenerManager ä¸ºä¾‹ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒå†…éƒ¨çš„ç»“æ„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class ConfigurationChangedListenerManager {

    private final SchemaChangedListener schemaChangedListener;

    private final PropertiesChangedListener propertiesChangedListener;

    private final AuthenticationChangedListener authenticationChangedListener;

    public ConfigurationChangedListenerManager(final String name, final RegistryCenter regCenter, final Collection&lt;String&gt; shardingSchemaNames) {

        schemaChangedListener = new SchemaChangedListener(name, regCenter, shardingSchemaNames);

        propertiesChangedListener = new PropertiesChangedListener(name, regCenter);

        authenticationChangedListener = new AuthenticationChangedListener(name, regCenter);

    }

    public void initListeners() {

        schemaChangedListener.watch(ChangedType.UPDATED, ChangedType.DELETED);

        propertiesChangedListener.watch(ChangedType.UPDATED);

        authenticationChangedListener.watch(ChangedType.UPDATED);

    }

}
</code></pre><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå®šä¹‰äº† SchemaChangedListenerã€PropertiesChangedListener å’Œ AuthenticationChangedListener è¿™ä¸‰ä¸ª Listenerã€‚æ˜¾ç„¶ï¼Œå®ƒä»¬å¯¹åº” ConfigurationService ä¸­ä»‹ç»çš„é…ç½®ç»“æ„ä¸­çš„ä¸‰å¤§é¡¶å±‚é…ç½®é¡¹ schemaã€props å’Œ authenticationã€‚ç„¶åï¼Œå¯¹äºè¿™ä¸‰ç§é…ç½®é¡¹ï¼Œæˆ‘ä»¬åˆ†åˆ«æ ¹æ®éœ€è¦å¯¹å…·ä½“æŸä¸€ä¸ªæ“ä½œæ·»åŠ ç›‘è§†ã€‚ä»ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äº schema é…ç½®é¡¹è€Œè¨€ï¼Œå½“è¿›è¡Œ UPDATE å’Œ DELETE æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å“åº”äº‹ä»¶ï¼›è€Œå¯¹äº props å’Œ authentication é…ç½®é¡¹è€Œè¨€ï¼Œåˆ™åªéœ€å…³æ³¨ UPDATE æ“ä½œã€‚</p>
<p>å› ä¸ºè¿™äº›å…·ä½“çš„äº‹ä»¶ä»¥åŠç›‘å¬æœºåˆ¶çš„å¤„ç†æ–¹å¼å¤§åŒå°å¼‚ï¼Œå› æ­¤æˆ‘ä»¬å°±ä»¥ SchemaChangedListener ä¸ºä¾‹è¿›è¡Œè¿›ä¸€æ­¥åˆ†æã€‚SchemaChangedListener ç»§æ‰¿è‡ª PostShardingOrchestrationEventListener æŠ½è±¡ç±»ï¼Œè€Œåè€…åˆå®ç°äº† ShardingOrchestrationListener æ¥å£ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹è¿™ä¸ªæ¥å£çš„å®šä¹‰ï¼š</p>
<pre tabindex="0"><code>public interface ShardingOrchestrationListener {

    //ç›‘å¬äº‹ä»¶

    void watch(ChangedType... watchedChangedTypes);

}
</code></pre><p>PostShardingOrchestrationEventListener å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œå…¶å®ç°è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public abstract class PostShardingOrchestrationEventListener implements ShardingOrchestrationListener {

    //åˆ›å»º EventBus

    private final EventBus eventBus = ShardingOrchestrationEventBus.getInstance();

    private final RegistryCenter regCenter;

    private final String watchKey;

    @Override

    public final void watch(final ChangedType... watchedChangedTypes) {

        final Collection&lt;ChangedType&gt; watchedChangedTypeList = Arrays.asList(watchedChangedTypes);

        regCenter.watch(watchKey, new DataChangedEventListener() {

            @Override

            public void onChange(final DataChangedEvent dataChangedEvent) {

                if (watchedChangedTypeList.contains(dataChangedEvent.getChangedType())) {

                  //é€šè¿‡ EventBus å‘å¸ƒäº‹ä»¶

                    eventBus.post(createShardingOrchestrationEvent(dataChangedEvent));

                }

            }

        });

    }

    protected abstract ShardingOrchestrationEvent createShardingOrchestrationEvent(DataChangedEvent event);

}
</code></pre><p>ä¸Šè¿°ä»£ç çš„æ ¸å¿ƒæœºåˆ¶æ˜¯é€šè¿‡ RegistryCenter çš„ watch æ–¹æ³•ä¸ºå…·ä½“çš„äº‹ä»¶æ·»åŠ äº‹ä»¶å¤„ç†ç¨‹åºï¼Œè€Œè¿™ä¸ªäº‹ä»¶å¤„ç†è¿‡ç¨‹å°±æ˜¯é€šè¿‡ Guava ä¸­çš„ EventBus ç±»çš„ post æ–¹æ³•å°†äº‹ä»¶è¿›è¡Œè¿›ä¸€æ­¥è½¬å‘ã€‚è‡³äºæ‰€éœ€è¦è½¬å‘çš„å…·ä½“äº‹ä»¶ç±»å‹ç”±æŠ½è±¡æ–¹æ³• createShardingOrchestrationEvent æ¥æä¾›ï¼ŒPostShardingOrchestrationEventListener çš„å„ä¸ªå­ç±»éœ€è¦å®ç°è¿™ä¸ªæŠ½è±¡æ–¹æ³•ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ PostShardingOrchestrationEventListener çš„å­ç±» SchemaChangedListener å¯¹äº‹ä»¶åˆ›å»ºè¿‡ç¨‹çš„å¤„ç†æ–¹æ³•ï¼Œè¿™é‡Œä»¥ createDataSourceChangedEvent æ–¹æ³•ä¸ºä¾‹è¿›è¡Œå±•å¼€ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒå…¸å‹çš„åˆ›å»ºäº‹ä»¶çš„æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>private DataSourceChangedEvent createDataSourceChangedEvent(final String shardingSchemaName, final DataChangedEvent event) {

        Map&lt;String, YamlDataSourceConfiguration&gt; dataSourceConfigurations = (Map) YamlEngine.unmarshal(event.getValue());

        Preconditions.checkState(null != dataSourceConfigurations &amp;&amp; !dataSourceConfigurations.isEmpty(), &quot;No available data sources to load for orchestration.&quot;);

       //åˆ›å»ºDataSourceChangedEvent

        return new DataSourceChangedEvent(shardingSchemaName, Maps.transformValues(dataSourceConfigurations, new Function&lt;YamlDataSourceConfiguration, DataSourceConfiguration&gt;() {

            @Override

            public DataSourceConfiguration apply(final YamlDataSourceConfiguration input) {

                return new DataSourceConfigurationYamlSwapper().swap(input);

            }

        }));

}
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå†æ¬¡ç”¨åˆ°äº†å‰é¢æåˆ°çš„ YamlDataSourceConfiguration ä»¥åŠ YamlEngineï¼Œä¸åŒçš„æ˜¯è¿™æ¬¡çš„å¤„ç†æµç¨‹æ˜¯ä» YamlDataSourceConfiguration åˆ° DataSourceConfigurationã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ª DataSourceChangedEventï¼ŒåŒ…å«äº† shardingSchemaName ä»¥åŠä¸€ä¸ª dataSourceConfigurations å¯¹è±¡ã€‚</p>
<p>å…³äºæ•´ä¸ª Listener æœºåˆ¶ï¼Œå¯ä»¥ç®€å•å½’çº³ä¸ºé€šè¿‡ç›‘å¬æ³¨å†Œä¸­å¿ƒä¸Šç›¸å…³æ•°æ®é¡¹çš„æ“ä½œæƒ…å†µæ¥ç”Ÿæˆå…·ä½“çš„äº‹ä»¶ï¼Œå¹¶å¯¹äº‹ä»¶è¿›è¡ŒåŒ…è£…ä¹‹åå†è¿›è¡Œè½¬å‘ã€‚è‡³äºå¦‚ä½•å¤„ç†è¿™äº›è½¬å‘åçš„äº‹ä»¶ï¼Œå–å†³äºå…·ä½“çš„åº”ç”¨åœºæ™¯ï¼Œå…¸å‹çš„ä¸€ä¸ªåº”ç”¨åœºæ™¯å°±æ˜¯æ§åˆ¶æ•°æ®è®¿é—®çš„ç†”æ–­ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸‹ã€‚</p>
<h3 id="æ³¨å†Œä¸­å¿ƒçš„åº”ç”¨æ•°æ®è®¿é—®ç†”æ–­æœºåˆ¶">æ³¨å†Œä¸­å¿ƒçš„åº”ç”¨ï¼šæ•°æ®è®¿é—®ç†”æ–­æœºåˆ¶</h3>
<p>ShardingOrchestrationFacade æ˜¯ä¸€ä¸ªå…¸å‹çš„å¤–è§‚ç±»ï¼Œé€šè¿‡åˆ†æä»£ç çš„è°ƒç”¨å…³ç³»ï¼Œæˆ‘ä»¬å‘ç°è¯¥ç±»çš„åˆ›å»ºè¿‡ç¨‹éƒ½å‘ç”Ÿåœ¨ sharding-jdbc-orchestration å·¥ç¨‹çš„å‡ ä¸ª DataSource ç±»ä¸­ã€‚æˆ‘ä»¬å…ˆæ¥åˆ° AbstractOrchestrationDataSource è¿™ä¸ªæŠ½è±¡ç±»ï¼Œè¯¥ç±»çš„æ ¸å¿ƒå˜é‡å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private final ShardingOrchestrationFacade shardingOrchestrationFacade;

//æ˜¯å¦ç†”æ–­

private boolean isCircuitBreak;

private final Map&lt;String, DataSourceConfiguration&gt; dataSourceConfigurations = new LinkedHashMap&lt;&gt;();
</code></pre><p>æ³¨æ„åˆ°è¿™é‡Œè¿˜æœ‰ä¸€ä¸ª isCircuitBreak å˜é‡ï¼Œç”¨æ¥è¡¨ç¤ºæ˜¯å¦éœ€è¦è¿›è¡Œç†”æ–­ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¼šå¯¹ç†”æ–­æœºåˆ¶ä»¥åŠè¯¥å˜é‡çš„ä½¿ç”¨æ–¹æ³•åšè¯¦ç»†å±•å¼€ã€‚</p>
<p>æˆ‘ä»¬ç»§ç»­æ¥çœ‹ AbstractOrchestrationDataSource çš„æ„é€ å‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public AbstractOrchestrationDataSource(final ShardingOrchestrationFacade shardingOrchestrationFacade) {

        this.shardingOrchestrationFacade = shardingOrchestrationFacade;

        //é€šè¿‡ EventBus æ³¨å†Œè‡ªå·±

        ShardingOrchestrationEventBus.getInstance().register(this);

}
</code></pre><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œç”¨åˆ°äº† Guava ä¸­ EventBus çš„ register æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ç”¨äºå¯¹æ³¨å†Œäº‹ä»¶çš„è®¢é˜…ã€‚åœ¨å‰é¢çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬ç•™ä¸‹äº†ä¸€ä¸ªç–‘é—®ï¼Œå³<strong>æ‰€åˆ›å»ºçš„è¿™äº› ShardingOrchestrationEvent æ˜¯å¦‚ä½•è¢«å¤„ç†çš„å‘¢ï¼Ÿ</strong></p>
<p>ç­”æ¡ˆå°±åœ¨è¿™é‡Œè¿›è¡Œäº†æ­æ™“ï¼Œå³æ‰€æœ‰é€šè¿‡ EventBus çš„ post æ–¹æ³•æ‰€å‘å¸ƒçš„äº‹ä»¶çš„æœ€ç»ˆæ¶ˆè´¹è€…å°±æ˜¯è¿™ä¸ª AbstractOrchestrationDataSource ç±»ä»¥åŠå®ƒçš„å„ä¸ªå­ç±»ã€‚è€Œåœ¨ AbstractOrchestrationDataSource ç±»ä¸­å°±å­˜åœ¨äº†å¦‚ä¸‹æ‰€ç¤ºçš„ renew æ–¹æ³•ï¼Œç”¨äºå¤„ç† CircuitStateChangedEvent äº‹ä»¶ï¼š</p>
<pre tabindex="0"><code>@Subscribe

public final synchronized void renew(final CircuitStateChangedEvent circuitStateChangedEvent) {

        isCircuitBreak = circuitStateChangedEvent.isCircuitBreak();

}
</code></pre><p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸Šæ·»åŠ äº† @Subscribe æ³¨è§£ï¼Œå³ä¸€æ—¦åœ¨ç³»ç»Ÿä¸­ç”Ÿæˆäº† CircuitStateChangedEvent äº‹ä»¶ï¼Œè¿™ä¸ªæ–¹æ³•å°±å¯ä»¥è‡ªåŠ¨å“åº”è¿™ç±»äº‹ä»¶ã€‚åœ¨è¿™ä¸ªå¤„ç†æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°å®ƒä» CircuitStateChangedEvent äº‹ä»¶ä¸­è·å–äº†æ˜¯å¦ç†”æ–­çš„ä¿¡æ¯å¹¶èµ‹å€¼ç»™å‰é¢ä»‹ç»çš„ isCircuitBreak å˜é‡ã€‚</p>
<p>åœ¨ AbstractOrchestrationDataSource çš„ getConnection æ–¹æ³•ä¸­è°ƒç”¨äº† getDataSource æŠ½è±¡æ–¹æ³•ä»¥è·å–ç‰¹å®šçš„ DataSourceï¼Œè¿›è€Œè·å–ç‰¹å®šçš„ Connectionï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@Override

public final Connection getConnection() throws SQLException {

        return isCircuitBreak ? new CircuitBreakerDataSource().getConnection() : getDataSource().getConnection();

}
</code></pre><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°äº† isCircuitBreak å˜é‡çš„ä½œç”¨ã€‚å½“è¯¥å˜é‡ä¸ºçœŸæ—¶ï¼Œæˆ‘ä»¬è¿”å›çš„æ˜¯ä¸€ä¸ªç‰¹å®šçš„ CircuitBreakerDataSource ç”¨äºå®Œæˆç†”æ–­æ“ä½œã€‚æ‰€è°“ç†”æ–­ï¼Œå…¶ä½œç”¨ç±»ä¼¼äºæˆ‘ä»¬å®¶ç”¨çš„ä¿é™©ä¸ï¼Œå½“æŸä¸ªæœåŠ¡å‡ºç°ä¸å¯ç”¨æˆ–å“åº”è¶…æ—¶çš„æƒ…å†µæ—¶ï¼Œä¸ºäº†é˜²æ­¢æ•´ä¸ªç³»ç»Ÿå‡ºç°é›ªå´©ï¼Œæš‚æ—¶åœæ­¢å¯¹è¯¥æœåŠ¡çš„è°ƒç”¨ã€‚</p>
<p>é‚£ä¹ˆ ShardingSphere å¦‚ä½•å®ç°è¿™ä¸€ç‚¹å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ CircuitBreakerDataSource ç±»ï¼Œ å®ƒçš„å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class CircuitBreakerDataSource extends AbstractUnsupportedOperationDataSource implements AutoCloseable {

    @Override

    public void close() {

    }

    @Override

    public Connection getConnection() {

        return new CircuitBreakerConnection();

    }

    @Override

    public Connection getConnection(final String username, final String password) {

        return new CircuitBreakerConnection();

    }

    @Override

    public PrintWriter getLogWriter() {

        return null;

    }

    @Override

    public void setLogWriter(final PrintWriter out) {

    }

    @Override

    public Logger getParentLogger() {

        return null;

    }

}
</code></pre><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªç±»çš„ getConnection æ–¹æ³•è¿”å›äº†ä¸€ä¸ª CircuitBreakerConnectionï¼Œè€Œè¿™ä¸ª CircuitBreakerConnection ä¸­çš„ createStatement å’Œ prepareStatement æ–¹æ³•åˆ†åˆ«è¿”å›äº† CircuitBreakerStatement å’Œ CircuitBreakerPreparedStatementï¼Œæˆ‘ä»¬å‘ç°è¿™äº› Statement ç±»ä»¥åŠä»£è¡¨æ‰§è¡Œç»“æœçš„ CircuitBreakerResultSet ç±»åŸºæœ¬éƒ½æ˜¯ç©ºå®ç°ï¼Œå³ä¸ä¼šå¯¹æ•°æ®åº“æ‰§è¡Œä»»ä½•å…·ä½“çš„æ“ä½œï¼Œç›¸å½“äºå®ç°äº†è®¿é—®çš„ç†”æ–­ã€‚</p>
<p>é‚£ä¹ˆå›åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå³ä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘ç†”æ–­æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯ä»€ä¹ˆæ—¶å€™ä¼šå‘é€è¿™ä¸ª CircuitStateChangedEvent äº‹ä»¶å‘¢ï¼Ÿè®©æˆ‘ä»¬è·Ÿè¸ªè¿™ä¸ªäº‹ä»¶çš„åˆ›å»ºè¿‡ç¨‹ï¼Œæ¥åˆ°äº†å¦‚ä¸‹æ‰€ç¤ºçš„ InstanceStateChangedListener ç±»ï¼š</p>
<pre tabindex="0"><code>public final class InstanceStateChangedListener extends PostShardingOrchestrationEventListener {

    public InstanceStateChangedListener(final String name, final RegistryCenter regCenter) {

        super(regCenter, new StateNode(name).getInstancesNodeFullPath(OrchestrationInstance.getInstance().getInstanceId()));

    }

    @Override

    protected CircuitStateChangedEvent createShardingOrchestrationEvent(final DataChangedEvent event) {

        return new CircuitStateChangedEvent(StateNodeStatus.DISABLED.toString().equalsIgnoreCase(event.getValue()));

    }

}
</code></pre><p>é€šè¿‡ä¸Šè¿°ä»£ç ï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°å½“ StateNodeStatus ä¸º DISABLED æ—¶ï¼Œä¹Ÿå°±æ˜¯å½“å‰çš„èŠ‚ç‚¹å·²ç»ä¸å¯ç”¨æ—¶ä¼šå‘é€ CircuitStateChangedEventï¼Œä»è€Œè§¦å‘ç†”æ–­æœºåˆ¶ã€‚</p>
<h3 id="ä»æºç è§£æåˆ°æ—¥å¸¸å¼€å‘">ä»æºç è§£æåˆ°æ—¥å¸¸å¼€å‘</h3>
<p>ä»Šå¤©çš„å†…å®¹è™½ç„¶å…³æ³¨çš„æ˜¯æ³¨å†Œä¸­å¿ƒï¼Œä½†åœ¨ç¯‡å¹…ä¸Šå®é™…ä¸Šæ›´å¤šçš„æ˜¯åœ¨è®¨è®º<strong>åŸºäºäº‹ä»¶é©±åŠ¨æ¶æ„çš„è®¾è®¡å’Œå®ç°æ–¹æ³•</strong>ã€‚åŸºäºé…ç½®ä¿¡æ¯ï¼Œä»¥åŠæ•°æ®åº“å®ä¾‹ä¿¡æ¯çš„å˜æ›´æƒ…å†µï¼ŒShardingSphere æŠ½è±¡äº†ä¸€å¥—å®Œæ•´çš„äº‹ä»¶å‘é€å’Œæ¶ˆè´¹æœºåˆ¶ï¼Œæ¥å®ç°è¯¸å¦‚æ•°æ®è®¿é—®ç†”æ–­ç­‰éåŠŸèƒ½æ€§éœ€æ±‚ã€‚</p>
<p>æˆ‘ä»¬æ³¨æ„åˆ° ShardingSphere å®ç°äº‹ä»¶é©±åŠ¨æ¶æ„æ—¶ä½¿ç”¨äº† Guava æ¡†æ¶ä¸­çš„ EventBus å·¥å…·ç±»ï¼Œåœ¨æ—¥å¸¸å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªç±»æ¥æ„å»ºè‡ªå®šä¹‰çš„äº‹ä»¶å¤„ç†æœºåˆ¶ã€‚</p>
<h3 id="å°ç»“ä¸é¢„å‘Š">å°ç»“ä¸é¢„å‘Š</h3>
<p>æ³¨å†Œä¸­å¿ƒæ˜¯ ShardingSphere ç¼–æ’æ²»ç†æœºåˆ¶ä¸­çš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ï¼Œä½†æ³¨å†Œä¸­å¿ƒæœ¬èº«ä¹Ÿåªæ˜¯ä¸€ä¸ªå·¥å…·ï¼Œéœ€è¦æ ¹æ®ä¸åŒçš„ä¸šåŠ¡åœºæ™¯æ¥è®¾è®¡å¯¹åº”çš„åº”ç”¨æ–¹å¼ã€‚åœ¨ ShardingSphere ä¸­ï¼Œé…ç½®ä¿¡æ¯ç®¡ç†ä»¥åŠæ•°æ®åº“å®ä¾‹ç®¡ç†å°±æ˜¯å…¸å‹çš„åº”ç”¨åœºæ™¯ï¼Œæˆ‘ä»¬åŸºäºè¿™äº›åœºæ™¯è¯¦ç»†åˆ†æäº†åŸºäºæ³¨å†Œä¸­å¿ƒçš„äº‹ä»¶é©±åŠ¨æ¶æ„çš„è®¾è®¡å’Œå®ç°æ–¹æ³•ï¼Œå¹¶ç»™å‡ºäº†åŸºäºæ•°æ®è®¿é—®ç†”æ–­æœºåˆ¶çš„æ¡ˆä¾‹åˆ†æã€‚</p>
<p>è¿™é‡Œç»™ä½ ç•™ä¸€é“æ€è€ƒé¢˜ï¼šåœ¨ ShardingSphere ä¸­ï¼Œå¦‚ä½•æŠŠæœåŠ¡å®ä¾‹çš„çŠ¶æ€ä¸æ³¨å†Œä¸­å¿ƒæ•´åˆåœ¨ä¸€èµ·è¿›è¡Œç¼–æ’æ²»ç†ï¼Ÿ</p>
<p>åœ¨ä¸‹ä¸€è¯¾æ—¶ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç» ShardingSphere ç¼–æ’æ²»ç†ä¸­çš„å¦ä¸€ä¸ªé‡è¦ä¸»é¢˜ï¼Œå³æœåŠ¡è®¿é—®çš„é“¾è·¯ç›‘æ§å’Œè·Ÿè¸ªæœºåˆ¶ã€‚</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/31-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E7%9A%84%E5%8A%A8%E6%80%81%E5%8C%96%E7%AE%A1%E7%90%86/"><span>31 é…ç½®ä¸­å¿ƒï¼šå¦‚ä½•åŸºäºé…ç½®ä¸­å¿ƒå®ç°é…ç½®ä¿¡æ¯çš„åŠ¨æ€åŒ–ç®¡ç†ï¼Ÿ</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/33-%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E-hook-%E6%9C%BA%E5%88%B6%E4%BB%A5%E5%8F%8A-opentracing-%E5%8D%8F%E8%AE%AE%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA/"><span>33 é“¾è·¯è·Ÿè¸ªï¼šå¦‚ä½•åŸºäº Hook æœºåˆ¶ä»¥åŠ OpenTracing åè®®å®ç°æ•°æ®è®¿é—®é“¾è·¯è·Ÿè¸ªï¼Ÿ</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 27270 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>