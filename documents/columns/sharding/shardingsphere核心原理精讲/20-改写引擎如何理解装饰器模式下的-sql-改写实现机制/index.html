<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>20 æ”¹å†™å¼•æ“ï¼šå¦‚ä½•ç†è§£è£…é¥°å™¨æ¨¡å¼ä¸‹çš„ SQL æ”¹å†™å®ç°æœºåˆ¶ï¼Ÿ | Yipsen Ye</title>
<meta name="description" content="å›æƒ³åœ¨â€œ17 | è·¯ç”±å¼•æ“ï¼šå¦‚ä½•ç†è§£åˆ†ç‰‡è·¯ç”±æ ¸å¿ƒç±» ShardingRouter çš„è¿ä½œæœºåˆ¶ï¼Ÿâ€è¯¾æ—¶ä¸­ï¼Œæˆ‘ä»¬åœ¨ BaseShardingEngine çš„ Shard æ–¹æ³•ä¸­çœ‹åˆ°äº† ShardingSphere ä¸­å¦ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œå³ SQL æ”¹å†™ï¼ˆRewriteï¼‰ã€‚
SQL æ”¹å†™åœ¨åˆ†åº“åˆ†è¡¨æ¡†æ¶ä¸­é€šå¸¸ä½äºè·¯ç”±ä¹‹åï¼Œä¹Ÿæ˜¯æ•´ä¸ª SQL æ‰§è¡Œæµç¨‹ä¸­çš„é‡è¦ç¯èŠ‚ï¼Œå› ä¸ºå¼€å‘äººå‘˜æ˜¯é¢å‘é€»è¾‘åº“ä¸é€»è¾‘è¡¨æ‰€ä¹¦å†™çš„ SQLï¼Œå¹¶ä¸èƒ½å¤Ÿç›´æ¥åœ¨çœŸå®çš„æ•°æ®åº“ä¸­æ‰§è¡Œï¼ŒSQL æ”¹å†™ï¼Œç”¨äºå°†é€»è¾‘ SQL æ”¹å†™ä¸ºåœ¨çœŸå®æ•°æ®åº“ä¸­å¯ä»¥æ­£ç¡®æ‰§è¡Œçš„ SQLã€‚
äº‹å®ä¸Šï¼Œæˆ‘ä»¬å·²ç»åœ¨å‰é¢çš„æ¡ˆä¾‹ä¸­çœ‹åˆ°äº† SQL æ”¹å†™çš„åº”ç”¨åœºæ™¯ï¼Œè¿™ä¸ªåœºæ™¯å°±æ˜¯åˆ†å¸ƒå¼ä¸»é”®çš„è‡ªåŠ¨ç”Ÿæˆè¿‡ç¨‹ã€‚åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œè‡ªå¢ä¸»é”®æ˜¯å¸¸è§çš„åŠŸèƒ½ç‰¹æ€§ï¼Œè€Œå¯¹äº ShardingSphere è€Œè¨€ï¼Œè¿™ä¹Ÿæ˜¯ SQL æ”¹å†™çš„å…¸å‹åº”ç”¨åœºæ™¯ã€‚
ä»Šå¤©ï¼Œæˆ‘ä»¬å°±å°†åŸºäºè‡ªå¢ä¸»é”®è¿™ä¸€åœºæ™¯æ¥æ¢è®¨ ShardingSphere ä¸­ SQL æ”¹å†™çš„å®ç°è¿‡ç¨‹ã€‚
ShardingSphere æ”¹å†™å¼•æ“åŸºæœ¬ç»“æ„ è®©æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ BaseShardingEngine ä¸­ï¼Œç”¨äºæ‰§è¡Œæ”¹å†™é€»è¾‘çš„ rewriteAndConvert æ–¹æ³•ï¼š
private Collection&amp;lt;RouteUnit&amp;gt; rewriteAndConvert(final String sql, final List&amp;lt;Object&amp;gt; parameters, final SQLRouteResult sqlRouteResult) { //æ„å»º SQLRewriteContext SQLRewriteContext sqlRewriteContext = new SQLRewriteContext(metaData.getRelationMetas(), sqlRouteResult.getSqlStatementContext(), sql, parameters); //æ„å»º ShardingSQLRewriteContextDecorator å¯¹ SQLRewriteContext è¿›è¡Œè£…é¥° new ShardingSQLRewriteContextDecorator(shardingRule, sqlRouteResult).">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/shardingsphere%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e7%b2%be%e8%ae%b2/">ShardingSphereæ ¸å¿ƒåŸç†ç²¾è®²</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/00-%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E5%AD%A6%E4%B9%A0%E4%B8%80%E6%AC%BE%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/">00 å¦‚ä½•æ­£ç¡®å­¦ä¹ ä¸€æ¬¾åˆ†åº“åˆ†è¡¨å¼€æºæ¡†æ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/01-%E4%BB%8E%E7%90%86%E8%AE%BA%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%A6%82%E4%BD%95%E8%AE%A9%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%9C%9F%E6%AD%A3%E8%90%BD%E5%9C%B0/">01 ä»ç†è®ºåˆ°å®è·µï¼šå¦‚ä½•è®©åˆ†åº“åˆ†è¡¨çœŸæ­£è½åœ°ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/02-%E9%A1%B6%E7%BA%A7%E9%A1%B9%E7%9B%AEshardingsphere-%E6%98%AF%E4%B8%80%E6%AC%BE%E4%BB%80%E4%B9%88%E6%A0%B7%E7%9A%84-apache-%E5%BC%80%E6%BA%90%E8%BD%AF%E4%BB%B6/">02 é¡¶çº§é¡¹ç›®ï¼šShardingSphere æ˜¯ä¸€æ¬¾ä»€ä¹ˆæ ·çš„ Apache å¼€æºè½¯ä»¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/03-%E8%A7%84%E8%8C%83%E5%85%BC%E5%AE%B9jdbc-%E8%A7%84%E8%8C%83%E4%B8%8E-shardingsphere-%E6%98%AF%E4%BB%80%E4%B9%88%E5%85%B3%E7%B3%BB/">03 è§„èŒƒå…¼å®¹ï¼šJDBC è§„èŒƒä¸ ShardingSphere æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/04-%E5%BA%94%E7%94%A8%E9%9B%86%E6%88%90%E5%9C%A8%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F%E4%B8%AD%E4%BD%BF%E7%94%A8-shardingsphere-%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9C%89%E5%93%AA%E4%BA%9B/">04 åº”ç”¨é›†æˆï¼šåœ¨ä¸šåŠ¡ç³»ç»Ÿä¸­ä½¿ç”¨ ShardingSphere çš„æ–¹å¼æœ‰å“ªäº›ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/05-%E9%85%8D%E7%BD%AE%E9%A9%B1%E5%8A%A8shardingsphere-%E4%B8%AD%E7%9A%84%E9%85%8D%E7%BD%AE%E4%BD%93%E7%B3%BB%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E7%9A%84/">05 é…ç½®é©±åŠ¨ï¼šShardingSphere ä¸­çš„é…ç½®ä½“ç³»æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/09-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E4%B8%8E%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1/">09 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¦‚ä½•ä½¿ç”¨å¼ºä¸€è‡´æ€§äº‹åŠ¡ä¸æŸ”æ€§äº‹åŠ¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/10-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E5%A6%82%E4%BD%95%E7%A1%AE%E4%BF%9D%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AE%89%E5%85%A8%E8%AE%BF%E9%97%AE/">10 æ•°æ®è„±æ•ï¼šå¦‚ä½•ç¡®ä¿æ•æ„Ÿæ•°æ®çš„å®‰å…¨è®¿é—®ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/11-%E7%BC%96%E6%8E%92%E6%B2%BB%E7%90%86%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/">11 ç¼–æ’æ²»ç†ï¼šå¦‚ä½•å®ç°åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„åŠ¨æ€é…ç½®ç®¡ç†ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/12-%E4%BB%8E%E5%BA%94%E7%94%A8%E5%88%B0%E5%8E%9F%E7%90%86%E5%A6%82%E4%BD%95%E9%AB%98%E6%95%88%E9%98%85%E8%AF%BB-shardingsphere-%E6%BA%90%E7%A0%81/">12 ä»åº”ç”¨åˆ°åŸç†ï¼šå¦‚ä½•é«˜æ•ˆé˜…è¯» ShardingSphere æºç ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/13-%E5%BE%AE%E5%86%85%E6%A0%B8%E6%9E%B6%E6%9E%84shardingsphere-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%89%A9%E5%B1%95%E6%80%A7/">13 å¾®å†…æ ¸æ¶æ„ï¼šShardingSphere å¦‚ä½•å®ç°ç³»ç»Ÿçš„æ‰©å±•æ€§ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/14-%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AEshardingsphere-%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AE%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F/">14 åˆ†å¸ƒå¼ä¸»é”®ï¼šShardingSphere ä¸­æœ‰å“ªäº›åˆ†å¸ƒå¼ä¸»é”®å®ç°æ–¹å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/15-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8A/">15 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/16-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8B/">16 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/17-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E5%88%86%E7%89%87%E8%B7%AF%E7%94%B1%E6%A0%B8%E5%BF%83%E7%B1%BB-shardingrouter-%E7%9A%84%E8%BF%90%E4%BD%9C%E6%9C%BA%E5%88%B6/">17 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•ç†è§£åˆ†ç‰‡è·¯ç”±æ ¸å¿ƒç±» ShardingRouter çš„è¿ä½œæœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/18-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E7%9A%84%E5%88%86%E7%89%87%E8%B7%AF%E7%94%B1%E5%92%8C%E5%B9%BF%E6%92%AD%E8%B7%AF%E7%94%B1/">18 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•å®ç°æ•°æ®è®¿é—®çš„åˆ†ç‰‡è·¯ç”±å’Œå¹¿æ’­è·¯ç”±ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/19-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%9C%A8%E8%B7%AF%E7%94%B1%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%9B%86%E6%88%90%E5%A4%9A%E7%A7%8D%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E5%92%8C%E8%B7%AF%E7%94%B1%E7%AE%97%E6%B3%95/">19 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•åœ¨è·¯ç”±è¿‡ç¨‹ä¸­é›†æˆå¤šç§è·¯ç”±ç­–ç•¥å’Œè·¯ç”±ç®—æ³•ï¼Ÿ</a></li>
                
                
                
                    <li>20 æ”¹å†™å¼•æ“ï¼šå¦‚ä½•ç†è§£è£…é¥°å™¨æ¨¡å¼ä¸‹çš„ SQL æ”¹å†™å®ç°æœºåˆ¶ï¼Ÿ</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/21-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%88%86%E7%89%87%E7%8E%AF%E5%A2%83%E4%B8%8B-sql-%E6%89%A7%E8%A1%8C%E7%9A%84%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E6%8A%BD%E8%B1%A1/">21 æ‰§è¡Œå¼•æ“ï¼šåˆ†ç‰‡ç¯å¢ƒä¸‹ SQL æ‰§è¡Œçš„æ•´ä½“æµç¨‹åº”è¯¥å¦‚ä½•è¿›è¡ŒæŠ½è±¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/22-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E6%8A%8A%E6%8F%A1-shardingsphere-%E4%B8%AD%E7%9A%84-executor-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8A/">22 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/23-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E6%8A%8A%E6%8F%A1-shardingsphere-%E4%B8%AD%E7%9A%84-executor-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8B/">23 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/24-%E5%BD%92%E5%B9%B6%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E6%95%B0%E6%8D%AE%E5%BD%92%E5%B9%B6%E7%9A%84%E7%B1%BB%E5%9E%8B%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%BD%92%E5%B9%B6%E7%AD%96%E7%95%A5%E7%9A%84%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B/">24 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æ•°æ®å½’å¹¶çš„ç±»å‹ä»¥åŠç®€å•å½’å¹¶ç­–ç•¥çš„å®ç°è¿‡ç¨‹ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/25-%E5%BD%92%E5%B9%B6%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E6%B5%81%E5%BC%8F%E5%BD%92%E5%B9%B6%E5%92%8C%E5%86%85%E5%AD%98%E5%BD%92%E5%B9%B6%E5%9C%A8%E5%A4%8D%E6%9D%82%E5%BD%92%E5%B9%B6%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84%E5%BA%94%E7%94%A8%E6%96%B9%E5%BC%8F/">25 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æµå¼å½’å¹¶å’Œå†…å­˜å½’å¹¶åœ¨å¤æ‚å½’å¹¶åœºæ™¯ä¸‹çš„åº”ç”¨æ–¹å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/26-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%99%AE%E9%80%9A%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%92%8C%E5%88%86%E7%89%87%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%88%86%E5%88%AB%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84/">26 è¯»å†™åˆ†ç¦»ï¼šæ™®é€šä¸»ä»æ¶æ„å’Œåˆ†ç‰‡ä¸»ä»æ¶æ„åˆ†åˆ«æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/27-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3-shardingsphere-%E4%B8%AD%E5%AF%B9%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%8A%BD%E8%B1%A1%E8%BF%87%E7%A8%8B/">27 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¦‚ä½•ç†è§£ ShardingSphere ä¸­å¯¹åˆ†å¸ƒå¼äº‹åŠ¡çš„æŠ½è±¡è¿‡ç¨‹ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/28-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1shardingsphere-%E4%B8%AD%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%E4%B8%8A/">28 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/29-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1shardingsphere-%E4%B8%AD%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%E4%B8%8B/">29 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/30-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E6%94%B9%E5%86%99%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%E4%BD%8E%E4%BE%B5%E5%85%A5%E6%80%A7%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E6%96%B9%E6%A1%88/">30 æ•°æ®è„±æ•ï¼šå¦‚ä½•åŸºäºæ”¹å†™å¼•æ“å®ç°ä½ä¾µå…¥æ€§æ•°æ®è„±æ•æ–¹æ¡ˆï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/31-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E7%9A%84%E5%8A%A8%E6%80%81%E5%8C%96%E7%AE%A1%E7%90%86/">31 é…ç½®ä¸­å¿ƒï¼šå¦‚ä½•åŸºäºé…ç½®ä¸­å¿ƒå®ç°é…ç½®ä¿¡æ¯çš„åŠ¨æ€åŒ–ç®¡ç†ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/32-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BF%E9%97%AE%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6/">32 æ³¨å†Œä¸­å¿ƒï¼šå¦‚ä½•åŸºäºæ³¨å†Œä¸­å¿ƒå®ç°æ•°æ®åº“è®¿é—®ç†”æ–­æœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/33-%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E-hook-%E6%9C%BA%E5%88%B6%E4%BB%A5%E5%8F%8A-opentracing-%E5%8D%8F%E8%AE%AE%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA/">33 é“¾è·¯è·Ÿè¸ªï¼šå¦‚ä½•åŸºäº Hook æœºåˆ¶ä»¥åŠ OpenTracing åè®®å®ç°æ•°æ®è®¿é—®é“¾è·¯è·Ÿè¸ªï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/35-%E7%BB%93%E8%AF%ADshardingsphere-%E6%80%BB%E7%BB%93%E5%8F%8A%E5%B1%95%E6%9C%9B/">35 ç»“è¯­ï¼šShardingSphere æ€»ç»“åŠå±•æœ›</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">20 æ”¹å†™å¼•æ“ï¼šå¦‚ä½•ç†è§£è£…é¥°å™¨æ¨¡å¼ä¸‹çš„ SQL æ”¹å†™å®ç°æœºåˆ¶ï¼Ÿ</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2021-12-22 01:55:59</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/sharding/">sharding</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/">ShardingSphereæ ¸å¿ƒåŸç†ç²¾è®²</a>
                
            </div></div>
        <div class="post-content">
            <p>å›æƒ³åœ¨â€œ17 | è·¯ç”±å¼•æ“ï¼šå¦‚ä½•ç†è§£åˆ†ç‰‡è·¯ç”±æ ¸å¿ƒç±» ShardingRouter çš„è¿ä½œæœºåˆ¶ï¼Ÿâ€è¯¾æ—¶ä¸­ï¼Œæˆ‘ä»¬åœ¨ BaseShardingEngine çš„ Shard æ–¹æ³•ä¸­çœ‹åˆ°äº† ShardingSphere ä¸­å¦ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œå³ SQL æ”¹å†™ï¼ˆRewriteï¼‰ã€‚</p>
<p><strong>SQL æ”¹å†™</strong>åœ¨åˆ†åº“åˆ†è¡¨æ¡†æ¶ä¸­é€šå¸¸ä½äºè·¯ç”±ä¹‹åï¼Œä¹Ÿæ˜¯æ•´ä¸ª SQL æ‰§è¡Œæµç¨‹ä¸­çš„é‡è¦ç¯èŠ‚ï¼Œå› ä¸ºå¼€å‘äººå‘˜æ˜¯é¢å‘é€»è¾‘åº“ä¸é€»è¾‘è¡¨æ‰€ä¹¦å†™çš„ SQLï¼Œå¹¶ä¸èƒ½å¤Ÿç›´æ¥åœ¨çœŸå®çš„æ•°æ®åº“ä¸­æ‰§è¡Œï¼ŒSQL æ”¹å†™ï¼Œç”¨äºå°†é€»è¾‘ SQL æ”¹å†™ä¸ºåœ¨çœŸå®æ•°æ®åº“ä¸­å¯ä»¥æ­£ç¡®æ‰§è¡Œçš„ SQLã€‚</p>
<p>äº‹å®ä¸Šï¼Œæˆ‘ä»¬å·²ç»åœ¨å‰é¢çš„æ¡ˆä¾‹ä¸­çœ‹åˆ°äº† SQL æ”¹å†™çš„åº”ç”¨åœºæ™¯ï¼Œè¿™ä¸ªåœºæ™¯å°±æ˜¯åˆ†å¸ƒå¼ä¸»é”®çš„è‡ªåŠ¨ç”Ÿæˆè¿‡ç¨‹ã€‚åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œ<strong>è‡ªå¢ä¸»é”®</strong>æ˜¯å¸¸è§çš„åŠŸèƒ½ç‰¹æ€§ï¼Œè€Œå¯¹äº ShardingSphere è€Œè¨€ï¼Œè¿™ä¹Ÿæ˜¯ SQL æ”¹å†™çš„å…¸å‹åº”ç”¨åœºæ™¯ã€‚</p>
<p>ä»Šå¤©ï¼Œæˆ‘ä»¬å°±å°†åŸºäºè‡ªå¢ä¸»é”®è¿™ä¸€åœºæ™¯æ¥æ¢è®¨ <strong>ShardingSphere ä¸­ SQL æ”¹å†™çš„å®ç°è¿‡ç¨‹</strong>ã€‚</p>
<h3 id="shardingsphere-æ”¹å†™å¼•æ“åŸºæœ¬ç»“æ„">ShardingSphere æ”¹å†™å¼•æ“åŸºæœ¬ç»“æ„</h3>
<p>è®©æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ BaseShardingEngine ä¸­ï¼Œç”¨äºæ‰§è¡Œæ”¹å†™é€»è¾‘çš„ rewriteAndConvert æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>private Collection&lt;RouteUnit&gt; rewriteAndConvert(final String sql, final List&lt;Object&gt; parameters, final SQLRouteResult sqlRouteResult) { 
    //æ„å»º SQLRewriteContext 
   SQLRewriteContext sqlRewriteContext = new     SQLRewriteContext(metaData.getRelationMetas(), sqlRouteResult.getSqlStatementContext(), sql, parameters); 
   //æ„å»º ShardingSQLRewriteContextDecorator å¯¹ SQLRewriteContext è¿›è¡Œè£…é¥° 
   new ShardingSQLRewriteContextDecorator(shardingRule, sqlRouteResult).decorate(sqlRewriteContext); 
   //åˆ¤æ–­æ˜¯å¦æ ¹æ®æ•°æ®è„±æ•åˆ—è¿›è¡ŒæŸ¥è¯¢ 
   boolean isQueryWithCipherColumn = shardingProperties.&lt;Boolean&gt;getValue(ShardingPropertiesConstant.QUERY_WITH_CIPHER_COLUMN); 
    //æ„å»º EncryptSQLRewriteContextDecorator å¯¹ SQLRewriteContext è¿›è¡Œè£…é¥° 
   new EncryptSQLRewriteContextDecorator(shardingRule.getEncryptRule(), isQueryWithCipherColumn).decorate(sqlRewriteContext); 
  //ç”Ÿæˆ SQLTokens 
 sqlRewriteContext.generateSQLTokens(); 

    Collection&lt;RouteUnit&gt; result = new LinkedHashSet&lt;&gt;(); 
    for (RoutingUnit each : sqlRouteResult.getRoutingResult().getRoutingUnits()) { 
        //æ„å»º ShardingSQLRewriteEngine 
        ShardingSQLRewriteEngine sqlRewriteEngine = new ShardingSQLRewriteEngine(shardingRule, sqlRouteResult.getShardingConditions(), each); 
        //æ‰§è¡Œæ”¹å†™ 
        SQLRewriteResult sqlRewriteResult = sqlRewriteEngine.rewrite(sqlRewriteContext); 
        //ä¿å­˜æ”¹å†™ç»“æœ 
        result.add(new RouteUnit(each.getDataSourceName(), new SQLUnit(sqlRewriteResult.getSql(), sqlRewriteResult.getParameters()))); 
    } 
    return result; 
}
</code></pre><p>è¿™æ®µä»£ç è™½ç„¶å†…å®¹ä¸å¤šï¼Œä½†å´å®Œæ•´æè¿°äº†å®ç° SQL æ”¹å†™çš„æ•´ä½“æµç¨‹ï¼Œæˆ‘ä»¬å¯¹æ ¸å¿ƒä»£ç éƒ½æ·»åŠ äº†æ³¨é‡Šï¼Œè¿™é‡Œé¢æ¶‰åŠçš„<strong>æ ¸å¿ƒç±»</strong>ä¹Ÿå¾ˆå¤šï¼Œå€¼å¾—æˆ‘ä»¬è¿›è¡Œæ·±å…¥åˆ†æï¼Œç›¸å…³æ ¸å¿ƒç±»çš„æ•´ä½“ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/CgqCHl8-KY-AfKIDAACvtfju_F4857.png" alt="image.png"></p>
<p>å¯ä»¥çœ‹åˆ°åœ¨æ•´ä¸ªç±»å›¾ä¸­ï¼ŒSQLRewriteContext å¤„äºä¸­é—´ä½ç½®ï¼Œæ”¹å†™å¼•æ“ SQLRewriteEngine å’Œè£…é¥°å™¨ SQLRewriteContextDecorator éƒ½ä¾èµ–äºå®ƒã€‚</p>
<p>æ‰€ä»¥æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ª SQLRewriteContextï¼Œå¹¶åŸºäºè‡ªå¢ä¸»é”®åŠŸèƒ½å¼•å‡º SQL æ”¹å†™å¼•æ“çš„åŸºç¡€ç»„ä»¶ SQLTokenã€‚</p>
<h3 id="ä»è‡ªå¢ä¸»é”®åŠŸèƒ½çœ‹æ”¹å†™å¼•æ“ä¸­çš„æ ¸å¿ƒç±»">ä»è‡ªå¢ä¸»é”®åŠŸèƒ½çœ‹æ”¹å†™å¼•æ“ä¸­çš„æ ¸å¿ƒç±»</h3>
<h4 id="1-sqlrewritecontext">1. SQLRewriteContext</h4>
<p>ä»å‘½åä¸Šè®²ï¼Œä¸ SQLStatementContext ç±»ä¼¼ï¼ŒSQLRewriteContext ä¹Ÿæ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ SQLRewriteContext ä¸­çš„å˜é‡å®šä¹‰ï¼š</p>
<pre tabindex="0"><code>//æ•°æ®è¡¨å’Œåˆ—çš„å…³ç³»å…ƒæ•°æ® 
private final RelationMetas relationMetas; 
//SQLStatement ä¸Šä¸‹æ–‡ 
private final SQLStatementContext sqlStatementContext; 
//åŸå§‹SQL 
private final String sql; 
//å‚æ•°åˆ—è¡¨ 
private final List&lt;Object&gt; parameters; 
//SQLToken åˆ—è¡¨ 
private final List&lt;SQLToken&gt; sqlTokens = new LinkedList&lt;&gt;(); 
//å‚æ•°æ„å»ºå™¨ 
private final ParameterBuilder parameterBuilder; 
//SQLToken ç”Ÿæˆå™¨ 
private final SQLTokenGenerators sqlTokenGenerators = new SQLTokenGenerators();
</code></pre><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å‰é¢å·²ç»ä»‹ç»çš„ SQLStatementContextï¼Œä¹Ÿçœ‹åˆ°äº†æ–°çš„ SQLToken å’Œ SQLTokenGeneratorsã€‚éšç€ä»Šå¤©å†…å®¹çš„æ¼”è¿›ï¼Œè¿™äº›å¯¹è±¡éƒ½ä¼šé€ä¸€è¿›è¡Œä»‹ç»ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆæ˜ç¡® SQLRewriteContext ä¸­ä¿å­˜ç€ç”¨äº SQL æ”¹å†™çš„å„ç§ç›¸å…³ä¿¡æ¯ã€‚</p>
<h4 id="2-sqltoken">2. SQLToken</h4>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ SQLToken å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åœ¨æ”¹å†™å¼•æ“ä¸­é‡è¦æ€§å¾ˆé«˜ï¼Œ<strong>SQLRewriteEngine æ­£æ˜¯åŸºäº SQLToken å®ç°äº† SQL æ”¹å†™</strong>ï¼ŒSQLToken ç±»çš„å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@RequiredArgsConstructor 
@Getter 
public abstract class SQLToken implements Comparable&lt;SQLToken&gt; { 

    private final int startIndex; 

    @Override 
    public final int compareTo(final SQLToken sqlToken) { 
        return startIndex - sqlToken.getStartIndex(); 
    } 
}
</code></pre><p>SQLToken å®é™…ä¸Šæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œåœ¨ ShardingSphere ä¸­ï¼Œå­˜åœ¨äº†ä¸€å¤§æ‰¹ SQLToken çš„å­ç±»ã€‚è¿™äº› SQLToken å¤šæ•°è·Ÿ SQL æ”¹å†™ç›¸å…³ï¼ˆè¿™éƒ¨åˆ†ç±»çš„åŒ…åä¸­åŒ…å« rewriteï¼‰ï¼›è€Œæœ‰äº›åœ¨æ”¹å†™çš„åŸºç¡€ä¸Šè¿˜ä¸åé¢è¦è®²åˆ°çš„æ•°æ®è„±æ•åŠŸèƒ½ç›¸å…³ï¼ˆè¿™éƒ¨åˆ†ç±»åŒ…åä¸­è¿˜åŒ…å«ç€ encryptï¼‰ã€‚</p>
<blockquote>
<p>æ•°æ®è„±æ•ä¹Ÿæ˜¯ ShardingSphere æä¾›çš„ä¸€é¡¹éå¸¸å®ç”¨çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬åœ¨è®²åˆ°â€œæ¨¡å—å…­ï¼šShardingSphere æºç è§£æä¹‹æ²»ç†ä¸é›†æˆâ€æ—¶ä¼šæœ‰ä¸“é¢˜å¯¹å…¶è¿›è¡Œä»‹ç»ã€‚</p>
</blockquote>
<p>åŒæ—¶ï¼Œéƒ¨åˆ† SQLToken ä½äº shardingsphere-rewrite-engine å·¥ç¨‹ä¸­ï¼Œè€Œæœ‰äº›åˆ™ä½äº sharding-core-rewrite å·¥ç¨‹ä¸­ï¼Œè¿™ç‚¹ä¹Ÿéœ€è¦æ³¨æ„ã€‚</p>
<p>ç»“åˆ SQL æ”¹å†™çš„å¸¸è§åœºæ™¯ï¼Œå¾ˆå¤š SQLToken çš„å«ä¹‰å¯ä»¥ä»å­—é¢æ„æ€ä¸Šç›´æ¥ç†è§£ã€‚ä¾‹å¦‚ï¼Œå¯¹ INSERT è¯­å¥è€Œè¨€ï¼Œå¦‚æœä½¿ç”¨æ•°æ®åº“è‡ªå¢ä¸»é”®ï¼Œæ˜¯ä¸éœ€è¦å†™å…¥ä¸»é”®å­—æ®µçš„ï¼Œä½†æ•°æ®åº“çš„è‡ªå¢ä¸»é”®æ— æ³•æ»¡è¶³åˆ†å¸ƒå¼åœºæ™¯ä¸‹çš„ä¸»é”®å”¯ä¸€æ€§ï¼Œå› æ­¤ ShardingSphere æä¾›äº†åˆ†å¸ƒå¼è‡ªå¢ä¸»é”®çš„ç”Ÿæˆç­–ç•¥ï¼Œèƒ½å¤Ÿè‡ªåŠ¨åœ°æ›¿æ¢æ•°æ®åº“ç°æœ‰çš„è‡ªå¢ä¸»é”®ã€‚</p>
<p>ä¸¾ä¾‹è¯´æ˜ï¼Œæˆ‘ä»¬æ¡ˆä¾‹ä¸­ health_record è¡¨çš„ä¸»é”®æ˜¯ record_idï¼Œå‡å®šåŸå§‹çš„ SQL ä¸ºï¼š</p>
<pre tabindex="0"><code>INSERT INTO health_record (user_id, level_id, remark) values (1, 1, &quot;remark1&quot;)
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸Šè¿° SQL ä¸­å¹¶æœªåŒ…å«è‡ªå¢ä¸»é”®ï¼Œéœ€è¦æ•°æ®åº“è‡ªè¡Œå¡«å……ï¼Œåœ¨ ShardingSphere ä¸­é…ç½®äº†è‡ªå¢ä¸»é”®åï¼ŒSQL å°†è¢«è‡ªåŠ¨æ”¹å†™ä¸ºï¼š</p>
<pre tabindex="0"><code>INSERT INTO health_record (record_id, user_id, level_id, remark) values (&quot;471698773731577856&quot;, 1, 1, &quot;Remark1&quot;)
</code></pre><p>æ˜¾ç„¶ï¼Œæ”¹å†™åçš„ SQL å°†åœ¨ INSERT è¯­å¥ä¸­å¢åŠ ä¸»é”®åˆ—åç§°ï¼Œä»¥åŠè‡ªåŠ¨ç”Ÿæˆçš„è‡ªå¢ä¸»é”®å€¼ã€‚</p>
<p>ä»å‘½åä¸Šçœ‹ï¼ŒGeneratedKeyInsertColumnToken å¯¹åº”ä¸Šè¿°çš„è‡ªåŠ¨ä¸»é”®å¡«å……çš„åœºæ™¯ï¼Œè¿™å®é™…ä¸Šå±äºå¸¸è§çš„ä¸€ç§ SQL æ”¹å†™ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯è¡¥åˆ—ï¼ŒGeneratedKeyInsertColumnToken çš„å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public final class GeneratedKeyInsertColumnToken extends SQLToken implements Attachable { 

    private final String column; 

    public GeneratedKeyInsertColumnToken(final int startIndex, final String column) { 
        super(startIndex); 
        this.column = column; 
    } 

    @Override 
    public String toString() { 
        return String.format(&quot;, %s&quot;, column); 
    } 
}
</code></pre><p>æ³¨æ„åˆ°è¿™é‡Œå¤šäº†ä¸€ä¸ª column å˜é‡ç”¨äºæŒ‡å®šä¸»é”®çš„æ‰€åœ¨åˆ—ã€‚æˆ‘ä»¬å†æ¥è·Ÿè¸ª GeneratedKeyInsertColumnToken çš„æ„é€ å‡½æ•°è°ƒç”¨æƒ…å†µï¼Œå‘ç°è¿™ä¸ªç±»æ˜¯é€šè¿‡ GeneratedKeyInsertColumnTokenGenerator åˆ›å»ºå‡ºæ¥çš„ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹ TokenGeneratorã€‚</p>
<h4 id="3-tokengenerator">3. TokenGenerator</h4>
<p>é¡¾åæ€ä¹‰ï¼ŒTokenGenerator çš„ä½œç”¨æ˜¯ä¸“é—¨è´Ÿè´£ç”Ÿæˆå…·ä½“çš„ Tokenï¼Œè¯¥æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>public interface SQLTokenGenerator {
    //åˆ¤æ–­æ˜¯å¦è¦ç”Ÿæˆ SQLToken 
    boolean isGenerateSQLToken(SQLStatementContext sqlStatementContext); 
}
</code></pre><p>è¯¥æ¥å£è¿˜æœ‰ä¸¤ä¸ªå­æ¥å£ï¼Œåˆ†åˆ«æ˜¯è´Ÿè´£ç”Ÿæˆå•ä¸ª SQLToken çš„ OptionalSQLTokenGenerator å’Œè´Ÿè´£ç”Ÿæˆæ‰¹é‡ SQLToken çš„ CollectionSQLTokenGeneratorï¼š</p>
<pre tabindex="0"><code>public interface OptionalSQLTokenGenerator extends SQLTokenGenerator {
    //ç”Ÿæˆå•ä¸ª SQLToken 
    SQLToken generateSQLToken(SQLStatementContext sqlStatementContext); 
} 

public interface CollectionSQLTokenGenerator extends SQLTokenGenerator { 
    //ç”Ÿæˆæ‰¹é‡ SQLToken 
    Collection&lt;? extends SQLToken&gt; generateSQLTokens(SQLStatementContext sqlStatementContext); 
}
</code></pre><p>åœ¨ ShardingSphereï¼Œå’Œ SQLToken ä¸€æ ·ï¼ŒTokenGenerator çš„ç±»å±‚ç»“æ„ä¹Ÿæ¯”è¾ƒå¤æ‚ã€‚å¯¹äº GeneratedKeyInsertColumnTokenGenerator è€Œè¨€ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ªæŠ½è±¡çš„åŸºç±»ï¼Œå³å¦‚ä¸‹æ‰€ç¤ºçš„ BaseGeneratedKeyTokenGeneratorï¼š</p>
<pre tabindex="0"><code>public abstract class BaseGeneratedKeyTokenGenerator implements OptionalSQLTokenGenerator, SQLRouteResultAware { 

    //æ˜¯å¦ç”Ÿæˆ SQLToken 
    protected abstract boolean isGenerateSQLToken(InsertStatement insertStatement);

    //ç”Ÿæˆ SQLToken 
protected abstract SQLToken generateSQLToken(SQLStatementContext sqlStatementContext, GeneratedKey generatedKey); 

â€¦ 
}
</code></pre><p>è¿™ä¸ªæŠ½è±¡ç±»ç•™ä¸‹äº†ä¸¤ä¸ªæ¨¡æ¿æ–¹æ³• isGenerateSQLToken å’Œ generateSQLTokenï¼Œäº¤ç”±å­ç±»è¿›è¡Œå®ç°ï¼Œåœ¨ GeneratedKeyInsertColumnTokenGenerator ä¸­æä¾›äº†è¿™ä¸¤ä¸ªæ–¹æ³•çš„å®ç°è¿‡ç¨‹ï¼š</p>
<pre tabindex="0"><code>public final class GeneratedKeyInsertColumnTokenGenerator extends BaseGeneratedKeyTokenGenerator { 

    @Override 
    protected boolean isGenerateSQLToken(final InsertStatement insertStatement) { 
        Optional&lt;InsertColumnsSegment&gt; sqlSegment = insertStatement.findSQLSegment(InsertColumnsSegment.class); 
        return sqlSegment.isPresent() &amp;&amp; !sqlSegment.get().getColumns().isEmpty(); 
    } 

    @Override 
    protected GeneratedKeyInsertColumnToken generateSQLToken(final SQLStatementContext sqlStatementContext, final GeneratedKey generatedKey) { 
        Optional&lt;InsertColumnsSegment&gt; sqlSegment = sqlStatementContext.getSqlStatement().findSQLSegment(InsertColumnsSegment.class); 
        Preconditions.checkState(sqlSegment.isPresent()); 
       //æ„å»º GeneratedKeyInsertColumnToken 
        return new GeneratedKeyInsertColumnToken(sqlSegment.get().getStopIndex(), generatedKey.getColumnName()); 
    } 
}
</code></pre><p>æˆ‘ä»¬çœ‹åˆ°åœ¨ä¸Šè¿° generateSQLToken æ–¹æ³•ä¸­ï¼Œé€šè¿‡åˆ©ç”¨åœ¨ SQL è§£æå¼•æ“ä¸­è·å–çš„ InsertColumnsSegment ä»¥åŠä»ç”¨äºç”Ÿæˆåˆ†å¸ƒå¼ä¸»é”®çš„ GeneratedKey ä¸­è·å–å¯¹åº”çš„ä¸»é”®åˆ—ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„å»ºä¸€ä¸ª GeneratedKeyInsertColumnTokenã€‚</p>
<h3 id="è£…é¥°å™¨-sqlrewritecontextdecorator">è£…é¥°å™¨ SQLRewriteContextDecorator</h3>
<p>ç°åœ¨ï¼Œæ—¢ç„¶å·²ç»è·å–äº† SQLTokenï¼Œè®©æˆ‘ä»¬å†æ¬¡å›åˆ°å‰é¢æåˆ°çš„ SQLRewriteContextã€‚æˆ‘ä»¬çŸ¥é“ SQLRewriteContext æ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œä¿å­˜ç€ä¸ SQL æ”¹å†™ç›¸å…³çš„å¾ˆå¤šæ•°æ®ä¿¡æ¯ï¼ŒåŒæ—¶å¯¹äºè¿™äº›ä¿¡æ¯ï¼Œå…¶æ„å»ºè¿‡ç¨‹ä¼šæ ¹æ®ä¸åŒçš„åº”ç”¨åœºæ™¯è€Œæœ‰æ‰€ä¸åŒã€‚åŸºäºè¿™äº›åº”ç”¨åœºæ™¯ï¼ŒShardingSphere çš„æ”¹å†™å¼•æ“æä¾›äº† SQLRewriteContextDecorator æ¥å£ï¼š</p>
<pre tabindex="0"><code>public interface SQLRewriteContextDecorator { 

    //å¯¹SQLRewriteContext æ‰§è¡Œè£…é¥° 
    void decorate(SQLRewriteContext sqlRewriteContext); 
}
</code></pre><p>é¡¾åæ€ä¹‰ï¼ŒSQLRewriteContextDecorator æ˜¯ä¸€ç§è£…é¥°å™¨æ¨¡å¼çš„å…·ä½“åº”ç”¨ï¼Œåœ¨ ShardingSphere ä¸­åªå­˜åœ¨ä¸¤ç§å…·ä½“çš„ SQLRewriteContextDecoratorï¼šä¸€ç§æ˜¯ç”¨äºåˆ†ç‰‡å¤„ç†çš„ ShardingSQLRewriteContextDecoratorï¼Œä¸€ç§æ˜¯ç”¨äºæ•°æ®è„±æ•çš„ EncryptSQLRewriteContextDecoratorï¼Œæˆ‘ä»¬å°†åœ¨â€œ30 | æ•°æ®è„±æ•ï¼šå¦‚ä½•åŸºäºæ”¹å†™å¼•æ“å®ç°ä½ä¾µå…¥æ€§æ•°æ®è„±æ•æ–¹æ¡ˆï¼Ÿâ€ä¸­è¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å…³æ³¨çš„æ˜¯å‰ä¸€ç§ ShardingSQLRewriteContextDecorator çš„å®ç°è¿‡ç¨‹ï¼š</p>
<pre tabindex="0"><code>public final class ShardingSQLRewriteContextDecorator implements SQLRewriteContextDecorator { 

    private final ShardingRule shardingRule; 

    private final SQLRouteResult sqlRouteResult; 

    @Override 
    public void decorate(final SQLRewriteContext sqlRewriteContext) { 
         //å‚æ•°æ”¹å†™ 
        for (ParameterRewriter each : new ShardingParameterRewriterBuilder(shardingRule, sqlRouteResult).getParameterRewriters(sqlRewriteContext.getRelationMetas())) { 
            if (!sqlRewriteContext.getParameters().isEmpty() &amp;&amp; each.isNeedRewrite(sqlRewriteContext.getSqlStatementContext())) { 
                each.rewrite(sqlRewriteContext.getParameterBuilder(), sqlRewriteContext.getSqlStatementContext(), sqlRewriteContext.getParameters()); 
            } 
        } 

        //SQLTokenGenerators åˆå§‹åŒ– 
        sqlRewriteContext.addSQLTokenGenerators(new ShardingTokenGenerateBuilder(shardingRule, sqlRouteResult).getSQLTokenGenerators()); 
    } 
}
</code></pre><p>è¿™æ®µä»£ç ä¸é•¿ï¼ŒåŒ…å«äº†ä¸¤éƒ¨åˆ†å†…å®¹ï¼šä¸€ä¸ªæ˜¯å‚æ•°æ”¹å†™ï¼Œå¦ä¸€ä¸ªæ˜¯ SQLTokenGenerators åˆå§‹åŒ–ï¼Œä¸‹é¢æˆ‘å°†åˆ†åˆ«è®²è§£ï¼š</p>
<h4 id="1-å‚æ•°æ”¹å†™">1. å‚æ•°æ”¹å†™</h4>
<p>å‚æ•°æ”¹å†™éƒ¨åˆ†åˆå¼•å…¥äº†å‡ ä¸ªæ–°ç±»ã€‚é¦–å½“å…¶å†²çš„æ˜¯ ParameterRewriter ä»¥åŠæ„å»ºå®ƒçš„ ParameterRewriterBuilderã€‚</p>
<p><strong>ï¼ˆ1ï¼‰ParameterRewriter</strong></p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ ParameterRewriter çš„å®šä¹‰ï¼š</p>
<pre tabindex="0"><code>public interface ParameterRewriter { 

    //åˆ¤æ–­æ˜¯å¦éœ€è¦æ”¹å†™ 
    boolean isNeedRewrite(SQLStatementContext sqlStatementContext); 

    //æ‰§è¡Œå‚æ•°æ”¹å†™ 
    void rewrite(ParameterBuilder parameterBuilder, SQLStatementContext sqlStatementContext, List&lt;Object&gt; parameters); 
}
</code></pre><p>åŸºäºè‡ªå¢ä¸»é”®åŠŸèƒ½ï¼Œè¿™é‡Œä»¥ ShardingGeneratedKeyInsertValueParameterRewriter ä¸ºä¾‹çœ‹ä¸€ä¸‹ ParameterRewriter çš„å®ç°æ–¹å¼ï¼Œå®ƒçš„ isNeedRewrite æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@Override 
public boolean isNeedRewrite(final SQLStatementContext sqlStatementContext) { 
    return sqlStatementContext instanceof InsertSQLStatementContext &amp;&amp; sqlRouteResult.getGeneratedKey().isPresent() &amp;&amp; sqlRouteResult.getGeneratedKey().get().isGenerated(); 
}
</code></pre><p>æ˜¾ç„¶ï¼Œè¾“å…¥çš„ SQL åº”è¯¥æ˜¯ä¸€ç§ InsertSQLStatementï¼Œå¹¶ä¸”åªæœ‰åœ¨è·¯ç”±ç»“æœå·²ç»åŒ…å«äº† GeneratedKey çš„æƒ…å†µä¸‹æ‰æ‰§è¡Œè¿™ç§æ”¹å†™ã€‚</p>
<p><strong>ï¼ˆ2ï¼‰ParameterRewriterBuilder</strong></p>
<p>åœ¨ä»‹ç» rewrite æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ç†è§£ <strong>ParameterBuilder</strong> çš„æ¦‚å¿µï¼ŒParameterBuilder æ˜¯ä¸€ç§å‚æ•°æ„å»ºå™¨ï¼š</p>
<pre tabindex="0"><code>public interface ParameterBuilder {
    List&lt;Object&gt; getParameters(); 
}
</code></pre><p>ParameterBuilder æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼šåˆ†åˆ«æ˜¯ StandardParameterBuilder å’Œ GroupedParameterBuilderã€‚å…¶ä¸­ï¼ŒGroupedParameterBuilder ä¿å­˜ç€ StandardParameterBuilder çš„ä¸€ä¸ªé›†åˆï¼Œåªé€‚ç”¨äº InsertSQLStatementã€‚</p>
<p>äº†è§£äº†è¿™å±‚å…³ç³»ä¹‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹ ShardingGeneratedKeyInsertValueParameterRewriter çš„ rewrite æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>@Override 
public void rewrite(final ParameterBuilder parameterBuilder, final SQLStatementContext sqlStatementContext, final List&lt;Object&gt; parameters) { 
        Preconditions.checkState(sqlRouteResult.getGeneratedKey().isPresent()); 
    ((GroupedParameterBuilder) parameterBuilder).setDerivedColumnName(sqlRouteResult.getGeneratedKey().get().getColumnName()); 
    Iterator&lt;Comparable&lt;?&gt;&gt; generatedValues = sqlRouteResult.getGeneratedKey().get().getGeneratedValues().descendingIterator(); 
    int count = 0; 
    int parametersCount = 0; 
    for (List&lt;Object&gt; each : ((InsertSQLStatementContext) sqlStatementContext).getGroupedParameters()) { 
        parametersCount += ((InsertSQLStatementContext) sqlStatementContext).getInsertValueContexts().get(count).getParametersCount(); 
        Comparable&lt;?&gt; generatedValue = generatedValues.next(); 
        if (!each.isEmpty()) { 
          //ä½¿ç”¨ GroupedParameterBuilder è¿›è¡Œè¡¥åˆ—å’Œè®¾ç½®å‚æ•° 
            ((GroupedParameterBuilder) parameterBuilder).getParameterBuilders().get(count).addAddedParameters(parametersCount, Lists.&lt;Object&gt;newArrayList(generatedValue)); 
        } 
        count++; 
    } 
}
</code></pre><p>å› ä¸ºè¿™ä¸ª ParameterRewriter é¢å‘ InsertSQLStatementï¼Œæ‰€ä»¥è¿™é‡Œç”¨åˆ°äº† GroupedParameterBuilderï¼Œå¹¶é€šè¿‡ SQLRouteResult è·å– GeneratedKeyã€‚æˆ‘ä»¬è®¾ç½®äº† GroupedParameterBuilder ä¸­çš„ DerivedColumnName ä¸º GeneratedKey çš„ä¸»é”® Columnï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå¾ªç¯æ·»åŠ äº†å¯¹åº”çš„ Index å’Œ Parameterï¼Œä¹Ÿå°±æ˜¯å®Œæˆäº†æ‰€éœ€çš„è¡¥åˆ—æ“ä½œã€‚</p>
<p>è¿™éƒ¨åˆ†çš„æ“ä½œå®é™…ä¸Šå¯ä»¥ä¸ GeneratedKey çš„ç”Ÿæˆè¿‡ç¨‹ç»“åˆèµ·æ¥ä¸€èµ·çœ‹ä»¥ä¾¿åŠ æ·±ç†è§£ï¼Œåœ¨ [â€œ14 | åˆ†å¸ƒå¼ä¸»é”®ï¼šShardingSphere ä¸­æœ‰å“ªäº›åˆ†å¸ƒå¼ä¸»é”®å®ç°æ–¹å¼ï¼Ÿâ€]è¯¾æ—¶ä¸­æåˆ°çš„ createGeneratedKey æ–¹æ³•ä¹Ÿæ˜¯é€šè¿‡ä¸€ä¸ªå¾ªç¯å¯¹ GeneratedKey è¿›è¡Œèµ‹å€¼ã€‚</p>
<pre tabindex="0"><code>private static GeneratedKey createGeneratedKey(final ShardingRule shardingRule, final InsertStatement insertStatement, final String generateKeyColumnName) { 
    GeneratedKey result = new GeneratedKey(generateKeyColumnName, true); 
    for (int i = 0; i &lt; insertStatement.getValueListCount(); i++) { 
            result.getGeneratedValues().add(shardingRule.generateKey(insertStatement.getTable().getTableName())); 
    } 
    return result; 
}
</code></pre><h4 id="2-sqltokengenerator-åˆå§‹åŒ–">2. SQLTokenGenerator åˆå§‹åŒ–</h4>
<p>ä¸Šæ–‡å†…å®¹æˆ‘ä»¬å…³æ³¨ ShardingSQLRewriteContextDecorator ä¸­ä½¿ç”¨ ParameterRewriter è¿›è¡Œ<strong>å‚æ•°æ”¹å†™</strong>çš„è¿‡ç¨‹ï¼Œè¿™æ˜¯ decorate æ–¹æ³•ä¸­çš„ç¬¬ä¸€éƒ¨åˆ†å†…å®¹ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­è®²è§£è¯¥æ–¹æ³•çš„ç¬¬äºŒéƒ¨åˆ†å†…å®¹ï¼Œå³ <strong>ä¸º SQLRewriteContext æ·»åŠ  SQLTokenGenerator</strong>ï¼š</p>
<pre tabindex="0"><code>//SQLTokenGenerators åˆå§‹åŒ– 
sqlRewriteContext.addSQLTokenGenerators(new ShardingTokenGenerateBuilder(shardingRule, sqlRouteResult).getSQLTokenGenerators());
</code></pre><p>è¿™å¥ä»£ç å…³æ³¨äº SQLTokenGenerator çš„åˆ›å»ºï¼Œæ‰€ä»¥å‡ºç°äº†ä¸€ä¸ªShardingTokenGenerateBuilderï¼š</p>
<pre tabindex="0"><code>public interface SQLTokenGeneratorBuilder { 
    //è·å– SQLTokenGenerator åˆ—è¡¨ 
    Collection&lt;SQLTokenGenerator&gt; getSQLTokenGenerators(); 
}
</code></pre><p>åœ¨ SQLTokenGeneratorBuilder çš„å®ç°ç±» ShardingTokenGenerateBuilder ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å†…ç½®äº†å¾ˆå¤š TokenGeneratorï¼ŒåŒ…å«æˆ‘ä»¬åœ¨å‰é¢æåˆ°è¿‡çš„ GeneratedKeyInsertColumnTokenGeneratorï¼š</p>
<pre tabindex="0"><code>private Collection&lt;SQLTokenGenerator&gt; buildSQLTokenGenerators() { 
        Collection&lt;SQLTokenGenerator&gt; result = new LinkedList&lt;&gt;(); 
        addSQLTokenGenerator(result, new TableTokenGenerator()); 
        â€¦ 
        addSQLTokenGenerator(result, new OffsetTokenGenerator()); 
        addSQLTokenGenerator(result, new RowCountTokenGenerator()); 
        addSQLTokenGenerator(result, new GeneratedKeyInsertColumnTokenGenerator()); 
        â€¦ 
        return result; 
}
</code></pre><h3 id="æ”¹å†™å¼•æ“-sqlrewriteengine">æ”¹å†™å¼•æ“ SQLRewriteEngine</h3>
<p>åœ¨ ShardingSphere ä¸­ï¼ŒSQLRewriteEngine æ¥å£ä»£è¡¨äº†æ”¹å†™å¼•æ“çš„å…¥å£ï¼š</p>
<pre tabindex="0"><code>public interface SQLRewriteEngine { 
    //åŸºäº SQLRewriteContext æ‰§è¡Œ SQL æ”¹å†™ 
    SQLRewriteResult rewrite(SQLRewriteContext sqlRewriteContext); 
}
</code></pre><p>SQLRewriteEngine æ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œå³æ ¹æ®è¾“å…¥çš„ SQLRewriteContext è¿”å›ä¸€ä¸ª SQLRewriteResult å¯¹è±¡ã€‚æˆ‘ä»¬é€šè¿‡å‰é¢çš„ä»‹ç»å·²ç»äº†è§£åˆ°ï¼Œå¯ä»¥é€šè¿‡è£…é¥°å™¨ç±»å¯¹ SQLRewriteContext è¿›è¡Œè£…é¥°ï¼Œä»è€Œæ»¡è¶³ä¸åŒåœºæ™¯çš„éœ€è¦ã€‚</p>
<p>æ³¨æ„åˆ° SQLRewriteEngine æ¥å£åªæœ‰ä¸¤ä¸ªå®ç°ç±»ï¼šåˆ†åˆ«æ˜¯ DefaultSQLRewriteEngine å’Œ ShardingSQLRewriteEngineã€‚æˆ‘ä»¬é‡ç‚¹å…³æ³¨ ShardingSQLRewriteEngineï¼Œä½†åœ¨ä»‹ç»è¿™ä¸ªæ”¹å†™å¼•æ“ç±»ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè¦ä»‹ç»ä¸€ä¸‹ <strong>SQLBuilder æ¥å£</strong>ï¼Œä»å®šä¹‰ä¸Šå¯ä»¥çœ‹å‡º SQLBuilder çš„ç›®çš„å°±æ˜¯æ„å»ºæœ€ç»ˆå¯ä»¥æ‰§è¡Œçš„ SQL è¯­å¥ï¼š</p>
<pre tabindex="0"><code>public interface SQLBuilder { 
    //ç”Ÿæˆ SQL 
    String toSQL(); 
}
</code></pre><p>SQLBuilder æ¥å£æœ‰ä¸€ä¸ªæŠ½è±¡çš„å®ç°ç±» AbstractSQLBuilderï¼Œå®ƒçš„ toSQL æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@Override 
public final String toSQL() { 
    if (context.getSqlTokens().isEmpty()) { 
        return context.getSql(); 
    } 
    Collections.sort(context.getSqlTokens()); 
    StringBuilder result = new StringBuilder(); 
    result.append(context.getSql().substring(0, context.getSqlTokens().get(0).getStartIndex())); 
   //æ ¹æ® SQLToken æ‹¼è£…ç›®æ ‡ SQL 
    for (SQLToken each : context.getSqlTokens()) { 
        result.append(getSQLTokenText(each)); 
        result.append(getConjunctionText(each)); 
    } 
    return result.toString(); 
}
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœ SQLRewriteContext çš„ sqlTokens ä¸ºç©ºï¼Œå°±ç›´æ¥è¿”å›ä¿å­˜åœ¨ SQLRewriteContext ä¸­çš„æœ€ç»ˆ SQLï¼›åä¹‹ï¼Œä¼šæ„å»ºä¸€ä¸ªä¿å­˜ SQLçš„StringBuilderï¼Œç„¶åä¾æ¬¡æ·»åŠ æ¯ä¸ª SQLTokenText ä»¥åŠè¿æ¥è¯ ConjunctionTextï¼Œä»è€Œæ‹¼è£…æˆä¸€ä¸ªå®Œæ•´çš„ SQL è¯­å¥ã€‚<strong>æ³¨æ„åˆ°ï¼Œè¿™é‡Œè·å– SQLTokenText çš„æ–¹æ³•æ˜¯ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ï¼Œéœ€è¦ AbstractSQLBuilder çš„å­ç±»è¿›è¡Œå®ç°ï¼š</strong></p>
<pre tabindex="0"><code>//è·å– SQLToken æ–‡æœ¬ 
protected abstract String getSQLTokenText(SQLToken sqlToken);
</code></pre><p>ä½œä¸º AbstractSQLBuilderçš„ä¸€ä¸ªå®ç°ç±»ï¼ŒShardingSQLBuilder çš„ getSQLTokenText æ–¹æ³•å°±åŒ…å«äº† SQL æ”¹å†™çš„ä¸€äº›åœºæ™¯ï¼š</p>
<pre tabindex="0"><code>@Override 
protected String getSQLTokenText(final SQLToken sqlToken) { 
    if (sqlToken instanceof RoutingUnitAware) { 
        return ((RoutingUnitAware) sqlToken).toString(routingUnit); 
    } 
    if (sqlToken instanceof LogicAndActualTablesAware) { 
        return ((LogicAndActualTablesAware) sqlToken).toString(getLogicAndActualTables()); 
    } 
    return sqlToken.toString(); 
}
</code></pre><p>å¯¹äºè¾“å…¥çš„ SQLTokenï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªç‰¹æ®Šçš„å¤„ç†ï¼Œå³åˆ¤æ–­æ˜¯å¦å®ç°äº† RoutingUnitAware æ¥å£æˆ– LogicAndActualTablesAware æ¥å£ã€‚æˆ‘ä»¬å‘ç°å®ç° RoutingUnitAware æ¥å£çš„åªæœ‰ ShardingInsertValuesTokenï¼›è€Œå®ç° LogicAndActualTablesAware çš„åˆ™æœ‰ IndexToken å’Œ TableToken ä¸¤ä¸ª SQLTokenã€‚</p>
<p>è¿™é‡Œä»¥å®ç°äº† LogicAndActualTablesAware çš„ TableToken ä¸ºä¾‹å±•å¼€è®¨è®ºã€‚<strong>è¡¨åæ”¹å†™</strong>å°±æ˜¯å°†é€»è¾‘è¡¨åæ”¹å†™ä¸ºçœŸå®è¡¨åçš„è¿‡ç¨‹ï¼Œæ˜¯ä¸€ä¸ªå…¸å‹çš„éœ€è¦å¯¹ SQL è¿›è¡Œæ”¹å†™çš„åœºæ™¯ã€‚æˆ‘ä»¬è€ƒè™‘æœ€ç®€å•è¡¨åæ”¹å†™åœºæ™¯ï¼Œå¦‚æœé€»è¾‘ SQL ä¸ºï¼š</p>
<pre tabindex="0"><code>SELECT user_name FROM user WHERE user_id = 1;
</code></pre><p>é‚£ä¹ˆï¼Œè¿™é‡Œçš„é€»è¾‘è¡¨åä¸º userã€‚å‡è®¾æˆ‘ä»¬é…ç½®äº†åˆ†ç‰‡é”® user_idï¼Œå¹¶ä¸” user_id = 1 çš„æƒ…å†µï¼Œå°†è·¯ç”±è‡³åˆ†ç‰‡è¡¨ user_1ï¼Œé‚£ä¹ˆæ”¹å†™ä¹‹åçš„ SQL åº”è¯¥ä¸ºï¼š</p>
<pre tabindex="0"><code>SELECT user_name FROM user_1 WHERE user_id = 1;
</code></pre><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„çœŸå®è¡¨ååº”è¯¥æ˜¯ user_1 è€Œä¸æ˜¯ userï¼Œåœ¨ç”¨äºæ”¹å†™è¡¨åçš„ TableToken ä¸­ï¼Œå®ƒçš„ toString å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@Override 
public String toString(final Map&lt;String, String&gt; logicAndActualTables) { 
    String actualTableName = logicAndActualTables.get(tableName.toLowerCase()); 
    actualTableName = null == actualTableName ? tableName.toLowerCase() : actualTableName; 
    return Joiner.on(&quot;&quot;).join(quoteCharacter.getStartDelimiter(), actualTableName, quoteCharacter.getEndDelimiter()); 
}
</code></pre><p>è¿™é‡Œçš„é€»è¾‘å¹¶ä¸å¤æ‚ï¼Œåªæ˜¯æ ¹æ®é€»è¾‘è¡¨åä» logicAndActualTables ä¸­è·å–çœŸå®è¡¨å actualTableNameï¼Œç„¶åè¿›è¡Œå­—ç¬¦ä¸²æ‹¼è£…è€Œå·²ã€‚é‚£ä¹ˆè¿™ä¸ª logicAndActualTables æ˜¯ä»ä½•è€Œæ¥å‘¢ï¼ŸlogicAndActualTables çš„æ„å»ºè¿‡ç¨‹æ˜¯åœ¨ ShardingSQLBuilder ä¸­ï¼š</p>
<pre tabindex="0"><code>private Map&lt;String, String&gt; getLogicAndActualTables() { 
    Map&lt;String, String&gt; result = new HashMap&lt;&gt;(); 
    Collection&lt;String&gt; tableNames = getContext().getSqlStatementContext().getTablesContext().getTableNames(); 
    for (TableUnit each : routingUnit.getTableUnits()) { 
        String logicTableName = each.getLogicTableName().toLowerCase(); 
        result.put(logicTableName, each.getActualTableName()); 
            result.putAll(getLogicAndActualTablesFromBindingTable(routingUnit.getMasterSlaveLogicDataSourceName(), each, tableNames)); 
    } 
    return result; 
}
</code></pre><p>ä¸Šè¿°ä»£ç å®é™…ä¸Šä¹Ÿåªæ˜¯åšäº†æ•°æ®ç»“æ„çš„æ‹¼è£…ï¼Œæˆ‘ä»¬æ²¿ç€è¿™é‡Œçš„ getLogicAndActualTablesFromBindingTable æ–¹æ³•ç»§ç»­å¾€ä¸‹çœ‹ï¼Œä¼šå‘ç°æ ¹æ® logicTable è·å– actualTable çš„è¿‡ç¨‹å®é™…ä¸Šæ˜¯å‘ç”Ÿåœ¨ BindingTableRule ä¸­ï¼š</p>
<pre tabindex="0"><code>public String getBindingActualTable(final String dataSource, final String logicTable, final String otherActualTable) { 
        int index = -1; 
        for (TableRule each : tableRules) { 
            index = each.findActualTableIndex(dataSource, otherActualTable); 
            if (-1 != index) { 
                break; 
            } 
        } 
        if (-1 == index) { 
            throw new ShardingConfigurationException(&quot;Actual table [%s].[%s] is not in table config&quot;, dataSource, otherActualTable); 
        } 
        for (TableRule each : tableRules) { 
            if (each.getLogicTable().equals(logicTable.toLowerCase())) { 
                return each.getActualDataNodes().get(index).getTableName().toLowerCase(); 
            } 
        } 
        throw new ShardingConfigurationException(&quot;Cannot find binding actual table, data source: %s, logic table: %s, other actual table: %s&quot;, dataSource, logicTable, otherActualTable); 
}
</code></pre><p>è€Œ BindingTableRule åˆä¾èµ–äº TableRule ä¸­ä¿å­˜çš„ ActualDataNodes æ¥å®Œæˆ ActualTableIndexå’ŒActualTable çš„è®¡ç®—ã€‚å›æƒ³èµ·æˆ‘ä»¬åœ¨æ¡ˆä¾‹ä¸­é…ç½®çš„åˆ†åº“åˆ†è¡¨è§„åˆ™ï¼Œè¿™é‡Œå†æ¬¡æ„Ÿå—åˆ°äº†ä»¥ TableRule å’Œ BindingTableRuleä¸º ä»£è¡¨çš„å„ç§ Rule å¯¹è±¡åœ¨ ShardingSphere çš„ä¸²è”ä½œç”¨ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/Ciqc1F8-KfuASC1zAAB-5yBwv_o382.png" alt="image"></p>
<p>å½“ ShardingSQLBuilder å®Œæˆ SQL çš„æ„å»ºä¹‹åï¼Œæˆ‘ä»¬å†å›åˆ° ShardingSQLRewriteEngineï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯¹å®ƒçš„ rewrite æ–¹æ³•å°±æ¯”è¾ƒæ˜ç¡®äº†ï¼š</p>
<pre tabindex="0"><code>@Override 
public SQLRewriteResult rewrite(final SQLRewriteContext sqlRewriteContext) { 
    return new SQLRewriteResult(new ShardingSQLBuilder(sqlRewriteContext, shardingRule, routingUnit).toSQL(), getParameters(sqlRewriteContext.getParameterBuilder())); 
}
</code></pre><p>æ”¹å†™å¼•æ“çš„è¾“å‡º SQLRewriteResult å¯¹è±¡å°±åŒ…å«äº†æœ€ç»ˆçš„ SQL ä»¥åŠé…å¥—çš„å‚æ•°åˆ—è¡¨ï¼š</p>
<pre tabindex="0"><code>public final class SQLRewriteResult {
    private final String sql;
    private final List&lt;Object&gt; parameters; 
}
</code></pre><p>è®²å®Œ ShardingSQLRewriteEngine ä¹‹åï¼Œæˆ‘ä»¬æœ€åå›åˆ° BaseShardingEngine çš„ rewriteAndConvert æ–¹æ³•ã€‚ç°åœ¨ï¼Œè¯¥æ–¹æ³•ä¸­é™¤äº† EncryptSQLRewriteContextDecorator éƒ¨åˆ†çš„å†…å®¹æ¶‰åŠæ•°æ®è„±æ•åŠŸèƒ½ï¼Œå…¶ä»–çš„éƒ¨åˆ†æˆ‘ä»¬åº”è¯¥éƒ½èƒ½æ˜ç™½æ•´ä½“çš„æ‰§è¡Œæµç¨‹ã€‚è¯¥æ–¹æ³•æœ€ç»ˆè¿”å›çš„æ˜¯ä¸€ä¸ª RouteUnit åˆ—è¡¨ï¼ŒRouteUnit ä¸­åˆåŒ…å«äº† SQLUnitï¼š</p>
<pre tabindex="0"><code>public final class RouteUnit { 
    //ç›®æ ‡æ•°æ®æºå 
    private final String dataSourceName; 
    //SQL å•å…ƒ 
    private final SQLUnit sqlUnit; 
} 

public final class SQLUnit { 
    //ç›®æ ‡ SQL 
    private final String sql; 
    //å‚æ•°åˆ—è¡¨ 
    private final List&lt;Object&gt; parameters; 
}
</code></pre><p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆçš„ç»“æœå®é™…ä¸Šå°±æ˜¯ç›®æ ‡æ•°æ®åº“ã€ç›®æ ‡ SQL ä»¥åŠç›¸å…³å‚æ•°ï¼Œä¸€æ—¦æˆ‘ä»¬è·å–äº†è¿™äº›ä¿¡æ¯ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œä¸€æ¡ SQL è¯­å¥ã€‚</p>
<h3 id="ä»æºç è§£æåˆ°æ—¥å¸¸å¼€å‘">ä»æºç è§£æåˆ°æ—¥å¸¸å¼€å‘</h3>
<p>åœ¨ä»Šå¤©çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ˜æ˜¾æ„Ÿå—åˆ°<strong>è£…é¥°å™¨æ¨¡å¼</strong>çš„å¼ºå¤§ä½œç”¨ã€‚è£…é¥°å™¨æ¨¡å¼å…è®¸å‘ä¸€ä¸ªç°æœ‰çš„å¯¹è±¡æ·»åŠ æ–°çš„åŠŸèƒ½ï¼ŒåŒæ—¶åˆä¸æ”¹å˜å…¶ç»“æ„ï¼Œè¿™ç§æ¨¡å¼åˆ›å»ºäº†ä¸€ä¸ªè£…é¥°ç±»ï¼Œç”¨æ¥åŒ…è£…åŸæœ‰çš„ç±»ï¼Œå¹¶åœ¨ä¿æŒç±»æ–¹æ³•ç­¾åå®Œæ•´æ€§çš„å‰æä¸‹ï¼Œæä¾›äº†é¢å¤–çš„åŠŸèƒ½ã€‚</p>
<p>åŒæ—¶ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°åœ¨ ShardingSphere ä¸­ï¼Œè£…é¥°å™¨æ¨¡å¼çš„ä½œç”¨å¯¹è±¡æ˜¯ä¸€ä¸ª <strong>SQLRewriteContext</strong> ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œè¿™æ˜¯ä¸€ç§å€¼å¾—å­¦ä¹ çš„åšæ³•ã€‚åœ¨æ—¥å¸¸å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠéœ€è¦æ ¹æ®ä¸åŒåœºæ™¯è¿›è¡Œä¸åŒå¤„ç†çš„ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ä¸­ï¼Œç„¶ååŸºäºè£…é¥°å™¨æ¨¡å¼å¯¹è¿™äº›ä¿¡æ¯è¿›è¡Œè£…é¥°ã€‚ä¸¤è€…çš„æ— ç¼é›†æˆï¼Œå¯ä»¥åœ¨å¾ˆå¤šåº”ç”¨åœºæ™¯ä¸‹ï¼Œå®ŒæˆåŸºäºå­ç±»å®ç°æ–¹å¼æ‰€ä¸èƒ½å®Œæˆçš„åŠŸèƒ½ï¼Œä»è€Œä¸ºå¯¹è±¡åŠ¨æ€æ·»åŠ ä¸€äº›é¢å¤–çš„èŒè´£ã€‚</p>
<h3 id="å°ç»“ä¸é¢„å‘Š">å°ç»“ä¸é¢„å‘Š</h3>
<p>ä»Šå¤©ï¼Œæˆ‘ä»¬èŠ±äº†ä¸€ä¸ªè¯¾æ—¶çš„æ—¶é—´å®Œæ•´ä»‹ç»äº† ShardingSphere ä¸­æ”¹å†™å¼•æ“çš„åŸºæœ¬ç»“æ„å’Œå„ä¸ªæ ¸å¿ƒç±»ã€‚<strong>æ”¹å†™å¼•æ“</strong>åœ¨è®¾è®¡ä¸Šä½¿ç”¨äº†è£…é¥°å™¨æ¨¡å¼ï¼Œå®Œæˆäº†ä»é€»è¾‘ SQL åˆ°ç›®æ ‡ SQL çš„æ”¹å†™è¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¹Ÿé’ˆå¯¹<strong>è‡ªå¢ä¸»é”®</strong>å’Œ<strong>è¡¨åæ”¹å†™</strong>è¿™ä¸¤ä¸ªå…¸å‹çš„åº”ç”¨åœºæ™¯ï¼Œç»™å‡ºäº†å¯¹åº”çš„å®ç°åŸç†å’Œæºç åˆ†æã€‚</p>
<p>è¯·æ³¨æ„ï¼Œæ”¹å†™å¼•æ“åœ¨ ShardingSphere ä¸­ä¸ä»…ä»…åªç”¨äºè¿™äº›åœºæ™¯ï¼Œåœ¨åé¢çš„è¯¾ç¨‹â€œ30 | æ•°æ®è„±æ•ï¼šå¦‚ä½•åŸºäºæ”¹å†™å¼•æ“å®ç°ä½ä¾µå…¥æ€§æ•°æ®è„±æ•æ–¹æ¡ˆï¼Ÿâ€ä¸­ï¼Œæˆ‘ä»¬è¿˜ä¼šçœ‹åˆ°å®ƒåœ¨æ•°æ®è„±æ•ç­‰åœºæ™¯ä¸‹çš„åº”ç”¨ã€‚</p>
<p>æœ€åç»™ä½ ç•™ä¸€é“æ€è€ƒé¢˜ï¼šShardingSphere ä¸­ï¼Œå¦‚ä½•é€šè¿‡è£…é¥°å™¨æ¨¡å¼å¯¹ SQL æ”¹å†™çš„ä¸Šä¸‹æ–‡è¿›è¡Œè£…é¥°ï¼Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸å¤§å®¶è®¨è®ºï¼Œæˆ‘å°†é€ä¸€ç‚¹è¯„è§£ç­”ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»é’ˆå¯¹è¾“å…¥çš„é€»è¾‘ SQL é€šè¿‡æ”¹å†™å¼•æ“è·å–äº†ç›®æ ‡ SQLï¼Œæœ‰äº†ç›®æ ‡ SQL æ¥ä¸‹æ¥å°±å¯ä»¥æ‰§è¡Œ SQL äº†ï¼Œè¿™å°±æ˜¯ä¸‹ä¸€è¯¾æ—¶ä¸­è¦å¼€å§‹ä»‹ç»çš„ ShardingSphere æ‰§è¡Œå¼•æ“è¦åšçš„äº‹æƒ…ã€‚</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/19-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%9C%A8%E8%B7%AF%E7%94%B1%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%9B%86%E6%88%90%E5%A4%9A%E7%A7%8D%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E5%92%8C%E8%B7%AF%E7%94%B1%E7%AE%97%E6%B3%95/"><span>19 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•åœ¨è·¯ç”±è¿‡ç¨‹ä¸­é›†æˆå¤šç§è·¯ç”±ç­–ç•¥å’Œè·¯ç”±ç®—æ³•ï¼Ÿ</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/21-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%88%86%E7%89%87%E7%8E%AF%E5%A2%83%E4%B8%8B-sql-%E6%89%A7%E8%A1%8C%E7%9A%84%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E6%8A%BD%E8%B1%A1/"><span>21 æ‰§è¡Œå¼•æ“ï¼šåˆ†ç‰‡ç¯å¢ƒä¸‹ SQL æ‰§è¡Œçš„æ•´ä½“æµç¨‹åº”è¯¥å¦‚ä½•è¿›è¡ŒæŠ½è±¡ï¼Ÿ</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 27270 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>