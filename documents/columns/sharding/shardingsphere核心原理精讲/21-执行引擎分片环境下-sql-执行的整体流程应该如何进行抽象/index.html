<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>21 æ‰§è¡Œå¼•æ“ï¼šåˆ†ç‰‡ç¯å¢ƒä¸‹ SQL æ‰§è¡Œçš„æ•´ä½“æµç¨‹åº”è¯¥å¦‚ä½•è¿›è¡ŒæŠ½è±¡ï¼Ÿ | Yipsen Ye</title>
<meta name="description" content="ä»ä»Šå¤©å¼€å§‹ï¼Œæˆ‘ä»¬å°†å¼€å§‹ä¸€ä¸ªå…¨æ–°çš„ä¸»é¢˜ï¼Œå³ ShardingSphere çš„æ‰§è¡Œå¼•æ“ï¼ˆExecuteEngineï¼‰ã€‚ä¸€æ—¦æˆ‘ä»¬è·å–äº†ä»è·¯ç”±å¼•æ“å’Œæ”¹å†™å¼•æ“ä¸­æ‰€ç”Ÿæˆçš„ SQLï¼Œæ‰§è¡Œå¼•æ“å°±ä¼šå®Œæˆè¿™äº›SQLåœ¨å…·ä½“æ•°æ®åº“ä¸­çš„æ‰§è¡Œã€‚
æ‰§è¡Œå¼•æ“æ˜¯ ShardingSphere çš„æ ¸å¿ƒæ¨¡å—ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†é€šè¿‡ä¸‰ä¸ªè¯¾æ—¶æ¥å¯¹å…¶è¿›è¡Œå…¨é¢ä»‹ç»ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å…ˆè®¨è®ºåœ¨åˆ†ç‰‡ç¯å¢ƒä¸‹ï¼ŒShardingSphere å¯¹ SQL æ‰§è¡Œçš„æ•´ä½“æµç¨‹çš„æŠ½è±¡è¿‡ç¨‹ï¼Œåä¸¤ä¸ªè¯¾æ—¶ä¼šå‘ä½ è®²è§£â€œå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹â€ã€‚
ShardingSphere æ‰§è¡Œå¼•æ“æ€»ä½“ç»“æ„ åœ¨è®²è§£å…·ä½“çš„æºä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬ä»ã€Š17 | è·¯ç”±å¼•æ“ï¼šå¦‚ä½•ç†è§£åˆ†ç‰‡è·¯ç”±æ ¸å¿ƒç±» ShardingRouter çš„è¿ä½œæœºåˆ¶ï¼Ÿã€‹ä¸­çš„ PreparedQueryShardingEngine å’Œ SimpleQueryShardingEngine è¿™ä¸¤ä¸ªç±»å‡ºå‘ï¼Œçœ‹çœ‹åœ¨ ShardingSphere ä¸­ä½¿ç”¨å®ƒä»¬çš„å…¥å£ã€‚
æˆ‘ä»¬åœ¨ShardingStatementç±»ä¸­æ‰¾åˆ°äº†å¦‚ä¸‹æ‰€ç¤ºçš„ä¸€ä¸ª shard æ–¹æ³•ï¼Œè¿™é‡Œç”¨åˆ°äº† SimpleQueryShardingEngineï¼š
private void shard(final String sql) {//ä» Connection ä¸­è·å– ShardingRuntimeContext ä¸Šä¸‹æ–‡ShardingRuntimeContext runtimeContext = connection.getRuntimeContext(); //åˆ›å»º SimpleQueryShardingEngineSimpleQueryShardingEngine shardingEngine = new SimpleQueryShardingEngine(runtimeContext.getRule(), runtimeContext.getProps(), runtimeContext.getMetaData(), runtimeContext.getParseEngine()); //æ‰§è¡Œåˆ†ç‰‡è·¯ç”±å¹¶è·å–è·¯ç”±ç»“æœsqlRouteResult = shardingEngine.shard(sql, Collections.emptyList());}è€Œåœ¨ShardingPreparedStatementä¸­ä¹Ÿå­˜åœ¨ä¸€ä¸ªç±»ä¼¼çš„ shard æ–¹æ³•ã€‚
ä»è®¾è®¡æ¨¡å¼ä¸Šè®²ï¼ŒShardingStatement å’Œ ShardingPreparedStatement å®é™…ä¸Šå°±æ˜¯å¾ˆå…¸å‹çš„å¤–è§‚ç±»ï¼Œå®ƒä»¬æŠŠä¸ SQL è·¯ç”±å’Œæ‰§è¡Œçš„å…¥å£ç±»éƒ½æ•´åˆåœ¨ä¸€èµ·ã€‚">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/shardingsphere%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e7%b2%be%e8%ae%b2/">ShardingSphereæ ¸å¿ƒåŸç†ç²¾è®²</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/00-%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E5%AD%A6%E4%B9%A0%E4%B8%80%E6%AC%BE%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/">00 å¦‚ä½•æ­£ç¡®å­¦ä¹ ä¸€æ¬¾åˆ†åº“åˆ†è¡¨å¼€æºæ¡†æ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/01-%E4%BB%8E%E7%90%86%E8%AE%BA%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%A6%82%E4%BD%95%E8%AE%A9%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%9C%9F%E6%AD%A3%E8%90%BD%E5%9C%B0/">01 ä»ç†è®ºåˆ°å®è·µï¼šå¦‚ä½•è®©åˆ†åº“åˆ†è¡¨çœŸæ­£è½åœ°ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/02-%E9%A1%B6%E7%BA%A7%E9%A1%B9%E7%9B%AEshardingsphere-%E6%98%AF%E4%B8%80%E6%AC%BE%E4%BB%80%E4%B9%88%E6%A0%B7%E7%9A%84-apache-%E5%BC%80%E6%BA%90%E8%BD%AF%E4%BB%B6/">02 é¡¶çº§é¡¹ç›®ï¼šShardingSphere æ˜¯ä¸€æ¬¾ä»€ä¹ˆæ ·çš„ Apache å¼€æºè½¯ä»¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/03-%E8%A7%84%E8%8C%83%E5%85%BC%E5%AE%B9jdbc-%E8%A7%84%E8%8C%83%E4%B8%8E-shardingsphere-%E6%98%AF%E4%BB%80%E4%B9%88%E5%85%B3%E7%B3%BB/">03 è§„èŒƒå…¼å®¹ï¼šJDBC è§„èŒƒä¸ ShardingSphere æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/04-%E5%BA%94%E7%94%A8%E9%9B%86%E6%88%90%E5%9C%A8%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F%E4%B8%AD%E4%BD%BF%E7%94%A8-shardingsphere-%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9C%89%E5%93%AA%E4%BA%9B/">04 åº”ç”¨é›†æˆï¼šåœ¨ä¸šåŠ¡ç³»ç»Ÿä¸­ä½¿ç”¨ ShardingSphere çš„æ–¹å¼æœ‰å“ªäº›ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/05-%E9%85%8D%E7%BD%AE%E9%A9%B1%E5%8A%A8shardingsphere-%E4%B8%AD%E7%9A%84%E9%85%8D%E7%BD%AE%E4%BD%93%E7%B3%BB%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E7%9A%84/">05 é…ç½®é©±åŠ¨ï¼šShardingSphere ä¸­çš„é…ç½®ä½“ç³»æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/09-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E4%B8%8E%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1/">09 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¦‚ä½•ä½¿ç”¨å¼ºä¸€è‡´æ€§äº‹åŠ¡ä¸æŸ”æ€§äº‹åŠ¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/10-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E5%A6%82%E4%BD%95%E7%A1%AE%E4%BF%9D%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AE%89%E5%85%A8%E8%AE%BF%E9%97%AE/">10 æ•°æ®è„±æ•ï¼šå¦‚ä½•ç¡®ä¿æ•æ„Ÿæ•°æ®çš„å®‰å…¨è®¿é—®ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/11-%E7%BC%96%E6%8E%92%E6%B2%BB%E7%90%86%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/">11 ç¼–æ’æ²»ç†ï¼šå¦‚ä½•å®ç°åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„åŠ¨æ€é…ç½®ç®¡ç†ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/12-%E4%BB%8E%E5%BA%94%E7%94%A8%E5%88%B0%E5%8E%9F%E7%90%86%E5%A6%82%E4%BD%95%E9%AB%98%E6%95%88%E9%98%85%E8%AF%BB-shardingsphere-%E6%BA%90%E7%A0%81/">12 ä»åº”ç”¨åˆ°åŸç†ï¼šå¦‚ä½•é«˜æ•ˆé˜…è¯» ShardingSphere æºç ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/13-%E5%BE%AE%E5%86%85%E6%A0%B8%E6%9E%B6%E6%9E%84shardingsphere-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%89%A9%E5%B1%95%E6%80%A7/">13 å¾®å†…æ ¸æ¶æ„ï¼šShardingSphere å¦‚ä½•å®ç°ç³»ç»Ÿçš„æ‰©å±•æ€§ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/14-%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AEshardingsphere-%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AE%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F/">14 åˆ†å¸ƒå¼ä¸»é”®ï¼šShardingSphere ä¸­æœ‰å“ªäº›åˆ†å¸ƒå¼ä¸»é”®å®ç°æ–¹å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/15-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8A/">15 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/16-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8B/">16 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/17-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E5%88%86%E7%89%87%E8%B7%AF%E7%94%B1%E6%A0%B8%E5%BF%83%E7%B1%BB-shardingrouter-%E7%9A%84%E8%BF%90%E4%BD%9C%E6%9C%BA%E5%88%B6/">17 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•ç†è§£åˆ†ç‰‡è·¯ç”±æ ¸å¿ƒç±» ShardingRouter çš„è¿ä½œæœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/18-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E7%9A%84%E5%88%86%E7%89%87%E8%B7%AF%E7%94%B1%E5%92%8C%E5%B9%BF%E6%92%AD%E8%B7%AF%E7%94%B1/">18 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•å®ç°æ•°æ®è®¿é—®çš„åˆ†ç‰‡è·¯ç”±å’Œå¹¿æ’­è·¯ç”±ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/19-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%9C%A8%E8%B7%AF%E7%94%B1%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%9B%86%E6%88%90%E5%A4%9A%E7%A7%8D%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E5%92%8C%E8%B7%AF%E7%94%B1%E7%AE%97%E6%B3%95/">19 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•åœ¨è·¯ç”±è¿‡ç¨‹ä¸­é›†æˆå¤šç§è·¯ç”±ç­–ç•¥å’Œè·¯ç”±ç®—æ³•ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/20-%E6%94%B9%E5%86%99%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84-sql-%E6%94%B9%E5%86%99%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6/">20 æ”¹å†™å¼•æ“ï¼šå¦‚ä½•ç†è§£è£…é¥°å™¨æ¨¡å¼ä¸‹çš„ SQL æ”¹å†™å®ç°æœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li>21 æ‰§è¡Œå¼•æ“ï¼šåˆ†ç‰‡ç¯å¢ƒä¸‹ SQL æ‰§è¡Œçš„æ•´ä½“æµç¨‹åº”è¯¥å¦‚ä½•è¿›è¡ŒæŠ½è±¡ï¼Ÿ</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/22-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E6%8A%8A%E6%8F%A1-shardingsphere-%E4%B8%AD%E7%9A%84-executor-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8A/">22 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/23-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E6%8A%8A%E6%8F%A1-shardingsphere-%E4%B8%AD%E7%9A%84-executor-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8B/">23 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/24-%E5%BD%92%E5%B9%B6%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E6%95%B0%E6%8D%AE%E5%BD%92%E5%B9%B6%E7%9A%84%E7%B1%BB%E5%9E%8B%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%BD%92%E5%B9%B6%E7%AD%96%E7%95%A5%E7%9A%84%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B/">24 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æ•°æ®å½’å¹¶çš„ç±»å‹ä»¥åŠç®€å•å½’å¹¶ç­–ç•¥çš„å®ç°è¿‡ç¨‹ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/25-%E5%BD%92%E5%B9%B6%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E6%B5%81%E5%BC%8F%E5%BD%92%E5%B9%B6%E5%92%8C%E5%86%85%E5%AD%98%E5%BD%92%E5%B9%B6%E5%9C%A8%E5%A4%8D%E6%9D%82%E5%BD%92%E5%B9%B6%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84%E5%BA%94%E7%94%A8%E6%96%B9%E5%BC%8F/">25 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æµå¼å½’å¹¶å’Œå†…å­˜å½’å¹¶åœ¨å¤æ‚å½’å¹¶åœºæ™¯ä¸‹çš„åº”ç”¨æ–¹å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/26-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%99%AE%E9%80%9A%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%92%8C%E5%88%86%E7%89%87%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%88%86%E5%88%AB%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84/">26 è¯»å†™åˆ†ç¦»ï¼šæ™®é€šä¸»ä»æ¶æ„å’Œåˆ†ç‰‡ä¸»ä»æ¶æ„åˆ†åˆ«æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/27-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3-shardingsphere-%E4%B8%AD%E5%AF%B9%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%8A%BD%E8%B1%A1%E8%BF%87%E7%A8%8B/">27 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¦‚ä½•ç†è§£ ShardingSphere ä¸­å¯¹åˆ†å¸ƒå¼äº‹åŠ¡çš„æŠ½è±¡è¿‡ç¨‹ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/28-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1shardingsphere-%E4%B8%AD%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%E4%B8%8A/">28 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/29-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1shardingsphere-%E4%B8%AD%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%E4%B8%8B/">29 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/30-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E6%94%B9%E5%86%99%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%E4%BD%8E%E4%BE%B5%E5%85%A5%E6%80%A7%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E6%96%B9%E6%A1%88/">30 æ•°æ®è„±æ•ï¼šå¦‚ä½•åŸºäºæ”¹å†™å¼•æ“å®ç°ä½ä¾µå…¥æ€§æ•°æ®è„±æ•æ–¹æ¡ˆï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/31-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E7%9A%84%E5%8A%A8%E6%80%81%E5%8C%96%E7%AE%A1%E7%90%86/">31 é…ç½®ä¸­å¿ƒï¼šå¦‚ä½•åŸºäºé…ç½®ä¸­å¿ƒå®ç°é…ç½®ä¿¡æ¯çš„åŠ¨æ€åŒ–ç®¡ç†ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/32-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BF%E9%97%AE%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6/">32 æ³¨å†Œä¸­å¿ƒï¼šå¦‚ä½•åŸºäºæ³¨å†Œä¸­å¿ƒå®ç°æ•°æ®åº“è®¿é—®ç†”æ–­æœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/33-%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E-hook-%E6%9C%BA%E5%88%B6%E4%BB%A5%E5%8F%8A-opentracing-%E5%8D%8F%E8%AE%AE%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA/">33 é“¾è·¯è·Ÿè¸ªï¼šå¦‚ä½•åŸºäº Hook æœºåˆ¶ä»¥åŠ OpenTracing åè®®å®ç°æ•°æ®è®¿é—®é“¾è·¯è·Ÿè¸ªï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/35-%E7%BB%93%E8%AF%ADshardingsphere-%E6%80%BB%E7%BB%93%E5%8F%8A%E5%B1%95%E6%9C%9B/">35 ç»“è¯­ï¼šShardingSphere æ€»ç»“åŠå±•æœ›</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">21 æ‰§è¡Œå¼•æ“ï¼šåˆ†ç‰‡ç¯å¢ƒä¸‹ SQL æ‰§è¡Œçš„æ•´ä½“æµç¨‹åº”è¯¥å¦‚ä½•è¿›è¡ŒæŠ½è±¡ï¼Ÿ</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2021-12-22 01:56:00</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/sharding/">sharding</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/">ShardingSphereæ ¸å¿ƒåŸç†ç²¾è®²</a>
                
            </div></div>
        <div class="post-content">
            <p>ä»ä»Šå¤©å¼€å§‹ï¼Œæˆ‘ä»¬å°†å¼€å§‹ä¸€ä¸ªå…¨æ–°çš„ä¸»é¢˜ï¼Œå³ ShardingSphere çš„æ‰§è¡Œå¼•æ“ï¼ˆExecuteEngineï¼‰ã€‚<strong>ä¸€æ—¦æˆ‘ä»¬è·å–äº†</strong>ä»è·¯ç”±å¼•æ“å’Œæ”¹å†™å¼•æ“ä¸­æ‰€ç”Ÿæˆçš„ SQLï¼Œ<strong>æ‰§è¡Œå¼•æ“</strong>å°±ä¼šå®Œæˆè¿™äº›SQLåœ¨å…·ä½“æ•°æ®åº“ä¸­çš„æ‰§è¡Œã€‚</p>
<p>æ‰§è¡Œå¼•æ“æ˜¯ ShardingSphere çš„æ ¸å¿ƒæ¨¡å—ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†é€šè¿‡ä¸‰ä¸ªè¯¾æ—¶æ¥å¯¹å…¶è¿›è¡Œå…¨é¢ä»‹ç»ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å…ˆè®¨è®ºåœ¨åˆ†ç‰‡ç¯å¢ƒä¸‹ï¼ŒShardingSphere å¯¹ SQL æ‰§è¡Œçš„æ•´ä½“æµç¨‹çš„æŠ½è±¡è¿‡ç¨‹ï¼Œåä¸¤ä¸ªè¯¾æ—¶ä¼šå‘ä½ è®²è§£â€œå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹â€ã€‚</p>
<h3 id="shardingsphere-æ‰§è¡Œå¼•æ“æ€»ä½“ç»“æ„">ShardingSphere æ‰§è¡Œå¼•æ“æ€»ä½“ç»“æ„</h3>
<p>åœ¨è®²è§£å…·ä½“çš„æºä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬ä»ã€Š17 | è·¯ç”±å¼•æ“ï¼šå¦‚ä½•ç†è§£åˆ†ç‰‡è·¯ç”±æ ¸å¿ƒç±» ShardingRouter çš„è¿ä½œæœºåˆ¶ï¼Ÿã€‹ä¸­çš„ PreparedQueryShardingEngine å’Œ SimpleQueryShardingEngine è¿™ä¸¤ä¸ªç±»å‡ºå‘ï¼Œ<strong>çœ‹çœ‹åœ¨ ShardingSphere ä¸­ä½¿ç”¨å®ƒä»¬çš„å…¥å£</strong>ã€‚</p>
<p>æˆ‘ä»¬åœ¨<strong>ShardingStatement</strong>ç±»ä¸­æ‰¾åˆ°äº†å¦‚ä¸‹æ‰€ç¤ºçš„ä¸€ä¸ª shard æ–¹æ³•ï¼Œè¿™é‡Œç”¨åˆ°äº† SimpleQueryShardingEngineï¼š</p>
<pre tabindex="0"><code>private void shard(final String sql) {
    //ä» Connection ä¸­è·å– ShardingRuntimeContext ä¸Šä¸‹æ–‡
    ShardingRuntimeContext runtimeContext = connection.getRuntimeContext(); 
    //åˆ›å»º SimpleQueryShardingEngine
    SimpleQueryShardingEngine shardingEngine = new SimpleQueryShardingEngine(runtimeContext.getRule(), runtimeContext.getProps(), runtimeContext.getMetaData(), runtimeContext.getParseEngine()); 
    //æ‰§è¡Œåˆ†ç‰‡è·¯ç”±å¹¶è·å–è·¯ç”±ç»“æœ
    sqlRouteResult = shardingEngine.shard(sql, Collections.emptyList());
}
</code></pre><p>è€Œåœ¨<strong>ShardingPreparedStatement</strong>ä¸­ä¹Ÿå­˜åœ¨ä¸€ä¸ªç±»ä¼¼çš„ shard æ–¹æ³•ã€‚</p>
<p>ä»è®¾è®¡æ¨¡å¼ä¸Šè®²ï¼ŒShardingStatement å’Œ ShardingPreparedStatement å®é™…ä¸Šå°±æ˜¯å¾ˆå…¸å‹çš„<strong>å¤–è§‚ç±»</strong>ï¼Œå®ƒä»¬æŠŠä¸ SQL è·¯ç”±å’Œæ‰§è¡Œçš„å…¥å£ç±»éƒ½æ•´åˆåœ¨ä¸€èµ·ã€‚</p>
<p>é€šè¿‡é˜…è¯»<a href="https://github.com/tianyilan12/shardingsphere-demo">æºç </a>ï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°åœ¨ ShardingStatement ä¸­å­˜åœ¨ä¸€ä¸ª StatementExecutorï¼›è€Œåœ¨ ShardingPreparedStatement ä¸­ä¹Ÿå­˜åœ¨ PreparedStatementExecutor å’Œ BatchPreparedStatementExecutorï¼Œè¿™äº›ç±»éƒ½ä»¥ Executor ç»“å°¾ï¼Œ<strong>æ˜¾ç„¶è¿™å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„ SQL æ‰§è¡Œå¼•æ“çš„å…¥å£ç±»ã€‚</strong></p>
<p>æˆ‘ä»¬å‘ç°ä¸Šè¿°ä¸‰ä¸ª Executor éƒ½ä½äº sharding-jdbc-core å·¥ç¨‹ä¸­ã€‚</p>
<p>æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªä¸ sharding-core-route å’Œ sharding-core-rewrite å¹¶åˆ—çš„<strong>sharding-core-execute å·¥ç¨‹</strong>ï¼Œä»å‘½åä¸Šçœ‹ï¼Œè¿™ä¸ªå·¥ç¨‹åº”è¯¥ä¹Ÿä¸æ‰§è¡Œå¼•æ“ç›¸å…³ã€‚æœç„¶ï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ªå·¥ç¨‹ä¸­æ‰¾åˆ°äº†<strong>ShardingExecuteEngine ç±»ï¼Œè¿™æ˜¯åˆ†ç‰‡æ‰§è¡Œå¼•æ“çš„å…¥å£ç±»</strong>ã€‚</p>
<p>ç„¶åï¼Œæˆ‘ä»¬åˆåˆ†åˆ«æ‰¾åˆ°äº† SQLExecuteTemplate å’Œ SQLExecutePrepareTemplate ç±»ï¼Œè¿™ä¸¤ä¸ªæ˜¯å…¸å‹çš„<strong>SQL æ‰§è¡Œæ¨¡æ¿ç±»</strong>ã€‚</p>
<p>æ ¹æ®åˆ°ç›®å‰ä¸ºæ­¢å¯¹ ShardingSphere ç»„ä»¶è®¾è®¡å’Œä»£ç åˆ†å±‚é£æ ¼çš„äº†è§£ï¼Œå¯ä»¥æƒ³è±¡ï¼Œåœ¨å±‚æ¬¡å…³ç³»ä¸Šï¼ŒShardingExecuteEngine æ˜¯åº•å±‚å¯¹è±¡ï¼ŒSQLExecuteTemplate åº”è¯¥ä¾èµ–äº ShardingExecuteEngineï¼›è€Œ StatementExecutorã€PreparedStatementExecutor å’Œ BatchPreparedStatementExecutor å±äºä¸Šå±‚å¯¹è±¡ï¼Œåº”è¯¥ä¾èµ–äº SQLExecuteTemplateã€‚æˆ‘ä»¬é€šè¿‡ç®€å•é˜…è¯»è¿™äº›æ ¸å¿ƒç±»ä¹‹å‰çš„å¼•ç”¨å…³ç³»ï¼Œå°è¯äº†è¿™ç§çŒœæƒ³ã€‚</p>
<p>åŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘ä»¬å¯ä»¥ç»™å‡º SQL æ‰§è¡Œå¼•æ“çš„æ•´ä½“ç»“æ„å›¾ï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼Œå…¶ä¸­æ¨ªçº¿ä»¥ä¸Šéƒ¨åˆ†ä½äº sharding-core-execute å·¥ç¨‹ï¼Œå±äºåº•å±‚ç»„ä»¶ï¼›è€Œç›´çº¿ä»¥ä¸‹éƒ¨åˆ†ä½äº sharding-jdbc-core ä¸­ï¼Œå±äºä¸Šå±‚ç»„ä»¶ã€‚è¿™ç§åˆ†ææºç çš„èƒ½åŠ›ä¹Ÿæ˜¯ã€Š12 | ä»åº”ç”¨åˆ°åŸç†ï¼šå¦‚ä½•é«˜æ•ˆé˜…è¯» ShardingSphere æºç ï¼Ÿã€‹ä¸­æåˆ°çš„â€œåŸºäºåˆ†åŒ…è®¾è®¡åŸåˆ™é˜…è¯»æºç â€çš„ä¸€ç§å…·ä½“è¡¨ç°ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/CgqCHl9Dei6AMqoCAACpyMuj2MI683.png" alt="Drawing 0.png"></p>
<p>ShardingSphere æ‰§è¡Œå¼•æ“æ ¸å¿ƒç±»çš„åˆ†å±‚ç»“æ„å›¾</p>
<p>å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬åœ¨ä¸Šå›¾ä¸­è¿˜çœ‹åˆ° SQLExecuteCallback å’Œ SQLExecutePrepareCallbackï¼Œæ˜¾ç„¶ï¼Œå®ƒä»¬çš„ä½œç”¨æ˜¯å®Œæˆ SQL æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å›è°ƒå¤„ç†ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§éå¸¸å…¸å‹çš„æ‰©å±•æ€§å¤„ç†æ–¹å¼ã€‚</p>
<h3 id="shardingexecuteengine">ShardingExecuteEngine</h3>
<p>æŒ‰ç…§æƒ¯ä¾‹ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä»ä½äºåº•å±‚çš„ ShardingExecuteEngine å¼€å§‹åˆ‡å…¥ã€‚ä¸è·¯ç”±å’Œæ”¹å†™å¼•æ“ä¸åŒï¼ŒShardingExecuteEngine æ˜¯ ShardingSphere ä¸­å”¯ä¸€çš„ä¸€ä¸ªæ‰§è¡Œå¼•æ“ï¼Œæ‰€ä»¥ç›´æ¥è®¾è®¡ä¸ºä¸€ä¸ªç±»è€Œéæ¥å£ï¼Œè¿™ä¸ªç±»åŒ…å«äº†å¦‚ä¸‹çš„å˜é‡å’Œæ„é€ å‡½æ•°ï¼š</p>
<pre tabindex="0"><code>private final ShardingExecutorService shardingExecutorService;    
private ListeningExecutorService executorService;
    
public ShardingExecuteEngine(final int executorSize) {
    shardingExecutorService = new ShardingExecutorService(executorSize);
    executorService = shardingExecutorService.getExecutorService();
}
</code></pre><h4 id="1executorservice">1.ExecutorService</h4>
<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªä»¥ ExecutorService ç»“å°¾çš„å˜é‡ï¼Œæ˜¾ç„¶ä»å‘½åä¸Šä¸éš¾çœ‹å‡ºå®ƒä»¬éƒ½æ˜¯æ‰§è¡Œå™¨æœåŠ¡ï¼Œä¸ JDK ä¸­çš„ java.util.concurrent.ExecutorService ç±»ä¼¼ã€‚å…¶ä¸­<strong>ListeningExecutorService</strong>æ¥è‡ª Google çš„å·¥å…·åŒ… Guavaï¼›è€Œ<strong>ShardingExecutorService</strong>æ˜¯ ShardingSphere ä¸­çš„è‡ªå®šä¹‰ç±»ï¼ŒåŒ…å«äº† ListeningExecutorService çš„æ„å»ºè¿‡ç¨‹ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å¯¹ä¸¤è€…åˆ†åˆ«å±•å¼€è®²è¿°ã€‚</p>
<ul>
<li><strong>ShardingExecutorService</strong></li>
</ul>
<p>æˆ‘ä»¬å‘ç° ShardingExecutorService åŒ…å«äº†ä¸€ä¸ª JDK çš„ ExecutorServiceï¼Œå®ƒçš„åˆ›å»ºè¿‡ç¨‹å¦‚ä¸‹ï¼Œè¿™é‡Œç”¨åˆ°çš„ newCachedThreadPool å’Œ newFixedThreadPool éƒ½æ˜¯ JDK æä¾›çš„å¸¸è§æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>private ExecutorService getExecutorService(final int executorSize, final String nameFormat) {
    ThreadFactory shardingThreadFactory = ShardingThreadFactoryBuilder.build(nameFormat);
    return 0 == executorSize ? Executors.newCachedThreadPool(shardingThreadFactory) : Executors.newFixedThreadPool(executorSize, shardingThreadFactory);
}
</code></pre><ul>
<li><strong>ListeningExecutorService</strong></li>
</ul>
<p>ç”±äº JDK ä¸­æ™®é€šçº¿ç¨‹æ± è¿”å›çš„ Future åŠŸèƒ½æ¯”è¾ƒå•ä¸€ï¼Œæ‰€ä»¥ Guava æä¾›äº† ListeningExecutorService å¯¹å…¶è¿›è¡Œè£…é¥°ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ ListeningExecutorService å¯¹ ExecutorService åšä¸€å±‚åŒ…è£…ï¼Œè¿”å›ä¸€ä¸ª ListenableFuture å®ä¾‹ï¼Œè€Œ ListenableFuture åˆæ˜¯ç»§æ‰¿è‡ª Futureï¼Œæ‰©å±•äº†ä¸€ä¸ª addListener ç›‘å¬æ–¹æ³•ï¼Œè¿™æ ·å½“ä»»åŠ¡æ‰§è¡Œå®Œæˆå°±ä¼šä¸»åŠ¨å›è°ƒè¯¥æ–¹æ³•ã€‚ListeningExecutorService çš„æ„å»ºè¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>executorService = MoreExecutors.listeningDecorator(getExecutorService(executorSize, nameFormat));
oreExecutors.addDelayedShutdownHook(executorService, 60, TimeUnit.SECONDS);
</code></pre><p>æ˜ç¡®äº†æ‰§è¡Œå™¨ ExecutorService ä¹‹åï¼Œæˆ‘ä»¬<strong>å›åˆ° ShardingExecuteEngine ç±»</strong>ï¼Œè¯¥ç±»ä»¥ groupExecute æ–¹æ³•ä¸ºå…¥å£ï¼Œè¿™ä¸ªæ–¹æ³•å‚æ•°æ¯”è¾ƒå¤šï¼Œä¹Ÿå•ç‹¬éƒ½åˆ—äº†ä¸€ä¸‹ï¼š</p>
<pre tabindex="0"><code>/** 
 * @param inputGroupsï¼šè¾“å…¥ç»„
 * @param firstCallbackï¼šç¬¬ä¸€æ¬¡åˆ†ç‰‡æ‰§è¡Œå›è°ƒ
 * @param callbackï¼šåˆ†ç‰‡æ‰§è¡Œå›è°ƒ
 * @param serialï¼šæ˜¯å¦ä½¿ç”¨å¤šçº¿ç¨‹è¿›è¡Œæ‰§è¡Œ
 * @param &lt;I&gt;ï¼šè¾“å…¥å€¼ç±»å‹
 * @param &lt;O&gt;ï¼šè¿”å›å€¼ç±»å‹
 * @return æ‰§è¡Œç»“æœ
 * @throws SQLExceptionï¼šæŠ›å‡ºå¼‚å¸¸
 */
public &lt;I, O&gt; List&lt;O&gt; groupExecute(
    final Collection&lt;ShardingExecuteGroup&lt;I&gt;&gt; inputGroups, final ShardingGroupExecuteCallback&lt;I, O&gt; firstCallback, final ShardingGroupExecuteCallback&lt;I, O&gt; callback, final boolean serial)
    throws SQLException {
    if (inputGroups.isEmpty()) {
        return Collections.emptyList();
    }
    return serial ? serialExecute(inputGroups, firstCallback, callback) : parallelExecute(inputGroups, firstCallback, callback);
}
</code></pre><p>è¿™é‡Œçš„åˆ†ç‰‡æ‰§è¡Œç»„ ShardingExecuteGroup å¯¹è±¡å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªåŒ…å«è¾“å…¥ä¿¡æ¯çš„åˆ—è¡¨ï¼Œè€Œä¸Šè¿° groupExecute æ–¹æ³•çš„è¾“å…¥æ˜¯ä¸€ä¸ª ShardingExecuteGroup çš„é›†åˆã€‚é€šè¿‡åˆ¤æ–­è¾“å…¥å‚æ•° serial æ˜¯å¦ä¸º trueï¼Œä¸Šè¿°ä»£ç æµç¨‹åˆ†åˆ«è½¬å‘äº†<strong>serialExecute å’Œ parallelExecute è¿™ä¸¤ä¸ªä»£ç åˆ†æ”¯</strong>ï¼Œæ¥ä¸‹æ¥æˆ‘æ¥åˆ†åˆ«è®²è§£ä¸€ä¸‹è¿™ä¸¤ä¸ªä»£ç åˆ†æ”¯ã€‚</p>
<h4 id="2serialexecute">2.SerialExecute</h4>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ serialExecute æ–¹æ³•ï¼Œé¡¾åæ€ä¹‰ï¼Œè¯¥æ–¹æ³•ç”¨äºä¸²è¡Œæ‰§è¡Œçš„åœºæ™¯ï¼š</p>
<pre tabindex="0"><code>private &lt;I, O&gt; List&lt;O&gt; serialExecute(final Collection&lt;ShardingExecuteGroup&lt;I&gt;&gt; inputGroups, final ShardingGroupExecuteCallback&lt;I, O&gt; firstCallback,
                                     final ShardingGroupExecuteCallback&lt;I, O&gt; callback) throws SQLException {
    Iterator&lt;ShardingExecuteGroup&lt;I&gt;&gt; inputGroupsIterator = inputGroups.iterator();
    //è·å–ç¬¬ä¸€ä¸ªè¾“å…¥çš„ShardingExecuteGroup
    ShardingExecuteGroup&lt;I&gt; firstInputs = inputGroupsIterator.next();
    //é€šè¿‡ç¬¬ä¸€ä¸ªå›è°ƒ firstCallback å®ŒæˆåŒæ­¥æ‰§è¡Œçš„ syncGroupExecute
    List&lt;O&gt; result = new LinkedList&lt;&gt;(syncGroupExecute(firstInputs, null == firstCallback ? callback : firstCallback));
    //å¯¹å‰©ä¸‹çš„ ShardingExecuteGroupï¼Œé€šè¿‡å›è°ƒ callback é€ä¸ªåŒæ­¥æ‰§è¡Œ syncGroupExecute
    for (ShardingExecuteGroup&lt;I&gt; each : Lists.newArrayList(inputGroupsIterator)) {
        result.addAll(syncGroupExecute(each, callback));
    }
    return result;
}
</code></pre><p>ä¸Šè¿°ä»£ç çš„åŸºæœ¬æµç¨‹æ˜¯è·å–ç¬¬ä¸€ä¸ªè¾“å…¥çš„ ShardingExecuteGroupï¼Œé€šè¿‡ç¬¬ä¸€ä¸ªå›è°ƒ firstCallback å®ŒæˆåŒæ­¥æ‰§è¡Œçš„ syncGroupExecute æ–¹æ³•ã€‚ç„¶åå¯¹å‰©ä¸‹çš„ ShardingExecuteGroupï¼Œé€šè¿‡å›è°ƒ callback é€ä¸ªæ‰§è¡Œ syncGroupExecute æ–¹æ³•ã€‚è¿™é‡Œçš„ syncGroupExecute æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private &lt;I, O&gt; Collection&lt;O&gt; syncGroupExecute(final ShardingExecuteGroup&lt;I&gt; executeGroup, final ShardingGroupExecuteCallback&lt;I, O&gt; callback) throws SQLException {
        return callback.execute(executeGroup.getInputs(), true, ShardingExecuteDataMap.getDataMap());
}
</code></pre><p>æˆ‘ä»¬çœ‹åˆ°åŒæ­¥æ‰§è¡Œçš„è¿‡ç¨‹å®é™…ä¸Šæ˜¯äº¤ç»™äº† ShardingGroupExecuteCallback å›è°ƒæ¥å£ï¼š</p>
<pre tabindex="0"><code>public interface ShardingGroupExecuteCallback&lt;I, O&gt; {
    
    Collection&lt;O&gt; execute(Collection&lt;I&gt; inputs, boolean isTrunkThread, Map&lt;String, Object&gt; shardingExecuteDataMap) throws SQLException;
}
</code></pre><p>è¿™é‡Œçš„ ShardingExecuteDataMap ç›¸å½“äºä¸€ä¸ªç”¨äº SQL æ‰§è¡Œçš„æ•°æ®å­—å…¸ï¼Œè¿™äº›æ•°æ®å­—å…¸ä¿å­˜åœ¨ ThreadLocal ä¸­ï¼Œä»è€Œç¡®ä¿äº†çº¿ç¨‹å®‰å…¨ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®å½“å‰çš„æ‰§è¡Œçº¿ç¨‹è·å–å¯¹åº”çš„ DataMap å¯¹è±¡ã€‚</p>
<h4 id="3parallelexecute">3.ParallelExecute</h4>
<p>è¿™æ ·ï¼Œå…³äºä¸²è¡Œæ‰§è¡Œçš„æµç¨‹å°±ä»‹ç»å®Œäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹å¹¶è¡Œæ‰§è¡Œçš„ parallelExecute æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>private &lt;I, O&gt; List&lt;O&gt; parallelExecute(final Collection&lt;ShardingExecuteGroup&lt;I&gt;&gt; inputGroups, final ShardingGroupExecuteCallback&lt;I, O&gt; firstCallback,
                                       final ShardingGroupExecuteCallback&lt;I, O&gt; callback) throws SQLException {
    Iterator&lt;ShardingExecuteGroup&lt;I&gt;&gt; inputGroupsIterator = inputGroups.iterator();
    //è·å–ç¬¬ä¸€ä¸ªè¾“å…¥çš„ ShardingExecuteGroup
    ShardingExecuteGroup&lt;I&gt; firstInputs = inputGroupsIterator.next();
    //é€šè¿‡ asyncGroupExecute æ‰§è¡Œå¼‚æ­¥å›è°ƒ
    Collection&lt;ListenableFuture&lt;Collection&lt;O&gt;&gt;&gt; restResultFutures = asyncGroupExecute(Lists.newArrayList(inputGroupsIterator), callback);
    //è·å–æ‰§è¡Œç»“æœå¹¶ç»„è£…è¿”å›
    return getGroupResults(syncGroupExecute(firstInputs, null == firstCallback ? callback : firstCallback), restResultFutures);
}
</code></pre><p>æ³¨æ„åˆ°è¿™é‡Œæœ‰ä¸€ä¸ªå¼‚æ­¥æ‰§è¡Œæ–¹æ³• asyncGroupExecuteï¼Œä¼ å…¥å‚æ•°æ˜¯ä¸€ä¸ª ShardingExecuteGroup åˆ—è¡¨ï¼š</p>
<pre tabindex="0"><code>private &lt;I, O&gt; Collection&lt;ListenableFuture&lt;Collection&lt;O&gt;&gt;&gt; asyncGroupExecute(final List&lt;ShardingExecuteGroup&lt;I&gt;&gt; inputGroups, final ShardingGroupExecuteCallback&lt;I, O&gt; callback) {
    Collection&lt;ListenableFuture&lt;Collection&lt;O&gt;&gt;&gt; result = new LinkedList&lt;&gt;();
    for (ShardingExecuteGroup&lt;I&gt; each : inputGroups) {
        result.add(asyncGroupExecute(each, callback));
    }
    return result;
}
</code></pre><p>è¿™ä¸ªæ–¹æ³•ä¸­é’ˆå¯¹æ¯ä¸ªä¼ å…¥çš„ ShardingExecuteGroupï¼Œå†æ¬¡è°ƒç”¨ä¸€ä¸ªé‡è½½çš„å¼‚æ­¥ asyncGroupExecute æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>private &lt;I, O&gt; ListenableFuture&lt;Collection&lt;O&gt;&gt; asyncGroupExecute(final ShardingExecuteGroup&lt;I&gt; inputGroup, final ShardingGroupExecuteCallback&lt;I, O&gt; callback) {
    final Map&lt;String, Object&gt; dataMap = ShardingExecuteDataMap.getDataMap();
    return executorService.submit(new Callable&lt;Collection&lt;O&gt;&gt;() {
            
        @Override
        public Collection&lt;O&gt; call() throws SQLException {
            return callback.execute(inputGroup.getInputs(), false, dataMap);
        }
    });
}
</code></pre><p>æ˜¾ç„¶ï¼Œä½œä¸ºå¼‚æ­¥æ‰§è¡Œæ–¹æ³•ï¼Œè¿™é‡Œå°±ä¼šä½¿ç”¨ Guava çš„ ListeningExecutorService æ¥æäº¤ä¸€ä¸ªå¼‚æ­¥æ‰§è¡Œçš„ä»»åŠ¡å¹¶è¿”å›ä¸€ä¸ª ListenableFutureï¼Œè€Œè¿™ä¸ªå¼‚æ­¥æ‰§è¡Œçš„ä»»åŠ¡å°±æ˜¯å…·ä½“çš„å›è°ƒã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹ parallelExecute æ–¹æ³•çš„æœ€åä¸€å¥ï¼Œå³è°ƒç”¨ getGroupResults æ–¹æ³•è·å–æ‰§è¡Œç»“æœï¼š</p>
<pre tabindex="0"><code>private &lt;O&gt; List&lt;O&gt; getGroupResults(final Collection&lt;O&gt; firstResults, final Collection&lt;ListenableFuture&lt;Collection&lt;O&gt;&gt;&gt; restFutures) throws SQLException {
        List&lt;O&gt; result = new LinkedList&lt;&gt;(firstResults);
        for (ListenableFuture&lt;Collection&lt;O&gt;&gt; each : restFutures) {
            try {
                result.addAll(each.get());
            } catch (final InterruptedException | ExecutionException ex) {
                return throwException(ex);
            }
        }
        return result;
}
</code></pre><p>ç†Ÿæ‚‰ Future ç”¨æ³•çš„åŒå­¦å¯¹ä¸Šè¿°ä»£ç åº”è¯¥ä¸ä¼šé™Œç”Ÿï¼Œæˆ‘ä»¬éå† ListenableFutureï¼Œç„¶åè°ƒåŠ¨å®ƒçš„ get æ–¹æ³•åŒæ­¥ç­‰å¾…è¿”å›ç»“æœï¼Œæœ€åå½“æ‰€æœ‰çš„ç»“æœéƒ½è·å–åˆ°ä¹‹åç»„è£…æˆä¸€ä¸ªç»“æœåˆ—è¡¨å¹¶è¿”å›ï¼Œè¿™ç§å†™æ³•åœ¨ä½¿ç”¨ Future æ—¶éå¸¸å¸¸è§ã€‚</p>
<p>æˆ‘ä»¬å›è¿‡å¤´æ¥çœ‹ï¼Œæ— è®ºæ˜¯ serialExecute æ–¹æ³•è¿˜æ˜¯ parallelExecute æ–¹æ³•ï¼Œéƒ½ä¼šä» ShardingExecuteGroup ä¸­è·å–ç¬¬ä¸€ä¸ª firstInputs å…ƒç´ å¹¶è¿›è¡Œæ‰§è¡Œï¼Œç„¶åå‰©ä¸‹çš„å†è¿›è¡ŒåŒæ­¥æˆ–å¼‚æ­¥æ‰§è¡Œã€‚ShardingSphere è¿™æ ·ä½¿ç”¨çº¿ç¨‹çš„èƒŒåæœ‰å…¶ç‹¬ç‰¹çš„è®¾è®¡æ€è·¯ã€‚è€ƒè™‘åˆ°å½“å‰çº¿ç¨‹åŒæ ·ä¹Ÿæ˜¯ä¸€ç§å¯ç”¨èµ„æºï¼Œ<strong>è®©ç¬¬ä¸€ä¸ªä»»åŠ¡ç”±å½“å‰çº¿ç¨‹è¿›è¡Œæ‰§è¡Œå°±å¯ä»¥å……åˆ†åˆ©ç”¨å½“å‰çº¿ç¨‹ï¼Œä»è€Œæœ€å¤§åŒ–çº¿ç¨‹çš„åˆ©ç”¨ç‡ã€‚</strong></p>
<p>è‡³æ­¤ï¼Œå…³äº ShardingExecuteEngine ç±»çš„ä»‹ç»å°±å‘Šä¸€æ®µè½ã€‚ä½œä¸ºæ‰§è¡Œå¼•æ“ï¼ŒShardingExecuteEngine æ‰€åšçš„äº‹æƒ…å°±æ˜¯æä¾›ä¸€ä¸ªå¤šçº¿ç¨‹çš„æ‰§è¡Œç¯å¢ƒã€‚<strong>åœ¨ç³»ç»Ÿè®¾è®¡ä¸Šï¼Œè¿™ä¹Ÿæ˜¯åœ¨æ—¥å¸¸å¼€å‘è¿‡ç¨‹ä¸­å¯ä»¥å‚è€ƒçš„ä¸€ä¸ªæŠ€å·§ã€‚æˆ‘ä»¬å¯ä»¥è®¾è®¡å¹¶å®ç°ä¸€ä¸ªå¤šçº¿ç¨‹æ‰§è¡Œç¯å¢ƒï¼Œè¿™ä¸ªç¯å¢ƒä¸éœ€è¦å®Œæˆå…·ä½“çš„ä¸šåŠ¡æ“ä½œï¼Œè€Œåªéœ€è¦è´Ÿè´£æ‰§è¡Œä¼ å…¥çš„å›è°ƒå‡½æ•°ã€‚ShardingSphere ä¸­çš„ShardingExecuteEngine å°±æ˜¯æä¾›äº†è¿™æ ·ä¸€ç§ç¯å¢ƒ</strong>ï¼ŒåŒæ ·çš„å®ç°æ–¹å¼åœ¨å…¶ä»–è¯¸å¦‚ Spring ç­‰å¼€æºæ¡†æ¶ä¸­ä¹Ÿéƒ½å¯ä»¥çœ‹åˆ°ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œå°±è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ ShardingSphere å¦‚ä½•é€šè¿‡å›è°ƒå®Œæˆ SQL çš„çœŸæ­£æ‰§è¡Œã€‚</p>
<h3 id="å›è°ƒæ¥å£-shardinggroupexecutecallback">å›è°ƒæ¥å£ ShardingGroupExecuteCallback</h3>
<p>å›è°ƒæ¥å£ ShardingGroupExecuteCallback çš„å®šä¹‰éå¸¸ç®€å•ï¼š</p>
<pre tabindex="0"><code>public interface ShardingGroupExecuteCallback&lt;I, O&gt; {
   
    Collection&lt;O&gt; execute(Collection&lt;I&gt; inputs, boolean isTrunkThread, Map&lt;String, Object&gt; shardingExecuteDataMap) throws SQLException;
}
</code></pre><p>è¯¥æ¥å£æ ¹æ®ä¼ å…¥çš„æ³›å‹ inputs é›†åˆå’Œ shardingExecuteDataMap å®ŒæˆçœŸæ­£çš„ SQL æ‰§è¡Œæ“ä½œã€‚åœ¨ ShardingSphere ä¸­ï¼Œä½¿ç”¨åŒ¿åæ–¹æ³•å®ç° ShardingGroupExecuteCallback æ¥å£çš„åœ°æ–¹æœ‰å¾ˆå¤šï¼Œä½†æ˜¾å¼å®ç°è¿™ä¸€æ¥å£çš„åªæœ‰ä¸€ä¸ªç±»ï¼Œå³ SQLExecuteCallback ç±»ï¼Œè¿™æ˜¯ä¸€ä¸ª<strong>æŠ½è±¡ç±»</strong>ï¼Œå®ƒçš„ execute æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>@Override
public final Collection&lt;T&gt; execute(final Collection&lt;StatementExecuteUnit&gt; statementExecuteUnits, 
                                   final boolean isTrunkThread, final Map&lt;String, Object&gt; shardingExecuteDataMap) throws SQLException {
    Collection&lt;T&gt; result = new LinkedList&lt;&gt;();
    for (StatementExecuteUnit each : statementExecuteUnits) {
        result.add(execute0(each, isTrunkThread, shardingExecuteDataMap));
    }
    return result;
}
</code></pre><p>å¯¹äºæ¯ä¸ªè¾“å…¥çš„ StatementExecuteUnit æ•°æ®ç»“æ„ï¼Œä¸Šè¿° execute æ–¹æ³•ä¼šè¿›ä¸€æ­¥æ‰§è¡Œä¸€ä¸ª execute0 æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>private T execute0(final StatementExecuteUnit statementExecuteUnit, final boolean isTrunkThread, final Map&lt;String, Object&gt; shardingExecuteDataMap) throws SQLException {
    //è®¾ç½® ExecutorExceptionHandler
     ExecutorExceptionHandler.setExceptionThrown(isExceptionThrown);
    //è·å– DataSourceMetaDataï¼Œè¿™é‡Œç”¨åˆ°äº†ç¼“å­˜æœºåˆ¶
     DataSourceMetaData dataSourceMetaData = getDataSourceMetaData(statementExecuteUnit.getStatement().getConnection().getMetaData());
    //åˆå§‹åŒ– SQLExecutionHook
     SQLExecutionHook sqlExecutionHook = new SPISQLExecutionHook();
        try {
            RouteUnit routeUnit = statementExecuteUnit.getRouteUnit();
            //å¯åŠ¨æ‰§è¡Œé’©å­
            sqlExecutionHook.start(routeUnit.getDataSourceName(), routeUnit.getSqlUnit().getSql(), routeUnit.getSqlUnit().getParameters(), dataSourceMetaData, isTrunkThread, shardingExecuteDataMap);
            //æ‰§è¡Œ SQL
            T result = executeSQL(routeUnit.getSqlUnit().getSql(), statementExecuteUnit.getStatement(), statementExecuteUnit.getConnectionMode());
            //æˆåŠŸé’©å­
            sqlExecutionHook.finishSuccess();
            return result;
        } catch (final SQLException ex) {
            //å¤±è´¥é’©å­
            sqlExecutionHook.finishFailure(ex);
            //å¼‚å¸¸å¤„ç†
            ExecutorExceptionHandler.handleException(ex);
            return null;
        }
}
</code></pre><p>è¿™æ®µä»£ç æ¯ä¸€å¥çš„å«ä¹‰éƒ½æ¯”è¾ƒæ˜ç¡®ï¼Œè¿™é‡Œå¼•å…¥äº†ä¸€ä¸ª ExecutorExceptionHandler ç”¨äºå¼‚å¸¸å¤„ç†ï¼ŒåŒæ—¶ä¹Ÿå¼•å…¥äº†ä¸€ä¸ª SPISQLExecutionHook å¯¹æ‰§è¡Œè¿‡ç¨‹åµŒå…¥é’©å­ã€‚å…³äºåŸºäº SPI æœºåˆ¶çš„ Hook å®ç°æœºåˆ¶ï¼Œæˆ‘ä»¬åœ¨å‰é¢çš„ SQL è§£æå’Œè·¯ç”±å¼•æ“ä¸­å·²ç»çœ‹åˆ°è¿‡å¾ˆå¤šæ¬¡ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚æˆ‘ä»¬çœ‹åˆ°ï¼ŒçœŸæ­£æ‰§è¡Œ SQL çš„è¿‡ç¨‹æ˜¯äº¤ç»™ executeSQL æ¨¡æ¿æ–¹æ³•è¿›è¡Œå®Œæˆï¼Œéœ€è¦ SQLExecuteCallback çš„å„ä¸ªå­ç±»å®ç°è¿™ä¸€æ¨¡æ¿æ–¹æ³•ã€‚</p>
<p>åœ¨ ShardingSphere ä¸­ï¼Œæ²¡æœ‰æä¾›ä»»ä½•çš„ SQLExecuteCallback å®ç°ç±»ï¼Œä½†å¤§é‡é‡‡ç”¨åŒ¿åæ–¹æ³•æ¥å®Œæˆ executeSQL æ¨¡æ¿æ–¹æ³•çš„å®ç°ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸‹ä¸€è¯¾æ—¶ã€Š22 | æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸Šï¼‰ã€‹çš„ StatementExecutor ç±»ä¸­ï¼ŒexecuteQuery æ–¹æ³•å°±åˆ›å»ºäº†ä¸€ä¸ª SQLExecuteCallback åŒ¿åå®ç°æ–¹æ³•ï¼Œç”¨æ¥å®ŒæˆæŸ¥è¯¢æ“ä½œï¼š</p>
<pre tabindex="0"><code>public List&lt;QueryResult&gt; executeQuery() throws SQLException {
final boolean isExceptionThrown = ExecutorExceptionHandler.isExceptionThrown();
//åˆ›å»º SQLExecuteCallback å¹¶æ‰§è¡ŒæŸ¥è¯¢
SQLExecuteCallback&lt;QueryResult&gt; executeCallback = new SQLExecuteCallback&lt;QueryResult&gt;(getDatabaseType(), isExceptionThrown) {
            
    @Override
    protected QueryResult executeSQL(final String sql, final Statement statement, final ConnectionMode connectionMode) throws SQLException {
        return getQueryResult(sql, statement, connectionMode);
    }
};
//æ‰§è¡Œ SQLExecuteCallback å¹¶è¿”å›ç»“æœ
return executeCallback(executeCallback);
}
</code></pre><h3 id="æ¨¡æ¿ç±»-sqlexecutetemplate">æ¨¡æ¿ç±» SQLExecuteTemplate</h3>
<p>åœ¨ ShardingSphere æ‰§è¡Œå¼•æ“çš„åº•å±‚ç»„ä»¶ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªç±»éœ€è¦å±•å¼€ï¼Œè¿™å°±æ˜¯<strong>æ¨¡æ¿ç±» SQLExecuteTemplate</strong>ï¼Œå®ƒæ˜¯ ShardingExecuteEngine çš„ç›´æ¥ä½¿ç”¨è€…ã€‚ä»å‘½åä¸Šçœ‹ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„æ¨¡æ¿å·¥å…·ç±»ï¼Œå®šä½ä¸Šå°±åƒ Spring ä¸­çš„ JdbcTemplate ä¸€æ ·ã€‚ä½†å‡¡è¿™ç§æ¨¡æ¿å·¥å…·ç±»ï¼Œå…¶å®ç°ä¸€èˆ¬éƒ½æ¯”è¾ƒç®€å•ï¼ŒåŸºæœ¬å°±æ˜¯å¯¹åº•å±‚å¯¹è±¡çš„ç®€å•å°è£…ã€‚</p>
<p>SQLExecuteTemplate ä¹Ÿä¸ä¾‹å¤–ï¼Œå®ƒè¦åšçš„å°±æ˜¯å¯¹ ShardingExecuteEngine ä¸­çš„å…¥å£æ–¹æ³•è¿›è¡Œå°è£…å’Œå¤„ç†ã€‚ShardingExecuteEngine çš„æ ¸å¿ƒæ–¹æ³•å°±åªæœ‰ä¸€ä¸ªï¼Œå³ executeGroup æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>public &lt;T&gt; List&lt;T&gt; executeGroup(final Collection&lt;ShardingExecuteGroup&lt;? extends StatementExecuteUnit&gt;&gt; sqlExecuteGroups, final SQLExecuteCallback&lt;T&gt; firstCallback, final SQLExecuteCallback&lt;T&gt; callback) throws SQLException {
    try {
        return executeEngine.groupExecute((Collection) sqlExecuteGroups, firstCallback, callback, serial);
    } catch (final SQLException ex) {
        ExecutorExceptionHandler.handleException(ex);
        return Collections.emptyList();
    }
}
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ–¹æ³•æ‰€åšçš„äº‹æƒ…å°±æ˜¯ç›´æ¥è°ƒç”¨ ShardingExecuteEngine çš„ groupExecute æ–¹æ³•å®Œæˆå…·ä½“çš„æ‰§è¡Œå·¥ä½œï¼Œå¹¶æ·»åŠ äº†å¼‚å¸¸å¤„ç†æœºåˆ¶è€Œå·²ã€‚</p>
<h3 id="ä»æºç è§£æåˆ°æ—¥å¸¸å¼€å‘">ä»æºç è§£æåˆ°æ—¥å¸¸å¼€å‘</h3>
<p>æˆ‘ä»¬å¯ä»¥ä»ä»Šå¤©çš„å†…å®¹ä¸­ï¼Œæç‚¼å‡ºæ¥è®¸å¤šæŠ€å·§ï¼Œå¹¶åº”ç”¨äºæ—¥å¸¸å¼€å‘è¿‡ç¨‹ä¸­ã€‚<strong>æ¯”è¾ƒå®ç”¨çš„ä¸€ä¸ªæŠ€å·§æ˜¯ï¼šæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Guava æä¾›çš„ ListeningExecutorService æ¥å¼ºåŒ– JDK ä¸­åŸºäºæ™®é€š Future çš„æ‰§è¡Œå™¨æœåŠ¡ ExecutorService</strong>ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†åŸºäº Callback çš„ç³»ç»Ÿæ‰©å±•æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥åŸºäºè¿™ç§æ‰©å±•æœºåˆ¶ï¼Œæ„å»ºä¸€ä¸ªç‹¬ç«‹çš„è¿è¡Œç¯å¢ƒï¼Œä»è€ŒæŠŠä¸ä¸šåŠ¡ç›¸å…³çš„æ‰€æœ‰æ“ä½œé€šè¿‡å›è°ƒå¾—ä»¥å®ç°ã€‚</p>
<h3 id="å°ç»“ä¸é¢„å‘Š">å°ç»“ä¸é¢„å‘Š</h3>
<p>æœ¬è¯¾æ—¶æ˜¯ä»‹ç» ShardingSphere æ‰§è¡Œå¼•æ“çš„ç¬¬ä¸€éƒ¨åˆ†å†…å®¹ï¼Œä»‹ç»äº†åˆ†ç‰‡ç¯å¢ƒä¸‹ SQL æ‰§è¡Œæµç¨‹çš„æŠ½è±¡è¿‡ç¨‹ã€‚æˆ‘ä»¬å…ˆå¼•å‡ºäº†<strong>æ‰§è¡Œå¼•æ“</strong>è¿™ä¸ªæ ¸å¿ƒç±»ï¼Œç„¶ååˆ†åˆ«ä»<strong>æ‰§è¡Œå™¨æœåŠ¡</strong>ã€<strong>æ‰§è¡Œå›è°ƒ</strong>ä»¥åŠ<strong>æ‰§è¡Œæ¨¡æ¿</strong>ç±»ç­‰ç»´åº¦å¯¹æ•´ä¸ªæ‰§è¡Œæµç¨‹å±•å¼€äº†è¯¦ç»†è®²è¿°ã€‚</p>
<p>æœ€åè¿™é‡Œç»™ä½ ç•™ä¸€é“æ€è€ƒé¢˜ï¼šåœ¨åŸºäºå¤šçº¿ç¨‹æŠ€æœ¯å®ç° Executor æ—¶ï¼ŒShardingSphere åº”ç”¨äº†å“ªäº›æŠ€å·§ï¼Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸å¤§å®¶è®¨è®ºï¼Œæˆ‘å°† ä¸€ ä¸€ ç‚¹è¯„è§£ç­”ã€‚</p>
<p>ä¸‹ä¸€è¯¾æ—¶ï¼Œæˆ‘ä»¬ç»§ç»­ä»‹ç» ShardingSphere çš„æ‰§è¡Œå¼•æ“ï¼Œæˆ‘ä»¬å°†é‡ç‚¹å…³æ³¨ SQL çš„æ‰§è¡Œå™¨ StatementExecutorã€‚</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/20-%E6%94%B9%E5%86%99%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84-sql-%E6%94%B9%E5%86%99%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6/"><span>20 æ”¹å†™å¼•æ“ï¼šå¦‚ä½•ç†è§£è£…é¥°å™¨æ¨¡å¼ä¸‹çš„ SQL æ”¹å†™å®ç°æœºåˆ¶ï¼Ÿ</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/22-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E6%8A%8A%E6%8F%A1-shardingsphere-%E4%B8%AD%E7%9A%84-executor-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8A/"><span>22 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸Šï¼‰</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 28280 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>