<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>22 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸Šï¼‰ | Yipsen Ye</title>
<meta name="description" content="åœ¨ä¸Šä¸€è¯¾æ—¶ä¸­ï¼Œæˆ‘ä»¬å¯¹ ShardingGroupExecuteCallback å’Œ SQLExecuteTemplate åšäº†ä»‹ç»ã€‚ä»è®¾è®¡ä¸Šè®²ï¼Œå‰è€…å……å½“ ShardingExecuteEngine çš„å›è°ƒå…¥å£ï¼›è€Œåè€…åˆ™æ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œå®Œæˆå¯¹ ShardingExecuteEngine çš„å°è£…å¹¶æä¾›äº†å¯¹å¤–çš„ç»Ÿä¸€å…¥å£ï¼Œè¿™äº›ç±»éƒ½ä½äºåº•å±‚çš„ sharding-core-execute å·¥ç¨‹ä¸­ã€‚
ä»ä»Šå¤©å¼€å§‹ï¼Œæˆ‘ä»¬å°†è¿›å…¥åˆ° sharding-jdbc-core å·¥ç¨‹ï¼Œæ¥çœ‹çœ‹ ShardingSphere ä¸­æ‰§è¡Œå¼•æ“ä¸Šå±‚è®¾è®¡ä¸­çš„å‡ ä¸ªæ ¸å¿ƒç±»ã€‚
AbstractStatementExecutor å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ ¹æ®ä¸Šä¸€è¯¾æ—¶ä¸­çš„æ‰§è¡Œå¼•æ“æ•´ä½“ç»“æ„å›¾ï¼Œå¯ä»¥çœ‹åˆ°SQLExecuteTemplateçš„ç›´æ¥ä½¿ç”¨è€…æ˜¯AbstractStatementExecutor ç±»ï¼Œä»Šå¤©æˆ‘ä»¬å°±ä»è¿™ä¸ªç±»å¼€å§‹å±•å¼€è®¨è®ºï¼Œè¯¥ç±»çš„å˜é‡æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ï¼š
//æ•°æ®åº“ç±»å‹private final DatabaseType databaseType;//JDBCä¸­ç”¨äºæŒ‡å®šç»“æœå¤„ç†æ–¹å¼çš„ resultSetTypeprivate final int resultSetType;//JDBCä¸­ç”¨äºæŒ‡å®šæ˜¯å¦å¯å¯¹ç»“æœé›†è¿›è¡Œä¿®æ”¹çš„ resultSetConcurrencyprivate final int resultSetConcurrency; //JDBCä¸­ç”¨äºæŒ‡å®šäº‹åŠ¡æäº¤æˆ–å›æ»šåç»“æœé›†æ˜¯å¦ä»ç„¶å¯ç”¨çš„ resultSetConcurrencyprivate final int resultSetHoldability;//åˆ†ç‰‡ Connectionprivate final ShardingConnection connection;//ç”¨äºæ•°æ®å‡†å¤‡çš„æ¨¡æ¿ç±»private final SQLExecutePrepareTemplate sqlExecutePrepareTemplate;//SQL æ‰§è¡Œæ¨¡æ¿ç±»private final SQLExecuteTemplate sqlExecuteTemplate;//JDBCçš„Connectionåˆ—è¡¨private final Collection&amp;lt;Connection&amp;gt; connections = new LinkedList&amp;lt;&amp;gt;();//SQLStatement ä¸Šä¸‹æ–‡private SQLStatementContext sqlStatementContext;//å‚æ•°é›†private final List&amp;lt;List&amp;lt;Object&amp;gt;&amp;gt; parameterSets = new LinkedList&amp;lt;&amp;gt;(); //JDBCçš„Statement åˆ—è¡¨private final List&amp;lt;Statement&amp;gt; statements = new LinkedList&amp;lt;&amp;gt;(); //JDBCçš„ResultSet åˆ—è¡¨private final List&amp;lt;ResultSet&amp;gt; resultSets = new CopyOnWriteArrayList&amp;lt;&amp;gt;();//ShardingExecuteGroup åˆ—è¡¨private final Collection&amp;lt;ShardingExecuteGroup&amp;lt;StatementExecuteUnit&amp;gt;&amp;gt; executeGroups = new LinkedList&amp;lt;&amp;gt;();ä»è¿™ä¸ªç±»å¼€å§‹ï¼Œæˆ‘ä»¬ä¼šæ…¢æ…¢æ¥è§¦ JDBC è§„èŒƒç›¸å…³çš„å¯¹è±¡ï¼Œå› ä¸º ShardingSphere çš„è®¾è®¡ç›®æ ‡æ˜¯ï¼Œé‡å†™ä¸€å¥—ä¸ç›®å‰çš„ JDBC è§„èŒƒå®Œå…¨å…¼å®¹çš„ä½“ç³»ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°çš„ Connectionã€Statement å’Œ ResultSet ç­‰å¯¹è±¡ï¼Œä»¥åŠ resultSetTypeã€resultSetConcurrencyã€resultSetHoldability ç­‰å‚æ•°ï¼Œéƒ½æ˜¯å±äº JDBC è§„èŒƒä¸­çš„å†…å®¹ï¼Œæˆ‘ä»¬åœ¨æ³¨é‡Šä¸Šåšäº†ç‰¹åˆ«çš„è¯´æ˜ï¼Œä½ å¯¹æ­¤ä¹Ÿéƒ½æ¯”è¾ƒç†Ÿæ‚‰ã€‚">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="nav-logo">
    <a href="http://yipsen.github.io/">
        
        <span class="nav-title">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æ–‡ç« </a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/shardingsphere%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e7%b2%be%e8%ae%b2/">ShardingSphereæ ¸å¿ƒåŸç†ç²¾è®²</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/00-%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E5%AD%A6%E4%B9%A0%E4%B8%80%E6%AC%BE%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/">00 å¦‚ä½•æ­£ç¡®å­¦ä¹ ä¸€æ¬¾åˆ†åº“åˆ†è¡¨å¼€æºæ¡†æ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/01-%E4%BB%8E%E7%90%86%E8%AE%BA%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%A6%82%E4%BD%95%E8%AE%A9%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%9C%9F%E6%AD%A3%E8%90%BD%E5%9C%B0/">01 ä»ç†è®ºåˆ°å®è·µï¼šå¦‚ä½•è®©åˆ†åº“åˆ†è¡¨çœŸæ­£è½åœ°ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/02-%E9%A1%B6%E7%BA%A7%E9%A1%B9%E7%9B%AEshardingsphere-%E6%98%AF%E4%B8%80%E6%AC%BE%E4%BB%80%E4%B9%88%E6%A0%B7%E7%9A%84-apache-%E5%BC%80%E6%BA%90%E8%BD%AF%E4%BB%B6/">02 é¡¶çº§é¡¹ç›®ï¼šShardingSphere æ˜¯ä¸€æ¬¾ä»€ä¹ˆæ ·çš„ Apache å¼€æºè½¯ä»¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/03-%E8%A7%84%E8%8C%83%E5%85%BC%E5%AE%B9jdbc-%E8%A7%84%E8%8C%83%E4%B8%8E-shardingsphere-%E6%98%AF%E4%BB%80%E4%B9%88%E5%85%B3%E7%B3%BB/">03 è§„èŒƒå…¼å®¹ï¼šJDBC è§„èŒƒä¸ ShardingSphere æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/04-%E5%BA%94%E7%94%A8%E9%9B%86%E6%88%90%E5%9C%A8%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F%E4%B8%AD%E4%BD%BF%E7%94%A8-shardingsphere-%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9C%89%E5%93%AA%E4%BA%9B/">04 åº”ç”¨é›†æˆï¼šåœ¨ä¸šåŠ¡ç³»ç»Ÿä¸­ä½¿ç”¨ ShardingSphere çš„æ–¹å¼æœ‰å“ªäº›ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/05-%E9%85%8D%E7%BD%AE%E9%A9%B1%E5%8A%A8shardingsphere-%E4%B8%AD%E7%9A%84%E9%85%8D%E7%BD%AE%E4%BD%93%E7%B3%BB%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E7%9A%84/">05 é…ç½®é©±åŠ¨ï¼šShardingSphere ä¸­çš„é…ç½®ä½“ç³»æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/09-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E4%B8%8E%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1/">09 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¦‚ä½•ä½¿ç”¨å¼ºä¸€è‡´æ€§äº‹åŠ¡ä¸æŸ”æ€§äº‹åŠ¡ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/10-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E5%A6%82%E4%BD%95%E7%A1%AE%E4%BF%9D%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AE%89%E5%85%A8%E8%AE%BF%E9%97%AE/">10 æ•°æ®è„±æ•ï¼šå¦‚ä½•ç¡®ä¿æ•æ„Ÿæ•°æ®çš„å®‰å…¨è®¿é—®ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/11-%E7%BC%96%E6%8E%92%E6%B2%BB%E7%90%86%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/">11 ç¼–æ’æ²»ç†ï¼šå¦‚ä½•å®ç°åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„åŠ¨æ€é…ç½®ç®¡ç†ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/12-%E4%BB%8E%E5%BA%94%E7%94%A8%E5%88%B0%E5%8E%9F%E7%90%86%E5%A6%82%E4%BD%95%E9%AB%98%E6%95%88%E9%98%85%E8%AF%BB-shardingsphere-%E6%BA%90%E7%A0%81/">12 ä»åº”ç”¨åˆ°åŸç†ï¼šå¦‚ä½•é«˜æ•ˆé˜…è¯» ShardingSphere æºç ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/13-%E5%BE%AE%E5%86%85%E6%A0%B8%E6%9E%B6%E6%9E%84shardingsphere-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%89%A9%E5%B1%95%E6%80%A7/">13 å¾®å†…æ ¸æ¶æ„ï¼šShardingSphere å¦‚ä½•å®ç°ç³»ç»Ÿçš„æ‰©å±•æ€§ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/14-%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AEshardingsphere-%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AE%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F/">14 åˆ†å¸ƒå¼ä¸»é”®ï¼šShardingSphere ä¸­æœ‰å“ªäº›åˆ†å¸ƒå¼ä¸»é”®å®ç°æ–¹å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/15-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8A/">15 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/16-%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8Esql-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5%E4%B8%8B/">16 è§£æå¼•æ“ï¼šSQL è§£ææµç¨‹åº”è¯¥åŒ…æ‹¬å“ªäº›æ ¸å¿ƒé˜¶æ®µï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/17-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E5%88%86%E7%89%87%E8%B7%AF%E7%94%B1%E6%A0%B8%E5%BF%83%E7%B1%BB-shardingrouter-%E7%9A%84%E8%BF%90%E4%BD%9C%E6%9C%BA%E5%88%B6/">17 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•ç†è§£åˆ†ç‰‡è·¯ç”±æ ¸å¿ƒç±» ShardingRouter çš„è¿ä½œæœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/18-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E7%9A%84%E5%88%86%E7%89%87%E8%B7%AF%E7%94%B1%E5%92%8C%E5%B9%BF%E6%92%AD%E8%B7%AF%E7%94%B1/">18 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•å®ç°æ•°æ®è®¿é—®çš„åˆ†ç‰‡è·¯ç”±å’Œå¹¿æ’­è·¯ç”±ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/19-%E8%B7%AF%E7%94%B1%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%9C%A8%E8%B7%AF%E7%94%B1%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%9B%86%E6%88%90%E5%A4%9A%E7%A7%8D%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E5%92%8C%E8%B7%AF%E7%94%B1%E7%AE%97%E6%B3%95/">19 è·¯ç”±å¼•æ“ï¼šå¦‚ä½•åœ¨è·¯ç”±è¿‡ç¨‹ä¸­é›†æˆå¤šç§è·¯ç”±ç­–ç•¥å’Œè·¯ç”±ç®—æ³•ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/20-%E6%94%B9%E5%86%99%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84-sql-%E6%94%B9%E5%86%99%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6/">20 æ”¹å†™å¼•æ“ï¼šå¦‚ä½•ç†è§£è£…é¥°å™¨æ¨¡å¼ä¸‹çš„ SQL æ”¹å†™å®ç°æœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/21-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%88%86%E7%89%87%E7%8E%AF%E5%A2%83%E4%B8%8B-sql-%E6%89%A7%E8%A1%8C%E7%9A%84%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E6%8A%BD%E8%B1%A1/">21 æ‰§è¡Œå¼•æ“ï¼šåˆ†ç‰‡ç¯å¢ƒä¸‹ SQL æ‰§è¡Œçš„æ•´ä½“æµç¨‹åº”è¯¥å¦‚ä½•è¿›è¡ŒæŠ½è±¡ï¼Ÿ</a></li>
                
                
                
                    <li>22 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸Šï¼‰</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/23-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E6%8A%8A%E6%8F%A1-shardingsphere-%E4%B8%AD%E7%9A%84-executor-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8B/">23 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/24-%E5%BD%92%E5%B9%B6%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E6%95%B0%E6%8D%AE%E5%BD%92%E5%B9%B6%E7%9A%84%E7%B1%BB%E5%9E%8B%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%BD%92%E5%B9%B6%E7%AD%96%E7%95%A5%E7%9A%84%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B/">24 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æ•°æ®å½’å¹¶çš„ç±»å‹ä»¥åŠç®€å•å½’å¹¶ç­–ç•¥çš„å®ç°è¿‡ç¨‹ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/25-%E5%BD%92%E5%B9%B6%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E6%B5%81%E5%BC%8F%E5%BD%92%E5%B9%B6%E5%92%8C%E5%86%85%E5%AD%98%E5%BD%92%E5%B9%B6%E5%9C%A8%E5%A4%8D%E6%9D%82%E5%BD%92%E5%B9%B6%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84%E5%BA%94%E7%94%A8%E6%96%B9%E5%BC%8F/">25 å½’å¹¶å¼•æ“ï¼šå¦‚ä½•ç†è§£æµå¼å½’å¹¶å’Œå†…å­˜å½’å¹¶åœ¨å¤æ‚å½’å¹¶åœºæ™¯ä¸‹çš„åº”ç”¨æ–¹å¼ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/26-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%99%AE%E9%80%9A%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%92%8C%E5%88%86%E7%89%87%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%88%86%E5%88%AB%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84/">26 è¯»å†™åˆ†ç¦»ï¼šæ™®é€šä¸»ä»æ¶æ„å’Œåˆ†ç‰‡ä¸»ä»æ¶æ„åˆ†åˆ«æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/27-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3-shardingsphere-%E4%B8%AD%E5%AF%B9%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%8A%BD%E8%B1%A1%E8%BF%87%E7%A8%8B/">27 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¦‚ä½•ç†è§£ ShardingSphere ä¸­å¯¹åˆ†å¸ƒå¼äº‹åŠ¡çš„æŠ½è±¡è¿‡ç¨‹ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/28-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1shardingsphere-%E4%B8%AD%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%E4%B8%8A/">28 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/29-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1shardingsphere-%E4%B8%AD%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%E4%B8%8B/">29 åˆ†å¸ƒå¼äº‹åŠ¡ï¼šShardingSphere ä¸­å¦‚ä½•é›†æˆå¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æ”¯æŒï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/30-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E6%94%B9%E5%86%99%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0%E4%BD%8E%E4%BE%B5%E5%85%A5%E6%80%A7%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E6%96%B9%E6%A1%88/">30 æ•°æ®è„±æ•ï¼šå¦‚ä½•åŸºäºæ”¹å†™å¼•æ“å®ç°ä½ä¾µå…¥æ€§æ•°æ®è„±æ•æ–¹æ¡ˆï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/31-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E7%9A%84%E5%8A%A8%E6%80%81%E5%8C%96%E7%AE%A1%E7%90%86/">31 é…ç½®ä¸­å¿ƒï¼šå¦‚ä½•åŸºäºé…ç½®ä¸­å¿ƒå®ç°é…ç½®ä¿¡æ¯çš„åŠ¨æ€åŒ–ç®¡ç†ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/32-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BF%E9%97%AE%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6/">32 æ³¨å†Œä¸­å¿ƒï¼šå¦‚ä½•åŸºäºæ³¨å†Œä¸­å¿ƒå®ç°æ•°æ®åº“è®¿é—®ç†”æ–­æœºåˆ¶ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/33-%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E-hook-%E6%9C%BA%E5%88%B6%E4%BB%A5%E5%8F%8A-opentracing-%E5%8D%8F%E8%AE%AE%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA/">33 é“¾è·¯è·Ÿè¸ªï¼šå¦‚ä½•åŸºäº Hook æœºåˆ¶ä»¥åŠ OpenTracing åè®®å®ç°æ•°æ®è®¿é—®é“¾è·¯è·Ÿè¸ªï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/35-%E7%BB%93%E8%AF%ADshardingsphere-%E6%80%BB%E7%BB%93%E5%8F%8A%E5%B1%95%E6%9C%9B/">35 ç»“è¯­ï¼šShardingSphere æ€»ç»“åŠå±•æœ›</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">22 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸Šï¼‰</h1>
        <div class="post-info">
            <div class="post-date"> 
                <span>2021-12-22 01:56:01</span>
            </div>
        </div>
        <div class="post-content">
            <p>åœ¨ä¸Šä¸€è¯¾æ—¶ä¸­ï¼Œæˆ‘ä»¬å¯¹ ShardingGroupExecuteCallback å’Œ SQLExecuteTemplate åšäº†ä»‹ç»ã€‚ä»è®¾è®¡ä¸Šè®²ï¼Œå‰è€…å……å½“ ShardingExecuteEngine çš„å›è°ƒå…¥å£ï¼›è€Œåè€…åˆ™æ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œå®Œæˆå¯¹ ShardingExecuteEngine çš„å°è£…å¹¶æä¾›äº†å¯¹å¤–çš„ç»Ÿä¸€å…¥å£ï¼Œè¿™äº›ç±»éƒ½ä½äºåº•å±‚çš„ sharding-core-execute å·¥ç¨‹ä¸­ã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/CgqCHl9HalOAccqPAACp0Ky_Tl8886.png" alt="image.png"></p>
<p>ä»ä»Šå¤©å¼€å§‹ï¼Œæˆ‘ä»¬å°†è¿›å…¥åˆ° sharding-jdbc-core å·¥ç¨‹ï¼Œæ¥çœ‹çœ‹ ShardingSphere ä¸­æ‰§è¡Œå¼•æ“ä¸Šå±‚è®¾è®¡ä¸­çš„å‡ ä¸ªæ ¸å¿ƒç±»ã€‚</p>
<h3 id="abstractstatementexecutor">AbstractStatementExecutor</h3>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ ¹æ®ä¸Šä¸€è¯¾æ—¶ä¸­çš„æ‰§è¡Œå¼•æ“æ•´ä½“ç»“æ„å›¾ï¼Œå¯ä»¥çœ‹åˆ°<strong>SQLExecuteTemplate</strong>çš„ç›´æ¥ä½¿ç”¨è€…æ˜¯<strong>AbstractStatementExecutor ç±»</strong>ï¼Œä»Šå¤©æˆ‘ä»¬å°±ä»è¿™ä¸ªç±»å¼€å§‹å±•å¼€è®¨è®ºï¼Œè¯¥ç±»çš„å˜é‡æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ï¼š</p>
<pre tabindex="0"><code>//æ•°æ®åº“ç±»å‹
private final DatabaseType databaseType;
//JDBCä¸­ç”¨äºæŒ‡å®šç»“æœå¤„ç†æ–¹å¼çš„ resultSetType
private final int resultSetType;
//JDBCä¸­ç”¨äºæŒ‡å®šæ˜¯å¦å¯å¯¹ç»“æœé›†è¿›è¡Œä¿®æ”¹çš„ resultSetConcurrency
private final int resultSetConcurrency; 
//JDBCä¸­ç”¨äºæŒ‡å®šäº‹åŠ¡æäº¤æˆ–å›æ»šåç»“æœé›†æ˜¯å¦ä»ç„¶å¯ç”¨çš„ resultSetConcurrency
private final int resultSetHoldability;
//åˆ†ç‰‡ Connection
private final ShardingConnection connection;
//ç”¨äºæ•°æ®å‡†å¤‡çš„æ¨¡æ¿ç±»
private final SQLExecutePrepareTemplate sqlExecutePrepareTemplate;
//SQL æ‰§è¡Œæ¨¡æ¿ç±»
private final SQLExecuteTemplate sqlExecuteTemplate;
//JDBCçš„Connectionåˆ—è¡¨
private final Collection&lt;Connection&gt; connections = new LinkedList&lt;&gt;();
//SQLStatement ä¸Šä¸‹æ–‡
private SQLStatementContext sqlStatementContext;
//å‚æ•°é›†
private final List&lt;List&lt;Object&gt;&gt; parameterSets = new LinkedList&lt;&gt;(); 
//JDBCçš„Statement åˆ—è¡¨
private final List&lt;Statement&gt; statements = new LinkedList&lt;&gt;(); 
//JDBCçš„ResultSet åˆ—è¡¨
private final List&lt;ResultSet&gt; resultSets = new CopyOnWriteArrayList&lt;&gt;();
//ShardingExecuteGroup åˆ—è¡¨
private final Collection&lt;ShardingExecuteGroup&lt;StatementExecuteUnit&gt;&gt; executeGroups = new LinkedList&lt;&gt;();
</code></pre><p>ä»è¿™ä¸ªç±»å¼€å§‹ï¼Œæˆ‘ä»¬ä¼šæ…¢æ…¢æ¥è§¦ JDBC è§„èŒƒç›¸å…³çš„å¯¹è±¡ï¼Œå› ä¸º ShardingSphere çš„è®¾è®¡ç›®æ ‡æ˜¯ï¼Œé‡å†™ä¸€å¥—ä¸ç›®å‰çš„ JDBC è§„èŒƒå®Œå…¨å…¼å®¹çš„ä½“ç³»ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°çš„ Connectionã€Statement å’Œ ResultSet ç­‰å¯¹è±¡ï¼Œä»¥åŠ resultSetTypeã€resultSetConcurrencyã€resultSetHoldability ç­‰å‚æ•°ï¼Œéƒ½æ˜¯å±äº JDBC è§„èŒƒä¸­çš„å†…å®¹ï¼Œæˆ‘ä»¬åœ¨æ³¨é‡Šä¸Šåšäº†ç‰¹åˆ«çš„è¯´æ˜ï¼Œä½ å¯¹æ­¤ä¹Ÿéƒ½æ¯”è¾ƒç†Ÿæ‚‰ã€‚</p>
<p>è€Œåƒ ShardingSphere è‡ªå·±å°è£…çš„ ShardingConnection å¯¹è±¡ä¹Ÿå¾ˆé‡è¦ï¼Œæˆ‘ä»¬å·²ç»åœ¨ã€Š03 | è§„èŒƒå…¼å®¹ï¼šJDBC è§„èŒƒä¸ ShardingSphere æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿã€‹ä¸­å¯¹è¿™ä¸ªç±»çš„å®ç°æ–¹å¼ï¼Œä»¥åŠå¦‚ä½•å…¼å®¹ JDBC è§„èŒƒçš„è¯¦ç»†è¿‡ç¨‹åšäº†ä»‹ç»ã€‚</p>
<p>åœ¨ AbstractStatementExecutor ä¸­ï¼Œè¿™äº›å˜é‡çš„å±•å¼€ï¼Œä¼šæ¶‰åŠå¾ˆå¤š sharding-jdbc-core ä»£ç å·¥ç¨‹ï¼Œå…³äºæ•°æ®åº“è®¿é—®ç›¸å…³çš„ç±»çš„ä»‹ç»ï¼ŒåŒ…æ‹¬æˆ‘ä»¬ä»¥å‰å·²ç»æ¥è§¦è¿‡çš„ ShardingStatement å’Œ ShardingPreparedStatement ç­‰ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å±•å¼€ AbstractStatementExecutor ç±»çš„å…·ä½“å®ç°æ–¹æ³•ä¹‹å‰ï¼Œéœ€è¦å¯¹è¿™äº›ç±»æœ‰ä¸€å®šçš„äº†è§£ã€‚</p>
<p>åœ¨ AbstractStatementExecutor æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸Šä¸€è¯¾æ—¶ä¸­ä»‹ç»çš„æ‰§è¡Œå¼•æ“ ShardingExecuteEngine çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå¹¶é€šè¿‡å®ƒåˆ›å»ºäº† SQLExecuteTemplate æ¨¡æ¿ç±»ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public AbstractStatementExecutor(final int resultSetType, final int resultSetConcurrency, final int resultSetHoldability, final ShardingConnection shardingConnection) {
    â€¦
    ShardingExecuteEngine executeEngine = connection.getRuntimeContext().getExecuteEngine();
    sqlExecuteTemplate = new SQLExecuteTemplate(executeEngine, connection.isHoldTransaction());
}
</code></pre><p>åŒæ—¶ï¼ŒAbstractStatementExecutor ä¸­å¦‚ä¸‹æ‰€ç¤ºçš„ cacheStatements æ–¹æ³•ä¹Ÿå¾ˆæœ‰ç‰¹è‰²ï¼Œè¯¥æ–¹æ³•ä¼šæ ¹æ®æŒæœ‰çš„ ShardingExecuteGroup ç±»åˆ†åˆ«å¡«å…… statements å’Œ parameterSets è¿™ä¸¤ä¸ªå¯¹è±¡ï¼Œä»¥ä¾› AbstractStatementExecutor çš„å­ç±»è¿›è¡Œä½¿ç”¨ï¼š</p>
<pre tabindex="0"><code>protected final void cacheStatements() {
    for (ShardingExecuteGroup&lt;StatementExecuteUnit&gt; each : executeGroups) {
        statements.addAll(Lists.transform(each.getInputs(), new Function&lt;StatementExecuteUnit, Statement&gt;() {

            @Override
            public Statement apply(final StatementExecuteUnit input) {
                return input.getStatement();
            }
        }));
        parameterSets.addAll(Lists.transform(each.getInputs(), new Function&lt;StatementExecuteUnit, List&lt;Object&gt;&gt;() {

            @Override
            public List&lt;Object&gt; apply(final StatementExecuteUnit input) {
                return input.getRouteUnit().getSqlUnit().getParameters();
            }
        }));
    }
}
</code></pre><p>æ³¨æ„ï¼šè¿™é‡Œåœ¨å®ç°æ–¹å¼ä¸Šä½¿ç”¨äº† Google æä¾›çš„ Guava æ¡†æ¶ä¸­çš„ Lists.transform æ–¹æ³•ï¼Œä»è€Œå®Œæˆäº†ä¸åŒå¯¹è±¡ä¹‹é—´çš„è½¬æ¢è¿‡ç¨‹ï¼Œè¿™ç§å®ç°æ–¹å¼åœ¨ ShardingSphere ä¸­åº”ç”¨å¹¿æ³›ï¼Œéå¸¸å€¼å¾—ä½ å­¦ä¹ ã€‚</p>
<p>ç„¶åæˆ‘ä»¬æ¥çœ‹ AbstractStatementExecutor ä¸­æœ€æ ¸å¿ƒçš„æ–¹æ³•ï¼Œå³æ‰§è¡Œå›è°ƒçš„ executeCallback æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>protected final &lt;T&gt; List&lt;T&gt; executeCallback(final SQLExecuteCallback&lt;T&gt; executeCallback) throws SQLException {
    List&lt;T&gt; result = sqlExecuteTemplate.executeGroup((Collection) executeGroups, executeCallback);
    refreshMetaDataIfNeeded(connection.getRuntimeContext(), sqlStatementContext);
    return result;
}
</code></pre><p>æ˜¾ç„¶ï¼Œåœ¨è¿™é‡Œåº”è¯¥ä½¿ç”¨ SQLExecuteTemplate æ¨¡æ¿ç±»æ¥å®Œæˆå…·ä½“å›è°ƒçš„æ‰§è¡Œè¿‡ç¨‹ã€‚åŒæ—¶ï¼Œæˆ‘å¯ä»¥çœ‹åˆ°è¿™é‡Œè¿˜æœ‰ä¸€ä¸ª refreshMetaDataIfNeeded è¾…åŠ©æ–¹æ³•ç”¨æ¥åˆ·é€‰å…ƒæ•°æ®ã€‚</p>
<p>AbstractStatementExecutor æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼šä¸€ä¸ªæ˜¯æ™®é€šçš„ StatementExecutorï¼Œä¸€ä¸ªæ˜¯ PreparedStatementExecutorï¼Œæ¥ä¸‹æ¥æˆ‘å°†åˆ†åˆ«è¿›è¡Œè®²è§£ã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/Ciqc1F9HamWACCzmAABPdP2Sna8714.png" alt="image"></p>
<h3 id="statementexecutor">StatementExecutor</h3>
<p>æˆ‘ä»¬æ¥åˆ° StatementExecutorï¼Œå…ˆçœ‹å®ƒçš„ç”¨äºæ‰§è¡Œåˆå§‹åŒ–æ“ä½œçš„ init æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>public void init(final SQLRouteResult routeResult) throws SQLException {
    setSqlStatementContext(routeResult.getSqlStatementContext());
    getExecuteGroups().addAll(obtainExecuteGroups(routeResult.getRouteUnits()));
    cacheStatements();
}
</code></pre><p>è¿™é‡Œçš„ cacheStatements æ–¹æ³•å‰é¢å·²ç»ä»‹ç»è¿‡ï¼Œè€Œ obtainExecuteGroups æ–¹æ³•ç”¨äºè·å–æ‰€éœ€çš„ ShardingExecuteGroup é›†åˆã€‚è¦å®ç°è¿™ä¸ªæ–¹æ³•ï¼Œå°±éœ€è¦å¼•å…¥ SQLExecutePrepareTemplate å’Œå¯¹åº”çš„å›è°ƒ SQLExecutePrepareCallbackã€‚</p>
<h4 id="1sqlexecutepreparecallback">1.SQLExecutePrepareCallback</h4>
<p>ä»å‘½åä¸Šçœ‹ï¼Œè®©äººæ„Ÿè§‰ SQLExecutePrepareTemplate å’Œ SQLExecuteTemplate åº”è¯¥æ˜¯ä¸€å¯¹ï¼Œå°¤å…¶æ˜¯åç§°ä¸­æœ‰ä¸€ä¸ªâ€œPrepareâ€ï¼Œè®©äººè”æƒ³åˆ° PreparedStatementã€‚</p>
<p><strong>ä½†äº‹å®ä¸Šï¼ŒSQLExecutePrepareTemplate ä¸ SQLExecuteTemplate æ²¡æœ‰ä»€ä¹ˆå…³è”</strong>ï¼Œå®ƒä¹Ÿä¸æ˜¯åƒ SQLExecuteTemplate ä¸€æ ·æä¾›äº† ShardingExecuteEngine çš„å°è£…ï¼Œè€Œæ˜¯ä¸»è¦å…³æ³¨äº ShardingExecuteGroup æ•°æ®çš„æ”¶é›†å’Œæ‹¼è£…ï¼Œæ¢å¥è¯è¯´æ˜¯<strong>ä¸ºäº†å‡†å¤‡ï¼ˆPrepareï¼‰æ•°æ®</strong>ã€‚</p>
<p>åœ¨ SQLExecutePrepareTemplate ä¸­ï¼Œæ ¸å¿ƒçš„åŠŸèƒ½å°±æ˜¯ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼ å…¥äº†ä¸€ä¸ª SQLExecutePrepareCallback å¯¹è±¡ï¼Œå¹¶è¿”å› ShardingExecuteGroup çš„ä¸€ä¸ªé›†åˆï¼š</p>
<pre tabindex="0"><code>public Collection&lt;ShardingExecuteGroup&lt;StatementExecuteUnit&gt;&gt; getExecuteUnitGroups(final Collection&lt;RouteUnit&gt; routeUnits, final SQLExecutePrepareCallback callback) throws SQLException {
        return getSynchronizedExecuteUnitGroups(routeUnits, callback);
}
</code></pre><p>ä¸ºäº†æ„å»ºè¿™ä¸ªé›†åˆï¼ŒSQLExecutePrepareTemplate å®ç°äº†å¾ˆå¤šè¾…åŠ©æ–¹æ³•ï¼ŒåŒæ—¶å®ƒè¿˜å¼•å…¥äº†ä¸€ä¸ª SQLExecutePrepareCallback å›è°ƒï¼Œæ¥å®Œæˆ ShardingExecuteGroup æ•°æ®ç»“æ„ä¸­éƒ¨åˆ†æ•°æ®çš„å¡«å……ã€‚SQLExecutePrepareCallback æ¥å£å®šä¹‰å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ° Connection å’Œ StatementExecuteUnit è¿™ä¸¤ä¸ªå¯¹è±¡æ˜¯é€šè¿‡å›è°ƒæ¥åˆ›å»ºçš„ï¼š</p>
<pre tabindex="0"><code>public interface SQLExecutePrepareCallback {

    //è·å– Connection åˆ—è¡¨
    List&lt;Connection&gt; getConnections(ConnectionMode connectionMode, String dataSourceName, int connectionSize) throws SQLException;

    //è·å– Statement æ‰§è¡Œå•å…ƒ
    StatementExecuteUnit createStatementExecuteUnit(Connection connection, RouteUnit routeUnit, ConnectionMode connectionMode) throws SQLException;
}
</code></pre><p>å½“æˆ‘ä»¬è·å–äº†æƒ³è¦çš„ ShardingExecuteGroup ä¹‹åï¼Œç›¸å½“äºå®Œæˆäº† StatementExecutor çš„åˆå§‹åŒ–å·¥ä½œã€‚è¯¥ç±»ä¸­å‰©ä¸‹çš„å°±æ˜¯ä¸€ç³»åˆ—ä»¥â€œexecuteâ€å¼€å¤´çš„ SQL æ‰§è¡Œæ–¹æ³•ï¼ŒåŒ…æ‹¬ executeQueryã€executeUpdateï¼Œä»¥åŠå®ƒä»¬çš„å„ç§é‡è½½æ–¹æ³•ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ç”¨äºæŸ¥è¯¢çš„ executeQuery æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>public List&lt;QueryResult&gt; executeQuery() throws SQLException {
    final boolean isExceptionThrown = ExecutorExceptionHandler.isExceptionThrown();
    //åˆ›å»º SQLExecuteCallback å¹¶æ‰§è¡ŒæŸ¥è¯¢
    SQLExecuteCallback&lt;QueryResult&gt; executeCallback = new SQLExecuteCallback&lt;QueryResult&gt;(getDatabaseType(), isExceptionThrown) {

        @Override
        protected QueryResult executeSQL(final String sql, final Statement statement, final ConnectionMode connectionMode) throws SQLException {
            return getQueryResult(sql, statement, connectionMode);
        }
    };
    //æ‰§è¡Œ SQLExecuteCallback å¹¶è¿”å›ç»“æœ
    return executeCallback(executeCallback);
}
</code></pre><p>æˆ‘ä»¬å·²ç»åœ¨ä¸Šä¸€è¯¾æ—¶ä¸­ä»‹ç»è¿‡è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬çŸ¥é“ SQLExecuteCallback å®ç°äº† ShardingGroupExecuteCallback æ¥å£å¹¶æä¾›äº† executeSQL æ¨¡æ¿æ–¹æ³•ã€‚è€Œåœ¨ä¸Šè¿° executeQuery æ–¹æ³•ä¸­ï¼ŒexecuteSQL æ¨¡æ¿æ–¹æ³•çš„å®ç°è¿‡ç¨‹ï¼Œå°±æ˜¯è°ƒç”¨å¦‚ä¸‹æ‰€ç¤ºçš„ getQueryResult æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>private QueryResult getQueryResult(final String sql, final Statement statement, final ConnectionMode connectionMode) throws SQLException {
    //é€šè¿‡ Statement æ‰§è¡Œ SQL å¹¶è·å–ç»“æœ
 ResultSet resultSet = statement.executeQuery(sql);
    getResultSets().add(resultSet);
    //æ ¹æ®è¿æ¥æ¨¡å¼æ¥ç¡®è®¤æ„å»ºç»“æœ
    return ConnectionMode.MEMORY_STRICTLY == connectionMode ? new StreamQueryResult(resultSet) : new MemoryQueryResult(resultSet);
}
</code></pre><h4 id="2connectionmode">2.ConnectionMode</h4>
<p>getQueryResult æ–¹æ³•ä¸­å®Œå…¨åŸºäº JDBC ä¸­çš„ Statement å’Œ ResultSet å¯¹è±¡æ¥æ‰§è¡ŒæŸ¥è¯¢å¹¶è¿”å›ç»“æœã€‚</p>
<p>ä½†æ˜¯ï¼Œè¿™é‡Œä¹Ÿå¼•å…¥äº† ShardingSphere æ‰§è¡Œå¼•æ“ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå³<strong>ConnectionModeï¼ˆè¿æ¥æ¨¡å¼ï¼‰</strong>ï¼Œå®ƒæ˜¯ä¸€ä¸ªæšä¸¾ï¼š</p>
<pre tabindex="0"><code>public enum ConnectionMode {
    MEMORY_STRICTLY, CONNECTION_STRICTLY
}
</code></pre><p>å¯ä»¥çœ‹åˆ°æœ‰ä¸¤ç§å…·ä½“çš„è¿æ¥æ¨¡å¼ï¼šMEMORY_STRICTLY å’Œ CONNECTION_STRICTLYã€‚</p>
<ul>
<li>MEMORY_STRICTLY ä»£è¡¨<strong>å†…å­˜é™åˆ¶æ¨¡å¼</strong>ï¼Œ</li>
<li>CONNECTION_STRICTLY ä»£è¡¨<strong>è¿æ¥é™åˆ¶æ¨¡å¼</strong>ã€‚</li>
</ul>
<p><strong>ConnectionModeï¼ˆè¿æ¥æ¨¡å¼ï¼‰</strong> æ˜¯ ShardingSphere æ‰€æå‡ºçš„ä¸€ä¸ªç‰¹æœ‰æ¦‚å¿µï¼ŒèƒŒåä½“ç°çš„æ˜¯ä¸€ç§è®¾è®¡ä¸Šçš„å¹³è¡¡æ€æƒ³ã€‚ä»æ•°æ®åº“è®¿é—®èµ„æºçš„è§’åº¦æ¥çœ‹ï¼Œä¸€æ–¹é¢æ˜¯å¯¹æ•°æ®åº“è¿æ¥èµ„æºçš„æ§åˆ¶ä¿æŠ¤ï¼Œå¦ä¸€æ–¹é¢æ˜¯é‡‡ç”¨æ›´ä¼˜çš„å½’å¹¶æ¨¡å¼è¾¾åˆ°å¯¹ä¸­é—´ä»¶å†…å­˜èµ„æºçš„èŠ‚çœï¼Œå¦‚ä½•å¤„ç†å¥½ä¸¤è€…ä¹‹é—´çš„å…³ç³»ï¼Œæ˜¯ ShardingSphere æ‰§è¡Œå¼•æ“éœ€æ±‚è§£å†³çš„é—®é¢˜ã€‚</p>
<p>ä¸ºæ­¤ï¼ŒShardingSphere æå‡ºäº†è¿æ¥æ¨¡å¼çš„æ¦‚å¿µï¼Œç®€å•ä¸¾ä¾‹è¯´æ˜ï¼š</p>
<ul>
<li>å½“é‡‡ç”¨<strong>å†…å­˜é™åˆ¶æ¨¡å¼</strong>æ—¶ï¼Œå¯¹äºåŒä¸€æ•°æ®æºï¼Œå¦‚æœæœ‰ 10 å¼ åˆ†è¡¨ï¼Œé‚£ä¹ˆæ‰§è¡Œæ—¶ä¼šè·å– 10 ä¸ªè¿æ¥å¹¶è¿›è¡Œ<strong>å¹¶è¡Œæ‰§è¡Œ</strong>ï¼›</li>
<li>è€Œå½“é‡‡ç”¨<strong>è¿æ¥é™åˆ¶æ¨¡å¼</strong>æ—¶ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­åªä¼šè·å– 1 ä¸ªè¿æ¥è€Œè¿›è¡Œ<strong>ä¸²è¡Œæ‰§è¡Œ</strong>ã€‚</li>
</ul>
<p><strong>é‚£ä¹ˆè¿™ä¸ª ConnectionMode æ˜¯æ€ä¹ˆå¾—å‡ºæ¥çš„å‘¢ï¼Ÿ</strong></p>
<p>å®é™…ä¸Šè¿™éƒ¨åˆ†ä»£ç ä½äº SQLExecutePrepareTemplate ä¸­ï¼Œæˆ‘ä»¬æ ¹æ® maxConnectionsSizePerQuery è¿™ä¸ªé…ç½®é¡¹ï¼Œä»¥åŠä¸æ¯ä¸ªæ•°æ®åº“æ‰€éœ€è¦æ‰§è¡Œçš„ SQL æ•°é‡è¿›è¡Œæ¯”è¾ƒï¼Œç„¶åå¾—å‡ºå…·ä½“çš„ ConnectionModeï¼š</p>
<pre tabindex="0"><code>ConnectionMode connectionMode = maxConnectionsSizePerQuery &lt; sqlUnits.size() ? ConnectionMode.CONNECTION_STRICTLY : ConnectionMode.MEMORY_STRICTLY;
</code></pre><p>å…³äºè¿™ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€å¼ ç®€å•çš„ç¤ºæ„å›¾æ¥è¿›è¡Œè¯´æ˜ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ShardingSphere%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2-%E5%AE%8C/assets/Ciqc1F9HaoaAYskMAACJIb5G6C8859.png" alt="image"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚æœæ¯ä¸ªæ•°æ®åº“è¿æ¥æ‰€æŒ‡å‘çš„ SQL æ•°å¤šäºä¸€æ¡æ—¶ï¼Œèµ°çš„æ˜¯å†…å­˜é™åˆ¶æ¨¡å¼ï¼Œåä¹‹èµ°çš„æ˜¯è¿æ¥é™åˆ¶æ¨¡å¼ã€‚</p>
<h4 id="3streamqueryresult-vs-memoryqueryresult">3.StreamQueryResult VS MemoryQueryResult</h4>
<p>åœ¨äº†è§£äº† ConnectionModeï¼ˆè¿æ¥æ¨¡å¼ï¼‰ çš„è®¾è®¡ç†å¿µåï¼Œæˆ‘ä»¬å†æ¥çœ‹ StatementExecutor çš„ executeQuery æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ª QueryResultã€‚</p>
<p>åœ¨ ShardingSphere ä¸­ï¼Œ<strong>QueryResult æ˜¯ä¸€ä¸ªä»£è¡¨æŸ¥è¯¢ç»“æœçš„æ¥å£</strong>ï¼Œå¯ä»¥çœ‹åˆ°è¯¥æ¥å£å°è£…äº†å¾ˆå¤šé¢å‘åº•å±‚æ•°æ®è·å–çš„æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>public interface QueryResult {
    boolean next() throws SQLException;
    Object getValue(int columnIndex, Class&lt;?&gt; type) throws SQLException;
    Object getCalendarValue(int columnIndex, Class&lt;?&gt; type, Calendar calendar) throws SQLException;
    InputStream getInputStream(int columnIndex, String type) throws SQLException;
    boolean wasNull() throws SQLException;
    int getColumnCount() throws SQLException;
    String getColumnLabel(int columnIndex) throws SQLException;
    boolean isCaseSensitive(int columnIndex) throws SQLException;
}
</code></pre><p>åœ¨ ShardingSphereä¸­ï¼Œ<strong>QueryResult æ¥å£å­˜åœ¨äº StreamQueryResultï¼ˆä»£è¡¨æµå¼å½’å¹¶ç»“æœï¼‰å’Œ MemoryQueryResult ï¼ˆä»£è¡¨å†…å­˜å½’å¹¶ç»“æœï¼‰è¿™ä¸¤ä¸ªå®ç°ç±»</strong>ã€‚</p>
<blockquote>
<p>ShardingSphere é‡‡ç”¨è¿™æ ·çš„è®¾è®¡å®é™…ä¸Šè·Ÿå‰é¢ä»‹ç»çš„ ConnectionMode æœ‰ç›´æ¥å…³ç³»ã€‚</p>
</blockquote>
<ul>
<li>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨<strong>å†…å­˜é™åˆ¶</strong>æ¨¡å¼ä¸­ï¼ŒShardingSphere å¯¹ä¸€æ¬¡æ“ä½œæ‰€è€—è´¹çš„æ•°æ®åº“è¿æ¥æ•°é‡<strong>ä¸åšé™åˆ¶</strong>ï¼›</li>
<li>è€Œå½“é‡‡ç”¨<strong>è¿æ¥é™åˆ¶</strong>æ¨¡å¼æ—¶ï¼ŒShardingSphere<strong>ä¸¥æ ¼æ§åˆ¶</strong>å¯¹ä¸€æ¬¡æ“ä½œæ‰€è€—è´¹çš„æ•°æ®åº“è¿æ¥æ•°é‡ã€‚</li>
</ul>
<p>åŸºäºè¿™æ ·çš„è®¾è®¡åŸç†ï¼Œå¦‚ä¸Šé¢çš„ ConnectionMode çš„è®¡ç®—ç¤ºæ„å›¾æ‰€ç¤ºï¼šåœ¨ maxConnectionSizePerQuery å…è®¸çš„èŒƒå›´å†…ï¼Œå½“ä¸€ä¸ªè¿æ¥éœ€è¦æ‰§è¡Œçš„è¯·æ±‚æ•°é‡å¤§äº 1 æ—¶ï¼Œæ„å‘³ç€å½“å‰çš„æ•°æ®åº“è¿æ¥æ— æ³•æŒæœ‰ç›¸åº”çš„æ•°æ®ç»“æœé›†ï¼Œåˆ™å¿…é¡»é‡‡ç”¨<strong>å†…å­˜å½’å¹¶</strong>ï¼›åä¹‹ï¼Œåˆ™å¯ä»¥é‡‡ç”¨<strong>æµå¼å½’å¹¶</strong>ã€‚</p>
<ul>
<li><strong>StreamQueryResult</strong></li>
</ul>
<p>æˆ‘ä»¬é€šè¿‡å¯¹æ¯” StreamQueryResult å’Œ MemoryQueryResult çš„å®ç°è¿‡ç¨‹ï¼Œå¯¹ä¸Šè¿°åŸç†åšè¿›ä¸€æ­¥åˆ†æï¼Œåœ¨ StreamQueryResult ä¸­ï¼Œå®ƒçš„ next æ–¹æ³•éå¸¸ç®€å•ï¼š</p>
<pre tabindex="0"><code>@Override
public boolean next() throws SQLException {
    return resultSet.next();
}
</code></pre><p>æ˜¾ç„¶è¿™æ˜¯ä¸€ç§<strong>æµå¼å¤„ç†</strong>çš„æ–¹å¼ï¼Œä» ResultSet ä¸­è·å–ä¸‹ä¸€ä¸ªæ•°æ®è¡Œã€‚</p>
<ul>
<li><strong>MemoryQueryResult</strong></li>
</ul>
<p>æˆ‘ä»¬å†æ¥çœ‹ MemoryQueryResultï¼Œåœ¨å®ƒçš„æ„é€ å‡½æ•°ä¸­ï¼Œé€šè¿‡ getRows æ–¹æ³•æŠŠ ResultSet ä¸­çš„å…¨éƒ¨æ•°æ®è¡Œï¼Œå…ˆè¿›è¡Œè·å–å¹¶å­˜å‚¨åœ¨å†…å­˜å˜é‡ rows ä¸­ï¼š</p>
<pre tabindex="0"><code>private Iterator&lt;List&lt;Object&gt;&gt; getRows(final ResultSet resultSet) throws SQLException {
    Collection&lt;List&lt;Object&gt;&gt; result = new LinkedList&lt;&gt;();
    while (resultSet.next()) {
        List&lt;Object&gt; rowData = new ArrayList&lt;&gt;(resultSet.getMetaData().getColumnCount());
        for (int columnIndex = 1; columnIndex &lt;= resultSet.getMetaData().getColumnCount(); columnIndex++) {
          //è·å–æ¯ä¸€ä¸ª Row çš„æ•°æ®
            Object rowValue = getRowValue(resultSet, columnIndex);
          //å­˜æ”¾åœ¨å†…å­˜ä¸­
            rowData.add(resultSet.wasNull() ? null : rowValue);
        }
        result.add(rowData);
    }
    return result.iterator();
}
</code></pre><p>åŸºäºä»¥ä¸Šæ–¹æ³•ï¼ŒMemoryQueryResult çš„ next æ–¹æ³•åº”è¯¥æ˜¯ï¼Œä»è¿™ä¸ª rows å˜é‡ä¸­è·å–ä¸‹ä¸€ä¸ªæ•°æ®è¡Œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public boolean next() {
    if (rows.hasNext()) {
        currentRow = rows.next();
        return true;
    }
    currentRow = null;
    return false;
}
</code></pre><p><strong>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å°±å°†ä¼ ç»Ÿçš„æµå¼å¤„ç†æ–¹å¼è½¬å˜æˆäº†å†…å­˜å¤„ç†æ–¹å¼ã€‚</strong></p>
<p>å…³äº ConnectionMode å’Œä¸¤ç§ QueryResult çš„è®¨è®ºå°±åˆ°è¿™é‡Œï¼Œè®©æˆ‘ä»¬å›åˆ° StatementExecutorã€‚ç†è§£äº† StatementExecutor çš„ executeQuery æ–¹æ³•ä¹‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹å®ƒæ›´ä¸ºé€šç”¨çš„ execute æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>public boolean execute() throws SQLException {
     return execute(new Executor() {

         @Override
         public boolean execute(final Statement statement, final String sql) throws SQLException {
             return statement.execute(sql);
         }
     });
}
</code></pre><p>æ³¨æ„åˆ°ä¸Šè¿° execute æ–¹æ³•å¹¶æ²¡æœ‰ä½¿ç”¨ SQLExecuteCallback å›è°ƒï¼Œè€Œæ˜¯ä½¿ç”¨äº†ä¸€ä¸ª Executor æ¥å£ï¼Œè¯¥æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>private interface Executor {
        //æ‰§è¡Œ SQL
        boolean execute(Statement statement, String sql) throws SQLException;
}
</code></pre><p>ç„¶åæˆ‘ä»¬å†ç»§ç»­å¾€ä¸‹çœ‹ï¼Œå‘ç°åœ¨æ”¹æ–¹æ³•å®é™…çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¿˜æ˜¯ç”¨åˆ°äº† SQLExecuteCallback å›è°ƒï¼š</p>
<pre tabindex="0"><code>private boolean execute(final Executor executor) throws SQLException {
    final boolean isExceptionThrown = ExecutorExceptionHandler.isExceptionThrown();
    //åˆ›å»º SQLExecuteCallback å¹¶æ‰§è¡Œ
    SQLExecuteCallback&lt;Boolean&gt; executeCallback = new SQLExecuteCallback&lt;Boolean&gt;(getDatabaseType(), isExceptionThrown) {

        @Override
        protected Boolean executeSQL(final String sql, final Statement statement, final ConnectionMode connectionMode) throws SQLException {
            //ä½¿ç”¨ Executor è¿›è¡Œæ‰§è¡Œ
            return executor.execute(statement, sql);
        }
    };
    List&lt;Boolean&gt; result = executeCallback(executeCallback);
    if (null == result || result.isEmpty() || null == result.get(0)) {
        return false;
    }
    return result.get(0);
}
</code></pre><p>è¿™é‡Œå¤šåµŒå¥—ä¸€å±‚çš„ç›®çš„æ˜¯ï¼Œæ›´å¥½åœ°åˆ†ç¦»ä»£ç çš„èŒè´£ï¼Œå¹¶å¯¹æ‰§è¡Œç»“æœè¿›è¡Œå¤„ç†ï¼ŒåŒæ ·çš„å¤„ç†æŠ€å·§åœ¨ StatementExecutor çš„ executeUpdate æ–¹æ³•ä¸­ä¹Ÿæœ‰ä½“ç°ã€‚</p>
<h3 id="preparedstatementexecutor">PreparedStatementExecutor</h3>
<p>è®²å®Œ StatementExecutor ä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹ PreparedStatementExecutorã€‚PreparedStatementExecutor åŒ…å«äº†ä¸ StatementExecutor ä¸€æ ·çš„ç”¨äºåˆå§‹åŒ–çš„ init æ–¹æ³•ã€‚ç„¶åï¼Œæˆ‘ä»¬åŒæ ·æ¥çœ‹å®ƒå¦‚ä¸‹æ‰€ç¤ºçš„ executeQuery æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„å¤„ç†æ–¹å¼ä¸åœ¨ StatementExecutor çš„ä¸€è‡´ï¼š</p>
<pre tabindex="0"><code>public List&lt;QueryResult&gt; executeQuery() throws SQLException {
    final boolean isExceptionThrown = ExecutorExceptionHandler.isExceptionThrown();
   //åˆ›å»º SQLExecuteCallback å¹¶æ‰§è¡Œ
    SQLExecuteCallback&lt;QueryResult&gt; executeCallback = new SQLExecuteCallback&lt;QueryResult&gt;(getDatabaseType(), isExceptionThrown) {

        @Override
        protected QueryResult executeSQL(final String sql, final Statement statement, final ConnectionMode connectionMode) throws SQLException {
            return getQueryResult(statement, connectionMode);
        }
    };
    return executeCallback(executeCallback);
}
</code></pre><p>ç„¶åï¼Œæˆ‘ä»¬å†æ¥çœ‹å®ƒçš„ execute æ–¹æ³•ï¼Œå°±ä¼šå‘ç°æœ‰ä¸åŒç‚¹ï¼š</p>
<pre tabindex="0"><code>public boolean execute() throws SQLException {
    boolean isExceptionThrown = ExecutorExceptionHandler.isExceptionThrown();
    SQLExecuteCallback&lt;Boolean&gt; executeCallback = SQLExecuteCallbackFactory.getPreparedSQLExecuteCallback(getDatabaseType(), isExceptionThrown);
    List&lt;Boolean&gt; result = executeCallback(executeCallback);
    if (null == result || result.isEmpty() || null == result.get(0)) {
        return false;
    }
    return result.get(0);
}
</code></pre><p>ä¸ StatementExecutor ä¸åŒï¼ŒPreparedStatementExecutor åœ¨å®ç° execute æ–¹æ³•æ—¶æ²¡æœ‰è®¾è®¡ç±»ä¼¼ Executor è¿™æ ·çš„æ¥å£ï¼Œè€Œæ˜¯ç›´æ¥æä¾›äº†ä¸€ä¸ªå·¥å‚ç±» SQLExecuteCallbackFactoryï¼š</p>
<pre tabindex="0"><code>public final class SQLExecuteCallbackFactory {
â€¦
    public static SQLExecuteCallback&lt;Boolean&gt; getPreparedSQLExecuteCallback(final DatabaseType databaseType, final boolean isExceptionThrown) {
        return new SQLExecuteCallback&lt;Boolean&gt;(databaseType, isExceptionThrown) {

            @Override
            protected Boolean executeSQL(final String sql, final Statement statement, final ConnectionMode connectionMode) throws SQLException {
                return ((PreparedStatement) statement).execute();
            }
        };
}
}
</code></pre><p>æ³¨æ„åˆ°è¿™é‡Œçš„é™æ€æ–¹æ³• getPreparedSQLExecuteCallback ä¹Ÿå°±æ˜¯è¿”å›äº†ä¸€ä¸ª SQLExecuteCallback å›è°ƒçš„å®ç°ï¼Œè€Œåœ¨è¿™ä¸ªå®ç°ä¸­ä½¿ç”¨äº† JDBC åº•å±‚çš„ PreparedStatement å®Œæˆå…·ä½“ SQL çš„æ‰§è¡Œè¿‡ç¨‹ã€‚</p>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å¯¹ ShardingSphere ä¸­ä¸¤ä¸ªä¸»è¦æ‰§è¡Œå™¨ StatementExecutor å’Œ PreparedStatementExecutor éƒ½è¿›è¡Œäº†è¯¦ç»†ä»‹ç»ã€‚</p>
<h3 id="ä»æºç è§£æåˆ°æ—¥å¸¸å¼€å‘">ä»æºç è§£æåˆ°æ—¥å¸¸å¼€å‘</h3>
<p>æœ¬è¯¾æ—¶å…³äºä¸¤ç§ QueryResult çš„è®¾è®¡æ€æƒ³ï¼ŒåŒæ ·å¯ä»¥åº”ç”¨åˆ°æ—¥å¸¸å¼€å‘ä¸­ã€‚å½“æˆ‘ä»¬é¢å¯¹å¦‚ä½•å¤„ç†æ¥è‡ªæ•°æ®åº“æˆ–å¤–éƒ¨æ•°æ®æºçš„æ•°æ®æ—¶ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è®¾è®¡<strong>æµå¼è®¿é—®æ–¹å¼</strong>å’Œ<strong>å†…å­˜è®¿é—®æ–¹å¼</strong>ï¼Œè¿™ä¸¤ç§è®¿é—®æ–¹å¼åœ¨æ•°æ®è®¿é—®è¿‡ç¨‹ä¸­éƒ½å…·æœ‰ä¸€å®šçš„ä»£è¡¨æ€§ã€‚</p>
<p>é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šé¦–å…ˆæƒ³åˆ°å°†æ‰€æœ‰è®¿é—®åˆ°çš„æ•°æ®å­˜æ”¾åœ¨å†…å­˜ä¸­ï¼Œå†è¿›è¡ŒäºŒæ¬¡å¤„ç†ï¼Œä½†è¿™ç§å¤„ç†æ–¹å¼ä¼šé¢ä¸´æ€§èƒ½é—®é¢˜ï¼Œæµå¼è®¿é—®æ–¹å¼æ€§èƒ½æ›´é«˜ï¼Œä½†éœ€è¦æˆ‘ä»¬æŒ–æ˜é€‚åˆçš„åº”ç”¨åœºæ™¯ã€‚</p>
<h3 id="å°ç»“ä¸é¢„å‘Š">å°ç»“ä¸é¢„å‘Š</h3>
<p>ä»Šå¤©ä»‹ç»äº† ShardingSphere æ‰§è¡Œå¼•æ“ä¸»é¢˜çš„ç¬¬äºŒä¸ªè¯¾æ—¶ï¼Œæˆ‘ä»¬é‡ç‚¹å›´ç»•æ‰§è¡Œå¼•æ“ä¸­çš„æ‰§è¡Œå™¨å±•å¼€è®¨è®ºï¼Œç»™å‡ºäº† StatementExecutor å’Œ PreparedStatementExecutor è¿™ä¸¤ç§æ‰§è¡Œå™¨çš„å®ç°æ–¹å¼ï¼Œä¹Ÿç»™å‡ºäº† ShardingSphere ä¸­å…³äºè¿æ¥æ¨¡å¼çš„è¯¦ç»†è®¨è®ºã€‚</p>
<p>è¿™é‡Œç»™å¤§å®¶ç•™ä¸€é“æ€è€ƒé¢˜ï¼šShardingSphere ä¸­è¿æ¥æ¨¡å¼çš„æ¦‚å¿µå’Œä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸å¤§å®¶è®¨è®ºï¼Œæˆ‘å°†é€ä¸€ç‚¹è¯„è§£ç­”ã€‚</p>
<p>ä»ç±»å±‚ç»“æ„è€Œè¨€ï¼ŒStatementExecutor å’Œ PreparedStatementExecutor éƒ½å±äºåº•å±‚ç»„ä»¶ï¼Œåœ¨ä¸‹ä¸€è¯¾æ—¶ï¼Œæˆ‘ä»¬ä¼šä»‹ç»åŒ…æ‹¬ ShardingStatement å’Œ PreparedShardingStatement åœ¨å†…çš„ä½äºæ›´åŠ ä¸Šå±‚çš„æ‰§è¡Œå¼•æ“ç»„ä»¶ã€‚</p>

        </div>
    </article>
</div>
<div class="division-line"></div>
<div class="others">
    <div>æ ‡ç­¾ï¼šğŸ·ï¸<a class="post-tag" href="/tags/sharding/">sharding</a>&nbsp;</div>
    <div>åˆ†ç±»ï¼š ğŸ“’<a class="post-category" href="/categories/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/">ShardingSphereæ ¸å¿ƒåŸç†ç²¾è®²</a>&nbsp; </div>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/21-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%88%86%E7%89%87%E7%8E%AF%E5%A2%83%E4%B8%8B-sql-%E6%89%A7%E8%A1%8C%E7%9A%84%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E5%BA%94%E8%AF%A5%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E6%8A%BD%E8%B1%A1/"><span>21 æ‰§è¡Œå¼•æ“ï¼šåˆ†ç‰‡ç¯å¢ƒä¸‹ SQL æ‰§è¡Œçš„æ•´ä½“æµç¨‹åº”è¯¥å¦‚ä½•è¿›è¡ŒæŠ½è±¡ï¼Ÿ</span></a>
    </div>
    <div class="next">
        
        <a href="http://yipsen.github.io/documents/columns/sharding/shardingsphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2/23-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E6%8A%8A%E6%8F%A1-shardingsphere-%E4%B8%AD%E7%9A%84-executor-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8B/"><span>23 æ‰§è¡Œå¼•æ“ï¼šå¦‚ä½•æŠŠæ¡ ShardingSphere ä¸­çš„ Executor æ‰§è¡Œæ¨¡å‹ï¼Ÿï¼ˆä¸‹ï¼‰</span></a>
    </div>
</div>

        </div>
        <div id="float">
            <ul class="float-button-bar">
    <li>
        <button class="float-button top" onclick="scrollToTop(this);">UP</button>
    </li>
    <li>
        <button class="float-button toggler" onclick="changeSkin(this);">DARK</button>
    </li>
</ul>
        </div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 2020 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    const changeSkin = () => {
        document.getElementById('page').classList.toggle('night');
    }
    const scrollToTop = () => {
        window.scrollTo(0, 0);
    }
</script>
</body>

</html>