<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>11 é¸Ÿç° MyBatis åˆå§‹åŒ–ï¼ŒæŠŠæ¡ MyBatis å¯åŠ¨æµç¨‹è„‰ç»œï¼ˆä¸‹ï¼‰ | Yipsen Ye</title>
<meta name="description" content="åœ¨ä¸Šä¸€è®²ï¼Œæˆ‘ä»¬æ·±å…¥åˆ†æäº†MyBatis åˆå§‹åŒ–è¿‡ç¨‹ä¸­å¯¹ mybatis-config.xml å…¨å±€é…ç½®æ–‡ä»¶çš„è§£æï¼Œè¯¦ç»†ä»‹ç»äº†å…¶ä¸­æ¯ä¸ªæ ‡ç­¾çš„è§£ææµç¨‹ä»¥åŠæ¶‰åŠçš„ç»å…¸è®¾è®¡æ¨¡å¼â€”â€”æ„é€ è€…æ¨¡å¼ã€‚è¿™ä¸€è®²æˆ‘ä»¬å°±ç´§æ¥ç€ä¸Šä¸€è®²çš„å†…å®¹ï¼Œç»§ç»­ä»‹ç» MyBatis åˆå§‹åŒ–æµç¨‹ï¼Œé‡ç‚¹ä»‹ç»Mapper.xml é…ç½®æ–‡ä»¶çš„è§£æä»¥åŠ SQL è¯­å¥çš„å¤„ç†é€»è¾‘ã€‚
Mapper.xml æ˜ å°„æ–‡ä»¶è§£æå…¨æµç¨‹ åœ¨ä¸Šä¸€è®²åˆ†æ mybatis-config.xml é…ç½®æ–‡ä»¶è§£ææµç¨‹çš„æ—¶å€™æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨ mybatis-config.xml é…ç½®æ–‡ä»¶ä¸­å¯ä»¥å®šä¹‰å¤šä¸ª &amp;lt;mapper&amp;gt; æ ‡ç­¾æŒ‡å®š Mapper é…ç½®æ–‡ä»¶çš„åœ°å€ï¼ŒMyBatis ä¼šä¸ºæ¯ä¸ª Mapper.xml æ˜ å°„æ–‡ä»¶åˆ›å»ºä¸€ä¸ª XMLMapperBuilder å®ä¾‹å®Œæˆè§£æã€‚
ä¸ XMLConfigBuilder ç±»ä¼¼ï¼ŒXMLMapperBuilderä¹Ÿæ˜¯å…·ä½“æ„é€ è€…çš„è§’è‰²ï¼Œç»§æ‰¿äº† BaseBuilder è¿™ä¸ªæŠ½è±¡ç±»ï¼Œè§£æ Mapper.xml æ˜ å°„æ–‡ä»¶çš„å…¥å£æ˜¯ XMLMapperBuilder.parse() æ–¹æ³•ï¼Œå…¶æ ¸å¿ƒæ­¥éª¤å¦‚ä¸‹ï¼š
 æ‰§è¡Œ configurationElement() æ–¹æ³•è§£ææ•´ä¸ªMapper.xml æ˜ å°„æ–‡ä»¶çš„å†…å®¹ï¼› è·å–å½“å‰ Mapper.xml æ˜ å°„æ–‡ä»¶æŒ‡å®šçš„ Mapper æ¥å£ï¼Œå¹¶è¿›è¡Œæ³¨å†Œï¼› å¤„ç† configurationElement() æ–¹æ³•ä¸­è§£æå¤±è´¥çš„ &amp;lt;resultMap&amp;gt; æ ‡ç­¾ï¼› å¤„ç† configurationElement() æ–¹æ³•ä¸­è§£æå¤±è´¥çš„ &amp;lt;cache-ref&amp;gt; æ ‡ç­¾ï¼› å¤„ç† configurationElement() æ–¹æ³•ä¸­è§£æå¤±è´¥çš„SQL è¯­å¥æ ‡ç­¾ã€‚  å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ï¼ŒconfigurationElement() æ–¹æ³•æ‰æ˜¯çœŸæ­£è§£æ Mapper.xml æ˜ å°„æ–‡ä»¶çš„åœ°æ–¹ï¼Œå…¶ä¸­å®šä¹‰äº†å¤„ç† Mapper.xml æ˜ å°„æ–‡ä»¶çš„æ ¸å¿ƒæµç¨‹ï¼š
 è·å– &amp;lt;mapper&amp;gt; æ ‡ç­¾ä¸­çš„ namespace å±æ€§ï¼ŒåŒæ—¶ä¼šè¿›è¡Œå¤šç§è¾¹ç•Œæ£€æŸ¥ï¼› è§£æ &amp;lt;cache&amp;gt; æ ‡ç­¾ï¼› è§£æ &amp;lt;cache-ref&amp;gt; æ ‡ç­¾ï¼› è§£æ &amp;lt;resultMap&amp;gt; æ ‡ç­¾ï¼› è§£æ &amp;lt;sql&amp;gt; æ ‡ç­¾ï¼› è§£æ &amp;lt;select&amp;gt;ã€&amp;lt;insert&amp;gt;ã€&amp;lt;update&amp;gt;ã€&amp;lt;delete&amp;gt; ç­‰ SQL æ ‡ç­¾ã€‚  ä¸‹é¢æˆ‘ä»¬å°±æŒ‰ç…§é¡ºåºé€ä¸€ä»‹ç»è¿™äº›æ–¹æ³•çš„æ ¸å¿ƒå®ç°ã€‚">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/%e6%b7%b1%e5%85%a5%e5%89%96%e6%9e%90mybatis%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86/">æ·±å…¥å‰–æMyBatisæ ¸å¿ƒåŸç†</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/00-%E5%BC%80%E7%AF%87%E8%AF%8D-%E9%A2%86%E7%95%A5-mybatis-%E8%AE%BE%E8%AE%A1%E6%80%9D%E7%BB%B4%E7%AA%81%E7%A0%B4%E6%8C%81%E4%B9%85%E5%8C%96%E6%8A%80%E6%9C%AF%E7%93%B6%E9%A2%88/">00 å¼€ç¯‡è¯ é¢†ç•¥ MyBatis è®¾è®¡æ€ç»´ï¼Œçªç ´æŒä¹…åŒ–æŠ€æœ¯ç“¶é¢ˆ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/01-%E5%B8%B8%E8%A7%81%E6%8C%81%E4%B9%85%E5%B1%82%E6%A1%86%E6%9E%B6%E8%B5%8F%E6%9E%90%E5%88%B0%E5%BA%95%E6%98%AF%E4%BB%80%E4%B9%88%E8%AE%A9%E4%BD%A0%E9%80%89%E6%8B%A9-mybatis/">01 å¸¸è§æŒä¹…å±‚æ¡†æ¶èµæï¼Œåˆ°åº•æ˜¯ä»€ä¹ˆè®©ä½ é€‰æ‹© MyBatisï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/02-%E8%AE%A2%E5%8D%95%E7%B3%BB%E7%BB%9F%E6%8C%81%E4%B9%85%E5%B1%82%E7%A4%BA%E4%BE%8B%E5%88%86%E6%9E%9020-%E5%88%86%E9%92%9F%E5%B8%A6%E4%BD%A0%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B-mybatis/">02 è®¢å•ç³»ç»ŸæŒä¹…å±‚ç¤ºä¾‹åˆ†æï¼Œ20 åˆ†é’Ÿå¸¦ä½ å¿«é€Ÿä¸Šæ‰‹ MyBatis</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/03-mybatis-%E6%BA%90%E7%A0%81%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%8F%8A%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E8%A7%A3%E6%9E%90/">03 MyBatis æºç ç¯å¢ƒæ­å»ºåŠæ•´ä½“æ¶æ„è§£æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/04-mybatis-%E5%8F%8D%E5%B0%84%E5%B7%A5%E5%85%B7%E7%AE%B1%E5%B8%A6%E4%BD%A0%E9%A2%86%E7%95%A5%E4%B8%8D%E4%B8%80%E6%A0%B7%E7%9A%84%E5%8F%8D%E5%B0%84%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/">04 MyBatis åå°„å·¥å…·ç®±ï¼šå¸¦ä½ é¢†ç•¥ä¸ä¸€æ ·çš„åå°„è®¾è®¡æ€è·¯</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/05-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B1%BB%E5%9E%8B%E4%BD%93%E7%B3%BB%E4%B8%8E-java-%E7%B1%BB%E5%9E%8B%E4%BD%93%E7%B3%BB%E4%B9%8B%E9%97%B4%E7%9A%84%E7%88%B1%E6%81%A8%E6%83%85%E4%BB%87/">05 æ•°æ®åº“ç±»å‹ä½“ç³»ä¸ Java ç±»å‹ä½“ç³»ä¹‹é—´çš„â€œçˆ±æ¨æƒ…ä»‡â€</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/06-%E6%97%A5%E5%BF%97%E6%A1%86%E6%9E%B6%E5%8D%83%E5%8D%83%E4%B8%87mybatis-%E9%83%BD%E8%83%BD%E5%85%BC%E5%AE%B9%E7%9A%84%E7%A7%98%E5%AF%86%E6%98%AF%E4%BB%80%E4%B9%88/">06 æ—¥å¿—æ¡†æ¶åƒåƒä¸‡ï¼ŒMyBatis éƒ½èƒ½å…¼å®¹çš„ç§˜å¯†æ˜¯ä»€ä¹ˆï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/07-%E6%B7%B1%E5%85%A5%E6%95%B0%E6%8D%AE%E6%BA%90%E5%92%8C%E4%BA%8B%E5%8A%A1%E6%8A%8A%E6%8F%A1%E6%8C%81%E4%B9%85%E5%8C%96%E6%A1%86%E6%9E%B6%E7%9A%84%E4%B8%A4%E4%B8%AA%E5%85%B3%E9%94%AE%E5%91%BD%E8%84%89/">07 æ·±å…¥æ•°æ®æºå’Œäº‹åŠ¡ï¼ŒæŠŠæ¡æŒä¹…åŒ–æ¡†æ¶çš„ä¸¤ä¸ªå…³é”®å‘½è„‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/08-mapper-%E6%96%87%E4%BB%B6%E4%B8%8E-java-%E6%8E%A5%E5%8F%A3%E7%9A%84%E4%BC%98%E9%9B%85%E6%98%A0%E5%B0%84%E4%B9%8B%E9%81%93/">08 Mapper æ–‡ä»¶ä¸ Java æ¥å£çš„ä¼˜é›…æ˜ å°„ä¹‹é“</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/09-%E5%9F%BA%E4%BA%8E-mybatis-%E7%BC%93%E5%AD%98%E5%88%86%E6%9E%90%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">09 åŸºäº MyBatis ç¼“å­˜åˆ†æè£…é¥°å™¨æ¨¡å¼çš„æœ€ä½³å®è·µ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/10-%E9%B8%9F%E7%9E%B0-mybatis-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%8A%8A%E6%8F%A1-mybatis-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E8%84%89%E7%BB%9C%E4%B8%8A/">10 é¸Ÿç° MyBatis åˆå§‹åŒ–ï¼ŒæŠŠæ¡ MyBatis å¯åŠ¨æµç¨‹è„‰ç»œï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li>11 é¸Ÿç° MyBatis åˆå§‹åŒ–ï¼ŒæŠŠæ¡ MyBatis å¯åŠ¨æµç¨‹è„‰ç»œï¼ˆä¸‹ï¼‰</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/12-%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90%E5%8A%A8%E6%80%81-sql-%E8%AF%AD%E5%8F%A5%E8%A7%A3%E6%9E%90%E5%85%A8%E6%B5%81%E7%A8%8B%E4%B8%8A/">12 æ·±å…¥åˆ†æåŠ¨æ€ SQL è¯­å¥è§£æå…¨æµç¨‹ï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/13-%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90%E5%8A%A8%E6%80%81-sql-%E8%AF%AD%E5%8F%A5%E8%A7%A3%E6%9E%90%E5%85%A8%E6%B5%81%E7%A8%8B%E4%B8%8B/">13 æ·±å…¥åˆ†æåŠ¨æ€ SQL è¯­å¥è§£æå…¨æµç¨‹ï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/14-%E6%8E%A2%E7%A9%B6-mybatis-%E7%BB%93%E6%9E%9C%E9%9B%86%E6%98%A0%E5%B0%84%E6%9C%BA%E5%88%B6%E8%83%8C%E5%90%8E%E7%9A%84%E7%A7%98%E5%AF%86%E4%B8%8A/">14 æ¢ç©¶ MyBatis ç»“æœé›†æ˜ å°„æœºåˆ¶èƒŒåçš„ç§˜å¯†ï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/15-%E6%8E%A2%E7%A9%B6-mybatis-%E7%BB%93%E6%9E%9C%E9%9B%86%E6%98%A0%E5%B0%84%E6%9C%BA%E5%88%B6%E8%83%8C%E5%90%8E%E7%9A%84%E7%A7%98%E5%AF%86%E4%B8%8B/">15 æ¢ç©¶ MyBatis ç»“æœé›†æ˜ å°„æœºåˆ¶èƒŒåçš„ç§˜å¯†ï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/16-statementhandler%E5%8F%82%E6%95%B0%E7%BB%91%E5%AE%9Asql-%E6%89%A7%E8%A1%8C%E5%92%8C%E7%BB%93%E6%9E%9C%E6%98%A0%E5%B0%84%E7%9A%84%E5%A5%A0%E5%9F%BA%E8%80%85/">16 StatementHandlerï¼šå‚æ•°ç»‘å®šã€SQL æ‰§è¡Œå’Œç»“æœæ˜ å°„çš„å¥ åŸºè€…</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/17-executor-%E6%89%8D%E6%98%AF%E6%89%A7%E8%A1%8C-sql-%E8%AF%AD%E5%8F%A5%E7%9A%84%E5%B9%95%E5%90%8E%E6%8E%A8%E6%89%8B%E4%B8%8A/">17 Executor æ‰æ˜¯æ‰§è¡Œ SQL è¯­å¥çš„å¹•åæ¨æ‰‹ï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/18-executor-%E6%89%8D%E6%98%AF%E6%89%A7%E8%A1%8C-sql-%E8%AF%AD%E5%8F%A5%E7%9A%84%E5%B9%95%E5%90%8E%E6%8E%A8%E6%89%8B%E4%B8%8B/">18 Executor æ‰æ˜¯æ‰§è¡Œ SQL è¯­å¥çš„å¹•åæ¨æ‰‹ï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/19-%E6%B7%B1%E5%85%A5-mybatis-%E5%86%85%E6%A0%B8%E4%B8%8E%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E7%9A%84%E6%A1%A5%E6%A2%81%E6%8E%A5%E5%8F%A3%E5%B1%82/">19 æ·±å…¥ MyBatis å†…æ ¸ä¸ä¸šåŠ¡é€»è¾‘çš„æ¡¥æ¢â€”â€”æ¥å£å±‚</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/20-%E6%8F%92%E4%BB%B6%E4%BD%93%E7%B3%BB%E8%AE%A9-mybatis-%E4%B8%96%E7%95%8C%E6%9B%B4%E5%8A%A0%E7%B2%BE%E5%BD%A9/">20 æ’ä»¶ä½“ç³»è®© MyBatis ä¸–ç•Œæ›´åŠ ç²¾å½©</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/21-%E6%B7%B1%E6%8C%96-mybatis-%E4%B8%8E-spring-%E9%9B%86%E6%88%90%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/">21 æ·±æŒ– MyBatis ä¸ Spring é›†æˆåº•å±‚åŸç†</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/22-%E5%9F%BA%E4%BA%8E-mybatis-%E7%9A%84%E8%A1%8D%E7%94%9F%E6%A1%86%E6%9E%B6%E4%B8%80%E8%A7%88/">22 åŸºäº MyBatis çš„è¡ç”Ÿæ¡†æ¶ä¸€è§ˆ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/23-%E7%BB%93%E6%9D%9F%E8%AF%AD-%E4%BC%9A%E4%BD%BF%E7%94%A8%E5%8F%AA%E8%83%BD%E9%BB%98%E9%BB%98%E6%90%AC%E7%A0%96%E6%87%82%E5%8E%9F%E7%90%86%E6%89%8D%E8%83%BD%E5%BF%AB%E9%80%9F%E6%99%8B%E5%8D%87/">23 ç»“æŸè¯­ ä¼šä½¿ç”¨åªèƒ½é»˜é»˜â€œæ¬ç –â€ï¼Œæ‡‚åŸç†æ‰èƒ½å¿«é€Ÿæ™‹å‡</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">11 é¸Ÿç° MyBatis åˆå§‹åŒ–ï¼ŒæŠŠæ¡ MyBatis å¯åŠ¨æµç¨‹è„‰ç»œï¼ˆä¸‹ï¼‰</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2021-12-22 01:51:13</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/mybatis/">mybatis</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/">æ·±å…¥å‰–æMyBatisæ ¸å¿ƒåŸç†</a>
                
            </div></div>
        <div class="post-content">
            <p>åœ¨ä¸Šä¸€è®²ï¼Œæˆ‘ä»¬æ·±å…¥åˆ†æäº†MyBatis åˆå§‹åŒ–è¿‡ç¨‹ä¸­å¯¹ mybatis-config.xml å…¨å±€é…ç½®æ–‡ä»¶çš„è§£æï¼Œè¯¦ç»†ä»‹ç»äº†å…¶ä¸­æ¯ä¸ªæ ‡ç­¾çš„è§£ææµç¨‹ä»¥åŠæ¶‰åŠçš„ç»å…¸è®¾è®¡æ¨¡å¼â€”â€”æ„é€ è€…æ¨¡å¼ã€‚è¿™ä¸€è®²æˆ‘ä»¬å°±ç´§æ¥ç€ä¸Šä¸€è®²çš„å†…å®¹ï¼Œç»§ç»­ä»‹ç» MyBatis åˆå§‹åŒ–æµç¨‹ï¼Œé‡ç‚¹ä»‹ç»Mapper.xml é…ç½®æ–‡ä»¶çš„è§£æä»¥åŠ SQL è¯­å¥çš„å¤„ç†é€»è¾‘ã€‚</p>
<h3 id="mapperxml-æ˜ å°„æ–‡ä»¶è§£æå…¨æµç¨‹">Mapper.xml æ˜ å°„æ–‡ä»¶è§£æå…¨æµç¨‹</h3>
<p>åœ¨ä¸Šä¸€è®²åˆ†æ mybatis-config.xml é…ç½®æ–‡ä»¶è§£ææµç¨‹çš„æ—¶å€™æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨ mybatis-config.xml é…ç½®æ–‡ä»¶ä¸­å¯ä»¥å®šä¹‰å¤šä¸ª <code>&lt;mapper&gt;</code> æ ‡ç­¾æŒ‡å®š Mapper é…ç½®æ–‡ä»¶çš„åœ°å€ï¼Œ<strong>MyBatis ä¼šä¸ºæ¯ä¸ª Mapper.xml æ˜ å°„æ–‡ä»¶åˆ›å»ºä¸€ä¸ª XMLMapperBuilder å®ä¾‹å®Œæˆè§£æ</strong>ã€‚</p>
<p>ä¸ XMLConfigBuilder ç±»ä¼¼ï¼ŒXMLMapperBuilderä¹Ÿæ˜¯å…·ä½“æ„é€ è€…çš„è§’è‰²ï¼Œç»§æ‰¿äº† BaseBuilder è¿™ä¸ªæŠ½è±¡ç±»ï¼Œè§£æ Mapper.xml æ˜ å°„æ–‡ä»¶çš„å…¥å£æ˜¯ XMLMapperBuilder.parse() æ–¹æ³•ï¼Œå…¶æ ¸å¿ƒæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ‰§è¡Œ configurationElement() æ–¹æ³•è§£ææ•´ä¸ªMapper.xml æ˜ å°„æ–‡ä»¶çš„å†…å®¹ï¼›</li>
<li>è·å–å½“å‰ Mapper.xml æ˜ å°„æ–‡ä»¶æŒ‡å®šçš„ Mapper æ¥å£ï¼Œå¹¶è¿›è¡Œæ³¨å†Œï¼›</li>
<li>å¤„ç† configurationElement() æ–¹æ³•ä¸­è§£æå¤±è´¥çš„ <code>&lt;resultMap&gt;</code> æ ‡ç­¾ï¼›</li>
<li>å¤„ç† configurationElement() æ–¹æ³•ä¸­è§£æå¤±è´¥çš„ <code>&lt;cache-ref&gt;</code> æ ‡ç­¾ï¼›</li>
<li>å¤„ç† configurationElement() æ–¹æ³•ä¸­è§£æå¤±è´¥çš„SQL è¯­å¥æ ‡ç­¾ã€‚</li>
</ul>
<p>å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ï¼Œ<strong>configurationElement() æ–¹æ³•æ‰æ˜¯çœŸæ­£è§£æ Mapper.xml æ˜ å°„æ–‡ä»¶çš„åœ°æ–¹</strong>ï¼Œå…¶ä¸­å®šä¹‰äº†å¤„ç† Mapper.xml æ˜ å°„æ–‡ä»¶çš„æ ¸å¿ƒæµç¨‹ï¼š</p>
<ul>
<li>è·å– <code>&lt;mapper&gt;</code> æ ‡ç­¾ä¸­çš„ namespace å±æ€§ï¼ŒåŒæ—¶ä¼šè¿›è¡Œå¤šç§è¾¹ç•Œæ£€æŸ¥ï¼›</li>
<li>è§£æ <code>&lt;cache&gt;</code> æ ‡ç­¾ï¼›</li>
<li>è§£æ <code>&lt;cache-ref&gt;</code> æ ‡ç­¾ï¼›</li>
<li>è§£æ <code>&lt;resultMap&gt;</code> æ ‡ç­¾ï¼›</li>
<li>è§£æ <code>&lt;sql&gt;</code> æ ‡ç­¾ï¼›</li>
<li>è§£æ <code>&lt;select&gt;</code>ã€<code>&lt;insert&gt;</code>ã€<code>&lt;update&gt;</code>ã€<code>&lt;delete&gt;</code> ç­‰ SQL æ ‡ç­¾ã€‚</li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬å°±æŒ‰ç…§é¡ºåºé€ä¸€ä»‹ç»è¿™äº›æ–¹æ³•çš„æ ¸å¿ƒå®ç°ã€‚</p>
<h4 id="1-å¤„ç†-cache-æ ‡ç­¾">1. å¤„ç† <code>&lt;cache&gt;</code> æ ‡ç­¾</h4>
<p>æˆ‘ä»¬çŸ¥é“ Cache æ¥å£åŠå…¶å®ç°æ˜¯MyBatis ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜çš„åŸºç¡€ï¼Œå…¶ä¸­ï¼Œä¸€çº§ç¼“å­˜æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œè€ŒäºŒçº§ç¼“å­˜é»˜è®¤æƒ…å†µä¸‹å¹¶æ²¡æœ‰å¼€å¯ï¼Œå¦‚æœ‰éœ€è¦ï¼Œ<strong>å¯ä»¥é€šè¿‡æ ‡ç­¾ä¸ºæŒ‡å®šçš„namespace å¼€å¯äºŒçº§ç¼“å­˜</strong>ã€‚</p>
<p>XMLMapperBuilder ä¸­è§£æ <code>&lt;cache&gt;</code> æ ‡ç­¾çš„<strong>æ ¸å¿ƒé€»è¾‘ä½äº cacheElement() æ–¹æ³•</strong>ä¹‹ä¸­ï¼Œå…¶å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li>è·å– <code>&lt;cache&gt;</code> æ ‡ç­¾ä¸­çš„å„é¡¹å±æ€§ï¼ˆtypeã€flushIntervalã€size ç­‰å±æ€§ï¼‰ï¼›</li>
<li>è¯»å– <code>&lt;cache&gt;</code> æ ‡ç­¾ä¸‹çš„å­æ ‡ç­¾ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å°†ç”¨äºåˆå§‹åŒ–äºŒçº§ç¼“å­˜ï¼›</li>
<li>MapperBuilderAssistant ä¼šæ ¹æ®ä¸Šè¿°é…ç½®ä¿¡æ¯ï¼Œåˆ›å»ºä¸€ä¸ªå…¨æ–°çš„Cache å¯¹è±¡å¹¶æ·»åŠ åˆ° Configuration.caches é›†åˆä¸­ä¿å­˜ã€‚</li>
</ul>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè§£æ <code>&lt;cache&gt;</code> æ ‡ç­¾å¾—åˆ°çš„æ‰€æœ‰ä¿¡æ¯å°†ä¼šä¼ ç»™ MapperBuilderAssistant å®Œæˆ Cache å¯¹è±¡çš„åˆ›å»ºï¼Œåˆ›å»ºå¥½çš„Cache å¯¹è±¡ä¼šæ·»åŠ åˆ° Configuration.caches é›†åˆä¸­ï¼Œ<strong>è¿™ä¸ª caches å­—æ®µæ˜¯ä¸€ä¸ªStrictMap ç±»å‹çš„é›†åˆ</strong>ï¼Œå…¶ä¸­çš„ Keyæ˜¯Cache å¯¹è±¡çš„å”¯ä¸€æ ‡è¯†ï¼Œé»˜è®¤å€¼æ˜¯Mapper.xml æ˜ å°„æ–‡ä»¶çš„namespaceï¼ŒValue æ‰æ˜¯çœŸæ­£çš„äºŒçº§ç¼“å­˜å¯¹åº”çš„ Cache å¯¹è±¡ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬ç®€å•ä»‹ç»ä¸€ä¸‹ StrictMapçš„ç‰¹æ€§ã€‚</p>
<p>StrictMap ç»§æ‰¿äº† HashMapï¼Œå¹¶ä¸”è¦†ç›–äº† HashMap çš„ä¸€äº›è¡Œä¸ºï¼Œä¾‹å¦‚ï¼Œç›¸è¾ƒäº HashMap çš„ put() æ–¹æ³•ï¼ŒStrictMap çš„ put() æ–¹æ³•æœ‰å¦‚ä¸‹å‡ ç‚¹ä¸åŒï¼š</p>
<ul>
<li>å¦‚æœæ£€æµ‹åˆ°é‡å¤ Key çš„å†™å…¥ï¼Œä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼›</li>
<li>åœ¨æ²¡æœ‰é‡å¤ Keyçš„æƒ…å†µä¸‹ï¼Œä¼šæ­£å¸¸å†™å…¥ KV æ•°æ®ï¼Œä¸æ­¤åŒæ—¶ï¼Œè¿˜ä¼šæ ¹æ® Keyäº§ç”Ÿä¸€ä¸ª shortKeyï¼ŒshortKey ä¸å®Œæ•´ Key æŒ‡å‘åŒä¸€ä¸ª Value å€¼ï¼›</li>
<li>å¦‚æœ shortKey å·²ç»å­˜åœ¨ï¼Œåˆ™å°† value ä¿®æ”¹æˆ Ambiguity å¯¹è±¡ï¼ŒAmbiguity å¯¹è±¡è¡¨ç¤ºè¿™ä¸ª shortKey å­˜åœ¨äºŒä¹‰æ€§ï¼Œåç»­é€šè¿‡ StrictMapçš„get() æ–¹æ³•è·å–è¯¥ shortKey çš„æ—¶å€™ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</li>
</ul>
<p>äº†è§£äº† StrictMap è¿™ä¸ªé›†åˆç±»çš„ç‰¹æ€§ä¹‹åï¼Œæˆ‘ä»¬å›åˆ°MapperBuilderAssistant è¿™ä¸ªç±»ç»§ç»­åˆ†æï¼Œåœ¨å®ƒçš„ useNewCache() æ–¹æ³•ä¸­ï¼Œä¼šæ ¹æ®å‰é¢è§£æå¾—åˆ°çš„é…ç½®ä¿¡æ¯ï¼Œé€šè¿‡ CacheBuilder åˆ›å»º Cache å¯¹è±¡ã€‚</p>
<p>é€šè¿‡åå­—ä½ å°±èƒ½çŒœæµ‹åˆ° CacheBuilder æ˜¯ Cache çš„æ„é€ è€…ï¼Œ<strong>CacheBuilder ä¸­æœ€æ ¸å¿ƒçš„æ–¹æ³•æ˜¯build() æ–¹æ³•ï¼Œå…¶ä¸­ä¼šæ ¹æ®ä¼ å…¥çš„é…ç½®ä¿¡æ¯åˆ›å»ºåº•å±‚å­˜å‚¨æ•°æ®çš„ Cache å¯¹è±¡ä»¥åŠç›¸å…³çš„ Cache è£…é¥°å™¨</strong>ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>public Cache build() {

    // å°†implementationé»˜è®¤å€¼è®¾ç½®ä¸ºPerpetualCacheï¼Œåœ¨decoratorsé›†åˆä¸­é»˜è®¤æ·»åŠ LruCacheè£…é¥°å™¨ï¼Œ

    // éƒ½æ˜¯åœ¨setDefaultImplementations()æ–¹æ³•ä¸­å®Œæˆçš„

    setDefaultImplementations();

    // é€šè¿‡åå°„ï¼Œåˆå§‹åŒ–implementationæŒ‡å®šç±»å‹çš„å¯¹è±¡

    Cache cache = newBaseCacheInstance(implementation, id);

    // åˆ›å»ºCacheå…³è”çš„MetaObjectå¯¹è±¡ï¼Œå¹¶æ ¹æ®propertiesè®¾ç½®Cacheä¸­çš„å„ä¸ªå­—æ®µ

    setCacheProperties(cache);

    // æ ¹æ®ä¸Šé¢åˆ›å»ºçš„Cacheå¯¹è±¡ç±»å‹ï¼Œå†³å®šæ˜¯å¦æ·»åŠ è£…é¥°å™¨

    if (PerpetualCache.class.equals(cache.getClass())) {

        // å¦‚æœæ˜¯PerpetualCacheç±»å‹ï¼Œåˆ™ä¸ºå…¶æ·»åŠ decoratorsé›†åˆä¸­æŒ‡å®šçš„è£…é¥°å™¨

        for (Class&lt;? extends Cache&gt; decorator : decorators) {

            // é€šè¿‡åå°„åˆ›å»ºCacheè£…é¥°å™¨

            cache = newCacheDecoratorInstance(decorator, cache);

            // ä¾èµ–MetaObjectå°†propertiesä¸­é…ç½®ä¿¡æ¯è®¾ç½®åˆ°Cacheçš„å„ä¸ªå±æ€§ä¸­ï¼ŒåŒæ—¶è°ƒç”¨Cacheçš„initialize()æ–¹æ³•å®Œæˆåˆå§‹åŒ–

            setCacheProperties(cache);

        }

        // æ ¹æ®readWriteã€blockingã€clearIntervalç­‰é…ç½®ï¼Œ

        // æ·»åŠ SerializedCacheã€ScheduledCacheç­‰è£…é¥°å™¨

        cache = setStandardDecorators(cache);

    } else if (!LoggingCache.class.isAssignableFrom(cache.getClass())) {

        // å¦‚æœä¸æ˜¯PerpetualCacheç±»å‹ï¼Œå°±æ˜¯å…¶ä»–è‡ªå®šä¹‰ç±»å‹çš„Cacheï¼Œåˆ™æ·»åŠ ä¸€ä¸ªLoggingCacheè£…é¥°å™¨

        cache = new LoggingCache(cache);

    }

    return cache;

}
</code></pre><h4 id="2-å¤„ç†cache-refæ ‡ç­¾">2. å¤„ç†<code>&lt;cache-ref&gt;</code>æ ‡ç­¾</h4>
<p>é€šè¿‡ä¸Šè¿°ä»‹ç»æˆ‘ä»¬çŸ¥é“ï¼Œå¯ä»¥é€šè¿‡ <code>&lt;cache&gt;</code> æ ‡ç­¾ä¸ºæ¯ä¸ª namespace å¼€å¯äºŒçº§ç¼“å­˜ï¼ŒåŒæ—¶è¿˜ä¼šå°† namespace ä¸å…³è”çš„äºŒçº§ç¼“å­˜ Cacheå¯¹è±¡è®°å½•åˆ° Configuration.caches é›†åˆä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´äºŒçº§ç¼“å­˜æ˜¯ namespace çº§åˆ«çš„ã€‚ä½†æ˜¯ï¼Œåœ¨æœ‰çš„åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ä¼šéœ€è¦åœ¨å¤šä¸ª namespace å…±äº«åŒä¸€ä¸ªäºŒçº§ç¼“å­˜ï¼Œä¹Ÿå°±æ˜¯<strong>å…±äº«åŒä¸€ä¸ª Cache å¯¹è±¡</strong>ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªéœ€æ±‚ï¼ŒMyBatisæä¾›äº† <code>&lt;cache-ref&gt;</code> æ ‡ç­¾æ¥å¼•ç”¨å¦ä¸€ä¸ª namespace çš„äºŒçº§ç¼“å­˜ã€‚cacheRefElement() æ–¹æ³•æ˜¯å¤„ç† <code>&lt;cache-ref&gt;</code> æ ‡ç­¾çš„æ ¸å¿ƒé€»è¾‘æ‰€åœ¨ï¼Œåœ¨ Configuration ä¸­ç»´æŠ¤äº†ä¸€ä¸ª cacheRefMap å­—æ®µï¼ˆHashMap&lt;String,String&gt; ç±»å‹ï¼‰ï¼Œå…¶ä¸­çš„ Key æ˜¯ <code>&lt;cache-ref&gt;</code> æ ‡ç­¾æ‰€å±çš„namespace æ ‡è¯†ï¼ŒValue å€¼æ˜¯ <code>&lt;cache-ref&gt;</code> æ ‡ç­¾å¼•ç”¨çš„ namespace å€¼ï¼Œè¿™æ ·çš„è¯ï¼Œå°±å¯ä»¥å°†ä¸¤ä¸ªnamespace å…³è”èµ·æ¥äº†ï¼Œå³è¿™ä¸¤ä¸ª namespace å…±ç”¨ä¸€ä¸ª Cacheå¯¹è±¡ã€‚</p>
<p>è¿™é‡Œä¼šä½¿ç”¨åˆ°ä¸€ä¸ªå« CacheRefResolver çš„ Cache å¼•ç”¨è§£æå™¨ã€‚<strong>CacheRefResolver ä¸­è®°å½•äº†è¢«å¼•ç”¨çš„ namespaceä»¥åŠå½“å‰ namespace å…³è”çš„MapperBuilderAssistant å¯¹è±¡</strong>ã€‚å‰é¢åœ¨è§£æ <code>&lt;cache&gt;</code>æ ‡ç­¾çš„æ—¶å€™æˆ‘ä»¬ä»‹ç»è¿‡ï¼ŒMapperBuilderAssistant ä¼šåœ¨ useNewCache() æ–¹æ³•ä¸­é€šè¿‡ CacheBuilder åˆ›å»ºæ–°çš„ Cache å¯¹è±¡ï¼Œå¹¶è®°å½•åˆ° currentCache å­—æ®µã€‚è€Œè¿™é‡Œè§£æ <code>&lt;cache-ref&gt;</code> æ ‡ç­¾çš„æ—¶å€™ï¼ŒMapperBuilderAssistant ä¼šé€šè¿‡ useCacheRef() æ–¹æ³•ä» Configuration.caches é›†åˆä¸­ï¼Œæ ¹æ®è¢«å¼•ç”¨çš„namespace æŸ¥æ‰¾å…±äº«çš„ Cache å¯¹è±¡æ¥åˆå§‹åŒ– currentCacheï¼Œè€Œä¸å†åˆ›å»ºæ–°çš„Cache å¯¹è±¡ï¼Œä»è€Œå®ç°äºŒçº§ç¼“å­˜çš„å…±äº«ã€‚</p>
<h4 id="3-å¤„ç†resultmapæ ‡ç­¾">3. å¤„ç†<code>&lt;resultMap&gt;</code>æ ‡ç­¾</h4>
<p>æœ‰å…³ç³»å‹æ•°æ®åº“ä½¿ç”¨ç»éªŒçš„åŒå­¦åº”è¯¥çŸ¥é“ï¼Œselect è¯­å¥æ‰§è¡Œå¾—åˆ°çš„ç»“æœé›†å®é™…ä¸Šæ˜¯ä¸€å¼ äºŒç»´è¡¨ï¼Œè€Œ Java æ˜¯ä¸€é—¨é¢å‘å¯¹è±¡çš„ç¨‹åºè®¾è®¡è¯­è¨€ï¼Œåœ¨ä½¿ç”¨ JDBC çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å†™ä»£ç å°†select è¯­å¥çš„ç»“æœé›†è½¬æ¢æˆ Java å¯¹è±¡ï¼Œè¿™æ˜¯ä¸€é¡¹é‡å¤æ€§å¾ˆå¤§çš„æ“ä½œã€‚</p>
<p><strong>ä¸ºäº†å°† Java å¼€å‘è€…ä»è¿™ç§é‡å¤æ€§çš„å·¥ä½œä¸­è§£è„±å‡ºæ¥ï¼ŒMyBatis æä¾›äº† æ ‡ç­¾æ¥å®šä¹‰ç»“æœé›†ä¸ Java å¯¹è±¡ä¹‹é—´çš„æ˜ å°„è§„åˆ™ã€‚</strong></p>
<p>é¦–å…ˆï¼Œ<code>&lt;resultMap&gt;</code> æ ‡ç­¾ä¸‹çš„æ¯ä¸€ä¸ªå­æ ‡ç­¾ï¼Œä¾‹å¦‚ï¼Œ<code>&lt;column&gt;</code>ã€<code>&lt;id&gt;</code> ç­‰ï¼Œéƒ½è¢«è§£æä¸€ä¸ª ResultMapping å¯¹è±¡ï¼Œå…¶ä¸­ç»´æŠ¤äº†æ•°æ®åº“è¡¨ä¸­ä¸€ä¸ªåˆ—ä¸å¯¹åº” Java ç±»ä¸­ä¸€ä¸ªå±æ€§ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚</p>
<p>ä¸‹é¢æ˜¯ ResultMapping ä¸­æ ¸å¿ƒå­—æ®µçš„å«ä¹‰ã€‚</p>
<ul>
<li>columnï¼ˆString ç±»å‹ï¼‰ï¼šå½“å‰æ ‡ç­¾ä¸­æŒ‡å®šçš„ column å±æ€§å€¼ï¼ŒæŒ‡å‘çš„æ˜¯æ•°æ®åº“è¡¨ä¸­çš„ä¸€ä¸ªåˆ—åï¼ˆæˆ–æ˜¯åˆ«åï¼‰ã€‚</li>
<li>propertyï¼ˆString ç±»å‹ï¼‰ï¼šå½“å‰æ ‡ç­¾ä¸­æŒ‡å®šçš„ property å±æ€§å€¼ï¼ŒæŒ‡å‘çš„æ˜¯ä¸ column åˆ—å¯¹åº”çš„å±æ€§åç§°ã€‚</li>
<li>javaTypeï¼ˆClass&lt;?&gt; ç±»å‹ï¼‰ã€jdbcTypeï¼ˆJdbcType ç±»å‹ï¼‰ï¼šå½“å‰æ ‡ç­¾æŒ‡å®šçš„ javaType å±æ€§å€¼å’Œ jdbcType å±æ€§å€¼ï¼ŒæŒ‡å®šäº† property å­—æ®µçš„ Java ç±»å‹ä»¥åŠå¯¹åº”åˆ—çš„ JDBC ç±»å‹ã€‚</li>
<li>typeHandlerï¼ˆTypeHandler&lt;?&gt; ç±»å‹ï¼‰ï¼šå½“å‰æ ‡ç­¾çš„ typeHandler å±æ€§å€¼ï¼Œè¿™é‡ŒæŒ‡å®šçš„ TypeHandler ä¼šè¦†ç›–é»˜è®¤çš„ç±»å‹å¤„ç†å™¨ã€‚</li>
<li>nestedResultMapIdï¼ˆStringç±»å‹ï¼‰ï¼šå½“å‰æ ‡ç­¾çš„ resultMap å±æ€§å€¼ï¼Œé€šè¿‡è¯¥å±æ€§æˆ‘ä»¬å¯ä»¥å¼•ç”¨å¦ä¸€ä¸ª <code>&lt;resultMap&gt;</code> æ ‡ç­¾çš„idï¼Œç„¶åç”±è¿™ä¸ªè¢«å¼•ç”¨çš„<code>&lt;resultMap&gt;</code> æ ‡ç­¾æ˜ å°„ç»“æœé›†ä¸­çš„ä¸€éƒ¨åˆ†åˆ—ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†ä¸€ä¸ªæŸ¥è¯¢ç»“æœé›†æ˜ å°„æˆå¤šä¸ªå¯¹è±¡ï¼ŒåŒæ—¶ç¡®å®šè¿™äº›å¯¹è±¡ä¹‹é—´çš„å…³è”å…³ç³»ã€‚</li>
<li>nestedQueryIdï¼ˆString ç±»å‹ï¼‰ï¼šå½“å‰æ ‡ç­¾çš„select å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯¥å±æ€§å¼•ç”¨å¦ä¸€ä¸ª <code>&lt;select&gt;</code> æ ‡ç­¾ä¸­çš„select è¯­å¥å®šä¹‰ï¼Œå®ƒä¼šå°†å½“å‰åˆ—çš„å€¼ä½œä¸ºå‚æ•°ä¼ å…¥è¿™ä¸ª select è¯­å¥ã€‚ç”±äºå½“å‰ç»“æœé›†å¯èƒ½æŸ¥è¯¢å‡ºå¤šè¡Œæ•°æ®ï¼Œé‚£ä¹ˆå¯èƒ½å°±ä¼šå¯¼è‡´ select å±æ€§æŒ‡å®šçš„ SQL è¯­å¥ä¼šæ‰§è¡Œå¤šæ¬¡ï¼Œä¹Ÿå°±æ˜¯è‘—åçš„ N+1 é—®é¢˜ã€‚</li>
<li>columnPrefixï¼ˆString ç±»å‹ï¼‰ï¼šå½“å‰æ ‡ç­¾çš„ columnPrefix å±æ€§å€¼ï¼Œè®°å½•äº†è¡¨ä¸­åˆ—åçš„å…¬å…±å‰ç¼€ã€‚</li>
<li>resultSetï¼ˆString ç±»å‹ï¼‰ï¼šå½“å‰æ ‡ç­¾çš„ resultSet å±æ€§å€¼ã€‚</li>
<li>lazyï¼ˆboolean ç±»å‹ï¼‰ï¼šå½“å‰æ ‡ç­¾çš„fetchType å±æ€§ï¼Œè¡¨ç¤ºæ˜¯å¦å»¶è¿ŸåŠ è½½å½“å‰æ ‡ç­¾å¯¹åº”çš„åˆ—ã€‚</li>
</ul>
<p>ä»‹ç»å®Œ ResultMapping å¯¹è±¡ï¼ˆå³<code>&lt;resultMap&gt;</code> æ ‡ç­¾ä¸‹å„ä¸ªå­æ ‡ç­¾çš„è§£æç»“æœï¼‰ä¹‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹<code>&lt;resultMap&gt;</code> æ ‡ç­¾å¦‚ä½•è¢«è§£æã€‚æ•´ä¸ª <code>&lt;resultMap&gt;</code> æ ‡ç­¾æœ€ç»ˆä¼šè¢«è§£ææˆ ResultMap å¯¹è±¡ï¼Œå®ƒä¸ ResultMapping ä¹‹é—´çš„æ˜ å°„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%20MyBatis%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86-%E5%AE%8C/assets/CioPOWA7kqSASvnUAAPk5cQ7q3c025.png" alt="å›¾ç‰‡1.png"></p>
<p>ResultMap ç»“æ„å›¾</p>
<p>é€šè¿‡ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒResultMap ä¸­æœ‰å››ä¸ªé›†åˆä¸ ResultMapping ç´§å¯†ç›¸è¿ã€‚</p>
<ul>
<li>resultMappings é›†åˆï¼Œç»´æŠ¤äº†æ•´ä¸ª<code>&lt;resultMap&gt;</code> æ ‡ç­¾è§£æä¹‹åå¾—åˆ°çš„å…¨éƒ¨æ˜ å°„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯å…¨éƒ¨ ResultMapping å¯¹è±¡ã€‚</li>
<li>idResultMappings é›†åˆï¼Œç»´æŠ¤äº†ä¸å”¯ä¸€æ ‡è¯†ç›¸å…³çš„æ˜ å°„ï¼Œä¾‹å¦‚ï¼Œ<code>&lt;id&gt;</code> æ ‡ç­¾ã€<code>&lt;constructor&gt;</code> æ ‡ç­¾ä¸‹çš„ <code>&lt;idArg&gt;</code> å­æ ‡ç­¾è§£æå¾—åˆ°çš„ ResultMapping å¯¹è±¡ã€‚å¦‚æœæ²¡æœ‰å®šä¹‰ <code>&lt;id&gt;</code> ç­‰å”¯ä¸€æ€§æ ‡ç­¾ï¼Œåˆ™ç”± resultMappings é›†åˆä¸­å…¨éƒ¨æ˜ å°„å…³ç³»æ¥ç¡®å®šä¸€æ¡è®°å½•çš„å”¯ä¸€æ€§ï¼Œå³ idResultMappings é›†åˆä¸ resulMappings é›†åˆç›¸åŒã€‚</li>
<li>constructorResultMappings é›†åˆï¼Œç»´æŠ¤äº† <code>&lt;constructor&gt;</code> æ ‡ç­¾ä¸‹å…¨éƒ¨å­æ ‡ç­¾å®šä¹‰çš„æ˜ å°„å…³ç³»ã€‚</li>
<li>propertyResultMappings é›†åˆï¼Œç»´æŠ¤äº†ä¸å¸¦ Constructor æ ‡å¿—çš„æ˜ å°„å…³ç³»ã€‚</li>
</ul>
<p>é™¤äº†ä¸Šè¿°å››ä¸ª ResultMapping é›†åˆï¼ŒResultMap ä¸­è¿˜ç»´æŠ¤äº†ä¸‹åˆ—æ ¸å¿ƒå­—æ®µã€‚</p>
<ul>
<li>idï¼ˆString ç±»å‹ï¼‰ï¼šå½“å‰ <code>&lt;resultMap&gt;</code> æ ‡ç­¾çš„ id å±æ€§å€¼ã€‚</li>
<li>typeï¼ˆClass ç±»å‹ï¼‰ï¼šå½“å‰ <code>&lt;resultMap&gt;</code> çš„ type å±æ€§å€¼ã€‚</li>
<li>mappedColumnsï¼ˆSet<code>&lt;String&gt;</code> ç±»å‹ï¼‰ï¼šç»´æŠ¤äº†æ‰€æœ‰æ˜ å°„å…³ç³»ä¸­æ¶‰åŠçš„ column å±æ€§å€¼ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰çš„åˆ—åï¼ˆæˆ–åˆ«åï¼‰ã€‚</li>
<li>hasNestedResultMapsï¼ˆboolean ç±»å‹ï¼‰ï¼šå½“å‰ <code>&lt;resultMap&gt;</code> æ ‡ç­¾æ˜¯å¦åµŒå¥—äº†å…¶ä»– <code>&lt;resultMap&gt;</code> æ ‡ç­¾ï¼Œå³è¿™ä¸ªæ˜ å°„å…³ç³»ä¸­æŒ‡å®šäº† resultMapå±æ€§ï¼Œä¸”æœªæŒ‡å®š resultSet å±æ€§ã€‚</li>
<li>hasNestedQueriesï¼ˆboolean ç±»å‹ï¼‰ï¼šå½“å‰ <code>&lt;resultMap&gt;</code> æ ‡ç­¾æ˜¯å¦å«æœ‰åµŒå¥—æŸ¥è¯¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªæ˜ å°„å…³ç³»ä¸­æ˜¯å¦æŒ‡å®šäº† select å±æ€§ã€‚</li>
<li>autoMappingï¼ˆBoolean ç±»å‹ï¼‰ï¼šå½“å‰ ResultMap æ˜¯å¦å¼€å¯è‡ªåŠ¨æ˜ å°„çš„åŠŸèƒ½ã€‚</li>
<li>discriminatorï¼ˆDiscriminator ç±»å‹ï¼‰ï¼šå¯¹åº” <code>&lt;discriminator&gt;</code> æ ‡ç­¾ã€‚</li>
</ul>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹æ·±å…¥åˆ†æ <code>&lt;resultMap&gt;</code> æ ‡ç­¾è§£æçš„æµç¨‹ã€‚XMLMapperBuilderçš„resultMapElements() æ–¹æ³•è´Ÿè´£è§£æ Mapper é…ç½®æ–‡ä»¶ä¸­çš„å…¨éƒ¨ <code>&lt;resultMap&gt;</code> æ ‡ç­¾ï¼Œå…¶ä¸­ä¼šé€šè¿‡ resultMapElement() æ–¹æ³•è§£æå•ä¸ª <code>&lt;resultMap&gt;</code> æ ‡ç­¾ã€‚</p>
<p>ä¸‹é¢æ˜¯ resultMapElement() æ–¹æ³•è§£æ <code>&lt;resultMap&gt;</code> æ ‡ç­¾çš„æ ¸å¿ƒæµç¨‹ã€‚</p>
<ul>
<li>è·å– <code>&lt;resultMap&gt;</code> æ ‡ç­¾çš„type å±æ€§å€¼ï¼Œè¿™ä¸ªå€¼è¡¨ç¤ºç»“æœé›†å°†è¢«æ˜ å°„æˆ type æŒ‡å®šç±»å‹çš„å¯¹è±¡ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®š type å±æ€§çš„è¯ï¼Œä¼šæ‰¾å…¶ä»–å±æ€§å€¼ï¼Œä¼˜å…ˆçº§ä¾æ¬¡æ˜¯ï¼štypeã€ofTypeã€resultTypeã€javaTypeã€‚åœ¨è¿™ä¸€æ­¥ä¸­ä¼šç¡®å®šæ˜ å°„å¾—åˆ°çš„å¯¹è±¡ç±»å‹ï¼Œè¿™é‡Œæ”¯æŒåˆ«åè½¬æ¢ã€‚</li>
<li>è§£æ<code>&lt;resultMap&gt;</code>æ ‡ç­¾ä¸‹çš„å„ä¸ªå­æ ‡ç­¾ï¼Œæ¯ä¸ªå­æ ‡ç­¾éƒ½ä¼šç”Ÿæˆä¸€ä¸ªResultMapping å¯¹è±¡ï¼Œè¿™ä¸ª ResultMapping å¯¹è±¡ä¼šè¢«æ·»åŠ åˆ°resultMappings é›†åˆï¼ˆList<code>&lt;ResultMapping&gt;</code> ç±»å‹ï¼‰ä¸­æš‚å­˜ã€‚è¿™é‡Œä¼šæ¶‰åŠ <code>&lt;id&gt;</code>ã€<code>&lt;result&gt;</code>ã€<code>&lt;association&gt;</code>ã€<code>&lt;collection&gt;</code>ã€<code>&lt;discriminator&gt;</code> ç­‰å­æ ‡ç­¾çš„è§£æã€‚</li>
<li>è·å– <code>&lt;resultMap&gt;</code> æ ‡ç­¾çš„id å±æ€§ï¼Œé»˜è®¤å€¼ä¼šæ‹¼è£…æ‰€æœ‰çˆ¶æ ‡ç­¾çš„idã€value æˆ– property å±æ€§å€¼ã€‚</li>
<li>è·å– <code>&lt;resultMap&gt;</code> æ ‡ç­¾çš„extendsã€autoMapping ç­‰å±æ€§ã€‚</li>
<li>åˆ›å»º ResultMapResolver å¯¹è±¡ï¼ŒResultMapResolver ä¼šæ ¹æ®ä¸Šé¢è§£æåˆ°çš„ResultMappings é›†åˆä»¥åŠ <code>&lt;resultMap&gt;</code> æ ‡ç­¾çš„å±æ€§æ„é€  ResultMap å¯¹è±¡ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° Configuration.resultMaps é›†åˆï¼ˆStrictMap ç±»å‹ï¼‰ä¸­ã€‚</li>
</ul>
<h5 id="1è§£æ-idresultconstructoræ ‡ç­¾">ï¼ˆ1ï¼‰è§£æ <code>&lt;id&gt;</code>ã€<code>&lt;result&gt;</code>ã€<code>&lt;constructor&gt;</code>æ ‡ç­¾</h5>
<p>åœ¨ resultMapElement() æ–¹æ³•ä¸­è·å–åˆ° id å±æ€§å’Œ type å±æ€§å€¼ä¹‹åï¼Œä¼šè°ƒç”¨ buildResultMappingFromContext() æ–¹æ³•è§£æä¸Šè¿°æ ‡ç­¾å¾—åˆ° ResultMapping å¯¹è±¡ï¼Œå…¶æ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼š</p>
<ul>
<li>è·å–å½“å‰æ ‡ç­¾çš„propertyçš„å±æ€§å€¼ä½œä¸ºç›®æ ‡å±æ€§åç§°ï¼ˆå¦‚æœ <code>&lt;constructor&gt;</code> æ ‡ç­¾ä½¿ç”¨çš„æ˜¯ name å±æ€§ï¼‰ï¼›</li>
<li>è·å– columnã€javaTypeã€typeHandlerã€jdbcTypeã€select ç­‰ä¸€ç³»åˆ—å±æ€§ï¼Œä¸è·å– property å±æ€§çš„æ–¹å¼ç±»ä¼¼ï¼›</li>
<li>æ ¹æ®ä¸Šé¢è§£æåˆ°çš„ä¿¡æ¯ï¼Œè°ƒç”¨ MapperBuilderAssistant.buildResultMapping() æ–¹æ³•åˆ›å»º ResultMapping å¯¹è±¡ã€‚</li>
</ul>
<p>æ­£å¦‚ resultMapElement() æ–¹æ³•æ ¸å¿ƒæ­¥éª¤æè¿°çš„é‚£æ ·ï¼Œç»è¿‡è§£æå¾—åˆ° ResultMapping å¯¹è±¡é›†åˆä¹‹åï¼Œä¼šè®°å½•åˆ°resultMappings è¿™ä¸ªä¸´æ—¶é›†åˆä¸­ï¼Œç„¶åç”± ResultMapResolver è°ƒç”¨ MapperBuilderAssistant.addResultMap() æ–¹æ³•åˆ›å»º ResultMap å¯¹è±¡ï¼Œå°†resultMappings é›†åˆä¸­çš„å…¨éƒ¨ ResultMapping å¯¹è±¡æ·»åŠ åˆ°å…¶ä¸­ï¼Œç„¶åå°†ResultMap å¯¹è±¡è®°å½•åˆ° Configuration.resultMaps é›†åˆä¸­ã€‚</p>
<p>ä¸‹é¢æ˜¯ MapperBuilderAssistant.addResultMap() çš„å…·ä½“å®ç°ï¼š</p>
<pre tabindex="0"><code>public ResultMap addResultMap(

        String id,

        Class&lt;?&gt; type,

        String extend,

        Discriminator discriminator,

        List&lt;ResultMapping&gt; resultMappings,

        Boolean autoMapping) {

    // ResultMapçš„å®Œæ•´idæ˜¯&quot;namespace.id&quot;çš„æ ¼å¼

    id = applyCurrentNamespace(id, false);

    // è·å–è¢«ç»§æ‰¿çš„ResultMapçš„å®Œæ•´idï¼Œä¹Ÿå°±æ˜¯çˆ¶ResultMapå¯¹è±¡çš„å®Œæ•´id

    extend = applyCurrentNamespace(extend, true);

    if (extend != null) {  // é’ˆå¯¹extendå±æ€§çš„å¤„ç†

        // æ£€æµ‹Configuration.resultMapsé›†åˆä¸­æ˜¯å¦å­˜åœ¨è¢«ç»§æ‰¿çš„ResultMapå¯¹è±¡

        if (!configuration.hasResultMap(extend)) {

            throw new IncompleteElementException(&quot;Could not find a parent resultmap with id '&quot; + extend + &quot;'&quot;);

        }

        // è·å–éœ€è¦è¢«ç»§æ‰¿çš„ResultMapå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯çˆ¶ResultMapå¯¹è±¡

        ResultMap resultMap = configuration.getResultMap(extend);

        // è·å–çˆ¶ResultMapå¯¹è±¡ä¸­è®°å½•çš„ResultMappingé›†åˆ

        List&lt;ResultMapping&gt; extendedResultMappings = new ArrayList&lt;&gt;(resultMap.getResultMappings());

        // åˆ é™¤éœ€è¦è¦†ç›–çš„ResultMappingé›†åˆ

        extendedResultMappings.removeAll(resultMappings);

        // å¦‚æœå½“å‰&lt;resultMap&gt;æ ‡ç­¾ä¸­å®šä¹‰äº†&lt;constructor&gt;æ ‡ç­¾ï¼Œåˆ™ä¸éœ€è¦ä½¿ç”¨çˆ¶ResultMapä¸­è®°å½•

        // çš„ç›¸åº”&lt;constructor&gt;æ ‡ç­¾ï¼Œè¿™é‡Œä¼šå°†å…¶å¯¹åº”çš„ResultMappingå¯¹è±¡åˆ é™¤

        boolean declaresConstructor = false;

        for (ResultMapping resultMapping : resultMappings) {

            if (resultMapping.getFlags().contains(ResultFlag.CONSTRUCTOR)) {

                declaresConstructor = true;

                break;

            }

        }

        if (declaresConstructor) {

            extendedResultMappings.removeIf(resultMapping -&gt; resultMapping.getFlags().contains(ResultFlag.CONSTRUCTOR));

        }

        // æ·»åŠ éœ€è¦è¢«ç»§æ‰¿ä¸‹æ¥çš„ResultMappingå¯¹è±¡è®°å½•åˆ°resultMappingsé›†åˆä¸­

        resultMappings.addAll(extendedResultMappings);

    }

    // åˆ›å»ºResultMapå¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°Configuration.resultMapsé›†åˆä¸­ä¿å­˜

    ResultMap resultMap = new ResultMap.Builder(configuration, id, type, resultMappings, autoMapping)

            .discriminator(discriminator)

            .build();

    configuration.addResultMap(resultMap);

    return resultMap;

}
</code></pre><p>è‡³äº <code>&lt;constructor&gt;</code> æ ‡ç­¾çš„æµç¨‹ï¼Œæ˜¯ç”±XMLMapperBuilder ä¸­çš„processConstructorElement() æ–¹æ³•å®ç°ï¼Œå…¶ä¸­ä¼šå…ˆè·å– <code>&lt;constructor&gt;</code> æ ‡ç­¾çš„å…¨éƒ¨å­æ ‡ç­¾ï¼Œç„¶åä¸ºæ¯ä¸ªæ ‡ç­¾æ·»åŠ  CONSTRUCTOR æ ‡å¿—ï¼ˆä¸ºæ¯ä¸ª<code>&lt;idArg&gt;</code> æ ‡ç­¾æ·»åŠ é¢å¤–çš„IDæ ‡å¿—ï¼‰ï¼Œæœ€åé€šè¿‡ buildResultMappingFromContext()æ–¹æ³•åˆ›å»º ResultMappingå¯¹è±¡å¹¶è®°å½•åˆ° resultMappings é›†åˆä¸­æš‚å­˜ï¼Œè¿™äº› ResultMapping å¯¹è±¡æœ€ç»ˆä¹Ÿä¼šæ·»åŠ åˆ°å‰é¢ä»‹ç»çš„ResultMap å¯¹è±¡ã€‚</p>
<h5 id="2è§£æ-association-å’Œ-collectionæ ‡ç­¾">ï¼ˆ2ï¼‰è§£æ <code>&lt;association&gt;</code> å’Œ <code>&lt;collection&gt;</code>æ ‡ç­¾</h5>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥ä»‹ç»è§£æ <code>&lt;association&gt;</code> å’Œ <code>&lt;collection&gt;</code>æ ‡ç­¾çš„æ ¸å¿ƒæµç¨‹ï¼Œä¸¤è€…è§£æçš„è¿‡ç¨‹åŸºæœ¬ä¸€è‡´ã€‚å‰é¢ä»‹ç»çš„ buildResultMappingFromContext() æ–¹æ³•ä¸ä»…å®Œæˆäº† <code>&lt;id&gt;</code>ã€<code>&lt;result&gt;</code> ç­‰æ ‡ç­¾çš„è§£æï¼Œè¿˜å®Œæˆäº† <code>&lt;association&gt;</code> å’Œ <code>&lt;collection&gt;</code> æ ‡ç­¾çš„è§£æï¼Œå…¶ä¸­ç›¸å…³çš„ä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>private ResultMapping buildResultMappingFromContext(XNode context, Class&lt;?&gt; resultType, List&lt;ResultFlag&gt; flags) {

    ... // &lt;association&gt;æ ‡ç­¾ä¸­å…¶ä»–å±æ€§çš„è§£æä¸&lt;result&gt;ã€&lt;id&gt;æ ‡ç­¾ç±»ä¼¼ï¼Œè¿™é‡Œä¸å†å±•å¼€

    // å¦‚æœ&lt;association&gt;æ ‡ç­¾æ²¡æœ‰æŒ‡å®šresultMapå±æ€§ï¼Œé‚£ä¹ˆå°±æ˜¯åŒ¿ååµŒå¥—æ˜ å°„ï¼Œéœ€è¦é€šè¿‡

    //  processNestedResultMappings()æ–¹æ³•è§£æè¯¥åŒ¿åçš„åµŒå¥—æ˜ å°„

    String nestedResultMap = context.getStringAttribute(&quot;resultMap&quot;, () -&gt;

            processNestedResultMappings(context, Collections.emptyList(), resultType));

    ... // &lt;association&gt;æ ‡ç­¾ä¸­å…¶ä»–å±æ€§çš„è§£æä¸&lt;result&gt;ã€&lt;id&gt;æ ‡ç­¾ç±»ä¼¼ï¼Œè¿™é‡Œä¸å†å±•å¼€

    // æ ¹æ®ä¸Šé¢è§£æåˆ°çš„å±æ€§å€¼ï¼Œåˆ›å»ºResultMappingå¯¹è±¡

    return builderAssistant.buildResultMapping(resultType, property, column, javaTypeClass, jdbcTypeEnum, nestedSelect, nestedResultMap, notNullColumn, columnPrefix, typeHandlerClass, flags, resultSet, foreignColumn, lazy);

}
</code></pre><p>è¿™é‡Œçš„ processNestedResultMappings() æ–¹æ³•ä¼šé€’å½’æ‰§è¡ŒresultMapElement() æ–¹æ³•è§£æ <code>&lt;association&gt;</code> æ ‡ç­¾å’Œ <code>&lt;collection&gt;</code> æ ‡ç­¾æŒ‡å®šçš„åŒ¿ååµŒå¥—æ˜ å°„ï¼Œå¾—åˆ°ä¸€ä¸ªå®Œæ•´çš„ResultMap å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°Configuration.resultMapsé›†åˆä¸­ã€‚</p>
<h5 id="3è§£æ-discriminator-æ ‡ç­¾">ï¼ˆ3ï¼‰è§£æ <code>&lt;discriminator&gt;</code> æ ‡ç­¾</h5>
<p>æœ€åä¸€ä¸ªè¦ä»‹ç»çš„æ˜¯ <code>&lt;discriminator&gt;</code> æ ‡ç­¾çš„è§£æè¿‡ç¨‹ï¼Œæˆ‘ä»¬å°† <code>&lt;discriminator&gt;</code> æ ‡ç­¾ä¸ <code>&lt;case&gt;</code> æ ‡ç­¾é…åˆä½¿ç”¨ï¼Œæ ¹æ®ç»“æœé›†ä¸­æŸåˆ—çš„å€¼æ”¹å˜æ˜ å°„è¡Œä¸ºã€‚ä» resultMapElement() æ–¹æ³•çš„é€»è¾‘æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œ<code>&lt;discriminator&gt;</code> æ ‡ç­¾æ˜¯ç”± processDiscriminatorElement() æ–¹æ³•ä¸“é—¨è¿›è¡Œè§£æçš„ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>private Discriminator processDiscriminatorElement(XNode context, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; resultMappings) {

    // ä»&lt;discriminator&gt;æ ‡ç­¾ä¸­è§£æcolumnã€javaTypeã€jdbcTypeã€typeHandlerå››ä¸ªå±æ€§çš„é€»è¾‘éå¸¸ç®€å•ï¼Œè¿™é‡Œå°†è¿™éƒ¨åˆ†ä»£ç çœç•¥

    Map&lt;String, String&gt; discriminatorMap = new HashMap&lt;&gt;();

    // è§£æ&lt;discriminator&gt;æ ‡ç­¾çš„&lt;case&gt;å­æ ‡ç­¾

    for (XNode caseChild : context.getChildren()) {

        String value = caseChild.getStringAttribute(&quot;value&quot;);

        // é€šè¿‡å‰é¢ä»‹ç»çš„processNestedResultMappings()æ–¹æ³•ï¼Œè§£æ&lt;case&gt;æ ‡ç­¾ï¼Œ

        // åˆ›å»ºç›¸åº”çš„åµŒå¥—ResultMapå¯¹è±¡

        String resultMap = caseChild.getStringAttribute(&quot;resultMap&quot;,

                processNestedResultMappings(caseChild, resultMappings, resultType));

        // è®°å½•è¯¥åˆ—å€¼ä¸å¯¹åº”é€‰æ‹©çš„ResultMapçš„Id

        discriminatorMap.put(value, resultMap);

    }

    // åˆ›å»ºDiscriminatorå¯¹è±¡

    return builderAssistant.buildDiscriminator(resultType, column, javaTypeClass, jdbcTypeEnum, typeHandlerClass, discriminatorMap);

}
</code></pre><h3 id="sql-è¯­å¥è§£æå…¨æµç¨‹">SQL è¯­å¥è§£æå…¨æµç¨‹</h3>
<p>åœ¨ Mapper.xml æ˜ å°„æ–‡ä»¶ä¸­ï¼Œé™¤äº†ä¸Šé¢ä»‹ç»çš„æ ‡ç­¾ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç±»æ¯”è¾ƒé‡è¦çš„æ ‡ç­¾ï¼Œé‚£å°±æ˜¯ <code>&lt;select&gt;</code>ã€<code>&lt;insert&gt;</code>ã€<code>&lt;delete&gt;</code>ã€<code>&lt;update&gt;</code> ç­‰ SQL è¯­å¥æ ‡ç­¾ã€‚è™½ç„¶å®šä¹‰åœ¨ Mapper.xml æ˜ å°„æ–‡ä»¶ä¸­ï¼Œä½†æ˜¯<strong>è¿™äº›æ ‡ç­¾æ˜¯ç”± XMLStatementBuilder è¿›è¡Œè§£æçš„</strong>ï¼Œè€Œä¸å†ç”± XMLMapperBuilder æ¥å®Œæˆè§£æã€‚</p>
<p>åœ¨å¼€å§‹ä»‹ç» XMLStatementBuilder è§£æ SQL è¯­å¥æ ‡ç­¾çš„å…·ä½“å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ MyBatis åœ¨å†…å­˜ä¸­æ˜¯å¦‚ä½•è¡¨ç¤ºè¿™äº› SQL è¯­å¥æ ‡ç­¾çš„ã€‚åœ¨å†…å­˜ä¸­ï¼ŒMyBatis ä½¿ç”¨ SqlSource æ¥å£æ¥è¡¨ç¤ºè§£æä¹‹åçš„ SQL è¯­å¥ï¼Œå…¶ä¸­çš„ SQL è¯­å¥åªæ˜¯ä¸€ä¸ªä¸­é—´æ€ï¼Œå¯èƒ½åŒ…å«åŠ¨æ€ SQL æ ‡ç­¾æˆ–å ä½ç¬¦ç­‰ä¿¡æ¯ï¼Œæ— æ³•ç›´æ¥ä½¿ç”¨ã€‚SqlSource æ¥å£çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>public interface SqlSource {

    // æ ¹æ®Mapperæ–‡ä»¶æˆ–æ³¨è§£æè¿°çš„SQLè¯­å¥ï¼Œä»¥åŠä¼ å…¥çš„å®å‚ï¼Œè¿”å›å¯æ‰§è¡Œçš„SQL

    BoundSql getBoundSql(Object parameterObject);

}
</code></pre><p>MyBatis åœ¨å†…å­˜ä¸­ä½¿ç”¨ MappedStatement å¯¹è±¡è¡¨ç¤ºä¸Šè¿° SQL æ ‡ç­¾ã€‚åœ¨ MappedStatement ä¸­çš„ sqlSource å­—æ®µè®°å½•äº† SQL æ ‡ç­¾ä¸­å®šä¹‰çš„ SQL è¯­å¥ï¼ŒsqlCommandType å­—æ®µè®°å½•äº† SQL è¯­å¥çš„ç±»å‹ï¼ˆINSERTã€UPDATEã€DELETEã€SELECT æˆ– FLUSH ç±»å‹ï¼‰ã€‚</p>
<p>ä»‹ç»å®Œè¡¨ç¤º SQL æ ‡ç­¾çš„åŸºç¡€ç±»ä¹‹åï¼Œæˆ‘ä»¬æ¥åˆ†æ XMLStatementBuilder è§£æ SQL æ ‡ç­¾çš„å…¥å£æ–¹æ³•â€”â€” parseStatementNode() æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­é¦–å…ˆä¼šæ ¹æ® id å±æ€§å’Œ databaseId å±æ€§å†³å®šåŠ è½½åŒ¹é…çš„ SQL æ ‡ç­¾ï¼Œç„¶åè§£æå…¶ä¸­çš„<code>&lt;include&gt;</code> æ ‡ç­¾å’Œ <code>&lt;selectKey&gt;</code> æ ‡ç­¾ï¼Œç›¸å…³çš„ä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>public void parseStatementNode() {

    // è·å–SQLæ ‡ç­¾çš„idä»¥åŠdatabaseIdå±æ€§

    String id = context.getStringAttribute(&quot;id&quot;);

    String databaseId = context.getStringAttribute(&quot;databaseId&quot;);

    // è‹¥databaseIdå±æ€§å€¼ä¸å½“å‰ä½¿ç”¨çš„æ•°æ®åº“ä¸åŒ¹é…ï¼Œåˆ™ä¸åŠ è½½è¯¥SQLæ ‡ç­¾

    // è‹¥å­˜åœ¨ç›¸åŒidä¸”databaseIdä¸ä¸ºç©ºçš„SQLæ ‡ç­¾ï¼Œåˆ™ä¸å†åŠ è½½è¯¥SQLæ ‡ç­¾

    if (!databaseIdMatchesCurrent(id, databaseId, this.requiredDatabaseId)) {

        return;

    }

    // æ ¹æ®SQLæ ‡ç­¾çš„åç§°å†³å®šå…¶SqlCommandType

    String nodeName = context.getNode().getNodeName();

    SqlCommandType sqlCommandType = SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH));

    // è·å–SQLæ ‡ç­¾çš„å±æ€§å€¼ï¼Œä¾‹å¦‚ï¼ŒfetchSizeã€timeoutã€parameterTypeã€parameterMapã€

    // resultMapã€resultTypeã€langã€resultSetTypeã€flushCacheã€useCacheç­‰ã€‚

    // è¿™äº›å±æ€§çš„å…·ä½“å«ä¹‰åœ¨MyBatiså®˜æ–¹æ–‡æ¡£ä¸­å·²ç»æœ‰æ¯”è¾ƒè¯¦ç»†çš„ä»‹ç»äº†ï¼Œè¿™é‡Œä¸å†èµ˜è¿°

    ... ...

    // åœ¨è§£æSQLè¯­å¥ä¹‹å‰ï¼Œå…ˆå¤„ç†å…¶ä¸­çš„&lt;include&gt;æ ‡ç­¾

    XMLIncludeTransformer includeParser = new XMLIncludeTransformer(configuration, builderAssistant);

    includeParser.applyIncludes(context.getNode());

    // è·å–SQLæ ‡ç­¾çš„parameterTypeã€langä¸¤ä¸ªå±æ€§

    ... ...

    // è§£æ&lt;selectKey&gt;æ ‡ç­¾

    processSelectKeyNodes(id, parameterTypeClass, langDriver);

    // æš‚æ—¶çœç•¥åé¢çš„é€»è¾‘

    ...

}
</code></pre><h4 id="1-å¤„ç†-include-æ ‡ç­¾">1. å¤„ç† <code>&lt;include&gt;</code> æ ‡ç­¾</h4>
<p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ä¼šåœ¨<code>&lt;sql&gt;</code> æ ‡ç­¾ä¸­å®šä¹‰ä¸€äº›èƒ½å¤Ÿè¢«é‡ç”¨çš„SQL ç‰‡æ®µï¼Œåœ¨ XMLMapperBuilder.sqlElement() æ–¹æ³•ä¸­ä¼šæ ¹æ®å½“å‰ä½¿ç”¨çš„ DatabaseId åŒ¹é… <code>&lt;sql&gt;</code> æ ‡ç­¾ï¼Œåªæœ‰åŒ¹é…çš„ SQL ç‰‡æ®µæ‰ä¼šè¢«åŠ è½½åˆ°å†…å­˜ã€‚</p>
<p>åœ¨è§£æ SQL æ ‡ç­¾ä¹‹å‰ï¼ŒMyBatis ä¼šå…ˆå°† <code>&lt;include&gt;</code> æ ‡ç­¾è½¬æ¢æˆå¯¹åº”çš„ SQL ç‰‡æ®µï¼ˆå³å®šä¹‰åœ¨ <code>&lt;sql&gt;</code> æ ‡ç­¾å†…çš„æ–‡æœ¬ï¼‰ï¼Œè¿™ä¸ªè½¬æ¢è¿‡ç¨‹æ˜¯åœ¨ XMLIncludeTransformer.applyIncludes() æ–¹æ³•ä¸­å®ç°çš„ï¼ˆå…¶ä¸­ä¸ä»…åŒ…å«äº† <code>&lt;include&gt;</code> æ ‡ç­¾çš„å¤„ç†ï¼Œè¿˜åŒ…å«äº†â€œ${}â€å ä½ç¬¦çš„å¤„ç†ï¼‰ã€‚</p>
<p>é’ˆå¯¹ <code>&lt;include&gt;</code> æ ‡ç­¾çš„å¤„ç†å¦‚ä¸‹ï¼š</p>
<ul>
<li>æŸ¥æ‰¾ refid å±æ€§æŒ‡å‘çš„ <code>&lt;sql&gt;</code> æ ‡ç­¾ï¼Œå¾—åˆ°å…¶å¯¹åº”çš„ Node å¯¹è±¡ï¼›</li>
<li>è§£æ <code>&lt;include&gt;</code> æ ‡ç­¾ä¸‹çš„ <code>&lt;property&gt;</code> æ ‡ç­¾ï¼Œå°†å¾—åˆ°çš„é”®å€¼å¯¹æ·»åŠ åˆ° variablesContext é›†åˆï¼ˆProperties ç±»å‹ï¼‰ä¸­ï¼Œå¹¶å½¢æˆæ–°çš„ Properties å¯¹è±¡è¿”å›ï¼Œç”¨äºæ›¿æ¢å ä½ç¬¦ï¼›</li>
<li>é€’å½’æ‰§è¡Œ applyIncludes()æ–¹æ³•ï¼Œå› ä¸ºåœ¨ <code>&lt;sql&gt;</code> æ ‡ç­¾çš„å®šä¹‰ä¸­å¯èƒ½ä¼šä½¿ç”¨ <code>&lt;include&gt;</code> å¼•ç”¨å…¶ä»– SQL ç‰‡æ®µï¼Œåœ¨ applyIncludes()æ–¹æ³•é€’å½’çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœé‡åˆ°â€œ${}â€å ä½ç¬¦ï¼Œåˆ™ä½¿ç”¨ variablesContext é›†åˆä¸­çš„é”®å€¼å¯¹è¿›è¡Œæ›¿æ¢ï¼›</li>
<li>æœ€åï¼Œå°† <code>&lt;include&gt;</code> æ ‡ç­¾æ›¿æ¢æˆ <code>&lt;sql&gt;</code> æ ‡ç­¾çš„å†…å®¹ã€‚</li>
</ul>
<p>é€šè¿‡ä¸Šé¢é€»è¾‘å¯ä»¥çœ‹å‡ºï¼Œ<code>&lt;include&gt;</code> æ ‡ç­¾å’Œ <code>&lt;sql&gt;</code> æ ‡ç­¾æ˜¯å¯ä»¥åµŒå¥—å¤šå±‚çš„ï¼Œæ­¤æ—¶å°±ä¼šæ¶‰åŠ applyIncludes()æ–¹æ³•çš„é€’å½’ï¼ŒåŒæ—¶å¯ä»¥é…åˆâ€œ${}â€å ä½ç¬¦ï¼Œå®ç° SQL ç‰‡æ®µæ¨¡æ¿åŒ–ï¼Œæ›´å¤§ç¨‹åº¦åœ°æé«˜ SQL ç‰‡æ®µçš„é‡ç”¨ç‡ã€‚</p>
<h4 id="2-å¤„ç†-selectkey-æ ‡ç­¾">2. å¤„ç† <code>&lt;selectKey&gt;</code> æ ‡ç­¾</h4>
<p>åœ¨æœ‰çš„æ•°æ®åº“è¡¨è®¾è®¡åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ä¼šæ·»åŠ ä¸€ä¸ªè‡ªå¢ ID å­—æ®µä½œä¸ºä¸»é”®ï¼Œä¾‹å¦‚ï¼Œç”¨æˆ· IDã€è®¢å• ID æˆ–è€…è¿™ä¸ªè‡ªå¢ ID æœ¬èº«å¹¶æ²¡æœ‰ä»€ä¹ˆä¸šåŠ¡å«ä¹‰ï¼Œåªæ˜¯ä¸€ä¸ªå”¯ä¸€æ ‡è¯†è€Œå·²ã€‚åœ¨æŸäº›ä¸šåŠ¡é€»è¾‘é‡Œé¢ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨æ‰§è¡Œ insert è¯­å¥çš„æ—¶å€™è¿”å›è¿™ä¸ªè‡ªå¢ ID å€¼ï¼Œ<code>&lt;selectKey&gt;</code> æ ‡ç­¾å°±å¯ä»¥å®ç°è‡ªå¢ ID çš„è·å–ã€‚<code>&lt;selectKey&gt;</code> æ ‡ç­¾ä¸ä»…å¯ä»¥è·å–è‡ªå¢ IDï¼Œè¿˜å¯ä»¥æŒ‡å®šå…¶ä»– SQL è¯­å¥ï¼Œä»å…¶ä»–è¡¨æˆ–æ‰§è¡Œæ•°æ®åº“çš„å‡½æ•°è·å–å­—æ®µå€¼ã€‚</p>
<p><strong>parseSelectKeyNode() æ–¹æ³•æ˜¯è§£æ æ ‡ç­¾çš„æ ¸å¿ƒæ‰€åœ¨</strong>ï¼Œå…¶ä¸­ä¼šè§£æ <code>&lt;selectKey&gt;</code> æ ‡ç­¾çš„å„ä¸ªå±æ€§ï¼Œå¹¶æ ¹æ®è¿™äº›å±æ€§å€¼å°†å…¶ä¸­çš„ SQL è¯­å¥è§£ææˆ MappedStatement å¯¹è±¡ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>private void parseSelectKeyNode(String id, XNode nodeToHandle, Class&lt;?&gt; parameterTypeClass, LanguageDriver langDriver, String databaseId) {

    ... // è§£æ&lt;selectKey&gt;æ ‡ç­¾çš„resultTypeã€statementTypeã€keyPropertyç­‰å±æ€§

    // é€šè¿‡LanguageDriverè§£æ&lt;selectKey&gt;æ ‡ç­¾ä¸­çš„SQLè¯­å¥ï¼Œå¾—åˆ°å¯¹åº”çš„SqlSourceå¯¹è±¡

    SqlSource sqlSource = langDriver.createSqlSource(configuration, nodeToHandle, parameterTypeClass);

    SqlCommandType sqlCommandType = SqlCommandType.SELECT;

    // åˆ›å»ºMappedStatementå¯¹è±¡

    builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,

            fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,

            resultSetTypeEnum, flushCache, useCache, resultOrdered,

            keyGenerator, keyProperty, keyColumn, databaseId, langDriver, null);

    id = builderAssistant.applyCurrentNamespace(id, false);

    // åˆ›å»º&lt;selectKey&gt;æ ‡ç­¾å¯¹åº”çš„KeyGeneratorå¯¹è±¡ï¼Œè¿™ä¸ªKeyGeneratorå¯¹è±¡ä¼šæ·»åŠ åˆ°Configuration.keyGeneratorsé›†åˆä¸­

    MappedStatement keyStatement = configuration.getMappedStatement(id, false);

    configuration.addKeyGenerator(id, new SelectKeyGenerator(keyStatement, executeBefore));

}
</code></pre><h4 id="3-å¤„ç†-sql-è¯­å¥">3. å¤„ç† SQL è¯­å¥</h4>
<p>ç»è¿‡ <code>&lt;include&gt;</code> æ ‡ç­¾å’Œ <code>&lt;selectKey&gt;</code> æ ‡ç­¾çš„å¤„ç†æµç¨‹ä¹‹åï¼ŒXMLStatementBuilder ä¸­çš„ parseStatementNode()æ–¹æ³•æ¥ä¸‹æ¥å°±è¦å¼€å§‹å¤„ç† SQL è¯­å¥äº†ï¼Œç›¸å…³çš„ä»£ç ç‰‡æ®µä¹‹å‰è¢«çœç•¥äº†ï¼Œè¿™é‡Œæˆ‘ä»¬è¯¦ç»†åˆ†æä¸€ä¸‹ï¼š</p>
<pre tabindex="0"><code>public void parseStatementNode() {

    // å‰é¢æ˜¯è§£æ&lt;selectKey&gt;å’Œ&lt;include&gt;æ ‡ç­¾çš„é€»è¾‘ï¼Œè¿™é‡Œä¸å†å±•ç¤º

    // å½“æ‰§è¡Œåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œ&lt;selectKey&gt;å’Œ&lt;include&gt;æ ‡ç­¾å·²ç»è¢«è§£æå®Œæ¯•ï¼Œå¹¶åˆ é™¤æ‰äº†

    // ä¸‹é¢æ˜¯è§£æSQLè¯­å¥çš„é€»è¾‘ï¼Œä¹Ÿæ˜¯parseStatementNode()æ–¹æ³•çš„æ ¸å¿ƒ

    // é€šè¿‡LanguageDriver.createSqlSource()æ–¹æ³•åˆ›å»ºSqlSourceå¯¹è±¡

    SqlSource sqlSource = langDriver.createSqlSource(configuration, context, parameterTypeClass);

    // è·å–SQLæ ‡ç­¾ä¸­é…ç½®çš„resultSetsã€keyPropertyã€keyColumnç­‰å±æ€§ï¼Œä»¥åŠå‰é¢è§£æ&lt;selectKey&gt;æ ‡ç­¾å¾—åˆ°çš„KeyGeneratorå¯¹è±¡ç­‰ï¼Œ

    // è¿™äº›ä¿¡æ¯å°†ä¼šå¡«å……åˆ°MappedStatementå¯¹è±¡ä¸­

    // æ ¹æ®ä¸Šè¿°å±æ€§ä¿¡æ¯åˆ›å»ºMappedStatementå¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°Configuration.mappedStatementsé›†åˆä¸­ä¿å­˜

    builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,

            fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,

            resultSetTypeEnum, flushCache, useCache, resultOrdered,

            keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);

}
</code></pre><p>è¿™é‡Œè§£æ SQL è¯­å¥<strong>ä½¿ç”¨çš„æ˜¯ LanguageDriver æ¥å£</strong>ï¼Œå…¶æ ¸å¿ƒå®ç°æ˜¯ XMLLanguageDriverï¼Œç»§æ‰¿å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%20MyBatis%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86-%E5%AE%8C/assets/Cgp9HWA7ksyAUvrwAADwoAT3J5M370.png" alt="å›¾ç‰‡2.png"></p>
<p>LanguageDriver ç»§æ‰¿å…³ç³»å›¾</p>
<p>åœ¨ createSqlSource() æ–¹æ³•ä¸­ï¼ŒXMLLanguageDriver ä¼šä¾èµ– XMLScriptBuilder åˆ›å»º SqlSource å¯¹è±¡ï¼ŒXMLScriptBuilder é¦–å…ˆä¼šåˆ¤æ–­ SQL è¯­å¥æ˜¯å¦ä¸ºåŠ¨æ€SQLï¼Œåˆ¤æ–­çš„æ ¸å¿ƒé€»è¾‘åœ¨ parseDynamicTags()æ–¹æ³•ä¸­ï¼Œæ ¸å¿ƒå®ç°å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>protected MixedSqlNode parseDynamicTags(XNode node) {

    List&lt;SqlNode&gt; contents = new ArrayList&lt;&gt;(); // è§£æåçš„SqlNodeç»“æœé›†åˆ

    NodeList children = node.getNode().getChildNodes();

    // è·å–SQLæ ‡ç­¾ä¸‹çš„æ‰€æœ‰èŠ‚ç‚¹ï¼ŒåŒ…æ‹¬æ ‡ç­¾èŠ‚ç‚¹å’Œæ–‡æœ¬èŠ‚ç‚¹

    for (int i = 0; i &lt; children.getLength(); i++) {

        XNode child = node.newXNode(children.item(i));

        if (child.getNode().getNodeType() == Node.CDATA_SECTION_NODE ||

                child.getNode().getNodeType() == Node.TEXT_NODE) {

            // å¤„ç†æ–‡æœ¬èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯SQLè¯­å¥

            String data = child.getStringBody(&quot;&quot;);

            TextSqlNode textSqlNode = new TextSqlNode(data);

            // è§£æSQLè¯­å¥ï¼Œå¦‚æœå«æœ‰æœªè§£æçš„&quot;${}&quot;å ä½ç¬¦ï¼Œåˆ™ä¸ºåŠ¨æ€SQL

            if (textSqlNode.isDynamic()) {

                contents.add(textSqlNode);

                isDynamic = true; // æ ‡è®°ä¸ºåŠ¨æ€SQLè¯­å¥

            } else {

                contents.add(new StaticTextSqlNode(data));

            }

        } else if (child.getNode().getNodeType() == Node.ELEMENT_NODE) {

            // å¦‚æœè§£æåˆ°ä¸€ä¸ªå­æ ‡ç­¾ï¼Œé‚£ä¹ˆä¸€å®šæ˜¯åŠ¨æ€SQL

            // è¿™é‡Œä¼šæ ¹æ®ä¸åŒçš„æ ‡ç­¾ï¼Œè·å–ä¸åŒçš„NodeHandlerï¼Œç„¶åç”±NodeHandlerè¿›è¡Œåç»­è§£æ

            String nodeName = child.getNode().getNodeName();

            NodeHandler handler = nodeHandlerMap.get(nodeName);

            if (handler == null) {

                throw new BuilderException(&quot;Unknown element &lt;&quot; + nodeName + &quot;&gt; in SQL statement.&quot;);

            }

            // å¤„ç†åŠ¨æ€SQLè¯­å¥ï¼Œå¹¶å°†è§£æå¾—åˆ°çš„SqlNodeå¯¹è±¡è®°å½•åˆ°contentsé›†åˆä¸­

            handler.handleNode(child, contents);

            isDynamic = true;

        }

    }

    // è§£æåçš„SqlNodeé›†åˆå°†ä¼šè¢«å°è£…æˆMixedSqlNodeè¿”å›

    return new MixedSqlNode(contents);

}
</code></pre><p>è¿™é‡Œä½¿ç”¨ SqlNode æ¥å£æ¥è¡¨ç¤ºä¸€æ¡ SQL è¯­å¥çš„ä¸åŒéƒ¨åˆ†ï¼Œå…¶ä¸­ï¼ŒTextSqlNode è¡¨ç¤ºçš„æ˜¯SQL è¯­å¥çš„æ–‡æœ¬ï¼ˆå¯èƒ½åŒ…å«â€œ${}â€å ä½ç¬¦ï¼‰ï¼ŒStaticTextSqlNode è¡¨ç¤ºçš„æ˜¯ä¸åŒ…å«å ä½ç¬¦çš„SQL è¯­å¥æ–‡æœ¬ã€‚</p>
<p>å¦å¤–ä¸€ä¸ªæ–°æ¥å£æ˜¯NodeHandlerï¼Œå®ƒæœ‰å¾ˆå¤šå®ç°ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%20MyBatis%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86-%E5%AE%8C/assets/Cgp9HWA7kvSAHP1yAAEyhRwHGEE543.png" alt="å›¾ç‰‡3.png"></p>
<p>NodeHandler ç»§æ‰¿å…³ç³»å›¾</p>
<p><strong>NodeHandleræ¥å£è´Ÿè´£è§£æåŠ¨æ€ SQL å†…çš„æ ‡ç­¾</strong>ï¼Œç”Ÿæˆç›¸åº”çš„ SqlNode å¯¹è±¡ï¼Œé€šè¿‡ NodeHandler å®ç°ç±»çš„åç§°ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¤§æ¦‚çŒœæµ‹åˆ°å…¶è§£æçš„æ ‡ç­¾åç§°ã€‚ä»¥ IfHandler ä¸ºä¾‹ï¼Œå®ƒè§£æçš„å°±æ˜¯ <code>&lt;if&gt;</code> æ ‡ç­¾ï¼Œå…¶æ ¸å¿ƒå®ç°å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>private class IfHandler implements NodeHandler {

    public void handleNode(XNode nodeToHandle, List&lt;SqlNode&gt; targetContents) {

        // é€šè¿‡parseDynamicTags()æ–¹æ³•ï¼Œè§£æ&lt;if&gt;æ ‡ç­¾ä¸‹åµŒå¥—çš„åŠ¨æ€SQL

        MixedSqlNode mixedSqlNode = parseDynamicTags(nodeToHandle);

        // è·å–&lt;if&gt;æ ‡ç­¾åˆ¤æ–­åˆ†æ”¯çš„æ¡ä»¶

        String test = nodeToHandle.getStringAttribute(&quot;test&quot;);

        // åˆ›å»ºIfNodeå¯¹è±¡(ä¹Ÿæ˜¯SqlNodeæ¥å£çš„å®ç°)ï¼Œå¹¶å°†å…¶ä¿å­˜ä¸‹æ¥

        IfSqlNode ifSqlNode = new IfSqlNode(mixedSqlNode, test);

        targetContents.add(ifSqlNode);

    }

}
</code></pre><p>å®Œæˆäº†å¯¹ SQL è¯­å¥çš„è§£æï¼Œå¾—åˆ°äº†ç›¸åº”çš„ MixedSqlNodeå¯¹è±¡ä¹‹åï¼ŒXMLScriptBuilder ä¼šæ ¹æ® SQL è¯­å¥çš„ç±»å‹ç”Ÿæˆä¸åŒçš„ SqlSource å®ç°ï¼š</p>
<pre tabindex="0"><code>public SqlSource parseScriptNode() {

    // å¯¹SQLè¯­å¥è¿›è¡Œè§£æ

    MixedSqlNode rootSqlNode = parseDynamicTags(context);

    SqlSource sqlSource;

    if (isDynamic) { // æ ¹æ®è¯¥SQLæ˜¯å¦ä¸ºåŠ¨æ€SQLï¼Œåˆ›å»ºä¸åŒçš„SqlSourceå®ç°

        sqlSource = new DynamicSqlSource(configuration, rootSqlNode);

    } else {

        sqlSource = new RawSqlSource(configuration, rootSqlNode, parameterType);

    }

    return sqlSource;

}
</code></pre><h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>è¿™ä¸€è®²æˆ‘ä»¬é‡ç‚¹ä»‹ç»äº† MyBatis åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­å¯¹ Mapper.xml æ˜ å°„æ–‡ä»¶çš„è§£æã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬ç€é‡ä»‹ç»äº† Mapper.xml æ˜ å°„æ–‡ä»¶ä¸­å¯¹ <code>&lt;cache&gt;</code> æ ‡ç­¾ã€<code>&lt;cache-ref&gt;</code> æ ‡ç­¾ä»¥åŠ <code>&lt;resultMap&gt;</code> æ ‡ç­¾ï¼ˆåŒ…æ‹¬å®ƒçš„å„ä¸ªå­æ ‡ç­¾ï¼‰çš„è§£ææµç¨‹ï¼Œè®©æˆ‘ä»¬çŸ¥é“ MyBatisæ˜¯å¦‚ä½•æ­£ç¡®ç†è§£äºŒçº§ç¼“å­˜çš„é…ç½®ä¿¡æ¯ä»¥åŠæˆ‘ä»¬å®šä¹‰çš„å„ç§æ˜ å°„è§„åˆ™ã€‚</p>
<p>ç„¶åï¼Œæˆ‘ä»¬è¯¦ç»†åˆ†æäº† MyBatis å¯¹ Mapper.xml æ˜ å°„æ–‡ä»¶ä¸­ SQL è¯­å¥æ ‡ç­¾çš„è§£æï¼Œå…¶ä¸­æ¶‰åŠ <code>&lt;include&gt;</code>ã€<code>&lt;selectKey&gt;</code> ç­‰æ ‡ç­¾çš„å¤„ç†é€»è¾‘ã€‚</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/10-%E9%B8%9F%E7%9E%B0-mybatis-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%8A%8A%E6%8F%A1-mybatis-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E8%84%89%E7%BB%9C%E4%B8%8A/"><span>10 é¸Ÿç° MyBatis åˆå§‹åŒ–ï¼ŒæŠŠæ¡ MyBatis å¯åŠ¨æµç¨‹è„‰ç»œï¼ˆä¸Šï¼‰</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/mybatis/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/12-%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90%E5%8A%A8%E6%80%81-sql-%E8%AF%AD%E5%8F%A5%E8%A7%A3%E6%9E%90%E5%85%A8%E6%B5%81%E7%A8%8B%E4%B8%8A/"><span>12 æ·±å…¥åˆ†æåŠ¨æ€ SQL è¯­å¥è§£æå…¨æµç¨‹ï¼ˆä¸Šï¼‰</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 27270 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>