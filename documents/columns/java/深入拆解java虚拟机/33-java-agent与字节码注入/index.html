<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>33 Java Agentä¸å­—èŠ‚ç æ³¨å…¥ | Yipsen Ye</title>
<meta name="description" content="å…³äº Java agentï¼Œå¤§å®¶å¯èƒ½éƒ½å¬è¿‡å¤§åé¼é¼çš„premainæ–¹æ³•ã€‚é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªæ–¹æ³•æŒ‡çš„å°±æ˜¯åœ¨mainæ–¹æ³•ä¹‹å‰æ‰§è¡Œçš„æ–¹æ³•ã€‚
package org.example;public class MyAgent {public static void premain(String args) {System.out.println(&amp;quot;premain&amp;quot;);}}æˆ‘åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­å®šä¹‰äº†ä¸€ä¸ªpremainæ–¹æ³•ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒJava è™šæ‹Ÿæœºæ‰€èƒ½è¯†åˆ«çš„premainæ–¹æ³•æ¥æ”¶çš„æ˜¯å­—ç¬¦ä¸²ç±»å‹çš„å‚æ•°ï¼Œè€Œå¹¶éç±»ä¼¼äºmainæ–¹æ³•çš„å­—ç¬¦ä¸²æ•°ç»„ã€‚
ä¸ºäº†èƒ½å¤Ÿä»¥ Java agent çš„æ–¹å¼è¿è¡Œè¯¥premainæ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶æ‰“åŒ…æˆ jar åŒ…ï¼Œå¹¶åœ¨å…¶ä¸­çš„ MANIFEST.MF é…ç½®æ–‡ä»¶ä¸­ï¼ŒæŒ‡å®šæ‰€è°“çš„Premain-classã€‚å…·ä½“çš„å‘½ä»¤å¦‚ä¸‹æ‰€ç¤ºï¼š
# æ³¨æ„ç¬¬ä¸€æ¡å‘½ä»¤ä¼šå‘ manifest.txt æ–‡ä»¶å†™å…¥ä¸¤è¡Œæ•°æ®ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸€è¡Œç©ºè¡Œ$ echo &#39;Premain-Class: org.example.MyAgent&#39; &amp;gt; manifest.txt$ jar cvmf manifest.txt myagent.jar org/$ java -javaagent:myagent.jar HelloWorldpremainHello, Worldé™¤äº†åœ¨å‘½ä»¤è¡Œä¸­æŒ‡å®š Java agent ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ Attach API è¿œç¨‹åŠ è½½ã€‚å…·ä½“ç”¨æ³•å¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š
import java.io.IOException;import com.sun.tools.attach.*;public class AttachTest {public static void main(String[] args)throws AttachNotSupportedException, IOException, AgentLoadException, AgentInitializationException {if (args.">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/%e6%b7%b1%e5%85%a5%e6%8b%86%e8%a7%a3java%e8%99%9a%e6%8b%9f%e6%9c%ba/">æ·±å…¥æ‹†è§£Javaè™šæ‹Ÿæœº</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/00-%E5%BC%80%E7%AF%87%E8%AF%8D-%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E4%BB%AC%E8%A6%81%E5%AD%A6%E4%B9%A0java%E8%99%9A%E6%8B%9F%E6%9C%BA/">00 å¼€ç¯‡è¯ ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦å­¦ä¹ Javaè™šæ‹Ÿæœºï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/01-java%E4%BB%A3%E7%A0%81%E6%98%AF%E6%80%8E%E4%B9%88%E8%BF%90%E8%A1%8C%E7%9A%84/">01 Javaä»£ç æ˜¯æ€ä¹ˆè¿è¡Œçš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/02-java%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/">02 Javaçš„åŸºæœ¬ç±»å‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/03-java%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%98%AF%E5%A6%82%E4%BD%95%E5%8A%A0%E8%BD%BDjava%E7%B1%BB%E7%9A%84/">03 Javaè™šæ‹Ÿæœºæ˜¯å¦‚ä½•åŠ è½½Javaç±»çš„</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/04-jvm%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E7%9A%84%E4%B8%8A/">04 JVMæ˜¯å¦‚ä½•æ‰§è¡Œæ–¹æ³•è°ƒç”¨çš„ï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/05-jvm%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E7%9A%84%E4%B8%8B/">05 JVMæ˜¯å¦‚ä½•æ‰§è¡Œæ–¹æ³•è°ƒç”¨çš„ï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/06-jvm%E6%98%AF%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E5%BC%82%E5%B8%B8%E7%9A%84/">06 JVMæ˜¯å¦‚ä½•å¤„ç†å¼‚å¸¸çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/07-jvm%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%8F%8D%E5%B0%84%E7%9A%84/">07 JVMæ˜¯å¦‚ä½•å®ç°åå°„çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/08-jvm%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0invokedynamic%E7%9A%84%E4%B8%8A/">08 JVMæ˜¯æ€ä¹ˆå®ç°invokedynamicçš„ï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/09-jvm%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0invokedynamic%E7%9A%84%E4%B8%8B/">09 JVMæ˜¯æ€ä¹ˆå®ç°invokedynamicçš„ï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/10-java%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/">10 Javaå¯¹è±¡çš„å†…å­˜å¸ƒå±€</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/11-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E4%B8%8A/">11 åƒåœ¾å›æ”¶ï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/12-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E4%B8%8B/">12 åƒåœ¾å›æ”¶ï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/13-java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/">13 Javaå†…å­˜æ¨¡å‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/14-java%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0synchronized%E7%9A%84/">14 Javaè™šæ‹Ÿæœºæ˜¯æ€ä¹ˆå®ç°synchronizedçš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/15-java%E8%AF%AD%E6%B3%95%E7%B3%96%E4%B8%8Ejava%E7%BC%96%E8%AF%91%E5%99%A8/">15 Javaè¯­æ³•ç³–ä¸Javaç¼–è¯‘å™¨</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/16-%E5%8D%B3%E6%97%B6%E7%BC%96%E8%AF%91%E4%B8%8A/">16 å³æ—¶ç¼–è¯‘ï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/17-%E5%8D%B3%E6%97%B6%E7%BC%96%E8%AF%91%E4%B8%8B/">17 å³æ—¶ç¼–è¯‘ï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/18-%E5%8D%B3%E6%97%B6%E7%BC%96%E8%AF%91%E5%99%A8%E7%9A%84%E4%B8%AD%E9%97%B4%E8%A1%A8%E8%BE%BE%E5%BD%A2%E5%BC%8F/">18 å³æ—¶ç¼–è¯‘å™¨çš„ä¸­é—´è¡¨è¾¾å½¢å¼</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/19-java%E5%AD%97%E8%8A%82%E7%A0%81%E5%9F%BA%E7%A1%80%E7%AF%87/">19 Javaå­—èŠ‚ç ï¼ˆåŸºç¡€ç¯‡ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/20-%E6%96%B9%E6%B3%95%E5%86%85%E8%81%94%E4%B8%8A/">20 æ–¹æ³•å†…è”ï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/21-%E6%96%B9%E6%B3%95%E5%86%85%E8%81%94%E4%B8%8B/">21 æ–¹æ³•å†…è”ï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/22-hotspot%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84intrinsic/">22 HotSpotè™šæ‹Ÿæœºçš„intrinsic</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/23-%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/">23 é€ƒé€¸åˆ†æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/24-%E5%AD%97%E6%AE%B5%E8%AE%BF%E9%97%AE%E7%9B%B8%E5%85%B3%E4%BC%98%E5%8C%96/">24 å­—æ®µè®¿é—®ç›¸å…³ä¼˜åŒ–</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/25-%E5%BE%AA%E7%8E%AF%E4%BC%98%E5%8C%96/">25 å¾ªç¯ä¼˜åŒ–</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/26-%E5%90%91%E9%87%8F%E5%8C%96/">26 å‘é‡åŒ–</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/27-%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E5%99%A8/">27 æ³¨è§£å¤„ç†å™¨</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/28-%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6jmh%E4%B8%8A/">28 åŸºå‡†æµ‹è¯•æ¡†æ¶JMHï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/29-%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6jmh%E4%B8%8B/">29 åŸºå‡†æµ‹è¯•æ¡†æ¶JMHï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/30-java%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E7%9B%91%E6%8E%A7%E5%8F%8A%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%AF%87/">30 Javaè™šæ‹Ÿæœºçš„ç›‘æ§åŠè¯Šæ–­å·¥å…·ï¼ˆå‘½ä»¤è¡Œç¯‡ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/31-java%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E7%9B%91%E6%8E%A7%E5%8F%8A%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7gui%E7%AF%87/">31 Javaè™šæ‹Ÿæœºçš„ç›‘æ§åŠè¯Šæ–­å·¥å…·ï¼ˆGUIç¯‡ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/32-jni%E7%9A%84%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/">32 JNIçš„è¿è¡Œæœºåˆ¶</a></li>
                
                
                
                    <li>33 Java Agentä¸å­—èŠ‚ç æ³¨å…¥</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/34-graal%E7%94%A8java%E7%BC%96%E8%AF%91java/">34 Graalï¼šç”¨Javaç¼–è¯‘Java</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/35-truffle%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0%E6%A1%86%E6%9E%B6/">35 Truffleï¼šè¯­è¨€å®ç°æ¡†æ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/36-substratevmaot%E7%BC%96%E8%AF%91%E6%A1%86%E6%9E%B6/">36 SubstrateVMï¼šAOTç¼–è¯‘æ¡†æ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/%E5%B0%BE%E5%A3%B0%E4%B8%A8%E9%81%93%E9%98%BB%E4%B8%94%E9%95%BF%E5%8A%AA%E5%8A%9B%E5%8A%A0%E9%A4%90.html/">å°¾å£°ä¸¨é“é˜»ä¸”é•¿ï¼ŒåŠªåŠ›åŠ é¤.html</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/%E5%B7%A5%E5%85%B7%E7%AF%87-%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D/">å·¥å…·ç¯‡ å¸¸ç”¨å·¥å…·ä»‹ç»</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">33 Java Agentä¸å­—èŠ‚ç æ³¨å…¥</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2022-01-09 11:11:23</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/java/">java</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/">æ·±å…¥æ‹†è§£Javaè™šæ‹Ÿæœº</a>
                
            </div></div>
        <div class="post-content">
            <p>å…³äº Java agentï¼Œå¤§å®¶å¯èƒ½éƒ½å¬è¿‡å¤§åé¼é¼çš„<code>premain</code>æ–¹æ³•ã€‚é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªæ–¹æ³•æŒ‡çš„å°±æ˜¯åœ¨<code>main</code>æ–¹æ³•ä¹‹å‰æ‰§è¡Œçš„æ–¹æ³•ã€‚</p>
<pre tabindex="0"><code>package org.example;
 
public class MyAgent {
  public static void premain(String args) {
    System.out.println(&quot;premain&quot;);
  }
}
</code></pre><p>æˆ‘åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­å®šä¹‰äº†ä¸€ä¸ª<code>premain</code>æ–¹æ³•ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒJava è™šæ‹Ÿæœºæ‰€èƒ½è¯†åˆ«çš„<code>premain</code>æ–¹æ³•æ¥æ”¶çš„æ˜¯å­—ç¬¦ä¸²ç±»å‹çš„å‚æ•°ï¼Œè€Œå¹¶éç±»ä¼¼äº<code>main</code>æ–¹æ³•çš„å­—ç¬¦ä¸²æ•°ç»„ã€‚</p>
<p>ä¸ºäº†èƒ½å¤Ÿä»¥ Java agent çš„æ–¹å¼è¿è¡Œè¯¥<code>premain</code>æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶æ‰“åŒ…æˆ jar åŒ…ï¼Œå¹¶åœ¨å…¶ä¸­çš„ MANIFEST.MF é…ç½®æ–‡ä»¶ä¸­ï¼ŒæŒ‡å®šæ‰€è°“çš„<code>Premain-class</code>ã€‚å…·ä½“çš„å‘½ä»¤å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code># æ³¨æ„ç¬¬ä¸€æ¡å‘½ä»¤ä¼šå‘ manifest.txt æ–‡ä»¶å†™å…¥ä¸¤è¡Œæ•°æ®ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸€è¡Œç©ºè¡Œ
$ echo 'Premain-Class: org.example.MyAgent
' &gt; manifest.txt
$ jar cvmf manifest.txt myagent.jar org/
$ java -javaagent:myagent.jar HelloWorld
premain
Hello, World
</code></pre><p>é™¤äº†åœ¨å‘½ä»¤è¡Œä¸­æŒ‡å®š Java agent ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ Attach API è¿œç¨‹åŠ è½½ã€‚å…·ä½“ç”¨æ³•å¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>import java.io.IOException;
 
import com.sun.tools.attach.*;
 
public class AttachTest {
  public static void main(String[] args)
      throws AttachNotSupportedException, IOException, AgentLoadException, AgentInitializationException {
    if (args.length &lt;= 1) {
      System.out.println(&quot;Usage: java AttachTest &lt;PID&gt; /PATH/TO/AGENT.jar&quot;);
      return;
    }
    VirtualMachine vm = VirtualMachine.attach(args[0]);
    vm.loadAgent(args[1]);
  }
}
 
</code></pre><p>ä½¿ç”¨ Attach API è¿œç¨‹åŠ è½½çš„ Java agent ä¸ä¼šå†å…ˆäº<code>main</code>æ–¹æ³•æ‰§è¡Œï¼Œè¿™å–å†³äºå¦ä¸€è™šæ‹Ÿæœºè°ƒç”¨ Attach API çš„æ—¶æœºã€‚å¹¶ä¸”ï¼Œå®ƒè¿è¡Œçš„ä¹Ÿä¸å†æ˜¯<code>premain</code>æ–¹æ³•ï¼Œè€Œæ˜¯åä¸º<code>agentmain</code>çš„æ–¹æ³•ã€‚</p>
<pre tabindex="0"><code>public class MyAgent { 
  public static void agentmain(String args) {
    System.out.println(&quot;agentmain&quot;);
  }
}
</code></pre><p>ç›¸åº”çš„ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–° jar åŒ…ä¸­çš„ manifest æ–‡ä»¶ï¼Œä½¿å…¶åŒ…å«<code>Agent-Class</code>çš„é…ç½®ï¼Œä¾‹å¦‚<code>Agent-Class: org.example.MyAgent</code>ã€‚</p>
<pre tabindex="0"><code>$ echo 'Agent-Class: org.example.MyAgent
' &gt; manifest.txt
$ jar cvmf manifest.txt myagent.jar org/
$ java HelloWorld
Hello, World
$ jps
$ java AttachTest &lt;pid&gt; myagent.jar
agentmain
// æœ€åä¸€å¥è¾“å‡ºæ¥è‡ªäºè¿è¡Œ HelloWorld çš„ Java è¿›ç¨‹
</code></pre><p>Java è™šæ‹Ÿæœºå¹¶ä¸é™åˆ¶ Java agent çš„æ•°é‡ã€‚ä½ å¯ä»¥åœ¨ java å‘½ä»¤åé™„ä¸Šå¤šä¸ª<code>-javaagent</code>å‚æ•°ï¼Œæˆ–è€…è¿œç¨‹ attach å¤šä¸ª Java agentï¼ŒJava è™šæ‹Ÿæœºä¼šæŒ‰ç…§å®šä¹‰é¡ºåºï¼Œæˆ–è€… attach çš„é¡ºåºé€ä¸ªæ‰§è¡Œè¿™äº› Java agentã€‚</p>
<p>åœ¨<code>premain</code>æ–¹æ³•æˆ–è€…<code>agentmain</code>æ–¹æ³•ä¸­æ‰“å°ä¸€äº›å­—ç¬¦ä¸²å¹¶ä¸å‡ºå¥‡ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥å°†å…¶ä¸­çš„é€»è¾‘å¹¶å…¥<code>main</code>æ–¹æ³•ï¼Œæˆ–è€…å…¶ä»–ç›‘å¬ç«¯å£çš„çº¿ç¨‹ä¸­ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒJava agent è¿˜æä¾›äº†ä¸€å¥— instrumentation æœºåˆ¶ï¼Œå…è®¸åº”ç”¨ç¨‹åºæ‹¦æˆªç±»åŠ è½½äº‹ä»¶ï¼Œå¹¶ä¸”æ›´æ”¹è¯¥ç±»çš„å­—èŠ‚ç ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹åŸºäºè¿™ä¸€æœºåˆ¶çš„å­—èŠ‚ç æ³¨å…¥ã€‚</p>
<h2 id="å­—èŠ‚ç æ³¨å…¥">å­—èŠ‚ç æ³¨å…¥</h2>
<pre tabindex="0"><code>package org.example;
 
import java.lang.instrument.*;
import java.security.ProtectionDomain;
 
public class MyAgent {
  public static void premain(String args, Instrumentation instrumentation) {
    instrumentation.addTransformer(new MyTransformer());
  }
 
  static class MyTransformer implements ClassFileTransformer {
    public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined,
        ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {
      System.out.printf(&quot;Loaded %s: 0x%X%X%X%X\n&quot;, className, classfileBuffer[0], classfileBuffer[1],
          classfileBuffer[2], classfileBuffer[3]);
      return null;
    }
  }
}
</code></pre><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œ<code>premain</code>æ–¹æ³•å¤šå‡ºäº†ä¸€ä¸ª<code>Instrumentation</code>ç±»å‹çš„å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæ¥æ³¨å†Œç±»åŠ è½½äº‹ä»¶çš„æ‹¦æˆªå™¨ã€‚è¯¥æ‹¦æˆªå™¨éœ€è¦å®ç°<code>ClassFileTransformer</code>æ¥å£ï¼Œå¹¶é‡å†™å…¶ä¸­çš„<code>transform</code>æ–¹æ³•ã€‚</p>
<p><code>transform</code>æ–¹æ³•å°†æ¥æ”¶ä¸€ä¸ª byte æ•°ç»„ç±»å‹çš„å‚æ•°ï¼Œå®ƒä»£è¡¨çš„æ˜¯æ­£åœ¨è¢«åŠ è½½çš„ç±»çš„å­—èŠ‚ç ã€‚åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘å°†æ‰“å°è¯¥æ•°ç»„çš„å‰å››ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ Java class æ–‡ä»¶çš„é­”æ•°ï¼ˆmagic numberï¼‰0xCAFEBABEã€‚</p>
<p><code>transform</code>æ–¹æ³•å°†è¿”å›ä¸€ä¸ª byte æ•°ç»„ï¼Œä»£è¡¨æ›´æ–°è¿‡åçš„ç±»çš„å­—èŠ‚ç ã€‚å½“æ–¹æ³•è¿”å›ä¹‹åï¼ŒJava è™šæ‹Ÿæœºä¼šä½¿ç”¨æ‰€è¿”å›çš„ byte æ•°ç»„ï¼Œæ¥å®Œæˆæ¥ä¸‹æ¥çš„ç±»åŠ è½½å·¥ä½œã€‚ä¸è¿‡ï¼Œå¦‚æœ<code>transform</code>æ–¹æ³•è¿”å› null æˆ–è€…æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆ Java è™šæ‹Ÿæœºå°†ä½¿ç”¨åŸæ¥çš„ byte æ•°ç»„å®Œæˆç±»åŠ è½½å·¥ä½œã€‚</p>
<p>åŸºäºè¿™ä¸€ç±»åŠ è½½äº‹ä»¶çš„æ‹¦æˆªåŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°å­—èŠ‚ç æ³¨å…¥ï¼ˆbytecode instrumentationï¼‰ï¼Œå¾€æ­£åœ¨è¢«åŠ è½½çš„ç±»ä¸­æ’å…¥é¢å¤–çš„å­—èŠ‚ç ã€‚</p>
<p>åœ¨å·¥å…·ç¯‡ä¸­æˆ‘æ›¾ç»ä»‹ç»è¿‡å­—èŠ‚ç å·¥ç¨‹æ¡†æ¶ ASM çš„ç”¨æ³•ã€‚ä¸‹é¢æˆ‘å°†æ¼”ç¤ºå®ƒçš„<a href="https://search.maven.org/artifact/org.ow2.asm/asm-tree/7.0-beta/jar">tree åŒ…</a>ï¼ˆä¾èµ–äº<a href="https://search.maven.org/artifact/org.ow2.asm/asm/7.0-beta/jar">åŸºç¡€åŒ…</a>ï¼‰ï¼Œç”¨é¢å‘å¯¹è±¡çš„æ–¹å¼æ³¨å…¥å­—èŠ‚ç ã€‚</p>
<pre tabindex="0"><code>package org.example;
 
import java.lang.instrument.*;
import java.security.ProtectionDomain;
import org.objectweb.asm.*;
import org.objectweb.asm.tree.*;
 
public class MyAgent {
  public static void premain(String args, Instrumentation instrumentation) {
    instrumentation.addTransformer(new MyTransformer());
  }
 
  static class MyTransformer implements ClassFileTransformer, Opcodes {
    public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined,
        ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {
      ClassReader cr = new ClassReader(classfileBuffer);
      ClassNode classNode = new ClassNode(ASM7);
      cr.accept(classNode, ClassReader.SKIP_FRAMES);
 
      for (MethodNode methodNode : classNode.methods) {
        if (&quot;main&quot;.equals(methodNode.name)) {
          InsnList instrumentation = new InsnList();
          instrumentation.add(new FieldInsnNode(GETSTATIC, &quot;java/lang/System&quot;, &quot;out&quot;, &quot;Ljava/io/PrintStream;&quot;));
          instrumentation.add(new LdcInsnNode(&quot;Hello, Instrumentation!&quot;));
          instrumentation
              .add(new MethodInsnNode(INVOKEVIRTUAL, &quot;java/io/PrintStream&quot;, &quot;println&quot;, &quot;(Ljava/lang/String;)V&quot;, false));
 
          methodNode.instructions.insert(instrumentation);
        }
      }
 
      ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES | ClassWriter.COMPUTE_MAXS);
      classNode.accept(cw);
      return cw.toByteArray();
    }
  }
}
</code></pre><p>ä¸Šé¢è¿™æ®µä»£ç ä¸éš¾ç†è§£ã€‚æˆ‘ä»¬å°†ä½¿ç”¨<code>ClassReader</code>è¯»å–æ‰€ä¼ å…¥çš„ byte æ•°ç»„ï¼Œå¹¶å°†å…¶è½¬æ¢æˆ<code>ClassNode</code>ã€‚ç„¶åæˆ‘ä»¬å°†éå†<code>ClassNode</code>ä¸­çš„<code>MethodNode</code>èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯¥ç±»ä¸­çš„æ„é€ å™¨å’Œæ–¹æ³•ã€‚</p>
<p>å½“é‡åˆ°åå­—ä¸º<code>&quot;main&quot;</code>çš„æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬ä¼šåœ¨æ–¹æ³•çš„å…¥å£å¤„æ³¨å…¥<code>System.out.println(&quot;Hello, Instrumentation!&quot;);</code>ã€‚è¿è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>$ java -javaagent:myagent.jar -cp .:/PATH/TO/asm-7.0-beta.jar:/PATH/TO/asm-tree-7.0-beta.jar HelloWorld
Hello, Instrumentation!
Hello, World!
</code></pre><p>Java agent è¿˜æä¾›äº†å¦å¤–ä¸¤ä¸ªåŠŸèƒ½<code>redefine</code>å’Œ<code>retransform</code>ã€‚è¿™ä¸¤ä¸ªåŠŸèƒ½é’ˆå¯¹çš„æ˜¯å·²åŠ è½½çš„ç±»ï¼Œå¹¶è¦æ±‚ç”¨æˆ·ä¼ å…¥æ‰€è¦<code>redefine</code>æˆ–è€…<code>retransform</code>çš„ç±»å®ä¾‹ã€‚</p>
<p>å…¶ä¸­ï¼Œ<code>redefine</code>æŒ‡çš„æ˜¯èˆå¼ƒåŸæœ¬çš„å­—èŠ‚ç ï¼Œå¹¶æ›¿æ¢æˆç”±ç”¨æˆ·æä¾›çš„ byte æ•°ç»„ã€‚è¯¥åŠŸèƒ½æ¯”è¾ƒå±é™©ï¼Œä¸€èˆ¬ç”¨äºä¿®å¤å‡ºé”™äº†çš„å­—èŠ‚ç ã€‚</p>
<p><code>retransform</code>åˆ™å°†é’ˆå¯¹æ‰€ä¼ å…¥çš„ç±»ï¼Œé‡æ–°è°ƒç”¨æ‰€æœ‰å·²æ³¨å†Œçš„<code>ClassFileTransformer</code>çš„<code>transform</code>æ–¹æ³•ã€‚å®ƒçš„åº”ç”¨åœºæ™¯ä¸»è¦æœ‰å¦‚ä¸‹ä¸¤ä¸ªã€‚</p>
<p>ç¬¬ä¸€ï¼Œåœ¨æ‰§è¡Œ<code>premain</code>æˆ–è€…<code>agentmain</code>æ–¹æ³•å‰ï¼ŒJava è™šæ‹Ÿæœºæ—©å·²åŠ è½½äº†ä¸å°‘ç±»ï¼Œè€Œè¿™äº›ç±»çš„åŠ è½½äº‹ä»¶å¹¶æ²¡æœ‰è¢«æ‹¦æˆªï¼Œå› æ­¤ä¹Ÿæ²¡æœ‰è¢«æ³¨å…¥ã€‚ä½¿ç”¨<code>retransform</code>åŠŸèƒ½å¯ä»¥æ³¨å…¥è¿™äº›å·²åŠ è½½ä½†æœªæ³¨å…¥çš„ç±»ã€‚</p>
<p>ç¬¬äºŒï¼Œåœ¨å®šä¹‰äº†å¤šä¸ª Java agentï¼Œå¤šä¸ªæ³¨å…¥çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ç§»é™¤å…¶ä¸­çš„éƒ¨åˆ†æ³¨å…¥ã€‚å½“è°ƒç”¨<code>Instrumentation.removeTransformer</code>å»é™¤æŸä¸ªæ³¨å…¥ç±»åï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨<code>retransform</code>åŠŸèƒ½ï¼Œé‡æ–°ä»åŸå§‹ byte æ•°ç»„å¼€å§‹è¿›è¡Œæ³¨å…¥ã€‚</p>
<p>Java agent çš„è¿™äº›åŠŸèƒ½éƒ½æ˜¯é€šè¿‡ JVMTI agentï¼Œä¹Ÿå°±æ˜¯ C agent æ¥å®ç°çš„ã€‚JVMTI æ˜¯ä¸€ä¸ªäº‹ä»¶é©±åŠ¨çš„å·¥å…·å®ç°æ¥å£ï¼Œé€šå¸¸ï¼Œæˆ‘ä»¬ä¼šåœ¨ C agent åŠ è½½åçš„å…¥å£æ–¹æ³•<code>Agent_OnLoad</code>å¤„æ³¨å†Œå„ä¸ªäº‹ä»¶çš„é’©å­ï¼ˆhookï¼‰æ–¹æ³•ã€‚å½“ Java è™šæ‹Ÿæœºè§¦å‘äº†è¿™äº›äº‹ä»¶æ—¶ï¼Œä¾¿ä¼šè°ƒç”¨å¯¹åº”çš„é’©å­æ–¹æ³•ã€‚</p>
<pre tabindex="0"><code>JNIEXPORT jint JNICALL
Agent_OnLoad(JavaVM *vm, char *options, void *reserved);
</code></pre><p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥ä¸º JVMTI ä¸­çš„<code>ClassFileLoadHook</code>äº‹ä»¶è®¾ç½®é’©å­ï¼Œä»è€Œåœ¨ C å±‚é¢æ‹¦æˆªæ‰€æœ‰çš„ç±»åŠ è½½äº‹ä»¶ã€‚å…³äº JVMTI çš„å…¶ä»–äº‹ä»¶ï¼Œä½ å¯ä»¥å‚è€ƒè¯¥<a href="https://docs.oracle.com/en/java/javase/11/docs/specs/jvmti.html#EventIndex">é“¾æ¥</a>ã€‚</p>
<h2 id="åŸºäºå­—èŠ‚ç æ³¨å…¥çš„-profiler">åŸºäºå­—èŠ‚ç æ³¨å…¥çš„ profiler</h2>
<p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å­—èŠ‚ç æ³¨å…¥æ¥å®ç°ä»£ç è¦†ç›–å·¥å…·ï¼ˆä¾‹å¦‚<a href="https://www.jacoco.org/jacoco/">JaCoCo</a>ï¼‰ï¼Œæˆ–è€…å„å¼å„æ ·çš„ profilerã€‚</p>
<p>é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šå®šä¹‰ä¸€ä¸ªè¿è¡Œæ—¶ç±»ï¼Œå¹¶åœ¨æŸä¸€ç¨‹åºè¡Œä¸ºçš„å‘¨å›´ï¼Œæ³¨å…¥å¯¹è¯¥è¿è¡Œæ—¶ç±»ä¸­æ–¹æ³•çš„è°ƒç”¨ï¼Œä»¥è¡¨ç¤ºè¯¥ç¨‹åºè¡Œä¸ºæ­£è¦å‘ç”Ÿæˆ–è€…å·²ç»å‘ç”Ÿã€‚</p>
<pre tabindex="0"><code>package org.example;
 
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.atomic.AtomicInteger;
 
public class MyProfiler {
  public static ConcurrentHashMap&lt;Class&lt;?&gt;, AtomicInteger&gt; data = new ConcurrentHashMap&lt;&gt;();
 
  public static void fireAllocationEvent(Class&lt;?&gt; klass) {
    data.computeIfAbsent(klass, kls -&gt; new AtomicInteger())
        .incrementAndGet();
  }
 
  public static void dump() {
    data.forEach((kls, counter) -&gt; {
      System.err.printf(&quot;%s: %d\n&quot;, kls.getName(), counter.get());
    });
  }
 
  static {
    Runtime.getRuntime().addShutdownHook(new Thread(MyProfiler::dump));
  }
}
</code></pre><p>ä¸¾ä¸ªä¾‹å­ï¼Œä¸Šé¢è¿™æ®µä»£ç ä¾¿æ˜¯ä¸€ä¸ªè¿è¡Œæ—¶ç±»ã€‚è¯¥ç±»ç»´æŠ¤äº†ä¸€ä¸ª<code>HashMap</code>ï¼Œç”¨æ¥ç»Ÿè®¡æ¯ä¸ªç±»æ‰€æ–°å»ºå®ä¾‹çš„æ•°ç›®ã€‚å½“ç¨‹åºé€€å‡ºæ—¶ï¼Œæˆ‘ä»¬å°†é€ä¸ªæ‰“å°å‡ºæ¯ä¸ªç±»çš„åå­—ï¼Œä»¥åŠå…¶æ–°å»ºå®ä¾‹çš„æ•°ç›®ã€‚</p>
<p>åœ¨ Java agent ä¸­ï¼Œæˆ‘ä»¬ä¼šæˆªè·æ­£åœ¨åŠ è½½çš„ç±»ï¼Œå¹¶ä¸”åœ¨æ¯æ¡<code>new</code>å­—èŠ‚ç ä¹‹åæ’å…¥å¯¹<code>fireAllocationEvent</code>æ–¹æ³•çš„è°ƒç”¨ï¼Œä»¥è¡¨ç¤ºå½“å‰æ­£åœ¨æ–°å»ºæŸä¸ªç±»çš„å®ä¾‹ã€‚å…·ä½“çš„æ³¨å…¥ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>package org.example;
 
import java.lang.instrument.*;
import java.security.ProtectionDomain;
 
import org.objectweb.asm.*;
import org.objectweb.asm.tree.*;
 
public class MyAgent {
 
  public static void premain(String args, Instrumentation instrumentation) {
    instrumentation.addTransformer(new MyTransformer());
  }
 
  static class MyTransformer implements ClassFileTransformer, Opcodes {
    public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined,
        ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {
      if (className.startsWith(&quot;java&quot;)    ||
          className.startsWith(&quot;javax&quot;)   || 
          className.startsWith(&quot;jdk&quot;)     ||
          className.startsWith(&quot;sun&quot;)     ||
          className.startsWith(&quot;com/sun&quot;) ||
          className.startsWith(&quot;org/example&quot;)) {
        // Skip JDK classes and profiler classes
        return null;
      }
 
      ClassReader cr = new ClassReader(classfileBuffer);
      ClassNode classNode = new ClassNode(ASM7);
      cr.accept(classNode, ClassReader.SKIP_FRAMES);
 
      for (MethodNode methodNode : classNode.methods) {
        for (AbstractInsnNode node : methodNode.instructions.toArray()) {
          if (node.getOpcode() == NEW) {
            TypeInsnNode typeInsnNode = (TypeInsnNode) node;
 
            InsnList instrumentation = new InsnList();
            instrumentation.add(new LdcInsnNode(Type.getObjectType(typeInsnNode.desc)));
            instrumentation.add(new MethodInsnNode(INVOKESTATIC, &quot;org/example/MyProfiler&quot;, &quot;fireAllocationEvent&quot;,
                &quot;(Ljava/lang/Class;)V&quot;, false));
 
            methodNode.instructions.insert(node, instrumentation);
          }
        }
      }
 
      ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES | ClassWriter.COMPUTE_MAXS);
      classNode.accept(cw);
      return cw.toByteArray();
    }
  }
 
}
</code></pre><p>ä½ æˆ–è®¸å·²ç»ç•™æ„åˆ°ï¼Œæˆ‘ä»¬ä¸å¾—ä¸æ’é™¤å¯¹ JDK ç±»ä»¥åŠè¯¥è¿è¡Œæ—¶ç±»çš„æ³¨å…¥ã€‚è¿™æ˜¯å› ä¸ºï¼Œå¯¹è¿™äº›ç±»çš„æ³¨å…¥å¾ˆå¯èƒ½é€ æˆæ­»å¾ªç¯è°ƒç”¨ï¼Œå¹¶æœ€ç»ˆæŠ›å‡º<code>StackOverflowException</code>å¼‚å¸¸ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬åœ¨<code>PrintStream.println</code>æ–¹æ³•å…¥å£å¤„æ³¨å…¥<code>System.out.println(&quot;blahblah&quot;)</code>ï¼Œç”±äº<code>out</code>æ˜¯<code>PrintStream</code>çš„å®ä¾‹ï¼Œå› æ­¤å½“æ‰§è¡Œæ³¨å…¥ä»£ç æ—¶ï¼Œæˆ‘ä»¬åˆä¼šè°ƒç”¨<code>PrintStream.println</code>æ–¹æ³•ï¼Œä»è€Œé€ æˆæ­»å¾ªç¯ã€‚</p>
<p>è§£å†³è¿™ä¸€é—®é¢˜çš„å…³é”®åœ¨äºè®¾ç½®ä¸€ä¸ªçº¿ç¨‹ç§æœ‰çš„æ ‡è¯†ä½ï¼Œç”¨ä»¥åŒºåˆ†åº”ç”¨ä»£ç çš„ä¸Šä¸‹æ–‡ä»¥åŠæ³¨å…¥ä»£ç çš„ä¸Šä¸‹æ–‡ã€‚å½“å³å°†æ‰§è¡Œæ³¨å…¥ä»£ç æ—¶ï¼Œæˆ‘ä»¬å°†æ ¹æ®æ ‡è¯†ä½åˆ¤æ–­æ˜¯å¦å·²ç»ä½äºæ³¨å…¥ä»£ç çš„ä¸Šä¸‹æ–‡ä¹‹ä¸­ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™è®¾ç½®æ ‡è¯†ä½å¹¶æ­£å¸¸æ‰§è¡Œæ³¨å…¥ä»£ç ï¼›å¦‚æœæ˜¯ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä¸å†æ‰§è¡Œæ³¨å…¥ä»£ç ã€‚</p>
<p>å­—èŠ‚ç æ³¨å…¥çš„å¦ä¸€ä¸ªæŠ€æœ¯éš¾ç‚¹åˆ™æ˜¯å‘½åç©ºé—´ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä¸å°‘åº”ç”¨ç¨‹åºéƒ½ä¾èµ–äºå­—èŠ‚ç å·¥ç¨‹åº“ ASMã€‚å½“æˆ‘ä»¬çš„æ³¨å…¥é€»è¾‘ä¾èµ–äº ASM æ—¶ï¼Œä¾¿æœ‰å¯èƒ½å‡ºç°æ³¨å…¥ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ ASMï¼Œè€Œåº”ç”¨ç¨‹åºä½¿ç”¨è¾ƒä½ç‰ˆæœ¬çš„ ASM çš„é—®é¢˜ã€‚</p>
<p>JDK æœ¬èº«ä¹Ÿä½¿ç”¨äº† ASM åº“ï¼Œå¦‚ç”¨æ¥ç”Ÿæˆ Lambda è¡¨è¾¾å¼çš„é€‚é…å™¨ç±»ã€‚JDK çš„åšæ³•æ˜¯é‡å‘½åæ•´ä¸ª ASM åº“ï¼Œä¸ºæ‰€æœ‰ç±»çš„åŒ…åæ·»åŠ <code>jdk.internal</code>å‰ç¼€ã€‚æˆ‘ä»¬æ˜¾ç„¶ä¸å¥½ç›´æ¥æ›´æ”¹ ASM çš„åŒ…åï¼Œå› æ­¤éœ€è¦å€ŸåŠ©è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¥éš”ç¦»å‘½åç©ºé—´ã€‚</p>
<p>é™¤äº†ä¸Šè¿°æŠ€æœ¯éš¾ç‚¹ä¹‹å¤–ï¼ŒåŸºäºå­—èŠ‚ç æ³¨å…¥çš„å·¥å…·è¿˜æœ‰å¦ä¸€ä¸ªé—®é¢˜ï¼Œé‚£ä¾¿æ˜¯è§‚å¯Ÿè€…æ•ˆåº”ï¼ˆobserver effectï¼‰å¯¹æ‰€æ”¶é›†çš„æ•°æ®é€ æˆçš„å½±å“ã€‚</p>
<p>ä¸¾ä¸ªåˆ©ç”¨å­—èŠ‚ç æ³¨å…¥æ”¶é›†æ¯ä¸ªæ–¹æ³•çš„è¿è¡Œæ—¶é—´çš„ä¾‹å­ã€‚å‡è®¾æŸä¸ªæ–¹æ³•è°ƒç”¨äº†å¦ä¸€ä¸ªæ–¹æ³•ï¼Œè€Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½è¢«æ³¨å…¥äº†ï¼Œé‚£ä¹ˆç»Ÿè®¡è¢«è°ƒç”¨è€…è¿è¡Œæ—¶é—´çš„æ³¨å…¥ä»£ç æ‰€è€—è´¹çš„æ—¶é—´ï¼Œå°†ä¸å¯é¿å…åœ°è¢«è®¡å…¥è‡³è°ƒç”¨è€…æ–¹æ³•çš„è¿è¡Œæ—¶é—´ä¹‹ä¸­ã€‚</p>
<p>å†ä¸¾ä¸€ä¸ªç»Ÿè®¡æ–°å»ºå¯¹è±¡æ•°ç›®çš„ä¾‹å­ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œå³æ—¶ç¼–è¯‘å™¨ä¸­çš„é€ƒé€¸åˆ†æå¯èƒ½ä¼šä¼˜åŒ–æ‰æ–°å»ºå¯¹è±¡æ“ä½œï¼Œä½†å®ƒä¸ä¼šæ¶ˆé™¤ç›¸åº”çš„ç»Ÿè®¡æ“ä½œï¼Œæ¯”å¦‚ä¸Šè¿°ä¾‹å­ä¸­å¯¹<code>fireAllocationEvent</code>æ–¹æ³•çš„è°ƒç”¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†ç»Ÿè®¡æ²¡æœ‰å®é™…å‘ç”Ÿçš„æ–°å»ºå¯¹è±¡æ“ä½œã€‚</p>
<p>å¦ä¸€ç§æƒ…å†µåˆ™æ˜¯ï¼Œæˆ‘ä»¬æ‰€æ³¨å…¥çš„å¯¹<code>fireAllocationEvent</code>æ–¹æ³•çš„è°ƒç”¨ï¼Œå°†å½±å“åˆ°æ–¹æ³•å†…è”çš„å†³ç­–ã€‚å¦‚æœè¯¥æ–°å»ºå¯¹è±¡çš„æ„é€ å™¨è°ƒç”¨æ°å¥½å› æ­¤æ²¡æœ‰è¢«å†…è”ï¼Œä»è€Œé€ æˆå¯¹è±¡é€ƒé€¸ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒåŸæœ¬èƒ½å¤Ÿè¢«é€ƒé€¸åˆ†æä¼˜åŒ–æ‰çš„æ–°å»ºå¯¹è±¡æ“ä½œå°†æ— æ³•ä¼˜åŒ–ï¼Œæˆ‘ä»¬ä¹Ÿå°†ç»Ÿè®¡åˆ°åŸæœ¬ä¸ä¼šå‘ç”Ÿçš„æ–°å»ºå¯¹è±¡æ“ä½œã€‚</p>
<p>æ€»è€Œè¨€ä¹‹ï¼Œå½“ä½¿ç”¨å­—èŠ‚ç æ³¨å…¥å¼€å‘ profiler æ—¶ï¼Œéœ€è¦è¾©è¯åœ°çœ‹å¾…æ‰€æ”¶é›†çš„æ•°æ®ã€‚å®ƒä»…èƒ½è¡¨ç¤ºåœ¨è¢«æ³¨å…¥çš„æƒ…å†µä¸‹ç¨‹åºçš„æ‰§è¡ŒçŠ¶æ€ï¼Œè€Œéæ²¡æœ‰æ³¨å…¥æƒ…å†µä¸‹çš„ç¨‹åºæ‰§è¡ŒçŠ¶æ€ã€‚</p>
<h2 id="é¢å‘æ–¹é¢ç¼–ç¨‹">é¢å‘æ–¹é¢ç¼–ç¨‹</h2>
<p>è¯´åˆ°å­—èŠ‚ç æ³¨å…¥ï¼Œå°±ä¸å¾—ä¸æé¢å‘æ–¹é¢ç¼–ç¨‹ï¼ˆAspect-Oriented Programmingï¼ŒAOPï¼‰ã€‚é¢å‘æ–¹é¢ç¼–ç¨‹çš„æ ¸å¿ƒç†å¿µæ˜¯å®šä¹‰åˆ‡å…¥ç‚¹ï¼ˆpointcutï¼‰ä»¥åŠé€šçŸ¥ï¼ˆadviceï¼‰ã€‚ç¨‹åºæ§åˆ¶æµä¸­æ‰€æœ‰åŒ¹é…è¯¥åˆ‡å…¥ç‚¹çš„è¿æ¥ç‚¹ï¼ˆjoinpointï¼‰éƒ½å°†æ‰§è¡Œè¿™æ®µé€šçŸ¥ä»£ç ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæŒ‡ä»£æ‰€æœ‰æ–¹æ³•å…¥å£çš„åˆ‡å…¥ç‚¹ï¼Œå¹¶æŒ‡å®šåœ¨è¯¥åˆ‡å…¥ç‚¹æ‰§è¡Œçš„â€œæ‰“å°è¯¥æ–¹æ³•çš„åå­—â€è¿™ä¸€é€šçŸ¥ã€‚é‚£ä¹ˆæ¯ä¸ªå…·ä½“çš„æ–¹æ³•å…¥å£ä¾¿æ˜¯ä¸€ä¸ªè¿æ¥ç‚¹ã€‚</p>
<p>é¢å‘æ–¹é¢ç¼–ç¨‹çš„å…¶ä¸­ä¸€ç§å®ç°æ–¹å¼ä¾¿æ˜¯å­—èŠ‚ç æ³¨å…¥ï¼Œæ¯”å¦‚<a href="https://www.eclipse.org/aspectj/">AspectJ</a>ã€‚</p>
<p>åœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿç›¸å½“äºä½¿ç”¨äº†é¢å‘æ–¹é¢ç¼–ç¨‹ï¼Œåœ¨æ‰€æœ‰çš„<code>new</code>å­—èŠ‚ç ä¹‹åæ‰§è¡Œäº†ä¸‹é¢è¿™æ ·ä¸€æ®µé€šçŸ¥ä»£ç ã€‚</p>
<pre tabindex="0"><code>`MyProfiler.fireAllocationEvent(&lt;Target&gt;.class)`
</code></pre><p>æˆ‘æ›¾ç»å‚ä¸å¼€å‘è¿‡ä¸€ä¸ªåº”ç”¨äº†é¢å‘æ–¹é¢ç¼–ç¨‹æ€æƒ³çš„å­—èŠ‚ç æ³¨å…¥æ¡†æ¶<a href="https://disl.ow2.org/">DiSL</a>ã€‚å®ƒæ”¯æŒç”¨æ³¨è§£æ¥å®šä¹‰åˆ‡å…¥ç‚¹ï¼Œç”¨æ™®é€š Java æ–¹æ³•æ¥å®šä¹‰é€šçŸ¥ã€‚ä¾‹å¦‚ï¼Œåœ¨æ–¹æ³•å…¥å£å¤„æ‰“å°æ‰€åœ¨çš„æ–¹æ³•åï¼Œå¯ä»¥ç®€å•è¡¨ç¤ºä¸ºå¦‚ä¸‹ä»£ç ï¼š</p>
<pre tabindex="0"><code>@Before(marker = BodyMarker.class)
static void onMethodEntry(MethodStaticContext msc) {
  System.out.println(msc.thisMethodFullName());
}
</code></pre><p>å¦‚æœæœ‰åŒå­¦å¯¹è¿™ä¸ªå·¥å…·æ„Ÿå…´è¶£ï¼Œæˆ–è€…æœ‰ä»€ä¹ˆéœ€æ±‚æˆ–è€…å»ºè®®ï¼Œæ¬¢è¿ä½ åœ¨ç•™è¨€ä¸­æå‡ºã€‚</p>
<h2 id="æ€»ç»“ä¸å®è·µ">æ€»ç»“ä¸å®è·µ</h2>
<p>ä»Šå¤©æˆ‘ä»‹ç»äº† Java agent ä»¥åŠå­—èŠ‚ç æ³¨å…¥ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ Java agent çš„ç±»åŠ è½½æ‹¦æˆªåŠŸèƒ½ï¼Œä¿®æ”¹æŸä¸ªç±»æ‰€å¯¹åº”çš„ byte æ•°ç»„ï¼Œå¹¶åˆ©ç”¨è¿™ä¸ªä¿®æ”¹è¿‡åçš„ byte æ•°ç»„å®Œæˆæ¥ä¸‹æ¥çš„ç±»åŠ è½½ã€‚</p>
<p>åŸºäºå­—èŠ‚ç æ³¨å…¥çš„ profilerï¼Œå¯ä»¥ç»Ÿè®¡ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­æŸäº›è¡Œä¸ºçš„å‡ºç°æ¬¡æ•°ã€‚å¦‚æœéœ€è¦æ”¶é›† Java æ ¸å¿ƒç±»åº“çš„æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦å°å¿ƒé¿å…æ— é™é€’å½’è°ƒç”¨ã€‚å¦å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€é€šè¿‡è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¥è§£å†³å‘½åç©ºé—´çš„é—®é¢˜ã€‚</p>
<p>ç”±äºå­—èŠ‚ç æ³¨å…¥ä¼šäº§ç”Ÿè§‚å¯Ÿè€…æ•ˆåº”ï¼Œå› æ­¤åŸºäºè¯¥æŠ€æœ¯çš„ profiler æ‰€æ”¶é›†åˆ°çš„æ•°æ®å¹¶ä¸èƒ½åæ˜ ç¨‹åºçš„çœŸå®è¿è¡ŒçŠ¶æ€ã€‚å®ƒæ‰€åæ˜ çš„æ˜¯ç¨‹åºåœ¨è¢«æ³¨å…¥çš„æƒ…å†µä¸‹çš„æ‰§è¡ŒçŠ¶æ€ã€‚</p>
<hr>
<p>ä»Šå¤©çš„å®è·µç¯èŠ‚ï¼Œè¯·ä½ æ€è€ƒå¦‚ä½•æ³¨å…¥æ–¹æ³•å‡ºå£ã€‚é™¤äº†æ­£å¸¸æ‰§è¡Œè·¯å¾„ä¹‹å¤–ï¼Œä½ è¿˜éœ€è€ƒè™‘å¼‚å¸¸æ‰§è¡Œè·¯å¾„ã€‚</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/32-jni%E7%9A%84%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/"><span>32 JNIçš„è¿è¡Œæœºåˆ¶</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/34-graal%E7%94%A8java%E7%BC%96%E8%AF%91java/"><span>34 Graalï¼šç”¨Javaç¼–è¯‘Java</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 28280 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>