<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>09 JVMæ˜¯æ€ä¹ˆå®ç°invokedynamicçš„ï¼Ÿï¼ˆä¸‹ï¼‰ | Yipsen Ye</title>
<meta name="description" content="ä¸Šå›è®²åˆ°ï¼Œä¸ºäº†è®©æ‰€æœ‰çš„åŠ¨ç‰©éƒ½èƒ½å‚åŠ èµ›é©¬ï¼ŒJava 7 å¼•å…¥äº† invokedynamic æœºåˆ¶ï¼Œå…è®¸è°ƒç”¨ä»»æ„ç±»çš„â€œèµ›è·‘â€æ–¹æ³•ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰è®²è§£ invokedynamicï¼Œè€Œæ˜¯æ·±å…¥åœ°æ¢è®¨äº†å®ƒæ‰€ä¾èµ–çš„æ–¹æ³•å¥æŸ„ã€‚
ä»Šå¤©ï¼Œæˆ‘ä¾¿æ¥æ­£å¼åœ°ä»‹ç» invokedynamic æŒ‡ä»¤ï¼Œè®²è®²å®ƒæ˜¯å¦‚ä½•ç”Ÿæˆè°ƒç”¨ç‚¹ï¼Œå¹¶ä¸”å…è®¸åº”ç”¨ç¨‹åºè‡ªå·±å†³å®šé“¾æ¥è‡³å“ªä¸€ä¸ªæ–¹æ³•ä¸­çš„ã€‚
invokedynamic æŒ‡ä»¤ invokedynamic æ˜¯ Java 7 å¼•å…¥çš„ä¸€æ¡æ–°æŒ‡ä»¤ï¼Œç”¨ä»¥æ”¯æŒåŠ¨æ€è¯­è¨€çš„æ–¹æ³•è°ƒç”¨ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒå°†è°ƒç”¨ç‚¹ï¼ˆCallSiteï¼‰æŠ½è±¡æˆä¸€ä¸ª Java ç±»ï¼Œå¹¶ä¸”å°†åŸæœ¬ç”± Java è™šæ‹Ÿæœºæ§åˆ¶çš„æ–¹æ³•è°ƒç”¨ä»¥åŠæ–¹æ³•é“¾æ¥æš´éœ²ç»™äº†åº”ç”¨ç¨‹åºã€‚åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæ¯ä¸€æ¡ invokedynamic æŒ‡ä»¤å°†æ†ç»‘ä¸€ä¸ªè°ƒç”¨ç‚¹ï¼Œå¹¶ä¸”ä¼šè°ƒç”¨è¯¥è°ƒç”¨ç‚¹æ‰€é“¾æ¥çš„æ–¹æ³•å¥æŸ„ã€‚
åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œ invokedynamic æŒ‡ä»¤æ—¶ï¼ŒJava è™šæ‹Ÿæœºä¼šè°ƒç”¨è¯¥æŒ‡ä»¤æ‰€å¯¹åº”çš„å¯åŠ¨æ–¹æ³•ï¼ˆBootStrap Methodï¼‰ï¼Œæ¥ç”Ÿæˆå‰é¢æåˆ°çš„è°ƒç”¨ç‚¹ï¼Œå¹¶ä¸”å°†ä¹‹ç»‘å®šè‡³è¯¥ invokedynamic æŒ‡ä»¤ä¸­ã€‚åœ¨ä¹‹åçš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒJava è™šæ‹Ÿæœºåˆ™ä¼šç›´æ¥è°ƒç”¨ç»‘å®šçš„è°ƒç”¨ç‚¹æ‰€é“¾æ¥çš„æ–¹æ³•å¥æŸ„ã€‚
åœ¨å­—èŠ‚ç ä¸­ï¼Œå¯åŠ¨æ–¹æ³•æ˜¯ç”¨æ–¹æ³•å¥æŸ„æ¥æŒ‡å®šçš„ã€‚è¿™ä¸ªæ–¹æ³•å¥æŸ„æŒ‡å‘ä¸€ä¸ªè¿”å›ç±»å‹ä¸ºè°ƒç”¨ç‚¹çš„é™æ€æ–¹æ³•ã€‚è¯¥æ–¹æ³•å¿…é¡»æ¥æ”¶ä¸‰ä¸ªå›ºå®šçš„å‚æ•°ï¼Œåˆ†åˆ«ä¸ºä¸€ä¸ª Lookup ç±»å®ä¾‹ï¼Œä¸€ä¸ªç”¨æ¥æŒ‡ä»£ç›®æ ‡æ–¹æ³•åå­—çš„å­—ç¬¦ä¸²ï¼Œä»¥åŠè¯¥è°ƒç”¨ç‚¹èƒ½å¤Ÿé“¾æ¥çš„æ–¹æ³•å¥æŸ„çš„ç±»å‹ã€‚
é™¤äº†è¿™ä¸‰ä¸ªå¿…éœ€å‚æ•°ä¹‹å¤–ï¼Œå¯åŠ¨æ–¹æ³•è¿˜å¯ä»¥æ¥æ”¶è‹¥å¹²ä¸ªå…¶ä»–çš„å‚æ•°ï¼Œç”¨æ¥è¾…åŠ©ç”Ÿæˆè°ƒç”¨ç‚¹ï¼Œæˆ–è€…å®šä½æ‰€è¦é“¾æ¥çš„ç›®æ ‡æ–¹æ³•ã€‚
import java.lang.invoke.*;class Horse {public void race() {System.out.println(&amp;quot;Horse.race()&amp;quot;); }}class Deer {public void race() {System.out.println(&amp;quot;Deer.race()&amp;quot;);}}// javac Circuit.java// java Circuitpublic class Circuit {public static void startRace(Object obj) {// aload obj// invokedynamic race()}public static void main(String[] args) {startRace(new Horse());// startRace(new Deer());}public static CallSite bootstrap(MethodHandles.">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="nav-logo">
    <a href="http://yipsen.github.io/">
        
        <span class="nav-title">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æ–‡ç« </a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/%e6%b7%b1%e5%85%a5%e6%8b%86%e8%a7%a3java%e8%99%9a%e6%8b%9f%e6%9c%ba/">æ·±å…¥æ‹†è§£Javaè™šæ‹Ÿæœº</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/00-%E5%BC%80%E7%AF%87%E8%AF%8D-%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E4%BB%AC%E8%A6%81%E5%AD%A6%E4%B9%A0java%E8%99%9A%E6%8B%9F%E6%9C%BA/">00 å¼€ç¯‡è¯ ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦å­¦ä¹ Javaè™šæ‹Ÿæœºï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/01-java%E4%BB%A3%E7%A0%81%E6%98%AF%E6%80%8E%E4%B9%88%E8%BF%90%E8%A1%8C%E7%9A%84/">01 Javaä»£ç æ˜¯æ€ä¹ˆè¿è¡Œçš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/02-java%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/">02 Javaçš„åŸºæœ¬ç±»å‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/03-java%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%98%AF%E5%A6%82%E4%BD%95%E5%8A%A0%E8%BD%BDjava%E7%B1%BB%E7%9A%84/">03 Javaè™šæ‹Ÿæœºæ˜¯å¦‚ä½•åŠ è½½Javaç±»çš„</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/04-jvm%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E7%9A%84%E4%B8%8A/">04 JVMæ˜¯å¦‚ä½•æ‰§è¡Œæ–¹æ³•è°ƒç”¨çš„ï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/05-jvm%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E7%9A%84%E4%B8%8B/">05 JVMæ˜¯å¦‚ä½•æ‰§è¡Œæ–¹æ³•è°ƒç”¨çš„ï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/06-jvm%E6%98%AF%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E5%BC%82%E5%B8%B8%E7%9A%84/">06 JVMæ˜¯å¦‚ä½•å¤„ç†å¼‚å¸¸çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/07-jvm%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%8F%8D%E5%B0%84%E7%9A%84/">07 JVMæ˜¯å¦‚ä½•å®ç°åå°„çš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/08-jvm%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0invokedynamic%E7%9A%84%E4%B8%8A/">08 JVMæ˜¯æ€ä¹ˆå®ç°invokedynamicçš„ï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li>09 JVMæ˜¯æ€ä¹ˆå®ç°invokedynamicçš„ï¼Ÿï¼ˆä¸‹ï¼‰</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/10-java%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/">10 Javaå¯¹è±¡çš„å†…å­˜å¸ƒå±€</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/11-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E4%B8%8A/">11 åƒåœ¾å›æ”¶ï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/12-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E4%B8%8B/">12 åƒåœ¾å›æ”¶ï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/13-java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/">13 Javaå†…å­˜æ¨¡å‹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/14-java%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0synchronized%E7%9A%84/">14 Javaè™šæ‹Ÿæœºæ˜¯æ€ä¹ˆå®ç°synchronizedçš„ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/15-java%E8%AF%AD%E6%B3%95%E7%B3%96%E4%B8%8Ejava%E7%BC%96%E8%AF%91%E5%99%A8/">15 Javaè¯­æ³•ç³–ä¸Javaç¼–è¯‘å™¨</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/16-%E5%8D%B3%E6%97%B6%E7%BC%96%E8%AF%91%E4%B8%8A/">16 å³æ—¶ç¼–è¯‘ï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/17-%E5%8D%B3%E6%97%B6%E7%BC%96%E8%AF%91%E4%B8%8B/">17 å³æ—¶ç¼–è¯‘ï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/18-%E5%8D%B3%E6%97%B6%E7%BC%96%E8%AF%91%E5%99%A8%E7%9A%84%E4%B8%AD%E9%97%B4%E8%A1%A8%E8%BE%BE%E5%BD%A2%E5%BC%8F/">18 å³æ—¶ç¼–è¯‘å™¨çš„ä¸­é—´è¡¨è¾¾å½¢å¼</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/19-java%E5%AD%97%E8%8A%82%E7%A0%81%E5%9F%BA%E7%A1%80%E7%AF%87/">19 Javaå­—èŠ‚ç ï¼ˆåŸºç¡€ç¯‡ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/20-%E6%96%B9%E6%B3%95%E5%86%85%E8%81%94%E4%B8%8A/">20 æ–¹æ³•å†…è”ï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/21-%E6%96%B9%E6%B3%95%E5%86%85%E8%81%94%E4%B8%8B/">21 æ–¹æ³•å†…è”ï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/22-hotspot%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84intrinsic/">22 HotSpotè™šæ‹Ÿæœºçš„intrinsic</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/23-%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/">23 é€ƒé€¸åˆ†æ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/24-%E5%AD%97%E6%AE%B5%E8%AE%BF%E9%97%AE%E7%9B%B8%E5%85%B3%E4%BC%98%E5%8C%96/">24 å­—æ®µè®¿é—®ç›¸å…³ä¼˜åŒ–</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/25-%E5%BE%AA%E7%8E%AF%E4%BC%98%E5%8C%96/">25 å¾ªç¯ä¼˜åŒ–</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/26-%E5%90%91%E9%87%8F%E5%8C%96/">26 å‘é‡åŒ–</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/27-%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E5%99%A8/">27 æ³¨è§£å¤„ç†å™¨</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/28-%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6jmh%E4%B8%8A/">28 åŸºå‡†æµ‹è¯•æ¡†æ¶JMHï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/29-%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6jmh%E4%B8%8B/">29 åŸºå‡†æµ‹è¯•æ¡†æ¶JMHï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/30-java%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E7%9B%91%E6%8E%A7%E5%8F%8A%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%AF%87/">30 Javaè™šæ‹Ÿæœºçš„ç›‘æ§åŠè¯Šæ–­å·¥å…·ï¼ˆå‘½ä»¤è¡Œç¯‡ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/31-java%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E7%9B%91%E6%8E%A7%E5%8F%8A%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7gui%E7%AF%87/">31 Javaè™šæ‹Ÿæœºçš„ç›‘æ§åŠè¯Šæ–­å·¥å…·ï¼ˆGUIç¯‡ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/32-jni%E7%9A%84%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/">32 JNIçš„è¿è¡Œæœºåˆ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/33-java-agent%E4%B8%8E%E5%AD%97%E8%8A%82%E7%A0%81%E6%B3%A8%E5%85%A5/">33 Java Agentä¸å­—èŠ‚ç æ³¨å…¥</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/34-graal%E7%94%A8java%E7%BC%96%E8%AF%91java/">34 Graalï¼šç”¨Javaç¼–è¯‘Java</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/35-truffle%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0%E6%A1%86%E6%9E%B6/">35 Truffleï¼šè¯­è¨€å®ç°æ¡†æ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/36-substratevmaot%E7%BC%96%E8%AF%91%E6%A1%86%E6%9E%B6/">36 SubstrateVMï¼šAOTç¼–è¯‘æ¡†æ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/%E5%B0%BE%E5%A3%B0%E4%B8%A8%E9%81%93%E9%98%BB%E4%B8%94%E9%95%BF%E5%8A%AA%E5%8A%9B%E5%8A%A0%E9%A4%90.html/">å°¾å£°ä¸¨é“é˜»ä¸”é•¿ï¼ŒåŠªåŠ›åŠ é¤.html</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/%E5%B7%A5%E5%85%B7%E7%AF%87-%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D/">å·¥å…·ç¯‡ å¸¸ç”¨å·¥å…·ä»‹ç»</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">09 JVMæ˜¯æ€ä¹ˆå®ç°invokedynamicçš„ï¼Ÿï¼ˆä¸‹ï¼‰</h1>
        <div class="post-info">
            <div class="post-date"> 
                <span>2022-01-09 11:10:58</span>
            </div>
        </div>
        <div class="post-content">
            <p>ä¸Šå›è®²åˆ°ï¼Œä¸ºäº†è®©æ‰€æœ‰çš„åŠ¨ç‰©éƒ½èƒ½å‚åŠ èµ›é©¬ï¼ŒJava 7 å¼•å…¥äº† invokedynamic æœºåˆ¶ï¼Œå…è®¸è°ƒç”¨ä»»æ„ç±»çš„â€œèµ›è·‘â€æ–¹æ³•ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰è®²è§£ invokedynamicï¼Œè€Œæ˜¯æ·±å…¥åœ°æ¢è®¨äº†å®ƒæ‰€ä¾èµ–çš„æ–¹æ³•å¥æŸ„ã€‚</p>
<p>ä»Šå¤©ï¼Œæˆ‘ä¾¿æ¥æ­£å¼åœ°ä»‹ç» invokedynamic æŒ‡ä»¤ï¼Œè®²è®²å®ƒæ˜¯å¦‚ä½•ç”Ÿæˆè°ƒç”¨ç‚¹ï¼Œå¹¶ä¸”å…è®¸åº”ç”¨ç¨‹åºè‡ªå·±å†³å®šé“¾æ¥è‡³å“ªä¸€ä¸ªæ–¹æ³•ä¸­çš„ã€‚</p>
<h2 id="invokedynamic-æŒ‡ä»¤">invokedynamic æŒ‡ä»¤</h2>
<p>invokedynamic æ˜¯ Java 7 å¼•å…¥çš„ä¸€æ¡æ–°æŒ‡ä»¤ï¼Œç”¨ä»¥æ”¯æŒåŠ¨æ€è¯­è¨€çš„æ–¹æ³•è°ƒç”¨ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒå°†è°ƒç”¨ç‚¹ï¼ˆCallSiteï¼‰æŠ½è±¡æˆä¸€ä¸ª Java ç±»ï¼Œå¹¶ä¸”å°†åŸæœ¬ç”± Java è™šæ‹Ÿæœºæ§åˆ¶çš„æ–¹æ³•è°ƒç”¨ä»¥åŠæ–¹æ³•é“¾æ¥æš´éœ²ç»™äº†åº”ç”¨ç¨‹åºã€‚åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæ¯ä¸€æ¡ invokedynamic æŒ‡ä»¤å°†æ†ç»‘ä¸€ä¸ªè°ƒç”¨ç‚¹ï¼Œå¹¶ä¸”ä¼šè°ƒç”¨è¯¥è°ƒç”¨ç‚¹æ‰€é“¾æ¥çš„æ–¹æ³•å¥æŸ„ã€‚</p>
<p>åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œ invokedynamic æŒ‡ä»¤æ—¶ï¼ŒJava è™šæ‹Ÿæœºä¼šè°ƒç”¨è¯¥æŒ‡ä»¤æ‰€å¯¹åº”çš„å¯åŠ¨æ–¹æ³•ï¼ˆBootStrap Methodï¼‰ï¼Œæ¥ç”Ÿæˆå‰é¢æåˆ°çš„è°ƒç”¨ç‚¹ï¼Œå¹¶ä¸”å°†ä¹‹ç»‘å®šè‡³è¯¥ invokedynamic æŒ‡ä»¤ä¸­ã€‚åœ¨ä¹‹åçš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒJava è™šæ‹Ÿæœºåˆ™ä¼šç›´æ¥è°ƒç”¨ç»‘å®šçš„è°ƒç”¨ç‚¹æ‰€é“¾æ¥çš„æ–¹æ³•å¥æŸ„ã€‚</p>
<p>åœ¨å­—èŠ‚ç ä¸­ï¼Œå¯åŠ¨æ–¹æ³•æ˜¯ç”¨æ–¹æ³•å¥æŸ„æ¥æŒ‡å®šçš„ã€‚è¿™ä¸ªæ–¹æ³•å¥æŸ„æŒ‡å‘ä¸€ä¸ªè¿”å›ç±»å‹ä¸ºè°ƒç”¨ç‚¹çš„é™æ€æ–¹æ³•ã€‚è¯¥æ–¹æ³•å¿…é¡»æ¥æ”¶ä¸‰ä¸ªå›ºå®šçš„å‚æ•°ï¼Œåˆ†åˆ«ä¸ºä¸€ä¸ª Lookup ç±»å®ä¾‹ï¼Œä¸€ä¸ªç”¨æ¥æŒ‡ä»£ç›®æ ‡æ–¹æ³•åå­—çš„å­—ç¬¦ä¸²ï¼Œä»¥åŠè¯¥è°ƒç”¨ç‚¹èƒ½å¤Ÿé“¾æ¥çš„æ–¹æ³•å¥æŸ„çš„ç±»å‹ã€‚</p>
<p>é™¤äº†è¿™ä¸‰ä¸ªå¿…éœ€å‚æ•°ä¹‹å¤–ï¼Œå¯åŠ¨æ–¹æ³•è¿˜å¯ä»¥æ¥æ”¶è‹¥å¹²ä¸ªå…¶ä»–çš„å‚æ•°ï¼Œç”¨æ¥è¾…åŠ©ç”Ÿæˆè°ƒç”¨ç‚¹ï¼Œæˆ–è€…å®šä½æ‰€è¦é“¾æ¥çš„ç›®æ ‡æ–¹æ³•ã€‚</p>
<pre tabindex="0"><code>import java.lang.invoke.*;
 
class Horse {
  public void race() {
    System.out.println(&quot;Horse.race()&quot;); 
  }
}
 
class Deer {
  public void race() {
    System.out.println(&quot;Deer.race()&quot;);
  }
}
 
// javac Circuit.java
// java Circuit
public class Circuit {
 
  public static void startRace(Object obj) {
    // aload obj
    // invokedynamic race()
  }
 
  public static void main(String[] args) {
    startRace(new Horse());
    // startRace(new Deer());
  }
  
  public static CallSite bootstrap(MethodHandles.Lookup l, String name, MethodType callSiteType) throws Throwable {
    MethodHandle mh = l.findVirtual(Horse.class, name, MethodType.methodType(void.class));
    return new ConstantCallSite(mh.asType(callSiteType));
  }
}
</code></pre><p>æˆ‘åœ¨æ–‡ç¨¿ä¸­è´´äº†ä¸€æ®µä»£ç ï¼Œå…¶ä¸­ä¾¿åŒ…å«ä¸€ä¸ªå¯åŠ¨æ–¹æ³•ã€‚å®ƒå°†æ¥æ”¶å‰é¢æåˆ°çš„ä¸‰ä¸ªå›ºå®šå‚æ•°ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªé“¾æ¥è‡³ Horse.race æ–¹æ³•çš„ ConstantCallSiteã€‚</p>
<p>è¿™é‡Œçš„ ConstantCallSite æ˜¯ä¸€ç§ä¸å¯ä»¥æ›´æ”¹é“¾æ¥å¯¹è±¡çš„è°ƒç”¨ç‚¹ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒJava æ ¸å¿ƒç±»åº“è¿˜æä¾›å¤šç§å¯ä»¥æ›´æ”¹é“¾æ¥å¯¹è±¡çš„è°ƒç”¨ç‚¹ï¼Œæ¯”å¦‚ MutableCallSite å’Œ VolatileCallSiteã€‚</p>
<p>è¿™ä¸¤è€…çš„åŒºåˆ«å°±å¥½æ¯”æ­£å¸¸å­—æ®µå’Œ volatile å­—æ®µä¹‹é—´çš„åŒºåˆ«ã€‚æ­¤å¤–ï¼Œåº”ç”¨ç¨‹åºè¿˜å¯ä»¥è‡ªå®šä¹‰è°ƒç”¨ç‚¹ç±»ï¼Œæ¥æ»¡è¶³ç‰¹å®šçš„é‡é“¾æ¥éœ€æ±‚ã€‚</p>
<p>ç”±äº Java æš‚ä¸æ”¯æŒç›´æ¥ç”Ÿæˆ invokedynamic æŒ‡ä»¤ [1]ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä¼šå€ŸåŠ©ä¹‹å‰ä»‹ç»è¿‡çš„å­—èŠ‚ç å·¥å…· ASM æ¥å®ç°è¿™ä¸€ç›®çš„ã€‚</p>
<pre tabindex="0"><code>import java.io.IOException;
import java.lang.invoke.*;
import java.nio.file.*;
 
import org.objectweb.asm.*;
 
// javac -cp /path/to/asm-all-6.0_BETA.jar:. ASMHelper.java
// java -cp /path/to/asm-all-6.0_BETA.jar:. ASMHelper
// java Circuit
public class ASMHelper implements Opcodes {
 
  private static class MyMethodVisitor extends MethodVisitor {
 
    private static final String BOOTSTRAP_CLASS_NAME = Circuit.class.getName().replace('.', '/');
    private static final String BOOTSTRAP_METHOD_NAME = &quot;bootstrap&quot;;
    private static final String BOOTSTRAP_METHOD_DESC = MethodType
        .methodType(CallSite.class, MethodHandles.Lookup.class, String.class, MethodType.class)
        .toMethodDescriptorString();
 
    private static final String TARGET_METHOD_NAME = &quot;race&quot;;
    private static final String TARGET_METHOD_DESC = &quot;(Ljava/lang/Object;)V&quot;;
 
    public final MethodVisitor mv;
 
    public MyMethodVisitor(int api, MethodVisitor mv) {
      super(api);
      this.mv = mv;
    }
 
    @Override
    public void visitCode() {
      mv.visitCode();
      mv.visitVarInsn(ALOAD, 0);
      Handle h = new Handle(H_INVOKESTATIC, BOOTSTRAP_CLASS_NAME, BOOTSTRAP_METHOD_NAME, BOOTSTRAP_METHOD_DESC, false);
      mv.visitInvokeDynamicInsn(TARGET_METHOD_NAME, TARGET_METHOD_DESC, h);
      mv.visitInsn(RETURN);
      mv.visitMaxs(1, 1);
      mv.visitEnd();
    }
  }
 
  public static void main(String[] args) throws IOException {
    ClassReader cr = new ClassReader(&quot;Circuit&quot;);
    ClassWriter cw = new ClassWriter(cr, ClassWriter.COMPUTE_FRAMES);
    ClassVisitor cv = new ClassVisitor(ASM6, cw) {
      @Override
      public MethodVisitor visitMethod(int access, String name, String descriptor, String signature,
          String[] exceptions) {
        MethodVisitor visitor = super.visitMethod(access, name, descriptor, signature, exceptions);
        if (&quot;startRace&quot;.equals(name)) {
          return new MyMethodVisitor(ASM6, visitor);
        }
        return visitor;
      }
    };
    cr.accept(cv, ClassReader.SKIP_FRAMES);
 
    Files.write(Paths.get(&quot;Circuit.class&quot;), cw.toByteArray());
  }
}
</code></pre><p>ä½ æ— éœ€ç†è§£ä¸Šé¢è¿™æ®µä»£ç çš„å…·ä½“å«ä¹‰ï¼Œåªé¡»äº†è§£å®ƒä¼šæ›´æ”¹åŒä¸€ç›®å½•ä¸‹ Circuit ç±»çš„ startRace(Object) æ–¹æ³•ï¼Œä½¿ä¹‹åŒ…å« invokedynamic æŒ‡ä»¤ï¼Œæ‰§è¡Œæ‰€è°“çš„èµ›è·‘æ–¹æ³•ã€‚</p>
<pre tabindex="0"><code> public static void startRace(java.lang.Object);
         0: aload_0
         1: invokedynamic #80,  0 // race:(Ljava/lang/Object;)V
         6: return
</code></pre><p>å¦‚æœä½ è¶³å¤Ÿç»†å¿ƒçš„è¯ï¼Œä½ ä¼šå‘ç°è¯¥æŒ‡ä»¤æ‰€è°ƒç”¨çš„èµ›è·‘æ–¹æ³•çš„æè¿°ç¬¦ï¼Œå’Œ Horse.race æ–¹æ³•æˆ–è€… Deer.race æ–¹æ³•çš„æè¿°ç¬¦å¹¶ä¸ä¸€è‡´ã€‚è¿™æ˜¯å› ä¸º invokedynamic æŒ‡ä»¤æœ€ç»ˆè°ƒç”¨çš„æ˜¯æ–¹æ³•å¥æŸ„ï¼Œè€Œæ–¹æ³•å¥æŸ„ä¼šå°†è°ƒç”¨è€…å½“æˆç¬¬ä¸€ä¸ªå‚æ•°ã€‚å› æ­¤ï¼Œåˆšåˆšæåˆ°çš„é‚£ä¸¤ä¸ªæ–¹æ³•æ°æ°ç¬¦åˆè¿™ä¸ªæè¿°ç¬¦æ‰€å¯¹åº”çš„æ–¹æ³•å¥æŸ„ç±»å‹ã€‚</p>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥é€šè¿‡ invokedynamic è°ƒç”¨ Horse.race æ–¹æ³•äº†ã€‚ä¸ºäº†æ”¯æŒè°ƒç”¨ä»»æ„ç±»çš„ race æ–¹æ³•ï¼Œæˆ‘å®ç°äº†ä¸€ä¸ªç®€å•çš„å•æ€å†…è”ç¼“å­˜ã€‚å¦‚æœè°ƒç”¨è€…çš„ç±»å‹å‘½ä¸­ç¼“å­˜ä¸­çš„ç±»å‹ï¼Œä¾¿ç›´æ¥è°ƒç”¨ç¼“å­˜ä¸­çš„æ–¹æ³•å¥æŸ„ï¼Œå¦åˆ™ä¾¿æ›´æ–°ç¼“å­˜ã€‚</p>
<pre tabindex="0"><code>// éœ€è¦æ›´æ”¹ ASMHelper.MyMethodVisitor ä¸­çš„ BOOTSTRAP_CLASS_NAME
import java.lang.invoke.*;
 
public class MonomorphicInlineCache {
 
  private final MethodHandles.Lookup lookup;
  private final String name;
 
  public MonomorphicInlineCache(MethodHandles.Lookup lookup, String name) {
    this.lookup = lookup;
    this.name = name;
  }
 
  private Class&lt;?&gt; cachedClass = null;
  private MethodHandle mh = null;
 
  public void invoke(Object receiver) throws Throwable {
    if (cachedClass != receiver.getClass()) {
      cachedClass = receiver.getClass();
      mh = lookup.findVirtual(cachedClass, name, MethodType.methodType(void.class));
    }
    mh.invoke(receiver);
  }
 
  public static CallSite bootstrap(MethodHandles.Lookup l, String name, MethodType callSiteType) throws Throwable {
    MonomorphicInlineCache ic = new MonomorphicInlineCache(l, name);
    MethodHandle mh = l.findVirtual(MonomorphicInlineCache.class, &quot;invoke&quot;, MethodType.methodType(void.class, Object.class));
    return new ConstantCallSite(mh.bindTo(ic));
  }
}
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œå°½ç®¡ invokedynamic æŒ‡ä»¤è°ƒç”¨çš„æ˜¯æ‰€è°“çš„ race æ–¹æ³•ï¼Œä½†æ˜¯å®é™…ä¸Šæˆ‘è¿”å›äº†ä¸€ä¸ªé“¾æ¥è‡³åä¸ºâ€œinvokeâ€çš„æ–¹æ³•çš„è°ƒç”¨ç‚¹ã€‚ç”±äºè°ƒç”¨ç‚¹ä»…è¦æ±‚æ–¹æ³•å¥æŸ„çš„ç±»å‹èƒ½å¤ŸåŒ¹é…ï¼Œå› æ­¤è¿™ä¸ªé“¾æ¥æ˜¯åˆæ³•çš„ã€‚</p>
<p>ä¸è¿‡ï¼Œè¿™æ­£æ˜¯ invokedynamic çš„ç›®çš„ï¼Œä¹Ÿå°±æ˜¯å°†è°ƒç”¨ç‚¹ä¸ç›®æ ‡æ–¹æ³•çš„é“¾æ¥äº¤ç”±åº”ç”¨ç¨‹åºæ¥åšï¼Œå¹¶ä¸”ä¾èµ–äºåº”ç”¨ç¨‹åºå¯¹ç›®æ ‡æ–¹æ³•è¿›è¡ŒéªŒè¯ã€‚æ‰€ä»¥ï¼Œå¦‚æœåº”ç”¨ç¨‹åºå°†èµ›è·‘æ–¹æ³•é“¾æ¥è‡³å…”å­çš„ç¡è§‰æ–¹æ³•ï¼Œé‚£ä¹Ÿåªèƒ½æ€ªåº”ç”¨ç¨‹åºè‡ªå·±äº†ã€‚</p>
<h2 id="java-8-çš„-lambda-è¡¨è¾¾å¼">Java 8 çš„ Lambda è¡¨è¾¾å¼</h2>
<p>åœ¨ Java 8 ä¸­ï¼ŒLambda è¡¨è¾¾å¼ä¹Ÿæ˜¯å€ŸåŠ© invokedynamic æ¥å®ç°çš„ã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼ŒJava ç¼–è¯‘å™¨åˆ©ç”¨ invokedynamic æŒ‡ä»¤æ¥ç”Ÿæˆå®ç°äº†å‡½æ•°å¼æ¥å£çš„é€‚é…å™¨ã€‚è¿™é‡Œçš„å‡½æ•°å¼æ¥å£æŒ‡çš„æ˜¯ä»…åŒ…æ‹¬ä¸€ä¸ªé default æ¥å£æ–¹æ³•çš„æ¥å£ï¼Œä¸€èˆ¬é€šè¿‡ @FunctionalInterface æ³¨è§£ã€‚ä¸è¿‡å°±ç®—æ˜¯æ²¡æœ‰ä½¿ç”¨è¯¥æ³¨è§£ï¼ŒJava ç¼–è¯‘å™¨ä¹Ÿä¼šå°†ç¬¦åˆæ¡ä»¶çš„æ¥å£è¾¨è®¤ä¸ºå‡½æ•°å¼æ¥å£ã€‚</p>
<pre tabindex="0"><code>int x = ..
IntStream.of(1, 2, 3).map(i -&gt; i * 2).map(i -&gt; i * x);
</code></pre><p>ä¸¾ä¸ªä¾‹å­ï¼Œä¸Šé¢è¿™æ®µä»£ç ä¼šå¯¹ IntStream ä¸­çš„å…ƒç´ è¿›è¡Œä¸¤æ¬¡æ˜ å°„ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œæ˜ å°„æ–¹æ³• map æ‰€æ¥æ”¶çš„å‚æ•°æ˜¯ IntUnaryOperatorï¼ˆè¿™æ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­æˆ‘ä»¬éœ€è¦å°† i-&gt;i_2 å’Œ i-&gt;i_x è¿™ä¸¤ä¸ª Lambda è¡¨è¾¾å¼è½¬åŒ–æˆ IntUnaryOperator çš„å®ä¾‹ã€‚è¿™ä¸ªè½¬åŒ–è¿‡ç¨‹ä¾¿æ˜¯ç”± invokedynamic æ¥å®ç°çš„ã€‚</p>
<p>åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼ŒJava ç¼–è¯‘å™¨ä¼šå¯¹ Lambda è¡¨è¾¾å¼è¿›è¡Œè§£è¯­æ³•ç³–ï¼ˆdesugarï¼‰ï¼Œç”Ÿæˆä¸€ä¸ªæ–¹æ³•æ¥ä¿å­˜ Lambda è¡¨è¾¾å¼çš„å†…å®¹ã€‚è¯¥æ–¹æ³•çš„å‚æ•°åˆ—è¡¨ä¸ä»…åŒ…å«åŸæœ¬ Lambda è¡¨è¾¾å¼çš„å‚æ•°ï¼Œè¿˜åŒ…å«å®ƒæ‰€æ•è·çš„å˜é‡ã€‚(æ³¨ï¼šæ–¹æ³•å¼•ç”¨ï¼Œå¦‚ Horse::raceï¼Œåˆ™ä¸ä¼šç”Ÿæˆç”Ÿæˆé¢å¤–çš„æ–¹æ³•ã€‚)</p>
<p>åœ¨ä¸Šé¢é‚£ä¸ªä¾‹å­ä¸­ï¼Œç¬¬ä¸€ä¸ª Lambda è¡¨è¾¾å¼æ²¡æœ‰æ•è·å…¶ä»–å˜é‡ï¼Œè€Œç¬¬äºŒä¸ª Lambda è¡¨è¾¾å¼ï¼ˆä¹Ÿå°±æ˜¯ i-&gt;i*xï¼‰åˆ™ä¼šæ•è·å±€éƒ¨å˜é‡ xã€‚è¿™ä¸¤ä¸ª Lambda è¡¨è¾¾å¼å¯¹åº”çš„æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºã€‚å¯ä»¥çœ‹åˆ°ï¼Œæ‰€æ•è·çš„å˜é‡åŒæ ·ä¹Ÿä¼šä½œä¸ºå‚æ•°ä¼ å…¥ç”Ÿæˆçš„æ–¹æ³•ä¹‹ä¸­ã€‚</p>
<pre tabindex="0"><code>  // i -&gt; i * 2
  private static int lambda$0(int);
    Code:
       0: iload_0
       1: iconst_2
       2: imul
       3: ireturn
 
  // i -&gt; i * x
  private static int lambda$1(int, int);
    Code:
       0: iload_1
       1: iload_0
       2: imul
       3: ireturn
</code></pre><p>ç¬¬ä¸€æ¬¡æ‰§è¡Œ invokedynamic æŒ‡ä»¤æ—¶ï¼Œå®ƒæ‰€å¯¹åº”çš„å¯åŠ¨æ–¹æ³•ä¼šé€šè¿‡ ASM æ¥ç”Ÿæˆä¸€ä¸ªé€‚é…å™¨ç±»ã€‚è¿™ä¸ªé€‚é…å™¨ç±»å®ç°äº†å¯¹åº”çš„å‡½æ•°å¼æ¥å£ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œä¹Ÿå°±æ˜¯ IntUnaryOperatorã€‚å¯åŠ¨æ–¹æ³•çš„è¿”å›å€¼æ˜¯ä¸€ä¸ª ConstantCallSiteï¼Œå…¶é“¾æ¥å¯¹è±¡ä¸ºä¸€ä¸ªè¿”å›é€‚é…å™¨ç±»å®ä¾‹çš„æ–¹æ³•å¥æŸ„ã€‚</p>
<p>æ ¹æ® Lambda è¡¨è¾¾å¼æ˜¯å¦æ•è·å…¶ä»–å˜é‡ï¼Œå¯åŠ¨æ–¹æ³•ç”Ÿæˆçš„é€‚é…å™¨ç±»ä»¥åŠæ‰€é“¾æ¥çš„æ–¹æ³•å¥æŸ„çš†ä¸åŒã€‚</p>
<p>å¦‚æœè¯¥ Lambda è¡¨è¾¾å¼æ²¡æœ‰æ•è·å…¶ä»–å˜é‡ï¼Œé‚£ä¹ˆå¯ä»¥è®¤ä¸ºå®ƒæ˜¯ä¸Šä¸‹æ–‡æ— å…³çš„ã€‚å› æ­¤ï¼Œå¯åŠ¨æ–¹æ³•å°†æ–°å»ºä¸€ä¸ªé€‚é…å™¨ç±»çš„å®ä¾‹ï¼Œå¹¶ä¸”ç”Ÿæˆä¸€ä¸ªç‰¹æ®Šçš„æ–¹æ³•å¥æŸ„ï¼Œå§‹ç»ˆè¿”å›è¯¥å®ä¾‹ã€‚</p>
<p>å¦‚æœè¯¥ Lambda è¡¨è¾¾å¼æ•è·äº†å…¶ä»–å˜é‡ï¼Œé‚£ä¹ˆæ¯æ¬¡æ‰§è¡Œè¯¥ invokedynamic æŒ‡ä»¤ï¼Œæˆ‘ä»¬éƒ½è¦æ›´æ–°è¿™äº›æ•è·äº†çš„å˜é‡ï¼Œä»¥é˜²æ­¢å®ƒä»¬å‘ç”Ÿäº†å˜åŒ–ã€‚</p>
<p>å¦å¤–ï¼Œä¸ºäº†ä¿è¯ Lambda è¡¨è¾¾å¼çš„çº¿ç¨‹å®‰å…¨ï¼Œæˆ‘ä»¬æ— æ³•å…±äº«åŒä¸€ä¸ªé€‚é…å™¨ç±»çš„å®ä¾‹ã€‚å› æ­¤ï¼Œåœ¨æ¯æ¬¡æ‰§è¡Œ invokedynamic æŒ‡ä»¤æ—¶ï¼Œæ‰€è°ƒç”¨çš„æ–¹æ³•å¥æŸ„éƒ½éœ€è¦æ–°å»ºä¸€ä¸ªé€‚é…å™¨ç±»å®ä¾‹ã€‚</p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯åŠ¨æ–¹æ³•ç”Ÿæˆçš„é€‚é…å™¨ç±»å°†åŒ…å«ä¸€ä¸ªé¢å¤–çš„é™æ€æ–¹æ³•ï¼Œæ¥æ„é€ é€‚é…å™¨ç±»çš„å®ä¾‹ã€‚è¯¥æ–¹æ³•å°†æ¥æ”¶è¿™äº›æ•è·çš„å‚æ•°ï¼Œå¹¶ä¸”å°†å®ƒä»¬ä¿å­˜ä¸ºé€‚é…å™¨ç±»å®ä¾‹çš„å®ä¾‹å­—æ®µã€‚</p>
<p>ä½ å¯ä»¥é€šè¿‡è™šæ‹Ÿæœºå‚æ•° -Djdk.internal.lambda.dumpProxyClasses=/DUMP/PATH å¯¼å‡ºè¿™äº›å…·ä½“çš„é€‚é…å™¨ç±»ã€‚è¿™é‡Œæˆ‘å¯¼å‡ºäº†ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ä¸¤ä¸ª Lambda è¡¨è¾¾å¼å¯¹åº”çš„é€‚é…å™¨ç±»ã€‚</p>
<pre tabindex="0"><code>// i-&gt;i*2 å¯¹åº”çš„é€‚é…å™¨ç±»
final class LambdaTest$$Lambda$1 implements IntUnaryOperator {
 private LambdaTest$$Lambda$1();
  Code:
    0: aload_0
    1: invokespecial java/lang/Object.&quot;&lt;init&gt;&quot;:()V
    4: return
 
 public int applyAsInt(int);
  Code:
    0: iload_1
    1: invokestatic LambdaTest.lambda$0:(I)I
    4: ireturn
}
 
// i-&gt;i*x å¯¹åº”çš„é€‚é…å™¨ç±»
final class LambdaTest$$Lambda$2 implements IntUnaryOperator {
 private final int arg$1;
 
 private LambdaTest$$Lambda$2(int);
  Code:
    0: aload_0
    1: invokespecial java/lang/Object.&quot;&lt;init&gt;&quot;:()V
    4: aload_0
    5: iload_1
    6: putfield arg$1:I
    9: return
 
 private static java.util.function.IntUnaryOperator get$Lambda(int);
  Code:
    0: new LambdaTest$$Lambda$2
    3: dup
    4: iload_0
    5: invokespecial &quot;&lt;init&gt;&quot;:(I)V
    8: areturn
 
 public int applyAsInt(int);
  Code:
    0: aload_0
    1: getfield arg$1:I
    4: iload_1
    5: invokestatic LambdaTest.lambda$1:(II)I
    8: ireturn
}
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæ•è·äº†å±€éƒ¨å˜é‡çš„ Lambda è¡¨è¾¾å¼å¤šå‡ºäº†ä¸€ä¸ª get$Lambda çš„æ–¹æ³•ã€‚å¯åŠ¨æ–¹æ³•ä¾¿ä¼šæ‰€è¿”å›çš„è°ƒç”¨ç‚¹é“¾æ¥è‡³æŒ‡å‘è¯¥æ–¹æ³•çš„æ–¹æ³•å¥æŸ„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯æ¬¡æ‰§è¡Œ invokedynamic æŒ‡ä»¤æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨è‡³è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œå¹¶æ„é€ ä¸€ä¸ªæ–°çš„é€‚é…å™¨ç±»å®ä¾‹ã€‚</p>
<p>è¿™ä¸ªå¤šå‡ºæ¥çš„æ–°å»ºå®ä¾‹ä¼šå¯¹ç¨‹åºæ€§èƒ½é€ æˆå½±å“å—ï¼Ÿ</p>
<h2 id="lambda-ä»¥åŠæ–¹æ³•å¥æŸ„çš„æ€§èƒ½åˆ†æ">Lambda ä»¥åŠæ–¹æ³•å¥æŸ„çš„æ€§èƒ½åˆ†æ</h2>
<p>æˆ‘å†æ¬¡è¯·å‡ºæµ‹è¯•åå°„è°ƒç”¨æ€§èƒ½å¼€é”€çš„é‚£æ®µä»£ç ï¼Œå¹¶å°†å…¶æ”¹é€ æˆä½¿ç”¨ Lambda è¡¨è¾¾å¼çš„ v6 ç‰ˆæœ¬ã€‚</p>
<pre tabindex="0"><code>// v6 ç‰ˆæœ¬
import java.util.function.IntConsumer;
 
public class Test {
  public static void target(int i) { }
 
  public static void main(String[] args) throws Exception {
    long current = System.currentTimeMillis();
    for (int i = 1; i &lt;= 2_000_000_000; i++) {
      if (i % 100_000_000 == 0) {
        long temp = System.currentTimeMillis();
        System.out.println(temp - current);
        current = temp;
      }
 
      ((IntConsumer) j -&gt; Test.target(j)).accept(128);
      // ((IntConsumer) Test::target.accept(128);
    }
  }
}
</code></pre><p>æµ‹é‡ç»“æœæ˜¾ç¤ºï¼Œå®ƒä¸ç›´æ¥è°ƒç”¨çš„æ€§èƒ½å¹¶æ— å¤ªå¤§çš„åŒºåˆ«ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå³æ—¶ç¼–è¯‘å™¨èƒ½å¤Ÿå°†è½¬æ¢ Lambda è¡¨è¾¾å¼æ‰€ä½¿ç”¨çš„ invokedynamicï¼Œä»¥åŠå¯¹ IntConsumer.accept æ–¹æ³•çš„è°ƒç”¨ç»Ÿç»Ÿå†…è”è¿›æ¥ï¼Œæœ€ç»ˆä¼˜åŒ–ä¸ºç©ºæ“ä½œã€‚</p>
<p>è¿™ä¸ªå…¶å®ä¸éš¾ç†è§£ï¼šLambda è¡¨è¾¾å¼æ‰€ä½¿ç”¨çš„ invokedynamic å°†ç»‘å®šä¸€ä¸ª ConstantCallSiteï¼Œå…¶é“¾æ¥çš„ç›®æ ‡æ–¹æ³•æ— æ³•æ”¹å˜ã€‚å› æ­¤ï¼Œå³æ—¶ç¼–è¯‘å™¨ä¼šå°†è¯¥ç›®æ ‡æ–¹æ³•ç›´æ¥å†…è”è¿›æ¥ã€‚å¯¹äºè¿™ç±»æ²¡æœ‰æ•è·å˜é‡çš„ Lambda è¡¨è¾¾å¼è€Œè¨€ï¼Œç›®æ ‡æ–¹æ³•åªå®Œæˆäº†ä¸€ä¸ªåŠ¨ä½œï¼Œä¾¿æ˜¯åŠ è½½ç¼“å­˜çš„é€‚é…å™¨ç±»å¸¸é‡ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œå¯¹ IntConsumer.accept æ–¹æ³•çš„è°ƒç”¨å®åˆ™æ˜¯å¯¹é€‚é…å™¨ç±»çš„ accept æ–¹æ³•çš„è°ƒç”¨ã€‚</p>
<p>å¦‚æœä½ æŸ¥çœ‹äº† accept æ–¹æ³•å¯¹åº”çš„å­—èŠ‚ç çš„è¯ï¼Œä½ ä¼šå‘ç°å®ƒä»…åŒ…å«ä¸€ä¸ªæ–¹æ³•è°ƒç”¨ï¼Œè°ƒç”¨è‡³ Java ç¼–è¯‘å™¨åœ¨è§£ Lambda è¯­æ³•ç³–æ—¶ç”Ÿæˆçš„æ–¹æ³•ã€‚</p>
<p>è¯¥æ–¹æ³•çš„å†…å®¹ä¾¿æ˜¯ Lambda è¡¨è¾¾å¼çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥è°ƒç”¨ç›®æ ‡æ–¹æ³• Test.targetã€‚å°†è¿™å‡ ä¸ªæ–¹æ³•è°ƒç”¨å†…è”è¿›æ¥ä¹‹åï¼ŒåŸæœ¬å¯¹ accept æ–¹æ³•çš„è°ƒç”¨åˆ™ä¼šè¢«ä¼˜åŒ–ä¸ºç©ºæ“ä½œã€‚</p>
<p>ä¸‹é¢æˆ‘å°†ä¹‹å‰çš„ä»£ç æ›´æ”¹ä¸ºå¸¦æ•è·å˜é‡çš„ v7 ç‰ˆæœ¬ã€‚ç†è®ºä¸Šï¼Œæ¯æ¬¡è°ƒç”¨ invokedynamic æŒ‡ä»¤ï¼ŒJava è™šæ‹Ÿæœºéƒ½ä¼šæ–°å»ºä¸€ä¸ªé€‚é…å™¨ç±»çš„å®ä¾‹ã€‚ç„¶è€Œï¼Œå®é™…è¿è¡Œç»“æœè¿˜æ˜¯ä¸ç›´æ¥è°ƒç”¨çš„æ€§èƒ½ä¸€è‡´ã€‚</p>
<pre tabindex="0"><code>// v7 ç‰ˆæœ¬
import java.util.function.IntConsumer;
 
public class Test {
  public static void target(int i) { }
 
  public static void main(String[] args) throws Exception {
    int x = 2;
 
    long current = System.currentTimeMillis();
    for (int i = 1; i &lt;= 2_000_000_000; i++) {
      if (i % 100_000_000 == 0) {
        long temp = System.currentTimeMillis();
        System.out.println(temp - current);
        current = temp;
      }
 
      ((IntConsumer) j -&gt; Test.target(x + j)).accept(128);
    }
  }
}
</code></pre><p>æ˜¾ç„¶ï¼Œå³æ—¶ç¼–è¯‘å™¨çš„é€ƒé€¸åˆ†æåˆå°†è¯¥æ–°å»ºå®ä¾‹ç»™ä¼˜åŒ–æ‰äº†ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è™šæ‹Ÿæœºå‚æ•° -XX:-DoEscapeAnalysis æ¥å…³é—­é€ƒé€¸åˆ†æã€‚æœç„¶ï¼Œè¿™æ—¶å€™æµ‹å¾—çš„å€¼çº¦ä¸ºç›´æ¥è°ƒç”¨çš„ 2.5 å€ã€‚</p>
<p>å°½ç®¡é€ƒé€¸åˆ†æèƒ½å¤Ÿå»é™¤è¿™äº›é¢å¤–çš„æ–°å»ºå®ä¾‹å¼€é”€ï¼Œä½†æ˜¯å®ƒä¹Ÿä¸æ˜¯æ—¶æ—¶å¥æ•ˆã€‚å®ƒéœ€è¦åŒæ—¶æ»¡è¶³ä¸¤ä»¶äº‹ï¼šinvokedynamic æŒ‡ä»¤æ‰€æ‰§è¡Œçš„æ–¹æ³•å¥æŸ„èƒ½å¤Ÿå†…è”ï¼Œå’Œæ¥ä¸‹æ¥çš„å¯¹ accept æ–¹æ³•çš„è°ƒç”¨ä¹Ÿèƒ½å†…è”ã€‚</p>
<p>åªæœ‰è¿™æ ·ï¼Œé€ƒé€¸åˆ†ææ‰èƒ½åˆ¤å®šè¯¥é€‚é…å™¨å®ä¾‹ä¸é€ƒé€¸ã€‚å¦åˆ™ï¼Œæˆ‘ä»¬ä¼šåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¸åœåœ°ç”Ÿæˆé€‚é…å™¨ç±»å®ä¾‹ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åº”å½“å°½é‡ä½¿ç”¨éæ•è·çš„ Lambda è¡¨è¾¾å¼ã€‚</p>
<h2 id="æ€»ç»“ä¸å®è·µ">æ€»ç»“ä¸å®è·µ</h2>
<p>ä»Šå¤©æˆ‘ä»‹ç»äº† invokedynamic æŒ‡ä»¤ä»¥åŠ Lambda è¡¨è¾¾å¼çš„å®ç°ã€‚</p>
<p>invokedymaic æŒ‡ä»¤æŠ½è±¡å‡ºè°ƒç”¨ç‚¹çš„æ¦‚å¿µï¼Œå¹¶ä¸”å°†è°ƒç”¨è¯¥è°ƒç”¨ç‚¹æ‰€é“¾æ¥çš„æ–¹æ³•å¥æŸ„ã€‚åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œ invokedynamic æŒ‡ä»¤æ—¶ï¼ŒJava è™šæ‹Ÿæœºå°†æ‰§è¡Œå®ƒæ‰€å¯¹åº”çš„å¯åŠ¨æ–¹æ³•ï¼Œç”Ÿæˆå¹¶ä¸”ç»‘å®šä¸€ä¸ªè°ƒç”¨ç‚¹ã€‚ä¹‹åå¦‚æœå†æ¬¡æ‰§è¡Œè¯¥æŒ‡ä»¤ï¼ŒJava è™šæ‹Ÿæœºåˆ™ç›´æ¥è°ƒç”¨å·²ç»ç»‘å®šäº†çš„è°ƒç”¨ç‚¹æ‰€é“¾æ¥çš„æ–¹æ³•ã€‚</p>
<p>Lambda è¡¨è¾¾å¼åˆ°å‡½æ•°å¼æ¥å£çš„è½¬æ¢æ˜¯é€šè¿‡ invokedynamic æŒ‡ä»¤æ¥å®ç°çš„ã€‚è¯¥ invokedynamic æŒ‡ä»¤å¯¹åº”çš„å¯åŠ¨æ–¹æ³•å°†é€šè¿‡ ASM ç”Ÿæˆä¸€ä¸ªé€‚é…å™¨ç±»ã€‚</p>
<p>å¯¹äºæ²¡æœ‰æ•è·å…¶ä»–å˜é‡çš„ Lambda è¡¨è¾¾å¼ï¼Œè¯¥ invokedynamic æŒ‡ä»¤å§‹ç»ˆè¿”å›åŒä¸€ä¸ªé€‚é…å™¨ç±»çš„å®ä¾‹ã€‚å¯¹äºæ•è·äº†å…¶ä»–å˜é‡çš„ Lambda è¡¨è¾¾å¼ï¼Œæ¯æ¬¡æ‰§è¡Œ invokedynamic æŒ‡ä»¤å°†æ–°å»ºä¸€ä¸ªé€‚é…å™¨ç±»å®ä¾‹ã€‚</p>
<p>ä¸ç®¡æ˜¯æ•è·å‹çš„è¿˜æ˜¯æœªæ•è·å‹çš„ Lambda è¡¨è¾¾å¼ï¼Œå®ƒä»¬çš„æ€§èƒ½ä¸Šé™çš†å¯ä»¥è¾¾åˆ°ç›´æ¥è°ƒç”¨çš„æ€§èƒ½ã€‚å…¶ä¸­ï¼Œæ•è·å‹ Lambda è¡¨è¾¾å¼å€ŸåŠ©äº†å³æ—¶ç¼–è¯‘å™¨ä¸­çš„é€ƒé€¸åˆ†æï¼Œæ¥é¿å…å®é™…çš„æ–°å»ºé€‚é…å™¨ç±»å®ä¾‹çš„æ“ä½œã€‚</p>
<p>åœ¨ä¸Šä¸€ç¯‡çš„è¯¾åå®è·µä¸­ï¼Œä½ åº”è¯¥æµ‹è¿‡è¿™ä¸€æ®µä»£ç çš„æ€§èƒ½å¼€é”€äº†ã€‚æˆ‘è¿™è¾¹æµ‹å¾—çš„ç»“æœçº¦ä¸ºç›´æ¥è°ƒç”¨çš„ 3.5 å€ã€‚</p>
<pre tabindex="0"><code>// v8 ç‰ˆæœ¬
import java.lang.invoke.MethodHandle;
import java.lang.invoke.MethodHandles;
import java.lang.invoke.MethodType;
 
public class Test {
  public static void target(int i) { }
 
  public static void main(String[] args) throws Exception {
    MethodHandles.Lookup l = MethodHandles.lookup();
    MethodType t = MethodType.methodType(void.class, int.class);
    MethodHandle mh = l.findStatic(Test.class, &quot;target&quot;, t);
 
    long current = System.currentTimeMillis();
    for (int i = 1; i &lt;= 2_000_000_000; i++) {
      if (i % 100_000_000 == 0) {
        long temp = System.currentTimeMillis();
        System.out.println(temp - current);
        current = temp;
      }
 
      mh.invokeExact(128);
    }
  }
}
</code></pre><p>å®é™…ä¸Šï¼Œå®ƒä¸ä½¿ç”¨ Lambda è¡¨è¾¾å¼æˆ–è€…æ–¹æ³•å¼•ç”¨çš„å·®åˆ«åœ¨äºï¼Œå³æ—¶ç¼–è¯‘å™¨æ— æ³•å°†è¯¥æ–¹æ³•å¥æŸ„è¯†åˆ«ä¸ºå¸¸é‡ï¼Œä»è€Œæ— æ³•è¿›è¡Œå†…è”ã€‚é‚£ä¹ˆå¦‚æœå°†å®ƒå˜æˆå¸¸é‡è¡Œä¸è¡Œå‘¢ï¼Ÿ</p>
<p>ä¸€ç§æ–¹æ³•ä¾¿æ˜¯å°†å…¶èµ‹å€¼ç»™ final çš„é™æ€å˜é‡ï¼Œå¦‚ä¸‹é¢çš„ v9 ç‰ˆæœ¬æ‰€ç¤ºï¼š</p>
<pre tabindex="0"><code>// v9 ç‰ˆæœ¬
import java.lang.invoke.MethodHandle;
import java.lang.invoke.MethodHandles;
import java.lang.invoke.MethodType;
 
public class Test {
  public static void target(int i) { }
 
  static final MethodHandle mh;
  static {
    try {
      MethodHandles.Lookup l = MethodHandles.lookup();
      MethodType t = MethodType.methodType(void.class, int.class);
      mh = l.findStatic(Test.class, &quot;target&quot;, t);
    } catch (Throwable e) {
      throw new RuntimeException(e);
    }
  }
 
  public static void main(String[] args) throws Throwable {
    long current = System.currentTimeMillis();
    for (int i = 1; i &lt;= 2_000_000_000; i++) {
      if (i % 100_000_000 == 0) {
        long temp = System.currentTimeMillis();
        System.out.println(temp - current);
        current = temp;
      }
 
      mh.invokeExact(128);
    }
  }
}
</code></pre><p>è¿™ä¸ªç‰ˆæœ¬æµ‹å¾—çš„æ•°æ®å’Œç›´æ¥è°ƒç”¨çš„æ€§èƒ½æ•°æ®ä¸€è‡´ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå³æ—¶ç¼–è¯‘å™¨èƒ½å¤Ÿå°†è¯¥æ–¹æ³•å¥æŸ„å®Œå…¨å†…è”è¿›æ¥ï¼Œæˆä¸ºç©ºæ“ä½œã€‚</p>
<p>ä»Šå¤©çš„å®è·µç¯èŠ‚ï¼Œæˆ‘ä»¬æ¥ç»§ç»­æ¢ç´¢æ–¹æ³•å¥æŸ„çš„æ€§èƒ½ã€‚è¿è¡Œä¸‹é¢çš„ v10 ç‰ˆæœ¬ä»¥åŠ v11 ç‰ˆæœ¬ï¼Œæ¯”è¾ƒå®ƒä»¬çš„æ€§èƒ½å¹¶æ€è€ƒä¸ºä»€ä¹ˆã€‚</p>
<pre tabindex="0"><code>// v10 ç‰ˆæœ¬
import java.lang.invoke.*;
 
public class Test {
  public static void target(int i) {
  }
 
  public static class MyCallSite {
 
    public final MethodHandle mh;
 
    public MyCallSite() {
      mh = findTarget();
    }
 
    private static MethodHandle findTarget() {
      try {
        MethodHandles.Lookup l = MethodHandles.lookup();
        MethodType t = MethodType.methodType(void.class, int.class);
        return l.findStatic(Test.class, &quot;target&quot;, t);
      } catch (Throwable e) {
        throw new RuntimeException(e);
      }
    }
  }
 
  private static final MyCallSite myCallSite = new MyCallSite();
 
  public static void main(String[] args) throws Throwable {
    long current = System.currentTimeMillis();
    for (int i = 1; i &lt;= 2_000_000_000; i++) {
      if (i % 100_000_000 == 0) {
        long temp = System.currentTimeMillis();
        System.out.println(temp - current);
        current = temp;
      }
 
      myCallSite.mh.invokeExact(128);
    }
  }
}
 
// v11 ç‰ˆæœ¬
import java.lang.invoke.*;
 
public class Test {
  public static void target(int i) {
  }
 
  public static class MyCallSite extends ConstantCallSite {
 
    public MyCallSite() {
      super(findTarget());
    }
 
    private static MethodHandle findTarget() {
      try {
        MethodHandles.Lookup l = MethodHandles.lookup();
        MethodType t = MethodType.methodType(void.class, int.class);
        return l.findStatic(Test.class, &quot;target&quot;, t);
      } catch (Throwable e) {
        throw new RuntimeException(e);
      }
    }
  }
 
  public static final MyCallSite myCallSite = new MyCallSite();
 
  public static void main(String[] args) throws Throwable {
    long current = System.currentTimeMillis();
    for (int i = 1; i &lt;= 2_000_000_000; i++) {
      if (i % 100_000_000 == 0) {
        long temp = System.currentTimeMillis();
        System.out.println(temp - current);
        current = temp;
      }
 
      myCallSite.getTarget().invokeExact(128);
    }
  }
}
</code></pre><p>æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œæˆ‘ä»¬ä¸‹æ¬¡å†è§ã€‚</p>
<p>[1] <a href="https://openjdk.java.net/jeps/303">http://openjdk.java.net/jeps/303</a></p>

        </div>
    </article>
</div>
<div class="division-line"></div>
<div class="others">
    <div>æ ‡ç­¾ï¼šğŸ·ï¸<a class="post-tag" href="/tags/java/">java</a>&nbsp;</div>
    <div>åˆ†ç±»ï¼š ğŸ“’<a class="post-category" href="/categories/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/">æ·±å…¥æ‹†è§£Javaè™šæ‹Ÿæœº</a>&nbsp; </div>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/08-jvm%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0invokedynamic%E7%9A%84%E4%B8%8A/"><span>08 JVMæ˜¯æ€ä¹ˆå®ç°invokedynamicçš„ï¼Ÿï¼ˆä¸Šï¼‰</span></a>
    </div>
    <div class="next">
        
        <a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/10-java%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/"><span>10 Javaå¯¹è±¡çš„å†…å­˜å¸ƒå±€</span></a>
    </div>
</div>

        </div>
        <div id="float">
            <ul class="float-button-bar">
    <li>
        <button class="float-button top" onclick="scrollToTop(this);">UP</button>
    </li>
    <li>
        <button class="float-button toggler" onclick="changeSkin(this);">DARK</button>
    </li>
</ul>
        </div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 2020 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    const changeSkin = () => {
        document.getElementById('page').classList.toggle('night');
    }
    const scrollToTop = () => {
        window.scrollTo(0, 0);
    }
</script>
</body>

</html>