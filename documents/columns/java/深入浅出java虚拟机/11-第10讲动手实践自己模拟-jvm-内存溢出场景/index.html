<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>11 ç¬¬10è®²ï¼šåŠ¨æ‰‹å®è·µï¼šè‡ªå·±æ¨¡æ‹Ÿ JVM å†…å­˜æº¢å‡ºåœºæ™¯ | Yipsen Ye</title>
<meta name="description" content="æœ¬è¯¾æ—¶æˆ‘ä»¬ä¸»è¦è‡ªå·±æ¨¡æ‹Ÿä¸€ä¸ª JVM å†…å­˜æº¢å‡ºçš„åœºæ™¯ã€‚åœ¨æ¨¡æ‹Ÿ JVM å†…å­˜æº¢å‡ºä¹‹å‰æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹è¿™æ ·çš„å‡ ä¸ªé—®é¢˜ã€‚
 è€å¹´ä»£æº¢å‡ºä¸ºä»€ä¹ˆé‚£ä¹ˆå¯æ€•ï¼Ÿ å…ƒç©ºé—´ä¹Ÿæœ‰æº¢å‡ºï¼Ÿæ€ä¹ˆä¼˜åŒ–ï¼Ÿ å¦‚ä½•é…ç½®æ ˆå¤§å°ï¼Ÿé¿å…æ ˆæº¢å‡ºï¼Ÿ è¿›ç¨‹çªç„¶æ­»æ‰ï¼Œæ²¡æœ‰ç•™ä¸‹ä»»ä½•ä¿¡æ¯æ—¶å¦‚ä½•è¿›è¡Œæ’æŸ¥ï¼Ÿ  å¹´è½»ä»£ç”±äºæœ‰è€å¹´ä»£çš„æ‹…ä¿ï¼Œä¸€èˆ¬åœ¨å†…å­˜å æ»¡çš„æ—¶å€™ï¼Œå¹¶æ²¡ä»€ä¹ˆé—®é¢˜ã€‚ä½†è€å¹´ä»£æ»¡äº†å°±æ¯”è¾ƒä¸¥é‡äº†ï¼Œå®ƒæ²¡æœ‰å…¶ä»–çš„ç©ºé—´ç”¨æ¥åšæ‹…ä¿ï¼Œåªèƒ½ OOM äº†ï¼Œä¹Ÿå°±æ˜¯å‘ç”Ÿ Out Of Memery Errorã€‚JVM ä¼šåœ¨è¿™ç§æƒ…å†µä¸‹ç›´æ¥åœæ­¢å·¥ä½œï¼Œæ˜¯éå¸¸ä¸¥é‡çš„åæœã€‚
OOM ä¸€èˆ¬æ˜¯å†…å­˜æ³„æ¼å¼•èµ·çš„ï¼Œè¡¨ç°åœ¨ GC æ—¥å¿—é‡Œï¼Œä¸€èˆ¬æƒ…å†µä¸‹å°±æ˜¯ GC çš„æ—¶é—´å˜é•¿äº†ï¼Œè€Œä¸”æ¯æ¬¡å›æ”¶çš„æ•ˆæœéƒ½éå¸¸ä¸€èˆ¬ã€‚GC åï¼Œå †å†…å­˜çš„å®é™…å ç”¨å‘ˆä¸Šå‡è¶‹åŠ¿ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ¨¡æ‹Ÿä¸‰ç§æº¢å‡ºåœºæ™¯ï¼ŒåŒæ—¶ä½¿ç”¨æˆ‘ä»¬äº†è§£çš„å·¥å…·è¿›è¡Œè§‚æµ‹ã€‚
åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ä½ ä¸‹è½½å¹¶å®‰è£…ä¸€ä¸ªå«ä½œ VisualVM çš„å·¥å…·ï¼Œæˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªå›¾å½¢åŒ–çš„å·¥å…·çœ‹ä¸€ä¸‹æº¢å‡ºè¿‡ç¨‹ã€‚
è™½ç„¶ VisualVM å·¥å…·éå¸¸å¥½ç”¨ï¼Œä½†ä¸€èˆ¬ç”Ÿäº§ç¯å¢ƒéƒ½æ²¡æœ‰è¿™æ ·çš„æ¡ä»¶ï¼Œæ‰€ä»¥å¤§æ¦‚ç‡ä½¿ç”¨ä¸äº†ã€‚æ–°ç‰ˆæœ¬ JDK æŠŠè¿™ä¸ªå·¥å…·å•ç‹¬æŠ½ç¦»äº†å‡ºå»ï¼Œéœ€è¦è‡ªè¡Œä¸‹è½½ã€‚
è¿™é‡Œéœ€è¦æ³¨æ„ä¸‹è½½å®‰è£…å®Œæˆä¹‹åè¯·åœ¨æ’ä»¶é€‰é¡¹ä¸­å‹¾é€‰ Visual GC ä¸‹è½½ï¼Œå®ƒå°†å¯è§†åŒ–å†…å­˜å¸ƒå±€ã€‚
å †æº¢å‡ºæ¨¡æ‹Ÿ é¦–å…ˆï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿå †æº¢å‡ºçš„æƒ…å†µï¼Œåœ¨æ¨¡æ‹Ÿä¹‹å‰æˆ‘ä»¬éœ€è¦å‡†å¤‡ä¸€ä»½æµ‹è¯•ä»£ç ã€‚è¿™ä»½ä»£ç å¼€æ”¾äº†ä¸€ä¸ª HTTP æ¥å£ï¼Œå½“ä½ è§¦å‘å®ƒä¹‹åï¼Œå°†æ¯ç§’é’Ÿç”Ÿæˆ 1MB çš„æ•°æ®ã€‚ç”±äºå®ƒå’Œ GC Roots çš„å¼ºå…³è”æ€§ï¼Œæ¯æ¬¡éƒ½ä¸èƒ½è¢«å›æ”¶ã€‚
ç¨‹åºé€šè¿‡ JMXï¼Œå°†åœ¨æ¯ä¸€ç§’åˆ›å»ºæ•°æ®ä¹‹åï¼Œè¾“å‡ºä¸€äº›å†…å­˜åŒºåŸŸçš„å ç”¨æƒ…å†µã€‚ç„¶åé€šè¿‡è®¿é—® http://localhost:8888 è§¦å‘åï¼Œå®ƒå°†ä¸€ç›´è¿è¡Œï¼Œç›´åˆ°å †æº¢å‡ºã€‚
import com.sun.net.httpserver.HttpContext;import com.sun.net.httpserver.HttpExchange;import com.sun.net.httpserver.HttpServer;import java.io.OutputStream;import java.lang.management.ManagementFactory;import java.lang.management.MemoryPoolMXBean;import java.net.InetSocketAddress;import java.util.ArrayList;import java.util.List;public class OOMTest {public static final int _1MB = 1024 * 1024;static List&amp;lt;byte[]&amp;gt; byteList = new ArrayList&amp;lt;&amp;gt;();private static void oom(HttpExchange exchange) {try {String response = &amp;quot;oom begin!">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/%e6%b7%b1%e5%85%a5%e6%b5%85%e5%87%bajava%e8%99%9a%e6%8b%9f%e6%9c%ba/">æ·±å…¥æµ…å‡ºJavaè™šæ‹Ÿæœº</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/00-%E5%BC%80%E7%AF%87%E8%AF%8Djvm%E4%B8%80%E5%9D%97%E9%9A%BE%E5%95%83%E7%9A%84%E9%AA%A8%E5%A4%B4/">00 å¼€ç¯‡è¯ï¼šJVMï¼Œä¸€å—éš¾å•ƒçš„éª¨å¤´</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/01-%E4%B8%80%E6%8E%A2%E7%A9%B6%E7%AB%9F%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-jvm%E5%AE%83%E5%A4%84%E5%9C%A8%E4%BB%80%E4%B9%88%E4%BD%8D%E7%BD%AE/">01 ä¸€æ¢ç©¶ç«Ÿï¼šä¸ºä»€ä¹ˆéœ€è¦ JVMï¼Ÿå®ƒå¤„åœ¨ä»€ä¹ˆä½ç½®ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/02-%E5%A4%A7%E5%8E%82%E9%9D%A2%E8%AF%95%E9%A2%98%E4%BD%A0%E4%B8%8D%E5%BE%97%E4%B8%8D%E6%8E%8C%E6%8F%A1%E7%9A%84-jvm-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">02 å¤§å‚é¢è¯•é¢˜ï¼šä½ ä¸å¾—ä¸æŒæ¡çš„ JVM å†…å­˜ç®¡ç†</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/03-%E5%A4%A7%E5%8E%82%E9%9D%A2%E8%AF%95%E9%A2%98%E4%BB%8E%E8%A6%86%E7%9B%96-jdk-%E7%9A%84%E7%B1%BB%E5%BC%80%E5%A7%8B%E6%8E%8C%E6%8F%A1%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/">03 å¤§å‚é¢è¯•é¢˜ï¼šä»è¦†ç›– JDK çš„ç±»å¼€å§‹æŒæ¡ç±»çš„åŠ è½½æœºåˆ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/04-%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5%E4%BB%8E%E6%A0%88%E5%B8%A7%E7%9C%8B%E5%AD%97%E8%8A%82%E7%A0%81%E6%98%AF%E5%A6%82%E4%BD%95%E5%9C%A8-jvm-%E4%B8%AD%E8%BF%9B%E8%A1%8C%E6%B5%81%E8%BD%AC%E7%9A%84/">04 åŠ¨æ‰‹å®è·µï¼šä»æ ˆå¸§çœ‹å­—èŠ‚ç æ˜¯å¦‚ä½•åœ¨ JVM ä¸­è¿›è¡Œæµè½¬çš„</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/05-%E5%A4%A7%E5%8E%82%E9%9D%A2%E8%AF%95%E9%A2%98%E5%BE%97%E5%BF%83%E5%BA%94%E6%89%8B%E5%BA%94%E5%AF%B9-oom-%E7%9A%84%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/">05 å¤§å‚é¢è¯•é¢˜ï¼šå¾—å¿ƒåº”æ‰‹åº”å¯¹ OOM çš„ç–‘éš¾æ‚ç—‡</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/06-%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%E5%90%97%E4%B8%8A/">06 æ·±å…¥å‰–æï¼šåƒåœ¾å›æ”¶ä½ çœŸçš„äº†è§£å—ï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/07-%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%E5%90%97%E4%B8%8B/">07 æ·±å…¥å‰–æï¼šåƒåœ¾å›æ”¶ä½ çœŸçš„äº†è§£å—ï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/08-%E5%A4%A7%E5%8E%82%E9%9D%A2%E8%AF%95%E9%A2%98%E6%9C%89%E4%BA%86-g1-%E8%BF%98%E9%9C%80%E8%A6%81%E5%85%B6%E4%BB%96%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8%E5%90%97/">08 å¤§å‚é¢è¯•é¢˜ï¼šæœ‰äº† G1 è¿˜éœ€è¦å…¶ä»–åƒåœ¾å›æ”¶å™¨å—ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/09-%E6%A1%88%E4%BE%8B%E5%AE%9E%E6%88%98%E4%BA%BF%E7%BA%A7%E6%B5%81%E9%87%8F%E9%AB%98%E5%B9%B6%E5%8F%91%E4%B8%8B%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E4%BC%B0%E7%AE%97%E5%92%8C%E8%B0%83%E4%BC%98/">09 æ¡ˆä¾‹å®æˆ˜ï¼šäº¿çº§æµé‡é«˜å¹¶å‘ä¸‹å¦‚ä½•è¿›è¡Œä¼°ç®—å’Œè°ƒä¼˜</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/10-%E7%AC%AC09%E8%AE%B2%E6%A1%88%E4%BE%8B%E5%AE%9E%E6%88%98%E9%9D%A2%E5%AF%B9%E7%AA%81%E5%A6%82%E5%85%B6%E6%9D%A5%E7%9A%84-gc-%E9%97%AE%E9%A2%98%E5%A6%82%E4%BD%95%E4%B8%8B%E6%89%8B%E8%A7%A3%E5%86%B3/">10 ç¬¬09è®²ï¼šæ¡ˆä¾‹å®æˆ˜ï¼šé¢å¯¹çªå¦‚å…¶æ¥çš„ GC é—®é¢˜å¦‚ä½•ä¸‹æ‰‹è§£å†³</a></li>
                
                
                
                    <li>11 ç¬¬10è®²ï¼šåŠ¨æ‰‹å®è·µï¼šè‡ªå·±æ¨¡æ‹Ÿ JVM å†…å­˜æº¢å‡ºåœºæ™¯</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/12-%E7%AC%AC11%E8%AE%B2%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5%E9%81%87%E5%88%B0%E9%97%AE%E9%A2%98%E4%B8%8D%E8%A6%81%E6%85%8C%E8%BD%BB%E6%9D%BE%E6%90%9E%E5%AE%9A%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/">12 ç¬¬11è®²ï¼šåŠ¨æ‰‹å®è·µï¼šé‡åˆ°é—®é¢˜ä¸è¦æ…Œï¼Œè½»æ¾æå®šå†…å­˜æ³„æ¼</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/13-%E5%B7%A5%E5%85%B7%E8%BF%9B%E9%98%B6%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8-mat-%E6%89%BE%E5%88%B0%E9%97%AE%E9%A2%98%E5%8F%91%E7%94%9F%E7%9A%84%E6%A0%B9%E6%9C%AC%E5%8E%9F%E5%9B%A0/">13 å·¥å…·è¿›é˜¶ï¼šå¦‚ä½•åˆ©ç”¨ MAT æ‰¾åˆ°é—®é¢˜å‘ç”Ÿçš„æ ¹æœ¬åŸå› </a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/14-%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5%E8%AE%A9%E9%9D%A2%E8%AF%95%E5%AE%98%E5%88%AE%E7%9B%AE%E7%9B%B8%E7%9C%8B%E7%9A%84%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98%E6%8E%92%E6%9F%A5/">14 åŠ¨æ‰‹å®è·µï¼šè®©é¢è¯•å®˜åˆ®ç›®ç›¸çœ‹çš„å †å¤–å†…å­˜æ’æŸ¥</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/15-%E9%A2%84%E8%AD%A6%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA-gc-%E7%9B%91%E6%8E%A7%E4%B8%8E%E8%B0%83%E4%BC%98/">15 é¢„è­¦ä¸è§£å†³ï¼šæ·±å…¥æµ…å‡º GC ç›‘æ§ä¸è°ƒä¼˜</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/16-%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90%E4%B8%80%E4%B8%AA%E9%AB%98%E6%AD%BB%E4%BA%A1%E7%8E%87%E7%9A%84%E6%8A%A5%E8%A1%A8%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BC%98%E5%8C%96%E4%B9%8B%E8%B7%AF/">16 æ¡ˆä¾‹åˆ†æï¼šä¸€ä¸ªé«˜æ­»äº¡ç‡çš„æŠ¥è¡¨ç³»ç»Ÿçš„ä¼˜åŒ–ä¹‹è·¯</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/17-%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%90%8E%E6%88%91%E7%9A%84%E5%BA%94%E7%94%A8%E5%B4%A9%E6%BA%83%E4%BA%86/">17 æ¡ˆä¾‹åˆ†æï¼šåˆ†åº“åˆ†è¡¨åï¼Œæˆ‘çš„åº”ç”¨å´©æºƒäº†</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/18-%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5%E4%BB%8E%E5%AD%97%E8%8A%82%E7%A0%81%E7%9C%8B%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0/">18 åŠ¨æ‰‹å®è·µï¼šä»å­—èŠ‚ç çœ‹æ–¹æ³•è°ƒç”¨çš„åº•å±‚å®ç°</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/19-%E5%A4%A7%E5%8E%82%E9%9D%A2%E8%AF%95%E9%A2%98%E4%B8%8D%E8%A6%81%E6%90%9E%E6%B7%B7-jmm-%E4%B8%8E-jvm/">19 å¤§å‚é¢è¯•é¢˜ï¼šä¸è¦ææ·· JMM ä¸ JVM</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/20-%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5%E4%BB%8E%E5%AD%97%E8%8A%82%E7%A0%81%E7%9C%8B%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0/">20 åŠ¨æ‰‹å®è·µï¼šä»å­—èŠ‚ç çœ‹å¹¶å‘ç¼–ç¨‹çš„åº•å±‚å®ç°</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/21-%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5%E4%B8%8D%E4%B8%BA%E4%BA%BA%E7%86%9F%E7%9F%A5%E7%9A%84%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4/">21 åŠ¨æ‰‹å®è·µï¼šä¸ä¸ºäººç†ŸçŸ¥çš„å­—èŠ‚ç æŒ‡ä»¤</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/22-%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-java-agent-%E6%8A%80%E6%9C%AF%E5%AF%B9%E5%AD%97%E8%8A%82%E7%A0%81%E8%BF%9B%E8%A1%8C%E4%BF%AE%E6%94%B9/">22 æ·±å…¥å‰–æï¼šå¦‚ä½•ä½¿ç”¨ Java Agent æŠ€æœ¯å¯¹å­—èŠ‚ç è¿›è¡Œä¿®æ”¹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/23-%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5jit-%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE%E5%A6%82%E4%BD%95%E5%BD%B1%E5%93%8D%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C/">23 åŠ¨æ‰‹å®è·µï¼šJIT å‚æ•°é…ç½®å¦‚ä½•å½±å“ç¨‹åºè¿è¡Œï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/24-%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90%E5%A4%A7%E5%9E%8B%E9%A1%B9%E7%9B%AE%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E6%80%A7%E8%83%BD%E7%93%B6%E9%A2%88%E8%B0%83%E4%BC%98/">24 æ¡ˆä¾‹åˆ†æï¼šå¤§å‹é¡¹ç›®å¦‚ä½•è¿›è¡Œæ€§èƒ½ç“¶é¢ˆè°ƒä¼˜ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/25-%E6%9C%AA%E6%9D%A5jvm-%E7%9A%84%E5%8E%86%E5%8F%B2%E4%B8%8E%E5%B1%95%E6%9C%9B/">25 æœªæ¥ï¼šJVM çš„å†å²ä¸å±•æœ›</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/26-%E7%A6%8F%E5%88%A9%E5%B8%B8%E8%A7%81-jvm-%E9%9D%A2%E8%AF%95%E9%A2%98%E8%A1%A5%E5%85%85/">26 ç¦åˆ©ï¼šå¸¸è§ JVM é¢è¯•é¢˜è¡¥å……</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">11 ç¬¬10è®²ï¼šåŠ¨æ‰‹å®è·µï¼šè‡ªå·±æ¨¡æ‹Ÿ JVM å†…å­˜æº¢å‡ºåœºæ™¯</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2022-01-09 11:12:30</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/java/">java</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/">æ·±å…¥æµ…å‡ºJavaè™šæ‹Ÿæœº</a>
                
            </div></div>
        <div class="post-content">
            <p>æœ¬è¯¾æ—¶æˆ‘ä»¬ä¸»è¦è‡ªå·±æ¨¡æ‹Ÿä¸€ä¸ª JVM å†…å­˜æº¢å‡ºçš„åœºæ™¯ã€‚åœ¨æ¨¡æ‹Ÿ JVM å†…å­˜æº¢å‡ºä¹‹å‰æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹è¿™æ ·çš„å‡ ä¸ªé—®é¢˜ã€‚</p>
<ul>
<li>è€å¹´ä»£æº¢å‡ºä¸ºä»€ä¹ˆé‚£ä¹ˆå¯æ€•ï¼Ÿ</li>
<li>å…ƒç©ºé—´ä¹Ÿæœ‰æº¢å‡ºï¼Ÿæ€ä¹ˆä¼˜åŒ–ï¼Ÿ</li>
<li>å¦‚ä½•é…ç½®æ ˆå¤§å°ï¼Ÿé¿å…æ ˆæº¢å‡ºï¼Ÿ</li>
<li>è¿›ç¨‹çªç„¶æ­»æ‰ï¼Œæ²¡æœ‰ç•™ä¸‹ä»»ä½•ä¿¡æ¯æ—¶å¦‚ä½•è¿›è¡Œæ’æŸ¥ï¼Ÿ</li>
</ul>
<p>å¹´è½»ä»£ç”±äºæœ‰è€å¹´ä»£çš„æ‹…ä¿ï¼Œä¸€èˆ¬åœ¨å†…å­˜å æ»¡çš„æ—¶å€™ï¼Œå¹¶æ²¡ä»€ä¹ˆé—®é¢˜ã€‚ä½†è€å¹´ä»£æ»¡äº†å°±æ¯”è¾ƒä¸¥é‡äº†ï¼Œå®ƒæ²¡æœ‰å…¶ä»–çš„ç©ºé—´ç”¨æ¥åšæ‹…ä¿ï¼Œåªèƒ½ OOM äº†ï¼Œä¹Ÿå°±æ˜¯å‘ç”Ÿ Out Of Memery Errorã€‚JVM ä¼šåœ¨è¿™ç§æƒ…å†µä¸‹ç›´æ¥åœæ­¢å·¥ä½œï¼Œæ˜¯éå¸¸ä¸¥é‡çš„åæœã€‚</p>
<p>OOM ä¸€èˆ¬æ˜¯å†…å­˜æ³„æ¼å¼•èµ·çš„ï¼Œè¡¨ç°åœ¨ GC æ—¥å¿—é‡Œï¼Œä¸€èˆ¬æƒ…å†µä¸‹å°±æ˜¯ GC çš„æ—¶é—´å˜é•¿äº†ï¼Œè€Œä¸”æ¯æ¬¡å›æ”¶çš„æ•ˆæœéƒ½éå¸¸ä¸€èˆ¬ã€‚GC åï¼Œå †å†…å­˜çš„å®é™…å ç”¨å‘ˆä¸Šå‡è¶‹åŠ¿ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ¨¡æ‹Ÿä¸‰ç§æº¢å‡ºåœºæ™¯ï¼ŒåŒæ—¶ä½¿ç”¨æˆ‘ä»¬äº†è§£çš„å·¥å…·è¿›è¡Œè§‚æµ‹ã€‚</p>
<p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ä½ ä¸‹è½½å¹¶å®‰è£…ä¸€ä¸ªå«ä½œ VisualVM çš„å·¥å…·ï¼Œæˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªå›¾å½¢åŒ–çš„å·¥å…·çœ‹ä¸€ä¸‹æº¢å‡ºè¿‡ç¨‹ã€‚</p>
<p>è™½ç„¶ VisualVM å·¥å…·éå¸¸å¥½ç”¨ï¼Œä½†ä¸€èˆ¬ç”Ÿäº§ç¯å¢ƒéƒ½æ²¡æœ‰è¿™æ ·çš„æ¡ä»¶ï¼Œæ‰€ä»¥å¤§æ¦‚ç‡ä½¿ç”¨ä¸äº†ã€‚æ–°ç‰ˆæœ¬ JDK æŠŠè¿™ä¸ªå·¥å…·å•ç‹¬æŠ½ç¦»äº†å‡ºå»ï¼Œéœ€è¦è‡ªè¡Œä¸‹è½½ã€‚</p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„ä¸‹è½½å®‰è£…å®Œæˆä¹‹åè¯·åœ¨æ’ä»¶é€‰é¡¹ä¸­å‹¾é€‰ Visual GC ä¸‹è½½ï¼Œå®ƒå°†å¯è§†åŒ–å†…å­˜å¸ƒå±€ã€‚</p>
<h2 id="å †æº¢å‡ºæ¨¡æ‹Ÿ">å †æº¢å‡ºæ¨¡æ‹Ÿ</h2>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿå †æº¢å‡ºçš„æƒ…å†µï¼Œåœ¨æ¨¡æ‹Ÿä¹‹å‰æˆ‘ä»¬éœ€è¦å‡†å¤‡ä¸€ä»½æµ‹è¯•ä»£ç ã€‚è¿™ä»½ä»£ç å¼€æ”¾äº†ä¸€ä¸ª HTTP æ¥å£ï¼Œå½“ä½ è§¦å‘å®ƒä¹‹åï¼Œå°†æ¯ç§’é’Ÿç”Ÿæˆ 1MB çš„æ•°æ®ã€‚ç”±äºå®ƒå’Œ GC Roots çš„å¼ºå…³è”æ€§ï¼Œæ¯æ¬¡éƒ½ä¸èƒ½è¢«å›æ”¶ã€‚</p>
<p>ç¨‹åºé€šè¿‡ JMXï¼Œå°†åœ¨æ¯ä¸€ç§’åˆ›å»ºæ•°æ®ä¹‹åï¼Œè¾“å‡ºä¸€äº›å†…å­˜åŒºåŸŸçš„å ç”¨æƒ…å†µã€‚ç„¶åé€šè¿‡è®¿é—® http://localhost:8888 è§¦å‘åï¼Œå®ƒå°†ä¸€ç›´è¿è¡Œï¼Œç›´åˆ°å †æº¢å‡ºã€‚</p>
<pre tabindex="0"><code>import com.sun.net.httpserver.HttpContext;
import com.sun.net.httpserver.HttpExchange;
import com.sun.net.httpserver.HttpServer;
import java.io.OutputStream;
import java.lang.management.ManagementFactory;
import java.lang.management.MemoryPoolMXBean;
import java.net.InetSocketAddress;
import java.util.ArrayList;
import java.util.List;
public class OOMTest {
   public static final int _1MB = 1024 * 1024;
   static List&lt;byte[]&gt; byteList = new ArrayList&lt;&gt;();
   private static void oom(HttpExchange exchange) {
       try {
           String response = &quot;oom begin!&quot;;
           exchange.sendResponseHeaders(200, response.getBytes().length);
           OutputStream os = exchange.getResponseBody();
           os.write(response.getBytes());
           os.close();
       } catch (Exception ex) {
       }
       for (int i = 0; ; i++) {
           byte[] bytes = new byte[_1MB];
           byteList.add(bytes);
           System.out.println(i + &quot;MB&quot;);
           memPrint();
           try {
               Thread.sleep(1000);
           } catch (Exception e) {
           }
       }
   }
   static void memPrint() {
       for (MemoryPoolMXBean memoryPoolMXBean : ManagementFactory.getMemoryPoolMXBeans()) {
           System.out.println(memoryPoolMXBean.getName() +
                   &quot;  committed:&quot; + memoryPoolMXBean.getUsage().getCommitted() +
                   &quot;  used:&quot; + memoryPoolMXBean.getUsage().getUsed());
       }
   }
   private static void srv() throws Exception {
       HttpServer server = HttpServer.create(new InetSocketAddress(8888), 0);
       HttpContext context = server.createContext(&quot;/&quot;);
       context.setHandler(OOMTest::oom);
       server.start();
   }
   public static void main(String[] args) throws Exception{
       srv();
   }
}
</code></pre><p>æˆ‘ä»¬ä½¿ç”¨ CMS æ”¶é›†å™¨è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„ä¿¡æ¯ã€‚</p>
<p>å‘½ä»¤ï¼š</p>
<p>java -Xmx20m -Xmn4m -XX:+UseConcMarkSweepGC -verbose:gc -Xlog:gc,</p>
<p>gc+ref=debug,gc+heap=debug,</p>
<p>gc+age=trace:file=/tmp/logs/gc_%p.log:tags,</p>
<p>uptime,</p>
<p>time,</p>
<p>level -Xlog:safepoint:file=/tmp/logs/safepoint_%p.log:tags,</p>
<p>uptime,</p>
<p>time,</p>
<p>level -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp/logs -XX:ErrorFile=/tmp/logs/hs_error_pid%p.log -XX:-OmitStackTraceInFastThrow OOMTest</p>
<p>è¾“å‡ºï¼š</p>
<p>[0.025s][info][gc] Using Concurrent Mark Sweep</p>
<p>0MB</p>
<p>CodeHeap &lsquo;non-nmethods&rsquo; committed:2555904 used:1120512</p>
<p>Metaspace committed:4980736 used:854432</p>
<p>CodeHeap &lsquo;profiled nmethods&rsquo; committed:2555904 used:265728</p>
<p>Compressed Class Space committed:524288 used:96184</p>
<p>Par Eden Space committed:3407872 used:2490984</p>
<p>Par Survivor Space committed:393216 used:0</p>
<p>CodeHeap &lsquo;non-profiled nmethods&rsquo; committed:2555904 used:78592</p>
<p>CMS Old Gen committed:16777216 used:0</p>
<p>&hellip;çœç•¥</p>
<p>[16.377s][info][gc] GC(9) Concurrent Mark 1.592ms</p>
<p>[16.377s][info][gc] GC(9) Concurrent Preclean</p>
<p>[16.378s][info][gc] GC(9) Concurrent Preclean 0.721ms</p>
<p>[16.378s][info][gc] GC(9) Concurrent Abortable Preclean</p>
<p>[16.378s][info][gc] GC(9) Concurrent Abortable Preclean 0.006ms</p>
<p>[16.378s][info][gc] GC(9) Pause Remark 17M-&gt;17M(19M) 0.344ms</p>
<p>[16.378s][info][gc] GC(9) Concurrent Sweep</p>
<p>[16.378s][info][gc] GC(9) Concurrent Sweep 0.248ms</p>
<p>[16.378s][info][gc] GC(9) Concurrent Reset</p>
<p>[16.378s][info][gc] GC(9) Concurrent Reset 0.013ms</p>
<p>17MB</p>
<p>CodeHeap &lsquo;non-nmethods&rsquo; committed:2555904 used:1120512</p>
<p>Metaspace committed:4980736 used:883760</p>
<p>CodeHeap &lsquo;profiled nmethods&rsquo; committed:2555904 used:422016</p>
<p>Compressed Class Space committed:524288 used:92432</p>
<p>Par Eden Space committed:3407872 used:3213392</p>
<p>Par Survivor Space committed:393216 used:0</p>
<p>CodeHeap &lsquo;non-profiled nmethods&rsquo; committed:2555904 used:88064</p>
<p>CMS Old Gen committed:16777216 used:16452312</p>
<p>[18.380s][info][gc] GC(10) Pause Initial Mark 18M-&gt;18M(19M) 0.187ms</p>
<p>[18.380s][info][gc] GC(10) Concurrent Mark</p>
<p>[18.384s][info][gc] GC(11) Pause Young (Allocation Failure) 18M-&gt;18M(19M) 0.186ms</p>
<p>[18.386s][info][gc] GC(10) Concurrent Mark 5.435ms</p>
<p>[18.395s][info][gc] GC(12) Pause Full (Allocation Failure) 18M-&gt;18M(19M) 10.572ms</p>
<p>[18.400s][info][gc] GC(13) Pause Full (Allocation Failure) 18M-&gt;18M(19M) 5.348ms</p>
<p>Exception in thread &ldquo;main&rdquo; java.lang.OutOfMemoryError: Java heap space</p>
<p>at OldOOM.main(OldOOM.java:20)</p>
<p>æœ€å JVM åœ¨ä¸€é˜µç–¯ç‹‚çš„ GC æ—¥å¿—è¾“å‡ºåï¼Œè¿›ç¨‹åœæ­¢äº†ã€‚åœ¨ç°å®æƒ…å†µä¸­ï¼ŒJVM åœ¨åœæ­¢å·¥ä½œä¹‹å‰ï¼Œå¾ˆå¤šä¼šå‚æ­»æŒ£æ‰ä¸€æ®µæ—¶é—´ï¼Œè¿™ä¸ªæ—¶å€™ï¼ŒGC çº¿ç¨‹ä¼šé€ æˆ CPU é£™å‡ï¼Œä½†å…¶å®å®ƒå·²ç»ä¸èƒ½å·¥ä½œäº†ã€‚</p>
<p>VisualVM çš„æˆªå›¾å±•ç¤ºäº†è¿™ä¸ªæº¢å‡ºç»“æœã€‚å¯ä»¥çœ‹åˆ° Eden åŒºåˆšå¼€å§‹è¿˜æ˜¯è¿è¡Œå¹³ç¨³çš„ï¼Œå†…å­˜æ³„æ¼ä¹‹åå°±å¼€å§‹ç–¯ç‹‚å›æ”¶ï¼ˆå…¶å®æ˜¯æå‡ï¼‰ï¼Œè€å¹´ä»£å†…å­˜ä¸€ç›´å¢é•¿ï¼Œç›´åˆ° OOMã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%20Java%20%E8%99%9A%E6%8B%9F%E6%9C%BA-%E5%AE%8C/assets/Cgq2xl5DytGAc09TAAFdBh0n9eo313.jpg" alt="img"></p>
<p>å¾ˆå¤šå‚æ•°ä¼šå½±å“å¯¹è±¡çš„åˆ†é…è¡Œä¸ºï¼Œä½†ä¸æ˜¯éå¸¸å¿…è¦ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¸å»è°ƒæ•´å®ƒä»¬ã€‚ä¸ºäº†è§‚å¯Ÿè¿™äº›å‚æ•°çš„é»˜è®¤å€¼ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ -XX:+PrintFlagsFinal å‚æ•°ï¼Œè¾“å‡ºä¸€äº›è®¾ç½®ä¿¡æ¯ã€‚</p>
<p>å‘½ä»¤ï¼š</p>
<p># java -XX:+PrintFlagsFinal 2&gt;&amp;1 | grep SurvivorRatio</p>
<p>uintx SurvivorRatio = 8 {product} {default}</p>
<p>Java13 è¾“å‡ºäº†å‡ ç™¾ä¸ªå‚æ•°å’Œé»˜è®¤å€¼ï¼Œæˆ‘ä»¬é€šè¿‡ä¿®æ”¹ä¸€äº›å‚æ•°æ¥è§‚æµ‹ä¸€äº›ä¸åŒçš„è¡Œä¸ºã€‚</p>
<p><strong>NewRatio</strong> é»˜è®¤å€¼ä¸º 2ï¼Œè¡¨ç¤ºå¹´è½»ä»£æ˜¯è€å¹´ä»£çš„ 1/2ã€‚è¿½åŠ å‚æ•° â€œ-XX:NewRatio=1â€ï¼Œå¯ä»¥æŠŠå¹´è½»ä»£å’Œè€å¹´ä»£çš„ç©ºé—´å¤§å°è°ƒæˆä¸€æ ·å¤§ã€‚åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨ -Xmn æ¥è®¾ç½®ä¸€ä¸ªå›ºå®šå€¼ã€‚æ³¨æ„ï¼Œè¿™ä¸¤ä¸ªå‚æ•°ä¸è¦ç”¨åœ¨ G1 åƒåœ¾å›æ”¶å™¨ä¸­ã€‚</p>
<p><strong>SurvivorRatio</strong> é»˜è®¤å€¼ä¸º 8ã€‚è¡¨ç¤ºä¼Šç”¸åŒºå’Œå¹¸å­˜åŒºçš„æ¯”ä¾‹ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒEden çš„å†…å­˜å¤§å°ä¸ºï¼š0.8*4MBã€‚S åˆ†åŒºä¸åˆ° 1MBï¼Œæ ¹æœ¬å­˜ä¸ä¸‹æˆ‘ä»¬çš„ 1MB æ•°æ®ã€‚</p>
<p><strong>MaxTenuringThreshold</strong> è¿™ä¸ªå€¼åœ¨ CMS ä¸‹é»˜è®¤ä¸º 6ï¼ŒG1 ä¸‹é»˜è®¤ä¸º 15ã€‚è¿™æ˜¯å› ä¸º G1 å­˜åœ¨åŠ¨æ€é˜ˆå€¼è®¡ç®—ã€‚è¿™ä¸ªå€¼å’Œæˆ‘ä»¬å‰é¢æåˆ°çš„å¯¹è±¡æå‡æœ‰å…³ï¼Œå¦‚æœä½ æƒ³è¦å¯¹è±¡å°½é‡é•¿çš„æ—¶é—´å­˜åœ¨äºå¹´è½»ä»£ï¼Œåˆ™åœ¨ CMS ä¸­ï¼Œå¯ä»¥æŠŠå®ƒè°ƒæ•´åˆ° 15ã€‚</p>
<p>java -XX:+PrintFlagsFinal -XX:+UseConcMarkSweepGC 2&gt;&amp;1 | grep MaxTenuringThreshold</p>
<p>java -XX:+PrintFlagsFinal -XX:+UseG1GC 2&gt;&amp;1 | grep MaxTenuringThreshold</p>
<p><strong>PretenureSizeThreshold</strong> è¿™ä¸ªå‚æ•°é»˜è®¤å€¼æ˜¯ 0ï¼Œæ„å‘³ç€æ‰€æœ‰çš„å¯¹è±¡å¹´è½»ä»£ä¼˜å…ˆåˆ†é…ã€‚æˆ‘ä»¬æŠŠè¿™ä¸ªå€¼è°ƒå°ä¸€ç‚¹ï¼Œå†è§‚æµ‹ JVM çš„è¡Œä¸ºã€‚è¿½åŠ å‚æ•° -XX:PretenureSizeThreshold=1024ï¼Œå¯ä»¥çœ‹åˆ° VisualVm ä¸­è€å¹´ä»£çš„åŒºåŸŸå¢é•¿ã€‚</p>
<p><strong>TargetSurvivorRatio</strong> é»˜è®¤å€¼ä¸º 50ã€‚åœ¨åŠ¨æ€è®¡ç®—å¯¹è±¡æå‡é˜ˆå€¼çš„æ—¶å€™ä½¿ç”¨ã€‚è®¡ç®—æ—¶ï¼Œä¼šä»å¹´é¾„æœ€å°çš„å¯¹è±¡å¼€å§‹ç´¯åŠ ï¼Œå¦‚æœç´¯åŠ çš„å¯¹è±¡å¤§å°å¤§äºå¹¸å­˜åŒºçš„ä¸€åŠï¼Œåˆ™å°†å½“å‰çš„å¯¹è±¡ age ä½œä¸ºæ–°çš„é˜ˆå€¼ï¼Œå¹´é¾„å¤§äºæ­¤é˜ˆå€¼çš„å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ã€‚å·¥ä½œä¸­ä¸å»ºè®®è°ƒæ•´è¿™ä¸ªå€¼ï¼Œå¦‚æœè¦è°ƒï¼Œè¯·è°ƒæˆæ¯” 50 å¤§çš„å€¼ã€‚</p>
<p>ä½ å¯ä»¥å°è¯•ç€æ›´æ”¹å…¶ä»–å‚æ•°ï¼Œæ¯”å¦‚åƒåœ¾å›æ”¶å™¨çš„ç§ç±»ï¼ŒåŠ¨æ€çœ‹ä¸€ä¸‹æ•ˆæœã€‚å°¤å…¶æ³¨æ„æ¯ä¸€é¡¹å†…å­˜åŒºåŸŸçš„å†…å®¹å˜åŠ¨ï¼Œä½ ä¼šå¯¹åƒåœ¾å›æ”¶å™¨æœ‰æ›´å¥½çš„ç†è§£ã€‚</p>
<p><strong>UseAdaptiveSizePolicy</strong> ï¼Œå› ä¸ºå®ƒå’Œ CMS ä¸å…¼å®¹ï¼Œæ‰€ä»¥ CMS ä¸‹é»˜è®¤ä¸º falseï¼Œä½† G1 ä¸‹é»˜è®¤ä¸º trueã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸æ™ºèƒ½çš„å‚æ•°ï¼Œå®ƒæ˜¯ç”¨æ¥è‡ªé€‚åº”è°ƒæ•´ç©ºé—´å¤§å°çš„å‚æ•°ã€‚å®ƒä¼šåœ¨æ¯æ¬¡ GC ä¹‹åï¼Œé‡æ–°è®¡ç®— Edenã€Fromã€To çš„å¤§å°ã€‚å¾ˆå¤šäººåœ¨ Java 8 çš„ä¸€äº›é…ç½®ä¸­ä¼šè§åˆ°è¿™ä¸ªå‚æ•°ï¼Œä½†å…¶å®åœ¨ CMS å’Œ G1 ä¸­æ˜¯ä¸éœ€è¦æ˜¾å¼è®¾ç½®çš„ã€‚</p>
<p>å€¼çš„æ³¨æ„çš„æ˜¯ï¼ŒJava 8 é»˜è®¤åƒåœ¾å›æ”¶å™¨æ˜¯ Parallel Scavengeï¼Œå®ƒçš„è¿™ä¸ªå‚æ•°æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œæœ‰å¯èƒ½ä¼šå‘ç”ŸæŠŠå¹¸å­˜åŒºè‡ªåŠ¨è°ƒå°çš„å¯èƒ½ï¼Œé€ æˆä¸€äº›é—®é¢˜ï¼Œæ˜¾å¼çš„è®¾ç½® SurvivorRatio å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>ä¸‹é¢è¿™å¼ æˆªå›¾ï¼Œæ˜¯åˆ‡æ¢åˆ° G1 ä¹‹åçš„æ•ˆæœã€‚</p>
<p>java -Xmx20m -XX:+UseG1GC -verbose:gc -Xlog:gc,gc+ref=debug,gc+heap=debug,gc+age=trace:file=/tmp/logs/gc_%p.log:tags,uptime,time,level -Xlog:safepoint:file=/tmp/logs/safepoint_%p.log:tags,uptime,time,level -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp/logs -XX:ErrorFile=/tmp/logs/hs_error_pid%p.log -XX:-OmitStackTraceInFastThrow OOMTest</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%20Java%20%E8%99%9A%E6%8B%9F%E6%9C%BA-%E5%AE%8C/assets/CgpOIF5DytKAIL4RAAE2rXZgveA253.jpg" alt="img"></p>
<p>å¯ä»¥é€šè¿‡ä¸‹é¢è¿™ä¸ªå‘½ä»¤è°ƒæ•´å°å †åŒºçš„å¤§å°ï¼Œæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ã€‚</p>
<p>-XX:G1HeapRegionSize=M</p>
<h2 id="å…ƒç©ºé—´æº¢å‡º">å…ƒç©ºé—´æº¢å‡º</h2>
<p>å †ä¸€èˆ¬éƒ½æ˜¯æŒ‡å®šå¤§å°çš„ï¼Œä½†å…ƒç©ºé—´ä¸æ˜¯ã€‚æ‰€ä»¥å¦‚æœå…ƒç©ºé—´å‘ç”Ÿå†…å­˜æº¢å‡ºä¼šæ›´åŠ ä¸¥é‡ï¼Œä¼šé€ æˆæ“ä½œç³»ç»Ÿçš„å†…å­˜æº¢å‡ºã€‚æˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œä¹Ÿä¼šç»™å®ƒè®¾ç½®ä¸€ä¸ªä¸Šé™ for safeã€‚</p>
<p>å…ƒç©ºé—´æº¢å‡ºä¸»è¦æ˜¯ç”±äºåŠ è½½çš„ç±»å¤ªå¤šï¼Œæˆ–è€…åŠ¨æ€ç”Ÿæˆçš„ç±»å¤ªå¤šã€‚ä¸‹é¢æ˜¯ä¸€æ®µæ¨¡æ‹Ÿä»£ç ã€‚é€šè¿‡è®¿é—® http://localhost:8888 è§¦å‘åï¼Œå®ƒå°†ä¼šå‘ç”Ÿå…ƒç©ºé—´æº¢å‡ºã€‚</p>
<pre tabindex="0"><code>import com.sun.net.httpserver.HttpContext;
import com.sun.net.httpserver.HttpExchange;
import com.sun.net.httpserver.HttpServer;
import java.io.OutputStream;
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Method;
import java.lang.reflect.Proxy;
import java.net.InetSocketAddress;
import java.net.URL;
import java.net.URLClassLoader;
import java.util.HashMap;
import java.util.Map;
public class MetaspaceOOMTest {
   public interface Facade {
       void m(String input);
   }
   public static class FacadeImpl implements Facade {
       @Override
       public void m(String name) {
       }
   }
   public static class MetaspaceFacadeInvocationHandler implements InvocationHandler {
       private Object impl;
       public MetaspaceFacadeInvocationHandler(Object impl) {
           this.impl = impl;
       }
       @Override
       public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
           return method.invoke(impl, args);
       }
   }
   private static Map&lt;String, Facade&gt; classLeakingMap = new HashMap&lt;String, Facade&gt;();
   private static void oom(HttpExchange exchange) {
       try {
           String response = &quot;oom begin!&quot;;
           exchange.sendResponseHeaders(200, response.getBytes().length);
           OutputStream os = exchange.getResponseBody();
           os.write(response.getBytes());
           os.close();
       } catch (Exception ex) {
       }
       try {
           for (int i = 0; ; i++) {
               String jar = &quot;file:&quot; + i + &quot;.jar&quot;;
               URL[] urls = new URL[]{new URL(jar)};
               URLClassLoader newClassLoader = new URLClassLoader(urls);
               Facade t = (Facade) Proxy.newProxyInstance(newClassLoader,
                       new Class&lt;?&gt;[]{Facade.class},
                       new MetaspaceFacadeInvocationHandler(new FacadeImpl()));
               classLeakingMap.put(jar, t);
           }
       } catch (Exception e) {
       }
   }
   private static void srv() throws Exception {
       HttpServer server = HttpServer.create(new InetSocketAddress(8888), 0);
       HttpContext context = server.createContext(&quot;/&quot;);
       context.setHandler(MetaspaceOOMTest::oom);
       server.start();
   }
   public static void main(String[] args) throws Exception {
       srv();
   }
}
</code></pre><p>è¿™æ®µä»£ç å°†ä½¿ç”¨ Java è‡ªå¸¦çš„åŠ¨æ€ä»£ç†ç±»ï¼Œä¸æ–­çš„ç”Ÿæˆæ–°çš„ classã€‚</p>
<p>java -Xmx20m -Xmn4m -XX:+UseG1GC -verbose:gc -Xlog:gc,gc+ref=debug,gc+heap=debug,gc+age=trace:file=/tmp/logs/gc_%p.log:tags,uptime,time,level -Xlog:safepoint:file=/tmp/logs/safepoint_%p.log:tags,uptime,time,level -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp/logs -XX:ErrorFile=/tmp/logs/hs_error_pid%p.log -XX:-OmitStackTraceInFastThrow -XX:MetaspaceSize=16M -XX:MaxMetaspaceSize=16M MetaspaceOOMTest</p>
<p>æˆ‘ä»¬åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œé™åˆ¶ Metaspace ç©ºé—´å¤§å°ä¸º 16MBã€‚å¯ä»¥çœ‹åˆ°è¿è¡Œä¸€å°ä¼šä¹‹åï¼ŒMetaspace ä¼šå‘ç”Ÿå†…å­˜æº¢å‡ºã€‚</p>
<p>[6.509s][info][gc] GC(28) Pause Young (Concurrent Start) (Metadata GC Threshold) 9M-&gt;9M(20M) 1.186ms</p>
<p>[6.509s][info][gc] GC(30) Concurrent Cycle</p>
<p>[6.534s][info][gc] GC(29) Pause Full (Metadata GC Threshold) 9M-&gt;9M(20M) 25.165ms</p>
<p>[6.556s][info][gc] GC(31) Pause Full (Metadata GC Clear Soft References) 9M-&gt;9M(20M) 21.136ms</p>
<p>[6.556s][info][gc] GC(30) Concurrent Cycle 46.668ms</p>
<p>java.lang.OutOfMemoryError: Metaspace</p>
<p>Dumping heap to /tmp/logs/java_pid36723.hprof &hellip;</p>
<p>Heap dump file created [17362313 bytes in 0.134 secs]</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%20Java%20%E8%99%9A%E6%8B%9F%E6%9C%BA-%E5%AE%8C/assets/Cgq2xl5DytKAMGfeAAE5q9rh1rM558.jpg" alt="img"></p>
<p>ä½†å‡å¦‚ä½ æŠŠå † Metaspace çš„é™åˆ¶ç»™å»æ‰ï¼Œä¼šæ›´å¯æ€•ã€‚å®ƒå ç”¨çš„å†…å­˜ä¼šä¸€ç›´å¢é•¿ã€‚</p>
<h2 id="å †å¤–å†…å­˜æº¢å‡º">å †å¤–å†…å­˜æº¢å‡º</h2>
<p>ä¸¥æ ¼æ¥è¯´ï¼Œä¸Šé¢çš„ Metaspace ä¹Ÿæ˜¯å±äºå †å¤–å†…å­˜çš„ã€‚ä½†æ˜¯æˆ‘ä»¬è¿™é‡Œçš„å †å¤–å†…å­˜æŒ‡çš„æ˜¯ Java åº”ç”¨ç¨‹åºé€šè¿‡ç›´æ¥æ–¹å¼ä»æ“ä½œç³»ç»Ÿä¸­ç”³è¯·çš„å†…å­˜ã€‚æ‰€ä»¥ä¸¥æ ¼æ¥è¯´ï¼Œè¿™é‡Œæ˜¯æŒ‡ç›´æ¥å†…å­˜ã€‚</p>
<p>ç¨‹åºå°†é€šè¿‡ ByteBuffer çš„ allocateDirect æ–¹æ³•æ¯ 1 ç§’é’Ÿç”³è¯· 1MB çš„ç›´æ¥å†…å­˜ã€‚ä¸è¦å¿˜äº†é€šè¿‡é“¾æ¥è§¦å‘è¿™ä¸ªè¿‡ç¨‹ã€‚</p>
<p>ä½†æ˜¯ï¼Œä½¿ç”¨ VisualVM çœ‹ä¸åˆ°è¿™ä¸ªè¿‡ç¨‹ï¼Œä½¿ç”¨ JMX çš„ API åŒæ ·ä¹Ÿçœ‹ä¸åˆ°ã€‚å…³äºè¿™éƒ¨åˆ†å†…å®¹ï¼Œæˆ‘ä»¬å°†åœ¨å †å¤–å†…å­˜æ’æŸ¥è¯¾æ—¶è¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚</p>
<pre tabindex="0"><code>import com.sun.net.httpserver.HttpContext;
import com.sun.net.httpserver.HttpExchange;
import com.sun.net.httpserver.HttpServer;
import java.io.OutputStream;
import java.lang.management.ManagementFactory;
import java.lang.management.MemoryPoolMXBean;
import java.net.InetSocketAddress;
import java.nio.ByteBuffer;
import java.util.ArrayList;
import java.util.List;
public class OffHeapOOMTest {
   public static final int _1MB = 1024 * 1024;
   static List&lt;ByteBuffer&gt; byteList = new ArrayList&lt;&gt;();
   private static void oom(HttpExchange exchange) {
       try {
           String response = &quot;oom begin!&quot;;
           exchange.sendResponseHeaders(200, response.getBytes().length);
           OutputStream os = exchange.getResponseBody();
           os.write(response.getBytes());
           os.close();
       } catch (Exception ex) {
       }
       for (int i = 0; ; i++) {
           ByteBuffer buffer = ByteBuffer.allocateDirect(_1MB);
           byteList.add(buffer);
           System.out.println(i + &quot;MB&quot;);
           memPrint();
           try {
               Thread.sleep(1000);
           } catch (Exception e) {
           }
       }
   }
   private static void srv() throws Exception {
       HttpServer server = HttpServer.create(new InetSocketAddress(8888), 0);
       HttpContext context = server.createContext(&quot;/&quot;);
       context.setHandler(OffHeapOOMTest::oom);
       server.start();
   }
   public static void main(String[] args) throws Exception {
       srv();
   }
   static void memPrint() {
       for (MemoryPoolMXBean memoryPoolMXBean : ManagementFactory.getMemoryPoolMXBeans()) {
           System.out.println(memoryPoolMXBean.getName() +
                   &quot;  committed:&quot; + memoryPoolMXBean.getUsage().getCommitted() +
                   &quot;  used:&quot; + memoryPoolMXBean.getUsage().getUsed());
       }
   }
}
</code></pre><p>é€šè¿‡ top æˆ–è€…æ“ä½œç³»ç»Ÿçš„ç›‘æ§å·¥å…·ï¼Œèƒ½å¤Ÿçœ‹åˆ°å†…å­˜å ç”¨çš„æ˜æ˜¾å¢é•¿ã€‚ä¸ºäº†é™åˆ¶è¿™äº›å±é™©çš„å†…å­˜ç”³è¯·ï¼Œå¦‚æœä½ ç¡®å®šåœ¨è‡ªå·±çš„ç¨‹åºä¸­ç”¨åˆ°äº†å¤§é‡çš„ JNI å’Œ JNA æ“ä½œï¼Œè¦æ˜¾å¼çš„è®¾ç½® MaxDirectMemorySize å‚æ•°ã€‚</p>
<p>ä»¥ä¸‹æ˜¯ç¨‹åºè¿è¡Œä¸€æ®µæ—¶é—´æŠ›å‡ºçš„é”™è¯¯ã€‚</p>
<p>Exception in thread &ldquo;Thread-2&rdquo; java.lang.OutOfMemoryError: Direct buffer memory</p>
<p>at java.nio.Bits.reserveMemory(Bits.java:694)</p>
<p>at java.nio.DirectByteBuffer.(DirectByteBuffer.java:123)</p>
<p>at java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:311)</p>
<p>at OffHeapOOMTest.oom(OffHeapOOMTest.java:27)</p>
<p>at com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:79)</p>
<p>at sun.net.httpserver.AuthFilter.doFilter(AuthFilter.java:83)</p>
<p>at com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:82)</p>
<p>at sun.net.httpserver.ServerImpl$Exchange$LinkHandler.handle(ServerImpl.java:675)</p>
<p>at com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:79)</p>
<p>at sun.net.httpserver.ServerImpl$Exchange.run(ServerImpl.java:647)</p>
<p>at sun.net.httpserver.ServerImpl$DefaultExecutor.execute(ServerImpl.java:158)</p>
<p>at sun.net.httpserver.ServerImpl$Dispatcher.handle(ServerImpl.java:431)</p>
<p>at sun.net.httpserver.ServerImpl$Dispatcher.run(ServerImpl.java:396)</p>
<p>at java.lang.Thread.run(Thread.java:748)</p>
<p>å¯åŠ¨å‘½ä»¤ã€‚</p>
<p>java -XX:MaxDirectMemorySize=10M -Xmx10M OffHeapOOMTest</p>
<h2 id="æ ˆæº¢å‡º">æ ˆæº¢å‡º</h2>
<p>è¿˜è®°å¾—æˆ‘ä»¬çš„è™šæ‹Ÿæœºæ ˆä¹ˆï¼Ÿæ ˆæº¢å‡ºæŒ‡çš„å°±æ˜¯è¿™é‡Œçš„æ•°æ®å¤ªå¤šé€ æˆçš„æ³„æ¼ã€‚é€šè¿‡ -Xss å‚æ•°å¯ä»¥è®¾ç½®å®ƒçš„å¤§å°ã€‚æ¯”å¦‚ä¸‹é¢çš„å‘½ä»¤å°±æ˜¯è®¾ç½®æ ˆå¤§å°ä¸º 128Kã€‚</p>
<p>-Xss128K</p>
<p>ä»è¿™é‡Œæˆ‘ä»¬ä¹Ÿèƒ½äº†è§£åˆ°ï¼Œç”±äºæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªè™šæ‹Ÿæœºæ ˆã€‚çº¿ç¨‹çš„å¼€é”€ä¹Ÿæ˜¯è¦å ç”¨å†…å­˜çš„ã€‚å¦‚æœç³»ç»Ÿä¸­çš„çº¿ç¨‹æ•°é‡è¿‡å¤šï¼Œé‚£ä¹ˆå ç”¨å†…å­˜çš„å¤§å°ä¹Ÿæ˜¯éå¸¸å¯è§‚çš„ã€‚</p>
<p>æ ˆæº¢å‡ºä¸ä¼šé€ æˆ JVM è¿›ç¨‹æ­»äº¡ï¼Œå±å®³â€œç›¸å¯¹è¾ƒå°â€ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„æ¨¡æ‹Ÿæ ˆæº¢å‡ºçš„ä»£ç ï¼Œåªéœ€è¦é€’å½’è°ƒç”¨å°±å¯ä»¥äº†ã€‚</p>
<pre tabindex="0"><code>public class StackOverflowTest {
   static int count = 0;
   static void a() {
       System.out.println(count);
       count++;
       b();
   }
   static void b() {
       System.out.println(count);
       count++;
       a();
   }
   public static void main(String[] args) throws Exception {
       a();
   }
}
</code></pre><p>è¿è¡Œåï¼Œç¨‹åºç›´æ¥æŠ¥é”™ã€‚</p>
<p>Exception in thread &ldquo;main&rdquo; java.lang.StackOverflowError</p>
<p>at java.io.PrintStream.write(PrintStream.java:526)</p>
<p>at java.io.PrintStream.print(PrintStream.java:597)</p>
<p>at java.io.PrintStream.println(PrintStream.java:736)</p>
<p>at StackOverflowTest.a(StackOverflowTest.java:5)</p>
<p>å¦‚æœä½ çš„åº”ç”¨ç»å¸¸å‘ç”Ÿè¿™ç§æƒ…å†µï¼Œå¯ä»¥è¯•ç€è°ƒå¤§è¿™ä¸ªå€¼ã€‚ä½†ä¸€èˆ¬éƒ½æ˜¯å› ä¸ºç¨‹åºé”™è¯¯å¼•èµ·çš„ï¼Œæœ€å¥½æ£€æŸ¥ä¸€ä¸‹è‡ªå·±çš„ä»£ç ã€‚</p>
<h2 id="è¿›ç¨‹å¼‚å¸¸é€€å‡º">è¿›ç¨‹å¼‚å¸¸é€€å‡º</h2>
<p>ä¸Šé¢è¿™å‡ ç§æº¢å‡ºåœºæ™¯ï¼Œéƒ½æœ‰æ˜ç¡®çš„åŸå› å’ŒæŠ¥é”™ï¼Œæ’æŸ¥èµ·æ¥ä¹Ÿæ˜¯éå¸¸å®¹æ˜“çš„ã€‚ä½†æ˜¯è¿˜æœ‰ä¸€ç±»åº”ç”¨ï¼Œæ­»äº¡çš„æ—¶å€™ï¼Œé™æ‚„æ‚„çš„ï¼Œä»€ä¹ˆéƒ½æ²¡ç•™ä¸‹ã€‚</p>
<p>ä»¥ä¸‹é—®é¢˜å·²ç»ä¸æ­¢ä¸€ä¸ªåŒå­¦é—®äº†ï¼š<strong>æˆ‘çš„ Java è¿›ç¨‹æ²¡äº†ï¼Œä»€ä¹ˆéƒ½æ²¡ç•™ä¸‹ï¼Œç›´æ¥è’¸å‘ä¸è§äº†</strong></p>
<p>whyï¼Ÿæ˜¯å› ä¸ºå¯¹è±¡å¤ªå¤šäº†ä¹ˆï¼Ÿ</p>
<p>è¿™æ˜¯è¶£å‘³æ€§å’ŒæŠ€å·§æ€§éå¸¸çªå‡ºçš„ä¸€ä¸ªé—®é¢˜ã€‚è®©æˆ‘ä»¬æ‰§è¡Œ dmesg å‘½ä»¤ï¼Œå¤§æ¦‚ç‡ä¼šçœ‹åˆ°ä½ çš„è¿›ç¨‹å´©æºƒä¿¡æ¯èººåœ¨é‚£é‡Œã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%20Java%20%E8%99%9A%E6%8B%9F%E6%9C%BA-%E5%AE%8C/assets/CgpOIF5DytKAL-kVAAEITZsHixY196.jpg" alt="img"></p>
<p>ä¸ºäº†èƒ½çœ‹åˆ°å‘ç”Ÿçš„æ—¶é—´ï¼Œæˆ‘ä»¬ä¹ æƒ¯æ€§åŠ ä¸Šå‚æ•° Tï¼ˆdmesg -Tï¼‰ã€‚</p>
<p>è¿™ä¸ªç°è±¡ï¼Œå…¶å®å’Œ Linux çš„å†…å­˜ç®¡ç†æœ‰å…³ã€‚ç”±äº Linux ç³»ç»Ÿé‡‡ç”¨çš„æ˜¯è™šæ‹Ÿå†…å­˜åˆ†é…æ–¹å¼ï¼ŒJVM çš„ä»£ç ã€åº“ã€å †å’Œæ ˆçš„ä½¿ç”¨éƒ½ä¼šæ¶ˆè€—å†…å­˜ï¼Œä½†æ˜¯ç”³è¯·å‡ºæ¥çš„å†…å­˜ï¼Œåªè¦æ²¡çœŸæ­£ accessè¿‡ï¼Œæ˜¯ä¸ç®—çš„ï¼Œå› ä¸ºæ²¡æœ‰çœŸæ­£ä¸ºä¹‹åˆ†é…ç‰©ç†é¡µé¢ã€‚</p>
<p>éšç€ä½¿ç”¨å†…å­˜è¶Šç”¨è¶Šå¤šã€‚ç¬¬ä¸€å±‚é˜²æŠ¤å¢™å°±æ˜¯ SWAPï¼›å½“ SWAP ä¹Ÿç”¨çš„å·®ä¸å¤šäº†ï¼Œä¼šå°è¯•é‡Šæ”¾ cacheï¼›å½“è¿™ä¸¤è€…èµ„æºéƒ½è€—å°½ï¼Œæ€æ‰‹å°±å‡ºç°äº†ã€‚oom-killer ä¼šåœ¨ç³»ç»Ÿå†…å­˜è€—å°½çš„æƒ…å†µä¸‹è·³å‡ºæ¥ï¼Œé€‰æ‹©æ€§çš„å¹²æ‰ä¸€äº›è¿›ç¨‹ä»¥æ±‚é‡Šæ”¾ä¸€ç‚¹å†…å­˜ã€‚</p>
<p>æ‰€ä»¥è¿™æ—¶å€™æˆ‘ä»¬çš„ Java è¿›ç¨‹ï¼Œæ˜¯æ“ä½œç³»ç»Ÿâ€œä¸»åŠ¨â€ç»ˆç»“çš„ï¼ŒJVM è¿å‘è¡¨é—è¨€çš„æœºä¼šéƒ½æ²¡æœ‰ã€‚è¿™ä¸ªä¿¡æ¯ï¼Œåªèƒ½åœ¨æ“ä½œç³»ç»Ÿæ—¥å¿—é‡ŒæŸ¥æ‰¾ã€‚</p>
<p>è¦è§£å†³è¿™ç§é—®é¢˜ï¼Œé¦–å…ˆä¸èƒ½å¤ªè´ªå©ªã€‚æ¯”å¦‚ä¸€å…± 8GB çš„æœºå™¨ï¼Œä½ æŠŠæ•´æ•´ 7.5GB éƒ½åˆ†é…ç»™äº† JVMã€‚å½“æ“ä½œç³»ç»Ÿå†…å­˜ä¸è¶³æ—¶ï¼Œä½ çš„ JVM å°±å¯èƒ½æˆä¸º oom-killer çš„çŒç‰©ã€‚</p>
<p>ç›¸å¯¹äºè¢«åŠ¨ç»ˆç»“ï¼Œè¿˜æœ‰ä¸€ç§ä¸»åŠ¨æ±‚æ­»çš„æ–¹å¼ã€‚æœ‰äº›åŒå­¦ï¼Œä¼šåœ¨ç¨‹åºé‡Œé¢åšä¸€äº›åˆ¤æ–­ï¼Œç›´æ¥è°ƒç”¨ System.exit() å‡½æ•°ã€‚</p>
<p>è¿™ä¸ªå‡½æ•°å±é™©å¾—å¾ˆï¼Œå®ƒå°†å¼ºåˆ¶ç»ˆæ­¢æˆ‘ä»¬çš„åº”ç”¨ï¼Œè€Œä¸”ä»€ä¹ˆéƒ½ä¸ä¼šç•™ä¸‹ã€‚ä½ åº”è¯¥æ‰«æä½ çš„ä»£ç ï¼Œç¡®ä¿è¿™æ ·çš„é€»è¾‘ä¸ä¼šå­˜åœ¨ã€‚</p>
<p>å†èŠä¸€ç§æœ€åˆçº§æœ€å¸¸è§è¿˜ç»å¸¸å‘ç”Ÿçš„ï¼Œä¼šé€ æˆåº”ç”¨ç¨‹åºæ„å¤–æ­»äº¡çš„æƒ…å†µï¼Œé‚£å°±æ˜¯å¯¹ Java ç¨‹åºé”™è¯¯çš„å¯åŠ¨æ–¹å¼ã€‚</p>
<p>å¾ˆå¤šåŒå­¦å¯¹ Linux ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œä½¿ç”¨ XShell ç™»é™†ä¹‹åï¼Œè°ƒç”¨ä¸‹é¢çš„å‘½ä»¤è¿›è¡Œå¯åŠ¨ã€‚</p>
<p>java com.cn.AA &amp;</p>
<p>è¿™æ ·è°ƒç”¨è¿˜ç®—æœ‰ç‚¹æ„è¯†ï¼Œåœ¨æœ€åä½¿ç”¨äº†â€œ&amp;â€å·ï¼Œä»¥æœŸæœ›è¿›ç¨‹åœ¨åå°è¿è¡Œã€‚ä½†å¯æƒœçš„æ˜¯ï¼Œå¾ˆå¤šæƒ…å†µä¸‹ï¼Œéšç€ XShell Tab é¡µçš„å…³é—­ï¼Œæˆ–è€…ç­‰å¾…è¶…æ—¶ï¼Œåé¢çš„ Java è¿›ç¨‹å°±éšç€ä¸€å—åœæ­¢äº†ï¼Œå¾ˆè®©äººå›°æƒ‘ã€‚</p>
<p>æ­£ç¡®çš„å¯åŠ¨æ–¹å¼ï¼Œå°±æ˜¯ä½¿ç”¨ nohup å…³é”®å­—ï¼Œæˆ–è€…é˜»å¡åœ¨å…¶ä»–æ›´åŠ é•¿å‘½çš„è¿›ç¨‹é‡Œï¼ˆæ¯”å¦‚dockerï¼‰ã€‚</p>
<p>nohup java com.cn.AA &amp;</p>
<p>è¿›ç¨‹è¿™ç§é™æ‚„æ‚„çš„æ­»äº¡æ–¹å¼ï¼Œé€šå¸¸ä¼šç»™æˆ‘ä»¬çš„é—®é¢˜æ’æŸ¥å¸¦æ¥æ›´å¤šçš„å›°éš¾ã€‚</p>
<p>åœ¨å‘ç”Ÿé—®é¢˜æ—¶ï¼Œè¦ç¡®ä¿ç•™ä¸‹äº†è¶³å¤Ÿçš„è¯æ®ï¼Œæ¥æ”¯æŒæ¥ä¸‹æ¥çš„åˆ†æã€‚ä¸èƒ½å–Šä¸€å¥â€œå‡ºäº‹å•¦â€ï¼Œç„¶åå°±é™·å…¥æ— ä»ä¸‹æ‰‹çš„å°´å°¬å¢ƒåœ°ã€‚</p>
<p>é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨å…³é—­æœåŠ¡çš„æ—¶å€™ï¼Œä¼šä½¿ç”¨â€œkill -15â€ï¼Œè€Œä¸æ˜¯â€œkill -9â€ï¼Œä»¥ä¾¿è®©æœåŠ¡åœ¨ä¸´æ­»ä¹‹å‰å–˜å£æ°”ã€‚ä¿¡å·9å’Œ15çš„åŒºåˆ«ï¼Œæ˜¯é¢è¯•ç»å¸¸é—®çš„ä¸€ä¸ªé—®é¢˜ï¼Œä¹Ÿæ˜¯ä¸€ç§éå¸¸æœ‰æ•ˆçš„æ‰‹æ®µã€‚</p>
<h2 id="å°ç»“">å°ç»“</h2>
<p>æœ¬è¯¾æ—¶æˆ‘ä»¬ç®€å•æ¨¡æ‹Ÿäº†å †ã€å…ƒç©ºé—´ã€æ ˆçš„æº¢å‡ºã€‚å¹¶ä½¿ç”¨ VisualVM è§‚å¯Ÿäº†è¿™ä¸ªè¿‡ç¨‹ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬äº†è§£åˆ°è¿›ç¨‹é™æ‚„æ‚„æ¶ˆå¤±çš„ä¸‰ç§æƒ…å†µã€‚å¦‚æœä½ çš„åº”ç”¨ä¹Ÿè¿™æ ·æ¶ˆå¤±è¿‡ï¼Œè¯•ç€è¿™æ ·æ‰¾æ‰¾å®ƒã€‚è¿™ä¸‰ç§æƒ…å†µä¹Ÿæ˜¯ä¸€ä¸ªæ•…éšœæ’æŸ¥æµç¨‹ä¸­è¦è€ƒè™‘çš„ç¯èŠ‚ï¼Œå±äºéå¸¸é‡è¦çš„è¾¹ç¼˜æ£€æŸ¥ç‚¹ã€‚ç›¸ä¿¡èªæ˜çš„ä½ ï¼Œä¼šå°†è¿™äº›æƒ…å†µæ‰è¿›è‡ªå·±çš„é¢è¯•ä½“ç³»å»ï¼ŒçœŸæ­£æˆä¸ºè‡ªå·±çš„å®æˆ˜ç»éªŒã€‚</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/10-%E7%AC%AC09%E8%AE%B2%E6%A1%88%E4%BE%8B%E5%AE%9E%E6%88%98%E9%9D%A2%E5%AF%B9%E7%AA%81%E5%A6%82%E5%85%B6%E6%9D%A5%E7%9A%84-gc-%E9%97%AE%E9%A2%98%E5%A6%82%E4%BD%95%E4%B8%8B%E6%89%8B%E8%A7%A3%E5%86%B3/"><span>10 ç¬¬09è®²ï¼šæ¡ˆä¾‹å®æˆ˜ï¼šé¢å¯¹çªå¦‚å…¶æ¥çš„ GC é—®é¢˜å¦‚ä½•ä¸‹æ‰‹è§£å†³</span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/12-%E7%AC%AC11%E8%AE%B2%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5%E9%81%87%E5%88%B0%E9%97%AE%E9%A2%98%E4%B8%8D%E8%A6%81%E6%85%8C%E8%BD%BB%E6%9D%BE%E6%90%9E%E5%AE%9A%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"><span>12 ç¬¬11è®²ï¼šåŠ¨æ‰‹å®è·µï¼šé‡åˆ°é—®é¢˜ä¸è¦æ…Œï¼Œè½»æ¾æå®šå†…å­˜æ³„æ¼</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 27270 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>