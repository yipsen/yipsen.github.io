<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta name="X-UA-Compatible" , content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="/%20/favicon.png">

<title>14 åŠ¨æ‰‹å®è·µï¼šè®©é¢è¯•å®˜åˆ®ç›®ç›¸çœ‹çš„å †å¤–å†…å­˜æ’æŸ¥ | Yipsen Ye</title>
<meta name="description" content="æœ¬è¯¾æ—¶æˆ‘ä»¬ä¸»è¦è®²è§£è®©é¢è¯•å®˜åˆ®ç›®ç›¸çœ‹çš„å †å¤–å†…å­˜æ’æŸ¥ã€‚
ç¬¬ 02 è¯¾æ—¶è®²äº† JVM çš„å†…å­˜å¸ƒå±€ï¼ŒåŒæ—¶ä¹Ÿåœ¨ç¬¬ 08 è¯¾æ—¶ä¸­çœ‹åˆ°äº†ç”±äº Metaspace è®¾ç½®è¿‡å°è€Œå¼•èµ·çš„é—®é¢˜ï¼Œæ¥ç€ï¼Œç¬¬ 10 è¯¾æ—¶è®²äº†ä¸€ä¸‹å…ƒç©ºé—´å’Œç›´æ¥å†…å­˜å¼•èµ·çš„å†…å­˜æº¢å‡ºå®ä¾‹ã€‚
Metaspace å±äºå †å¤–å†…å­˜ï¼Œä½†ç”±äºå®ƒæ˜¯å•ç‹¬ç®¡ç†çš„ï¼Œæ‰€ä»¥æ’æŸ¥èµ·æ¥æ²¡ä»€ä¹ˆéš¾åº¦ã€‚ä½ å¹³å¸¸å¯èƒ½è§åˆ°çš„ä½¿ç”¨å †å¤–å†…å­˜çš„åœºæ™¯è¿˜æœ‰ä¸‹é¢è¿™äº›ï¼š
 JNI æˆ–è€… JNA ç¨‹åºï¼Œç›´æ¥æ“çºµäº†æœ¬åœ°å†…å­˜ï¼Œæ¯”å¦‚ä¸€äº›åŠ å¯†åº“ï¼› ä½¿ç”¨äº†Java çš„ Unsafe ç±»ï¼Œåšäº†ä¸€äº›æœ¬åœ°å†…å­˜çš„æ“ä½œï¼› Netty çš„ç›´æ¥å†…å­˜ï¼ˆDirect Memoryï¼‰ï¼Œåº•å±‚ä¼šè°ƒç”¨æ“ä½œç³»ç»Ÿçš„ malloc å‡½æ•°ã€‚  ä½¿ç”¨å †å¤–å†…å­˜å¯ä»¥è°ƒç”¨ä¸€äº›åŠŸèƒ½å®Œå¤‡çš„åº“å‡½æ•°ï¼Œè€Œä¸”å‡è½»äº† GC çš„å‹åŠ›ã€‚è¿™äº›ä»£ç ï¼Œæœ‰å¯èƒ½æ˜¯ä½ äº†è§£çš„äººå†™çš„ï¼Œä¹Ÿæœ‰å¯èƒ½éšè—åœ¨ç¬¬ä¸‰æ–¹çš„ jar åŒ…é‡Œã€‚è™½ç„¶æœ‰ä¸€äº›å¥½å¤„ï¼Œä½†æ˜¯é—®é¢˜æ’æŸ¥èµ·æ¥é€šå¸¸ä¼šæ¯”è¾ƒçš„å›°éš¾ã€‚
åœ¨ç¬¬ 10 è¯¾æ—¶ï¼Œä»‹ç»äº† MaxDirectMemorySize å¯ä»¥æ§åˆ¶ç›´æ¥å†…å­˜çš„ç”³è¯·ã€‚å…¶å®ï¼Œé€šè¿‡è¿™ä¸ªå‚æ•°ï¼Œä»ç„¶é™åˆ¶ä¸ä½æ‰€æœ‰å †å¤–å†…å­˜çš„ä½¿ç”¨ï¼Œå®ƒåªæ˜¯é™åˆ¶äº†ä½¿ç”¨ DirectByteBuffer çš„å†…å­˜ç”³è¯·ã€‚å¾ˆå¤šæ—¶å€™ï¼ˆæ¯”å¦‚ç›´æ¥ä½¿ç”¨äº† sun.misc.Unsafe ç±»ï¼‰ï¼Œå †å¤–å†…å­˜ä¼šä¸€ç›´å¢é•¿ï¼Œç›´åˆ°æœºå™¨ç‰©ç†å†…å­˜çˆ†æ»¡ï¼Œè¢« oom killerã€‚
import sun.misc.Unsafe;import java.lang.reflect.Field;public class UnsafeDemo {public static final int _1MB = 1024 * 1024;public static void main(String[] args) throws Exception {Field field = Unsafe.">
<meta name="author" content="">

<link rel="stylesheet" type="text/css" href="/styles/main.css">

</head>

<body id="page">
    <header>
        <div class="logo-link" style="width: 60px; color: #CA6924;">
    <a href="http://yipsen.github.io/">
        <img style="margin-bottom: -1rem;" src="/images/deer.svg" alt="logo">
        <span style="font-size: 0.5rem; color: #CA6924;">Yipsen Ye</span>
    </a>
</div>
<nav class="navbar justify-content-end">
    <ul class="nav-list">
        
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/posts/">æœ­è®°</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/collections/">é™„è¡¨</a>
        </li>
        
        <li class="nav-item">
            <a class="nav-link"
                href="http://yipsen.github.io/about/">å…³äº</a>
        </li>
        
    </ul>
</nav>
    </header>
    <main id="content">
        
<div class="container"><aside>
    <div>
        
        
            
            
            <div class="post-category-icon"></div>
            <a href="/categories/%e6%b7%b1%e5%85%a5%e6%b5%85%e5%87%bajava%e8%99%9a%e6%8b%9f%e6%9c%ba/">æ·±å…¥æµ…å‡ºJavaè™šæ‹Ÿæœº</a>
            <ul>
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/00-%E5%BC%80%E7%AF%87%E8%AF%8Djvm%E4%B8%80%E5%9D%97%E9%9A%BE%E5%95%83%E7%9A%84%E9%AA%A8%E5%A4%B4/">00 å¼€ç¯‡è¯ï¼šJVMï¼Œä¸€å—éš¾å•ƒçš„éª¨å¤´</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/01-%E4%B8%80%E6%8E%A2%E7%A9%B6%E7%AB%9F%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-jvm%E5%AE%83%E5%A4%84%E5%9C%A8%E4%BB%80%E4%B9%88%E4%BD%8D%E7%BD%AE/">01 ä¸€æ¢ç©¶ç«Ÿï¼šä¸ºä»€ä¹ˆéœ€è¦ JVMï¼Ÿå®ƒå¤„åœ¨ä»€ä¹ˆä½ç½®ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/02-%E5%A4%A7%E5%8E%82%E9%9D%A2%E8%AF%95%E9%A2%98%E4%BD%A0%E4%B8%8D%E5%BE%97%E4%B8%8D%E6%8E%8C%E6%8F%A1%E7%9A%84-jvm-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">02 å¤§å‚é¢è¯•é¢˜ï¼šä½ ä¸å¾—ä¸æŒæ¡çš„ JVM å†…å­˜ç®¡ç†</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/03-%E5%A4%A7%E5%8E%82%E9%9D%A2%E8%AF%95%E9%A2%98%E4%BB%8E%E8%A6%86%E7%9B%96-jdk-%E7%9A%84%E7%B1%BB%E5%BC%80%E5%A7%8B%E6%8E%8C%E6%8F%A1%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/">03 å¤§å‚é¢è¯•é¢˜ï¼šä»è¦†ç›– JDK çš„ç±»å¼€å§‹æŒæ¡ç±»çš„åŠ è½½æœºåˆ¶</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/04-%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5%E4%BB%8E%E6%A0%88%E5%B8%A7%E7%9C%8B%E5%AD%97%E8%8A%82%E7%A0%81%E6%98%AF%E5%A6%82%E4%BD%95%E5%9C%A8-jvm-%E4%B8%AD%E8%BF%9B%E8%A1%8C%E6%B5%81%E8%BD%AC%E7%9A%84/">04 åŠ¨æ‰‹å®è·µï¼šä»æ ˆå¸§çœ‹å­—èŠ‚ç æ˜¯å¦‚ä½•åœ¨ JVM ä¸­è¿›è¡Œæµè½¬çš„</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/05-%E5%A4%A7%E5%8E%82%E9%9D%A2%E8%AF%95%E9%A2%98%E5%BE%97%E5%BF%83%E5%BA%94%E6%89%8B%E5%BA%94%E5%AF%B9-oom-%E7%9A%84%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/">05 å¤§å‚é¢è¯•é¢˜ï¼šå¾—å¿ƒåº”æ‰‹åº”å¯¹ OOM çš„ç–‘éš¾æ‚ç—‡</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/06-%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%E5%90%97%E4%B8%8A/">06 æ·±å…¥å‰–æï¼šåƒåœ¾å›æ”¶ä½ çœŸçš„äº†è§£å—ï¼Ÿï¼ˆä¸Šï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/07-%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%E5%90%97%E4%B8%8B/">07 æ·±å…¥å‰–æï¼šåƒåœ¾å›æ”¶ä½ çœŸçš„äº†è§£å—ï¼Ÿï¼ˆä¸‹ï¼‰</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/08-%E5%A4%A7%E5%8E%82%E9%9D%A2%E8%AF%95%E9%A2%98%E6%9C%89%E4%BA%86-g1-%E8%BF%98%E9%9C%80%E8%A6%81%E5%85%B6%E4%BB%96%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8%E5%90%97/">08 å¤§å‚é¢è¯•é¢˜ï¼šæœ‰äº† G1 è¿˜éœ€è¦å…¶ä»–åƒåœ¾å›æ”¶å™¨å—ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/09-%E6%A1%88%E4%BE%8B%E5%AE%9E%E6%88%98%E4%BA%BF%E7%BA%A7%E6%B5%81%E9%87%8F%E9%AB%98%E5%B9%B6%E5%8F%91%E4%B8%8B%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E4%BC%B0%E7%AE%97%E5%92%8C%E8%B0%83%E4%BC%98/">09 æ¡ˆä¾‹å®æˆ˜ï¼šäº¿çº§æµé‡é«˜å¹¶å‘ä¸‹å¦‚ä½•è¿›è¡Œä¼°ç®—å’Œè°ƒä¼˜</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/10-%E7%AC%AC09%E8%AE%B2%E6%A1%88%E4%BE%8B%E5%AE%9E%E6%88%98%E9%9D%A2%E5%AF%B9%E7%AA%81%E5%A6%82%E5%85%B6%E6%9D%A5%E7%9A%84-gc-%E9%97%AE%E9%A2%98%E5%A6%82%E4%BD%95%E4%B8%8B%E6%89%8B%E8%A7%A3%E5%86%B3/">10 ç¬¬09è®²ï¼šæ¡ˆä¾‹å®æˆ˜ï¼šé¢å¯¹çªå¦‚å…¶æ¥çš„ GC é—®é¢˜å¦‚ä½•ä¸‹æ‰‹è§£å†³</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/11-%E7%AC%AC10%E8%AE%B2%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5%E8%87%AA%E5%B7%B1%E6%A8%A1%E6%8B%9F-jvm-%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA%E5%9C%BA%E6%99%AF/">11 ç¬¬10è®²ï¼šåŠ¨æ‰‹å®è·µï¼šè‡ªå·±æ¨¡æ‹Ÿ JVM å†…å­˜æº¢å‡ºåœºæ™¯</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/12-%E7%AC%AC11%E8%AE%B2%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5%E9%81%87%E5%88%B0%E9%97%AE%E9%A2%98%E4%B8%8D%E8%A6%81%E6%85%8C%E8%BD%BB%E6%9D%BE%E6%90%9E%E5%AE%9A%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/">12 ç¬¬11è®²ï¼šåŠ¨æ‰‹å®è·µï¼šé‡åˆ°é—®é¢˜ä¸è¦æ…Œï¼Œè½»æ¾æå®šå†…å­˜æ³„æ¼</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/13-%E5%B7%A5%E5%85%B7%E8%BF%9B%E9%98%B6%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8-mat-%E6%89%BE%E5%88%B0%E9%97%AE%E9%A2%98%E5%8F%91%E7%94%9F%E7%9A%84%E6%A0%B9%E6%9C%AC%E5%8E%9F%E5%9B%A0/">13 å·¥å…·è¿›é˜¶ï¼šå¦‚ä½•åˆ©ç”¨ MAT æ‰¾åˆ°é—®é¢˜å‘ç”Ÿçš„æ ¹æœ¬åŸå› </a></li>
                
                
                
                    <li>14 åŠ¨æ‰‹å®è·µï¼šè®©é¢è¯•å®˜åˆ®ç›®ç›¸çœ‹çš„å †å¤–å†…å­˜æ’æŸ¥</li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/15-%E9%A2%84%E8%AD%A6%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA-gc-%E7%9B%91%E6%8E%A7%E4%B8%8E%E8%B0%83%E4%BC%98/">15 é¢„è­¦ä¸è§£å†³ï¼šæ·±å…¥æµ…å‡º GC ç›‘æ§ä¸è°ƒä¼˜</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/16-%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90%E4%B8%80%E4%B8%AA%E9%AB%98%E6%AD%BB%E4%BA%A1%E7%8E%87%E7%9A%84%E6%8A%A5%E8%A1%A8%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BC%98%E5%8C%96%E4%B9%8B%E8%B7%AF/">16 æ¡ˆä¾‹åˆ†æï¼šä¸€ä¸ªé«˜æ­»äº¡ç‡çš„æŠ¥è¡¨ç³»ç»Ÿçš„ä¼˜åŒ–ä¹‹è·¯</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/17-%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%90%8E%E6%88%91%E7%9A%84%E5%BA%94%E7%94%A8%E5%B4%A9%E6%BA%83%E4%BA%86/">17 æ¡ˆä¾‹åˆ†æï¼šåˆ†åº“åˆ†è¡¨åï¼Œæˆ‘çš„åº”ç”¨å´©æºƒäº†</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/18-%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5%E4%BB%8E%E5%AD%97%E8%8A%82%E7%A0%81%E7%9C%8B%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0/">18 åŠ¨æ‰‹å®è·µï¼šä»å­—èŠ‚ç çœ‹æ–¹æ³•è°ƒç”¨çš„åº•å±‚å®ç°</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/19-%E5%A4%A7%E5%8E%82%E9%9D%A2%E8%AF%95%E9%A2%98%E4%B8%8D%E8%A6%81%E6%90%9E%E6%B7%B7-jmm-%E4%B8%8E-jvm/">19 å¤§å‚é¢è¯•é¢˜ï¼šä¸è¦ææ·· JMM ä¸ JVM</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/20-%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5%E4%BB%8E%E5%AD%97%E8%8A%82%E7%A0%81%E7%9C%8B%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0/">20 åŠ¨æ‰‹å®è·µï¼šä»å­—èŠ‚ç çœ‹å¹¶å‘ç¼–ç¨‹çš„åº•å±‚å®ç°</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/21-%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5%E4%B8%8D%E4%B8%BA%E4%BA%BA%E7%86%9F%E7%9F%A5%E7%9A%84%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4/">21 åŠ¨æ‰‹å®è·µï¼šä¸ä¸ºäººç†ŸçŸ¥çš„å­—èŠ‚ç æŒ‡ä»¤</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/22-%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-java-agent-%E6%8A%80%E6%9C%AF%E5%AF%B9%E5%AD%97%E8%8A%82%E7%A0%81%E8%BF%9B%E8%A1%8C%E4%BF%AE%E6%94%B9/">22 æ·±å…¥å‰–æï¼šå¦‚ä½•ä½¿ç”¨ Java Agent æŠ€æœ¯å¯¹å­—èŠ‚ç è¿›è¡Œä¿®æ”¹</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/23-%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5jit-%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE%E5%A6%82%E4%BD%95%E5%BD%B1%E5%93%8D%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C/">23 åŠ¨æ‰‹å®è·µï¼šJIT å‚æ•°é…ç½®å¦‚ä½•å½±å“ç¨‹åºè¿è¡Œï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/24-%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90%E5%A4%A7%E5%9E%8B%E9%A1%B9%E7%9B%AE%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E6%80%A7%E8%83%BD%E7%93%B6%E9%A2%88%E8%B0%83%E4%BC%98/">24 æ¡ˆä¾‹åˆ†æï¼šå¤§å‹é¡¹ç›®å¦‚ä½•è¿›è¡Œæ€§èƒ½ç“¶é¢ˆè°ƒä¼˜ï¼Ÿ</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/25-%E6%9C%AA%E6%9D%A5jvm-%E7%9A%84%E5%8E%86%E5%8F%B2%E4%B8%8E%E5%B1%95%E6%9C%9B/">25 æœªæ¥ï¼šJVM çš„å†å²ä¸å±•æœ›</a></li>
                
                
                
                    <li><a href="http://yipsen.github.io/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/26-%E7%A6%8F%E5%88%A9%E5%B8%B8%E8%A7%81-jvm-%E9%9D%A2%E8%AF%95%E9%A2%98%E8%A1%A5%E5%85%85/">26 ç¦åˆ©ï¼šå¸¸è§ JVM é¢è¯•é¢˜è¡¥å……</a></li>
                
                
            </ul>
        
    </div>
</aside>

<style>
    aside {
        position: fixed;
        left: 20px;
        background: #ffdee3;
        border-radius: 6px;
        padding: 20px;
        padding-top: 60px;
        box-shadow: 5px 10px #888;
        list-style-type: none;
        display: none;
    }

    .post-category-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        top: -40px;
        left: 50%;
        margin-left: -40px;
        text-align: center;
        font-size: 36px;
        content: 'J';
        background: #ffdee3;
        border-radius: 100%;
        border: 10px solid #fff;
        box-shadow: 5px 10px #888;
    }
</style><article class="post-block">
        <h1 class="post-title">14 åŠ¨æ‰‹å®è·µï¼šè®©é¢è¯•å®˜åˆ®ç›®ç›¸çœ‹çš„å †å¤–å†…å­˜æ’æŸ¥</h1>
        <div class="post-info">
            <div> 
                <span class="post-date">ğŸ“…&nbsp;2022-01-09 11:12:33</span>ğŸ·ï¸&nbsp;<a class="post-tag" href="/tags/java/">java</a></div><div class="post-category">
                
                ğŸ“š&nbsp;<a href="/categories/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/">æ·±å…¥æµ…å‡ºJavaè™šæ‹Ÿæœº</a>
                
            </div></div>
        <div class="post-content">
            <p>æœ¬è¯¾æ—¶æˆ‘ä»¬ä¸»è¦è®²è§£è®©é¢è¯•å®˜åˆ®ç›®ç›¸çœ‹çš„å †å¤–å†…å­˜æ’æŸ¥ã€‚</p>
<p>ç¬¬ 02 è¯¾æ—¶è®²äº† JVM çš„å†…å­˜å¸ƒå±€ï¼ŒåŒæ—¶ä¹Ÿåœ¨ç¬¬ 08 è¯¾æ—¶ä¸­çœ‹åˆ°äº†ç”±äº Metaspace è®¾ç½®è¿‡å°è€Œå¼•èµ·çš„é—®é¢˜ï¼Œæ¥ç€ï¼Œç¬¬ 10 è¯¾æ—¶è®²äº†ä¸€ä¸‹å…ƒç©ºé—´å’Œç›´æ¥å†…å­˜å¼•èµ·çš„å†…å­˜æº¢å‡ºå®ä¾‹ã€‚</p>
<p>Metaspace å±äºå †å¤–å†…å­˜ï¼Œä½†ç”±äºå®ƒæ˜¯å•ç‹¬ç®¡ç†çš„ï¼Œæ‰€ä»¥æ’æŸ¥èµ·æ¥æ²¡ä»€ä¹ˆéš¾åº¦ã€‚ä½ å¹³å¸¸å¯èƒ½è§åˆ°çš„ä½¿ç”¨å †å¤–å†…å­˜çš„åœºæ™¯è¿˜æœ‰ä¸‹é¢è¿™äº›ï¼š</p>
<ul>
<li>JNI æˆ–è€… JNA ç¨‹åºï¼Œç›´æ¥æ“çºµäº†æœ¬åœ°å†…å­˜ï¼Œæ¯”å¦‚ä¸€äº›åŠ å¯†åº“ï¼›</li>
<li>ä½¿ç”¨äº†Java çš„ Unsafe ç±»ï¼Œåšäº†ä¸€äº›æœ¬åœ°å†…å­˜çš„æ“ä½œï¼›</li>
<li>Netty çš„ç›´æ¥å†…å­˜ï¼ˆDirect Memoryï¼‰ï¼Œåº•å±‚ä¼šè°ƒç”¨æ“ä½œç³»ç»Ÿçš„ malloc å‡½æ•°ã€‚</li>
</ul>
<p>ä½¿ç”¨å †å¤–å†…å­˜å¯ä»¥è°ƒç”¨ä¸€äº›åŠŸèƒ½å®Œå¤‡çš„åº“å‡½æ•°ï¼Œè€Œä¸”å‡è½»äº† GC çš„å‹åŠ›ã€‚è¿™äº›ä»£ç ï¼Œæœ‰å¯èƒ½æ˜¯ä½ äº†è§£çš„äººå†™çš„ï¼Œä¹Ÿæœ‰å¯èƒ½éšè—åœ¨ç¬¬ä¸‰æ–¹çš„ jar åŒ…é‡Œã€‚è™½ç„¶æœ‰ä¸€äº›å¥½å¤„ï¼Œä½†æ˜¯é—®é¢˜æ’æŸ¥èµ·æ¥é€šå¸¸ä¼šæ¯”è¾ƒçš„å›°éš¾ã€‚</p>
<p>åœ¨ç¬¬ 10 è¯¾æ—¶ï¼Œä»‹ç»äº† MaxDirectMemorySize å¯ä»¥æ§åˆ¶ç›´æ¥å†…å­˜çš„ç”³è¯·ã€‚å…¶å®ï¼Œé€šè¿‡è¿™ä¸ªå‚æ•°ï¼Œä»ç„¶é™åˆ¶ä¸ä½æ‰€æœ‰å †å¤–å†…å­˜çš„ä½¿ç”¨ï¼Œå®ƒåªæ˜¯é™åˆ¶äº†ä½¿ç”¨ DirectByteBuffer çš„å†…å­˜ç”³è¯·ã€‚å¾ˆå¤šæ—¶å€™ï¼ˆæ¯”å¦‚ç›´æ¥ä½¿ç”¨äº† sun.misc.Unsafe ç±»ï¼‰ï¼Œå †å¤–å†…å­˜ä¼šä¸€ç›´å¢é•¿ï¼Œç›´åˆ°æœºå™¨ç‰©ç†å†…å­˜çˆ†æ»¡ï¼Œè¢« oom killerã€‚</p>
<pre tabindex="0"><code>import sun.misc.Unsafe;

import java.lang.reflect.Field;

public class UnsafeDemo {
    public static final int _1MB = 1024 * 1024;

    public static void main(String[] args) throws Exception {
        Field field = Unsafe.class.getDeclaredField(&quot;theUnsafe&quot;);
        field.setAccessible(true);
        Unsafe unsafe = (Unsafe) field.get(null);
        for (; ; ) {
            unsafe.allocateMemory(_1MB);
        }
    }
</code></pre><p>ä¸Šé¢è¿™æ®µä»£ç ï¼Œå°±ä¼šæŒç»­ç”³è¯·å †å¤–å†…å­˜ï¼Œä½†å®ƒè¿”å›çš„æ˜¯ long ç±»å‹çš„åœ°å€å¥æŸ„ï¼Œæ‰€ä»¥å †å†…å†…å­˜çš„ä½¿ç”¨ä¼šå¾ˆå°‘ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å»é™åˆ¶å †å†…å’Œç›´æ¥å†…å­˜çš„ä½¿ç”¨ï¼Œç»“æœå‘ç°ç¨‹åºå ç”¨çš„æ“ä½œç³»ç»Ÿå†…å­˜åœ¨ä¸€ç›´ä¸Šå‡ï¼Œè¿™ä¸¤ä¸ªå‚æ•°åœ¨è¿™ç§åœºæ™¯ä¸‹æ²¡æœ‰ä»»ä½•æ•ˆæœã€‚è¿™æ®µç¨‹åºææ­»äº†æˆ‘çš„æœºå™¨å¾ˆå¤šæ¬¡ï¼Œè¿è¡Œçš„æ—¶å€™è¦å°å¿ƒã€‚</p>
<pre tabindex="0"><code>java -XX:MaxDirectMemorySize=10M -Xmx10M  UnsafeDemo
</code></pre><p>ç›¸ä¿¡è¿™ç§æƒ…å†µä¹Ÿå›°æ‰°äº†ä½ ï¼Œå› ä¸ºä½¿ç”¨ä¸€äº› JDK æä¾›çš„å·¥å…·ï¼Œæ ¹æœ¬æ— æ³•å‘ç°è¿™éƒ¨é—¨å†…å­˜çš„ä½¿ç”¨ã€‚æˆ‘ä»¬éœ€è¦ä¸€äº›æ›´åŠ åº•å±‚çš„å·¥å…·æ¥å‘ç°è¿™äº›æ¸¸ç¦»çš„å†…å­˜åˆ†é…ã€‚å…¶å®ï¼Œå¾ˆå¤šå†…å­˜å’Œæ€§èƒ½é—®é¢˜ï¼Œéƒ½é€ƒä¸è¿‡ä¸‹é¢è¦ä»‹ç»çš„è¿™äº›å·¥å…·çš„è”åˆåˆ†æã€‚æœ¬è¯¾æ—¶å°†ä¼šç»“åˆä¸€ä¸ªå®é™…çš„ä¾‹å­ï¼Œæ¥çœ‹ä¸€ä¸‹ä¸€ä¸ªå †å¤–å†…å­˜çš„æº¢å‡ºæƒ…å†µï¼Œäº†è§£å¸¸è§çš„å¥—è·¯ã€‚</p>
<h2 id="1-ç°è±¡">1. ç°è±¡</h2>
<p>æˆ‘ä»¬æœ‰ä¸€ä¸ªæœåŠ¡ï¼Œéå¸¸çš„å¥‡æ€ªï¼Œåœ¨æŸä¸ªç‰ˆæœ¬ä¹‹åï¼Œå ç”¨çš„å†…å­˜å¼€å§‹å¢é•¿ï¼Œç›´åˆ°è™šæ‹Ÿæœºåˆ†é…çš„å†…å­˜ä¸Šé™ï¼Œä½†æ˜¯å¹¶ä¸ä¼š OOMã€‚å¦‚æœä½ å¼€å¯äº† SWAPï¼Œä¼šå‘ç°è¿™ä¸ªåº”ç”¨ä¹Ÿä¼šæ¯«ä¸çŠ¹è±«çš„å°†å®ƒåæ‰ï¼Œæœ‰å¤šå°‘åå¤šå°‘ã€‚</p>
<p>è¯´å®ƒçš„å†…å­˜å¢é•¿ï¼Œæ˜¯é€šè¿‡ top å‘½ä»¤å»è§‚å¯Ÿçš„ï¼Œçœ‹å®ƒçš„ RES åˆ—çš„æ•°å€¼ï¼›åä¹‹ï¼Œå¦‚æœä½¿ç”¨ jmap å‘½ä»¤å»çœ‹å†…å­˜å ç”¨ï¼Œå¾—åˆ°çš„åªæ˜¯å †çš„å¤§å°ï¼Œåªèƒ½çœ‹åˆ°ä¸€å°å—å¯æ€œçš„ç©ºé—´ã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%20Java%20%E8%99%9A%E6%8B%9F%E6%9C%BA-%E5%AE%8C/assets/CgpOIF5Pj3SAcUN4AAoiqH1w81U087.png" alt="img"></p>
<p>ä½¿ç”¨ ps ä¹Ÿèƒ½çœ‹åˆ°ç›¸åŒçš„æ•ˆæœã€‚æˆ‘ä»¬è§‚æµ‹åˆ°ï¼Œé™¤äº†è™šæ‹Ÿå†…å­˜æ¯”è¾ƒé«˜ï¼Œè¾¾åˆ°äº† 17GB ä»¥å¤–ï¼Œå®é™…ä½¿ç”¨çš„å†…å­˜ RSS ä¹Ÿå¤¸å¼ çš„è¾¾åˆ°äº† 7 GBï¼Œè¿œè¿œè¶…è¿‡äº† -Xmx çš„è®¾å®šã€‚</p>
<pre tabindex="0"><code>[root]$ ps -p 75 -o rss,vsz  
RSS    VSZ 7152568 17485844
</code></pre><p>ä½¿ç”¨ jps æŸ¥çœ‹å¯åŠ¨å‚æ•°ï¼Œå‘ç°åˆ†é…äº†å¤§çº¦ 3GB çš„å †å†…å­˜ã€‚å®é™…å†…å­˜ä½¿ç”¨è¶…å‡ºäº†æœ€å¤§å†…å­˜è®¾å®šçš„ä¸€å€è¿˜å¤šï¼Œè¿™æ˜æ˜¾æ˜¯ä¸æ­£å¸¸çš„ï¼Œè‚¯å®šæ˜¯ä½¿ç”¨äº†å †å¤–å†…å­˜ã€‚</p>
<h2 id="2-æ¨¡æ‹Ÿç¨‹åº">2. æ¨¡æ‹Ÿç¨‹åº</h2>
<p>ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨è¿™äº›å·¥å…·å®é™…è§‚æµ‹è¿™ä¸ªå†…å­˜æ³„æ¼çš„è¿‡ç¨‹ï¼Œæˆ‘è¿™é‡Œå‡†å¤‡äº†ä¸€ä»½å°ç¨‹åºã€‚ç¨‹åºå°†ä¼šæŒç»­çš„ä½¿ç”¨ Java çš„ Zip å‡½æ•°è¿›è¡Œå‹ç¼©å’Œè§£å‹ï¼Œè¿™ç§æ“ä½œåœ¨ä¸€äº›å¯¹ä¼ è¾“æ€§èƒ½è¾ƒé«˜çš„çš„åœºæ™¯ç»å¸¸ä¼šç”¨åˆ°ã€‚</p>
<p>ç¨‹åºå°†ä¼šç”³è¯· 1kb çš„éšæœºå­—ç¬¦ä¸²ï¼Œç„¶åæŒç»­è§£å‹ã€‚ä¸ºäº†é¿å…è®©æ“ä½œç³»ç»Ÿé™·å…¥å‡æ­»çŠ¶æ€ï¼Œæˆ‘ä»¬æ¯æ¬¡éƒ½ä¼šåˆ¤æ–­æ“ä½œç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡ï¼Œåœ¨è¾¾åˆ° 60% çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°†æŒ‚èµ·ç¨‹åºï¼›é€šè¿‡è®¿é—® 8888 ç«¯å£ï¼Œå°†ä¼šæŠŠå†…å­˜é˜ˆå€¼æé«˜åˆ° 85%ã€‚æˆ‘ä»¬å°†åˆ†æè¿™ä¸¤ä¸ªå¤„äºç›¸å¯¹é™æ€çš„è™šæ‹Ÿå¿«ç…§ã€‚</p>
<pre tabindex="0"><code>import com.sun.management.OperatingSystemMXBean;
import com.sun.net.httpserver.HttpContext;
import com.sun.net.httpserver.HttpServer;

import java.io.*;
import java.lang.management.ManagementFactory;
import java.net.InetSocketAddress;
import java.util.Random;
import java.util.concurrent.ThreadLocalRandom;
import java.util.zip.GZIPInputStream;
import java.util.zip.GZIPOutputStream;

/**
 * @author xjjdog
 */
public class LeakExample {
    /**
     * æ„é€ éšæœºçš„å­—ç¬¦ä¸²
     */
    public static String randomString(int strLength) {
        Random rnd = ThreadLocalRandom.current();
        StringBuilder ret = new StringBuilder();
        for (int i = 0; i &lt; strLength; i++) {
            boolean isChar = (rnd.nextInt(2) % 2 == 0);
            if (isChar) {
                int choice = rnd.nextInt(2) % 2 == 0 ? 65 : 97;
                ret.append((char) (choice + rnd.nextInt(26)));
            } else {
                ret.append(rnd.nextInt(10));
            }
        }
        return ret.toString();
    }

    public static int copy(InputStream input, OutputStream output) throws IOException {
        long count = copyLarge(input, output);
        return count &gt; 2147483647L ? -1 : (int) count;
    }

    public static long copyLarge(InputStream input, OutputStream output) throws IOException {
        byte[] buffer = new byte[4096];
        long count = 0L;

        int n;
        for (; -1 != (n = input.read(buffer)); count += (long) n) {
            output.write(buffer, 0, n);
        }

        return count;
    }

    public static String decompress(byte[] input) throws Exception {
        ByteArrayOutputStream out = new ByteArrayOutputStream();
        copy(new GZIPInputStream(new ByteArrayInputStream(input)), out);
        return new String(out.toByteArray());
    }

    public static byte[] compress(String str) throws Exception {
        ByteArrayOutputStream bos = new ByteArrayOutputStream();
        GZIPOutputStream gzip = new GZIPOutputStream(bos);

        try {
            gzip.write(str.getBytes());
            gzip.finish();
            byte[] b = bos.toByteArray();
            return b;
        }finally {
            try { gzip.close(); }catch (Exception ex ){}
            try { bos.close(); }catch (Exception ex ){}
        }
    }
    private static OperatingSystemMXBean osmxb = (OperatingSystemMXBean) ManagementFactory.getOperatingSystemMXBean();

    public static int memoryLoad() {
        double totalvirtualMemory = osmxb.getTotalPhysicalMemorySize();
        double freePhysicalMemorySize = osmxb.getFreePhysicalMemorySize();

        double value = freePhysicalMemorySize / totalvirtualMemory;
        int percentMemoryLoad = (int) ((1 - value) * 100);
        return percentMemoryLoad;
    }
    private static volatile int RADIO = 60;

    public static void main(String[] args) throws Exception {
        HttpServer server = HttpServer.create(new InetSocketAddress(8888), 0);
        HttpContext context = server.createContext(&quot;/&quot;);
        context.setHandler(exchange -&gt; {
            try {
                RADIO = 85;
                String response = &quot;OK!&quot;;
                exchange.sendResponseHeaders(200, response.getBytes().length);
                OutputStream os = exchange.getResponseBody();
                os.write(response.getBytes());
                os.close();
            } catch (Exception ex) {
            }
        });
        server.start();
        //1kb
        int BLOCK_SIZE = 1024;
        String str = randomString(BLOCK_SIZE / Byte.SIZE);
        byte[] bytes = compress(str);
        for (; ; ) {
            int percent = memoryLoad();
            if (percent &gt; RADIO) {
                Thread.sleep(1000);
            } else {
                decompress(bytes);
                Thread.sleep(1);
            }
</code></pre><p>ç¨‹åºå°†ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è¡Œè¿›è¡Œå¯åŠ¨ã€‚ä¸ºäº†ç®€åŒ–é—®é¢˜ï¼Œè¿™é‡Œçœç•¥äº†ä¸€äº›æ— å…³çš„é…ç½®ã€‚</p>
<pre tabindex="0"><code>java -Xmx1G -Xmn1G -XX:+AlwaysPreTouch  -XX:MaxMetaspaceSize=10M -XX:MaxDirectMemorySize=10M -XX:NativeMemoryTracking=detail LeakExample
</code></pre><h2 id="3-nmt">3. NMT</h2>
<p>é¦–å…ˆä»‹ç»ä¸€ä¸‹ä¸Šé¢çš„å‡ ä¸ª JVM å‚æ•°ï¼Œåˆ†åˆ«ä½¿ç”¨ Xmxã€MaxMetaspaceSizeã€MaxDirectMemorySize è¿™ä¸‰ä¸ªå‚æ•°é™åˆ¶äº†å †ã€å…ƒç©ºé—´ã€ç›´æ¥å†…å­˜çš„å¤§å°ã€‚</p>
<p>ç„¶åï¼Œä½¿ç”¨ AlwaysPreTouch å‚æ•°ã€‚å…¶å®ï¼Œé€šè¿‡å‚æ•°æŒ‡å®šäº† JVM å¤§å°ï¼Œåªæœ‰åœ¨ JVM çœŸæ­£ä½¿ç”¨çš„æ—¶å€™ï¼Œæ‰ä¼šåˆ†é…ç»™å®ƒã€‚è¿™ä¸ªå‚æ•°ï¼Œåœ¨ JVM å¯åŠ¨çš„æ—¶å€™ï¼Œå°±æŠŠå®ƒæ‰€æœ‰çš„å†…å­˜åœ¨æ“ä½œç³»ç»Ÿåˆ†é…äº†ã€‚åœ¨å †æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œä¼šåŠ å¤§å¯åŠ¨æ—¶é—´ï¼Œä½†åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ä¸ºäº†å‡å°‘å†…å­˜åŠ¨æ€åˆ†é…çš„å½±å“ï¼ŒæŠŠè¿™ä¸ªå€¼è®¾ç½®ä¸º Trueã€‚</p>
<p>æ¥ä¸‹æ¥çš„ NativeMemoryTrackingï¼Œæ˜¯ç”¨æ¥è¿½è¸ª Native å†…å­˜çš„ä½¿ç”¨æƒ…å†µã€‚é€šè¿‡åœ¨å¯åŠ¨å‚æ•°ä¸ŠåŠ å…¥ -XX:NativeMemoryTracking=detail å°±å¯ä»¥å¯ç”¨ã€‚ä½¿ç”¨ jcmd å‘½ä»¤ï¼Œå°±å¯æŸ¥çœ‹å†…å­˜åˆ†é…ã€‚</p>
<pre tabindex="0"><code>jcmd $pid  VM.native_memory summary
</code></pre><p>æˆ‘ä»¬åœ¨ä¸€å° 4GB çš„è™šæ‹Ÿæœºä¸Šä½¿ç”¨ä¸Šé¢çš„å‘½ä»¤ã€‚å¯åŠ¨ç¨‹åºä¹‹åï¼Œå‘ç°è¿›ç¨‹ä½¿ç”¨çš„å†…å­˜è¿…é€Ÿå‡åˆ° 2.4GBã€‚</p>
<pre tabindex="0"><code># jcmd 2154  VM.native_memory summary
2154:
Native Memory Tracking:

Total: reserved=2370381KB, committed=1071413KB
-                 Java Heap (reserved=1048576KB, committed=1048576KB)
                            (mmap: reserved=1048576KB, committed=1048576KB)

-                     Class (reserved=1056899KB, committed=4995KB)
                            (classes #432)
                            (malloc=131KB #328)
                            (mmap: reserved=1056768KB, committed=4864KB)

-                    Thread (reserved=10305KB, committed=10305KB)
                            (thread #11)
                            (stack: reserved=10260KB, committed=10260KB)
                            (malloc=34KB #52)
                            (arena=12KB #18)

-                      Code (reserved=249744KB, committed=2680KB)
                            (malloc=144KB #502)
                            (mmap: reserved=249600KB, committed=2536KB)

-                        GC (reserved=2063KB, committed=2063KB)
                            (malloc=7KB #80)
                            (mmap: reserved=2056KB, committed=2056KB)

-                  Compiler (reserved=138KB, committed=138KB)
                            (malloc=8KB #38)
                            (arena=131KB #5)

-                  Internal (reserved=789KB, committed=789KB)
                            (malloc=757KB #1272)
                            (mmap: reserved=32KB, committed=32KB)

-                    Symbol (reserved=1535KB, committed=1535KB)
                            (malloc=983KB #114)
                            (arena=552KB #1)

-    Native Memory Tracking (reserved=159KB, committed=159KB)
                            (malloc=99KB #1399)
                            (tracking overhead=60KB)

-               Arena Chunk (reserved=174KB, committed=174KB)
                            (mall
</code></pre><p>å¯æƒœçš„æ˜¯ï¼Œè¿™ä¸ªåå­—è®©äººæŒ¯å¥‹çš„å·¥å…·å¹¶ä¸èƒ½å¦‚å®ƒæè¿°çš„ä¸€æ ·ï¼Œçœ‹åˆ°æˆ‘ä»¬è¿™ç§æ³„æ¼çš„åœºæ™¯ã€‚ä¸‹å›¾è¿™ç‚¹å°å°çš„ç©ºé—´ï¼Œæ˜¯ä¸èƒ½å’Œ 2GB çš„å†…å­˜å ç”¨ç›¸æ¯”çš„ã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%20Java%20%E8%99%9A%E6%8B%9F%E6%9C%BA-%E5%AE%8C/assets/Cgq2xl5Pj3WAFE7iAAHAqUmrvpI493.png" alt="img"></p>
<p>NMT èƒ½çœ‹åˆ°å †å†…å†…å­˜ã€Code åŒºåŸŸæˆ–è€…ä½¿ç”¨ unsafe.allocateMemory å’Œ DirectByteBuffer ç”³è¯·çš„å †å¤–å†…å­˜ï¼Œè™½ç„¶æ˜¯ä¸ªå¥½å·¥å…·ä½†é—®é¢˜å¹¶ä¸èƒ½è§£å†³ã€‚</p>
<p>ä½¿ç”¨ jmap å·¥å…·ï¼Œdump ä¸€ä»½å †å¿«ç…§ï¼Œç„¶åä½¿ç”¨ MAT åˆ†æï¼Œä¾ç„¶ä¸èƒ½æ‰¾åˆ°è¿™éƒ¨åˆ†å†…å­˜ã€‚</p>
<h2 id="4-pmap">4. pmap</h2>
<p>åƒæ˜¯ EhCache è¿™ç§ç¼“å­˜æ¡†æ¶ï¼Œæä¾›äº†å¤šç§ç­–ç•¥ï¼Œå¯ä»¥è®¾å®šå°†æ•°æ®å­˜å‚¨åœ¨éå †ä¸Šï¼Œæˆ‘ä»¬å°±æ˜¯è¦æ’æŸ¥è¿™äº›å½±å“å› ç´ ã€‚å¦‚æœèƒ½å¤Ÿåœ¨ä»£ç é‡Œçœ‹åˆ°è¿™ç§å¯èƒ½æ€§æœ€å¤§çš„ä»£ç å—ï¼Œæ˜¯æœ€å¥½çš„ã€‚</p>
<p>ä¸ºäº†è¿›ä¸€æ­¥åˆ†æé—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨ pmap å‘½ä»¤æŸ¥çœ‹è¿›ç¨‹çš„å†…å­˜åˆ†é…ï¼Œé€šè¿‡ RSS å‡åºåºæ’åˆ—ã€‚ç»“æœå‘ç°é™¤äº†åœ°å€ 00000000c0000000 ä¸Šåˆ†é…çš„ 1GB å †ä»¥å¤–ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„å †å†…å­˜ï¼‰ï¼Œè¿˜æœ‰æ•°é‡éå¸¸å¤šçš„ 64M ä¸€å—çš„å†…å­˜æ®µï¼Œè¿˜æœ‰å·¨é‡å°çš„ç‰©ç†å†…å­˜å—æ˜ å°„åˆ°ä¸åŒçš„è™šæ‹Ÿå†…å­˜æ®µä¸Šã€‚ä½†åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä¸çŸ¥é“é‡Œé¢çš„å†…å®¹æ˜¯ä»€ä¹ˆï¼Œæ˜¯é€šè¿‡ä»€ä¹ˆäº§ç”Ÿçš„ã€‚</p>
<pre tabindex="0"><code># pmap -x 2154  | sort -n -k3
Address           Kbytes     RSS   Dirty Mode  Mapping
---------------- ------- ------- -------
0000000100080000 1048064       0       0 -----   [ anon ]
00007f2d4fff1000      60       0       0 -----   [ anon ]
00007f2d537fb000    8212       0       0 -----   [ anon ]
00007f2d57ff1000      60       0       0 -----   [ anon ]
.....çœç•¥Nè¡Œ
00007f2e3c000000   65524   22064   22064 rw---   [ anon ]
00007f2e00000000   65476   22068   22068 rw---   [ anon ]
00007f2e18000000   65476   22072   22072 rw---   [ anon ]
00007f2e30000000   65476   22076   22076 rw---   [ anon ]
00007f2dc0000000   65520   22080   22080 rw---   [ anon ]
00007f2dd8000000   65520   22080   22080 rw---   [ anon ]
00007f2da8000000   65524   22088   22088 rw---   [ anon ]
00007f2e8c000000   65528   22088   22088 rw---   [ anon ]
00007f2e64000000   65520   22092   22092 rw---   [ anon ]
00007f2e4c000000   65520   22096   22096 rw---   [ anon ]
00007f2e7c000000   65520   22096   22096 rw---   [ anon ]
00007f2ecc000000   65520   22980   22980 rw---   [ anon ]
00007f2d84000000   65476   23368   23368 rw---   [ anon ]
00007f2d9c000000  131060   43932   43932 rw---   [ anon ]
00007f2d50000000   57324   56000   56000 rw---   [ anon ]
00007f2d4c000000   65476   64160   64160 rw---   [ anon ]
00007f2d5c000000   65476   64164   64164 rw---   [ anon ]
00007f2d64000000   65476   64164   64164 rw---   [ anon ]
00007f2d54000000   65476   64168   64168 rw---   [ anon ]
00007f2d7c000000   65476   64168   64168 rw---   [ anon ]
00007f2d60000000   65520   64172   64172 rw---   [ anon ]
00007f2d6c000000   65476   64172   64172 rw---   [ anon ]
00007f2d74000000   65476   64172   64172 rw---   [ anon ]
00007f2d78000000   65520   64176   64176 rw---   [ anon ]
00007f2d68000000   65520   64180   64180 rw---   [ anon ]
00007f2d80000000   65520   64184   64184 rw---   [ anon ]
00007f2d58000000   65520   64188   64188 rw---   [ anon ]
00007f2d70000000   65520   64192   64192 rw---   [ anon ]
00000000c0000000 1049088 1049088 1049088 rw---   [ anon ]
total kB         8492740 3511008 3498584
</code></pre><p>é€šè¿‡ Googleï¼Œæ‰¾åˆ°ä»¥ä¸‹èµ„æ–™ Linux glibc &gt;= 2.10 (RHEL 6) malloc may show excessive virtual memory usage) ã€‚</p>
<p>æ–‡ç« æŒ‡å‡ºé€ æˆåº”ç”¨ç¨‹åºå¤§é‡ç”³è¯· 64M å¤§å†…å­˜å—çš„åŸå› æ˜¯ç”± Glibc çš„ä¸€ä¸ªç‰ˆæœ¬å‡çº§å¼•èµ·çš„ï¼Œé€šè¿‡ export MALLOC_ARENA_MAX=4 å¯ä»¥è§£å†³ VSZ å ç”¨è¿‡é«˜çš„é—®é¢˜ã€‚è™½ç„¶è¿™ä¹Ÿæ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œä½†å´ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¢é•¿çš„æ˜¯ç‰©ç†å†…å­˜ï¼Œè€Œä¸æ˜¯è™šæ‹Ÿå†…å­˜ï¼Œç¨‹åºåœ¨è¿™ä¸€æ–¹é¢è¡¨ç°æ˜¯æ­£å¸¸çš„ã€‚</p>
<h2 id="5-gdb">5. gdb</h2>
<p>éå¸¸å¥½å¥‡ 64M æˆ–è€…å…¶ä»–å°å†…å­˜å—ä¸­æ˜¯ä»€ä¹ˆå†…å®¹ï¼Œæ¥ä¸‹æ¥å¯ä»¥é€šè¿‡ gdb å·¥å…·å°†å…¶ dump å‡ºæ¥ã€‚</p>
<p>è¯»å– /proc ç›®å½•ä¸‹çš„ maps æ–‡ä»¶ï¼Œèƒ½ç²¾å‡†åœ°çŸ¥æ™“ç›®å‰è¿›ç¨‹çš„å†…å­˜åˆ†å¸ƒã€‚ä»¥ä¸‹è„šæœ¬é€šè¿‡ä¼ å…¥è¿›ç¨‹ idï¼Œèƒ½å¤Ÿå°†æ‰€å…³è”çš„å†…å­˜å…¨éƒ¨ dump åˆ°æ–‡ä»¶ä¸­ã€‚æ³¨æ„ï¼Œè¿™ä¸ªå‘½ä»¤ä¼šå½±å“æœåŠ¡ï¼Œè¦æ…ç”¨ã€‚</p>
<pre tabindex="0"><code>pid=$1;grep rw-p /proc/$pid/maps | sed -n 's/^\([0-9a-f]*\)-\([0-9a-f]*\) .*$/\1 \2/p' | while read start stop; do gdb --batch --pid $pid -ex &quot;dump memory $1-$start-$stop.dump 0x$start 0x$stop&quot;; done
</code></pre><p>è¿™ä¸ªå‘½ä»¤ååˆ†éœ¸é“ï¼Œç”šè‡³æŠŠåŠ è½½åˆ°å†…å­˜ä¸­çš„ class æ–‡ä»¶ã€å †æ–‡ä»¶ä¸€å—ç»™ dump ä¸‹æ¥ã€‚è¿™æ˜¯æœºå™¨çš„åŸå§‹å†…å­˜ï¼Œå¤§å¤šæ•°æ–‡ä»¶æˆ‘ä»¬æ‰“ä¸å¼€ã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%20Java%20%E8%99%9A%E6%8B%9F%E6%9C%BA-%E5%AE%8C/assets/CgpOIF5Pj3WARpCEAAL6h0zOFuE422.png" alt="img"></p>
<p>æ›´å¤šæ—¶å€™ï¼Œåªéœ€è¦ dump ä¸€éƒ¨åˆ†å†…å­˜å°±å¯ä»¥ã€‚å†æ¬¡æé†’æ“ä½œä¼šå½±å“æœåŠ¡ï¼Œæ³¨æ„ dump çš„å†…å­˜å—å¤§å°ï¼Œçº¿ä¸Šä¸€å®šè¦æ…ç”¨ã€‚</p>
<p>æˆ‘ä»¬å¤åˆ¶ pman çš„ä¸€å— 64M å†…å­˜ï¼Œæ¯”å¦‚ 00007f2d70000000ï¼Œç„¶åå»æ‰å‰é¢çš„ 0ï¼Œä½¿ç”¨ä¸‹é¢ä»£ç å¾—åˆ°å†…å­˜å—çš„å¼€å§‹å’Œç»“æŸåœ°å€ã€‚</p>
<pre tabindex="0"><code>cat /proc/2154/maps | grep 7f2d70000000
7f2d6fff1000-7f2d70000000 ---p 00000000 00:00 0 7f2d70000000-7f2d73ffc000 rw-p 00000000 00:00 0
</code></pre><p>æ¥ä¸‹æ¥å°± dump è¿™ 64MB çš„å†…å­˜ã€‚</p>
<pre tabindex="0"><code>gdb --batch --pid 2154 -ex &quot;dump memory a.dump 0x7f2d70000000 0x7f2d73ffc000&quot;
</code></pre><p>ä½¿ç”¨ du å‘½ä»¤æŸ¥çœ‹å…·ä½“çš„å†…å­˜å—å¤§å°ï¼Œä¸å¤šä¸å°‘æ­£å¥½ 64Mã€‚</p>
<pre tabindex="0"><code># du -h a.dump
64M a.dump
</code></pre><p>æ˜¯æ—¶å€™æŸ¥çœ‹é‡Œé¢çš„å†…å®¹äº†ï¼Œä½¿ç”¨ strings å‘½ä»¤å¯ä»¥çœ‹åˆ°å†…å­˜å—é‡Œä¸€äº›å¯ä»¥æ‰“å°çš„å†…å®¹ã€‚</p>
<pre tabindex="0"><code># strings -10 a.dump

0R4f1Qej1ty5GT8V1R8no6T44564wz499E6Y582q2R9h8CC175GJ3yeJ1Q3P5Vt757Mcf6378kM36hxZ5U8uhg2A26T5l7f68719WQK6vZ2BOdH9lH5C7838qf1
...
</code></pre><p>ç­‰ç­‰ï¼Ÿè¿™äº›å†…å®¹ä¸åº”è¯¥åœ¨å †é‡Œé¢ä¹ˆï¼Ÿä¸ºä½•è¿˜ä¼šä½¿ç”¨é¢å¤–çš„å†…å­˜è¿›è¡Œåˆ†é…ï¼Ÿé‚£ä¹ˆè¿˜æœ‰ä»€ä¹ˆåœ°æ–¹åœ¨åˆ†é…å †å¤–å†…å­˜å‘¢ï¼Ÿ</p>
<p>è¿™ç§æƒ…å†µï¼Œåªå¯èƒ½æ˜¯ native ç¨‹åºå¯¹å †å¤–å†…å­˜çš„æ“ä½œã€‚</p>
<h2 id="6-perf">6. perf</h2>
<p>ä¸‹é¢ä»‹ç»ä¸€ä¸ªç¥å™¨ perfï¼Œé™¤äº†èƒ½å¤Ÿè¿›è¡Œä¸€äº›æ€§èƒ½åˆ†æï¼Œå®ƒè¿˜èƒ½å¸®åŠ©æˆ‘ä»¬æ‰¾åˆ°ç›¸åº”çš„ native è°ƒç”¨ã€‚è¿™ä¹ˆçªå‡ºçš„å †å¤–å†…å­˜ä½¿ç”¨é—®é¢˜ï¼Œè‚¯å®šèƒ½æ‰¾åˆ°ç›¸åº”çš„è°ƒç”¨å‡½æ•°ã€‚</p>
<p>ä½¿ç”¨ perf record -g -p 2154 å¼€å¯ç›‘æ§æ ˆå‡½æ•°è°ƒç”¨ï¼Œç„¶åè®¿é—®æœåŠ¡å™¨çš„ 8888 ç«¯å£ï¼Œè¿™å°†ä¼šæŠŠå†…å­˜ä½¿ç”¨çš„é˜ˆå€¼å¢åŠ åˆ° 85%ï¼Œæˆ‘ä»¬çš„ç¨‹åºä¼šé€æ¸æŠŠè¿™éƒ¨åˆ†å†…å­˜å æ»¡ï¼Œä½ å¯ä»¥ syiã€‚perf è¿è¡Œä¸€æ®µæ—¶é—´å Ctrl+C ç»“æŸï¼Œä¼šç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ perf.dataã€‚</p>
<p>æ‰§è¡Œ perf report -i perf.data æŸ¥çœ‹æŠ¥å‘Šã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%20Java%20%E8%99%9A%E6%8B%9F%E6%9C%BA-%E5%AE%8C/assets/Cgq2xl5Pj3aAKZfFAA-9bP5LmvM029.png" alt="img"></p>
<p>å¦‚å›¾ï¼Œä¸€èˆ¬ç¬¬ä¸‰æ–¹ JNI ç¨‹åºï¼Œæˆ–è€… JDK å†…çš„æ¨¡å—ï¼Œéƒ½ä¼šè°ƒç”¨ç›¸åº”çš„æœ¬åœ°å‡½æ•°ï¼Œåœ¨ Linux ä¸Šï¼Œè¿™äº›å‡½æ•°åº“çš„åç¼€éƒ½æ˜¯ soã€‚</p>
<p>æˆ‘ä»¬ä¾æ¬¡æµè§ˆç”¨çš„å¯ç–‘èµ„æºï¼Œå‘ç°äº†â€œlibzip.soâ€ï¼Œè¿˜å‘ç°äº†ä¸å°‘ç›¸å…³çš„è°ƒç”¨ã€‚æœç´¢ zipï¼ˆè¾“å…¥ / è¿›å…¥æœç´¢æ¨¡å¼ï¼‰ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%20Java%20%E8%99%9A%E6%8B%9F%E6%9C%BA-%E5%AE%8C/assets/CgpOIF5Pj3aAQju0AAHW7pHtD6w371.png" alt="img"></p>
<p>æŸ¥çœ‹ JDK ä»£ç ï¼Œå‘ç° bzip å¤§é‡ä½¿ç”¨äº† native æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ‰å¤§é‡å†…å­˜çš„ç”³è¯·å’Œé”€æ¯ï¼Œæ˜¯åœ¨å †å¤–å‘ç”Ÿçš„ã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%20Java%20%E8%99%9A%E6%8B%9F%E6%9C%BA-%E5%AE%8C/assets/Cgq2xl5Pj3aAc73qAAbsH6BJyJw405.png" alt="img"></p>
<p>è¿›ç¨‹è°ƒç”¨äº†Java_java_util_zip_Inflater_inflatBytes() ç”³è¯·äº†å†…å­˜ï¼Œå´æ²¡æœ‰è°ƒç”¨ Deflater é‡Šæ”¾å†…å­˜ã€‚ä¸ pmap å†…å­˜åœ°å€ç›¸æ¯”å¯¹ï¼Œç¡®å®æ˜¯ zip åœ¨æé¬¼ã€‚</p>
<h2 id="7-gperftools">7. gperftools</h2>
<p>google è¿˜æœ‰ä¸€ä¸ªç±»ä¼¼çš„ã€éå¸¸å¥½ç”¨çš„å·¥å…·ï¼Œå«åš gperftoolsï¼Œæˆ‘ä»¬ä¸»è¦ç”¨åˆ°å®ƒçš„ Heap Profilerï¼ŒåŠŸèƒ½æ›´åŠ å¼ºå¤§ã€‚</p>
<p>å®ƒçš„å¯åŠ¨æ–¹å¼æœ‰ç‚¹ç‰¹åˆ«ï¼Œå®‰è£…æˆåŠŸä¹‹åï¼Œä½ åªéœ€è¦è¾“å‡ºä¸¤ä¸ªç¯å¢ƒå˜é‡å³å¯ã€‚</p>
<pre tabindex="0"><code>mkdir -p /opt/test 
export LD_PRELOAD=/usr/lib64/libtcmalloc.so 
export HEAPPROFILE=/opt/test/heap
</code></pre><p>åœ¨åŒä¸€ä¸ªç»ˆç«¯ï¼Œå†æ¬¡å¯åŠ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°å†…å­˜ç”³è¯·åŠ¨ä½œéƒ½è¢«è®°å½•åˆ°äº† opt ç›®å½•ä¸‹çš„ test ç›®å½•ã€‚</p>
<p><img src="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%20Java%20%E8%99%9A%E6%8B%9F%E6%9C%BA-%E5%AE%8C/assets/CgpOIF5Pj3aAf-BFABBp-0oVTMo956.png" alt="img"></p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ pprof å‘½ä»¤åˆ†æè¿™äº›æ–‡ä»¶ã€‚</p>
<pre tabindex="0"><code>cd /opt/test
pprof -text *heap  | head -n 200
</code></pre><p>ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼Œèƒ½å¤Ÿä¸€çœ¼è¿½è¸ªåˆ°ç”³è¯·å†…å­˜æœ€å¤šçš„å‡½æ•°ã€‚Java_java_util_zip_Inflater_init è¿™ä¸ªå‡½æ•°ç«‹é©¬å°±è¢«å‘ç°äº†ã€‚</p>
<pre tabindex="0"><code>Total: 25205.3 MB
 20559.2  81.6%  81.6%  20559.2  81.6% inflateBackEnd
  4487.3  17.8%  99.4%   4487.3  17.8% inflateInit2_
    75.7   0.3%  99.7%     75.7   0.3% os::malloc@8bbaa0
    70.3   0.3%  99.9%   4557.6  18.1% Java_java_util_zip_Inflater_init
     7.1   0.0% 100.0%      7.1   0.0% readCEN
     3.9   0.0% 100.0%      3.9   0.0% init
     1.1   0.0% 100.0%      1.1   0.0% os::malloc@8bb8d0
     0.2   0.0% 100.0%      0.2   0.0% _dl_new_object
     0.1   0.0% 100.0%      0.1   0.0% __GI__dl_allocate_tls
     0.1   0.0% 100.0%      0.1   0.0% _nl_intern_locale_data
     0.0   0.0% 100.0%      0.0   0.0% _dl_check_map_versions
     0.0   0.0% 100.0%      0.0   0.0% __GI___strdup
     0.0   0.0% 100.0%      0.1   0.0% _dl_map_object_deps
     0.0   0.0% 100.0%      0.0   0.0% nss_parse_service_list
     0.0   0.0% 100.0%      0.0   0.0% __new_exitfn
     0.0   0.0% 100.0%      0.0   0.0% getpwuid
     0.0   0.0% 100.0%      0.0   0.0% expand_dynamic_string_token
</code></pre><h2 id="8-è§£å†³">8. è§£å†³</h2>
<p>è¿™å°±æ˜¯æˆ‘ä»¬æ¨¡æ‹Ÿå†…å­˜æ³„æ¼çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œåˆ°æ­¤é—®é¢˜å°±è§£å†³äº†ã€‚</p>
<p>GZIPInputStream ä½¿ç”¨ Inflater ç”³è¯·å †å¤–å†…å­˜ã€Deflater é‡Šæ”¾å†…å­˜ï¼Œè°ƒç”¨ close() æ–¹æ³•æ¥ä¸»åŠ¨é‡Šæ”¾ã€‚å¦‚æœå¿˜è®°å…³é—­ï¼ŒInflater å¯¹è±¡çš„ç”Ÿå‘½ä¼šå»¶ç»­åˆ°ä¸‹ä¸€æ¬¡ GCï¼Œæœ‰ä¸€ç‚¹ç±»ä¼¼å †å†…çš„å¼±å¼•ç”¨ã€‚åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œå †å¤–å†…å­˜ä¼šä¸€ç›´å¢é•¿ã€‚</p>
<p>æŠŠ decompress å‡½æ•°æ”¹æˆå¦‚ä¸‹ä»£ç ï¼Œé‡æ–°ç¼–è¯‘ä»£ç åè§‚å¯Ÿï¼Œé—®é¢˜è§£å†³ã€‚</p>
<pre tabindex="0"><code>public static String decompress(byte[] input) throws Exception {
        ByteArrayOutputStream out = new ByteArrayOutputStream();
        GZIPInputStream gzip = new GZIPInputStream(new ByteArrayInputStream(input));
        try {
            copy(gzip, out);
            return new String(out.toByteArray());
        }finally {
            try{ gzip.close(); }catch (Exception ex){}
            try{ out.close(); }catch (Exception ex){}
        }
    }
</code></pre><h2 id="9-å°ç»“">9. å°ç»“</h2>
<p>æœ¬è¯¾æ—¶ä½¿ç”¨äº†éå¸¸å¤šçš„å·¥å…·å’Œå‘½ä»¤æ¥è¿›è¡Œå †å¤–å†…å­˜çš„æ’æŸ¥ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œé™¤äº†ä½¿ç”¨ jmap è·å–å †å†…å†…å­˜ï¼Œè¿˜å¯¹å †å¤–å†…å­˜çš„è·å–ä¹Ÿæœ‰ä¸å°‘åŠæ³•ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå †å¤–å†…å­˜è¿›è¡Œæ›´åŠ ç»†è‡´åœ°åˆ’åˆ†äº†ã€‚</p>
<p>å…ƒç©ºé—´å±äºå †å¤–å†…å­˜ï¼Œä¸»è¦æ˜¯æ–¹æ³•åŒºå’Œå¸¸é‡æ± çš„å­˜å‚¨ä¹‹åœ°ï¼Œä½¿ç”¨æ•°â€œMaxMetaspaceSizeâ€å¯ä»¥é™åˆ¶å®ƒçš„å¤§å°ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½è§‚æµ‹åˆ°å®ƒçš„ä½¿ç”¨ã€‚</p>
<p>ç›´æ¥å†…å­˜ä¸»è¦æ˜¯é€šè¿‡ DirectByteBuffer ç”³è¯·çš„å†…å­˜ï¼Œå¯ä»¥ä½¿ç”¨å‚æ•°â€œMaxDirectMemorySizeâ€æ¥é™åˆ¶å®ƒçš„å¤§å°ï¼ˆå‚è€ƒç¬¬ 10 è¯¾æ—¶ï¼‰ã€‚</p>
<p>å…¶ä»–å †å¤–å†…å­˜ï¼Œä¸»è¦æ˜¯æŒ‡ä½¿ç”¨äº† Unsafe æˆ–è€…å…¶ä»– JNI æ‰‹æ®µç›´æ¥ç›´æ¥ç”³è¯·çš„å†…å­˜ã€‚è¿™ç§æƒ…å†µï¼Œå°±æ²¡æœ‰ä»»ä½•å‚æ•°èƒ½å¤Ÿé˜»æŒ¡å®ƒä»¬ï¼Œè¦ä¹ˆé å®ƒè‡ªå·±å»é‡Šæ”¾ä¸€äº›å†…å­˜ï¼Œè¦ä¹ˆç­‰å¾…æ“ä½œç³»ç»Ÿå¯¹å®ƒçš„å®¡åˆ¤äº†ã€‚</p>
<p>è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œå’Œå†…å­˜çš„ä½¿ç”¨æ— å…³ï¼Œä½†æ˜¯ä¹Ÿä¼šé€ æˆå†…å­˜ä¸æ­£å¸¸ä½¿ç”¨ï¼Œé‚£å°±æ˜¯ä½¿ç”¨äº† Process æ¥å£ï¼Œç›´æ¥è°ƒç”¨äº†å¤–éƒ¨çš„åº”ç”¨ç¨‹åºï¼Œè¿™äº›ç¨‹åºå¯¹æ“ä½œç³»ç»Ÿçš„å†…å­˜ä½¿ç”¨ä¸€èˆ¬æ˜¯ä¸å¯é¢„çŸ¥çš„ã€‚</p>
<p>æœ¬è¯¾æ—¶ä»‹ç»çš„ä¸€äº›å·¥å…·ï¼Œå¾ˆå¤šé«˜çº§ç ”å‘ï¼ŒåŒ…æ‹¬ä¸€äº›é¢è¯•å®˜ï¼Œä¹Ÿæ˜¯ä¸çŸ¥é“çš„ï¼›å³ä½¿äº†è§£è¿™ä¸ªè¿‡ç¨‹ï¼Œä¸å®é™…æ“ä½œä¸€éï¼Œä¹Ÿå¾ˆéš¾æœ‰æ·±åˆ»çš„å°è±¡ã€‚é€šè¿‡è¿™ä¸ªä¾‹å­ï¼Œä½ å¯ä»¥çœ‹åˆ°ä¸€ä¸ªå…¸å‹çš„å †å¤–å†…å­˜é—®é¢˜çš„æ’æŸ¥æ€è·¯ã€‚</p>
<p>å †å¤–å†…å­˜çš„æ³„æ¼æ˜¯éå¸¸ä¸¥é‡çš„ï¼Œå®ƒçš„æ’æŸ¥éš¾åº¦é«˜ã€å½±å“å¤§ï¼Œç”šè‡³ä¼šé€ æˆå®¿ä¸»æœºçš„æ­»äº¡ã€‚åœ¨æ’æŸ¥å†…å­˜é—®é¢˜æ—¶ï¼Œä¸è¦å¿˜äº†è¿™ä¸€ç¯ã€‚</p>

        </div>
    </article>
</div>

    </main>
    <footer>
        <div id="pagination">
            
<div class="paginator">
    <div class="prev">
        
        <a href="/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/13-%E5%B7%A5%E5%85%B7%E8%BF%9B%E9%98%B6%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8-mat-%E6%89%BE%E5%88%B0%E9%97%AE%E9%A2%98%E5%8F%91%E7%94%9F%E7%9A%84%E6%A0%B9%E6%9C%AC%E5%8E%9F%E5%9B%A0/"><span>13 å·¥å…·è¿›é˜¶ï¼šå¦‚ä½•åˆ©ç”¨ MAT æ‰¾åˆ°é—®é¢˜å‘ç”Ÿçš„æ ¹æœ¬åŸå› </span></a>
    </div>
    <div class="next">
        
        <a href="/documents/columns/java/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAjava%E8%99%9A%E6%8B%9F%E6%9C%BA/15-%E9%A2%84%E8%AD%A6%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA-gc-%E7%9B%91%E6%8E%A7%E4%B8%8E%E8%B0%83%E4%BC%98/"><span>15 é¢„è­¦ä¸è§£å†³ï¼šæ·±å…¥æµ…å‡º GC ç›‘æ§ä¸è°ƒä¼˜</span></a>
    </div>
</div>

        </div>
        <div class="toggler" onclick="toggleLight(this);">ğŸ’¡</div>
        <div id="copyright" style="display: none;">
    
    
    <p>&copy; 27270 <a href="/"></a>, powered by Hugo and Qiao</p>
</div>
    </footer>
    
<script>
    function toggleLight() {
        document.getElementById('page').classList.toggle('night');
    }
</script>
</body>

</html>